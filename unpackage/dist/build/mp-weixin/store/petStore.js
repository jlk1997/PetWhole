"use strict";var t=(t,e,r)=>new Promise(((s,n)=>{var i=t=>{try{h(r.next(t))}catch(e){n(e)}},o=t=>{try{h(r.throw(t))}catch(e){n(e)}},h=t=>t.done?s(t.value):Promise.resolve(t.value).then(i,o);h((r=r.apply(t,e)).next())}));const e=require("../common/vendor.js"),r=require("../utils/api.js"),s=e.defineStore("pet",{state:()=>({pets:[],currentPet:null,loading:!1,error:null}),getters:{getPets:t=>t.pets,getCurrentPet:t=>t.currentPet},actions:{fetchPets(){return t(this,null,(function*(){this.loading=!0,this.error=null;try{const t=yield r.pet.getMyPets();return console.log("获取宠物列表响应:",t),this.setPets(t),t}catch(t){return console.error("获取宠物列表失败:",t),this.error=t.message||"获取宠物列表失败",e.index.showToast({title:"获取宠物列表失败",icon:"none"}),[]}finally{this.loading=!1}}))},setPets(t){this.pets=t,e.index.setStorageSync("pets",JSON.stringify(t)),!this.currentPet&&t.length>0&&this.setCurrentPet(t[0])},addPet(s){return t(this,null,(function*(){this.loading=!0,this.error=null;try{const t=yield r.pet.addPet(s);return console.log("添加宠物响应:",t),this.pets.push(t),e.index.setStorageSync("pets",JSON.stringify(this.pets)),1===this.pets.length&&this.setCurrentPet(t),t}catch(t){throw console.error("添加宠物失败:",t),this.error=t.message||"添加宠物失败",t}finally{this.loading=!1}}))},updatePet(s,n){return t(this,null,(function*(){this.loading=!0,this.error=null;try{const t=yield r.pet.updatePet(s,n);console.log("更新宠物响应:",t);const i=this.pets.findIndex((t=>t._id===s));return-1!==i&&(this.pets[i]=t,e.index.setStorageSync("pets",JSON.stringify(this.pets)),this.currentPet&&this.currentPet._id===s&&(this.currentPet=t,e.index.setStorageSync("currentPet",JSON.stringify(t)))),t}catch(t){throw console.error("更新宠物信息失败:",t),this.error=t.message||"更新宠物信息失败",t}finally{this.loading=!1}}))},deletePet(s){return t(this,null,(function*(){this.loading=!0,this.error=null;try{return yield r.pet.deletePet(s),this.pets=this.pets.filter((t=>t._id!==s)),e.index.setStorageSync("pets",JSON.stringify(this.pets)),this.currentPet&&this.currentPet._id===s&&(this.currentPet=this.pets.length>0?this.pets[0]:null,e.index.setStorageSync("currentPet",this.currentPet?JSON.stringify(this.currentPet):"")),!0}catch(t){throw console.error("删除宠物失败:",t),this.error=t.message||"删除宠物失败",t}finally{this.loading=!1}}))},setCurrentPet(t){this.currentPet=t,e.index.setStorageSync("currentPet",JSON.stringify(t))},restorePetState(){try{const t=e.index.getStorageSync("pets"),r=e.index.getStorageSync("currentPet");t&&(this.pets=JSON.parse(t)),r?this.currentPet=JSON.parse(r):this.pets.length>0&&(this.currentPet=this.pets[0])}catch(t){console.error("恢复宠物状态失败:",t)}}}});exports.usePetStore=s;
