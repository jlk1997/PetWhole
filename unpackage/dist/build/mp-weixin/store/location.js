"use strict";var t=Object.defineProperty,e=Object.defineProperties,r=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,i=(e,r,n)=>r in e?t(e,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[r]=n,s=(t,e)=>{for(var r in e||(e={}))a.call(e,r)&&i(t,r,e[r]);if(n)for(var r of n(e))o.call(e,r)&&i(t,r,e[r]);return t},l=(t,e,r)=>new Promise(((n,a)=>{var o=t=>{try{s(r.next(t))}catch(e){a(e)}},i=t=>{try{s(r.throw(t))}catch(e){a(e)}},s=t=>t.done?n(t.value):Promise.resolve(t.value).then(o,i);s((r=r.apply(t,e)).next())}));const c=require("../common/vendor.js"),u=require("../utils/api.js"),d=c.defineStore("location",{state:()=>({currentLocation:null,nearbyUsers:[],loading:!1,error:null,sharingEnabled:!0,locationUpdateInterval:null}),getters:{hasLocation:t=>!!t.currentLocation,getNearbyUsersList:t=>t.nearbyUsers},actions:{updateLocation(t){return l(this,null,(function*(){try{return this.loading=!0,this.currentLocation=t,this.sharingEnabled&&(yield u.api.location.updateLocation({latitude:t.latitude,longitude:t.longitude,timestamp:(new Date).toISOString()})),t}catch(e){throw console.error("更新位置失败:",e),this.error="更新位置失败",e}finally{this.loading=!1}}))},getNearbyUsers(){return l(this,arguments,(function*(t={}){try{if(this.loading=!0,!this.currentLocation)return{success:!1,message:"没有位置信息"};const o=s({latitude:this.currentLocation.latitude,longitude:this.currentLocation.longitude,maxDistance:t.maxDistance||5e3},t),i=(n=s({},o),a={latitude:t.latitude||o.latitude,longitude:t.longitude||o.longitude},e(n,r(a)));console.log("获取附近用户，使用参数:",i);const l=yield u.api.location.getNearbyUsers(i);return l&&l.success?(this.nearbyUsers=l.data||[],l):{success:!1,data:[],message:"获取附近用户失败"}}catch(o){return console.error("获取附近用户失败:",o),this.error="获取附近用户失败",{success:!1,data:[],message:o.message}}finally{this.loading=!1}var n,a}))},toggleLocationSharing(t){return l(this,null,(function*(){try{this.loading=!0,this.sharingEnabled=t;try{yield u.api.location.toggleLocationSharing({enabled:this.sharingEnabled})}catch(e){console.warn("更新服务器位置共享状态失败，仅在本地更新:",e)}return this.sharingEnabled}catch(r){return console.error("切换位置共享状态失败:",r),this.error="切换位置共享状态失败",null}finally{this.loading=!1}}))},getLocationSharingStatus(){return l(this,null,(function*(){try{this.loading=!0;const t=yield u.api.location.getLocationSharingStatus();return this.sharingEnabled=t.data.enabled,this.sharingEnabled}catch(t){return console.error("获取位置共享状态失败:",t),this.error="获取位置共享状态失败",null}finally{this.loading=!1}}))},startLocationUpdates(t=1e4){this.locationUpdateInterval&&clearInterval(this.locationUpdateInterval),this.getUserLocation(),this.locationUpdateInterval=setInterval((()=>{this.getUserLocation()}),t)},stopLocationUpdates(){this.locationUpdateInterval&&(clearInterval(this.locationUpdateInterval),this.locationUpdateInterval=null)},getUserLocation(){return new Promise(((t,e)=>{c.index.getLocation({type:"gcj02",success:e=>{const r={latitude:e.latitude,longitude:e.longitude,accuracy:e.accuracy,altitude:e.altitude,timestamp:(new Date).toISOString()};this.updateLocation(r),t(r)},fail:t=>{console.error("获取位置失败:",t),this.error="获取位置失败",e(t)}})}))},clearLocationData(){this.stopLocationUpdates(),this.currentLocation=null,this.nearbyUsers=[],this.error=null},getUserPets(t){return l(this,null,(function*(){try{this.loading=!0;const e=yield c.index.request({url:`${c.index.getStorageSync("BASE_URL")||"http://49.235.65.37:5000"}/api/pets/user/${t}`,method:"GET",header:{Authorization:`Bearer ${c.index.getStorageSync("token")}`}});return 200===e.statusCode&&e.data?e.data:(console.error("获取用户宠物失败:",e),[])}catch(e){return console.error("获取用户宠物出错:",e),[]}finally{this.loading=!1}}))},checkFollowStatus(t){return l(this,null,(function*(){try{this.loading=!0;const e=yield c.index.request({url:`${c.index.getStorageSync("BASE_URL")||"http://49.235.65.37:5000"}/api/users/follow/check/${t}`,method:"GET",header:{Authorization:`Bearer ${c.index.getStorageSync("token")}`}});return 200===e.statusCode&&e.data?e.data:(console.error("检查关注状态失败:",e),{following:!1})}catch(e){return console.error("检查关注状态出错:",e),{following:!1}}finally{this.loading=!1}}))}}});exports.useLocationStore=d;
