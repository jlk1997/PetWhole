"use strict";var e=(e,r,n)=>new Promise(((t,o)=>{var s=e=>{try{l(n.next(e))}catch(r){o(r)}},i=e=>{try{l(n.throw(e))}catch(r){o(r)}},l=e=>e.done?t(e.value):Promise.resolve(e.value).then(s,i);l((n=n.apply(e,r)).next())}));const r=require("../common/vendor.js"),n=require("../utils/api.js"),t=r.defineStore("user",{state:()=>({token:r.index.getStorageSync("token")||null,userInfo:JSON.parse(r.index.getStorageSync("userInfo")||"null"),loading:!1,userStats:null,followingUsers:[],followerUsers:[],error:null}),getters:{isLoggedIn:e=>!!e.token&&!!e.userInfo,userId:e=>{var r;return(null==(r=e.userInfo)?void 0:r._id)||null},username:e=>{var r;return(null==(r=e.userInfo)?void 0:r.username)||""},nickname:e=>{var r,n;return(null==(r=e.userInfo)?void 0:r.nickname)||(null==(n=e.userInfo)?void 0:n.username)||""},avatar:e=>{var r;return(null==(r=e.userInfo)?void 0:r.avatar)||"/static/images/default-avatar.png"}},actions:{register(t){return e(this,null,(function*(){try{this.loading=!0,this.error=null;const e=yield n.auth.register(t);if(!e||!e.token)throw new Error("注册失败：响应中没有包含token");return this.token=e.token,this.userInfo={_id:e._id,username:e.username,email:e.email,nickname:e.nickname,avatar:e.avatar},r.index.setStorageSync("token",this.token),r.index.setStorageSync("userInfo",JSON.stringify(this.userInfo)),this.userInfo}catch(e){throw this.error=e.message||"注册失败",console.error("注册失败:",e),e}finally{this.loading=!1}}))},login(t){return e(this,null,(function*(){try{this.loading=!0,this.error=null;const e=yield n.auth.login(t);if(console.log("登录响应:",e),!e||!e.token)throw new Error("登录失败：响应中没有包含token");return this.token=e.token,this.userInfo={_id:e._id,username:e.username,email:e.email,nickname:e.nickname,avatar:e.avatar},r.index.setStorageSync("token",this.token),r.index.setStorageSync("userInfo",JSON.stringify(this.userInfo)),this.userInfo}catch(e){throw this.error=e.message||"登录失败",console.error("登录失败:",e),e}finally{this.loading=!1}}))},getUserInfo(){return e(this,null,(function*(){if(this.userInfo)return this.userInfo;try{this.loading=!0,this.error=null;const e=yield n.user.getCurrentUser();if(!e)throw new Error("获取用户信息失败：无效的响应");return this.userInfo=e,r.index.setStorageSync("userInfo",JSON.stringify(this.userInfo)),this.userInfo}catch(e){throw this.error=e.message||"获取用户信息失败",console.error("获取用户信息失败:",e),e}finally{this.loading=!1}}))},logout(){this.token=null,this.userInfo=null,this.userStats=null,r.index.removeStorageSync("token"),r.index.removeStorageSync("userInfo"),r.index.reLaunch({url:"/pages/login/login"})},fetchUserStats(){return e(this,null,(function*(){if(!this.isLoggedIn)return null;try{this.loading=!0;const e=yield n.user.getUserStats();return this.userStats=e,e}catch(e){return console.error("获取用户统计信息失败:",e),null}finally{this.loading=!1}}))},fetchFollowing(){return e(this,null,(function*(){if(!this.isLoggedIn)return[];try{this.loading=!0;const e=yield n.user.getFollowing();return this.followingUsers=e,e}catch(e){return console.error("获取关注列表失败:",e),[]}finally{this.loading=!1}}))},fetchFollowers(){return e(this,null,(function*(){if(!this.isLoggedIn)return[];try{this.loading=!0;const e=yield n.user.getFollowers();return this.followerUsers=e,e}catch(e){return console.error("获取粉丝列表失败:",e),[]}finally{this.loading=!1}}))},uploadAvatar(t){return e(this,null,(function*(){try{this.loading=!0;const e=yield n.user.uploadAvatar(t);return this.userInfo&&(this.userInfo.avatar=e.avatar,r.index.setStorageSync("userInfo",JSON.stringify(this.userInfo))),e}catch(e){throw console.error("上传头像失败:",e),e}finally{this.loading=!1}}))}}});exports.useUserStore=t;
