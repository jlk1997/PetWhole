"use strict";var e=(e,t,o)=>new Promise(((s,a)=>{var n=e=>{try{i(o.next(e))}catch(t){a(t)}},r=e=>{try{i(o.throw(e))}catch(t){a(t)}},i=e=>e.done?s(e.value):Promise.resolve(e.value).then(n,r);i((o=o.apply(e,t)).next())}));const t=require("../../common/vendor.js"),o=require("../../store/user.js"),s=require("../../store/pet.js"),a=require("../../utils/ui.js");var n={VITE_CJS_IGNORE_WARNING:"true",VITE_ROOT_DIR:"D:/caloriesH5/CloudStorage",VITE_USER_NODE_ENV:"production",BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1};const r={__name:"index",setup(r){const i=o.useUserStore(),l=s.usePetStore(),c=t.ref(!1),u=t.ref(null),g=n.VITE_API_URL||"http://49.235.65.37:5000",d=t.computed((()=>{const e=i.userAvatar;if(console.log("当前用户头像路径:",e),e&&e.startsWith("/uploads/")){const t=g+e;return console.log("完整头像URL:",t),t}return e||"/static/images/default-avatar.png"})),h=t.computed((()=>i.stats||{walkCount:0,totalDistance:0,following:0,followers:0}));function f(){try{const o=t.index.getStorageSync("token"),s=t.index.getStorageSync("userInfo");o&&s?(u.value=JSON.parse(s),c.value=!0,i.isAuthenticated||(i.token=o,i.user=u.value),u.value&&u.value.avatar&&i.user&&(i.user.avatar=u.value.avatar),function(){e(this,null,(function*(){if(i.isAuthenticated)try{const e=yield i.fetchUserStats();console.log("Loaded user stats:",e)}catch(e){console.error("获取用户统计数据失败:",e)}}))}()):p()}catch(o){console.error("加载用户信息失败:",o),p()}}function p(){u.value=null,c.value=!1,i.isAuthenticated&&(i.user=null,i.token=null,i.stats=null)}function v(){i.isAuthenticated?a.showModal({title:"退出登录",content:"确定要退出登录吗？",showCancel:!0}).then((e=>{e&&i.logout().then((()=>{p(),a.showToast("已成功退出登录")})).catch((e=>{console.error("退出登录失败:",e),a.showToast("退出登录失败，请重试")}))})):a.navigateTo("/pages/login/login")}function w(){return e(this,null,(function*(){if(!i.isAuthenticated)return a.showToast("请先登录");try{const o=(yield new Promise(((e,o)=>{t.index.chooseImage({count:6,sizeType:["compressed"],sourceType:["album","camera"],success:e,fail:o})}))).tempFilePaths;a.showToast("上传中...");try{const e=yield i.uploadAvatar(o);e&&(e.avatar||e.data&&e.data.avatar)?(a.showToast("头像上传成功"),yield i.fetchUserInfo()):a.showToast("头像上传失败，请重试")}catch(e){console.error("头像上传失败:",e),a.showToast("头像上传失败，请重试")}}catch(e){console.error("选择图片失败:",e)}}))}function m(){if(!i.isAuthenticated)return a.showToast("请先登录");a.navigateTo("/pages/profile/profile")}function T(){i.isAuthenticated?(console.log("开始导航到添加宠物页面"),t.index.navigateTo({url:"/pages/pet/edit?mode=add",success:e=>{console.log("导航到添加宠物页面成功",e)},fail:e=>{console.error("导航到添加宠物页面失败:",e),t.index.navigateTo({url:"/pages/pet/edit",success:()=>{console.log("使用简化路径导航成功");const e=getCurrentPages(),t=e[e.length-1];t&&t.$vm&&(t.$vm.mode="add",console.log("手动设置页面mode=add"))},fail:e=>{console.error("使用简化路径仍然失败:",e),t.index.navigateTo({url:"/pages/pet/management",success:()=>{console.log("导航到宠物管理页面成功"),a.showToast("请点击添加宠物按钮")},fail:()=>{a.showToast("页面跳转失败，请稍后再试")}})}})}})):a.showToast("请先登录")}function S(e){c.value||"/pages/login/login"===e?a.navigateTo(e):a.showToast("Please login first")}function y(e){if(!e)return"/static/images/default-pet.png";if(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("/static/"))return e;if(e.startsWith("/uploads")){return(t.index.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}if(e.startsWith("uploads/")){return(t.index.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+"/"+e}return"/static/images/default-pet.png"}function _(e){if(!i.isAuthenticated)return a.showToast("请先登录"),void setTimeout((()=>{S("/pages/login/login")}),1500);"following"===e?S("/pages/profile/following"):"followers"===e&&S("/pages/profile/followers")}function x(){i.isAuthenticated?a.navigateTo("/pages/pet/recognition"):a.showToast("请先登录")}return t.ref([]),t.onMounted((()=>{const e=t.index.getStorageSync("token"),o=t.index.getStorageSync("userInfo");if(e&&o){if(f(),l.fetchPets(),i.token){const e=t.index.getStorageSync("userInfo");if(e)try{const t=JSON.parse(e);t&&t._id&&(i.user=t,console.log("已从缓存加载用户信息:",t))}catch(s){console.error("解析存储的用户信息失败:",s)}setTimeout((()=>{i.fetchUserInfo().then((()=>{console.log("已从服务器更新用户信息")})).catch((e=>{console.error("从服务器更新用户信息失败:",e)}))}),500)}}else t.index.navigateTo({url:"/pages/login/login",success:()=>{a.showToast("请先登录")}})})),t.watch((()=>i.user),(e=>{console.log("User store changed, refresh data"),e&&(i.fetchUserStats(),l.fetchPets())}),{deep:!0}),t.watch((()=>l.pets),(e=>{console.log("Pet list updated, total pets:",e.length)}),{deep:!0}),(e,o)=>t.e({a:d.value,b:t.o(w),c:t.t(t.unref(i).nickname),d:t.t(t.unref(i).userId),e:t.o(m),f:t.t(h.value.walkCount||0),g:t.o((e=>S("/pages/walk/history"))),h:t.t(h.value.totalDistance||0),i:t.o((e=>S("/pages/walk/history"))),j:t.t(h.value.following||0),k:t.o((e=>_("following"))),l:t.t(h.value.followers||0),m:t.o((e=>_("followers"))),n:t.o(T),o:t.unref(l).pets.length>0},t.unref(l).pets.length>0?{p:t.f(t.unref(l).pets,((e,o,s)=>({a:y(e.avatar),b:t.t(e.name),c:t.t(e.breed),d:e.id||e._id,e:t.o((t=>{return o=e._id||e.id,void(c.value?a.navigateTo(`/pages/pet/edit?petId=${o}&mode=edit`):a.showToast("请先登录"));var o}),e.id||e._id)})))}:{},{q:t.o((e=>S("/pages/walk/history"))),r:t.o((e=>S("/pages/community/my-posts"))),s:t.o((e=>S("/pages/profile/my-markers"))),t:t.o(x),v:t.o((e=>S("/pages/profile/settings"))),w:t.t(t.unref(i).isAuthenticated?"退出登录":"登录/注册"),x:t.o(v)})}};wx.createPage(r);
