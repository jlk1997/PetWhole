"use strict";var e=Object.defineProperty,t=Object.defineProperties,a=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,r=(t,a,i)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[a]=i;const o=require("../../common/vendor.js"),l=require("../../store/user.js"),c=require("../../utils/petAnalysisService.js"),u={setup(){var e;const u=l.useUserStore();o.ref((null==(e=u.userInfo)?void 0:e.id)||"");const d=o.ref([]),g=o.ref(!1),m=o.ref(!1),h=o.ref({breed:"",englishName:"",breedConfidence:0,purity:"",features:"",characteristics:{friendliness:0,activity:0,trainability:0,grooming:0},note:"",petType:"",identified:!0,message:""}),p=e=>{h.value={identified:!1!==e.identified,message:e.message||"",breed:e.breed||"未识别",englishName:e.englishName||"",breedConfidence:e.breedConfidence||0,purity:e.purity||"未识别",features:e.features||"无法获取特征描述",characteristics:e.characteristics||{friendliness:0,activity:0,trainability:0,grooming:0},note:e.note||"",petType:e.petType||"unknown"},h.value.identified&&y(h.value)},y=e=>{try{const t=o.index.getStorageSync("petAnalysisHistory")||"[]",a=JSON.parse(t);a.unshift({id:"history-"+Date.now(),timestamp:Date.now(),result:e,images:d.value.map((e=>e.path))});const i=10;a.length>i&&a.splice(i),o.index.setStorageSync("petAnalysisHistory",JSON.stringify(a))}catch(t){console.error("保存分析历史失败:",t)}},f=e=>{o.index.setClipboardData({data:e,success:()=>{o.index.showToast({title:"分享内容已复制到剪贴板",icon:"none",duration:2e3})}})};return{imageList:d,maxImageCount:4,isAnalyzing:g,showResult:m,result:h,chooseImage:()=>{o.index.chooseImage({count:4-d.value.length,sizeType:["compressed"],sourceType:["album","camera"],success:e=>{const t=e.tempFiles.map((e=>({path:e.path,size:e.size,uploaded:!1})));d.value=[...d.value,...t]},fail:e=>{e.errMsg&&-1!==e.errMsg.indexOf("cancel")?console.log("用户取消选择图片"):(console.error("选择图片失败:",e),o.index.showToast({title:"选择图片失败",icon:"none"}))}})},deleteImage:e=>{d.value.splice(e,1),0===d.value.length&&(m.value=!1)},analyzeImages:()=>{return e=this,l=null,u=function*(){if(0!==d.value.length){g.value=!0,m.value=!1;try{o.index.showLoading({title:"正在分析图片...",mask:!0});const l=d.value.map((e=>e.path)),u=yield c.analyzePetImages(l);o.index.hideLoading(),!1===u.identified?(o.index.showToast({title:u.message||"无法识别，请尝试清晰的宠物照片",icon:"none",duration:3e3}),h.value=(e=((e,t)=>{for(var a in t||(t={}))s.call(t,a)&&r(e,a,t[a]);if(i)for(var a of i(t))n.call(t,a)&&r(e,a,t[a]);return e})({},u),t(e,a({breed:"未能识别",breedConfidence:0,purity:"未知",characteristics:{friendliness:0,activity:0,trainability:0,grooming:0}})))):(p(u),m.value=!0)}catch(l){console.error("分析失败:",l),o.index.hideLoading(),o.index.showToast({title:l.message||"分析失败，请重试",icon:"none",duration:3e3})}finally{g.value=!1}var e}else o.index.showToast({title:"请先上传宠物照片",icon:"none"})},new Promise(((t,a)=>{var i=e=>{try{n(u.next(e))}catch(t){a(t)}},s=e=>{try{n(u.throw(e))}catch(t){a(t)}},n=e=>e.done?t(e.value):Promise.resolve(e.value).then(i,s);n((u=u.apply(e,l)).next())}));var e,l,u},formatCharName:e=>({friendliness:"友善度",activity:"活跃度",trainability:"可训练性",grooming:"毛发护理需求"}[e]||e),shareResult:()=>{if(m.value)try{const e=`我的宠物是${h.value.breed}(${h.value.englishName})，${h.value.purity}，${h.value.features}`;f(e)}catch(e){console.error("分享处理异常:",e),f(`我的宠物是${h.value.breed}，${h.value.purity}`)}else o.index.showToast({title:"暂无结果可分享",icon:"none"})},saveResult:()=>{o.index.showToast({title:"正在生成图片...",icon:"none"}),setTimeout((()=>{o.index.showToast({title:"保存成功",icon:"success"})}),2e3)},goBack:()=>{o.index.navigateBack()}}}};const d=o._export_sfc(u,[["render",function(e,t,a,i,s,n){return o.e({a:o.o(((...e)=>i.goBack&&i.goBack(...e))),b:o.f(i.imageList,((e,t,a)=>({a:e.path,b:o.o((e=>i.deleteImage(t)),t),c:t}))),c:i.imageList.length<i.maxImageCount},i.imageList.length<i.maxImageCount?{d:o.o(((...e)=>i.chooseImage&&i.chooseImage(...e)))}:{},{e:o.t(i.isAnalyzing?"分析中...":"开始识别"),f:i.imageList.length>0?1:"",g:o.o(((...e)=>i.analyzeImages&&i.analyzeImages(...e))),h:i.showResult},i.showResult?o.e({i:o.t(i.result.breed),j:o.t(i.result.breedConfidence),k:o.t(i.result.purity),l:o.t(i.result.features),m:o.f(i.result.characteristics,((e,t,a)=>({a:o.t(i.formatCharName(t)),b:e+"%",c:o.t(e),d:t}))),n:i.result.note},i.result.note?{o:o.t(i.result.note)}:{},{p:o.o(((...e)=>i.shareResult&&i.shareResult(...e))),q:o.o(((...e)=>i.saveResult&&i.saveResult(...e)))}):{})}]]);wx.createPage(d);
