"use strict";var e=Object.defineProperty,o=Object.defineProperties,t=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,r=(o,t,n)=>t in o?e(o,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):o[t]=n,i=(e,o)=>{for(var t in o||(o={}))a.call(o,t)&&r(e,t,o[t]);if(n)for(var t of n(o))l.call(o,t)&&r(e,t,o[t]);return e},s=(e,n)=>o(e,t(n)),c=(e,o,t)=>new Promise(((n,a)=>{var l=e=>{try{i(t.next(e))}catch(o){a(o)}},r=e=>{try{i(t.throw(e))}catch(o){a(o)}},i=e=>e.done?n(e.value):Promise.resolve(e.value).then(l,r);i((t=t.apply(e,o)).next())}));const u=require("../../common/vendor.js"),d=require("../../store/user.js"),g=require("../../store/pet.js"),v=require("../../store/location.js"),h=require("../../stores/markerStore.js"),f=require("../../utils/amap.js"),m=require("../../utils/api.js"),p=require("../../utils/request.js"),w=require("../../static/images/marker-icons.js");var I={VITE_CJS_IGNORE_WARNING:"true",VITE_ROOT_DIR:"D:/caloriesH5/CloudStorage",VITE_USER_NODE_ENV:"production",BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1};const k={components:{UserInfoPopup:()=>"../../components/map/UserInfoPopup.js",WalkSummaryPopup:()=>"../../components/map/WalkSummaryPopup.js"},setup(){const e=d.useUserStore(),o=g.usePetStore(),t=v.useLocationStore(),n=h.useMarkerStore(),a=u.ref(!0),l=u.ref(null),r={};const k={cache:{},get(e){const o=this.normalizeUrl(e);return this.cache[o]||null},put(e,o){const t=this.normalizeUrl(e);return this.cache[t]=o,console.log("å¤´åƒç¼“å­˜æ›´æ–°ï¼Œå½“å‰ç¼“å­˜æ•°:",Object.keys(this.cache).length),o},remove(e){const o=this.normalizeUrl(e);return!!this.cache[o]&&(delete this.cache[o],!0)},clear(){return this.cache={},console.log("å¤´åƒç¼“å­˜å·²æ¸…ç©º"),!0},normalizeUrl(e){if(!e)return"";let o=e.split("?")[0];if(o.startsWith("/uploads/")){o=(I.VITE_API_URL||"http://49.235.65.37:5000")+o}return o}};function y(){const o={motionEvent:!1,deviceOrientation:!1,geolocation:!1,compass:!1,manualSet:!0};let t=null;function n(o,n){"compass"===n||"geolocation"===n||"deviceorientationevent"!==n&&"uniapp-motion"!==n||(o=(360-o)%360);const a={movement:5,geolocation:4,deviceorientationevent:3,"uniapp-motion":2,compass:1,manual:0};(!t||a[n]>a[t])&&(t=n),n===t&&(re.value=o,function(o){var t;const n=(null==(t=e.userInfo)?void 0:t.id)||"current-user-location";r[n]&&r[n].setRotation&&r[n].setRotation(o)}(o))}return function(){try{"undefined"!=typeof DeviceOrientationEvent&&(o.motionEvent=!0,window.addEventListener("deviceorientation",(e=>{if(null!==e.alpha&&void 0!==e.alpha){n(e.alpha,"deviceorientationevent")}})),console.log("å·²æ³¨å†Œè®¾å¤‡æ–¹å‘äº‹ä»¶ç›‘å¬å™¨"))}catch(e){console.warn("è®¾å¤‡æ–¹å‘äº‹ä»¶ä¸å¯ç”¨:",e)}try{"function"==typeof u.index.onDeviceMotionChange&&(u.index.startDeviceMotionListening({interval:"game",success:()=>{o.deviceOrientation=!0,console.log("uni-appè®¾å¤‡æ–¹å‘ç›‘å¬å¯åŠ¨æˆåŠŸ")},fail:e=>{console.warn("uni-appè®¾å¤‡æ–¹å‘ç›‘å¬å¯åŠ¨å¤±è´¥",e)}}),u.index.onDeviceMotionChange((e=>{if(void 0!==e.alpha){n(e.alpha,"uniapp-motion")}})))}catch(e){console.warn("uni-appè®¾å¤‡æ–¹å‘APIä¸å¯ç”¨:",e)}try{navigator.geolocation&&navigator.geolocation.watchPosition&&(navigator.geolocation.watchPosition((e=>{if(null!==e.coords.heading&&void 0!==e.coords.heading){o.geolocation=!0;n(e.coords.heading,"geolocation")}}),(e=>{console.warn("åœ°ç†ä½ç½®æ–¹å‘è·Ÿè¸ªé”™è¯¯:",e)}),{enableHighAccuracy:!0,maximumAge:0}),console.log("å·²å¯åŠ¨åœ°ç†ä½ç½®æ–¹å‘è·Ÿè¸ª"))}catch(e){console.warn("åœ°ç†ä½ç½®æ–¹å‘APIä¸å¯ç”¨:",e)}try{"function"==typeof u.index.onCompassChange&&(u.index.onCompassChange((e=>{if(void 0!==e.direction){o.compass=!0;n(e.direction,"compass")}})),console.log("å·²å¯åŠ¨æŒ‡å—é’ˆæ–¹å‘è·Ÿè¸ª"))}catch(e){console.warn("æŒ‡å—é’ˆAPIä¸å¯ç”¨:",e)}!function(){const e=[],o=5;u.watch(O,((t,a)=>{if(t&&a){const l=f.calculateDistance(a.latitude,a.longitude,t.latitude,t.longitude);if(l>5){const r=function(e,o,t,n){e=e*Math.PI/180,o=o*Math.PI/180,t=t*Math.PI/180,n=n*Math.PI/180;const a=Math.sin(n-o)*Math.cos(t),l=Math.cos(e)*Math.sin(t)-Math.sin(e)*Math.cos(t)*Math.cos(n-o);let r=180*Math.atan2(a,l)/Math.PI;return r=(r+360)%360,r}(a.latitude,a.longitude,t.latitude,t.longitude);if(e.push({location:t,timestamp:Date.now(),bearing:r,distance:l}),e.length>o&&e.shift(),e.length>=2){let o=0,t=0;if(e.forEach(((n,a)=>{const l=(a+1)/e.length*Math.min(n.distance/10,1);o+=n.bearing*l,t+=l})),t>0){n(o/t,"movement")}}}}}),{deep:!0})}(),setTimeout((()=>{console.log("æ–¹å‘ä¼ æ„Ÿå™¨å¯ç”¨æ€§:",o),o.motionEvent||o.deviceOrientation||o.geolocation||o.compass||(console.warn("æ²¡æœ‰å¯ç”¨çš„æ–¹å‘ä¼ æ„Ÿå™¨ï¼Œç”¨æˆ·å¤´åƒå°†ä¸ä¼šæ—‹è½¬"),te.value&&u.index.showToast({title:"è®¾å¤‡ä¸æ”¯æŒæ–¹å‘ä¼ æ„Ÿå™¨",icon:"none",duration:2e3}))}),3e3)}(),{setManualHeading:e=>{n(e,"manual")},getOrientationInfo:()=>({currentHeading:re.value,currentSource:t,supportInfo:i({},o)})}}const M=u.ref(!0),A=u.ref(!1),x=u.ref(null),D=()=>{if(M.value=!M.value,l.value){const e=l.value.getAllOverlays("circle"),o=l.value.getAllOverlays("marker").filter((e=>{const o=e.getExtData();return!(o&&o.isUserMarker)}));M.value?(o.forEach((e=>{e.show()})),e.forEach((e=>{e.show()})),console.log("æ˜¾ç¤ºæ‰€æœ‰æ ‡è®°å’Œè¦†ç›–åŒºåŸŸ")):(o.forEach((e=>{e.hide()})),e.forEach((e=>{e.hide()})),console.log("éšè—æ‰€æœ‰æ ‡è®°å’Œè¦†ç›–åŒºåŸŸï¼Œç”¨æˆ·å¤´åƒä¿æŒæ˜¾ç¤º")),S()}},S=()=>{if(!l.value)return;l.value.getAllOverlays("marker").filter((e=>{const o=e.getExtData();return o&&o.isUserMarker})).forEach((e=>{e.setzIndex(1e3),e.show()}))},T=()=>c(this,null,(function*(){try{if(console.log("åŠ è½½æ ‡è®°æ•°æ®..."),!O.value)return void console.warn("å½“å‰ä½ç½®ä¸å¯ç”¨ï¼Œæ— æ³•åŠ è½½é™„è¿‘æ ‡è®°");console.log("æ­£åœ¨ä»æœåŠ¡å™¨è·å–é™„è¿‘æ ‡è®°..."),console.log("å½“å‰ä½ç½®:",O.value);const o={show:()=>{u.index.showLoading({title:"åŠ è½½æ ‡è®°ä¸­...",mask:!1})},hide:()=>{u.index.hideLoading()}};o.show();try{const e=yield n.fetchNearbyMarkers({longitude:O.value.longitude,latitude:O.value.latitude,radius:5e3});o.hide(),console.log("è·å–åˆ°é™„è¿‘æ ‡è®°:",e.length);const t=e.map((e=>{const o=i({},e);return o.latitude&&o.longitude||o.location&&o.location.coordinates&&(o.longitude=o.location.coordinates[0],o.latitude=o.location.coordinates[1]),void 0===o.radius||null===o.radius?(o.radius=.5,console.log(`æ ‡è®° ${o.title||"æœªå‘½å"} æ²¡æœ‰åŠå¾„ï¼Œè®¾ç½®é»˜è®¤å€¼0.5å…¬é‡Œ`)):console.log(`æ ‡è®° ${o.title||"æœªå‘½å"} åŠå¾„: ${o.radius}`),o.color||(o.color=o.color||"#007AFF"),o}));P(t),0===t.length&&u.index.showToast({title:"é™„è¿‘æ²¡æœ‰æ ‡è®°",icon:"none",duration:2e3})}catch(e){if(o.hide(),console.error("APIè·å–æ ‡è®°å¤±è´¥:",e),u.index.showToast({title:"åŠ è½½æ ‡è®°å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none",duration:2e3}),n.markerCache&&n.markerCache.data&&n.markerCache.data.length>0){console.log("å°è¯•ä½¿ç”¨ç¼“å­˜çš„æ ‡è®°æ•°æ®");const e=n.filterMarkersByDistance(n.markerCache.data,{latitude:O.value.latitude,longitude:O.value.longitude,radius:5e3});if(e.length>0){const o=e.map((e=>(e.latitude&&e.longitude||e.location&&e.location.coordinates&&(e.longitude=e.location.coordinates[0],e.latitude=e.location.coordinates[1]),e.radius=e.radius||500,e.color=e.color||"#007AFF",e)));P(o),u.index.showToast({title:"æ˜¾ç¤ºç¼“å­˜çš„æ ‡è®°æ•°æ®",icon:"none",duration:2e3})}else P([])}else P([])}}catch(o){console.error("åŠ è½½æ ‡è®°æ•°æ®å¤±è´¥:",o),u.index.hideLoading(),u.index.showToast({title:"åŠ è½½æ ‡è®°å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none",duration:2e3})}})),P=e=>{try{if(console.log("æ˜¾ç¤ºæ ‡è®°æ•°æ®:",e),!e||!e.length)return void console.log("æ²¡æœ‰æ ‡è®°å¯æ˜¾ç¤º");if(l.value){const e=l.value.getAllOverlays("marker").filter((e=>{const o=e.getExtData();return!(o&&o.isUserMarker)}));e.length>0&&l.value.remove(e),l.value.remove(l.value.getAllOverlays("circle"))}e.forEach((e=>{var o,t,a,r;try{console.log("æ·»åŠ æ ‡è®°:",e);const i=[e.longitude||(null==(t=null==(o=e.location)?void 0:o.coordinates)?void 0:t[0]),e.latitude||(null==(r=null==(a=e.location)?void 0:a.coordinates)?void 0:r[1])];if(!i[0]||!i[1])return void console.warn("æ ‡è®°ä½ç½®æ— æ•ˆ:",i);e.title||(e.title=e.title||"æœªå‘½åæ ‡è®°"),e.type||(e.type=e.type||"general");const s=new AMap.Marker({position:i,title:e.title,icon:e.icon||C(e.type),anchor:"bottom-center",offset:new AMap.Pixel(0,0),extData:{marker:e,id:e._id,type:"marker"},clickable:!0});if(l.value.add(s),s.on("click",(o=>{console.log("æ ‡è®°è¢«ç‚¹å‡»:",e),n.setSelectedMarker(e),b(e)})),e.radius){let o;if("number"==typeof e.radius)e.radius<100?(o=1e3*e.radius,console.log(`æ ‡è®° "${e.title||"æœªå‘½å"}" [${e._id}] - è½¬æ¢åŠå¾„ä» ${e.radius}km åˆ° ${o}m`)):(o=e.radius,console.log(`æ ‡è®° "${e.title||"æœªå‘½å"}" [${e._id}] - ä½¿ç”¨åŸå§‹åŠå¾„ ${o}m`));else{const t=parseFloat(e.radius)||.5;o=t<100?1e3*t:t,console.log(`æ ‡è®° "${e.title||"æœªå‘½å"}" [${e._id}] - ä»å­—ç¬¦ä¸²è½¬æ¢åŠå¾„: ${e.radius} -> ${o}m`)}console.log(`æœ€ç»ˆä½¿ç”¨çš„è¦†ç›–åŠå¾„: ${o}ç±³ (åŸå§‹å€¼: ${e.radius})`);const t=new AMap.Circle({center:i,radius:o,strokeColor:e.color||"#1E90FF",strokeWeight:2,strokeOpacity:.8,fillColor:e.color||"#1E90FF",fillOpacity:.15,extData:{marker:e}});l.value.add(t),t.on("click",(o=>{console.log("æ ‡è®°åŒºåŸŸè¢«ç‚¹å‡»:",e),n.setSelectedMarker(e);const t=o.target,a=t.getOptions().strokeColor,l=t.getOptions().fillColor,r=t.getOptions().fillOpacity;t.setOptions({strokeColor:"#FF3B30",fillColor:"#FF3B30",fillOpacity:.3}),setTimeout((()=>{t.setOptions({strokeColor:a,fillColor:l,fillOpacity:r})}),1e3),b(e)}))}}catch(i){console.error("æ·»åŠ å•ä¸ªæ ‡è®°æ—¶å‡ºé”™:",i)}})),console.log("æ ‡è®°æ˜¾ç¤ºå®Œæˆ"),S(),M.value||(D(),D())}catch(o){console.error("æ˜¾ç¤ºæ ‡è®°æ—¶å‡ºé”™:",o)}},C=e=>{if(w.markerIconsBase64&&w.markerIconsBase64[e])return w.markerIconsBase64[e];const o={general:"/static/images/marker.png",pet_friendly:"/static/images/pet-marker.png",danger:"/static/images/danger-marker.png",scenic:"/static/images/park-marker.png",pet_service:"/static/images/shop-marker.png",custom:"/static/images/marker.png"};return o[e]||o.general},b=e=>{var o,t,a,r;if(e)try{console.log("æ˜¾ç¤ºæ ‡è®°è¯¦æƒ…å¼¹çª—, åŸå§‹æ•°æ®:",e);let s=e;if(e instanceof AMap.Marker){const o=e.getExtData();if(o&&o.marker)s=o.marker,console.log("ä»æ ‡è®°extDataä¸­è·å–åˆ°æ ‡è®°æ•°æ®:",s);else if(o&&o.id){const e=n.markers.find((e=>e._id===o.id));e&&(s=e,console.log("ä»storeä¸­è·å–åˆ°æ ‡è®°æ•°æ®:",s))}else console.warn("æ ‡è®°ä¸åŒ…å«æœ‰æ•ˆçš„extDataæ•°æ®")}s.title||(s.title="æœªå‘½åæ ‡è®°"),s.type||(s.type="general"),console.log("å¤„ç†åçš„æ ‡è®°æ•°æ®:",s),n.setSelectedMarker(s);const c=s.longitude||(null==(t=null==(o=s.location)?void 0:o.coordinates)?void 0:t[0]),d=s.latitude||(null==(r=null==(a=s.location)?void 0:a.coordinates)?void 0:r[1]);if(e instanceof AMap.Marker&&"function"==typeof e.setAnimation)try{e.setAnimation("AMAP_ANIMATION_BOUNCE"),setTimeout((()=>{e&&"function"==typeof e.setAnimation&&e.setAnimation(null)}),2e3)}catch(i){console.warn("è®¾ç½®æ ‡è®°åŠ¨ç”»æ•ˆæœå¤±è´¥:",i),"function"==typeof e.setzIndex&&e.setzIndex(999)}if(s.images&&s.images.length>0){console.log("æ ‡è®°åŒ…å«å›¾ç‰‡ï¼Œè·³è½¬åˆ°è¯¦æƒ…é¡µé¢"),s.user&&"string"==typeof s.user&&(console.log("æ ‡è®°åªåŒ…å«ç”¨æˆ·IDï¼Œåˆå§‹åŒ–åŸºæœ¬ç”¨æˆ·å¯¹è±¡"),s._processedUserInfo||(s._processedUserInfo=!0,s._originalUserId=s.user));const e=s._id;e?u.index.navigateTo({url:`/pages/map/marker-detail?id=${e}`}):u.index.showToast({title:"æ— æ³•è·å–æ ‡è®°è¯¦æƒ…",icon:"none"})}else null!=x?(x.value=s,A.value=!0):(console.error("selectedMarkeræœªå®šä¹‰"),u.index.showModal({title:s.title||"æœªå‘½åæ ‡è®°",content:s.description||"æ— æè¿°ä¿¡æ¯",showCancel:!0,cancelText:"å…³é—­",confirmText:"å¯¼èˆª",success:e=>{e.confirm&&c&&d&&l.value&&(l.value.setCenter([c,d]),l.value.setZoom(17))}}))}catch(s){console.error("æ˜¾ç¤ºæ ‡è®°ä¿¡æ¯å¤±è´¥:",s),u.index.showToast({title:"æ˜¾ç¤ºæ ‡è®°ä¿¡æ¯å¤±è´¥",icon:"none"})}},U=()=>{if(l.value)return l.value;if(console.error("åœ°å›¾æœªåˆå§‹åŒ–ï¼Œå°è¯•è·å–åœ°å›¾å®ä¾‹"),"undefined"!=typeof window&&window.__dogRunMapInstance)return console.log("ä»å…¨å±€å˜é‡è·å–åœ°å›¾å®ä¾‹"),l.value=window.__dogRunMapInstance,l.value;if("undefined"!=typeof window&&window.AMap){const o=document.getElementById("map-container");if(o&&o.__amap_instance__)return l.value=o.__amap_instance__,console.log("å·²ä»DOMå…ƒç´ è·å–åœ°å›¾å®ä¾‹"),l.value;if(console.log("å°è¯•é‡æ–°åˆ›å»ºåœ°å›¾å®ä¾‹"),!o)throw new Error("æ— æ³•è·å–åœ°å›¾å®¹å™¨");try{return l.value=new window.AMap.Map("map-container",{zoom:15,center:[O.value.longitude,O.value.latitude],resizeEnable:!0}),window.__dogRunMapInstance=l.value,o.__amap_instance__=l.value,console.log("åœ°å›¾å®ä¾‹å·²é‡æ–°åˆ›å»º"),l.value}catch(e){throw console.error("æ— æ³•åˆ›å»ºåœ°å›¾å®ä¾‹:",e),new Error("æ— æ³•åˆ›å»ºåœ°å›¾å®ä¾‹: "+e.message)}}throw new Error("åœ°å›¾APIæœªåŠ è½½")};function E(e,o=!1){if(o&&console.log("getFullAvatarUrlå¤„ç†:",e),!e)return o&&console.log("æ²¡æœ‰æä¾›avatarPathï¼Œè¿”å›é»˜è®¤å¤´åƒ"),ie;if(e.startsWith("data:image/"))return o&&console.log("æ˜¯base64å›¾ç‰‡ï¼Œç›´æ¥è¿”å›"),e;if(e.startsWith("http://")||e.startsWith("https://")){o&&console.log("å·²ç»æ˜¯å®Œæ•´URLï¼Œç›´æ¥è¿”å›:",e);return e.replace(/["']/g,"")}const t=u.index.getStorageSync("BASE_URL")||"http://49.235.65.37:5000";if(e.startsWith("/uploads/")){const n=t+e;return o&&console.log("æ˜¯ä¸Šä¼ è·¯å¾„ï¼Œæ·»åŠ åŸºç¡€URL:",n),n}if(e.startsWith("uploads/")){const n=t+"/"+e;return o&&console.log("æ˜¯ä¸å¸¦å‰å¯¼æ–œæ çš„ä¸Šä¼ è·¯å¾„ï¼Œæ·»åŠ åŸºç¡€URL:",n),n}o&&console.log("æœªè¯†åˆ«çš„è·¯å¾„ç±»å‹ï¼Œå°è¯•æ·»åŠ åŸºç¡€URL:",e);return t+"/"+(e.startsWith("/")?e.substring(1):e)}const _=u.ref(16),O=u.ref({latitude:39.9087,longitude:116.3975}),L=u.ref([]),$=u.ref(null),F=u.ref(null),R=u.ref([]),W=u.ref(!1),B=u.ref([]),j=u.ref(0),N=u.ref(0),z=u.ref(null),q=u.ref(null),V=u.ref([]),G=u.ref(!1),Q=u.ref(null),K=u.ref([]),Y=u.ref(!1),H=u.ref(!1),Z=u.ref(!1),J=u.ref(""),X=u.ref([]),ee=u.computed((()=>X.value.map((e=>e.name)))),oe=u.ref(0),te=u.ref(!1),ne=u.ref({markerCount:0,markerIds:[],coords:[]}),ae=u.ref(!1),le=u.ref(!0),re=u.ref(0),ie="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAAAXNSR0IArs4c6QAAAQNJREFUeF7t1LENACAMBDFYm+WDxAhc6/TXWK/sdWaW+xbYAL/tXgiw+QGMfgABVoHY+4EAo0DMLRBgFIi5BQKMAjG3QIBRIOYWCDAKxNwCAUaBmFsgwCgQcwsEGAViboEAo0DMLRBgFIi5BQKMAjG3QIBRIOYWCDAKxNwCAUaBmFsgwCgQcwsEGAViboEAo0DMLRBgFIi5BQKMAjG3QIBRIOYWCDAKxNwCAUaBmFsgwCgQcwsEGAViboEAo0DMLRBgFIi5BQKMAjG3QIBRIOYWCDAKxPwCxDvF0aa/hxYAAAAASUVORK5CYII=",se=u.computed((()=>{const o=e.userInfo||e.user||{};return console.log("ç”¨æˆ·ä¿¡æ¯çŠ¶æ€:",{"userStore.userAvatarå­˜åœ¨":!!e.userAvatar,"userStore.userInfoå­˜åœ¨":!!e.userInfo,"userStore.userå­˜åœ¨":!!e.user,"å¤´åƒè·¯å¾„":o.avatar||e.userAvatar}),e.userAvatar?E(e.userAvatar,!0):o.avatar?(console.log("å¤´åƒè®¡ç®—ç»†èŠ‚:",{"åŸå§‹è·¯å¾„":o.avatar,"æ˜¯å¦ä»¥ä¸Šä¼ è·¯å¾„å¼€å¤´":o.avatar.startsWith("/uploads/"),"ç¯å¢ƒå˜é‡":u.index.getStorageSync("BASE_URL")||"http://49.235.65.37:5000"}),E(o.avatar,!0)):(console.log("æœªæ‰¾åˆ°ç”¨æˆ·å¤´åƒï¼Œä½¿ç”¨é»˜è®¤è“è‰²å¤´åƒ"),ie)})),ce=u.ref(null),ue=u.computed((()=>{let e=[...L.value];if(ce.value)e=e.filter((e=>"user-location"!==e.id)),e.push(ce.value),console.log("æ·»åŠ ç”¨æˆ·ä½ç½®æ ‡è®°:",ce.value);else if(O.value&&O.value.latitude){const o={id:"user-location",latitude:O.value.latitude,longitude:O.value.longitude,iconPath:se.value,width:40,height:40,rotate:re.value,anchor:{x:.5,y:.5}};e.push(o),console.log("æ·»åŠ ä¸´æ—¶ç”¨æˆ·æ ‡è®°:",o)}else console.warn("ç”¨æˆ·ä½ç½®æ ‡è®°æœªåˆ›å»ºï¼Œä¸”æ²¡æœ‰ä½ç½®ä¿¡æ¯");return e}));function de(){if(le.value)try{console.log("æ›´æ–°ä½ç½®å…±äº«:",{latitude:O.value.latitude,longitude:O.value.longitude}),console.log("ä½ç½®å…±äº«å·²åœ¨æœ¬åœ°æ›´æ–°ï¼ˆä¸è°ƒç”¨APIï¼‰");try{t&&"function"==typeof t.updateLocation&&t.updateLocation({latitude:O.value.latitude,longitude:O.value.longitude,timestamp:(new Date).toISOString()}).catch((e=>{console.warn("æ›´æ–°ä½ç½®APIè°ƒç”¨å¤±è´¥ï¼ˆå·²å¿½ç•¥ï¼‰:",e)}))}catch(e){console.warn("ä½ç½®APIè°ƒç”¨å°è¯•å¤±è´¥ï¼ˆå·²å¿½ç•¥ï¼‰:",e)}}catch(o){console.error("æ›´æ–°ä½ç½®å…±äº«çŠ¶æ€å¤±è´¥:",o)}}function ge(o=0){return c(this,null,(function*(){try{if(!l.value)return console.log("åœ°å›¾æœªå‡†å¤‡å¥½ï¼Œå»¶è¿Ÿè·å–é™„è¿‘ç”¨æˆ·"),o<5&&setTimeout((()=>ge(o+1)),1500),Promise.resolve({success:!1,message:"åœ°å›¾æœªå‡†å¤‡å¥½"});if(!a.value)return console.log("åç«¯APIä¸å¯ç”¨ï¼Œä¸è·å–é™„è¿‘ç”¨æˆ·"),R.value=[],Promise.resolve({success:!1,message:"åç«¯APIä¸å¯ç”¨"});if(!le.value)return console.log("ä½ç½®å…±äº«æœªå¼€å¯ï¼Œä¸è·å–é™„è¿‘ç”¨æˆ·"),Promise.resolve({success:!1,message:"ä½ç½®å…±äº«æœªå¼€å¯"});if(!O.value||!O.value.latitude||!O.value.longitude)return console.error("å½“å‰ä½ç½®ä¸å¯ç”¨ï¼Œç¨åé‡è¯•è·å–é™„è¿‘ç”¨æˆ·"),o<5&&setTimeout((()=>ge(o+1)),1500),Promise.resolve({success:!1,message:"å½“å‰ä½ç½®ä¸å¯ç”¨"});console.log("è·å–é™„è¿‘ç”¨æˆ·...");const n=yield t.getNearbyUsers({latitude:O.value.latitude,longitude:O.value.longitude,maxDistance:5e3}).catch((e=>(console.error("ä½ç½®APIé”™è¯¯:",e),o<3&&(console.log(`è·å–é™„è¿‘ç”¨æˆ·å¤±è´¥ï¼Œ${o+1}/3æ¬¡é‡è¯•`),setTimeout((()=>ge(o+1)),2e3)),{success:!1,message:"ä½ç½®APIé”™è¯¯"})));if(n&&n.success&&Array.isArray(n.data)){let o=[];if(e.userInfo&&e.userInfo.id?(o=n.data.filter((o=>o.id!==e.userInfo.id)),console.log("è¿‡æ»¤åçš„å…¶ä»–ç”¨æˆ·æ•°é‡:",o.length)):(o=n.data,console.log("æœªè¿‡æ»¤çš„ç”¨æˆ·æ•°é‡:",o.length)),e.userInfo&&O.value){const t=s(i({},e.userInfo),{latitude:O.value.latitude,longitude:O.value.longitude,lastUpdated:(new Date).toISOString()});o.length>0?(R.value=[t,...o],console.log("åˆå¹¶åçš„ç”¨æˆ·åˆ—è¡¨:",R.value.length,"ä¸ªç”¨æˆ· (å½“å‰ç”¨æˆ· + å…¶ä»–ç”¨æˆ·)")):(R.value=[t],console.log("ç”¨æˆ·åˆ—è¡¨åªåŒ…å«å½“å‰ç”¨æˆ·"))}else R.value=o,console.log("ç”¨æˆ·åˆ—è¡¨ä¸åŒ…å«å½“å‰ç”¨æˆ·(æœªç™»å½•æˆ–æ— ä½ç½®)");return ve(),console.log("è·å–åˆ°é™„è¿‘ç”¨æˆ·:",R.value.length),Promise.resolve(n)}if(console.log("æœªè·å–åˆ°é™„è¿‘ç”¨æˆ·æˆ–æ ¼å¼é”™è¯¯:",n),e.userInfo&&O.value){const o=s(i({},e.userInfo),{latitude:O.value.latitude,longitude:O.value.longitude,lastUpdated:(new Date).toISOString()});R.value=[o],console.log("APIå¤±è´¥ï¼Œåªæ˜¾ç¤ºå½“å‰ç”¨æˆ·"),ve()}else R.value=[],console.log("APIå¤±è´¥ï¼Œä¸”æ— å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ŒnearbyUsersä¸ºç©º");return!(o<3)||e.userInfo&&O.value||(console.log(`APIå¤±è´¥ï¼Œ${o+1}/3æ¬¡é‡è¯•`),setTimeout((()=>ge(o+1)),2e3)),Promise.resolve({success:!1,message:"æ— é™„è¿‘ç”¨æˆ·",response:n})}catch(n){if(console.error("è·å–é™„è¿‘ç”¨æˆ·å¤±è´¥",n),e.userInfo&&O.value){const o=s(i({},e.userInfo),{latitude:O.value.latitude,longitude:O.value.longitude,lastUpdated:(new Date).toISOString()});R.value=[o],console.log("å¼‚å¸¸æƒ…å†µä¸‹ï¼Œåªæ˜¾ç¤ºå½“å‰ç”¨æˆ·"),ve()}else R.value=[],console.log("å¼‚å¸¸æƒ…å†µä¸‹ï¼Œä¸”æ— å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ŒnearbyUsersä¸ºç©º");return o<3&&(console.log(`å¼‚å¸¸æƒ…å†µï¼Œ${o+1}/3æ¬¡é‡è¯•`),setTimeout((()=>ge(o+1)),2e3)),Promise.reject(n)}}))}function ve(){try{if(!R.value||!R.value.length)return console.log("æ²¡æœ‰é™„è¿‘ç”¨æˆ·ï¼Œæ¸…é™¤éè‡ªèº«æ ‡è®°"),void(l.value&&ue.value&&(ue.value.forEach((o=>{var t,n;const a=null==(t=null==o?void 0:o.extData)?void 0:t.userId,r=null==(n=e.userInfo)?void 0:n.id;console.log("æ ‡è®°ID:",a,"å½“å‰ç”¨æˆ·ID:",r),a&&r&&a!==r&&(console.log("ç§»é™¤éæœ¬äººæ ‡è®°:",a),l.value.remove(o))})),ue.value=ue.value.filter((o=>{var t;return!o.extData||!o.extData.userId||o.extData.userId===(null==(t=e.userInfo)?void 0:t.id)}))));console.log("æ›´æ–°é™„è¿‘ç”¨æˆ·æ ‡è®°ï¼Œç”¨æˆ·æ•°é‡:",R.value.length),ue.value&&ue.value.length>0&&ue.value.forEach((o=>{o&&o.extData&&o.extData.userId!==e.userInfo.id&&o.setMap(null)})),R.value.forEach((o=>{if(!o||!o.id||e.userInfo&&o.id===e.userInfo.id)return;if(!o.latitude||!o.longitude)return void console.log("ç”¨æˆ·ç¼ºå°‘ä½ç½®ä¿¡æ¯:",o.nickname||o.username);const t=String(o.id),n=[o.longitude,o.latitude];console.log(`åˆ›å»ºç”¨æˆ·[${t}]çš„æ ‡è®°:`,o.nickname||o.username);let a=o.userAvatar||o.avatar;if(a=E(a,!0),console.log("å¤„ç†ç”¨æˆ·æ ‡è®°:",t,o.nickname,"å¤´åƒ:",a?"æœ‰":"æ— "),a&&a.startsWith("data:image/"))return void pe(t,n,a);const l=new Image;l.crossOrigin="anonymous",l.onload=()=>{pe(t,n,a)},l.onerror=()=>{console.error("è·å–å¤´åƒå¤±è´¥ï¼Œç”¨æˆ·ID:",t),me(n,t)},l.src=a,setTimeout((()=>{l.complete&&0!==l.naturalWidth||(console.error("å¤´åƒåŠ è½½è¶…æ—¶ï¼Œç”¨æˆ·ID:",t),me(n,t))}),3e3)})),console.log("åœ°å›¾æ ‡è®°æ›´æ–°å®Œæˆ")}catch(o){console.error("æ›´æ–°åœ°å›¾æ ‡è®°æ—¶å‡ºé”™:",o)}}function he(o,t){if(O.value&&0!==O.value.latitude){const e=o.latitude-O.value.latitude,t=o.longitude-O.value.longitude;if(Math.abs(e)>1e-5||Math.abs(t)>1e-5){const o=180*Math.atan2(t,e)/Math.PI;console.log("æ–¹ä½è®¡ç®—ï¼š",{dLat:e,dLng:t,calculatedHeading:o}),re.value=o}}if(O.value=o,console.log("ä½ç½®å·²æ›´æ–°:",O.value),void 0!==t&&(re.value=t,console.log("ä½¿ç”¨ç½—ç›˜æœå‘:",t)),(!window._lastMarkerUpdateTime||Date.now()-window._lastMarkerUpdateTime>3e4)&&(window._lastMarkerUpdateTime=Date.now(),console.log("è§¦å‘å®šæœŸæ ‡è®°æ›´æ–°"),e.isAuthenticated&&e.userInfo&&e.userInfo.id&&(console.log("ä½¿ç”¨å®é™…ç”¨æˆ·IDæ›´æ–°æ ‡è®°:",e.userInfo.id),Ie())),W.value&&V.value.length>0){const e=V.value[V.value.length-1],t=f.calculateDistance(e.latitude,e.longitude,o.latitude,o.longitude);t>5&&(V.value.push({latitude:o.latitude,longitude:o.longitude}),B.value=[{points:V.value.map((e=>({latitude:e.latitude,longitude:e.longitude}))),color:"#007AFF",width:4}],j.value+=t)}}function fe(){u.index.getLocation({type:"gcj02",success:o=>{if(console.log("è·å–å½“å‰ä½ç½®æˆåŠŸ:",o),he({latitude:o.latitude,longitude:o.longitude}),l.value?(console.log("ä½ç½®è·å–æˆåŠŸï¼Œç«‹å³å°†åœ°å›¾ä¸­å¿ƒè®¾ç½®åˆ°å½“å‰ä½ç½®"),l.value.setCenter([o.longitude,o.latitude]),l.value.setZoom(16)):console.log("åœ°å›¾å°šæœªåˆå§‹åŒ–ï¼Œæ— æ³•è®¾ç½®ä¸­å¿ƒç‚¹"),e.hasDecidedLocationSharing||(ae.value=!0),window.AMap)try{const e=window.AMap;e.plugin(["AMap.Geolocation"],(function(){new e.Geolocation({enableHighAccuracy:!0,timeout:1e4,convert:!0,showButton:!1,showMarker:!1,showCircle:!1}).getCurrentPosition((function(e,o){"complete"===e?o.position&&(O.value={latitude:o.position.lat,longitude:o.position.lng},l.value&&l.value.setCenter([o.position.lng,o.position.lat])):console.log("é«˜å¾·åœ°å›¾å®šä½å¤±è´¥",o)}))}))}catch(t){console.error("é«˜å¾·åœ°å›¾åˆå§‹åŒ–å¤±è´¥:",t)}y()},fail:e=>{console.error("è·å–ä½ç½®å¤±è´¥",e),u.index.showToast({title:"è·å–ä½ç½®ä¿¡æ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥å®šä½æƒé™",icon:"none"})}}),$.value=setInterval((()=>{const e=W.value?5:15,o=Date.now(),t=o-(De.value||0);t<1e3*e?console.log(`è·ä¸Šæ¬¡ä½ç½®æ›´æ–°ä»…${Math.floor(t/1e3)}ç§’ï¼Œæœªè¾¾åˆ°${e}ç§’æ›´æ–°é—´éš”`):(De.value=o,u.index.getLocation({type:"gcj02",success:e=>{var o,t;const n=null==(o=O.value)?void 0:o.latitude,a=null==(t=O.value)?void 0:t.longitude;if(n&&a){const o=f.calculateDistance(n,a,e.latitude,e.longitude);if(o<5&&!W.value)return void console.log(`ä½ç½®å˜åŒ–å¤ªå°(${o.toFixed(2)}ç±³)ï¼Œå¿½ç•¥æ›´æ–°`)}"function"==typeof u.index.onCompassChange?u.index.onCompassChange((o=>{he({latitude:e.latitude,longitude:e.longitude},o.direction)})):he({latitude:e.latitude,longitude:e.longitude}),le.value&&de()}}))}),5e3),F.value=setInterval((()=>{ge()}),3e4)}function me(o,t){if(console.log("åˆ›å»ºé»˜è®¤æ ‡è®°ï¼Œç”¨æˆ·ID:",t),!o&&O.value&&(o=[O.value.longitude,O.value.latitude]),o||(console.warn("createDefaultMarker: æ— æ³•è·å–ä½ç½®ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®"),o=[116.3,39.9]),!t&&e.userInfo&&(t=e.userInfo.id,console.log("ä»ç”¨æˆ·å­˜å‚¨è·å–ID:",t)),t||(t="current-user-marker",console.warn("userIdæœªæä¾›ä¸”æ— æ³•è·å–ï¼Œä½¿ç”¨å›ºå®šæ ‡è¯†ç¬¦:",t)),!l.value)return console.error("createDefaultMarker: åœ°å›¾å¯¹è±¡æœªåˆå§‹åŒ–ï¼Œæ— æ³•åˆ›å»ºæ ‡è®°"),null;const n=l,a=o,i=t;r[i]&&(console.log("ç§»é™¤å·²å­˜åœ¨çš„åŒIDæ ‡è®°:",i),n.value.remove(r[i]),delete r[i]);try{console.log("ä½¿ç”¨IDåˆ›å»ºé»˜è®¤æ ‡è®°:",i);const e=new AMap.Marker({map:n.value,position:a,icon:new AMap.Icon({size:new AMap.Size(30,30),image:"data:image/svg+xml;charset=utf-8,"+encodeURIComponent('\n\t\t\t\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30">\n\t\t\t\t\t\t\t\t<circle cx="15" cy="15" r="14" fill="#007aff" stroke="white" stroke-width="2"/>\n\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t'),imageSize:new AMap.Size(30,30)}),offset:new AMap.Pixel(-15,-15),zIndex:100,extData:{userId:i,type:"default-user"}});return r[i]=e,setTimeout((()=>{try{const o=e.getContentDom();o?(console.log("è®¾ç½®é»˜è®¤æ ‡è®°DOMå±æ€§ï¼Œç”¨æˆ·ID:",i),o.setAttribute("data-user-id",i),o.setAttribute("data-id",`user-marker-${i}`),o.id=`marker-${i}`,o.classList.add("user-marker"),o.classList.add(`user-marker-${i}`),o.setAttribute("data-marker-type","default-user"),o.setAttribute("data-timestamp",(new Date).getTime()),o.addEventListener("click",(e=>{e.stopPropagation(),console.log("é»˜è®¤æ ‡è®°DOMç‚¹å‡», ç”¨æˆ·ID:",i),Pe({detail:{markerId:i}})})),o.style.cursor="pointer",o.style.pointerEvents="auto"):console.warn("æ— æ³•è·å–é»˜è®¤æ ‡è®°DOM")}catch(o){console.error("è®¾ç½®é»˜è®¤æ ‡è®°DOMå±æ€§æ—¶å‡ºé”™:",o)}}),100),ue.value&&ue.value.push(e),e}catch(s){return console.error("åˆ›å»ºé»˜è®¤æ ‡è®°æ—¶å‡ºé”™:",s),null}}const pe=(e,o,t)=>{if(!l.value)return console.error("åœ°å›¾æœªåˆå§‹åŒ–ï¼Œæ— æ³•åˆ›å»ºæ ‡è®°"),void setTimeout((()=>{l.value?(console.log("åœ°å›¾ç°åœ¨å·²åˆå§‹åŒ–ï¼Œé‡è¯•åˆ›å»ºæ ‡è®°"),pe(e,o,t)):console.error("é‡è¯•ååœ°å›¾ä»æœªåˆå§‹åŒ–ï¼Œæ ‡è®°åˆ›å»ºå¤±è´¥")}),2e3);e||(console.warn("æ ‡è®°çš„userIdä¸ºç©ºï¼Œä½¿ç”¨å›ºå®šæ ‡è¯†ç¬¦"),e="current-user-location");try{console.log("å¼€å§‹åˆ›å»ºç”¨æˆ·æ ‡è®°ï¼Œç”¨æˆ·ID:",e);const n=t||se.value,a=k.get(n);if(a)return console.log("ä½¿ç”¨ç¼“å­˜çš„å¤´åƒå›¾åƒ:",n.substring(0,50)+"..."),void createMarkerWithProcessedImage(e,o,a);if(n.startsWith("data:image"))return void processImageAndCreateMarker(e,o,n);const i=60,s=56,c=document.createElement("canvas");c.width=i,c.height=i;const u=c.getContext("2d",{willReadFrequently:!0});if(!u)return console.error("æ— æ³•è·å–canvasä¸Šä¸‹æ–‡"),me(o,e);u.clearRect(0,0,i,i);const d=new Image;d.crossOrigin="Anonymous",d.onload=function(){try{u.save(),u.beginPath(),u.arc(i/2,i/2,s/2,0,2*Math.PI),u.closePath(),u.clip();const t=(i-s)/2,a=(i-s)/2;u.drawImage(d,t,a,s,s),u.restore(),u.beginPath(),u.arc(i/2,i/2,s/2,0,2*Math.PI),u.lineWidth=2,u.strokeStyle="#2196F3",u.stroke();const g=c.toDataURL("image/png");k.put(n,g),"object"!=typeof r&&(console.warn("userMarkersæœªå®šä¹‰ï¼Œåˆå§‹åŒ–ä¸ºç©ºå¯¹è±¡"),window.userMarkers={});const v=new AMap.Marker({position:o,icon:new AMap.Icon({size:new AMap.Size(i,i),image:g,imageSize:new AMap.Size(i,i)}),offset:new AMap.Pixel(-i/2,-i/2),zIndex:100,extData:{userId:e,type:"user",isUserMarker:!0}});return l.value.add(v),r[e]=v,setTimeout((()=>{try{const o=v.getContentDom();if(o){console.log(`ä¸ºæ ‡è®°DOMè®¾ç½®ç”¨æˆ·ID: ${e}`),o.setAttribute("data-user-id",e),o.setAttribute("data-id",`user-marker-${e}`),o.id=`marker-${e}`,o.classList.add("user-marker"),o.classList.add(`user-marker-${e}`),o.setAttribute("data-marker-type","user"),o.setAttribute("data-timestamp",(new Date).getTime()),o.addEventListener("click",(o=>{o.stopPropagation(),console.log("ç”¨æˆ·æ ‡è®°DOMç‚¹å‡», ç”¨æˆ·ID:",e),Ce(e)})),o.style.cursor="pointer",o.style.pointerEvents="auto";const t=o.querySelector("img");t&&(t.setAttribute("data-user-id",e),t.setAttribute("data-id",`user-image-${e}`))}else console.warn("æ— æ³•è·å–æ ‡è®°DOMå…ƒç´ ")}catch(o){console.error("è®¾ç½®æ ‡è®°DOMå±æ€§æ—¶å‡ºé”™:",o)}}),100),v.on("click",(function(o){console.log("æ ‡è®°è¢«ç‚¹å‡»ï¼Œç”¨æˆ·ID:",e),Ce(e)})),setTimeout((()=>be()),500),console.log("æˆåŠŸåˆ›å»ºç”¨æˆ·æ ‡è®°ï¼Œç”¨æˆ·ID:",e),v}catch(t){return console.error("ç»˜åˆ¶æ ‡è®°å›¾åƒæ—¶å‡ºé”™:",t),me(o,e)}},d.onerror=function(t){return console.error("åŠ è½½å¤´åƒå›¾åƒå¤±è´¥:",t),me(o,e)},d.src=t}catch(n){return console.error("åˆ›å»ºç”¨æˆ·æ ‡è®°å‡ºé”™:",n),me(o,e)}},we=()=>c(this,null,(function*(){if(e.token&&!e.user)try{console.log("å‘ç°tokenä½†æ²¡æœ‰ç”¨æˆ·æ•°æ®ï¼Œå°è¯•è·å–ç”¨æˆ·ä¿¡æ¯"),yield e.fetchUserInfo(),console.log("æˆåŠŸè·å–ç”¨æˆ·æ•°æ®:",e.user)}catch(o){console.error("è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œå¯èƒ½éœ€è¦é‡æ–°ç™»å½•:",o)}if(e.token&&(console.log("å·²æœ‰tokenï¼Œå‡å®šç”¨æˆ·å·²ç™»å½• - isAuthenticated:",e.isAuthenticated),!e.isAuthenticated&&!e.user))try{const o=u.index.getStorageSync("userInfo");if(o){const t=JSON.parse(o);e.$patch({user:t}),console.log("ä»æœ¬åœ°å­˜å‚¨æ¢å¤ç”¨æˆ·ä¿¡æ¯:",t)}else console.log("æœ¬åœ°å­˜å‚¨ä¸­æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯")}catch(t){console.error("ä»æœ¬åœ°å­˜å‚¨æ¢å¤ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",t)}console.log("å½“å‰è®¤è¯çŠ¶æ€:",{"tokenå­˜åœ¨":!!e.token,"userå­˜åœ¨":!!e.user,isAuthenticated:e.isAuthenticated})}));function Ie(){var o,t;try{if(!O.value||void 0===O.value.latitude)return console.error("å½“å‰ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ï¼Œæ— æ³•æ·»åŠ æ ‡è®°"),void u.index.showToast({title:"æ— æ³•è·å–ä½ç½®ä¿¡æ¯",icon:"none"});let n=(null==(o=e.userInfo)?void 0:o.id)||(null==(t=e.user)?void 0:t._id)||"current-user-location";if(console.log("ä½¿ç”¨ç”¨æˆ·IDåˆ›å»ºæ ‡è®°:",n),l.value){const e=l.value.getAllOverlays("marker");let o=!1;e.forEach((e=>{var t,a;try{const r=null==(a=null==(t=null==e?void 0:e.getExtData)?void 0:t.call(e))?void 0:a.userId;r!==n&&"current-user-location"!==r||(console.log(`å‘ç°å·²å­˜åœ¨æ ‡è®°(${r})ï¼Œç§»é™¤ä»¥é¿å…é‡å¤`),l.value.remove(e),o=!0)}catch(r){console.warn("æ£€æŸ¥æ ‡è®°æ—¶å‡ºé”™:",r)}})),o&&console.log("å·²ç§»é™¤æ—§æ ‡è®°ï¼Œåˆ›å»ºæ–°æ ‡è®°")}const a=[O.value.longitude,O.value.latitude],i=se.value;console.log("åˆ›å»ºç”¨æˆ·æ ‡è®°ï¼Œä½¿ç”¨å¤´åƒURL:",i),pe(n,a,i),r["current-user-location"]&&"current-user-location"!==n&&delete r["current-user-location"],console.log("å·²å®Œæˆåˆ›å»ºç”¨æˆ·æ ‡è®°")}catch(n){console.error("åˆ›å»ºæ ‡è®°æ—¶å‡ºé”™:",n),u.index.showToast({title:"åˆ›å»ºä½ç½®æ ‡è®°å¤±è´¥",icon:"none"})}}function ke(o=!1){var t;if(!O.value||void 0===O.value.latitude)return console.error("å½“å‰ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ï¼Œæ— æ³•æ·»åŠ æ ‡è®°"),void u.index.showToast({title:"æ— æ³•è·å–ä½ç½®ä¿¡æ¯",icon:"none"});o&&(console.log("å¼ºåˆ¶æ¸…é™¤å¤´åƒç¼“å­˜ï¼Œä½¿ç”¨æœ€æ–°ä¸Šä¼ çš„å¤´åƒ"),k.clear());const n=(null==(t=e.userInfo)?void 0:t.id)||"current-user-location",a=[O.value.longitude,O.value.latitude];if(l.value){const o=l.value.getAllOverlays("marker"),t=[];o.forEach((o=>{var n,a;try{const l=null==(a=null==(n=null==o?void 0:o.getExtData)?void 0:n.call(o))?void 0:a.userId;("current-user-location"===l||e.userInfo&&l===e.userInfo.id)&&t.push(o)}catch(l){console.error("å¤„ç†æ ‡è®°æ—¶å‡ºé”™:",l)}})),t.length>0&&(console.log(`ç§»é™¤ ${t.length} ä¸ªç”¨æˆ·æ ‡è®°`),l.value.remove(t),t.forEach((e=>{var o,t;const n=null==(t=null==(o=null==e?void 0:e.getExtData)?void 0:o.call(e))?void 0:t.userId;n&&r[n]&&delete r[n]}))),console.log("åˆ›å»ºæ–°çš„ç”¨æˆ·æ ‡è®°ï¼Œç”¨æˆ·ID:",n);const i=se.value;pe(n,a,i)}}u.onMounted((()=>c(this,null,(function*(){var t;if(console.log("ç»„ä»¶æŒ‚è½½å¼€å§‹..."),setTimeout((()=>{Ee()}),1e3),Ue=setInterval((()=>{be(),(new Date).getSeconds()%10==0&&Ee()}),2e3),n.restoreMarkerCache(),yield we(),console.log("åˆå§‹ç”¨æˆ·ä¿¡æ¯:",e.userInfo||e.user),console.log("åˆå§‹å¤´åƒè·¯å¾„:",null==(t=e.userInfo||e.user)?void 0:t.avatar),console.log("ç”¨æˆ·è®¤è¯çŠ¶æ€:",e.isAuthenticated),!e.user&&!e.userInfo){console.log("ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´ï¼Œå°è¯•é‡æ–°è·å–...");try{yield e.fetchUserInfo(),console.log("å·²é‡æ–°è·å–ç”¨æˆ·ä¿¡æ¯:",e.user)}catch(g){console.error("è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",g)}}const r=()=>c(this,null,(function*(){try{console.log("æ£€æŸ¥åç«¯APIè¿æ¥çŠ¶æ€...");const e=yield p.request({url:"/api",method:"GET",timeout:5e3}).catch((e=>p.request({url:"/api/users/ping",method:"GET",timeout:5e3})));console.log("åç«¯APIè¿æ¥æ­£å¸¸:",e),a.value=!0}catch(e){console.error("åç«¯APIè¿æ¥å¤±è´¥:",e),a.value=!1,u.index.showModal({title:"è¿æ¥é—®é¢˜",content:"æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚",showCancel:!1})}})),d=e=>{if(e&&void 0!==e.latitude)try{if(console.log("ä½¿ç”¨ç¡®å®šä½ç½®åˆå§‹åŒ–åœ°å›¾:",e),void 0===window.AMap){console.error("AMapæœªåŠ è½½"),window.onAMapLoaded=()=>d(e);const o=document.createElement("script");return o.type="text/javascript",o.async=!0,o.src="https://webapi.amap.com/maps?v=2.0&key=9ea84b4333b114c188a67cb42564a48f&callback=onAMapLoaded",void document.head.appendChild(o)}if(!document.getElementById("map-container"))return void console.error("æ‰¾ä¸åˆ°åœ°å›¾å®¹å™¨å…ƒç´ (#map-container)");l.value=new window.AMap.Map("map-container",{zoom:16,center:[e.longitude,e.latitude],resizeEnable:!0,animateEnable:!0}),"undefined"!=typeof window&&(window.__dogRunMapInstance=l.value),console.log("é«˜å¾·åœ°å›¾åˆå§‹åŒ–å®Œæˆ"),l.value.on("complete",(()=>{console.log("åœ°å›¾åŠ è½½å®Œæˆï¼Œåˆ›å»ºç”¨æˆ·æ ‡è®°å’ŒåŠ è½½æ ‡è®°æ•°æ®"),l.value.setCenter([e.longitude,e.latitude]),setTimeout((()=>{Ie(),T(),ge()}),800)})),l.value.on("click",(e=>{console.log("é«˜å¾·åœ°å›¾ç‚¹å‡»äº‹ä»¶:",e),Se({detail:{x:e.pixel.x,y:e.pixel.y}})})),setTimeout(be,2e3)}catch(o){console.error("åˆå§‹åŒ–åœ°å›¾å‡ºé”™:",o),u.index.showToast({title:"åœ°å›¾åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}else console.error("åˆå§‹åŒ–åœ°å›¾éœ€è¦æœ‰æ•ˆçš„ä½ç½®ä¿¡æ¯")};(()=>{c(this,null,(function*(){u.index.showLoading({title:"æ­£åœ¨å®šä½...",mask:!0});try{const t=u.index.getStorageSync("last_known_location");let n=null;if(t)try{const e=JSON.parse(t);e&&e.timestamp&&Date.now()-e.timestamp<864e5&&(n={latitude:e.latitude,longitude:e.longitude},console.log("ä½¿ç”¨ç¼“å­˜ä½ç½®ä½œä¸ºä¸´æ—¶ä½ç½®",n),O.value=n)}catch(e){console.warn("è§£æç¼“å­˜ä½ç½®å¤±è´¥",e)}const a=yield((e=8e3)=>new Promise(((o,t)=>{const n=setTimeout((()=>{console.log("è·å–ä½ç½®è¶…æ—¶"),t(new Error("è·å–ä½ç½®è¶…æ—¶"))}),e);u.index.getLocation({type:"gcj02",success:e=>{clearTimeout(n),o({latitude:e.latitude,longitude:e.longitude})},fail:e=>{clearTimeout(n),console.error("è·å–ä½ç½®å¤±è´¥:",e),t(e)}})})))(1e4).catch((e=>(console.warn("è·å–å®é™…ä½ç½®å¤±è´¥ï¼Œä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆ",e),null)));u.index.hideLoading(),a?(O.value=a,console.log("è·å–åˆ°å®é™…ä½ç½®:",a),u.index.setStorageSync("last_known_location",JSON.stringify(s(i({},a),{timestamp:Date.now()})))):O.value||(O.value={latitude:31.31,longitude:121.52},console.warn("æ— æ³•è·å–ä½ç½®ï¼Œä½¿ç”¨é»˜è®¤ä¸Šæµ·ä½ç½®")),fe(),d(O.value),function(){c(this,null,(function*(){try{const e=yield o.fetchPets();e&&Array.isArray(e)?X.value=e:X.value=[]}catch(e){console.error("è·å–æˆ‘çš„å® ç‰©å¤±è´¥",e),X.value=[]}}))}(),r()}catch(t){u.index.hideLoading(),console.error("åˆå§‹åŒ–åœ°å›¾æµç¨‹å‡ºé”™:",t),u.index.showToast({title:"å®šä½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®",icon:"none"}),O.value||(O.value={latitude:31.31,longitude:121.52}),fe(),d(O.value)}}))})(),console.log("ç»„ä»¶æŒ‚è½½å®Œæˆ")})))),u.onShow((()=>{console.log("åœ°å›¾é¡µé¢æ˜¾ç¤º"),l.value&&(console.log("åˆ·æ–°åœ°å›¾æ ‡è®°æ•°æ®"),T())})),u.onBeforeUnmount((()=>{$.value&&clearInterval($.value),F.value&&clearInterval(F.value),q.value&&clearInterval(q.value),"function"==typeof u.index.stopDeviceMotionListening&&u.index.stopDeviceMotionListening({success:()=>{console.log("è®¾å¤‡æ–¹å‘ç›‘å¬å·²åœæ­¢")}}),"function"==typeof u.index.offCompassChange&&u.index.offCompassChange()}));const ye=u.ref(!1),Me=u.ref("æœªå…±äº«");function Ae(){return c(this,null,(function*(){try{console.log("å¼€å§‹ä¿å­˜é›ç‹—è®°å½•...");const o=X.value.length>0?X.value[0]._id||X.value[0].id:null,t=X.value.length>0?X.value[0]:null;if(!o)return console.warn("æ²¡æœ‰å® ç‰©ä¿¡æ¯ï¼Œæ— æ³•ä¿å­˜é›ç‹—è®°å½•"),u.index.showToast({title:"è¯·å…ˆæ·»åŠ å® ç‰©",icon:"none"}),Promise.reject(new Error("æ²¡æœ‰å® ç‰©ä¿¡æ¯"));const n={pet:{_id:o,name:(null==t?void 0:t.name)||"æœªå‘½åå® ç‰©",avatar:(null==t?void 0:t.avatar)||"/static/images/default-pet.png"},distance:j.value,duration:N.value,startTime:new Date(z.value).toISOString(),endTime:(new Date).toISOString(),route:V.value,mapImageUrl:"/static/images/default-map.png"};console.log("å‘é€é›ç‹—è®°å½•æ•°æ®:",{"å® ç‰©ID":n.pet._id,"å® ç‰©åç§°":n.pet.name,"è·ç¦»":`${n.distance}ç±³ (${(n.distance/1e3).toFixed(2)}å…¬é‡Œ)`,"æ—¶é•¿":`${n.duration}ç§’ (${Math.floor(n.duration/60)}åˆ†${n.duration%60}ç§’)`,"å¼€å§‹æ—¶é—´":new Date(n.startTime).toLocaleString(),"ç»“æŸæ—¶é—´":new Date(n.endTime).toLocaleString(),"è·¯çº¿ç‚¹æ•°":n.route.length}),console.log("è°ƒç”¨API: api.walk.startWalk, URL: /api/walks/start");const a=yield m.api.walk.startWalk(n);console.log("é›ç‹—è®°å½•ä¿å­˜ç»“æœ:",a);let l=null;if(a&&0===a.code&&a.data?(l=a.data.walkId,console.log("ä»æ ‡å‡†æ ¼å¼è·å–walkId:",l)):a&&(a._id||a.id)?(l=a._id||a.id,console.log("ä»å¯¹è±¡å±æ€§è·å–walkId:",l)):a&&a.data&&(a.data._id||a.data.id||a.data.walkId)&&(l=a.data._id||a.data.id||a.data.walkId,console.log("ä»åµŒå¥—å¯¹è±¡è·å–walkId:",l)),!l)return console.error("æ— æ³•ä»APIå“åº”è·å–walkId:",a),Promise.reject(new Error("æ— æ³•è·å–é›ç‹—è®°å½•ID"));console.log("é›ç‹—è®°å½•åˆ›å»ºæˆåŠŸï¼ŒID:",l),yield new Promise((e=>setTimeout(e,500)));try{console.log(`è°ƒç”¨API: api.walk.endWalk, URL: /api/walks/${l}/end`);const e=yield m.api.walk.endWalk(l,{distance:j.value,duration:N.value,endTime:(new Date).toISOString()});console.log("é›ç‹—è®°å½•ç»“æŸç»“æœ:",e)}catch(e){console.error("ç»“æŸé›ç‹—è®°å½•å¤±è´¥ï¼Œä½†åˆå§‹è®°å½•å·²ä¿å­˜:",e)}return u.index.showToast({title:"è®°å½•å·²ä¿å­˜",icon:"success"}),setTimeout((()=>{console.log("å‡†å¤‡è·³è½¬åˆ°é›ç‹—è®°å½•é¡µé¢..."),u.index.navigateTo({url:"/pages/walk/history",success:()=>{console.log("æˆåŠŸè·³è½¬åˆ°é›ç‹—è®°å½•é¡µé¢")},fail:e=>{console.error("è·³è½¬åˆ°é›ç‹—è®°å½•é¡µé¢å¤±è´¥:",e)}})}),3e3),Promise.resolve(l)}catch(o){if(console.error("ä¿å­˜é›ç‹—è®°å½•å‡ºé”™:",o),console.error("é”™è¯¯è¯¦æƒ…:",o.message||"æœªçŸ¥é”™è¯¯"),o.statusCode&&(console.error("HTTPçŠ¶æ€ç :",o.statusCode),404===o.statusCode)){console.error("APIç«¯ç‚¹ä¸å­˜åœ¨ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨");try{const e=u.index.requireNativePlugin("walkStorage")||require("@/utils/walkStorage.js").default,o={pet:{_id:X.value.length>0?X.value[0]._id||X.value[0].id:"default-pet",name:X.value.length>0?X.value[0].name:"æœªå‘½åå® ç‰©",avatar:X.value.length>0?X.value[0].avatar:"/static/images/default-pet.png"},distance:j.value,duration:N.value,startTime:new Date(z.value).toISOString(),endTime:(new Date).toISOString(),route:V.value};console.log("å°è¯•ä½¿ç”¨æœ¬åœ°å­˜å‚¨ä¿å­˜é›ç‹—è®°å½•");const t=e.saveWalkRecord(o);if(console.log("æœ¬åœ°å­˜å‚¨ä¿å­˜ç»“æœ:",t),t&&0===t.code&&t.data&&t.data.walkId)return Promise.resolve(t.data.walkId);throw new Error("æœ¬åœ°å­˜å‚¨ä¿å­˜å¤±è´¥")}catch(t){console.error("ä½¿ç”¨æœ¬åœ°å­˜å‚¨ä¿å­˜å¤±è´¥:",t)}}throw u.index.showToast({title:"ä¿å­˜è®°å½•å¤±è´¥: "+(o.message||"æœªçŸ¥é”™è¯¯"),icon:"none",duration:3e3}),o}}))}const xe=u.ref(!1),De=u.ref(0);function Se(e){if(console.log("åœ°å›¾ç‚¹å‡»äº‹ä»¶:",e),xe.value)return void console.log("åœ°å›¾æ­£åœ¨æ‹–åŠ¨ï¼Œå¿½ç•¥ç‚¹å‡»");const{x:o,y:t}=e.detail;if(void 0!==o&&void 0!==t){try{const e=document.querySelectorAll(".amap-marker");if(e.length>0){console.log("æ‰¾åˆ°é«˜å¾·åœ°å›¾æ ‡è®°:",e.length,"ä¸ª");for(const n of e){const e=n.getBoundingClientRect();if(o>=e.left&&o<=e.right&&t>=e.top&&t<=e.bottom){console.log("ç‚¹å‡»å‘½ä¸­æ ‡è®°å…ƒç´ :",n);const e=n.getAttribute("data-id")||n.id||n.getAttribute("id");if(e)return console.log("è§¦å‘æ ‡è®°ç‚¹å‡»:",e),void Pe({detail:{markerId:e}});const a=Te(o,t);if(a)return console.log("æ‰¾åˆ°æœ€æ¥è¿‘çš„ç”¨æˆ·:",a.nickname||a.username),void Pe({detail:{markerId:a.id}})}}}const n=Te(o,t);if(n)return console.log("æ‰¾åˆ°æœ€æ¥è¿‘çš„ç”¨æˆ·:",n.nickname||n.username),void Pe({detail:{markerId:n.id}})}catch(n){console.error("å¤„ç†åœ°å›¾ç‚¹å‡»äº‹ä»¶å‡ºé”™:",n)}G.value&&(G.value=!1)}else console.log("ç‚¹å‡»äº‹ä»¶æ²¡æœ‰åæ ‡ä¿¡æ¯")}function Te(e,o){if(!R.value||!R.value.length)return null;const t=document.getElementById("map");if(!t)return null;const n=t.getBoundingClientRect(),a=n.width,l=n.height,r=e-(n.left+a/2),i=o-(n.top+l/2),s=_.value,c=20/s*5e-6,u=20/s*5e-6/Math.cos(O.value.latitude*Math.PI/180),d=O.value.latitude-i*c,g=O.value.longitude+r*u;console.log("ç‚¹å‡»ç»çº¬åº¦ä¼°è®¡:",{lat:d,lng:g});let v=null,h=1/0;return R.value.forEach((e=>{if(!e.latitude||!e.longitude)return;const o=Math.sqrt(Math.pow((e.latitude-d)/c,2)+Math.pow((e.longitude-g)/u,2));o<30&&o<h&&(h=o,v=e)})),v}function Pe(e){return c(this,null,(function*(){var o,t,n;try{let a=e.markerId||(null==(o=e.detail)?void 0:o.markerId);if(!a&&(null==(t=e.detail)?void 0:t.marker)&&(a=e.detail.marker.id),!a&&(null==(n=e.detail)?void 0:n.nativeEvent)){const o=e.detail.nativeEvent.target;o&&o.dataset&&(a=o.dataset.userId||o.dataset.id)}a?(console.log("è·å–åˆ°æ ‡è®°ID:",a),yield Ce(a)):(console.error("æ— æ³•è·å–æ ‡è®°ID"),Array.isArray(R.value)&&R.value.length>0?(console.log("ä½¿ç”¨ç¬¬ä¸€ä¸ªé™„è¿‘ç”¨æˆ·ä½œä¸ºå¤‡é€‰"),yield Ce(R.value[0].id)):u.index.showToast({title:"æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯",icon:"none"}))}catch(a){console.error("æ ‡è®°ç‚¹å‡»å¤„ç†å‡ºé”™:",a),u.index.showToast({title:"æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}}))}function Ce(e){return c(this,null,(function*(){console.log("å¤„ç†ç”¨æˆ·æ ‡è®°ç‚¹å‡»äº‹ä»¶, ç”¨æˆ·ID:",e);try{yield _e(e)}catch(o){console.error("å¤„ç†ç”¨æˆ·æ ‡è®°ç‚¹å‡»å¤±è´¥:",o)}}))}function be(){try{const e=document.querySelectorAll(".amap-marker");if(e.length>0){console.log("å‘ç°åœ°å›¾æ ‡è®°å…ƒç´ :",e.length,"ä¸ª");let o=[];e.forEach((e=>{var t;const n=e.getAttribute("data-user-id")||(e.id?null==(t=e.id.match(/marker-([^"\s]+)/))?void 0:t[1]:null);n&&o.push(n)})),console.log("åœ°å›¾ä¸Šçš„ç”¨æˆ·ID:",o),setTimeout((()=>{e.forEach((e=>{if(!e.hasAttribute("data-click-handler")){e.addEventListener("click",(o=>{o.stopPropagation(),console.log("æ ‡è®°ç‚¹å‡»äº‹ä»¶ (ç›´æ¥):",e);let t=e.getAttribute("data-user-id");if(!t&&e.className){const o=e.className.match(/user-marker-([^"\s]+)/);o&&o[1]&&(t=o[1])}if(!t&&e.id){const o=e.id.match(/marker-([^"\s]+)/);o&&o[1]&&(t=o[1])}if(!t){const o=e.querySelector("img");o&&(t=o.getAttribute("data-user-id"))}console.log("å°è¯•æå–çš„ç”¨æˆ·ID:",t),t?(console.log("æ‰¾åˆ°ç”¨æˆ·IDï¼Œè§¦å‘æ ‡è®°ç‚¹å‡»äº‹ä»¶:",t),Ce(t)):R.value&&R.value.length>0&&(console.log("æ— æ³•è¯†åˆ«ç”¨æˆ·IDï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªé™„è¿‘ç”¨æˆ·"),Ce(R.value[0].id))})),e.setAttribute("data-click-handler","true"),e.style.cursor="pointer",e.style.pointerEvents="auto",e.style.zIndex="999";const o=e.querySelector(".amap-icon");if(o){o.style.borderRadius="50%",o.style.overflow="hidden";const t=o.querySelector("img");if(t){const o=e.getAttribute("data-user-id");o&&(t.setAttribute("data-user-id",o),console.log("è®¾ç½®å›¾åƒå…ƒç´ data-user-idå±æ€§:",o)),t.style.borderRadius="50%",t.style.width="100%",t.style.height="100%",t.style.objectFit="cover",t.addEventListener("click",(o=>{o.stopPropagation(),console.log("å›¾åƒç‚¹å‡»äº‹ä»¶");const n=t.getAttribute("data-user-id")||e.getAttribute("data-user-id");console.log("å›¾åƒç‚¹å‡» - æå–çš„ç”¨æˆ·ID:",n),n&&(console.log("æ‰¾åˆ°å›¾åƒç”¨æˆ·IDï¼Œå¤„ç†æ ‡è®°ç‚¹å‡»:",n),Ce(n))}))}}}}))}),100)}}catch(e){console.error("å¤„ç†åœ°å›¾æ ‡è®°å‡ºé”™:",e)}}let Ue;function Ee(){var o,t;if(console.log("æ‰§è¡Œæ ‡è®°æ¸…ç†..."),!l.value)return;const n=l.value.getAllOverlays("marker");if(!n||0===n.length)return void console.log("åœ°å›¾ä¸Šæ²¡æœ‰æ ‡è®°ï¼Œæ— éœ€æ¸…ç†");console.log(`åœ°å›¾ä¸Šå…±æœ‰ ${n.length} ä¸ªæ ‡è®°`);const a=(null==(o=e.userInfo)?void 0:o.id)||(null==(t=e.user)?void 0:t._id);if(!a)return void console.log("æœªæ‰¾åˆ°å½“å‰ç”¨æˆ·IDï¼Œè·³è¿‡æ ‡è®°æ¸…ç†");console.log("å½“å‰ç”¨æˆ·ID:",a);const i=[a,"current-user-location"],s=[];n.forEach((e=>{var o,t;try{const n=(null==(t=null==(o=null==e?void 0:e.getExtData)?void 0:o.call(e))?void 0:t.userId)||"æœªçŸ¥";s.push(n)}catch(n){console.error("è·å–æ ‡è®°IDå‡ºé”™:",n)}})),console.log("åœ°å›¾ä¸Šçš„æ ‡è®°ID:",s);const c=[];n.forEach((e=>{var o,t;try{const n=null==(t=null==(o=null==e?void 0:e.getExtData)?void 0:o.call(e))?void 0:t.userId;if(!n)return console.log("æ‰¾åˆ°æ— IDæ ‡è®°ï¼Œç§»é™¤"),void l.value.remove(e);i.includes(n)?(console.log(`ä¿ç•™æ ‡è®°ID: ${n}`),c.push(n)):(console.log(`ç§»é™¤æ ‡è®°ID: ${n}`),l.value.remove(e),r[n]&&delete r[n])}catch(n){console.error("æ¸…ç†æ ‡è®°æ—¶å‡ºé”™:",n)}})),console.log(`æ¸…ç†å®Œæˆï¼Œä¿ç•™æ ‡è®°: ${c.join(", ")}`)}u.watch((()=>e.isAuthenticated),(e=>{console.log("ç”¨æˆ·ç™»å½•çŠ¶æ€å˜æ›´:",e),e?(console.log("ç”¨æˆ·å·²ç™»å½•ï¼Œè·å–å® ç‰©æ•°æ®"),o.fetchPets().then((e=>{console.log("ç™»å½•åè·å–å® ç‰©æ•°æ®æˆåŠŸ:",e),X.value=e})).catch((e=>{console.error("ç™»å½•åè·å–å® ç‰©æ•°æ®å¤±è´¥:",e)}))):(console.log("ç”¨æˆ·å·²ç™»å‡ºï¼Œæ¸…ç©ºå® ç‰©æ•°æ®"),X.value=[])})),u.onBeforeUnmount((()=>{Ue&&clearInterval(Ue)}));const _e=t=>c(this,null,(function*(){console.log("é€‰ä¸­ç”¨æˆ·æ ‡è®°:",t);try{let a,l=[];if(t===e.userId)a=s(i({},e.user),{isCurrentUser:!0}),l=o.pets||[];else{if(a=yield m.api.user.getUserById(t),!a)return void console.error("æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯");a=s(i({},a),{isCurrentUser:!1});try{l=yield m.api.pet.getPetsByUser(t)}catch(n){console.error("è·å–ç”¨æˆ·å® ç‰©å¤±è´¥:",n),l=[]}try{if(e.isAuthenticated){const o=yield e.fetchUserInfo();H.value=o.following&&o.following.some((e=>e===t||e._id&&e._id===t))}}catch(n){console.error("æ£€æŸ¥å…³æ³¨çŠ¶æ€å¤±è´¥:",n),H.value=!1}}Q.value=a,K.value=l,G.value=!0}catch(n){console.error("è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",n)}}));return{userStore:e,petStore:o,mapScale:_,currentLocation:O,markers:L,allMarkers:ue,nearbyUsers:R,isWalking:W,walkingPath:B,walkingDistance:j,walkingDuration:N,showUserPopup:G,selectedUser:Q,selectedUserPets:K,selectedUserFollowStatus:Y,isFollowing:H,showWalkSummary:Z,walkShareContent:J,myPets:X,myPetsNames:ee,selectedPetIndex:oe,showDebug:te,debugInfo:ne,showLocationSharingTip:ae,isLocationShared:le,userAvatar:se,userHeading:re,defaultAvatarBase64:ie,userMarker:ce,locationSharingStatusVisible:ye,locationSharingStatus:Me,formatDuration:f.formatDuration,calculatePace:f.calculatePace,forceRefreshMarker:ke,toggleMarker:Ie,toggleWalkingMode:function(){if(console.log("åˆ‡æ¢é›ç‹—æ¨¡å¼ï¼Œå½“å‰çŠ¶æ€:",W.value),W.value){W.value=!1,clearInterval(q.value),q.value=null,le.value=!1,ye.value=!1,console.log("é›ç‹—ç»“æŸï¼Œæ—¶é•¿:",N.value,"ç§’"),console.log("é›ç‹—è·ç¦»:",j.value,"ç±³");const e=5;N.value>=e?(!function(){const e=(j.value/1e3).toFixed(2),o=f.formatDuration(N.value),t=f.calculatePace(j.value,N.value),n=ee.value.length?ee.value.join("ã€"):"æˆ‘çš„å® ç‰©";J.value=`æˆ‘å¸¦${n}é›äº†${e}å…¬é‡Œï¼Œç”¨æ—¶${o}ï¼Œé…é€Ÿ${t}ï¼`}(),Ae().then((e=>{console.log("é›ç‹—è®°å½•ä¿å­˜æˆåŠŸï¼ŒID:",e),Z.value=!0,u.index.showToast({title:"è®°å½•å·²ä¿å­˜",icon:"success",duration:2e3})})).catch((e=>{console.error("ä¿å­˜é›ç‹—è®°å½•å¤±è´¥:",e),Z.value=!0,u.index.showToast({title:"è®°å½•ä¿å­˜å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨",icon:"none",duration:2e3})}))):(console.log("é›ç‹—æ—¶é—´å¤ªçŸ­ï¼Œä¸ä¿å­˜è®°å½•"),u.index.showToast({title:`é›ç‹—æ—¶é—´å¤ªçŸ­ï¼ˆå°‘äº${e}ç§’ï¼‰ï¼Œæœªä¿å­˜è®°å½•`,icon:"none",duration:2e3}))}else ae.value=!0},confirmLocationSharing:function(){try{le.value=!0,ae.value=!1,console.log("å·²å¯ç”¨ä½ç½®å…±äº«ï¼ˆæœ¬åœ°ï¼‰"),u.index.showToast({title:"å·²å¼€å§‹ä½ç½®å…±äº«",icon:"success"}),de(),function(){W.value=!0,z.value=Date.now(),j.value=0,N.value=0,V.value=[{latitude:O.value.latitude,longitude:O.value.longitude}],B.value=[{points:[{latitude:O.value.latitude,longitude:O.value.longitude}],color:"#007AFF",width:4}],q.value&&clearInterval(q.value);console.log("å¼€å§‹é›ç‹—ï¼Œè®¾ç½®è®¡æ—¶å™¨"),q.value=setInterval((()=>{const e=Date.now(),o=Math.floor((e-z.value)/1e3);N.value=o,o%30==0&&o>0&&console.log("é›ç‹—è¿›è¡Œä¸­ï¼Œå·²ç»",o,"ç§’")}),1e3),console.log("é›ç‹—æ¨¡å¼å·²å¼€å§‹:",{"å¼€å§‹æ—¶é—´":new Date(z.value).toLocaleTimeString(),"åˆå§‹ä½ç½®":V.value[0]})}()}catch(e){console.error("å¼€å§‹ä½ç½®å…±äº«å‡ºé”™:",e)}},cancelLocationSharing:function(){try{le.value=!1,ae.value=!1,console.log("å·²ç¦ç”¨ä½ç½®å…±äº«ï¼ˆæœ¬åœ°ï¼‰"),u.index.showToast({title:"å·²åœæ­¢ä½ç½®å…±äº«",icon:"none"})}catch(e){console.error("åœæ­¢ä½ç½®å…±äº«å‡ºé”™:",e)}},saveWalkRecord:Ae,onMarkerTap:Pe,onMapTap:Se,onMapRegionChange:function(e){console.log("åœ°å›¾åŒºåŸŸå˜æ›´:",e),"begin"===e.type&&"drag"===e.causedBy?(console.log("åœ°å›¾å¼€å§‹æ‹–åŠ¨"),xe.value=!0):"end"===e.type&&"drag"===e.causedBy&&(console.log("åœ°å›¾ç»“æŸæ‹–åŠ¨"),setTimeout((()=>{xe.value=!1}),50))},onMapUpdated:function(o){if(console.log("åœ°å›¾æ›´æ–°äº‹ä»¶è§¦å‘"),te.value)try{ne.value={markerCount:L.value.length+ue.value.length,markerIds:L.value.map((e=>e.id)).concat(ue.value.map((e=>e.id))),coords:O.value?[O.value.latitude.toFixed(6),O.value.longitude.toFixed(6)]:[]}}catch(a){console.error("æ›´æ–°è°ƒè¯•ä¿¡æ¯é”™è¯¯:",a)}const n=t.sharingEnabled;if(le.value=n,console.log("ä½ç½®å…±äº«çŠ¶æ€:",le.value?"å·²å¼€å¯":"å·²å…³é—­"),!window._lastMarkerCheck||Date.now()-window._lastMarkerCheck>3e4){window._lastMarkerCheck=Date.now();try{const o=ue.value.some((e=>"user-location"===e.id));if(O.value&&void 0!==O.value.latitude&&null!==O.value.latitude&&!o){console.log("æ·»åŠ ç”¨æˆ·æ ‡è®°...");const o=se.value,t=e.userInfo?e.userInfo.id:"user-location",n=[O.value.longitude,O.value.latitude];if(o.startsWith("data:image/"))pe(t,n,o);else{const e=new Image;e.crossOrigin="anonymous",e.onload=()=>{pe(t,n,o)},e.onerror=()=>{console.error("åŠ è½½ç”¨æˆ·å¤´åƒå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ"),pe(t,n,ie)},e.src=o,setTimeout((()=>{e.complete&&0!==e.naturalWidth||pe(t,n,ie)}),3e3)}}}catch(a){console.error("æ·»åŠ æ ‡è®°é”™è¯¯:",a)}}},hideUserPopup:function(){console.log("éšè—ç”¨æˆ·å¼¹çª—"),G.value=!1},showMarkerPopup:b,showCustomMarkerPopup:A,selectedMarker:x,getMarkerTypeName:e=>{if(!e)return"æ™®é€šæ ‡è®°";return{general:"æ™®é€šæ ‡è®°",pet_friendly:"å® ç‰©å‹å¥½",danger:"å±é™©åŒºåŸŸ",scenic:"é£æ™¯åŒº",pet_service:"å® ç‰©æœåŠ¡",custom:"è‡ªå®šä¹‰"}[e]||"æœªçŸ¥ç±»å‹"},getMarkerTypeIcon:e=>{if(!e)return"ğŸ“";return{general:"ğŸ“",pet_friendly:"ğŸ¾",danger:"âš ï¸",scenic:"ğŸï¸",pet_service:"ğŸ¥",custom:"âœ¨"}[e]||"ğŸ“"},getMarkerColor:e=>{if(!e)return"#4285F4";return{general:"#4285F4",pet_friendly:"#34A853",danger:"#EA4335",scenic:"#FBBC05",pet_service:"#FF7F50",custom:"#9370DB"}[e]||"#4285F4"},navigateToMarker:e=>{var o,t,n,a;if(e)try{const r=e.longitude||(null==(t=null==(o=e.location)?void 0:o.coordinates)?void 0:t[0]),i=e.latitude||(null==(a=null==(n=e.location)?void 0:n.coordinates)?void 0:a[1]);r&&i&&l.value&&(l.value.setCenter([r,i]),l.value.setZoom(17),A.value=!1,u.index.showToast({title:"æ­£åœ¨å¯¼èˆªåˆ°æ ‡è®°ä½ç½®",icon:"none",duration:1500}))}catch(r){console.error("å¯¼èˆªåˆ°æ ‡è®°ä½ç½®å¤±è´¥:",r)}},formatTime:e=>{if(!e)return"æœªçŸ¥æ—¶é—´";const o=new Date(e);return`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")} ${String(o.getHours()).padStart(2,"0")}:${String(o.getMinutes()).padStart(2,"0")}`},getUserName:e=>e?"string"==typeof e?"ç”¨æˆ·"+e.substr(-4):e.nickname||e.username||"æœªçŸ¥ç”¨æˆ·":"æœªçŸ¥ç”¨æˆ·",centerOnUser(){console.log("å®šä½åˆ°ç”¨æˆ·ä½ç½®");try{if(l.value=U(),!O.value||void 0===O.value.latitude)return console.warn("å½“å‰ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ï¼Œå°è¯•é‡æ–°è·å–ä½ç½®"),void u.index.getLocation({type:"gcj02",success:e=>{console.log("é‡æ–°è·å–ä½ç½®æˆåŠŸ:",e),O.value={latitude:e.latitude,longitude:e.longitude};const o=[e.longitude,e.latitude];console.log("è®¾ç½®åœ°å›¾ä¸­å¿ƒåˆ°:",o),l.value.setCenter(o),l.value.setZoom(16),u.index.showToast({title:"å·²å®šä½åˆ°å½“å‰ä½ç½®",icon:"none",duration:1e3})},fail:e=>{console.error("é‡æ–°è·å–ä½ç½®å¤±è´¥:",e),u.index.showToast({title:"è·å–ä½ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥å®šä½æƒé™",icon:"none"})}});const e=[O.value.longitude,O.value.latitude];console.log("è®¾ç½®åœ°å›¾ä¸­å¿ƒåˆ°:",e),l.value.setCenter(e),l.value.setZoom(16),u.index.showToast({title:"å·²å®šä½åˆ°å½“å‰ä½ç½®",icon:"none",duration:1e3})}catch(e){console.error("è®¾ç½®åœ°å›¾ä¸­å¿ƒç‚¹å‡ºé”™:",e),u.index.showToast({title:"å®šä½å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}},zoomIn(){console.log("æ”¾å¤§åœ°å›¾");try{l.value=U();const e=l.value.getZoom();console.log("å½“å‰ç¼©æ”¾çº§åˆ«:",e);const o=Math.min(e+1,19);console.log("æ–°ç¼©æ”¾çº§åˆ«:",o),l.value.setZoom(o),u.index.showToast({title:"å·²æ”¾å¤§åœ°å›¾",icon:"none",duration:500})}catch(e){console.error("åœ°å›¾æ”¾å¤§å‡ºé”™:",e),u.index.showToast({title:"æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}},zoomOut(){console.log("ç¼©å°åœ°å›¾");try{l.value=U();const e=l.value.getZoom();console.log("å½“å‰ç¼©æ”¾çº§åˆ«:",e);const o=Math.max(e-1,3);console.log("æ–°ç¼©æ”¾çº§åˆ«:",o),l.value.setZoom(o),u.index.showToast({title:"å·²ç¼©å°åœ°å›¾",icon:"none",duration:500})}catch(e){console.error("åœ°å›¾ç¼©å°å‡ºé”™:",e),u.index.showToast({title:"æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}},closeUserPopup:function(){console.log("å…³é—­ç”¨æˆ·å¼¹çª—"),G.value=!1,Q.value=null,K.value=[]},messageUser(e){u.index.navigateTo({url:`/pages/profile/message?userId=${e}`})},followUser(e){H.value=!H.value},closeWalkSummary(){console.log("å…³é—­æ­¥è¡Œæ‘˜è¦"),Z.value=!1},shareWalkRecord(e){console.log("åˆ†äº«é›ç‹—è®°å½•åˆ°ç¤¾åŒº",e);const o=e&&e.selectedPetIndex>=0&&X.value.length>e.selectedPetIndex?X.value[e.selectedPetIndex]:null;let t=`æˆ‘å’Œ${o?o.name:"æˆ‘çš„å® ç‰©"}ä¸€èµ·é›äº†${(j.value/1e3).toFixed(2)}å…¬é‡Œï¼Œç”¨æ—¶${f.formatDuration(N.value)}ï¼`;e&&e.content&&(t+="\n\n"+e.content),Z.value=!1,Ae().then((e=>{console.log("å·²ä¿å­˜é›ç‹—è®°å½•ï¼Œå‡†å¤‡åˆ†äº«åˆ°ç¤¾åŒºï¼Œè®°å½•ID:",e);const n={_id:e,distance:j.value,duration:N.value,startTime:walkStartTime.value,routeSnapshot:currentRouteSnapshot.value,pet:o?{_id:o._id,name:o.name,avatar:o.avatar}:null};setTimeout((()=>{u.index.navigateTo({url:"/pages/community/create",success:e=>{u.index.$emit("createPost",{content:t,walkRecord:n}),u.index.showToast({title:"æ­£åœ¨å‰å¾€ç¤¾åŒº",icon:"none",duration:1500})},fail:e=>{console.error("å¯¼èˆªåˆ°ç¤¾åŒºå‘å¸–é¡µé¢å¤±è´¥:",e),u.index.showToast({title:"æ‰“å¼€ç¤¾åŒºé¡µé¢å¤±è´¥",icon:"none"})}})}),300)})).catch((e=>{console.error("ä¿å­˜é›ç‹—è®°å½•å¤±è´¥ï¼Œæ— æ³•åˆ†äº«åˆ°ç¤¾åŒº:",e),u.index.showToast({title:"åˆ†äº«å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}))},reloadUserInfo:function(){return c(this,null,(function*(){var o,t;try{console.log("å¼€å§‹é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯..."),console.log("å½“å‰ç”¨æˆ·ä¿¡æ¯:",JSON.stringify(e.userInfo)),console.log("å½“å‰å¤´åƒè·¯å¾„:",null==(o=e.userInfo)?void 0:o.avatar),console.log("å½“å‰è®¡ç®—çš„å¤´åƒURL:",se.value),yield e.fetchUserInfo(),console.log("æ›´æ–°åçš„ç”¨æˆ·ä¿¡æ¯:",JSON.stringify(e.userInfo)),console.log("æ›´æ–°åçš„å¤´åƒè·¯å¾„:",null==(t=e.userInfo)?void 0:t.avatar),console.log("æ›´æ–°åçš„è®¡ç®—å¤´åƒURL:",se.value),console.log("ç¯å¢ƒå˜é‡VITE_API_URL:",I.VITE_API_URL),u.index.showToast({title:"ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°",icon:"none"}),setTimeout((()=>{ke(!0)}),500)}catch(n){console.error("é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",n),u.index.showToast({title:"æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥",icon:"none"})}}))},clearAvatarCache:function(){return c(this,null,(function*(){var o;try{if(console.log("å¼€å§‹æ¸…é™¤å¤´åƒç¼“å­˜..."),k.clear(),u.index.removeStorageSync("userInfo"),console.log("å·²æ¸…é™¤æœ¬åœ°ç”¨æˆ·ä¿¡æ¯ç¼“å­˜"),yield e.fetchUserInfo(),console.log("å·²é‡æ–°è·å–ç”¨æˆ·ä¿¡æ¯"),null==(o=e.userInfo)?void 0:o.avatar){const o=E(e.userInfo.avatar,!0);if(console.log("æ¸…é™¤å¤´åƒURLç¼“å­˜:",o),u.index.removeSavedFile)try{const e=(yield new Promise(((e,o)=>{u.index.getSavedFileList({success:o=>e(o.fileList||[]),fail:()=>e([])})}))).filter((e=>e.filePath&&e.filePath.includes("avatar")));if(e.length>0){console.log("æ‰¾åˆ°",e.length,"ä¸ªå¯èƒ½çš„å¤´åƒç¼“å­˜æ–‡ä»¶");for(const o of e)yield new Promise((e=>{u.index.removeSavedFile({filePath:o.filePath,success:()=>console.log("å·²åˆ é™¤ç¼“å­˜æ–‡ä»¶:",o.filePath),complete:e})}))}}catch(t){console.warn("æ¸…é™¤æ–‡ä»¶ç³»ç»Ÿç¼“å­˜æ—¶å‡ºé”™:",t)}try{const t=(new Date).getTime(),n=o.includes("?")?`${o}&t=${t}`:`${o}?t=${t}`;u.index.downloadFile({url:n,success:o=>{var t;if(console.log("å¤´åƒé‡æ–°ä¸‹è½½æˆåŠŸ"),null==(t=e.userInfo)?void 0:t.id){const t=e.userInfo.id,n=O.value?[O.value.longitude,O.value.latitude]:null;n&&pe(t,n,o.tempFilePath)}},fail:e=>{console.error("å¤´åƒé‡æ–°ä¸‹è½½å¤±è´¥:",e)},complete:()=>{u.index.showToast({title:"å¤´åƒç¼“å­˜å·²æ¸…é™¤",icon:"success"})}})}catch(n){console.error("ä¸‹è½½å¤´åƒæ—¶å‡ºé”™:",n),u.index.showToast({title:"å¤´åƒå·²æ¸…é™¤ï¼Œä½†é‡æ–°è·å–å¤±è´¥",icon:"none"})}}else console.log("ç”¨æˆ·æ²¡æœ‰å¤´åƒï¼Œæ— éœ€æ¸…é™¤ç¼“å­˜"),u.index.showToast({title:"æ— å¤´åƒï¼Œå·²æ¸…é™¤ç”¨æˆ·ä¿¡æ¯",icon:"none"})}catch(a){console.error("æ¸…é™¤å¤´åƒç¼“å­˜å¤±è´¥:",a),u.index.showToast({title:"æ¸…é™¤å¤´åƒç¼“å­˜å‡ºé”™",icon:"none"})}}))},onMapContainerClick:function(e){console.log("åœ°å›¾å®¹å™¨ç‚¹å‡»äº‹ä»¶:",e);const{clientX:o,clientY:t}=e,n=document.querySelectorAll(".amap-marker");for(const a of n){const n=a.getBoundingClientRect();if(o>=n.left&&o<=n.right&&t>=n.top&&t<=n.bottom){console.log("ç‚¹å‡»äº†æ ‡è®°å…ƒç´ :",a);const o=a.getAttribute("data-user-id");if(o)return console.log("è§¦å‘æ ‡è®°ç‚¹å‡», ç”¨æˆ·ID:",o),e.stopPropagation(),void Pe({detail:{markerId:o}})}}G.value&&(G.value=!1)},selectUserMarker:_e,navigateToPetIdentify(){u.index.navigateTo({url:"/pages/petIdentify/index"})},showAddMarkerForm:()=>{u.index.navigateTo({url:`/pages/map/add-marker?latitude=${O.value.latitude}&longitude=${O.value.longitude}`})},loadMarkers:T,displayMarkers:P,showMarkerInfo:e=>{e&&(n.setCurrentMarker(e),u.index.showModal({title:e.title,content:e.description||"æš‚æ— æè¿°",showCancel:!0,cancelText:"å…³é—­",confirmText:"å¯¼èˆª",success:o=>{o.confirm&&(l.value.setCenter([e.longitude,e.latitude]),l.value.setZoom(16))}}))},toggleMarkersVisibility:D,navigateToAIMedical(){u.index.navigateTo({url:"/pages/ai-medical/index"})},refreshMap:function(){console.log("åˆ·æ–°åœ°å›¾ - ä½¿ç”¨æµè§ˆå™¨åˆ·æ–°"),u.index.showLoading({title:"åˆ·æ–°åœ°å›¾ä¸­...",mask:!0});try{if("undefined"!=typeof window)setTimeout((()=>{console.log("æ‰§è¡Œé¡µé¢åˆ·æ–°"),window.location.reload()}),500);else{console.log("éH5ç¯å¢ƒï¼Œä½¿ç”¨uni-appæ–¹å¼åˆ·æ–°");u.index.switchTab({url:"/pages/index/index",success:()=>{setTimeout((()=>{u.index.switchTab({url:"/pages/map/index",complete:()=>{u.index.hideLoading()}})}),300)},fail:()=>{u.index.hideLoading(),u.index.showToast({title:"åˆ·æ–°å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ‡æ¢é¡µé¢",icon:"none",duration:2e3})}})}}catch(e){console.error("æ‰§è¡Œåˆ·æ–°æ“ä½œæ—¶å‡ºé”™:",e),u.index.hideLoading(),u.index.showToast({title:"åˆ·æ–°å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ‡æ¢é¡µé¢",icon:"none",duration:2e3})}}}}};if(!Array){(u.resolveComponent("UserInfoPopup")+u.resolveComponent("WalkSummaryPopup"))()}const y=u._export_sfc(k,[["render",function(e,o,t,n,a,l){var r,i,s,c,d,g,v,h,f,m,p,w;return u.e({a:n.showDebug},n.showDebug?u.e({b:u.t(n.debugInfo.markerCount),c:n.debugInfo.markerIds.length>0},n.debugInfo.markerIds.length>0?{d:u.t(n.debugInfo.markerIds.join(", "))}:{},{e:n.debugInfo.coords.length>0},n.debugInfo.coords.length>0?{f:u.t(n.debugInfo.coords.join(" | "))}:{},{g:u.t(n.currentLocation.latitude),h:u.t(n.currentLocation.longitude),i:u.t((null==(r=n.userStore.userInfo)?void 0:r.avatar)||"æ— "),j:u.t(n.userAvatar||"æ— "),k:u.t(n.allMarkers.length),l:u.t(n.userMarker?"å·²åˆ›å»º":"æœªåˆ›å»º"),m:u.o((e=>n.forceRefreshMarker(!1))),n:u.o((e=>n.forceRefreshMarker(!0))),o:u.o(((...e)=>n.reloadUserInfo&&n.reloadUserInfo(...e))),p:u.o(((...e)=>n.clearAvatarCache&&n.clearAvatarCache(...e))),q:u.o((e=>n.showDebug=!1))}):{},{r:u.o(((...e)=>n.onMapContainerClick&&n.onMapContainerClick(...e))),s:n.showLocationSharingTip},n.showLocationSharingTip?{t:u.o(((...e)=>n.cancelLocationSharing&&n.cancelLocationSharing(...e))),v:u.o(((...e)=>n.confirmLocationSharing&&n.confirmLocationSharing(...e)))}:{},{w:n.locationSharingStatusVisible},n.locationSharingStatusVisible?{x:n.isLocationShared?1:"",y:u.t(n.locationSharingStatus)}:{},{z:u.o(((...e)=>n.centerOnUser&&n.centerOnUser(...e))),A:u.o(((...e)=>n.zoomIn&&n.zoomIn(...e))),B:u.o(((...e)=>n.zoomOut&&n.zoomOut(...e))),C:u.o(((...e)=>n.showAddMarkerForm&&n.showAddMarkerForm(...e))),D:u.o(((...e)=>n.navigateToPetIdentify&&n.navigateToPetIdentify(...e))),E:u.t(e.showMarkers?"éšè—æ ‡è®°":"æ˜¾ç¤ºæ ‡è®°"),F:u.o(((...e)=>n.toggleMarkersVisibility&&n.toggleMarkersVisibility(...e))),G:u.o(((...e)=>n.navigateToAIMedical&&n.navigateToAIMedical(...e))),H:u.t(n.isWalking?"â¹ï¸":"â–¶ï¸"),I:u.t(n.isWalking?"åœæ­¢":"å¼€å§‹"),J:n.isWalking?1:"",K:u.o(((...e)=>n.toggleWalkingMode&&n.toggleWalkingMode(...e))),L:u.o(((...e)=>n.refreshMap&&n.refreshMap(...e))),M:n.isWalking},n.isWalking?{N:u.t((n.walkingDistance/1e3).toFixed(2)),O:u.t(n.formatDuration(n.walkingDuration)),P:u.t(n.calculatePace(n.walkingDistance,n.walkingDuration))}:{},{Q:n.showUserPopup},n.showUserPopup?{R:u.o(n.closeUserPopup),S:u.o(n.messageUser),T:u.o(n.followUser),U:u.p({user:n.selectedUser,pets:n.selectedUserPets,"is-following":n.isFollowing,visible:n.showUserPopup})}:{},{V:n.showWalkSummary},n.showWalkSummary?{W:u.o(n.closeWalkSummary),X:u.o(n.shareWalkRecord),Y:u.p({duration:n.walkingDuration,distance:n.walkingDistance,pets:n.myPets,"selected-pet-index":n.selectedPetIndex,"share-content":n.walkShareContent})}:{},{Z:n.showCustomMarkerPopup},n.showCustomMarkerPopup?u.e({aa:u.o((e=>n.showCustomMarkerPopup=!1)),ab:u.t((null==(i=n.selectedMarker)?void 0:i.title)||"æœªå‘½åæ ‡è®°"),ac:u.o((e=>n.showCustomMarkerPopup=!1)),ad:u.t(n.getMarkerTypeIcon(null==(s=n.selectedMarker)?void 0:s.type)),ae:n.getMarkerColor(null==(c=n.selectedMarker)?void 0:c.type),af:u.t(n.getMarkerTypeName(null==(d=n.selectedMarker)?void 0:d.type)),ag:u.t((null==(g=n.selectedMarker)?void 0:g.description)||"æš‚æ— æè¿°å†…å®¹"),ah:null==(v=n.selectedMarker)?void 0:v.radius},(null==(h=n.selectedMarker)?void 0:h.radius)?{ai:u.t(n.selectedMarker.radius<100?n.selectedMarker.radius+"å…¬é‡Œ ("+(1e3*n.selectedMarker.radius).toFixed(0)+"ç±³)":n.selectedMarker.radius+"ç±³")}:{},{aj:null==(f=n.selectedMarker)?void 0:f.createdAt},(null==(m=n.selectedMarker)?void 0:m.createdAt)?{ak:u.t(n.formatTime(n.selectedMarker.createdAt))}:{},{al:(null==(p=n.selectedMarker)?void 0:p.user)&&"string"!=typeof n.selectedMarker.user},(null==(w=n.selectedMarker)?void 0:w.user)&&"string"!=typeof n.selectedMarker.user?{am:u.t(n.getUserName(n.selectedMarker.user))}:{},{an:u.o((e=>n.showCustomMarkerPopup=!1)),ao:u.o((e=>n.navigateToMarker(n.selectedMarker)))}):{})}]]);wx.createPage(y);
