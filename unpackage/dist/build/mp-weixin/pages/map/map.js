"use strict";var e=Object.defineProperty,o=Object.defineProperties,t=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,r=(o,t,n)=>t in o?e(o,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):o[t]=n,i=(e,o)=>{for(var t in o||(o={}))a.call(o,t)&&r(e,t,o[t]);if(n)for(var t of n(o))l.call(o,t)&&r(e,t,o[t]);return e},s=(e,n)=>o(e,t(n)),c=(e,o,t)=>new Promise(((n,a)=>{var l=e=>{try{i(t.next(e))}catch(o){a(o)}},r=e=>{try{i(t.throw(e))}catch(o){a(o)}},i=e=>e.done?n(e.value):Promise.resolve(e.value).then(l,r);i((t=t.apply(e,o)).next())}));const u=require("../../common/vendor.js"),d=require("../../store/user.js"),g=require("../../store/pet.js"),v=require("../../store/location.js"),h=require("../../stores/markerStore.js"),f=require("../../utils/amap.js"),m=require("../../utils/api.js"),p=require("../../utils/request.js"),w=require("../../static/images/marker-icons.js");var I={VITE_CJS_IGNORE_WARNING:"true",VITE_ROOT_DIR:"D:/caloriesH5/CloudStorage",VITE_USER_NODE_ENV:"production",BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1};const k={components:{UserInfoPopup:()=>"../../components/map/UserInfoPopup.js",WalkSummaryPopup:()=>"../../components/map/WalkSummaryPopup.js"},setup(){const e=d.useUserStore(),o=g.usePetStore(),t=v.useLocationStore(),n=h.useMarkerStore(),a=u.ref(!0),l=u.ref(null),r={};const k={cache:{},get(e){const o=this.normalizeUrl(e);return this.cache[o]||null},put(e,o){const t=this.normalizeUrl(e);return this.cache[t]=o,console.log("头像缓存更新，当前缓存数:",Object.keys(this.cache).length),o},remove(e){const o=this.normalizeUrl(e);return!!this.cache[o]&&(delete this.cache[o],!0)},clear(){return this.cache={},console.log("头像缓存已清空"),!0},normalizeUrl(e){if(!e)return"";let o=e.split("?")[0];if(o.startsWith("/uploads/")){o=(I.VITE_API_URL||"http://49.235.65.37:5000")+o}return o}};function y(){const o={motionEvent:!1,deviceOrientation:!1,geolocation:!1,compass:!1,manualSet:!0};let t=null;function n(o,n){"compass"===n||"geolocation"===n||"deviceorientationevent"!==n&&"uniapp-motion"!==n||(o=(360-o)%360);const a={movement:5,geolocation:4,deviceorientationevent:3,"uniapp-motion":2,compass:1,manual:0};(!t||a[n]>a[t])&&(t=n),n===t&&(re.value=o,function(o){var t;const n=(null==(t=e.userInfo)?void 0:t.id)||"current-user-location";r[n]&&r[n].setRotation&&r[n].setRotation(o)}(o))}return function(){try{"undefined"!=typeof DeviceOrientationEvent&&(o.motionEvent=!0,window.addEventListener("deviceorientation",(e=>{if(null!==e.alpha&&void 0!==e.alpha){n(e.alpha,"deviceorientationevent")}})),console.log("已注册设备方向事件监听器"))}catch(e){console.warn("设备方向事件不可用:",e)}try{"function"==typeof u.index.onDeviceMotionChange&&(u.index.startDeviceMotionListening({interval:"game",success:()=>{o.deviceOrientation=!0,console.log("uni-app设备方向监听启动成功")},fail:e=>{console.warn("uni-app设备方向监听启动失败",e)}}),u.index.onDeviceMotionChange((e=>{if(void 0!==e.alpha){n(e.alpha,"uniapp-motion")}})))}catch(e){console.warn("uni-app设备方向API不可用:",e)}try{navigator.geolocation&&navigator.geolocation.watchPosition&&(navigator.geolocation.watchPosition((e=>{if(null!==e.coords.heading&&void 0!==e.coords.heading){o.geolocation=!0;n(e.coords.heading,"geolocation")}}),(e=>{console.warn("地理位置方向跟踪错误:",e)}),{enableHighAccuracy:!0,maximumAge:0}),console.log("已启动地理位置方向跟踪"))}catch(e){console.warn("地理位置方向API不可用:",e)}try{"function"==typeof u.index.onCompassChange&&(u.index.onCompassChange((e=>{if(void 0!==e.direction){o.compass=!0;n(e.direction,"compass")}})),console.log("已启动指南针方向跟踪"))}catch(e){console.warn("指南针API不可用:",e)}!function(){const e=[],o=5;u.watch(O,((t,a)=>{if(t&&a){const l=f.calculateDistance(a.latitude,a.longitude,t.latitude,t.longitude);if(l>5){const r=function(e,o,t,n){e=e*Math.PI/180,o=o*Math.PI/180,t=t*Math.PI/180,n=n*Math.PI/180;const a=Math.sin(n-o)*Math.cos(t),l=Math.cos(e)*Math.sin(t)-Math.sin(e)*Math.cos(t)*Math.cos(n-o);let r=180*Math.atan2(a,l)/Math.PI;return r=(r+360)%360,r}(a.latitude,a.longitude,t.latitude,t.longitude);if(e.push({location:t,timestamp:Date.now(),bearing:r,distance:l}),e.length>o&&e.shift(),e.length>=2){let o=0,t=0;if(e.forEach(((n,a)=>{const l=(a+1)/e.length*Math.min(n.distance/10,1);o+=n.bearing*l,t+=l})),t>0){n(o/t,"movement")}}}}}),{deep:!0})}(),setTimeout((()=>{console.log("方向传感器可用性:",o),o.motionEvent||o.deviceOrientation||o.geolocation||o.compass||(console.warn("没有可用的方向传感器，用户头像将不会旋转"),te.value&&u.index.showToast({title:"设备不支持方向传感器",icon:"none",duration:2e3}))}),3e3)}(),{setManualHeading:e=>{n(e,"manual")},getOrientationInfo:()=>({currentHeading:re.value,currentSource:t,supportInfo:i({},o)})}}const M=u.ref(!0),A=u.ref(!1),x=u.ref(null),D=()=>{if(M.value=!M.value,l.value){const e=l.value.getAllOverlays("circle"),o=l.value.getAllOverlays("marker").filter((e=>{const o=e.getExtData();return!(o&&o.isUserMarker)}));M.value?(o.forEach((e=>{e.show()})),e.forEach((e=>{e.show()})),console.log("显示所有标记和覆盖区域")):(o.forEach((e=>{e.hide()})),e.forEach((e=>{e.hide()})),console.log("隐藏所有标记和覆盖区域，用户头像保持显示")),S()}},S=()=>{if(!l.value)return;l.value.getAllOverlays("marker").filter((e=>{const o=e.getExtData();return o&&o.isUserMarker})).forEach((e=>{e.setzIndex(1e3),e.show()}))},T=()=>c(this,null,(function*(){try{if(console.log("加载标记数据..."),!O.value)return void console.warn("当前位置不可用，无法加载附近标记");console.log("正在从服务器获取附近标记..."),console.log("当前位置:",O.value);const o={show:()=>{u.index.showLoading({title:"加载标记中...",mask:!1})},hide:()=>{u.index.hideLoading()}};o.show();try{const e=yield n.fetchNearbyMarkers({longitude:O.value.longitude,latitude:O.value.latitude,radius:5e3});o.hide(),console.log("获取到附近标记:",e.length);const t=e.map((e=>{const o=i({},e);return o.latitude&&o.longitude||o.location&&o.location.coordinates&&(o.longitude=o.location.coordinates[0],o.latitude=o.location.coordinates[1]),void 0===o.radius||null===o.radius?(o.radius=.5,console.log(`标记 ${o.title||"未命名"} 没有半径，设置默认值0.5公里`)):console.log(`标记 ${o.title||"未命名"} 半径: ${o.radius}`),o.color||(o.color=o.color||"#007AFF"),o}));P(t),0===t.length&&u.index.showToast({title:"附近没有标记",icon:"none",duration:2e3})}catch(e){if(o.hide(),console.error("API获取标记失败:",e),u.index.showToast({title:"加载标记失败，请重试",icon:"none",duration:2e3}),n.markerCache&&n.markerCache.data&&n.markerCache.data.length>0){console.log("尝试使用缓存的标记数据");const e=n.filterMarkersByDistance(n.markerCache.data,{latitude:O.value.latitude,longitude:O.value.longitude,radius:5e3});if(e.length>0){const o=e.map((e=>(e.latitude&&e.longitude||e.location&&e.location.coordinates&&(e.longitude=e.location.coordinates[0],e.latitude=e.location.coordinates[1]),e.radius=e.radius||500,e.color=e.color||"#007AFF",e)));P(o),u.index.showToast({title:"显示缓存的标记数据",icon:"none",duration:2e3})}else P([])}else P([])}}catch(o){console.error("加载标记数据失败:",o),u.index.hideLoading(),u.index.showToast({title:"加载标记失败，请重试",icon:"none",duration:2e3})}})),P=e=>{try{if(console.log("显示标记数据:",e),!e||!e.length)return void console.log("没有标记可显示");if(l.value){const e=l.value.getAllOverlays("marker").filter((e=>{const o=e.getExtData();return!(o&&o.isUserMarker)}));e.length>0&&l.value.remove(e),l.value.remove(l.value.getAllOverlays("circle"))}e.forEach((e=>{var o,t,a,r;try{console.log("添加标记:",e);const i=[e.longitude||(null==(t=null==(o=e.location)?void 0:o.coordinates)?void 0:t[0]),e.latitude||(null==(r=null==(a=e.location)?void 0:a.coordinates)?void 0:r[1])];if(!i[0]||!i[1])return void console.warn("标记位置无效:",i);e.title||(e.title=e.title||"未命名标记"),e.type||(e.type=e.type||"general");const s=new AMap.Marker({position:i,title:e.title,icon:e.icon||C(e.type),anchor:"bottom-center",offset:new AMap.Pixel(0,0),extData:{marker:e,id:e._id,type:"marker"},clickable:!0});if(l.value.add(s),s.on("click",(o=>{console.log("标记被点击:",e),n.setSelectedMarker(e),b(e)})),e.radius){let o;if("number"==typeof e.radius)e.radius<100?(o=1e3*e.radius,console.log(`标记 "${e.title||"未命名"}" [${e._id}] - 转换半径从 ${e.radius}km 到 ${o}m`)):(o=e.radius,console.log(`标记 "${e.title||"未命名"}" [${e._id}] - 使用原始半径 ${o}m`));else{const t=parseFloat(e.radius)||.5;o=t<100?1e3*t:t,console.log(`标记 "${e.title||"未命名"}" [${e._id}] - 从字符串转换半径: ${e.radius} -> ${o}m`)}console.log(`最终使用的覆盖半径: ${o}米 (原始值: ${e.radius})`);const t=new AMap.Circle({center:i,radius:o,strokeColor:e.color||"#1E90FF",strokeWeight:2,strokeOpacity:.8,fillColor:e.color||"#1E90FF",fillOpacity:.15,extData:{marker:e}});l.value.add(t),t.on("click",(o=>{console.log("标记区域被点击:",e),n.setSelectedMarker(e);const t=o.target,a=t.getOptions().strokeColor,l=t.getOptions().fillColor,r=t.getOptions().fillOpacity;t.setOptions({strokeColor:"#FF3B30",fillColor:"#FF3B30",fillOpacity:.3}),setTimeout((()=>{t.setOptions({strokeColor:a,fillColor:l,fillOpacity:r})}),1e3),b(e)}))}}catch(i){console.error("添加单个标记时出错:",i)}})),console.log("标记显示完成"),S(),M.value||(D(),D())}catch(o){console.error("显示标记时出错:",o)}},C=e=>{if(w.markerIconsBase64&&w.markerIconsBase64[e])return w.markerIconsBase64[e];const o={general:"/static/images/marker.png",pet_friendly:"/static/images/pet-marker.png",danger:"/static/images/danger-marker.png",scenic:"/static/images/park-marker.png",pet_service:"/static/images/shop-marker.png",custom:"/static/images/marker.png"};return o[e]||o.general},b=e=>{var o,t,a,r;if(e)try{console.log("显示标记详情弹窗, 原始数据:",e);let s=e;if(e instanceof AMap.Marker){const o=e.getExtData();if(o&&o.marker)s=o.marker,console.log("从标记extData中获取到标记数据:",s);else if(o&&o.id){const e=n.markers.find((e=>e._id===o.id));e&&(s=e,console.log("从store中获取到标记数据:",s))}else console.warn("标记不包含有效的extData数据")}s.title||(s.title="未命名标记"),s.type||(s.type="general"),console.log("处理后的标记数据:",s),n.setSelectedMarker(s);const c=s.longitude||(null==(t=null==(o=s.location)?void 0:o.coordinates)?void 0:t[0]),d=s.latitude||(null==(r=null==(a=s.location)?void 0:a.coordinates)?void 0:r[1]);if(e instanceof AMap.Marker&&"function"==typeof e.setAnimation)try{e.setAnimation("AMAP_ANIMATION_BOUNCE"),setTimeout((()=>{e&&"function"==typeof e.setAnimation&&e.setAnimation(null)}),2e3)}catch(i){console.warn("设置标记动画效果失败:",i),"function"==typeof e.setzIndex&&e.setzIndex(999)}if(s.images&&s.images.length>0){console.log("标记包含图片，跳转到详情页面"),s.user&&"string"==typeof s.user&&(console.log("标记只包含用户ID，初始化基本用户对象"),s._processedUserInfo||(s._processedUserInfo=!0,s._originalUserId=s.user));const e=s._id;e?u.index.navigateTo({url:`/pages/map/marker-detail?id=${e}`}):u.index.showToast({title:"无法获取标记详情",icon:"none"})}else null!=x?(x.value=s,A.value=!0):(console.error("selectedMarker未定义"),u.index.showModal({title:s.title||"未命名标记",content:s.description||"无描述信息",showCancel:!0,cancelText:"关闭",confirmText:"导航",success:e=>{e.confirm&&c&&d&&l.value&&(l.value.setCenter([c,d]),l.value.setZoom(17))}}))}catch(s){console.error("显示标记信息失败:",s),u.index.showToast({title:"显示标记信息失败",icon:"none"})}},U=()=>{if(l.value)return l.value;if(console.error("地图未初始化，尝试获取地图实例"),"undefined"!=typeof window&&window.__dogRunMapInstance)return console.log("从全局变量获取地图实例"),l.value=window.__dogRunMapInstance,l.value;if("undefined"!=typeof window&&window.AMap){const o=document.getElementById("map-container");if(o&&o.__amap_instance__)return l.value=o.__amap_instance__,console.log("已从DOM元素获取地图实例"),l.value;if(console.log("尝试重新创建地图实例"),!o)throw new Error("无法获取地图容器");try{return l.value=new window.AMap.Map("map-container",{zoom:15,center:[O.value.longitude,O.value.latitude],resizeEnable:!0}),window.__dogRunMapInstance=l.value,o.__amap_instance__=l.value,console.log("地图实例已重新创建"),l.value}catch(e){throw console.error("无法创建地图实例:",e),new Error("无法创建地图实例: "+e.message)}}throw new Error("地图API未加载")};function E(e,o=!1){if(o&&console.log("getFullAvatarUrl处理:",e),!e)return o&&console.log("没有提供avatarPath，返回默认头像"),ie;if(e.startsWith("data:image/"))return o&&console.log("是base64图片，直接返回"),e;if(e.startsWith("http://")||e.startsWith("https://")){o&&console.log("已经是完整URL，直接返回:",e);return e.replace(/["']/g,"")}const t=u.index.getStorageSync("BASE_URL")||"http://49.235.65.37:5000";if(e.startsWith("/uploads/")){const n=t+e;return o&&console.log("是上传路径，添加基础URL:",n),n}if(e.startsWith("uploads/")){const n=t+"/"+e;return o&&console.log("是不带前导斜杠的上传路径，添加基础URL:",n),n}o&&console.log("未识别的路径类型，尝试添加基础URL:",e);return t+"/"+(e.startsWith("/")?e.substring(1):e)}const _=u.ref(16),O=u.ref({latitude:39.9087,longitude:116.3975}),L=u.ref([]),$=u.ref(null),F=u.ref(null),R=u.ref([]),W=u.ref(!1),B=u.ref([]),j=u.ref(0),N=u.ref(0),z=u.ref(null),q=u.ref(null),V=u.ref([]),G=u.ref(!1),Q=u.ref(null),K=u.ref([]),Y=u.ref(!1),H=u.ref(!1),Z=u.ref(!1),J=u.ref(""),X=u.ref([]),ee=u.computed((()=>X.value.map((e=>e.name)))),oe=u.ref(0),te=u.ref(!1),ne=u.ref({markerCount:0,markerIds:[],coords:[]}),ae=u.ref(!1),le=u.ref(!0),re=u.ref(0),ie="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAAAXNSR0IArs4c6QAAAQNJREFUeF7t1LENACAMBDFYm+WDxAhc6/TXWK/sdWaW+xbYAL/tXgiw+QGMfgABVoHY+4EAo0DMLRBgFIi5BQKMAjG3QIBRIOYWCDAKxNwCAUaBmFsgwCgQcwsEGAViboEAo0DMLRBgFIi5BQKMAjG3QIBRIOYWCDAKxNwCAUaBmFsgwCgQcwsEGAViboEAo0DMLRBgFIi5BQKMAjG3QIBRIOYWCDAKxNwCAUaBmFsgwCgQcwsEGAViboEAo0DMLRBgFIi5BQKMAjG3QIBRIOYWCDAKxPwCxDvF0aa/hxYAAAAASUVORK5CYII=",se=u.computed((()=>{const o=e.userInfo||e.user||{};return console.log("用户信息状态:",{"userStore.userAvatar存在":!!e.userAvatar,"userStore.userInfo存在":!!e.userInfo,"userStore.user存在":!!e.user,"头像路径":o.avatar||e.userAvatar}),e.userAvatar?E(e.userAvatar,!0):o.avatar?(console.log("头像计算细节:",{"原始路径":o.avatar,"是否以上传路径开头":o.avatar.startsWith("/uploads/"),"环境变量":u.index.getStorageSync("BASE_URL")||"http://49.235.65.37:5000"}),E(o.avatar,!0)):(console.log("未找到用户头像，使用默认蓝色头像"),ie)})),ce=u.ref(null),ue=u.computed((()=>{let e=[...L.value];if(ce.value)e=e.filter((e=>"user-location"!==e.id)),e.push(ce.value),console.log("添加用户位置标记:",ce.value);else if(O.value&&O.value.latitude){const o={id:"user-location",latitude:O.value.latitude,longitude:O.value.longitude,iconPath:se.value,width:40,height:40,rotate:re.value,anchor:{x:.5,y:.5}};e.push(o),console.log("添加临时用户标记:",o)}else console.warn("用户位置标记未创建，且没有位置信息");return e}));function de(){if(le.value)try{console.log("更新位置共享:",{latitude:O.value.latitude,longitude:O.value.longitude}),console.log("位置共享已在本地更新（不调用API）");try{t&&"function"==typeof t.updateLocation&&t.updateLocation({latitude:O.value.latitude,longitude:O.value.longitude,timestamp:(new Date).toISOString()}).catch((e=>{console.warn("更新位置API调用失败（已忽略）:",e)}))}catch(e){console.warn("位置API调用尝试失败（已忽略）:",e)}}catch(o){console.error("更新位置共享状态失败:",o)}}function ge(o=0){return c(this,null,(function*(){try{if(!l.value)return console.log("地图未准备好，延迟获取附近用户"),o<5&&setTimeout((()=>ge(o+1)),1500),Promise.resolve({success:!1,message:"地图未准备好"});if(!a.value)return console.log("后端API不可用，不获取附近用户"),R.value=[],Promise.resolve({success:!1,message:"后端API不可用"});if(!le.value)return console.log("位置共享未开启，不获取附近用户"),Promise.resolve({success:!1,message:"位置共享未开启"});if(!O.value||!O.value.latitude||!O.value.longitude)return console.error("当前位置不可用，稍后重试获取附近用户"),o<5&&setTimeout((()=>ge(o+1)),1500),Promise.resolve({success:!1,message:"当前位置不可用"});console.log("获取附近用户...");const n=yield t.getNearbyUsers({latitude:O.value.latitude,longitude:O.value.longitude,maxDistance:5e3}).catch((e=>(console.error("位置API错误:",e),o<3&&(console.log(`获取附近用户失败，${o+1}/3次重试`),setTimeout((()=>ge(o+1)),2e3)),{success:!1,message:"位置API错误"})));if(n&&n.success&&Array.isArray(n.data)){let o=[];if(e.userInfo&&e.userInfo.id?(o=n.data.filter((o=>o.id!==e.userInfo.id)),console.log("过滤后的其他用户数量:",o.length)):(o=n.data,console.log("未过滤的用户数量:",o.length)),e.userInfo&&O.value){const t=s(i({},e.userInfo),{latitude:O.value.latitude,longitude:O.value.longitude,lastUpdated:(new Date).toISOString()});o.length>0?(R.value=[t,...o],console.log("合并后的用户列表:",R.value.length,"个用户 (当前用户 + 其他用户)")):(R.value=[t],console.log("用户列表只包含当前用户"))}else R.value=o,console.log("用户列表不包含当前用户(未登录或无位置)");return ve(),console.log("获取到附近用户:",R.value.length),Promise.resolve(n)}if(console.log("未获取到附近用户或格式错误:",n),e.userInfo&&O.value){const o=s(i({},e.userInfo),{latitude:O.value.latitude,longitude:O.value.longitude,lastUpdated:(new Date).toISOString()});R.value=[o],console.log("API失败，只显示当前用户"),ve()}else R.value=[],console.log("API失败，且无当前用户信息，nearbyUsers为空");return!(o<3)||e.userInfo&&O.value||(console.log(`API失败，${o+1}/3次重试`),setTimeout((()=>ge(o+1)),2e3)),Promise.resolve({success:!1,message:"无附近用户",response:n})}catch(n){if(console.error("获取附近用户失败",n),e.userInfo&&O.value){const o=s(i({},e.userInfo),{latitude:O.value.latitude,longitude:O.value.longitude,lastUpdated:(new Date).toISOString()});R.value=[o],console.log("异常情况下，只显示当前用户"),ve()}else R.value=[],console.log("异常情况下，且无当前用户信息，nearbyUsers为空");return o<3&&(console.log(`异常情况，${o+1}/3次重试`),setTimeout((()=>ge(o+1)),2e3)),Promise.reject(n)}}))}function ve(){try{if(!R.value||!R.value.length)return console.log("没有附近用户，清除非自身标记"),void(l.value&&ue.value&&(ue.value.forEach((o=>{var t,n;const a=null==(t=null==o?void 0:o.extData)?void 0:t.userId,r=null==(n=e.userInfo)?void 0:n.id;console.log("标记ID:",a,"当前用户ID:",r),a&&r&&a!==r&&(console.log("移除非本人标记:",a),l.value.remove(o))})),ue.value=ue.value.filter((o=>{var t;return!o.extData||!o.extData.userId||o.extData.userId===(null==(t=e.userInfo)?void 0:t.id)}))));console.log("更新附近用户标记，用户数量:",R.value.length),ue.value&&ue.value.length>0&&ue.value.forEach((o=>{o&&o.extData&&o.extData.userId!==e.userInfo.id&&o.setMap(null)})),R.value.forEach((o=>{if(!o||!o.id||e.userInfo&&o.id===e.userInfo.id)return;if(!o.latitude||!o.longitude)return void console.log("用户缺少位置信息:",o.nickname||o.username);const t=String(o.id),n=[o.longitude,o.latitude];console.log(`创建用户[${t}]的标记:`,o.nickname||o.username);let a=o.userAvatar||o.avatar;if(a=E(a,!0),console.log("处理用户标记:",t,o.nickname,"头像:",a?"有":"无"),a&&a.startsWith("data:image/"))return void pe(t,n,a);const l=new Image;l.crossOrigin="anonymous",l.onload=()=>{pe(t,n,a)},l.onerror=()=>{console.error("获取头像失败，用户ID:",t),me(n,t)},l.src=a,setTimeout((()=>{l.complete&&0!==l.naturalWidth||(console.error("头像加载超时，用户ID:",t),me(n,t))}),3e3)})),console.log("地图标记更新完成")}catch(o){console.error("更新地图标记时出错:",o)}}function he(o,t){if(O.value&&0!==O.value.latitude){const e=o.latitude-O.value.latitude,t=o.longitude-O.value.longitude;if(Math.abs(e)>1e-5||Math.abs(t)>1e-5){const o=180*Math.atan2(t,e)/Math.PI;console.log("方位计算：",{dLat:e,dLng:t,calculatedHeading:o}),re.value=o}}if(O.value=o,console.log("位置已更新:",O.value),void 0!==t&&(re.value=t,console.log("使用罗盘朝向:",t)),(!window._lastMarkerUpdateTime||Date.now()-window._lastMarkerUpdateTime>3e4)&&(window._lastMarkerUpdateTime=Date.now(),console.log("触发定期标记更新"),e.isAuthenticated&&e.userInfo&&e.userInfo.id&&(console.log("使用实际用户ID更新标记:",e.userInfo.id),Ie())),W.value&&V.value.length>0){const e=V.value[V.value.length-1],t=f.calculateDistance(e.latitude,e.longitude,o.latitude,o.longitude);t>5&&(V.value.push({latitude:o.latitude,longitude:o.longitude}),B.value=[{points:V.value.map((e=>({latitude:e.latitude,longitude:e.longitude}))),color:"#007AFF",width:4}],j.value+=t)}}function fe(){u.index.getLocation({type:"gcj02",success:o=>{if(console.log("获取当前位置成功:",o),he({latitude:o.latitude,longitude:o.longitude}),l.value?(console.log("位置获取成功，立即将地图中心设置到当前位置"),l.value.setCenter([o.longitude,o.latitude]),l.value.setZoom(16)):console.log("地图尚未初始化，无法设置中心点"),e.hasDecidedLocationSharing||(ae.value=!0),window.AMap)try{const e=window.AMap;e.plugin(["AMap.Geolocation"],(function(){new e.Geolocation({enableHighAccuracy:!0,timeout:1e4,convert:!0,showButton:!1,showMarker:!1,showCircle:!1}).getCurrentPosition((function(e,o){"complete"===e?o.position&&(O.value={latitude:o.position.lat,longitude:o.position.lng},l.value&&l.value.setCenter([o.position.lng,o.position.lat])):console.log("高德地图定位失败",o)}))}))}catch(t){console.error("高德地图初始化失败:",t)}y()},fail:e=>{console.error("获取位置失败",e),u.index.showToast({title:"获取位置信息失败，请检查定位权限",icon:"none"})}}),$.value=setInterval((()=>{const e=W.value?5:15,o=Date.now(),t=o-(De.value||0);t<1e3*e?console.log(`距上次位置更新仅${Math.floor(t/1e3)}秒，未达到${e}秒更新间隔`):(De.value=o,u.index.getLocation({type:"gcj02",success:e=>{var o,t;const n=null==(o=O.value)?void 0:o.latitude,a=null==(t=O.value)?void 0:t.longitude;if(n&&a){const o=f.calculateDistance(n,a,e.latitude,e.longitude);if(o<5&&!W.value)return void console.log(`位置变化太小(${o.toFixed(2)}米)，忽略更新`)}"function"==typeof u.index.onCompassChange?u.index.onCompassChange((o=>{he({latitude:e.latitude,longitude:e.longitude},o.direction)})):he({latitude:e.latitude,longitude:e.longitude}),le.value&&de()}}))}),5e3),F.value=setInterval((()=>{ge()}),3e4)}function me(o,t){if(console.log("创建默认标记，用户ID:",t),!o&&O.value&&(o=[O.value.longitude,O.value.latitude]),o||(console.warn("createDefaultMarker: 无法获取位置信息，使用默认位置"),o=[116.3,39.9]),!t&&e.userInfo&&(t=e.userInfo.id,console.log("从用户存储获取ID:",t)),t||(t="current-user-marker",console.warn("userId未提供且无法获取，使用固定标识符:",t)),!l.value)return console.error("createDefaultMarker: 地图对象未初始化，无法创建标记"),null;const n=l,a=o,i=t;r[i]&&(console.log("移除已存在的同ID标记:",i),n.value.remove(r[i]),delete r[i]);try{console.log("使用ID创建默认标记:",i);const e=new AMap.Marker({map:n.value,position:a,icon:new AMap.Icon({size:new AMap.Size(30,30),image:"data:image/svg+xml;charset=utf-8,"+encodeURIComponent('\n\t\t\t\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30">\n\t\t\t\t\t\t\t\t<circle cx="15" cy="15" r="14" fill="#007aff" stroke="white" stroke-width="2"/>\n\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t'),imageSize:new AMap.Size(30,30)}),offset:new AMap.Pixel(-15,-15),zIndex:100,extData:{userId:i,type:"default-user"}});return r[i]=e,setTimeout((()=>{try{const o=e.getContentDom();o?(console.log("设置默认标记DOM属性，用户ID:",i),o.setAttribute("data-user-id",i),o.setAttribute("data-id",`user-marker-${i}`),o.id=`marker-${i}`,o.classList.add("user-marker"),o.classList.add(`user-marker-${i}`),o.setAttribute("data-marker-type","default-user"),o.setAttribute("data-timestamp",(new Date).getTime()),o.addEventListener("click",(e=>{e.stopPropagation(),console.log("默认标记DOM点击, 用户ID:",i),Pe({detail:{markerId:i}})})),o.style.cursor="pointer",o.style.pointerEvents="auto"):console.warn("无法获取默认标记DOM")}catch(o){console.error("设置默认标记DOM属性时出错:",o)}}),100),ue.value&&ue.value.push(e),e}catch(s){return console.error("创建默认标记时出错:",s),null}}const pe=(e,o,t)=>{if(!l.value)return console.error("地图未初始化，无法创建标记"),void setTimeout((()=>{l.value?(console.log("地图现在已初始化，重试创建标记"),pe(e,o,t)):console.error("重试后地图仍未初始化，标记创建失败")}),2e3);e||(console.warn("标记的userId为空，使用固定标识符"),e="current-user-location");try{console.log("开始创建用户标记，用户ID:",e);const n=t||se.value,a=k.get(n);if(a)return console.log("使用缓存的头像图像:",n.substring(0,50)+"..."),void createMarkerWithProcessedImage(e,o,a);if(n.startsWith("data:image"))return void processImageAndCreateMarker(e,o,n);const i=60,s=56,c=document.createElement("canvas");c.width=i,c.height=i;const u=c.getContext("2d",{willReadFrequently:!0});if(!u)return console.error("无法获取canvas上下文"),me(o,e);u.clearRect(0,0,i,i);const d=new Image;d.crossOrigin="Anonymous",d.onload=function(){try{u.save(),u.beginPath(),u.arc(i/2,i/2,s/2,0,2*Math.PI),u.closePath(),u.clip();const t=(i-s)/2,a=(i-s)/2;u.drawImage(d,t,a,s,s),u.restore(),u.beginPath(),u.arc(i/2,i/2,s/2,0,2*Math.PI),u.lineWidth=2,u.strokeStyle="#2196F3",u.stroke();const g=c.toDataURL("image/png");k.put(n,g),"object"!=typeof r&&(console.warn("userMarkers未定义，初始化为空对象"),window.userMarkers={});const v=new AMap.Marker({position:o,icon:new AMap.Icon({size:new AMap.Size(i,i),image:g,imageSize:new AMap.Size(i,i)}),offset:new AMap.Pixel(-i/2,-i/2),zIndex:100,extData:{userId:e,type:"user",isUserMarker:!0}});return l.value.add(v),r[e]=v,setTimeout((()=>{try{const o=v.getContentDom();if(o){console.log(`为标记DOM设置用户ID: ${e}`),o.setAttribute("data-user-id",e),o.setAttribute("data-id",`user-marker-${e}`),o.id=`marker-${e}`,o.classList.add("user-marker"),o.classList.add(`user-marker-${e}`),o.setAttribute("data-marker-type","user"),o.setAttribute("data-timestamp",(new Date).getTime()),o.addEventListener("click",(o=>{o.stopPropagation(),console.log("用户标记DOM点击, 用户ID:",e),Ce(e)})),o.style.cursor="pointer",o.style.pointerEvents="auto";const t=o.querySelector("img");t&&(t.setAttribute("data-user-id",e),t.setAttribute("data-id",`user-image-${e}`))}else console.warn("无法获取标记DOM元素")}catch(o){console.error("设置标记DOM属性时出错:",o)}}),100),v.on("click",(function(o){console.log("标记被点击，用户ID:",e),Ce(e)})),setTimeout((()=>be()),500),console.log("成功创建用户标记，用户ID:",e),v}catch(t){return console.error("绘制标记图像时出错:",t),me(o,e)}},d.onerror=function(t){return console.error("加载头像图像失败:",t),me(o,e)},d.src=t}catch(n){return console.error("创建用户标记出错:",n),me(o,e)}},we=()=>c(this,null,(function*(){if(e.token&&!e.user)try{console.log("发现token但没有用户数据，尝试获取用户信息"),yield e.fetchUserInfo(),console.log("成功获取用户数据:",e.user)}catch(o){console.error("获取用户信息失败，可能需要重新登录:",o)}if(e.token&&(console.log("已有token，假定用户已登录 - isAuthenticated:",e.isAuthenticated),!e.isAuthenticated&&!e.user))try{const o=u.index.getStorageSync("userInfo");if(o){const t=JSON.parse(o);e.$patch({user:t}),console.log("从本地存储恢复用户信息:",t)}else console.log("本地存储中没有用户信息")}catch(t){console.error("从本地存储恢复用户信息失败:",t)}console.log("当前认证状态:",{"token存在":!!e.token,"user存在":!!e.user,isAuthenticated:e.isAuthenticated})}));function Ie(){var o,t;try{if(!O.value||void 0===O.value.latitude)return console.error("当前位置信息不可用，无法添加标记"),void u.index.showToast({title:"无法获取位置信息",icon:"none"});let n=(null==(o=e.userInfo)?void 0:o.id)||(null==(t=e.user)?void 0:t._id)||"current-user-location";if(console.log("使用用户ID创建标记:",n),l.value){const e=l.value.getAllOverlays("marker");let o=!1;e.forEach((e=>{var t,a;try{const r=null==(a=null==(t=null==e?void 0:e.getExtData)?void 0:t.call(e))?void 0:a.userId;r!==n&&"current-user-location"!==r||(console.log(`发现已存在标记(${r})，移除以避免重复`),l.value.remove(e),o=!0)}catch(r){console.warn("检查标记时出错:",r)}})),o&&console.log("已移除旧标记，创建新标记")}const a=[O.value.longitude,O.value.latitude],i=se.value;console.log("创建用户标记，使用头像URL:",i),pe(n,a,i),r["current-user-location"]&&"current-user-location"!==n&&delete r["current-user-location"],console.log("已完成创建用户标记")}catch(n){console.error("创建标记时出错:",n),u.index.showToast({title:"创建位置标记失败",icon:"none"})}}function ke(o=!1){var t;if(!O.value||void 0===O.value.latitude)return console.error("当前位置信息不可用，无法添加标记"),void u.index.showToast({title:"无法获取位置信息",icon:"none"});o&&(console.log("强制清除头像缓存，使用最新上传的头像"),k.clear());const n=(null==(t=e.userInfo)?void 0:t.id)||"current-user-location",a=[O.value.longitude,O.value.latitude];if(l.value){const o=l.value.getAllOverlays("marker"),t=[];o.forEach((o=>{var n,a;try{const l=null==(a=null==(n=null==o?void 0:o.getExtData)?void 0:n.call(o))?void 0:a.userId;("current-user-location"===l||e.userInfo&&l===e.userInfo.id)&&t.push(o)}catch(l){console.error("处理标记时出错:",l)}})),t.length>0&&(console.log(`移除 ${t.length} 个用户标记`),l.value.remove(t),t.forEach((e=>{var o,t;const n=null==(t=null==(o=null==e?void 0:e.getExtData)?void 0:o.call(e))?void 0:t.userId;n&&r[n]&&delete r[n]}))),console.log("创建新的用户标记，用户ID:",n);const i=se.value;pe(n,a,i)}}u.onMounted((()=>c(this,null,(function*(){var t;if(console.log("组件挂载开始..."),setTimeout((()=>{Ee()}),1e3),Ue=setInterval((()=>{be(),(new Date).getSeconds()%10==0&&Ee()}),2e3),n.restoreMarkerCache(),yield we(),console.log("初始用户信息:",e.userInfo||e.user),console.log("初始头像路径:",null==(t=e.userInfo||e.user)?void 0:t.avatar),console.log("用户认证状态:",e.isAuthenticated),!e.user&&!e.userInfo){console.log("用户信息不完整，尝试重新获取...");try{yield e.fetchUserInfo(),console.log("已重新获取用户信息:",e.user)}catch(g){console.error("获取用户信息失败:",g)}}const r=()=>c(this,null,(function*(){try{console.log("检查后端API连接状态...");const e=yield p.request({url:"/api",method:"GET",timeout:5e3}).catch((e=>p.request({url:"/api/users/ping",method:"GET",timeout:5e3})));console.log("后端API连接正常:",e),a.value=!0}catch(e){console.error("后端API连接失败:",e),a.value=!1,u.index.showModal({title:"连接问题",content:"无法连接到服务器，部分功能可能不可用。请检查网络连接或稍后重试。",showCancel:!1})}})),d=e=>{if(e&&void 0!==e.latitude)try{if(console.log("使用确定位置初始化地图:",e),void 0===window.AMap){console.error("AMap未加载"),window.onAMapLoaded=()=>d(e);const o=document.createElement("script");return o.type="text/javascript",o.async=!0,o.src="https://webapi.amap.com/maps?v=2.0&key=9ea84b4333b114c188a67cb42564a48f&callback=onAMapLoaded",void document.head.appendChild(o)}if(!document.getElementById("map-container"))return void console.error("找不到地图容器元素(#map-container)");l.value=new window.AMap.Map("map-container",{zoom:16,center:[e.longitude,e.latitude],resizeEnable:!0,animateEnable:!0}),"undefined"!=typeof window&&(window.__dogRunMapInstance=l.value),console.log("高德地图初始化完成"),l.value.on("complete",(()=>{console.log("地图加载完成，创建用户标记和加载标记数据"),l.value.setCenter([e.longitude,e.latitude]),setTimeout((()=>{Ie(),T(),ge()}),800)})),l.value.on("click",(e=>{console.log("高德地图点击事件:",e),Se({detail:{x:e.pixel.x,y:e.pixel.y}})})),setTimeout(be,2e3)}catch(o){console.error("初始化地图出错:",o),u.index.showToast({title:"地图初始化失败，请重试",icon:"none"})}else console.error("初始化地图需要有效的位置信息")};(()=>{c(this,null,(function*(){u.index.showLoading({title:"正在定位...",mask:!0});try{const t=u.index.getStorageSync("last_known_location");let n=null;if(t)try{const e=JSON.parse(t);e&&e.timestamp&&Date.now()-e.timestamp<864e5&&(n={latitude:e.latitude,longitude:e.longitude},console.log("使用缓存位置作为临时位置",n),O.value=n)}catch(e){console.warn("解析缓存位置失败",e)}const a=yield((e=8e3)=>new Promise(((o,t)=>{const n=setTimeout((()=>{console.log("获取位置超时"),t(new Error("获取位置超时"))}),e);u.index.getLocation({type:"gcj02",success:e=>{clearTimeout(n),o({latitude:e.latitude,longitude:e.longitude})},fail:e=>{clearTimeout(n),console.error("获取位置失败:",e),t(e)}})})))(1e4).catch((e=>(console.warn("获取实际位置失败，使用备选方案",e),null)));u.index.hideLoading(),a?(O.value=a,console.log("获取到实际位置:",a),u.index.setStorageSync("last_known_location",JSON.stringify(s(i({},a),{timestamp:Date.now()})))):O.value||(O.value={latitude:31.31,longitude:121.52},console.warn("无法获取位置，使用默认上海位置")),fe(),d(O.value),function(){c(this,null,(function*(){try{const e=yield o.fetchPets();e&&Array.isArray(e)?X.value=e:X.value=[]}catch(e){console.error("获取我的宠物失败",e),X.value=[]}}))}(),r()}catch(t){u.index.hideLoading(),console.error("初始化地图流程出错:",t),u.index.showToast({title:"定位失败，使用默认位置",icon:"none"}),O.value||(O.value={latitude:31.31,longitude:121.52}),fe(),d(O.value)}}))})(),console.log("组件挂载完成")})))),u.onShow((()=>{console.log("地图页面显示"),l.value&&(console.log("刷新地图标记数据"),T())})),u.onBeforeUnmount((()=>{$.value&&clearInterval($.value),F.value&&clearInterval(F.value),q.value&&clearInterval(q.value),"function"==typeof u.index.stopDeviceMotionListening&&u.index.stopDeviceMotionListening({success:()=>{console.log("设备方向监听已停止")}}),"function"==typeof u.index.offCompassChange&&u.index.offCompassChange()}));const ye=u.ref(!1),Me=u.ref("未共享");function Ae(){return c(this,null,(function*(){try{console.log("开始保存遛狗记录...");const o=X.value.length>0?X.value[0]._id||X.value[0].id:null,t=X.value.length>0?X.value[0]:null;if(!o)return console.warn("没有宠物信息，无法保存遛狗记录"),u.index.showToast({title:"请先添加宠物",icon:"none"}),Promise.reject(new Error("没有宠物信息"));const n={pet:{_id:o,name:(null==t?void 0:t.name)||"未命名宠物",avatar:(null==t?void 0:t.avatar)||"/static/images/default-pet.png"},distance:j.value,duration:N.value,startTime:new Date(z.value).toISOString(),endTime:(new Date).toISOString(),route:V.value,mapImageUrl:"/static/images/default-map.png"};console.log("发送遛狗记录数据:",{"宠物ID":n.pet._id,"宠物名称":n.pet.name,"距离":`${n.distance}米 (${(n.distance/1e3).toFixed(2)}公里)`,"时长":`${n.duration}秒 (${Math.floor(n.duration/60)}分${n.duration%60}秒)`,"开始时间":new Date(n.startTime).toLocaleString(),"结束时间":new Date(n.endTime).toLocaleString(),"路线点数":n.route.length}),console.log("调用API: api.walk.startWalk, URL: /api/walks/start");const a=yield m.api.walk.startWalk(n);console.log("遛狗记录保存结果:",a);let l=null;if(a&&0===a.code&&a.data?(l=a.data.walkId,console.log("从标准格式获取walkId:",l)):a&&(a._id||a.id)?(l=a._id||a.id,console.log("从对象属性获取walkId:",l)):a&&a.data&&(a.data._id||a.data.id||a.data.walkId)&&(l=a.data._id||a.data.id||a.data.walkId,console.log("从嵌套对象获取walkId:",l)),!l)return console.error("无法从API响应获取walkId:",a),Promise.reject(new Error("无法获取遛狗记录ID"));console.log("遛狗记录创建成功，ID:",l),yield new Promise((e=>setTimeout(e,500)));try{console.log(`调用API: api.walk.endWalk, URL: /api/walks/${l}/end`);const e=yield m.api.walk.endWalk(l,{distance:j.value,duration:N.value,endTime:(new Date).toISOString()});console.log("遛狗记录结束结果:",e)}catch(e){console.error("结束遛狗记录失败，但初始记录已保存:",e)}return u.index.showToast({title:"记录已保存",icon:"success"}),setTimeout((()=>{console.log("准备跳转到遛狗记录页面..."),u.index.navigateTo({url:"/pages/walk/history",success:()=>{console.log("成功跳转到遛狗记录页面")},fail:e=>{console.error("跳转到遛狗记录页面失败:",e)}})}),3e3),Promise.resolve(l)}catch(o){if(console.error("保存遛狗记录出错:",o),console.error("错误详情:",o.message||"未知错误"),o.statusCode&&(console.error("HTTP状态码:",o.statusCode),404===o.statusCode)){console.error("API端点不存在，使用本地存储");try{const e=u.index.requireNativePlugin("walkStorage")||require("@/utils/walkStorage.js").default,o={pet:{_id:X.value.length>0?X.value[0]._id||X.value[0].id:"default-pet",name:X.value.length>0?X.value[0].name:"未命名宠物",avatar:X.value.length>0?X.value[0].avatar:"/static/images/default-pet.png"},distance:j.value,duration:N.value,startTime:new Date(z.value).toISOString(),endTime:(new Date).toISOString(),route:V.value};console.log("尝试使用本地存储保存遛狗记录");const t=e.saveWalkRecord(o);if(console.log("本地存储保存结果:",t),t&&0===t.code&&t.data&&t.data.walkId)return Promise.resolve(t.data.walkId);throw new Error("本地存储保存失败")}catch(t){console.error("使用本地存储保存失败:",t)}}throw u.index.showToast({title:"保存记录失败: "+(o.message||"未知错误"),icon:"none",duration:3e3}),o}}))}const xe=u.ref(!1),De=u.ref(0);function Se(e){if(console.log("地图点击事件:",e),xe.value)return void console.log("地图正在拖动，忽略点击");const{x:o,y:t}=e.detail;if(void 0!==o&&void 0!==t){try{const e=document.querySelectorAll(".amap-marker");if(e.length>0){console.log("找到高德地图标记:",e.length,"个");for(const n of e){const e=n.getBoundingClientRect();if(o>=e.left&&o<=e.right&&t>=e.top&&t<=e.bottom){console.log("点击命中标记元素:",n);const e=n.getAttribute("data-id")||n.id||n.getAttribute("id");if(e)return console.log("触发标记点击:",e),void Pe({detail:{markerId:e}});const a=Te(o,t);if(a)return console.log("找到最接近的用户:",a.nickname||a.username),void Pe({detail:{markerId:a.id}})}}}const n=Te(o,t);if(n)return console.log("找到最接近的用户:",n.nickname||n.username),void Pe({detail:{markerId:n.id}})}catch(n){console.error("处理地图点击事件出错:",n)}G.value&&(G.value=!1)}else console.log("点击事件没有坐标信息")}function Te(e,o){if(!R.value||!R.value.length)return null;const t=document.getElementById("map");if(!t)return null;const n=t.getBoundingClientRect(),a=n.width,l=n.height,r=e-(n.left+a/2),i=o-(n.top+l/2),s=_.value,c=20/s*5e-6,u=20/s*5e-6/Math.cos(O.value.latitude*Math.PI/180),d=O.value.latitude-i*c,g=O.value.longitude+r*u;console.log("点击经纬度估计:",{lat:d,lng:g});let v=null,h=1/0;return R.value.forEach((e=>{if(!e.latitude||!e.longitude)return;const o=Math.sqrt(Math.pow((e.latitude-d)/c,2)+Math.pow((e.longitude-g)/u,2));o<30&&o<h&&(h=o,v=e)})),v}function Pe(e){return c(this,null,(function*(){var o,t,n;try{let a=e.markerId||(null==(o=e.detail)?void 0:o.markerId);if(!a&&(null==(t=e.detail)?void 0:t.marker)&&(a=e.detail.marker.id),!a&&(null==(n=e.detail)?void 0:n.nativeEvent)){const o=e.detail.nativeEvent.target;o&&o.dataset&&(a=o.dataset.userId||o.dataset.id)}a?(console.log("获取到标记ID:",a),yield Ce(a)):(console.error("无法获取标记ID"),Array.isArray(R.value)&&R.value.length>0?(console.log("使用第一个附近用户作为备选"),yield Ce(R.value[0].id)):u.index.showToast({title:"无法获取用户信息",icon:"none"}))}catch(a){console.error("标记点击处理出错:",a),u.index.showToast({title:"操作失败，请重试",icon:"none"})}}))}function Ce(e){return c(this,null,(function*(){console.log("处理用户标记点击事件, 用户ID:",e);try{yield _e(e)}catch(o){console.error("处理用户标记点击失败:",o)}}))}function be(){try{const e=document.querySelectorAll(".amap-marker");if(e.length>0){console.log("发现地图标记元素:",e.length,"个");let o=[];e.forEach((e=>{var t;const n=e.getAttribute("data-user-id")||(e.id?null==(t=e.id.match(/marker-([^"\s]+)/))?void 0:t[1]:null);n&&o.push(n)})),console.log("地图上的用户ID:",o),setTimeout((()=>{e.forEach((e=>{if(!e.hasAttribute("data-click-handler")){e.addEventListener("click",(o=>{o.stopPropagation(),console.log("标记点击事件 (直接):",e);let t=e.getAttribute("data-user-id");if(!t&&e.className){const o=e.className.match(/user-marker-([^"\s]+)/);o&&o[1]&&(t=o[1])}if(!t&&e.id){const o=e.id.match(/marker-([^"\s]+)/);o&&o[1]&&(t=o[1])}if(!t){const o=e.querySelector("img");o&&(t=o.getAttribute("data-user-id"))}console.log("尝试提取的用户ID:",t),t?(console.log("找到用户ID，触发标记点击事件:",t),Ce(t)):R.value&&R.value.length>0&&(console.log("无法识别用户ID，使用第一个附近用户"),Ce(R.value[0].id))})),e.setAttribute("data-click-handler","true"),e.style.cursor="pointer",e.style.pointerEvents="auto",e.style.zIndex="999";const o=e.querySelector(".amap-icon");if(o){o.style.borderRadius="50%",o.style.overflow="hidden";const t=o.querySelector("img");if(t){const o=e.getAttribute("data-user-id");o&&(t.setAttribute("data-user-id",o),console.log("设置图像元素data-user-id属性:",o)),t.style.borderRadius="50%",t.style.width="100%",t.style.height="100%",t.style.objectFit="cover",t.addEventListener("click",(o=>{o.stopPropagation(),console.log("图像点击事件");const n=t.getAttribute("data-user-id")||e.getAttribute("data-user-id");console.log("图像点击 - 提取的用户ID:",n),n&&(console.log("找到图像用户ID，处理标记点击:",n),Ce(n))}))}}}}))}),100)}}catch(e){console.error("处理地图标记出错:",e)}}let Ue;function Ee(){var o,t;if(console.log("执行标记清理..."),!l.value)return;const n=l.value.getAllOverlays("marker");if(!n||0===n.length)return void console.log("地图上没有标记，无需清理");console.log(`地图上共有 ${n.length} 个标记`);const a=(null==(o=e.userInfo)?void 0:o.id)||(null==(t=e.user)?void 0:t._id);if(!a)return void console.log("未找到当前用户ID，跳过标记清理");console.log("当前用户ID:",a);const i=[a,"current-user-location"],s=[];n.forEach((e=>{var o,t;try{const n=(null==(t=null==(o=null==e?void 0:e.getExtData)?void 0:o.call(e))?void 0:t.userId)||"未知";s.push(n)}catch(n){console.error("获取标记ID出错:",n)}})),console.log("地图上的标记ID:",s);const c=[];n.forEach((e=>{var o,t;try{const n=null==(t=null==(o=null==e?void 0:e.getExtData)?void 0:o.call(e))?void 0:t.userId;if(!n)return console.log("找到无ID标记，移除"),void l.value.remove(e);i.includes(n)?(console.log(`保留标记ID: ${n}`),c.push(n)):(console.log(`移除标记ID: ${n}`),l.value.remove(e),r[n]&&delete r[n])}catch(n){console.error("清理标记时出错:",n)}})),console.log(`清理完成，保留标记: ${c.join(", ")}`)}u.watch((()=>e.isAuthenticated),(e=>{console.log("用户登录状态变更:",e),e?(console.log("用户已登录，获取宠物数据"),o.fetchPets().then((e=>{console.log("登录后获取宠物数据成功:",e),X.value=e})).catch((e=>{console.error("登录后获取宠物数据失败:",e)}))):(console.log("用户已登出，清空宠物数据"),X.value=[])})),u.onBeforeUnmount((()=>{Ue&&clearInterval(Ue)}));const _e=t=>c(this,null,(function*(){console.log("选中用户标记:",t);try{let a,l=[];if(t===e.userId)a=s(i({},e.user),{isCurrentUser:!0}),l=o.pets||[];else{if(a=yield m.api.user.getUserById(t),!a)return void console.error("未找到用户信息");a=s(i({},a),{isCurrentUser:!1});try{l=yield m.api.pet.getPetsByUser(t)}catch(n){console.error("获取用户宠物失败:",n),l=[]}try{if(e.isAuthenticated){const o=yield e.fetchUserInfo();H.value=o.following&&o.following.some((e=>e===t||e._id&&e._id===t))}}catch(n){console.error("检查关注状态失败:",n),H.value=!1}}Q.value=a,K.value=l,G.value=!0}catch(n){console.error("获取用户信息失败:",n)}}));return{userStore:e,petStore:o,mapScale:_,currentLocation:O,markers:L,allMarkers:ue,nearbyUsers:R,isWalking:W,walkingPath:B,walkingDistance:j,walkingDuration:N,showUserPopup:G,selectedUser:Q,selectedUserPets:K,selectedUserFollowStatus:Y,isFollowing:H,showWalkSummary:Z,walkShareContent:J,myPets:X,myPetsNames:ee,selectedPetIndex:oe,showDebug:te,debugInfo:ne,showLocationSharingTip:ae,isLocationShared:le,userAvatar:se,userHeading:re,defaultAvatarBase64:ie,userMarker:ce,locationSharingStatusVisible:ye,locationSharingStatus:Me,formatDuration:f.formatDuration,calculatePace:f.calculatePace,forceRefreshMarker:ke,toggleMarker:Ie,toggleWalkingMode:function(){if(console.log("切换遛狗模式，当前状态:",W.value),W.value){W.value=!1,clearInterval(q.value),q.value=null,le.value=!1,ye.value=!1,console.log("遛狗结束，时长:",N.value,"秒"),console.log("遛狗距离:",j.value,"米");const e=5;N.value>=e?(!function(){const e=(j.value/1e3).toFixed(2),o=f.formatDuration(N.value),t=f.calculatePace(j.value,N.value),n=ee.value.length?ee.value.join("、"):"我的宠物";J.value=`我带${n}遛了${e}公里，用时${o}，配速${t}！`}(),Ae().then((e=>{console.log("遛狗记录保存成功，ID:",e),Z.value=!0,u.index.showToast({title:"记录已保存",icon:"success",duration:2e3})})).catch((e=>{console.error("保存遛狗记录失败:",e),Z.value=!0,u.index.showToast({title:"记录保存失败，使用本地存储",icon:"none",duration:2e3})}))):(console.log("遛狗时间太短，不保存记录"),u.index.showToast({title:`遛狗时间太短（少于${e}秒），未保存记录`,icon:"none",duration:2e3}))}else ae.value=!0},confirmLocationSharing:function(){try{le.value=!0,ae.value=!1,console.log("已启用位置共享（本地）"),u.index.showToast({title:"已开始位置共享",icon:"success"}),de(),function(){W.value=!0,z.value=Date.now(),j.value=0,N.value=0,V.value=[{latitude:O.value.latitude,longitude:O.value.longitude}],B.value=[{points:[{latitude:O.value.latitude,longitude:O.value.longitude}],color:"#007AFF",width:4}],q.value&&clearInterval(q.value);console.log("开始遛狗，设置计时器"),q.value=setInterval((()=>{const e=Date.now(),o=Math.floor((e-z.value)/1e3);N.value=o,o%30==0&&o>0&&console.log("遛狗进行中，已经",o,"秒")}),1e3),console.log("遛狗模式已开始:",{"开始时间":new Date(z.value).toLocaleTimeString(),"初始位置":V.value[0]})}()}catch(e){console.error("开始位置共享出错:",e)}},cancelLocationSharing:function(){try{le.value=!1,ae.value=!1,console.log("已禁用位置共享（本地）"),u.index.showToast({title:"已停止位置共享",icon:"none"})}catch(e){console.error("停止位置共享出错:",e)}},saveWalkRecord:Ae,onMarkerTap:Pe,onMapTap:Se,onMapRegionChange:function(e){console.log("地图区域变更:",e),"begin"===e.type&&"drag"===e.causedBy?(console.log("地图开始拖动"),xe.value=!0):"end"===e.type&&"drag"===e.causedBy&&(console.log("地图结束拖动"),setTimeout((()=>{xe.value=!1}),50))},onMapUpdated:function(o){if(console.log("地图更新事件触发"),te.value)try{ne.value={markerCount:L.value.length+ue.value.length,markerIds:L.value.map((e=>e.id)).concat(ue.value.map((e=>e.id))),coords:O.value?[O.value.latitude.toFixed(6),O.value.longitude.toFixed(6)]:[]}}catch(a){console.error("更新调试信息错误:",a)}const n=t.sharingEnabled;if(le.value=n,console.log("位置共享状态:",le.value?"已开启":"已关闭"),!window._lastMarkerCheck||Date.now()-window._lastMarkerCheck>3e4){window._lastMarkerCheck=Date.now();try{const o=ue.value.some((e=>"user-location"===e.id));if(O.value&&void 0!==O.value.latitude&&null!==O.value.latitude&&!o){console.log("添加用户标记...");const o=se.value,t=e.userInfo?e.userInfo.id:"user-location",n=[O.value.longitude,O.value.latitude];if(o.startsWith("data:image/"))pe(t,n,o);else{const e=new Image;e.crossOrigin="anonymous",e.onload=()=>{pe(t,n,o)},e.onerror=()=>{console.error("加载用户头像失败，使用默认头像"),pe(t,n,ie)},e.src=o,setTimeout((()=>{e.complete&&0!==e.naturalWidth||pe(t,n,ie)}),3e3)}}}catch(a){console.error("添加标记错误:",a)}}},hideUserPopup:function(){console.log("隐藏用户弹窗"),G.value=!1},showMarkerPopup:b,showCustomMarkerPopup:A,selectedMarker:x,getMarkerTypeName:e=>{if(!e)return"普通标记";return{general:"普通标记",pet_friendly:"宠物友好",danger:"危险区域",scenic:"风景区",pet_service:"宠物服务",custom:"自定义"}[e]||"未知类型"},getMarkerTypeIcon:e=>{if(!e)return"📍";return{general:"📍",pet_friendly:"🐾",danger:"⚠️",scenic:"🏞️",pet_service:"🏥",custom:"✨"}[e]||"📍"},getMarkerColor:e=>{if(!e)return"#4285F4";return{general:"#4285F4",pet_friendly:"#34A853",danger:"#EA4335",scenic:"#FBBC05",pet_service:"#FF7F50",custom:"#9370DB"}[e]||"#4285F4"},navigateToMarker:e=>{var o,t,n,a;if(e)try{const r=e.longitude||(null==(t=null==(o=e.location)?void 0:o.coordinates)?void 0:t[0]),i=e.latitude||(null==(a=null==(n=e.location)?void 0:n.coordinates)?void 0:a[1]);r&&i&&l.value&&(l.value.setCenter([r,i]),l.value.setZoom(17),A.value=!1,u.index.showToast({title:"正在导航到标记位置",icon:"none",duration:1500}))}catch(r){console.error("导航到标记位置失败:",r)}},formatTime:e=>{if(!e)return"未知时间";const o=new Date(e);return`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")} ${String(o.getHours()).padStart(2,"0")}:${String(o.getMinutes()).padStart(2,"0")}`},getUserName:e=>e?"string"==typeof e?"用户"+e.substr(-4):e.nickname||e.username||"未知用户":"未知用户",centerOnUser(){console.log("定位到用户位置");try{if(l.value=U(),!O.value||void 0===O.value.latitude)return console.warn("当前位置信息不可用，尝试重新获取位置"),void u.index.getLocation({type:"gcj02",success:e=>{console.log("重新获取位置成功:",e),O.value={latitude:e.latitude,longitude:e.longitude};const o=[e.longitude,e.latitude];console.log("设置地图中心到:",o),l.value.setCenter(o),l.value.setZoom(16),u.index.showToast({title:"已定位到当前位置",icon:"none",duration:1e3})},fail:e=>{console.error("重新获取位置失败:",e),u.index.showToast({title:"获取位置失败，请检查定位权限",icon:"none"})}});const e=[O.value.longitude,O.value.latitude];console.log("设置地图中心到:",e),l.value.setCenter(e),l.value.setZoom(16),u.index.showToast({title:"已定位到当前位置",icon:"none",duration:1e3})}catch(e){console.error("设置地图中心点出错:",e),u.index.showToast({title:"定位失败，请重试",icon:"none"})}},zoomIn(){console.log("放大地图");try{l.value=U();const e=l.value.getZoom();console.log("当前缩放级别:",e);const o=Math.min(e+1,19);console.log("新缩放级别:",o),l.value.setZoom(o),u.index.showToast({title:"已放大地图",icon:"none",duration:500})}catch(e){console.error("地图放大出错:",e),u.index.showToast({title:"操作失败，请重试",icon:"none"})}},zoomOut(){console.log("缩小地图");try{l.value=U();const e=l.value.getZoom();console.log("当前缩放级别:",e);const o=Math.max(e-1,3);console.log("新缩放级别:",o),l.value.setZoom(o),u.index.showToast({title:"已缩小地图",icon:"none",duration:500})}catch(e){console.error("地图缩小出错:",e),u.index.showToast({title:"操作失败，请重试",icon:"none"})}},closeUserPopup:function(){console.log("关闭用户弹窗"),G.value=!1,Q.value=null,K.value=[]},messageUser(e){u.index.navigateTo({url:`/pages/profile/message?userId=${e}`})},followUser(e){H.value=!H.value},closeWalkSummary(){console.log("关闭步行摘要"),Z.value=!1},shareWalkRecord(e){console.log("分享遛狗记录到社区",e);const o=e&&e.selectedPetIndex>=0&&X.value.length>e.selectedPetIndex?X.value[e.selectedPetIndex]:null;let t=`我和${o?o.name:"我的宠物"}一起遛了${(j.value/1e3).toFixed(2)}公里，用时${f.formatDuration(N.value)}！`;e&&e.content&&(t+="\n\n"+e.content),Z.value=!1,Ae().then((e=>{console.log("已保存遛狗记录，准备分享到社区，记录ID:",e);const n={_id:e,distance:j.value,duration:N.value,startTime:walkStartTime.value,routeSnapshot:currentRouteSnapshot.value,pet:o?{_id:o._id,name:o.name,avatar:o.avatar}:null};setTimeout((()=>{u.index.navigateTo({url:"/pages/community/create",success:e=>{u.index.$emit("createPost",{content:t,walkRecord:n}),u.index.showToast({title:"正在前往社区",icon:"none",duration:1500})},fail:e=>{console.error("导航到社区发帖页面失败:",e),u.index.showToast({title:"打开社区页面失败",icon:"none"})}})}),300)})).catch((e=>{console.error("保存遛狗记录失败，无法分享到社区:",e),u.index.showToast({title:"分享失败，请重试",icon:"none"})}))},reloadUserInfo:function(){return c(this,null,(function*(){var o,t;try{console.log("开始重新加载用户信息..."),console.log("当前用户信息:",JSON.stringify(e.userInfo)),console.log("当前头像路径:",null==(o=e.userInfo)?void 0:o.avatar),console.log("当前计算的头像URL:",se.value),yield e.fetchUserInfo(),console.log("更新后的用户信息:",JSON.stringify(e.userInfo)),console.log("更新后的头像路径:",null==(t=e.userInfo)?void 0:t.avatar),console.log("更新后的计算头像URL:",se.value),console.log("环境变量VITE_API_URL:",I.VITE_API_URL),u.index.showToast({title:"用户信息已更新",icon:"none"}),setTimeout((()=>{ke(!0)}),500)}catch(n){console.error("重新加载用户信息失败:",n),u.index.showToast({title:"更新用户信息失败",icon:"none"})}}))},clearAvatarCache:function(){return c(this,null,(function*(){var o;try{if(console.log("开始清除头像缓存..."),k.clear(),u.index.removeStorageSync("userInfo"),console.log("已清除本地用户信息缓存"),yield e.fetchUserInfo(),console.log("已重新获取用户信息"),null==(o=e.userInfo)?void 0:o.avatar){const o=E(e.userInfo.avatar,!0);if(console.log("清除头像URL缓存:",o),u.index.removeSavedFile)try{const e=(yield new Promise(((e,o)=>{u.index.getSavedFileList({success:o=>e(o.fileList||[]),fail:()=>e([])})}))).filter((e=>e.filePath&&e.filePath.includes("avatar")));if(e.length>0){console.log("找到",e.length,"个可能的头像缓存文件");for(const o of e)yield new Promise((e=>{u.index.removeSavedFile({filePath:o.filePath,success:()=>console.log("已删除缓存文件:",o.filePath),complete:e})}))}}catch(t){console.warn("清除文件系统缓存时出错:",t)}try{const t=(new Date).getTime(),n=o.includes("?")?`${o}&t=${t}`:`${o}?t=${t}`;u.index.downloadFile({url:n,success:o=>{var t;if(console.log("头像重新下载成功"),null==(t=e.userInfo)?void 0:t.id){const t=e.userInfo.id,n=O.value?[O.value.longitude,O.value.latitude]:null;n&&pe(t,n,o.tempFilePath)}},fail:e=>{console.error("头像重新下载失败:",e)},complete:()=>{u.index.showToast({title:"头像缓存已清除",icon:"success"})}})}catch(n){console.error("下载头像时出错:",n),u.index.showToast({title:"头像已清除，但重新获取失败",icon:"none"})}}else console.log("用户没有头像，无需清除缓存"),u.index.showToast({title:"无头像，已清除用户信息",icon:"none"})}catch(a){console.error("清除头像缓存失败:",a),u.index.showToast({title:"清除头像缓存出错",icon:"none"})}}))},onMapContainerClick:function(e){console.log("地图容器点击事件:",e);const{clientX:o,clientY:t}=e,n=document.querySelectorAll(".amap-marker");for(const a of n){const n=a.getBoundingClientRect();if(o>=n.left&&o<=n.right&&t>=n.top&&t<=n.bottom){console.log("点击了标记元素:",a);const o=a.getAttribute("data-user-id");if(o)return console.log("触发标记点击, 用户ID:",o),e.stopPropagation(),void Pe({detail:{markerId:o}})}}G.value&&(G.value=!1)},selectUserMarker:_e,navigateToPetIdentify(){u.index.navigateTo({url:"/pages/petIdentify/index"})},showAddMarkerForm:()=>{u.index.navigateTo({url:`/pages/map/add-marker?latitude=${O.value.latitude}&longitude=${O.value.longitude}`})},loadMarkers:T,displayMarkers:P,showMarkerInfo:e=>{e&&(n.setCurrentMarker(e),u.index.showModal({title:e.title,content:e.description||"暂无描述",showCancel:!0,cancelText:"关闭",confirmText:"导航",success:o=>{o.confirm&&(l.value.setCenter([e.longitude,e.latitude]),l.value.setZoom(16))}}))},toggleMarkersVisibility:D,navigateToAIMedical(){u.index.navigateTo({url:"/pages/ai-medical/index"})},refreshMap:function(){console.log("刷新地图 - 使用浏览器刷新"),u.index.showLoading({title:"刷新地图中...",mask:!0});try{if("undefined"!=typeof window)setTimeout((()=>{console.log("执行页面刷新"),window.location.reload()}),500);else{console.log("非H5环境，使用uni-app方式刷新");u.index.switchTab({url:"/pages/index/index",success:()=>{setTimeout((()=>{u.index.switchTab({url:"/pages/map/index",complete:()=>{u.index.hideLoading()}})}),300)},fail:()=>{u.index.hideLoading(),u.index.showToast({title:"刷新失败，请手动切换页面",icon:"none",duration:2e3})}})}}catch(e){console.error("执行刷新操作时出错:",e),u.index.hideLoading(),u.index.showToast({title:"刷新失败，请手动切换页面",icon:"none",duration:2e3})}}}}};if(!Array){(u.resolveComponent("UserInfoPopup")+u.resolveComponent("WalkSummaryPopup"))()}const y=u._export_sfc(k,[["render",function(e,o,t,n,a,l){var r,i,s,c,d,g,v,h,f,m,p,w;return u.e({a:n.showDebug},n.showDebug?u.e({b:u.t(n.debugInfo.markerCount),c:n.debugInfo.markerIds.length>0},n.debugInfo.markerIds.length>0?{d:u.t(n.debugInfo.markerIds.join(", "))}:{},{e:n.debugInfo.coords.length>0},n.debugInfo.coords.length>0?{f:u.t(n.debugInfo.coords.join(" | "))}:{},{g:u.t(n.currentLocation.latitude),h:u.t(n.currentLocation.longitude),i:u.t((null==(r=n.userStore.userInfo)?void 0:r.avatar)||"无"),j:u.t(n.userAvatar||"无"),k:u.t(n.allMarkers.length),l:u.t(n.userMarker?"已创建":"未创建"),m:u.o((e=>n.forceRefreshMarker(!1))),n:u.o((e=>n.forceRefreshMarker(!0))),o:u.o(((...e)=>n.reloadUserInfo&&n.reloadUserInfo(...e))),p:u.o(((...e)=>n.clearAvatarCache&&n.clearAvatarCache(...e))),q:u.o((e=>n.showDebug=!1))}):{},{r:u.o(((...e)=>n.onMapContainerClick&&n.onMapContainerClick(...e))),s:n.showLocationSharingTip},n.showLocationSharingTip?{t:u.o(((...e)=>n.cancelLocationSharing&&n.cancelLocationSharing(...e))),v:u.o(((...e)=>n.confirmLocationSharing&&n.confirmLocationSharing(...e)))}:{},{w:n.locationSharingStatusVisible},n.locationSharingStatusVisible?{x:n.isLocationShared?1:"",y:u.t(n.locationSharingStatus)}:{},{z:u.o(((...e)=>n.centerOnUser&&n.centerOnUser(...e))),A:u.o(((...e)=>n.zoomIn&&n.zoomIn(...e))),B:u.o(((...e)=>n.zoomOut&&n.zoomOut(...e))),C:u.o(((...e)=>n.showAddMarkerForm&&n.showAddMarkerForm(...e))),D:u.o(((...e)=>n.navigateToPetIdentify&&n.navigateToPetIdentify(...e))),E:u.t(e.showMarkers?"隐藏标记":"显示标记"),F:u.o(((...e)=>n.toggleMarkersVisibility&&n.toggleMarkersVisibility(...e))),G:u.o(((...e)=>n.navigateToAIMedical&&n.navigateToAIMedical(...e))),H:u.t(n.isWalking?"⏹️":"▶️"),I:u.t(n.isWalking?"停止":"开始"),J:n.isWalking?1:"",K:u.o(((...e)=>n.toggleWalkingMode&&n.toggleWalkingMode(...e))),L:u.o(((...e)=>n.refreshMap&&n.refreshMap(...e))),M:n.isWalking},n.isWalking?{N:u.t((n.walkingDistance/1e3).toFixed(2)),O:u.t(n.formatDuration(n.walkingDuration)),P:u.t(n.calculatePace(n.walkingDistance,n.walkingDuration))}:{},{Q:n.showUserPopup},n.showUserPopup?{R:u.o(n.closeUserPopup),S:u.o(n.messageUser),T:u.o(n.followUser),U:u.p({user:n.selectedUser,pets:n.selectedUserPets,"is-following":n.isFollowing,visible:n.showUserPopup})}:{},{V:n.showWalkSummary},n.showWalkSummary?{W:u.o(n.closeWalkSummary),X:u.o(n.shareWalkRecord),Y:u.p({duration:n.walkingDuration,distance:n.walkingDistance,pets:n.myPets,"selected-pet-index":n.selectedPetIndex,"share-content":n.walkShareContent})}:{},{Z:n.showCustomMarkerPopup},n.showCustomMarkerPopup?u.e({aa:u.o((e=>n.showCustomMarkerPopup=!1)),ab:u.t((null==(i=n.selectedMarker)?void 0:i.title)||"未命名标记"),ac:u.o((e=>n.showCustomMarkerPopup=!1)),ad:u.t(n.getMarkerTypeIcon(null==(s=n.selectedMarker)?void 0:s.type)),ae:n.getMarkerColor(null==(c=n.selectedMarker)?void 0:c.type),af:u.t(n.getMarkerTypeName(null==(d=n.selectedMarker)?void 0:d.type)),ag:u.t((null==(g=n.selectedMarker)?void 0:g.description)||"暂无描述内容"),ah:null==(v=n.selectedMarker)?void 0:v.radius},(null==(h=n.selectedMarker)?void 0:h.radius)?{ai:u.t(n.selectedMarker.radius<100?n.selectedMarker.radius+"公里 ("+(1e3*n.selectedMarker.radius).toFixed(0)+"米)":n.selectedMarker.radius+"米")}:{},{aj:null==(f=n.selectedMarker)?void 0:f.createdAt},(null==(m=n.selectedMarker)?void 0:m.createdAt)?{ak:u.t(n.formatTime(n.selectedMarker.createdAt))}:{},{al:(null==(p=n.selectedMarker)?void 0:p.user)&&"string"!=typeof n.selectedMarker.user},(null==(w=n.selectedMarker)?void 0:w.user)&&"string"!=typeof n.selectedMarker.user?{am:u.t(n.getUserName(n.selectedMarker.user))}:{},{an:u.o((e=>n.showCustomMarkerPopup=!1)),ao:u.o((e=>n.navigateToMarker(n.selectedMarker)))}):{})}]]);wx.createPage(y);
