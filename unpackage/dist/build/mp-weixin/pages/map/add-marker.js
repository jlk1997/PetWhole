"use strict";var e=(e,t,a)=>new Promise(((o,i)=>{var r=e=>{try{n(a.next(e))}catch(t){i(t)}},l=e=>{try{n(a.throw(e))}catch(t){i(t)}},n=e=>e.done?o(e.value):Promise.resolve(e.value).then(r,l);n((a=a.apply(e,t)).next())}));const t=require("../../common/vendor.js"),a=require("../../store/user.js"),o=require("../../store/pet.js"),i=require("../../stores/markerStore.js");require("../../config/index.js");const r=require("../../static/images/marker-icons.js"),l={setup(){a.useUserStore();const l=o.usePetStore(),n=i.useMarkerStore(),s=t.reactive({title:"",description:"",type:"general",customTypeName:"",color:"#FF5733",isPublic:!0,latitude:39.9087,longitude:116.3975,radius:1,pet:null,images:[]}),c=t.ref([]);t.onMounted((()=>e(this,null,(function*(){try{const e=yield(()=>{const e=getCurrentPages(),a=e[e.length-1].options||{};let o={latitude:39.9087,longitude:116.3975};return a.latitude&&a.longitude?{latitude:parseFloat(a.latitude),longitude:parseFloat(a.longitude)}:new Promise((e=>{t.index.getLocation({type:"gcj02",success:t=>{console.log("获取当前位置成功:",t),e({latitude:t.latitude,longitude:t.longitude})},fail:t=>{console.error("获取当前位置失败:",t),e(o)}})}))})();s.latitude=e.latitude,s.longitude=e.longitude,h(),setTimeout((()=>{const e=t.index.createMapContext("marker-preview-map");e&&e.moveToLocation({latitude:s.latitude,longitude:s.longitude})}),500)}catch(e){console.error("初始化位置失败:",e)}}))));const d=[{value:"general",label:"一般标记",icon:r.markerIconsBase64.general||"/static/images/marker.png",color:r.markerColors.general},{value:"pet_friendly",label:"宠物友好",icon:r.markerIconsBase64.pet_friendly||"/static/images/pet-marker.png",color:r.markerColors.pet_friendly},{value:"danger",label:"危险区域",icon:r.markerIconsBase64.danger||"/static/images/danger-marker.png",color:r.markerColors.danger},{value:"scenic",label:"风景优美",icon:r.markerIconsBase64.scenic||"/static/images/park-marker.png",color:r.markerColors.scenic},{value:"pet_service",label:"宠物服务",icon:r.markerIconsBase64.pet_service||"/static/images/shop-marker.png",color:r.markerColors.pet_service},{value:"custom",label:"自定义",icon:r.markerIconsBase64.custom||"/static/images/marker.png",color:r.markerColors.custom}],u=()=>{const e=d.find((e=>e.value===s.type));return e?e.icon:"/static/images/marker.png"},m=t.computed((()=>[{id:1,latitude:s.latitude,longitude:s.longitude,iconPath:u()||"/static/images/marker.png",width:40,height:40,anchor:{x:.5,y:1},callout:{content:"长按可拖动",color:"#000000",fontSize:12,borderRadius:4,padding:5,display:"ALWAYS"},draggable:!0}])),g=t.computed((()=>({latitude:s.latitude,longitude:s.longitude,color:s.color+"33",fillColor:s.color+"33",radius:1e3*s.radius,strokeWidth:2,strokeColor:s.color}))),p=t.ref([]),h=()=>e(this,null,(function*(){const e=yield l.fetchPets();p.value=e})),k=(e,a)=>{console.log("更新标记位置:",e,a),s.latitude=e,s.longitude=a,setTimeout((()=>{const o=t.index.createMapContext("marker-preview-map");o&&o.moveToLocation({latitude:e,longitude:a})}),100),t.index.showToast({title:"位置已更新",icon:"success",duration:1500})},f=()=>{t.index.showToast({title:"无法确定位置，请尝试拖动标记",icon:"none",duration:2e3})},y=e=>e*(Math.PI/180);function v(e){console.log("选择图片：",e);const t=e.tempFilePaths.map(((t,a)=>({url:t,file:t,caption:"",name:e.tempFiles[a].name||`图片${s.images.length+a+1}`})));s.images.push(...t)}return{markerData:s,markerTypes:d,colorOptions:["#FF5733","#33FF57","#3357FF","#FF33F5","#F5FF33","#33FFF5"],markers:m,mapCircle:g,myPets:p,imageFiles:c,getSelectedTypeLabel:()=>{if("custom"===s.type&&s.customTypeName)return`自定义: ${s.customTypeName}`;const e=d.find((e=>e.value===s.type));return e?e.label:"请选择标记类型"},getSelectedTypeIcon:u,getSelectedPetName:()=>{if(!s.pet)return"请选择关联宠物";const e=p.value.find((e=>e._id===s.pet));return e?e.name:"请选择关联宠物"},selectMarkerType:e=>{s.type=e,"custom"!==s.type&&(s.customTypeName="")},handlePetChange:e=>{const t=e.detail.value;s.pet=p.value[t]._id},handleRadiusChange:e=>{s.radius=parseFloat(parseFloat(e.detail.value).toFixed(2))},handleImageSelect:v,handleImageDelete:function(e){console.log("删除图片：",e)},removeImage:function(e){s.images.splice(e,1)},previewImage:function(e){const a=s.images.map((e=>e.url));t.index.previewImage({urls:a,current:e})},selectColor:e=>{s.color=e},togglePublic:()=>{s.isPublic=!s.isPublic},handleMapTap:e=>{if(console.log("地图点击原始事件:",e),e&&e.detail&&(console.log("点击详情:",e.detail),"number"==typeof e.detail.x&&"number"==typeof e.detail.y)){const a=t.index.createMapContext("marker-preview-map");if(a&&"function"==typeof a.fromScreenLocation)return void a.fromScreenLocation({x:e.detail.x,y:e.detail.y,success:e=>{k(e.latitude,e.longitude)},fail:e=>{console.error("坐标转换失败:",e),f()}})}let a,o;e.detail&&"number"==typeof e.detail.latitude&&"number"==typeof e.detail.longitude?(a=e.detail.latitude,o=e.detail.longitude):"number"==typeof e.latitude&&"number"==typeof e.longitude?(a=e.latitude,o=e.longitude):e.target&&"number"==typeof e.target.latitude&&"number"==typeof e.target.longitude?(a=e.target.latitude,o=e.target.longitude):e.detail&&e.detail.target&&"number"==typeof e.detail.target.latitude&&"number"==typeof e.detail.target.longitude&&(a=e.detail.target.latitude,o=e.detail.target.longitude),a&&o?k(a,o):setTimeout((()=>{const e=t.index.createMapContext("marker-preview-map");e&&"function"==typeof e.getCenterLocation?e.getCenterLocation({success:e=>{e.latitude&&e.longitude&&(k(e.latitude,e.longitude),t.index.showToast({title:"已使用地图中心位置",icon:"none",duration:1500}))}}):f()}),100)},handleMarkerDrag:e=>{if(console.log("标记拖动事件:",e),e.detail&&"number"==typeof e.detail.latitude&&"number"==typeof e.detail.longitude)k(e.detail.latitude,e.detail.longitude);else if(1===e.markerId){let t,a;e.latitude&&e.longitude?(t=e.latitude,a=e.longitude):e.target&&e.target.latitude&&e.target.longitude&&(t=e.target.latitude,a=e.target.longitude),t&&a&&k(t,a)}},moveToMarker:()=>{t.index.createMapContext("marker-preview-map").moveToLocation({latitude:s.latitude,longitude:s.longitude,success:()=>{t.index.showToast({title:"已定位到标记",icon:"success",duration:1500})}})},submitMarker:()=>e(this,null,(function*(){var e,a;if(!s.title)return void t.index.showToast({title:"请输入标记标题",icon:"none"});if("custom"===s.type&&!s.customTypeName.trim())return void t.index.showToast({title:"请输入自定义类型名称",icon:"none"});try{if("none"===(yield new Promise(((e,a)=>{t.index.getNetworkType({success:t=>e(t.networkType),fail:e=>a(e)})}))))return void t.index.showModal({title:"网络错误",content:"您当前无网络连接，无法保存标记。请检查网络设置后重试。",showCancel:!1})}catch(r){console.error("获取网络状态失败:",r)}let o=[];if(s.images&&s.images.length>0)try{t.index.showLoading({title:"正在上传图片...",mask:!0});for(let e=0;e<s.images.length;e++){const a=s.images[e];if(!a.url||a.file){if(t.index.showLoading({title:`上传图片 ${e+1}/${s.images.length}`,mask:!0}),!a.file)throw console.error(`图片 ${e+1} 文件路径不存在`),new Error(`图片 ${e+1} 文件路径不存在`);console.log(`准备上传图片 ${e+1}:`,a.file);try{let i=null;if(i=yield new Promise(((o,i)=>{t.index.uploadFile({url:"/api/markers/upload-fallback",filePath:a.file,name:"image",formData:{type:s.type||"default"},success:e=>{if(200===e.statusCode)try{const t=JSON.parse(e.data);o(t)}catch(t){i(new Error("解析响应数据失败"))}else i(new Error(`上传失败，状态码: ${e.statusCode}`))},fail:e=>{i(new Error(`备用上传失败: ${e.errMsg||"未知错误"}`))}}).onProgressUpdate((t=>{console.log(`上传进度 ${e+1}/${s.images.length}: ${t.progress}%`)}))})),!i||!i.success)throw new Error((null==i?void 0:i.message)||"上传失败");o.push({url:i.url,caption:a.caption||""}),console.log(`图片 ${e+1} 上传成功:`,i)}catch(l){throw console.error(`图片 ${e+1} 上传失败:`,l),new Error(`图片 ${e+1} 上传失败: ${l.message}`)}}else o.push({url:a.url,caption:a.caption||""})}console.log("所有图片上传完成:",o)}catch(r){return console.error("图片上传失败:",r),t.index.hideLoading(),void t.index.showModal({title:"图片上传失败",content:r.message||"上传图片时出错，请重试",showCancel:!1})}const i={title:s.title,description:s.description,type:s.type,icon:u(),color:s.color,longitude:s.longitude,latitude:s.latitude,radius:parseFloat(parseFloat(s.radius).toFixed(2)),isPublic:s.isPublic,properties:{},images:o};console.log("准备保存标记数据:",i),console.log("覆盖半径值 (km):",i.radius),"custom"===s.type&&(i.properties.customTypeName=s.customTypeName.trim()),s.pet&&(i.pet=s.pet),console.log("准备保存标记数据:",i);try{t.index.showLoading({title:"正在保存...",mask:!0});const e=yield n.createMarker(i);t.index.hideLoading(),e?(console.log("标记保存成功，数据:",e),e.data&&e.data._id?(t.index.$emit("marker-created",{marker:e.data,timestamp:Date.now()}),setTimeout((()=>{t.index.navigateBack({delta:1,success:()=>{t.index.$emit("refresh-map",{timestamp:Date.now()})}})}),1500)):(t.index.showToast({title:"标记保存成功",icon:"success"}),setTimeout((()=>{t.index.navigateBack({delta:1})}),1500))):t.index.showModal({title:"保存失败",content:"标记数据保存失败，请重试。如果问题持续，请联系客服。",showCancel:!1})}catch(r){t.index.hideLoading(),console.error("保存标记时出错:",r);const o=(null==(a=null==(e=r.response)?void 0:e.data)?void 0:a.message)||r.message||"保存失败，请检查网络连接后重试";t.index.showModal({title:"保存失败",content:o,showCancel:!1})}})),calculateDistance:(e,t,a,o)=>{if(!(e&&t&&a&&o))return 0;const i=y(a-e),r=y(o-t),l=Math.sin(i/2)*Math.sin(i/2)+Math.cos(y(e))*Math.cos(y(a))*Math.sin(r/2)*Math.sin(r/2);return 6371*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))},deg2rad:y,cancel:()=>{t.index.navigateBack()},openFilePicker:function(){t.index.chooseImage({count:9-s.images.length,sizeType:["original","compressed"],sourceType:["album","camera"],success:e=>{v({tempFilePaths:e.tempFilePaths,tempFiles:e.tempFiles})},fail:e=>{console.error("选择图片失败:",e),t.index.showToast({title:"选择图片失败",icon:"none"})}})}}}};if(!Array){(t.resolveComponent("uni-icons")+t.resolveComponent("uni-file-picker"))()}const n=t._export_sfc(l,[["render",function(e,a,o,i,r,l){return t.e({a:i.markerData.title,b:t.o((e=>i.markerData.title=e.detail.value)),c:i.markerData.description,d:t.o((e=>i.markerData.description=e.detail.value)),e:0===i.markerData.images.length},0===i.markerData.images.length?{f:t.p({type:"camera-filled",size:"24",color:"#007AFF"}),g:t.o(((...e)=>i.openFilePicker&&i.openFilePicker(...e)))}:{},{h:t.sr("filePicker","398ef52c-1"),i:t.o(i.handleImageSelect),j:t.o(i.handleImageDelete),k:t.o((e=>i.imageFiles=e)),l:t.p({fileMediatype:"image",mode:"grid",limit:9,modelValue:i.imageFiles}),m:i.markerData.images&&i.markerData.images.length>0},i.markerData.images&&i.markerData.images.length>0?t.e({n:t.f(i.markerData.images,((e,a,o)=>({a:e.url,b:t.o((e=>i.previewImage(a)),a),c:e.caption,d:t.o((t=>e.caption=t.detail.value),a),e:"398ef52c-2-"+o,f:t.o((e=>i.removeImage(a)),a),g:a}))),o:t.p({type:"trash",size:"18"}),p:i.markerData.images.length<9},i.markerData.images.length<9?{q:t.p({type:"plus",size:"20",color:"#007AFF"}),r:t.o(((...e)=>i.openFilePicker&&i.openFilePicker(...e)))}:{}):{},{s:t.f(i.markerTypes,((e,a,o)=>t.e({a:!e.icon.startsWith("data:")},e.icon.startsWith("data:")?{c:e.icon}:{b:e.icon},{d:e.color||"#007AFF",e:t.t(e.label),f:a,g:i.markerData.type===e.value?1:"",h:t.o((t=>i.selectMarkerType(e.value)),a)}))),t:"custom"===i.markerData.type},"custom"===i.markerData.type?{v:i.markerData.customTypeName,w:t.o((e=>i.markerData.customTypeName=e.detail.value))}:{},{x:t.f(i.colorOptions,((e,a,o)=>({a:a,b:e,c:i.markerData.color===e?1:"",d:t.o((t=>i.selectColor(e)),a)}))),y:i.markerData.radius,z:t.o(((...e)=>i.handleRadiusChange&&i.handleRadiusChange(...e))),A:t.t(i.markerData.radius),B:i.markerData.isPublic,C:t.o(((...e)=>i.togglePublic&&i.togglePublic(...e))),D:i.myPets.length>0},i.myPets.length>0?{E:t.t(i.getSelectedPetName()),F:i.myPets,G:t.o(((...e)=>i.handlePetChange&&i.handlePetChange(...e)))}:{},{H:t.t(i.markerData.longitude.toFixed(6)),I:t.t(i.markerData.latitude.toFixed(6)),J:i.markerData.latitude,K:i.markerData.longitude,L:i.markers,M:[i.mapCircle],N:t.o(((...e)=>i.handleMapTap&&i.handleMapTap(...e))),O:t.o(((...e)=>i.handleMarkerDrag&&i.handleMarkerDrag(...e))),P:t.o(((...e)=>i.moveToMarker&&i.moveToMarker(...e))),Q:t.o(((...e)=>i.cancel&&i.cancel(...e))),R:t.o(((...e)=>i.submitMarker&&i.submitMarker(...e)))})}]]);wx.createPage(n);
