"use strict";var e=(e,r,a)=>new Promise(((t,s)=>{var o=e=>{try{l(a.next(e))}catch(r){s(r)}},n=e=>{try{l(a.throw(e))}catch(r){s(r)}},l=e=>e.done?t(e.value):Promise.resolve(e.value).then(o,n);l((a=a.apply(e,r)).next())}));const r=require("../../common/vendor.js"),a=require("../../stores/markerStore.js"),t=require("../../store/user.js"),s={setup(){const s=r.ref({}),o=a.useMarkerStore(),n=t.useUserStore(),l=r.ref(!1),u=r.ref(null),i=r.ref(0),g=r.ref(0),c=r.computed((()=>s.value.images&&s.value.images.length>0?2:1));r.onMounted((()=>e(this,null,(function*(){var e;try{console.log("页面加载，准备获取标记详情");const r=getCurrentPages(),a=r[r.length-1],t=null==(e=null==a?void 0:a.options)?void 0:e.id;if(!t)throw new Error("没有指定标记ID");console.log("开始获取标记详情，标记ID:",t);const n=o.selectedMarker;n&&n._id===t?(console.log("从store获取标记数据"),s.value=n,console.log("标记数据:",JSON.stringify(s.value,null,2)),s.value.user?"string"==typeof s.value.user?(console.log("用户信息只有ID，需要获取详情:",s.value.user),yield v(s.value.user)):console.log("已有完整用户信息:",s.value.user):console.log("标记没有用户信息")):(console.log("从API获取标记详情"),yield m(t))}catch(a){console.error("标记详情页面初始化失败:",a),r.index.showToast({title:"获取标记信息失败",icon:"none"})}}))));const m=a=>new Promise(((t,o)=>{console.log("从API获取标记，ID:",a),r.index.request({url:`/api/markers/${a}`,method:"GET",header:{Authorization:`Bearer ${n.token}`},success:r=>e(this,null,(function*(){var e;try{if(200===r.statusCode&&r.data)r.data.success&&r.data.data?s.value=r.data.data:s.value=r.data,console.log("标记数据获取成功:",s.value),s.value.user&&"string"==typeof s.value.user?(console.log("需要获取用户详情，用户ID:",s.value.user),yield v(s.value.user)):s.value.user?console.log("标记包含完整用户信息:",s.value.user):console.log("标记没有用户信息"),t(s.value);else{const a=(null==(e=r.data)?void 0:e.message)||"获取标记失败";console.error("API响应错误:",a),o(new Error(a))}}catch(a){console.error("处理API响应时出错:",a),o(a)}})),fail:e=>{console.error("API请求失败:",e),o(e)}})})),v=a=>e(this,null,(function*(){l.value=!0,u.value=null;try{return console.log("开始获取用户信息，ID:",a),new Promise(((e,t)=>{r.index.request({url:`/api/users/${a}`,method:"GET",header:{Authorization:`Bearer ${n.token}`},success:r=>{var t;if(200===r.statusCode&&r.data)s.value.user=r.data,console.log("用户信息获取成功:",s.value.user),e(s.value.user);else{const o=(null==(t=r.data)?void 0:t.message)||"获取用户信息失败";console.error("获取用户信息API响应错误:",o),u.value=new Error(o),s.value.user={username:"用户"+a.substr(-4),nickname:"未知用户"},e(null)}},fail:r=>{console.error("获取用户信息请求失败:",r),u.value=r,s.value.user={username:"用户"+a.substr(-4),nickname:"未知用户"},e(null)},complete:()=>{l.value=!1}})}))}catch(e){return console.error("获取用户信息处理失败:",e),u.value=e,l.value=!1,s.value.user={username:a?"用户"+a.substr(-4):"未知用户",nickname:"未知用户"},null}})),d=e=>{if(!e)return"/static/images/default-avatar.png";if(e.startsWith("http://")||e.startsWith("https://"))return e;try{let a=r.index.getStorageSync("BASE_URL")||"http://49.235.65.37:5000";return e.startsWith("/")?a+e:e.startsWith("static/")?"/"+e:a+"/"+e}catch(a){return console.error("URL处理错误:",a,e),e.startsWith("/")?e:"/"+e}},h=e=>{if(!e)return"/static/images/default-cover.jpg";try{return e.startsWith("http://")||e.startsWith("https://")?e:d(e)}catch(r){return console.error("图片URL处理错误:",r,e),"/static/images/default-cover.jpg"}};return{marker:s,isLoadingUser:l,userError:u,currentPage:i,currentPhotoIndex:g,totalPages:c,getMarkerTypeName:e=>({general:"普通标记",pet_friendly:"宠物友好",danger:"危险区域",scenic:"风景区",pet_service:"宠物服务",custom:"自定义"}[e]||"未知类型"),formatTime:e=>{if(!e)return"未知时间";const r=new Date(e);return`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}-${String(r.getDate()).padStart(2,"0")} ${String(r.getHours()).padStart(2,"0")}:${String(r.getMinutes()).padStart(2,"0")}`},getImageUrl:h,getUserAvatar:e=>{if(!e)return"/static/images/default-avatar.png";if("string"==typeof e)return"/static/images/default-avatar.png";const r=e.avatar||"/static/images/default-avatar.png";return d(r)},getUserName:e=>e?"string"==typeof e?"用户"+e.substr(-4):e.nickname||e.username||"未知用户":"未知用户",previewImage:e=>{if(!s.value.images||0===s.value.images.length)return;const a=s.value.images.map((e=>h(e.url)));r.index.previewImage({urls:a,current:e})},goBack:()=>{r.index.navigateBack()},navigateToMarker:()=>{const e=getCurrentPages(),a=e[e.length-2];a&&a.$vm&&a.$vm.navigateToLocation?(a.$vm.navigateToLocation(s.value),setTimeout((()=>{r.index.navigateBack()}),500)):(r.index.setStorageSync("navigate_to_marker",s.value),r.index.navigateBack())},onPageChange:e=>{i.value=e.detail.current},onPhotoChange:e=>{g.value=e.detail.current},goToPage:e=>{i.value=e}}}};const o=r._export_sfc(s,[["render",function(e,a,t,s,o,n){return r.e({a:r.o(((...e)=>s.goBack&&s.goBack(...e))),b:s.marker.images&&s.marker.images.length>0?s.getImageUrl(s.marker.images[0].url):"/static/images/default-cover.jpg",c:r.t(s.marker.title||"未命名标记"),d:s.isLoadingUser},s.isLoadingUser?{}:{e:s.getUserAvatar(s.marker.user),f:r.t(s.getUserName(s.marker.user))},{g:r.t(s.formatTime(s.marker.createdAt)),h:r.t(s.getMarkerTypeName(s.marker.type)),i:r.t(s.marker.description||"暂无描述内容"),j:r.t(s.getMarkerTypeName(s.marker.type)),k:s.marker.radius},s.marker.radius?{l:r.t(s.marker.radius)}:{},{m:r.t(s.formatTime(s.marker.createdAt)),n:!s.isLoadingUser},s.isLoadingUser?{}:{o:r.t(s.getUserName(s.marker.user))},{p:s.marker.images&&s.marker.images.length>0},(s.marker.images&&s.marker.images.length,{}),{q:s.marker.images&&s.marker.images.length>0},s.marker.images&&s.marker.images.length>0?{r:r.f(s.marker.images,((e,a,t)=>({a:s.getImageUrl(e.url),b:r.t(e.caption||"无描述"),c:r.t(a+1),d:a,e:r.o((e=>s.previewImage(a)),a)}))),s:r.t(s.marker.images.length),t:s.currentPhotoIndex,v:r.o(((...e)=>s.onPhotoChange&&s.onPhotoChange(...e)))}:{},{w:s.currentPage,x:r.o(((...e)=>s.onPageChange&&s.onPageChange(...e))),y:r.f(s.totalPages,((e,a,t)=>({a:a,b:s.currentPage===a?1:"",c:r.o((e=>s.goToPage(a)),a)}))),z:r.o(((...e)=>s.navigateToMarker&&s.navigateToMarker(...e)))})}],["__scopeId","data-v-03245c0e"]]);wx.createPage(o);
