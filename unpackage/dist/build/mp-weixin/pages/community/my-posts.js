"use strict";var e=Object.defineProperty,t=Object.defineProperties,o=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,r=(t,o,n)=>o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[o]=n,s=(e,t,o)=>new Promise(((n,i)=>{var a=e=>{try{s(o.next(e))}catch(t){i(t)}},r=e=>{try{s(o.throw(e))}catch(t){i(t)}},s=e=>e.done?n(e.value):Promise.resolve(e.value).then(a,r);s((o=o.apply(e,t)).next())}));const l=require("../../common/vendor.js"),c=require("../../utils/ui.js"),d=require("../../store/user.js"),u=require("../../common/assets.js"),g={components:{WalkRecordCard:()=>"../../components/WalkRecordCard.js",ImageViewer:()=>"../../components/ImageViewer.js"},setup(){var e;const u=d.useUserStore(),g=l.ref([]),m=l.ref(!1),f=l.ref(1),h=l.ref(!0),p=null==(e=l.index.$api)?void 0:e.community,v=l.ref(!1),w=l.ref(0),y=l.ref(null);function k(e=!1){return s(this,null,(function*(){var t;if(!m.value&&(e&&(f.value=1,h.value=!0),h.value||e)){m.value=!0;try{console.log("尝试获取我的帖子，页码:",f.value,"每页数量:",10);const o=yield l.index.$api.community.getMyPosts({page:f.value,limit:10});if(!o||!o.data)return console.warn("获取我的帖子响应格式不正确:",o),e&&(g.value=[]),h.value=!1,void(e&&l.index.stopPullDownRefresh());console.log("获取我的帖子成功，数据:",o.data),g.value=e?(o.data||[]).map((e=>D(e))):[...g.value,...(o.data||[]).map((e=>D(e)))],h.value=10===(null==(t=o.data)?void 0:t.length),f.value++,e&&l.index.stopPullDownRefresh()}catch(o){console.error("获取我的动态失败:",o);const t=o.message||"未知错误",n=o.statusCode||"未知状态码";c.showToast({title:`获取动态失败 (${n}): ${t}`,icon:"none"}),(e||0===g.value.length)&&(g.value=[]),h.value=!1,e&&l.index.stopPullDownRefresh()}finally{m.value=!1}}}))}function P(e){return s(this,null,(function*(){m.value=!0;try{console.log("尝试删除帖子，ID:",e),yield l.index.$api.community.deletePost(e),g.value=g.value.filter((t=>t.id!==e&&t._id!==e)),c.showToast({title:"动态已删除",icon:"success"})}catch(t){console.error("删除动态失败:",t);const e=t.message||"未知错误",o=t.statusCode||"未知状态码";c.showToast({title:`删除失败 (${o}): ${e}`,icon:"none",duration:3e3}),404===t.statusCode&&(console.log("帖子可能已被删除，尝试刷新列表"),setTimeout((()=>{k(!0)}),1500))}finally{m.value=!1}}))}function D(e){if(e.walkRecord)return e;const s=e.content||"";let l=null;const c=s.match(/遛了\s*(\d+\.?\d*)\s*公里/),d=c?1e3*parseFloat(c[1]):null,u=s.match(/用时\s*(\d+)\s*(秒|分钟|小时)/);let g=null;if(u){const e=parseInt(u[1]),t=u[2];"秒"===t?g=e:"分钟"===t?g=60*e:"小时"===t&&(g=3600*e)}const m=s.match(/和\s*([^\s,，。！]+)\s*一起遛/),f=m?m[1]:"我的宠物";return null!==d||null!==g?(l={_id:`generated_${e._id||e.id||Date.now()}`,distance:d||0,duration:g||0,pet:{name:f},startTime:e.createdAt||e.time||(new Date).toISOString()},h=((e,t)=>{for(var o in t||(t={}))i.call(t,o)&&r(e,o,t[o]);if(n)for(var o of n(t))a.call(t,o)&&r(e,o,t[o]);return e})({},e),t(h,o({walkRecord:l}))):e;var h}return{posts:g,isLoading:m,hasMore:h,userStore:u,formatDate:function(e){if(!e)return"";const t=new Date(e),o=new Date;if(o-t<864e5&&t.getDate()===o.getDate()){const e=t.getHours(),o=t.getMinutes();return`今天 ${e.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`}const n=new Date(o);if(n.setDate(n.getDate()-1),t.getDate()===n.getDate()&&t.getMonth()===n.getMonth()&&t.getFullYear()===n.getFullYear()){const e=t.getHours(),o=t.getMinutes();return`昨天 ${e.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`}return`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")}`},formatImageUrl:function(e){if(!e)return"/static/images/default-pet.png";if(console.log("我的帖子页面处理图片URL:",e),e.startsWith("http")||e.startsWith("/static")||e.startsWith("blob:"))return e;if(e.startsWith("/uploads")){const t=l.index.getStorageSync("BASE_URL")||"http://49.235.65.37:5000",o=t+e;return console.log("处理相对路径图片URL:",e,"补充基础URL:",t,"完整URL:",o),o}return console.warn("未能识别的图片URL格式:",e),"/static/images/default-pet.png"},loadPosts:k,viewPostDetail:function(e){if(console.log("查看帖子详情:",e),!e||!e.id&&!e._id)return void l.index.showToast({title:"帖子数据无效",icon:"none"});const t=e.id||e._id;try{const o=`post_cache_${t}_${Date.now()}`;l.index.setStorageSync(o,JSON.stringify(e)),c.navigateTo(`/pages/community/post-detail?id=${t}&postKey=${o}`)}catch(o){console.error("保存帖子数据到缓存失败:",o),c.navigateTo(`/pages/community/post-detail?id=${t}`)}},previewImage:function(e,t){y.value=e,w.value=t,v.value=!0},editPost:function(e){if(!e||!e.id&&!e._id)return void l.index.showToast({title:"无法编辑，帖子数据无效",icon:"none"});const t=e.id||e._id;try{const o=`post_cache_${t}_${Date.now()}`;l.index.setStorageSync(o,JSON.stringify(e)),c.navigateTo(`/pages/community/create?id=${t}&mode=edit&postKey=${o}`)}catch(o){console.error("缓存帖子数据失败:",o),c.navigateTo(`/pages/community/create?id=${t}&mode=edit`)}},confirmDelete:function(e){c.showModal({title:"删除动态",content:"确定要删除这条动态吗？此操作不可恢复。",showCancel:!0}).then((t=>s(this,null,(function*(){t&&(yield P(e))}))))},deletePost:P,createPost:function(){c.navigateTo("/pages/community/create")},checkLoginAndLoadData:function(){if(!u.isAuthenticated)return c.showToast({title:"请先登录",icon:"none"}),void setTimeout((()=>{c.navigateTo("/pages/login/login")}),1500);k()},formatDuration:function(e){if(!e)return"0分钟";const t=Math.floor(e/3600),o=Math.floor(e%3600/60);let n="";return t>0?(n+=`${t}小时`,o>0&&(n+=`${o}分钟`)):n+=`${o}分钟`,n},viewWalkRecord:function(e){if(!e.walkRecord||!e.walkRecord._id)return void l.index.showToast({title:"遛狗记录不存在",icon:"none"});console.log("查看遛狗记录详情:",e.walkRecord),e.walkRecord._id.startsWith("generated_")?l.index.showToast({title:"这是从动态内容解析的遛狗记录，无法查看详情",icon:"none",duration:2500}):l.index.navigateTo({url:`/pages/walk/detail?id=${e.walkRecord._id}`,fail:e=>{console.error("打开遛狗记录详情失败:",e),l.index.showToast({title:"无法查看遛狗记录",icon:"none"})}})},getNumberValue:function(e){return Array.isArray(e)?e.length:"number"==typeof e?e:e&&"object"==typeof e?Object.keys(e).length:0},truncateText:function(e,t){return e?e.length<=t?e:e.substring(0,t)+"...":""},likePost:function(e,t){return s(this,null,(function*(){if(t.stopPropagation(),console.log("点赞帖子:",e),!e||!e.id&&!e._id)return console.error("无效的帖子ID"),void c.showToast({title:"无法点赞",icon:"none"});const o=e.id||e._id;void 0===e.isLiked&&(e.isLiked=!1),void 0===e.likes&&(e.likes=0);const n=e.isLiked;e.isLiked=!n,e.likes=n?Math.max((e.likes||1)-1,0):(e.likes||0)+1;try{if(!p)throw new Error("社区API未初始化");const t=yield p.likePost(o,!n);console.log("点赞/取消点赞成功:",t),t&&t.data&&void 0!==t.data.likes&&(e.likes=t.data.likes,e.isLiked=t.data.isLiked)}catch(i){console.error("点赞/取消点赞失败:",i),e.isLiked=n,e.likes=n?(e.likes||0)+1:Math.max((e.likes||1)-1,0),c.showToast({title:"操作失败，请重试",icon:"none"})}}))},closeImageViewer:function(){v.value=!1},showImageViewer:v,currentImageIndex:w,currentPost:y}},onLoad(){this.checkLoginAndLoadData()},onPullDownRefresh(){this.loadPosts(!0)},onReachBottom(){this.hasMore&&!this.isLoading&&this.loadPosts()}};if(!Array){(l.resolveComponent("walk-record-card")+l.resolveComponent("image-viewer"))()}const m=l._export_sfc(g,[["render",function(e,t,o,n,i,a){var r;return l.e({a:n.posts.length>0},n.posts.length>0?{b:l.f(n.posts,((e,t,o)=>l.e({a:e.avatar||"/static/images/default-avatar.png",b:l.t(e.username||"匿名用户"),c:l.t(n.formatDate(e.createdAt||e.createTime)),d:l.t(n.truncateText(e.content,40)),e:e.walkRecord},e.walkRecord?{f:"74d43aea-0-"+o,g:l.p({record:e.walkRecord})}:{},{h:e.images&&e.images.length>0},e.images&&e.images.length>0?l.e({i:l.f(e.images.slice(0,3),((t,o,i)=>({a:o,b:n.formatImageUrl(t),c:l.o((t=>n.previewImage(e,o)),o)}))),j:e.images.length>3},e.images.length>3?{k:l.t(e.images.length-3)}:{}):{},{l:e.isLiked?1:"",m:l.t(n.getNumberValue(e.likes)),n:l.o((t=>n.likePost(e,t)),e.id||e._id),o:l.t(n.getNumberValue(e.comments)),p:l.o((t=>n.confirmDelete(e.id||e._id)),e.id||e._id),q:e.id||e._id,r:l.o((t=>n.viewPostDetail(e)),e.id||e._id)})))}:{c:u._imports_0$2,d:l.o(((...e)=>n.createPost&&n.createPost(...e)))},{e:n.isLoading},(n.isLoading,{}),{f:l.o(n.closeImageViewer),g:l.p({show:n.showImageViewer,images:(null==(r=n.currentPost)?void 0:r.images)||[],initialIndex:n.currentImageIndex})})}]]);wx.createPage(m);
