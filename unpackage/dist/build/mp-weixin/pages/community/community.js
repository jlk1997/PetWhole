"use strict";var e=Object.defineProperty,t=Object.defineProperties,o=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,n=(t,o,i)=>o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[o]=i,l=(e,t)=>{for(var o in t||(t={}))s.call(t,o)&&n(e,o,t[o]);if(i)for(var o of i(t))a.call(t,o)&&n(e,o,t[o]);return e},r=(e,i)=>t(e,o(i)),c=(e,t,o)=>new Promise(((i,s)=>{var a=e=>{try{l(o.next(e))}catch(t){s(t)}},n=e=>{try{l(o.throw(e))}catch(t){s(t)}},l=e=>e.done?i(e.value):Promise.resolve(e.value).then(a,n);l((o=o.apply(e,t)).next())}));const u=require("../../common/vendor.js"),d=require("../../store/user.js"),g=require("../../utils/api.js"),m={components:{WalkRecordCard:()=>"../../components/WalkRecordCard.js",ImageViewer:()=>"../../components/ImageViewer.js",UserInfoPopup:()=>"../../components/map/UserInfoPopup.js"},data:()=>({scrollHeight:0,navHeight:110}),setup(){const e=g.api.community,t=d.useUserStore(),o=u.ref(0),i=u.ref(!1),s=u.ref(!1),a=u.ref(0),n=u.ref(!1),m=u.ref(0),v=u.ref(null),h=u.ref([]),p=u.ref(!1),f=u.ref(null),w=u.ref([]),y=u.ref(!1),k=e=>e&&Array.isArray(e)?e.map((e=>(e=>{if(e.walkRecord)return e;const t=e.content||"";let o=null;const i=t.match(/遛了\s*(\d+\.?\d*)\s*公里/),s=i?1e3*parseFloat(i[1]):null,a=t.match(/用时\s*(\d+)\s*(秒|分钟|小时)/);let n=null;if(a){const e=parseInt(a[1]),t=a[2];"秒"===t?n=e:"分钟"===t?n=60*e:"小时"===t&&(n=3600*e)}const c=t.match(/和\s*([^\s,，。！]+)\s*一起遛/),u=c?c[1]:"我的宠物";return null!==s||null!==n?(o={_id:`generated_${e._id||e.id||Date.now()}`,distance:s||0,duration:n||0,pet:{name:u},startTime:e.createdAt||e.time||(new Date).toISOString()},r(l({},e),{walkRecord:o})):e})(e))):[],x=(t=!1)=>c(this,null,(function*(){if(!i.value){i.value=!0,t&&(h.value=[]);try{if(!e)return console.error("社区API未找到，显示默认数据"),void P();console.log("加载帖子类型:",0===o.value?"recommended":"following");const t=yield e.getPosts({type:0===o.value?"recommended":"following",limit:20});if(t&&(t.data||Array.isArray(t))){const e=t.data||t;e&&0!==e.length?(a.value=Date.now(),h.value=k(e)):0===o.value?P():h.value=[]}else 0===o.value?P():h.value=[]}catch(s){console.error("加载帖子失败",s),0===o.value?P():(h.value=[],u.index.showToast({title:"没有关注的内容",icon:"none"}))}finally{i.value=!1,u.index.stopPullDownRefresh()}}})),P=()=>{const e=[{id:1,username:"狗狗爱好者",userAvatar:"/static/images/default-avatar.png",time:"1小时前",content:"今天和汪汪出去玩，好开心！",likes:12,comments:3,images:["/static/images/default-pet.png"]},{id:2,username:"宠物达人",userAvatar:"/static/images/default-avatar.png",time:"2小时前",content:"分享一下我家狗狗的日常~",likes:24,comments:8,images:["/static/images/default-pet.png","/static/images/default-pet.png","/static/images/default-pet.png"],walkRecord:{_id:"default_walk_record_1",distance:3500,duration:1800,pet:{name:"小白"},startTime:(new Date).toISOString()}},{id:3,username:"jlk1997",userAvatar:"/static/images/default-avatar.png",time:"5分钟前",content:"我和dwqdw一起遛了0.00公里，用时5秒！ caca",likes:0,comments:0}];h.value=k(e)},T=e=>{if(!e)return"/static/images/default-avatar.png";if(e.startsWith("http")||e.startsWith("/static"))return e;if(e.startsWith("/uploads")){return(u.index.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}return"object"==typeof e&&e.avatar?T(e.avatar):"/static/images/default-avatar.png"};return{tabs:["推荐","关注"],currentTab:o,posts:h,isLoading:i,isRefreshing:s,lastPublishTime:a,formatDuration:e=>{if(!e)return"0分钟";const t=Math.floor(e/3600),o=Math.floor(e%3600/60);let i="";return t>0?(i+=`${t}小时`,o>0&&(i+=`${o}分钟`)):i+=`${o}分钟`,i},truncateText:(e,t)=>e?e.length<=t?e:e.substring(0,t)+"...":"",previewImage:(e,t)=>{v.value=e,m.value=t,n.value=!0},viewPostDetail:e=>{if(console.log("查看帖子详情:",e),!e||!e.id&&!e._id)return void u.index.showToast({title:"帖子数据无效",icon:"none"});const t=e.id||e._id;try{const o=`post_cache_${t}_${Date.now()}`;u.index.setStorageSync(o,JSON.stringify(e)),u.index.navigateTo({url:`/pages/community/post-detail?id=${t}&postKey=${o}`})}catch(o){console.error("保存帖子数据到缓存失败:",o),u.index.navigateTo({url:`/pages/community/post-detail?id=${t}`})}},formatDate:(e,t=!1)=>{if(!e)return"";if("string"==typeof e&&!e.includes("T")&&!e.includes("-"))return e;try{const t=new Date(e),o=new Date,i=Math.floor((o-t)/1e3);return i<60?"刚刚":i<3600?Math.floor(i/60)+"分钟前":i<86400?Math.floor(i/3600)+"小时前":i<2592e3?Math.floor(i/86400)+"天前":`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}catch(o){return console.error("日期格式化错误:",o),e}},switchTab:e=>{o.value!==e?(o.value=e,x(!0)):x(!0)},loadMore:()=>c(this,null,(function*(){if(!i.value){i.value=!0;try{if(!e)return void(i.value=!1);const t=h.value.length>0?h.value[h.value.length-1].id:null;console.log("加载更多，类型:",0===o.value?"recommended":"following","最后ID:",t);const s=yield e.getPosts({type:0===o.value?"recommended":"following",limit:10,lastId:t});s&&s.data&&s.data.length>0?h.value=[...h.value,...s.data]:u.index.showToast({title:"没有更多内容了",icon:"none"})}catch(t){console.error("加载更多帖子失败",t),u.index.showToast({title:"加载更多失败",icon:"none"})}finally{i.value=!1}}})),navToCreate:()=>{a.value=Date.now(),u.index.navigateTo({url:"/pages/community/create"})},likePost:(t,o)=>c(this,null,(function*(){if(console.log("Like post:",t,"Index:",o),!t||!t.id&&!t._id)return console.error("Invalid post ID for like action"),void u.index.showToast({title:"无法点赞",icon:"none"});const i=t.id||t._id;void 0===t.isLiked&&(t.isLiked=!1),void 0===t.likes&&(t.likes=0);const s=t.isLiked;t.isLiked=!s,t.likes=s?Math.max((t.likes||1)-1,0):(t.likes||0)+1;try{if(!e)throw new Error("社区API未初始化");const o=yield e.likePost(i,!s);console.log("Like/unlike success:",o),o&&o.data&&void 0!==o.data.likes&&(t.likes=o.data.likes,t.isLiked=o.data.isLiked)}catch(a){console.error("Like/unlike error:",a),t.isLiked=s,t.likes=s?(t.likes||0)+1:Math.max((t.likes||1)-1,0),u.index.showToast({title:"操作失败，请重试",icon:"none"})}})),viewComments:e=>{if(console.log("Viewing comments for post:",e),!e||!e.id&&!e._id)return console.error("Invalid post ID for comments view"),void u.index.showToast({title:"无法查看评论",icon:"none"});const t=e.id||e._id;try{const o=`post_cache_${t}_${Date.now()}`;u.index.setStorageSync(o,JSON.stringify(e)),u.index.navigateTo({url:`/pages/community/post-detail?id=${t}&postKey=${o}&showComments=true`})}catch(o){console.error("保存帖子数据到缓存失败:",o),u.index.navigateTo({url:`/pages/community/post-detail?id=${t}&showComments=true`})}},loadPosts:x,onRefresh:()=>{console.log("触发下拉刷新"),s.value=!0,x(!0).finally((()=>{setTimeout((()=>{s.value=!1}),300)}))},formatAvatarUrl:T,handleAvatarError:(e,t)=>{console.warn("头像加载失败:",e,"索引:",t),e.target.src="/static/images/default-avatar.png"},formatImageUrl:e=>{if(!e)return"/static/images/default-pet.png";if(console.log("社区页面处理图片URL:",e),e.startsWith("http")||e.startsWith("/static")||e.startsWith("blob:"))return e;if(e.startsWith("/uploads")){const t=u.index.getStorageSync("BASE_URL")||"http://49.235.65.37:5000",o=t+e;return console.log("处理相对路径图片URL:",e,"补充基础URL:",t,"完整URL:",o),o}return console.warn("未能识别的图片URL格式:",e),"/static/images/default-pet.png"},viewWalkRecord:e=>{if(!e.walkRecord||!e.walkRecord._id)return void u.index.showToast({title:"遛狗记录不存在",icon:"none"});console.log("查看遛狗记录详情:",e.walkRecord);e.walkRecord._id.startsWith("generated_")?u.index.showToast({title:"这是从动态内容解析的遛狗记录，无法查看详情",icon:"none",duration:2500}):u.index.navigateTo({url:`/pages/walk/detail?id=${e.walkRecord._id}`,fail:e=>{console.error("打开遛狗记录详情失败:",e),u.index.showToast({title:"无法查看遛狗记录",icon:"none"})}})},getNumberValue:e=>Array.isArray(e)?e.length:"number"==typeof e?e:e&&"object"==typeof e?Object.keys(e).length:0,showImageViewer:n,currentImageIndex:m,currentPost:v,closeImageViewer:()=>{n.value=!1},showUserPopup:p,selectedUser:f,selectedUserPets:w,isFollowing:y,showUserProfile:e=>c(this,null,(function*(){if(console.log("显示用户信息:",e),!e||!e._id)return console.error("无效的用户信息"),void u.index.showToast({title:"无法获取用户信息",icon:"none"});const o=t.isAuthenticated&&t.userId===e._id;if(f.value=r(l({},e),{isCurrentUser:o}),y.value=!1,t.isAuthenticated&&!o)try{console.log("直接调用checkFollowStatus检查关注状态，用户ID:",e._id);const t=yield g.api.user.checkFollowStatus(e._id);t&&void 0!==t.isFollowing&&(y.value=t.isFollowing,console.log("API返回的关注状态:",y.value))}catch(i){console.error("检查关注状态失败:",i),void 0!==e.isFollowing&&(y.value=e.isFollowing,console.log("从用户对象获取关注状态:",y.value))}if(console.log("初始关注状态设置为:",y.value),t.isAuthenticated)try{let t=null;try{console.log("尝试获取用户详情，ID:",e._id),t=yield g.api.user.getUserById(e._id),console.log("获取用户详情成功:",t),t&&void 0!==t.isFollowing&&(y.value=y.value||t.isFollowing,console.log("综合考虑后的关注状态:",y.value))}catch(s){console.error("获取用户详情失败, 使用基本信息:",s),t=r(l({},e),{nickname:e.nickname||e.username||"用户",bio:e.bio||"这位用户还没有个人简介"}),u.index.showToast({title:"获取用户详情失败",icon:"none",duration:1500})}if(t){o&&(y.value=!1),f.value=r(l({},t),{isCurrentUser:o,isFollowing:y.value}),console.log("更新后的selectedUser和isFollowing:",f.value,y.value);try{console.log("尝试获取用户宠物列表，用户ID:",e._id);const t=yield g.api.user.getPetsByUser(e._id);console.log("获取到的宠物列表:",t),w.value=t||[]}catch(a){console.error("获取宠物列表失败:",a),w.value=[]}}}catch(i){console.error("获取用户详情过程中出错:",i),f.value=r(l({},e),{isCurrentUser:o,isFollowing:y.value,nickname:e.nickname||e.username||"用户",bio:e.bio||"这位用户还没有个人简介"})}console.log("最终用户信息和关注状态:",{user:f.value,isFollowing:y.value,pets:w.value}),p.value=!0})),closeUserPopup:()=>{p.value=!1,f.value=null,w.value=[]},messageUser:e=>{console.log("向用户发送消息:",e)},followUser:e=>c(this,null,(function*(){if(t.isAuthenticated)if(e&&e._id)try{const i=yield g.api.user.followUser(e._id);i&&void 0!==i.isFollowing&&(y.value=i.isFollowing,u.index.showToast({title:y.value?"关注成功":"取消关注成功",icon:"success"}),f.value&&(f.value.isFollowing=y.value),yield t.fetchUserStats(),1!==o.value||y.value||x())}catch(i){console.error("关注用户操作失败:",i),u.index.showToast({title:"操作失败，请重试",icon:"none"})}else console.error("无效的用户信息");else u.index.navigateTo({url:"/pages/login/login"})}))}},onLoad(){const e=u.index.getSystemInfoSync(),t=e.windowHeight;e.statusBarHeight;const o=u.index.upx2px(170),i=u.index.upx2px(100);this.scrollHeight=t-o-i,console.log("设置滚动区域高度:",this.scrollHeight,"px (已减去tabBar高度)"),this.$nextTick((()=>{u.index.$api&&u.index.$api.community?this.loadPosts():"function"==typeof this.showDefaultPosts&&this.showDefaultPosts()}))},mounted(){if(u.index.$api&&u.index.$api.community)this.loadPosts();else{console.warn("API尚未准备好，使用默认数据"),this.showDefaultPosts();const e=setInterval((()=>{u.index.$api&&u.index.$api.community&&(clearInterval(e),this.loadPosts())}),1e3);setTimeout((()=>{clearInterval(e)}),5e3)}},onPullDownRefresh(){console.log("页面下拉刷新触发"),this.isRefreshing=!0,this.loadPosts(!0).finally((()=>{u.index.stopPullDownRefresh(),setTimeout((()=>{this.isRefreshing=!1}),300)}))},onShow(){const e=Date.now();this.lastPublishTime&&e-this.lastPublishTime<15e3&&(console.log("检测到可能发布新帖子，刷新内容"),this.loadPosts&&this.loadPosts(!0))}};if(!Array){(u.resolveComponent("walk-record-card")+u.resolveComponent("image-viewer")+u.resolveComponent("UserInfoPopup"))()}const v=u._export_sfc(m,[["render",function(e,t,o,i,s,a){var n;return u.e({a:u.o(((...e)=>i.navToCreate&&i.navToCreate(...e))),b:u.f(i.tabs,((e,t,o)=>({a:u.t(e),b:t,c:i.currentTab===t?1:"",d:u.o((e=>i.switchTab(t)),t)}))),c:i.posts&&0===i.posts.length&&!i.isLoading},i.posts&&0===i.posts.length&&!i.isLoading?u.e({d:0===i.currentTab},(i.currentTab,{})):{},{e:u.f(i.posts,((e,t,o)=>{var s,a;return u.e({a:i.formatAvatarUrl((null==(s=e.user)?void 0:s.avatar)||e.userAvatar),b:u.o((t=>i.showUserProfile(e.user||{_id:e.userId,username:e.username,avatar:e.userAvatar})),e.id||e._id),c:u.o((e=>i.handleAvatarError(e,t)),e.id||e._id),d:u.t((null==(a=e.user)?void 0:a.username)||e.username||"用户"),e:u.t(i.formatDate(e.createdAt||e.time)),f:u.t(i.truncateText(e.content,40)),g:e.walkRecord},e.walkRecord?{h:"45256cc0-0-"+o,i:u.p({record:e.walkRecord})}:{},{j:e.images&&e.images.length>0},e.images&&e.images.length>0?u.e({k:u.f(e.images.slice(0,3),((t,o,s)=>({a:o,b:i.formatImageUrl(t),c:u.o((t=>i.previewImage(e,o)),o)}))),l:1===e.images.length?1:"",m:e.images.length>3},e.images.length>3?{n:u.t(e.images.length-3)}:{}):{},{o:e.isLiked?1:"",p:u.t(i.getNumberValue(e.likes)),q:u.o((o=>i.likePost(e,t)),e.id||e._id),r:u.t(i.getNumberValue(e.comments)),s:u.o((t=>i.viewComments(e)),e.id||e._id),t:e.id||e._id,v:u.o((t=>i.viewPostDetail(e)),e.id||e._id)})})),f:u.o(((...e)=>i.loadMore&&i.loadMore(...e))),g:i.isLoading},(i.isLoading,{}),{h:u.o(((...e)=>i.navToCreate&&i.navToCreate(...e))),i:u.o(i.closeImageViewer),j:u.p({show:i.showImageViewer,images:(null==(n=i.currentPost)?void 0:n.images)||[],initialIndex:i.currentImageIndex}),k:i.showUserPopup},i.showUserPopup?{l:u.o(i.closeUserPopup),m:u.o(i.messageUser),n:u.o(i.followUser),o:u.p({user:i.selectedUser,pets:i.selectedUserPets,"is-following":i.isFollowing,visible:i.showUserPopup})}:{})}]]);wx.createPage(v);
