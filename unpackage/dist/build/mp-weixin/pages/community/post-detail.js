"use strict";var e=Object.defineProperty,t=Object.defineProperties,o=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,r=(t,o,s)=>o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[o]=s,l=(e,t)=>{for(var o in t||(t={}))i.call(t,o)&&r(e,o,t[o]);if(s)for(var o of s(t))n.call(t,o)&&r(e,o,t[o]);return e},a=(e,s)=>t(e,o(s)),c=(e,t,o)=>new Promise(((s,i)=>{var n=e=>{try{l(o.next(e))}catch(t){i(t)}},r=e=>{try{l(o.throw(e))}catch(t){i(t)}},l=e=>e.done?s(e.value):Promise.resolve(e.value).then(n,r);l((o=o.apply(e,t)).next())}));const d=require("../../common/vendor.js"),h=require("../../store/user.js"),m=require("../../utils/api.js"),u={components:{WalkRecordCard:()=>"../../components/WalkRecordCard.js",ImageViewer:()=>"../../components/ImageViewer.js",UserInfoPopup:()=>"../../components/map/UserInfoPopup.js"},data:()=>({postId:"",post:null,comments:[],commentContent:"",isLoading:!0,isSubmitting:!1,shouldScrollToComments:!1,showImageViewer:!1,currentImageIndex:0,showUserPopup:!1,selectedUser:null,selectedUserPets:[],isFollowing:!1}),onLoad(e){if(e&&e.id){if(this.postId=e.id,e.postKey)try{const t=d.index.getStorageSync(e.postKey);if(t){const e=JSON.parse(t);if(e)return console.log("从缓存获取帖子数据:",e),this.post=e,void 0===this.post.isLiked&&(this.post.isLiked=!1),void 0===this.post.likes&&(this.post.likes=0),void 0===this.post.comments&&(this.post.comments=0),this.isLoading=!1,void this.loadComments()}}catch(t){console.error("解析缓存的帖子数据失败:",t)}"true"===e.showComments&&(this.shouldScrollToComments=!0),this.loadPostDetail(),this.loadComments()}else d.index.showToast({title:"未找到帖子",icon:"none"}),setTimeout((()=>{d.index.navigateBack()}),1500)},onReady(){this.shouldScrollToComments&&setTimeout((()=>{d.index.createSelectorQuery().in(this).select(".comment-divider").boundingClientRect((e=>{e&&d.index.pageScrollTo({scrollTop:e.top,duration:300})})).exec()}),500)},methods:{getNumberValue:e=>Array.isArray(e)?e.length:"number"==typeof e?e:e&&"object"==typeof e?Object.keys(e).length:0,formatDuration(e){if(!e)return"0分钟";const t=Math.floor(e/3600),o=Math.floor(e%3600/60);let s="";return t>0?(s+=`${t}小时`,o>0&&(s+=`${o}分钟`)):s+=`${o}分钟`,s},navBack(){d.index.navigateBack()},formatDate(e){if(!e)return"";if("string"==typeof e&&!e.includes("T")&&!e.includes("-"))return e;try{const t=new Date(e),o=new Date,s=Math.floor((o-t)/1e3);return s<60?"刚刚":s<3600?Math.floor(s/60)+"分钟前":s<86400?Math.floor(s/3600)+"小时前":s<2592e3?Math.floor(s/86400)+"天前":`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}catch(t){return console.error("日期格式化错误:",t),e}},previewImage(e){this.currentImageIndex=e,this.showImageViewer=!0},closeImageViewer(){this.showImageViewer=!1},showUserProfile(e){return c(this,null,(function*(){if(console.log("显示用户信息:",e),!e||!e._id)return console.error("无效的用户信息"),void d.index.showToast({title:"无法获取用户信息",icon:"none"});const t=h.useUserStore(),o=t.isAuthenticated&&t.userId===e._id;if(this.selectedUser=a(l({},e),{isCurrentUser:o}),this.isFollowing=!1,t.isAuthenticated&&!o)try{console.log("直接调用checkFollowStatus检查关注状态，用户ID:",e._id);const t=yield m.api.user.checkFollowStatus(e._id);t&&void 0!==t.isFollowing&&(this.isFollowing=t.isFollowing,console.log("API返回的关注状态:",this.isFollowing))}catch(s){console.error("检查关注状态失败:",s),void 0!==e.isFollowing&&(this.isFollowing=e.isFollowing,console.log("从用户对象获取关注状态:",this.isFollowing))}if(console.log("初始关注状态设置为:",this.isFollowing),t.isAuthenticated)try{let t=null;try{console.log("尝试获取用户详情，ID:",e._id),t=yield m.api.user.getUserById(e._id),console.log("获取用户详情成功:",t),t&&void 0!==t.isFollowing&&(this.isFollowing=this.isFollowing||t.isFollowing,console.log("综合考虑后的关注状态:",this.isFollowing))}catch(i){console.error("获取用户详情失败, 使用基本信息:",i),t=a(l({},e),{nickname:e.nickname||e.username||"用户",bio:e.bio||"这位用户还没有个人简介"}),d.index.showToast({title:"获取用户详情失败",icon:"none",duration:1500})}if(t){o&&(this.isFollowing=!1),this.selectedUser=a(l({},t),{isCurrentUser:o,isFollowing:this.isFollowing}),console.log("更新后的selectedUser和isFollowing:",this.selectedUser,this.isFollowing);try{console.log("尝试获取用户宠物列表，用户ID:",e._id);const t=yield m.api.user.getPetsByUser(e._id);console.log("获取到的宠物列表:",t),this.selectedUserPets=t||[]}catch(n){console.error("获取宠物列表失败:",n),this.selectedUserPets=[]}}}catch(s){console.error("获取用户信息处理过程出错:",s),this.selectedUser=a(l({},e),{isCurrentUser:o,isFollowing:this.isFollowing}),d.index.showToast({title:"获取用户详情失败",icon:"none"})}console.log("最终显示的用户信息和关注状态:",{user:this.selectedUser,isFollowing:this.isFollowing,pets:this.selectedUserPets}),this.showUserPopup=!0}))},closeUserPopup(){this.showUserPopup=!1,this.selectedUser=null,this.selectedUserPets=[]},messageUser(e){console.log("向用户发送消息:",e)},followUser(e){return c(this,null,(function*(){const t=h.useUserStore();if(t.isAuthenticated)if(e&&e._id)try{const o=yield m.api.user.followUser(e._id);o&&void 0!==o.isFollowing&&(this.isFollowing=o.isFollowing,this.selectedUser&&(this.selectedUser.isFollowing=this.isFollowing),d.index.showToast({title:this.isFollowing?"关注成功":"取消关注成功",icon:"success"}),yield t.fetchUserStats())}catch(o){console.error("关注用户操作失败:",o),d.index.showToast({title:"操作失败，请重试",icon:"none"})}else console.error("无效的用户信息");else d.index.navigateTo({url:"/pages/login/login"})}))},formatAvatarUrl(e){if(!e)return"/static/images/default-avatar.png";if(e.startsWith("http")||e.startsWith("/static"))return e;if(e.startsWith("/uploads")){const t=d.index.getStorageSync("BASE_URL")||"http://49.235.65.37:5000";return console.log("处理相对路径头像URL:",e,"补充基础URL:",t),t+e}return"object"==typeof e&&e.avatar?this.formatAvatarUrl(e.avatar):(console.warn("未能识别的头像URL格式:",e),"/static/images/default-avatar.png")},formatImageUrl(e){if(!e)return"/static/images/default-pet.png";if(console.log("帖子详情页处理图片URL:",e),e.startsWith("http")||e.startsWith("/static")||e.startsWith("blob:"))return console.log("返回原始URL:",e),e;if(e.startsWith("/uploads")){const t=d.index.getStorageSync("BASE_URL")||"http://49.235.65.37:5000",o=t+e;return console.log("处理相对路径图片URL:",e,"补充基础URL:",t,"完整URL:",o),o}return console.warn("未能识别的图片URL格式:",e),"/static/images/default-pet.png"},loadPostDetail(){return c(this,null,(function*(){this.isLoading=!0;try{const t=d.index.$api.community;if(!t)throw new Error("社区API未初始化");try{console.log("尝试加载帖子详情, ID:",this.postId);const e=yield t.getPostDetail(this.postId);if(!e)throw new Error("获取帖子详情失败：空响应");console.log("获取到帖子详情:",e),void 0===e.isLiked&&(e.isLiked=!1),void 0===e.likes&&(e.likes=0),void 0===e.comments&&(e.comments=0),this.post=this.parseWalkRecordFromContent(e),console.log("处理后的帖子详情:",this.post)}catch(e){console.error("获取帖子详情失败:",e),d.index.showToast({title:"加载失败，请稍后再试",icon:"none",duration:2e3}),setTimeout((()=>{d.index.navigateBack()}),2e3)}}catch(e){console.error("加载帖子详情过程中发生错误:",e),d.index.showToast({title:"加载失败，请稍后再试",icon:"none",duration:2e3}),setTimeout((()=>{d.index.navigateBack()}),2e3)}finally{this.isLoading=!1}}))},parseWalkRecordFromContent(e){if(e.walkRecord)return e;const t=e.content||"";let o=null;const s=t.match(/遛了\s*(\d+\.?\d*)\s*公里/),i=s?1e3*parseFloat(s[1]):null,n=t.match(/用时\s*(\d+)\s*(秒|分钟|小时)/);let r=null;if(n){const e=parseInt(n[1]),t=n[2];"秒"===t?r=e:"分钟"===t?r=60*e:"小时"===t&&(r=3600*e)}const c=t.match(/和\s*([^\s,，。！]+)\s*一起遛/),d=c?c[1]:"我的宠物";return null!==i||null!==r?(o={_id:`generated_${e._id||e.id||Date.now()}`,distance:i||0,duration:r||0,pet:{name:d},startTime:e.createdAt||e.time||(new Date).toISOString()},a(l({},e),{walkRecord:o})):e},loadComments(){return c(this,null,(function*(){try{if(!d.index.$api||!d.index.$api.community)return console.error("社区API未初始化"),void(this.comments=[]);d.index.showLoading({title:"加载评论..."});try{console.log("尝试加载评论, 帖子ID:",this.postId);const e=yield d.index.$api.community.getComments(this.postId,{limit:50});if(e&&(e.data||Array.isArray(e))){const t=Array.isArray(e)?e:Array.isArray(e.data)?e.data:[];console.log("评论列表:",t),this.comments=t}else console.log("没有找到评论或返回为空"),this.comments=[]}catch(e){console.error("获取评论失败:",e),this.comments=[]}finally{d.index.hideLoading()}}catch(e){console.error("加载评论过程中发生错误:",e),d.index.hideLoading(),this.comments=[]}}))},likePost(){return c(this,null,(function*(){if(this.post)try{this.post.isLiked=!this.post.isLiked,this.post.likes=this.post.isLiked?(this.post.likes||0)+1:Math.max((this.post.likes||1)-1,0);const e=d.index.$api.community;if(!e)throw new Error("社区API未初始化");return yield e.likePost(this.postId,this.post.isLiked),void d.index.showToast({title:this.post.isLiked?"点赞成功":"已取消点赞",icon:"none"})}catch(e){return console.error("点赞操作失败:",e),this.post.isLiked=!this.post.isLiked,this.post.likes=this.post.isLiked?(this.post.likes||0)+1:Math.max((this.post.likes||1)-1,0),void d.index.showToast({title:"操作失败",icon:"none"})}}))},submitComment(){return c(this,null,(function*(){if(this.commentContent.trim()&&!this.isSubmitting){this.isSubmitting=!0;try{if(!d.index.$api||!d.index.$api.community)throw new Error("社区API未初始化");yield d.index.$api.community.addComment(this.postId,{content:this.commentContent}),this.commentContent="",this.loadComments(),this.post&&(this.post.comments=(this.post.comments||0)+1),d.index.showToast({title:"评论成功",icon:"success"})}catch(e){console.error("提交评论失败:",e),d.index.showToast({title:"评论失败，请稍后再试",icon:"none"})}finally{this.isSubmitting=!1}}}))},viewWalkRecord(){if(!this.post||!this.post.walkRecord||!this.post.walkRecord._id)return void d.index.showToast({title:"遛狗记录不存在",icon:"none"});console.log("查看遛狗记录详情:",this.post.walkRecord);this.post.walkRecord._id.startsWith("generated_")?d.index.showToast({title:"这是从动态内容解析的遛狗记录，无法查看详情",icon:"none",duration:2500}):d.index.navigateTo({url:`/pages/walk/detail?id=${this.post.walkRecord._id}`,fail:e=>{console.error("打开遛狗记录详情失败:",e),d.index.showToast({title:"无法查看遛狗记录",icon:"none"})}})}}};if(!Array){(d.resolveComponent("walk-record-card")+d.resolveComponent("image-viewer")+d.resolveComponent("UserInfoPopup"))()}const p=d._export_sfc(u,[["render",function(e,t,o,s,i,n){var r,l,a;return d.e({a:d.o(((...e)=>n.navBack&&n.navBack(...e))),b:i.isLoading},(i.isLoading,{}),{c:!i.isLoading&&!i.post},(i.isLoading||i.post,{}),{d:i.post},i.post?d.e({e:n.formatAvatarUrl((null==(r=i.post.user)?void 0:r.avatar)||i.post.userAvatar),f:d.o((e=>n.showUserProfile(i.post.user||{_id:i.post.userId,username:i.post.username,avatar:i.post.userAvatar}))),g:d.t(i.post.username||(null==(l=i.post.user)?void 0:l.username)||"用户"),h:d.t(n.formatDate(i.post.time||i.post.createdAt)),i:d.t(i.post.content),j:i.post.walkRecord},i.post.walkRecord?{k:d.p({record:i.post.walkRecord})}:{},{l:i.post.images&&i.post.images.length>0},i.post.images&&i.post.images.length>0?{m:d.f(i.post.images,((e,t,o)=>({a:t,b:n.formatImageUrl(e),c:d.o((e=>n.previewImage(t)),t)})))}:{},{n:i.post.isLiked?1:"",o:d.t(n.getNumberValue(i.post.likes)),p:d.o(((...e)=>n.likePost&&n.likePost(...e))),q:d.t(n.getNumberValue(i.post.comments)),r:!i.comments||0===i.comments.length},(i.comments&&i.comments.length,{}),{s:d.f(i.comments,((e,t,o)=>{var s,i;return{a:n.formatAvatarUrl((null==(s=e.user)?void 0:s.avatar)||e.userAvatar),b:d.o((t=>n.showUserProfile(e.user||{_id:e.userId,username:e.username,avatar:e.userAvatar})),e.id||t),c:d.t(e.username||(null==(i=e.user)?void 0:i.username)||"用户"),d:d.t(n.formatDate(e.time||e.createdAt)),e:d.t(e.content),f:e.id||t}}))}):{},{t:d.o(((...e)=>n.submitComment&&n.submitComment(...e))),v:i.commentContent,w:d.o((e=>i.commentContent=e.detail.value)),x:d.o(((...e)=>n.submitComment&&n.submitComment(...e))),y:i.commentContent.trim()?1:"",z:d.o(n.closeImageViewer),A:d.p({show:i.showImageViewer,images:(null==(a=i.post)?void 0:a.images)||[],initialIndex:i.currentImageIndex}),B:i.showUserPopup},i.showUserPopup?{C:d.o(n.closeUserPopup),D:d.o(n.messageUser),E:d.o(n.followUser),F:d.p({user:i.selectedUser,pets:i.selectedUserPets,"is-following":i.isFollowing,visible:i.showUserPopup})}:{})}]]);wx.createPage(p);
