"use strict";var e=(e,o,t)=>new Promise(((n,a)=>{var i=e=>{try{s(t.next(e))}catch(o){a(o)}},l=e=>{try{s(t.throw(e))}catch(o){a(o)}},s=e=>e.done?n(e.value):Promise.resolve(e.value).then(i,l);s((t=t.apply(e,o)).next())}));const o=require("../../common/vendor.js"),t={setup(){const t=o.ref(""),n=o.ref([]),a=o.ref(!1),i=o.ref(null),l=o.ref(null),s=o.ref(!1),c=o.ref("");o.index.getLocation({type:"gcj02",success:e=>{console.log("获取位置成功:",e),l.value={type:"Point",coordinates:[e.longitude,e.latitude]}},fail:e=>{console.error("获取位置失败:",e),l.value={type:"Point",coordinates:[116.3,39.9]}}});o.index.$on("createPost",(e=>{console.log("收到预填内容:",e),e&&e.content&&(t.value=e.content),e&&e.walkRecord&&(i.value=e.walkRecord,console.log("设置遛狗记录:",i.value))}));o.index.$once("hook:beforeDestroy",(()=>{o.index.$off("createPost")}));const r=a=>e(this,null,(function*(){try{o.index.showLoading({title:"加载帖子数据..."});const c=`post_cache_${a}_`;let r=null;const u=o.index.getStorageInfoSync().keys||[];for(const t of u)if(t.startsWith(c))try{const e=o.index.getStorageSync(t);if(e){r=JSON.parse(e),console.log("找到缓存的帖子数据:",r);break}}catch(e){console.error("解析缓存数据失败:",e)}if(!r)try{if(o.index.$api&&o.index.$api.community&&"function"==typeof o.index.$api.community.getPostDetail)r=yield o.index.$api.community.getPostDetail(a),console.log("API获取帖子数据成功:",r);else{console.warn("API中没有getPostDetail方法，尝试从页面参数获取");const t=getCurrentPages(),n=t[t.length-1].options||{};if(n.postKey)try{const e=o.index.getStorageSync(n.postKey);e&&(r=JSON.parse(e),console.log("从页面参数缓存获取帖子数据:",r))}catch(e){console.error("解析页面参数缓存数据失败:",e)}}}catch(s){console.error("从API获取帖子数据失败:",s);const t=getCurrentPages(),n=t[t.length-1].options||{};if(n.postKey)try{const e=o.index.getStorageSync(n.postKey);e&&(r=JSON.parse(e),console.log("从页面参数缓存获取帖子数据:",r))}catch(e){console.error("解析页面参数缓存数据失败:",e)}}r?(t.value=r.content||"",r.images&&r.images.length>0&&(n.value=[...r.images]),r.walkRecord&&(i.value=r.walkRecord),r.location&&(l.value=r.location)):o.index.showToast({title:"获取帖子失败",icon:"none"})}catch(s){console.error("加载帖子数据失败:",s),o.index.showToast({title:"加载帖子数据失败",icon:"none"})}finally{o.index.hideLoading()}}));o.onMounted((()=>{const e=getCurrentPages(),a=e[e.length-1].options||{};if(console.log("页面参数:",a),"edit"===a.mode&&a.id)if(s.value=!0,c.value=a.id,a.postKey)try{const e=o.index.getStorageSync(a.postKey);if(e){const o=JSON.parse(e);console.log("从传入的缓存键加载帖子数据:",o),t.value=o.content||"",o.images&&o.images.length>0&&(n.value=[...o.images]),o.walkRecord&&(i.value=o.walkRecord),o.location&&(l.value=o.location)}else r(a.id)}catch(u){console.error("解析缓存数据失败:",u),r(a.id)}else r(a.id)}));return{content:t,images:n,isSubmitting:a,walkRecord:i,userLocation:l,isEditMode:s,editPostId:c,formatDuration:e=>{const o=Math.floor(e/3600),t=Math.floor(e%3600/60);let n="";return o>0&&(n+=`${o}小时`),(t>0||o>0)&&(n+=`${t}分钟`),n+=`${e%60}秒`,n},navBack:()=>{o.index.navigateBack()},chooseImage:()=>{o.index.chooseImage({count:6-n.value.length,sizeType:["compressed"],sourceType:["album","camera"],success:e=>{n.value=[...n.value,...e.tempFilePaths]}})},removeImage:e=>{n.value.splice(e,1)},previewImage:(e,t)=>{o.index.previewImage({urls:n.value,current:t,indicator:"number",loop:!0,longPressActions:{itemList:["保存图片","取消"],success:function(e){0===e.tapIndex&&o.index.saveImageToPhotosAlbum({filePath:n.value[t],success:function(){o.index.showToast({title:"图片已保存",icon:"success"})},fail:function(){o.index.showToast({title:"保存失败",icon:"none"})}})}}})},submitPost:()=>e(this,null,(function*(){if(!t.value.trim())return void o.index.showToast({title:"请输入内容",icon:"none"});if(a.value)return;if(a.value=!0,o.index.showLoading({title:s.value?"更新中...":"发布中..."}),!l.value)try{yield new Promise((e=>{o.index.getLocation({type:"gcj02",success:o=>{l.value={type:"Point",coordinates:[o.longitude,o.latitude]},console.log("发帖前获取位置成功:",l.value),e()},fail:o=>{console.error("发帖前获取位置失败:",o),l.value={type:"Point",coordinates:[116.3,39.9]},e()}})}))}catch(r){console.error("获取位置过程中出错:",r),l.value={type:"Point",coordinates:[116.3,39.9]}}const e={content:t.value,walkRecord:i.value?{_id:i.value._id,distance:i.value.distance,duration:i.value.duration,pet:i.value.pet}:null,location:{type:"Point",coordinates:l.value?l.value.coordinates:[116.3,39.9]}};console.log(`准备${s.value?"更新":"发送"}的帖子数据:`,e);try{if(!o.index.$api||!o.index.$api.community)throw new Error("社区API未初始化");let t;s.value&&c.value?(t=yield o.index.$api.community.updatePost(c.value,e),console.log("更新帖子成功，结果:",t)):(t=yield o.index.$api.community.createPost(e),console.log("发布帖子成功，结果:",t));const a=c.value||t&&t._id||t&&t.id||t&&t.data&&t.data._id;if(!a)throw console.error("无法获取有效的帖子ID:",t),new Error("创建帖子成功但无法获取帖子ID");if(console.log("获取到的帖子ID:",a),n.value&&n.value.length>0&&a){console.log("准备上传帖子图片, 帖子ID:",a);try{const e=[];for(let t=0;t<n.value.length;t++)if(n.value[t].startsWith("blob:")||n.value[t].startsWith("file:")||!n.value[t].startsWith("http")){o.index.showLoading({title:`上传图片 ${t+1}/${n.value.length}...`});try{const i=yield o.index.$api.community.uploadPostImage(a,n.value[t]);console.log(`图片 ${t+1} 上传成功:`,i),i&&i.url&&e.push(i.url)}catch(u){console.error(`图片 ${t+1} 上传失败:`,u),o.index.showToast({title:`图片 ${t+1} 上传失败，将继续上传其他图片`,icon:"none",duration:2e3});try{"string"==typeof n.value[t]&&(n.value[t].startsWith("file://")||n.value[t].startsWith("/storage/"))&&(console.log(`尝试保存本地图片路径: ${n.value[t]}`),e.push(n.value[t]))}catch(r){console.error("保存本地图片路径失败:",r)}}}else(n.value[t].startsWith("http")||n.value[t].startsWith("/uploads"))&&e.push(n.value[t]);if(e.length>0){console.log("所有图片上传完成，更新帖子图片字段:",e);try{const t=Array.isArray(e)?{images:e}:{images:[e]};if(console.log("发送更新帖子请求，数据:",t),"string"!=typeof a||!a.trim())throw console.error("更新图片时发现帖子ID无效:",a),new Error("帖子ID无效，无法更新图片");s.value?(yield o.index.$api.community.updatePost(a,t),console.log("更新帖子图片成功")):console.log("发布新帖模式，跳过更新帖子图片步骤")}catch(d){console.error("更新帖子图片字段失败:",d)}}}catch(g){console.error("上传图片过程中出错:",g)}}o.index.hideLoading(),o.index.showToast({title:s.value?"更新成功":"发布成功",icon:"success"}),setTimeout((()=>{o.index.navigateBack()}),1500)}catch(v){o.index.hideLoading(),o.index.showToast({title:"发布失败: "+(v.message||"未知错误"),icon:"none",duration:2e3}),console.error("发布帖子失败",v)}finally{a.value=!1}})),loadPostData:r,testMultipleImages:()=>{o.index.chooseImage({count:6,sizeType:["original","compressed"],sourceType:["album"],success:e=>{console.log("选择了多张图片:",e.tempFilePaths),n.value=[...e.tempFilePaths],t.value||(t.value="测试多图上传功能，这是一个包含多张图片的帖子"),o.index.showToast({title:`已选择${e.tempFilePaths.length}张图片`,icon:"none"})}})}}}};const n=o._export_sfc(t,[["render",function(e,t,n,a,i,l){return o.e({a:o.o(((...e)=>a.navBack&&a.navBack(...e))),b:o.t(a.isEditMode?"编辑动态":"发布动态"),c:o.t(a.isEditMode?"更新":"发布"),d:o.o(((...e)=>a.submitPost&&a.submitPost(...e))),e:a.content,f:o.o((e=>a.content=e.detail.value)),g:o.f(a.images,((e,t,n)=>({a:e,b:o.o((o=>a.previewImage(e,t)),t),c:o.o((e=>a.removeImage(t)),t),d:t}))),h:a.images.length<6},a.images.length<6?{i:o.o(((...e)=>a.chooseImage&&a.chooseImage(...e)))}:{},{j:0===a.images.length},0===a.images.length?{k:o.o(((...e)=>a.testMultipleImages&&a.testMultipleImages(...e)))}:{},{l:o.t(a.content.length),m:a.walkRecord},a.walkRecord?o.e({n:o.t((a.walkRecord.distance/1e3).toFixed(2)),o:o.t(a.formatDuration(a.walkRecord.duration)),p:a.walkRecord.pet},a.walkRecord.pet?o.e({q:a.walkRecord.pet.avatar},a.walkRecord.pet.avatar?{r:a.walkRecord.pet.avatar}:{},{s:o.t(a.walkRecord.pet.name||"未命名宠物")}):{}):{})}]]);wx.createPage(n);
