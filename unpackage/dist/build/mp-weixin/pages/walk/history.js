"use strict";var e=(e,a,t)=>new Promise(((o,l)=>{var s=e=>{try{n(t.next(e))}catch(a){l(a)}},r=e=>{try{n(t.throw(e))}catch(a){l(a)}},n=e=>e.done?o(e.value):Promise.resolve(e.value).then(s,r);n((t=t.apply(e,a)).next())}));const a=require("../../common/vendor.js"),t=require("../../store/user.js"),o=require("../../utils/api.js"),l=require("../../common/assets.js");console.log("已加载增强版遛狗记录页面 v2.1 - 修复返回导航逻辑");const s={setup(){const l=t.useUserStore(),s=a.ref([]),r=a.ref(!1),n=a.ref(!0),i=10,d=a.ref(1),c=a.ref(!1),u=a.ref(""),g=()=>e(this,null,(function*(){if(n.value&&!r.value){r.value=!0,u.value="";try{console.log("开始加载遛狗记录, 页码:",d.value,"每页数量:",i),console.log("API路径: /api/walks");const e=yield o.api.walk.getMyWalks({page:d.value,limit:i});console.log("API响应成功, 返回数据类型:",typeof e,e?"有数据":"无数据"),console.log("API响应数据:",JSON.stringify(e));let a=[],t=!1;e&&0===e.code&&e.data?e.data.list&&Array.isArray(e.data.list)&&(console.log("标准API返回格式, 记录数量:",e.data.list.length),a=e.data.list,t=a.length<i||e.data.total&&d.value*i>=e.data.total):Array.isArray(e)?(console.log("直接返回数组格式, 记录数量:",e.length),a=e,t=a.length<i):e&&"object"==typeof e&&e.data&&(Array.isArray(e.data)?(console.log("嵌套数组格式, 记录数量:",e.data.length),a=e.data,t=a.length<i):e.data.list&&Array.isArray(e.data.list)&&(console.log("嵌套对象格式, 记录数量:",e.data.list.length),a=e.data.list,t=a.length<i||e.data.total&&d.value*i>=e.data.total)),0===a.length&&1===d.value?(console.log("没有找到任何遛狗记录"),u.value="您还没有遛狗记录，快去遛狗吧！",n.value=!1):(console.log("成功加载遛狗记录, 数量:",a.length),s.value=1===d.value?[...a]:[...s.value,...a],d.value++,n.value=!t,console.log("当前已加载记录总数:",s.value.length,"是否有更多:",n.value))}catch(e){console.error("加载遛狗记录失败:",e),console.error("错误详情:",e.message||"未知错误"),e.statusCode&&console.error("HTTP状态码:",e.statusCode);let t="加载失败，请重试";e&&e.message&&(404===e.statusCode?(t="API接口不存在，后端可能尚未实现此功能",u.value="无法加载遛狗记录，后端API未找到"):401===e.statusCode?(t="登录已过期，请重新登录",setTimeout((()=>{a.index.navigateTo({url:"/pages/login/login"})}),1500)):(t=`加载失败: ${e.message}`,u.value="加载遛狗记录失败，请稍后再试")),a.index.showToast({title:t,icon:"none",duration:3e3})}finally{r.value=!1,c.value&&(c.value=!1)}}})),v=()=>{s.value=[],d.value=1,n.value=!0},h=e=>{const a=Math.floor(e/3600),t=Math.floor(e%3600/60),o=e%60;return a>0?`${a}小时${t}分`:t>0?`${t}分${o}秒`:`${o}秒`};return a.onMounted((()=>{l.token?g():a.index.showToast({title:"请先登录",icon:"none",success:()=>{setTimeout((()=>{a.index.navigateTo({url:"/pages/login/login"})}),1500)}})})),a.onPullDownRefresh((()=>{console.log("页面下拉刷新"),v(),g().finally((()=>{a.index.stopPullDownRefresh()}))})),{records:s,isLoading:r,hasMore:n,isRefreshing:c,errorMessage:u,loadMore:()=>{n.value&&!r.value&&g()},onRefresh:()=>{c.value=!0,v(),g()},viewDetail:e=>{a.index.navigateTo({url:`/pages/walk/detail?id=${e._id}`})},shareRecord:e=>{var t;const o=`我和${(null==(t=e.pet)?void 0:t.name)||"我的宠物"}一起遛了${(e.distance/1e3).toFixed(2)}公里，用时${h(e.duration)}！`;a.index.navigateTo({url:"/pages/community/create",success:t=>{var l;a.index.$emit("createPost",{content:o,walkRecord:{_id:e._id,distance:e.distance,duration:e.duration,pet:null==(l=e.pet)?void 0:l._id,startTime:e.startTime,endTime:e.endTime}})},fail:e=>{console.error("导航到社区发帖页面失败:",e),a.index.showToast({title:"打开社区页面失败",icon:"none"})}})},deleteRecord:t=>{a.index.showModal({title:"删除记录",content:"确定要删除这条遛狗记录吗？",success:l=>e(this,null,(function*(){if(l.confirm)try{r.value=!0,console.log("正在删除记录ID:",t._id||t.id);const l=yield o.api.walk.deleteWalk(t._id||t.id);if(console.log("删除记录API响应:",l),s.value=s.value.filter((e=>(e._id||e.id)!==(t._id||t.id))),t.id&&t.id.startsWith("walk_"))try{console.log("从本地存储中删除记录");require("@/utils/walkStorage.js").default.deleteWalkRecord(t.id)}catch(e){console.error("本地存储删除失败:",e)}a.index.showToast({title:"删除成功",icon:"success"}),setTimeout((()=>{v(),g()}),1e3)}catch(n){console.error("删除记录失败:",n),console.error("错误详情:",n.message||"未知错误"),n.statusCode&&console.error("HTTP状态码:",n.statusCode),a.index.showToast({title:n.message||"删除失败，请重试",icon:"none",duration:3e3})}finally{r.value=!1}}))})},navToMap:()=>{a.index.switchTab({url:"/pages/map/map"})},formatDate:e=>{const a=new Date(e);return`${a.getFullYear()}年${a.getMonth()+1}月${a.getDate()}日`},formatTime:e=>{const a=new Date(e);return`${a.getHours().toString().padStart(2,"0")}:${a.getMinutes().toString().padStart(2,"0")}`},formatDuration:h,navBack:()=>{getCurrentPages().length>1?a.index.navigateBack():a.index.switchTab({url:"/pages/my/index"})},loadRecords:g,resetList:v}}};const r=a._export_sfc(s,[["render",function(e,t,o,s,r,n){return a.e({a:a.o(((...e)=>s.navBack&&s.navBack(...e))),b:0===s.records.length&&!s.isLoading},0!==s.records.length||s.isLoading?{}:{c:l._imports_0$3,d:a.t(s.errorMessage||"暂无遛狗记录"),e:a.o(((...e)=>s.navToMap&&s.navToMap(...e)))},{f:a.f(s.records,((e,t,o)=>{var l,r;return{a:a.t(s.formatDate(e.startTime)),b:a.t(s.formatTime(e.startTime)),c:e.mapImageUrl||"/static/images/default-map.png",d:(null==(l=e.pet)?void 0:l.avatar)||"/static/images/default-pet.png",e:a.t((null==(r=e.pet)?void 0:r.name)||"未知宠物"),f:a.t((e.distance/1e3).toFixed(2)),g:a.t(s.formatDuration(e.duration)),h:a.o((a=>s.shareRecord(e)),e._id),i:a.o((a=>s.deleteRecord(e)),e._id),j:e._id,k:a.o((a=>s.viewDetail(e)),e._id)}})),g:s.isLoading},(s.isLoading,{}),{h:s.records.length>0&&!s.hasMore&&!s.isLoading},(s.records.length>0&&!s.hasMore&&s.isLoading,{}),{i:a.o(((...e)=>s.loadMore&&s.loadMore(...e)))})}],["__scopeId","data-v-da7e2b57"]]);wx.createPage(r);
