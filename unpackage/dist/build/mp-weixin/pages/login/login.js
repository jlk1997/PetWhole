"use strict";var e=Object.defineProperty,o=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,t=Object.prototype.propertyIsEnumerable,a=(o,r,t)=>r in o?e(o,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[r]=t;const s=require("../../common/vendor.js"),n=require("../../common/assets.js"),i=require("../../utils/ui.js"),l=require("../../utils/api.js"),u=require("../../store/user.js"),c={__name:"login",setup(e){const c=s.ref({username:"",password:""}),g=s.ref(!1),d=s.computed((()=>c.value.username.trim()&&c.value.password.trim()));function v(){return e=this,n=null,v=function*(){if(d.value){g.value=!0,i.showLoading("登录中...");try{const g=u.useUserStore(),d=yield l.api.auth.login({username:c.value.username,password:c.value.password});console.log("登录响应:",d);let v=d;if(d&&d.data&&(v=d.data),!v||!v.token&&!v.accessToken)throw console.error("无效的响应数据:",v),new Error("登录失败：服务器响应格式不正确");const f=v.token||v.accessToken;s.index.setStorageSync("token",f),g.token=f;let m=v.user;v.user?(g.user=v.user,s.index.setStorageSync("userInfo",JSON.stringify(v.user))):v._id||v.id?(m={username:c.value.username,nickname:v.nickname||c.value.username,_id:v._id||v.id||Date.now().toString(),avatar:v.avatar||"/static/images/default-avatar.png"},g.user=m,s.index.setStorageSync("userInfo",JSON.stringify(m))):(m=((e,s)=>{for(var n in s||(s={}))r.call(s,n)&&a(e,n,s[n]);if(o)for(var n of o(s))t.call(s,n)&&a(e,n,s[n]);return e})({username:c.value.username},v),g.user=m,s.index.setStorageSync("userInfo",JSON.stringify(m)));try{console.log("登录成功后获取完整用户信息");const e=yield g.fetchUserInfo();e&&(m=e,s.index.setStorageSync("userInfo",JSON.stringify(e)),console.log("已获取并保存最新用户信息:",e))}catch(e){console.error("获取完整用户信息失败:",e)}console.log("检查用户资料完整性:",m);const p=function(e){const o=["nickname","email"];if(!e)return console.log("用户信息不存在"),!1;for(const r of o)if(!e[r]||"string"==typeof e[r]&&""===e[r].trim())return console.log(`用户信息不完整: 缺少 ${r} 或为空值`),!1;return e.avatar&&"/static/images/default-avatar.png"!==e.avatar&&"static/images/default-avatar.png"!==e.avatar?(console.log("用户信息完整性检查通过:",e),!0):(console.log("用户信息不完整: 未上传头像"),!1)}(m);if(console.log("用户资料是否完整:",p),p){i.showToast({title:"登录成功",icon:"success"});try{s.index.setStorageSync("hasCompletedFirstLogin","true")}catch(n){console.error("保存登录状态失败:",n)}setTimeout((()=>{s.index.switchTab({url:"/pages/index/index"})}),1500)}else i.showToast({title:"请完善个人资料",icon:"none",duration:2e3}),setTimeout((()=>{s.index.redirectTo({url:"/pages/profile/profile?firstLogin=true"})}),1e3)}catch(v){console.error("登录失败:",v),"LOGIN_FAILED"===v.type?(i.showToast({title:"账号未注册，请先注册",icon:"none",duration:2e3}),setTimeout((()=>{try{i.navigateTo("/pages/login/register")}catch(e){console.error("跳转到注册页面失败:",e)}}),1500)):401===v.statusCode?i.showToast({title:"用户名或密码错误",icon:"none"}):i.showToast({title:v.message||"登录失败，请稍后再试",icon:"none"})}finally{g.value=!1,i.hideLoading()}}},new Promise(((o,r)=>{var t=e=>{try{s(v.next(e))}catch(o){r(o)}},a=e=>{try{s(v.throw(e))}catch(o){r(o)}},s=e=>e.done?o(e.value):Promise.resolve(e.value).then(t,a);s((v=v.apply(e,n)).next())}));var e,n,v}function f(){try{i.navigateTo("/pages/login/register")}catch(e){console.error("跳转到注册页面失败:",e),i.showToast("注册功能即将推出!")}}return(e,o)=>({a:n._imports_0,b:c.value.username,c:s.o((e=>c.value.username=e.detail.value)),d:c.value.password,e:s.o((e=>c.value.password=e.detail.value)),f:s.t(g.value?"登录中...":"登 录"),g:!d.value||g.value,h:g.value?1:"",i:s.o(v),j:s.o(f)})}};wx.createPage(c);
