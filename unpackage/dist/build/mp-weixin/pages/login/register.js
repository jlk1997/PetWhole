"use strict";const e=require("../../common/vendor.js"),a=require("../../common/assets.js"),o=require("../../utils/ui.js"),s={__name:"register",setup(s){const r=e.ref({username:"",password:"",confirmPassword:"",email:"",nickname:""}),n=e.ref(!1),t=e.computed((()=>{const{username:e,password:a,confirmPassword:o,email:s}=r.value;return e.trim()&&a.trim()&&a.length>=6&&o.trim()&&s.trim()&&a===o}));function i(){return a=this,s=null,t=function*(){var a,s,t;if(r.value.password.length<6)o.showToast({title:"密码长度不能少于6个字符",icon:"none"});else if(r.value.password===r.value.confirmPassword)if(i=r.value.email,/\S+@\S+\.\S+/.test(i)){var i;n.value=!0,o.showLoading("注册中...");try{const a=yield e.index.$api.auth.register({username:r.value.username,password:r.value.password,email:r.value.email,nickname:r.value.nickname||r.value.username});console.log("注册响应:",a);let s=a;if(a&&a.data&&(s=a.data),!s||!s.token&&!s.accessToken)throw console.error("无效的响应数据:",s),new Error("注册失败：服务器响应格式不正确");const n=s.token||s.accessToken;if(e.index.setStorageSync("token",n),s.user)e.index.setStorageSync("userInfo",JSON.stringify(s.user));else{const a={username:r.value.username,nickname:r.value.nickname||r.value.username,_id:s._id||s.id||Date.now().toString(),avatar:"/static/images/default-avatar.png"};e.index.setStorageSync("userInfo",JSON.stringify(a))}o.showToast({title:"注册成功，请完善信息",icon:"success"}),setTimeout((()=>{e.index.redirectTo({url:"/pages/profile/profile?firstLogin=true"})}),1500)}catch(l){console.error("注册失败:",l),500===l.statusCode?(console.error("服务器响应详情:",l.data),(null==(a=l.data)?void 0:a.error)&&l.data.error.includes("password")&&l.data.error.includes("shorter than the minimum")?o.showToast({title:"密码长度不能少于6个字符",icon:"none",duration:3e3}):(null==(s=l.data)?void 0:s.error)&&l.data.error.includes("email")&&l.data.error.includes("invalid")?o.showToast({title:"请输入有效的邮箱地址",icon:"none",duration:3e3}):(null==(t=l.data)?void 0:t.error)&&l.data.error.includes("required")?o.showToast({title:"请填写所有必填字段",icon:"none",duration:3e3}):o.showToast({title:"注册失败："+(l.message||"系统错误"),icon:"none",duration:3e3})):l.message&&l.message.includes("already exists")?o.showToast({title:"用户名已存在，请更换用户名",icon:"none"}):o.showToast({title:l.message||"注册失败，请稍后再试",icon:"none"})}finally{n.value=!1,o.hideLoading()}}else o.showToast({title:"请输入有效的邮箱地址",icon:"none"});else o.showToast({title:"两次输入的密码不一致",icon:"none"})},new Promise(((e,o)=>{var r=e=>{try{i(t.next(e))}catch(a){o(a)}},n=e=>{try{i(t.throw(e))}catch(a){o(a)}},i=a=>a.done?e(a.value):Promise.resolve(a.value).then(r,n);i((t=t.apply(a,s)).next())}));var a,s,t}function l(){try{o.navigateTo("/pages/login/login")}catch(a){console.error("跳转到登录页面失败:",a),e.index.navigateBack()}}return(o,s)=>e.e({a:a._imports_0,b:r.value.username,c:e.o((e=>r.value.username=e.detail.value)),d:r.value.email,e:e.o((e=>r.value.email=e.detail.value)),f:r.value.password,g:e.o((e=>r.value.password=e.detail.value)),h:r.value.password&&r.value.password.length<6},(r.value.password&&r.value.password.length,{}),{i:r.value.confirmPassword,j:e.o((e=>r.value.confirmPassword=e.detail.value)),k:r.value.password!==r.value.confirmPassword&&r.value.confirmPassword},(r.value.password!==r.value.confirmPassword&&r.value.confirmPassword,{}),{l:r.value.nickname,m:e.o((e=>r.value.nickname=e.detail.value)),n:e.t(n.value?"注册中...":"注 册"),o:!t.value||n.value,p:n.value?1:"",q:e.o(i),r:e.o(l)})}};wx.createPage(s);
