"use strict";var e=Object.defineProperty,t=Object.defineProperties,o=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,s=(t,o,i)=>o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[o]=i,a=(e,t)=>{for(var o in t||(t={}))n.call(t,o)&&s(e,o,t[o]);if(i)for(var o of i(t))r.call(t,o)&&s(e,o,t[o]);return e},d=(e,i)=>t(e,o(i)),l=(e,t,o)=>new Promise(((i,n)=>{var r=e=>{try{a(o.next(e))}catch(t){n(t)}},s=e=>{try{a(o.throw(e))}catch(t){n(t)}},a=e=>e.done?i(e.value):Promise.resolve(e.value).then(r,s);a((o=o.apply(e,t)).next())}));const c=require("../../common/vendor.js"),u=require("../../store/petStore.js"),g=require("../../store/userStore.js"),p=require("../../utils/api.js"),h=require("../../common/assets.js"),f={setup(){const e=u.usePetStore(),t=g.useUserStore(),o=c.ref([]),i=()=>l(this,null,(function*(){try{yield e.fetchPets(),o.value=e.pets.map((t=>{var o;return d(a({},t),{isDefault:t._id===(null==(o=e.currentPet)?void 0:o._id)})}))}catch(t){console.error("Failed to load pets:",t),c.index.showToast({title:"加载宠物信息失败",icon:"none"})}}));return c.onMounted((()=>{t.isLoggedIn?i():c.index.redirectTo({url:"/pages/login/login"})})),{pets:o,navToAdd:()=>{if(console.log("开始导航到添加宠物页面"),!t.isAuthenticated)return console.error("用户未登录，无法添加宠物"),c.index.showToast({title:"请先登录",icon:"none"}),void setTimeout((()=>{c.index.navigateTo({url:"/pages/login/login"})}),1500);c.index.navigateTo({url:"/pages/pet/edit?mode=add",success:e=>{console.log("导航到添加宠物页面成功",e)},fail:e=>{console.error("导航到添加宠物页面失败:",e),c.index.navigateTo({url:"/pages/pet/edit",success:()=>{console.log("使用简化路径导航成功")},fail:e=>{console.error("使用简化路径仍然失败:",e),c.index.showToast({title:"页面跳转失败",icon:"none"})}})}})},navToDetail:e=>{c.index.navigateTo({url:`/pages/pet/edit?petId=${e}&mode=edit`})},navToEdit:e=>{console.log("Navigating to edit pet with ID:",e),c.index.navigateTo({url:`/pages/pet/edit?petId=${e}&mode=edit`,success:()=>{console.log("Navigation successful")},fail:e=>{console.error("Navigation failed:",e)}})},deletePet:t=>l(this,null,(function*(){try{c.index.showLoading({title:"删除中..."});const o=yield p.api.pet.deletePet(t._id||t.id);if(c.index.hideLoading(),!o||!o.success)throw new Error(o.message||"删除失败");e.deletePet(t._id),c.index.showToast({title:"删除成功",icon:"success"})}catch(o){c.index.hideLoading(),console.error("Failed to delete pet:",o),c.index.showToast({title:o.message||"删除失败",icon:"none"})}})),setDefault:(t,i=!1)=>l(this,null,(function*(){try{c.index.showLoading({title:"设置中..."});const n=yield p.api.pet.updatePet(t._id,{isDefault:!0});if(c.index.hideLoading(),!n||!n.success)throw new Error(n.message||"设置失败");o.value=o.value.map((e=>d(a({},e),{isDefault:e._id===t._id}))),e.setCurrentPet(t),i||c.index.showToast({title:`已将"${t.name}"设为默认宠物`,icon:"success"})}catch(n){c.index.hideLoading(),console.error("Failed to set default pet:",n),i||c.index.showToast({title:n.message||"设置失败，请重试",icon:"none"})}})),calculatePetAge:e=>{if(!e)return"未知年龄";const t=new Date(e),o=new Date,i=12*(o.getFullYear()-t.getFullYear())+(o.getMonth()-t.getMonth());if(i<12)return`${i}个月`;{const e=Math.floor(i/12),t=i%12;return t>0?`${e}岁${t}个月`:`${e}岁`}},formatImageUrl:e=>{if(!e)return"/static/images/default-pet.png";if(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("/static/"))return e;if(e.startsWith("/uploads")){return(c.index.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}if(e.startsWith("uploads/")){return(c.index.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+"/"+e}return"/static/images/default-pet.png"}}}};const v=c._export_sfc(f,[["render",function(e,t,o,i,n,r){return c.e({a:c.o(((...e)=>i.navToAdd&&i.navToAdd(...e))),b:0===i.pets.length},0===i.pets.length?{c:h._imports_0$1,d:c.o(((...e)=>i.navToAdd&&i.navToAdd(...e)))}:{e:c.f(i.pets,((e,t,o)=>c.e({a:i.formatImageUrl(e.avatar),b:c.t(e.name),c:c.t("male"===e.gender?"♂":"♀"),d:c.n(e.gender),e:c.t(e.breed),f:c.t(i.calculatePetAge(e.birthdate)),g:e.isDefault},(e.isDefault,{}),{h:e._id,i:c.o((t=>i.navToEdit(e._id||e.id)),e._id)})))})}],["__scopeId","data-v-24c84d65"]]);wx.createPage(v);
