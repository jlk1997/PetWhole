"use strict";var e=Object.defineProperty,t=Object.defineProperties,o=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,i=(t,o,a)=>o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[o]=a,s=(e,t,o)=>new Promise(((a,l)=>{var n=e=>{try{s(o.next(e))}catch(t){l(t)}},i=e=>{try{s(o.throw(e))}catch(t){l(t)}},s=e=>e.done?a(e.value):Promise.resolve(e.value).then(n,i);s((o=o.apply(e,t)).next())}));const r=require("../../common/vendor.js"),u=require("../../store/pet.js"),c=require("../../utils/ui.js"),d={__name:"edit",props:{petId:{type:String,default:""},mode:{type:String,default:"add"}},setup(e){const d=u.usePetStore(),h=r.ref(!1),v=e,g=r.ref({name:"",breed:"",gender:"male",age:"",weight:"",description:"",avatar:"",socialIntention:"medium",matingStatus:"notLooking",dailyPhotos:[]}),p=r.ref(""),m=r.ref("add"),f=r.computed((()=>g.value.name&&g.value.breed));function y(){r.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:e=>s(this,null,(function*(){r.index.showLoading({title:"处理图片中..."});try{if(g.value.avatar=e.tempFilePaths[0],"edit"===v.mode&&p.value){console.log("上传宠物头像:",p.value,e.tempFilePaths[0]);try{const t=yield d.uploadPetAvatar(p.value,e.tempFilePaths[0]);if(console.log("头像上传结果:",t),!(t&&t.success&&t.data&&t.data.pet))throw new Error("头像上传响应格式不正确");{const e=t.data.pet.avatar;if(!e)throw new Error("返回的头像URL为空");g.value.avatar=T(e),r.index.showToast({title:"头像上传成功",icon:"success"})}}catch(t){console.error("头像上传处理失败:",t),r.index.showToast({title:"头像上传失败，将在保存时再次尝试",icon:"none"})}}}catch(o){console.error("头像上传失败:",o),r.index.showToast({title:"头像上传失败",icon:"none"})}finally{r.index.hideLoading()}})),fail:e=>{console.error("选择图片失败:",e),r.index.showToast({title:"选择图片失败",icon:"none"})}})}function w(){g.value.dailyPhotos.length>=3?c.showToast({title:"最多只能上传3张照片",icon:"none"}):r.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:e=>{r.index.showLoading({title:"处理图片中..."});try{const t={url:e.tempFilePaths[0],uploadDate:new Date,description:""};g.value.dailyPhotos.push(t),r.index.hideLoading(),c.showToast({title:"已添加照片",icon:"success"}),console.log("已添加临时照片:",t)}catch(t){console.error("添加照片失败:",t),r.index.hideLoading(),c.showToast({title:"添加照片失败",icon:"none"})}}})}function P(e){console.error("照片加载失败:",e.target),e.target.src="/static/images/default-pet.png"}function b(){return s(this,null,(function*(){if(f.value){h.value=!0,c.showLoading("保存中...");try{const o={name:g.value.name,breed:g.value.breed,gender:g.value.gender,age:g.value.age?parseInt(g.value.age):null,weight:g.value.weight?parseFloat(g.value.weight):null,description:g.value.description,socialIntention:g.value.socialIntention,matingStatus:g.value.matingStatus},a=g.value.avatar;let l,n=a&&a.startsWith("blob:"),i=[];if(g.value.dailyPhotos&&g.value.dailyPhotos.length>0){i=g.value.dailyPhotos.filter((e=>e.url&&(e.url.startsWith("blob:")||e.url.startsWith("file:"))));const e=g.value.dailyPhotos.filter((e=>e.url&&!e.url.startsWith("blob:")&&!e.url.startsWith("file:")));o.dailyPhotos=e}if("edit"===m.value&&p.value){if(console.log("更新宠物信息:",p.value,o),l=yield d.updatePet(p.value,o),n){console.log("更新模式: 单独上传头像",a);try{yield d.uploadPetAvatar(p.value,a)}catch(e){console.error("头像上传失败:",e)}}if(i.length>0)try{for(const e of i){const t=yield d.uploadPetDailyPhoto(p.value,e.url);console.log("日常照片上传结果:",t),t&&t.data&&t.data.photo&&t.data.photo.url&&console.log("服务器返回的照片URL:",t.data.photo.url)}}catch(t){console.error("日常照片上传失败:",t)}c.showToast({title:"宠物信息已更新",icon:"success"})}else{if(console.log("添加新宠物:",o),l=yield d.addPet(o),!l||!l._id)throw new Error("添加宠物失败，未返回宠物ID");{const o=l._id;if(n){console.log("添加模式: 上传头像",a);try{yield d.uploadPetAvatar(o,a)}catch(e){console.error("头像上传失败:",e)}}if(i.length>0)try{for(const e of i){const t=yield d.uploadPetDailyPhoto(o,e.url);console.log("新增模式 - 日常照片上传结果:",t),t&&t.data&&t.data.photo&&t.data.photo.url&&console.log("服务器返回的照片URL:",t.data.photo.url)}}catch(t){console.error("日常照片上传失败:",t)}c.showToast({title:"宠物添加成功",icon:"success"})}}yield d.fetchPets(),setTimeout((()=>{c.navigateBack()}),1500)}catch(o){console.error("保存宠物信息失败:",o),c.showToast({title:"保存失败: "+(o.message||"未知错误"),icon:"none"})}finally{h.value=!1,c.hideLoading()}}else c.showToast("请填写必填项")}))}function I(){return s(this,null,(function*(){p.value?c.showModal({title:"删除宠物",content:"确定要删除这只宠物吗？此操作不可逆。",showCancel:!0}).then((e=>s(this,null,(function*(){if(e){h.value=!0,c.showLoading("删除中...");try{console.log("删除宠物:",p.value),yield d.deletePet(p.value),c.showToast({title:"宠物已删除",icon:"success"}),setTimeout((()=>{c.navigateBack()}),1500)}catch(t){console.error("删除宠物失败:",t),c.showToast({title:t.message||"删除失败，请重试",icon:"none"})}finally{h.value=!1,c.hideLoading()}}})))):c.showToast("无效的宠物ID")}))}function T(e){if(!e)return"/static/images/default-pet.png";if(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("/static/")||e.startsWith("file://"))return e;if(e.startsWith("/uploads")){return(r.index.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}if(e.startsWith("uploads/")){return(r.index.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+"/"+e}return"/static/images/default-pet.png"}return r.onMounted((()=>s(this,null,(function*(){console.log("组件加载，参数:",v);const e=getCurrentPages(),r=e[e.length-1].options||{};console.log("页面参数:",r);const u=v.petId||r.petId||r.id;m.value=v.mode||r.mode||"add","add"!==m.value&&"edit"!==m.value&&(console.warn("无效的模式参数:",m.value,'重置为默认值"add"'),m.value="add"),console.log("解析参数:",{petId:u,mode:m.value}),p.value=u,document.title="add"===m.value?"添加宠物":"编辑宠物","edit"===m.value&&u?yield function(e){return s(this,null,(function*(){if(e){h.value=!0,c.showLoading("加载宠物信息...");try{console.log("获取宠物数据:",e);const s=yield d.getPetById(e);s?(console.log("获取到宠物数据:",s),g.value={name:s.name||"",breed:s.breed||"",gender:s.gender||"male",age:s.age||"",weight:s.weight||"",description:s.description||"",avatar:T(s.avatar)||"/static/images/default-pet.png",socialIntention:s.socialIntention||"medium",matingStatus:s.matingStatus||"notLooking",dailyPhotos:Array.isArray(s.dailyPhotos)?s.dailyPhotos.map((e=>{return s=((e,t)=>{for(var o in t||(t={}))l.call(t,o)&&i(e,o,t[o]);if(a)for(var o of a(t))n.call(t,o)&&i(e,o,t[o]);return e})({},e),r={url:T(e.url)},t(s,o(r));var s,r})):[]}):(console.error("未找到宠物:",e),c.showToast({title:"未找到宠物信息",icon:"none"}))}catch(s){console.error("获取宠物信息失败:",s),c.showToast({title:"获取宠物信息失败",icon:"none"})}finally{h.value=!1,c.hideLoading()}}}))}(u):(console.log("添加模式，使用默认表单数据"),g.value={name:"",breed:"",gender:"male",age:"",weight:"",description:"",avatar:"/static/images/default-pet.png",socialIntention:"medium",matingStatus:"notLooking",dailyPhotos:[]})})))),(e,t)=>r.e({a:r.t("add"===m.value?"添加宠物":"编辑宠物"),b:g.value.avatar||"/static/images/default-pet.png",c:r.o(y),d:g.value.name,e:r.o((e=>g.value.name=e.detail.value)),f:g.value.breed,g:r.o((e=>g.value.breed=e.detail.value)),h:"male"===g.value.gender?1:"",i:r.o((e=>g.value.gender="male")),j:"female"===g.value.gender?1:"",k:r.o((e=>g.value.gender="female")),l:g.value.age,m:r.o((e=>g.value.age=e.detail.value)),n:g.value.weight,o:r.o((e=>g.value.weight=e.detail.value)),p:"strong"===g.value.socialIntention?1:"",q:r.o((e=>g.value.socialIntention="strong")),r:"medium"===g.value.socialIntention?1:"",s:r.o((e=>g.value.socialIntention="medium")),t:"mild"===g.value.socialIntention?1:"",v:r.o((e=>g.value.socialIntention="mild")),w:"single"===g.value.matingStatus?1:"",x:r.o((e=>g.value.matingStatus="single")),y:"paired"===g.value.matingStatus?1:"",z:r.o((e=>g.value.matingStatus="paired")),A:"notLooking"===g.value.matingStatus?1:"",B:r.o((e=>g.value.matingStatus="notLooking")),C:r.f(g.value.dailyPhotos,((e,t,o)=>({a:e.url,b:r.o(P,t),c:r.o((e=>function(e){e>=0&&e<g.value.dailyPhotos.length&&(g.value.dailyPhotos.splice(e,1),c.showToast({title:"已删除照片",icon:"success"}))}(t)),t),d:t}))),D:g.value.dailyPhotos.length<3},g.value.dailyPhotos.length<3?{E:r.o(w)}:{},{F:g.value.description,G:r.o((e=>g.value.description=e.detail.value)),H:r.t(h.value?"处理中...":"保 存"),I:!f.value||h.value,J:h.value?1:"",K:r.o(b),L:"edit"===m.value},"edit"===m.value?{M:h.value,N:r.o(I)}:{})}};wx.createPage(d);
