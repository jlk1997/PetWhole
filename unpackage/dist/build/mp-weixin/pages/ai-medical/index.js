"use strict";var e=(e,t,n)=>new Promise(((a,r)=>{var i=e=>{try{s(n.next(e))}catch(t){r(t)}},o=e=>{try{s(n.throw(e))}catch(t){r(t)}},s=e=>e.done?a(e.value):Promise.resolve(e.value).then(i,o);s((n=n.apply(e,t)).next())}));const t=require("../../common/vendor.js"),n=require("../../utils/vetmewProxy.js"),a={setup(){const a=t.ref([]),r=t.ref(""),i=t.ref(!1),o=t.ref(0),s=t.ref(!1),l=t.ref(""),c=t.ref(""),u=t.ref(""),d=t.ref(""),g=t.ref(0),p=t.computed((()=>{const e="undefined"!=typeof window&&"undefined"!=typeof document,n=void 0!==t.index&&void 0===t.index.requireNativePlugin;try{const a=t.index.getSystemInfoSync(),r=a.platform,i=a.uniPlatform;return console.log("环境检测 - 平台:",r,"设备:",a.model,"uni平台:",i),console.log("是否H5环境:",e,"是否UniApp H5:",n),e||"web"===r||"web"===i}catch(a){return console.error("获取系统信息失败:",a),e}})),v=[{name:"问诊服务",path:"/open/v1/chat",requiresPetInfo:!0,requiresImage:!1,isConsultation:!0},{name:"品种识别",path:"/open/v1/breed-recognition",requiresPetInfo:!1,requiresImage:!0,isConsultation:!1},{name:"情绪分析",path:"/open/v1/emotion-recognition",requiresPetInfo:!1,requiresImage:!0,isConsultation:!1},{name:"粪便分析",path:"/open/v1/feces-recognition",requiresPetInfo:!0,requiresImage:!0,isConsultation:!1},{name:"皮肤分析",path:"/open/v1/skin-recognition",requiresPetInfo:!0,requiresImage:!0,isConsultation:!1},{name:"尿液分析",path:"/open/v1/urine-recognition",requiresPetInfo:!0,requiresImage:!0,isConsultation:!1},{name:"呕吐物分析",path:"/open/v1/vomitus-recognition",requiresPetInfo:!0,requiresImage:!0,isConsultation:!1},{name:"耳道分析",path:"/open/v1/ear-canal-recognition",requiresPetInfo:!0,requiresImage:!0,isConsultation:!1}],h=t.computed((()=>v[g.value])),m=t.computed((()=>h.value.isConsultation)),f=["狗","猫"],y=t.ref(0),I={"狗":1,"猫":2},x=["公","母"],P=t.ref(0),b={"公":1,"母":2},S=["未绝育","已绝育"],w=t.ref(0),T={"未绝育":1,"已绝育":2},C=t.reactive({nick_name:"",breed:1,birth:"2023-01-01",gender:1,fertility:1}),k="vmb1c7f72adc9473f7",U="44yth8axrytm8ux23f53c78bjw3kg20h",q=(e,t)=>{a.value.push({type:"user",content:"图片消息",imageUrl:e}),O(),M(t,e)},A=e=>new Promise(((n,a)=>{if(p.value)return console.log("检测到H5环境，不转换base64，使用URL方式"),void n("");try{if("function"!=typeof t.index.getFileSystemManager)return console.warn("getFileSystemManager不可用，使用URL方式"),void n("");t.index.getFileSystemManager().readFile({filePath:e,encoding:"base64",success:e=>{console.log("base64转换成功"),n(e.data)},fail:e=>{console.error("读取图片失败:",e),n("")}})}catch(r){console.error("转换base64发生错误:",r),n("")}})),F=()=>e(this,null,(function*(){i.value=!0,c.value&&(a.value.push({type:"user",content:"图片分析请求",imageUrl:c.value}),O());try{const r={};if(u.value)r.image=u.value;else if(c.value){if(!c.value.startsWith("http"))return t.index.showToast({title:"图片格式不支持，请提供有效URL",icon:"none"}),void(i.value=!1);r.url=c.value}h.value.requiresPetInfo&&(Object.assign(r,{breed:C.breed,birth:C.birth,gender:C.gender,fertility:C.fertility}),"品种识别"!==h.value.name&&"情绪分析"!==h.value.name&&(r.nick_name=C.nick_name)),console.log("准备发送分析请求:",r);const o=yield n.callVetmewAPI(r,{apiKey:k,apiSecret:U,apiPath:h.value.path});if(console.log("API响应:",o),o&&0===o.code){let t="";if("string"==typeof o.data)try{const e=JSON.parse(o.data);t=_(e,h.value.name)}catch(e){t=o.data||"分析完成"}else t=_(o.data,h.value.name);a.value.push({type:"ai",content:t})}else R(o)}catch(r){console.error("API调用异常:",r),a.value.push({type:"ai",content:"网络连接失败，请检查您的网络后重试。"})}finally{i.value=!1,O()}})),_=(e,t)=>{if(!e)return"分析完成";if("string"==typeof e)return e;if(e.text)return e.text;try{if(Array.isArray(e)&&e.length>0&&e[0].text)return e[0].text;if(e.contents){if("string"==typeof e.contents)return e.contents;if(Array.isArray(e.contents)&&e.contents.length>0)return e.contents.map((e=>e.text||e.content||JSON.stringify(e))).join("\n")}if(e.content)return e.content}catch(n){console.error("解析嵌套JSON出错:",n)}switch(t){case"品种识别":if(e.breed)return`识别结果：${e.breed}\n可信度：${(100*e.confidence).toFixed(2)}%`;break;case"情绪分析":if(e.emotion)return`情绪分析结果：${e.emotion}\n可信度：${(100*e.confidence).toFixed(2)}%`;break;case"粪便分析":case"皮肤分析":case"尿液分析":case"呕吐物分析":case"耳道分析":let t="";return e.conclusion&&(t+=`诊断结论：${e.conclusion}\n\n`),e.analysis&&(t+=`详细分析：${e.analysis}\n\n`),e.suggestion&&(t+=`建议：${e.suggestion}`),t||L(e)}return L(e)},L=e=>{try{let n,a="string"==typeof e?e:JSON.stringify(e);try{n="object"==typeof e?e:JSON.parse(a)}catch(t){return a}if(n.text)return n.text;if(n.message)return n.message;if(n.content)return n.content;if(n.data)return L(n.data);if(n.choices&&Array.isArray(n.choices)&&n.choices.length>0){const e=n.choices[0];if(e.text)return e.text;if(e.message&&e.message.content)return e.message.content}return a=JSON.stringify(n,null,2),a=a.replace(/^{|}$/g,""),a=a.replace(/^\s*"([^"]+)":\s*/gm,"$1: "),a=a.replace(/,$/gm,""),a=a.replace(/"msg_id":[^,}]+,?/g,""),a}catch(t){return console.error("清理JSON出错:",t),"分析完成，请查看结果"}},M=(r,o="")=>e(this,null,(function*(){if(!i.value){i.value=!0;try{const s={breed:C.breed,birth:C.birth,gender:C.gender,nick_name:C.nick_name,fertility:C.fertility};if(r&&r.length>0)s.image=r;else if(o&&o.startsWith("http"))s.url=o;else{if(!c.value||!c.value.startsWith("http"))return t.index.showToast({title:"无法处理图片，请尝试输入URL",icon:"none"}),void(i.value=!1);s.url=c.value}l.value&&(s.conversation_id=l.value),console.log("准备发送图片请求");const u=yield n.callVetmewAPI(s,{apiKey:k,apiSecret:U,apiPath:h.value.path});if(console.log("API响应:",u),u&&0===u.code){u.conversation_id&&(l.value=u.conversation_id);let t="";if("string"==typeof u.data)try{const e=JSON.parse(u.data);t=_(e,h.value.name)}catch(e){t=u.data||"我已分析您上传的图片..."}else t=_(u.data,h.value.name);a.value.push({type:"ai",content:t})}else R(u)}catch(s){console.error("图片API调用异常:",s),a.value.push({type:"ai",content:"图片处理失败，请稍后重试。"})}finally{i.value=!1,O()}}})),R=e=>{let t="抱歉，我遇到了一些问题，请稍后再试。";if(e&&e.code)switch(e.code){case 6001:t="无效的API密钥，请联系管理员。";break;case 6002:t="调用过于频繁，请稍后再试。";break;case 6003:t="调用次数不足，请联系管理员。";break;case 6004:case 6005:t="签名验证失败，请联系管理员。";break;case 6006:t="请求参数无效，请检查输入。";break;case 6007:t="会话已结束，请重新开始对话。";break;case 6008:t="系统正忙，请稍后再试。";break;case 6009:t="您的输入包含敏感词汇，请调整后重试。";break;case 9999:e.rawResponse?(console.log("原始错误响应:",e.rawResponse),t=e.rawResponse.includes("<!DOCTYPE html>")?"服务器返回了HTML页面而不是API响应，可能是代理配置错误或服务器异常。":"服务器返回格式错误，请联系管理员。"):t=`服务器连接失败: ${e.message}`;break;default:t=`服务器返回错误: ${e.code||"未知错误"}`}a.value.push({type:"ai",content:t}),console.error("API请求错误:",e)},O=()=>{t.nextTick$1((()=>{o.value=999999}))};return{messages:a,inputMessage:r,isLoading:i,scrollTop:o,chatStarted:s,petInfo:C,petTypes:f,petTypeIndex:y,genders:x,genderIndex:P,fertilityOptions:S,fertilityIndex:w,imageUrl:c,imageUrlInput:d,isH5Platform:p,serviceTypes:v,selectedServiceIndex:g,currentService:h,isConsultationService:m,goBack:()=>{t.index.navigateBack()},sendMessage:()=>e(this,null,(function*(){if(!r.value.trim()||i.value||!m.value)return;const e=r.value.trim();r.value="",a.value.push({type:"user",content:e}),O(),i.value=!0;try{const r={msg:e,breed:C.breed,birth:C.birth,gender:C.gender,nick_name:C.nick_name,fertility:C.fertility};l.value&&(r.conversation_id=l.value,console.log("使用现有会话ID继续对话:",l.value)),console.log("准备发送请求:",r);const i=yield n.callVetmewAPI(r,{apiKey:k,apiSecret:U,apiPath:h.value.path});if(console.log("API响应:",i),i&&0===i.code){i.conversation_id&&(l.value=i.conversation_id,console.log("保存会话ID:",l.value));let e="";if("string"==typeof i.data)try{const t=JSON.parse(i.data);e=_(t,h.value.name)}catch(t){e=i.data||"我正在分析您的问题..."}else e=_(i.data,h.value.name);a.value.push({type:"ai",content:e})}else R(i)}catch(o){console.error("API调用异常:",o),a.value.push({type:"ai",content:"网络连接失败，请检查您的网络后重试。"})}finally{i.value=!1,O()}})),loadMoreHistory:()=>{},onPetTypeChange:e=>{y.value=e.detail.value,C.breed=I[f[y.value]]},onBirthChange:e=>{C.birth=e.detail.value},onGenderChange:e=>{P.value=e.detail.value,C.gender=b[x[P.value]]},onFertilityChange:e=>{w.value=e.detail.value,C.fertility=T[S[w.value]]},startChat:()=>{!h.value.requiresPetInfo||C.nick_name?!h.value.requiresImage||u.value?(s.value=!0,m.value?a.value.push({type:"ai",content:`您好！我是您的AI宠物医生助手。请问${C.nick_name}有什么健康问题呢？我会尽力帮助您。`}):F()):t.index.showToast({title:"请上传图片",icon:"none"}):t.index.showToast({title:"请输入宠物昵称",icon:"none"})},selectService:e=>{g.value=e},chooseImage:()=>e(this,null,(function*(){try{const n=yield t.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"]});if(n.tempFilePaths&&n.tempFilePaths.length>0)if(c.value=n.tempFilePaths[0],d.value="",p.value)try{const e=yield t.index.chooseFile({count:1,extension:[".png",".jpg",".jpeg"],type:"image"});if(e.tempFiles&&e.tempFiles.length>0){const n=e.tempFiles[0],a=new FileReader;a.onload=e=>{const t=e.target.result.split(",")[1];u.value=t},a.onerror=()=>{console.error("读取文件失败"),t.index.showToast({title:"图片读取失败，请尝试输入URL",icon:"none"})},a.readAsDataURL(n)}}catch(e){console.error("H5环境下获取文件失败:",e),t.index.showToast({title:"H5环境下请使用图片URL或使用App版本",icon:"none"})}else{const e=yield A(n.tempFilePaths[0]);u.value=e}}catch(n){console.error("选择图片失败:",n),t.index.showToast({title:"选择图片失败，请尝试其他方式",icon:"none"})}})),chooseAdditionalImage:()=>e(this,null,(function*(){if(!i.value)try{const n=yield t.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"]});if(n.tempFilePaths&&n.tempFilePaths.length>0){const a=n.tempFilePaths[0];let r="";if(p.value)try{const e=yield t.index.chooseFile({count:1,extension:[".png",".jpg",".jpeg"],type:"image"});if(e.tempFiles&&e.tempFiles.length>0){const t=e.tempFiles[0],n=new FileReader;return n.onload=e=>{r=e.target.result.split(",")[1],q(a,r)},n.onerror=()=>{console.error("读取文件失败"),q(a,"")},void n.readAsDataURL(t)}}catch(e){return console.error("H5环境下获取文件失败:",e),void q(a,"")}else r=yield A(a);q(a,r)}}catch(n){console.error("选择图片失败:",n),t.index.showToast({title:"选择图片失败",icon:"none",duration:2e3})}})),previewUrlImage:()=>{d.value&&(d.value.startsWith("http")?(c.value=d.value,u.value="",t.index.showToast({title:"图片URL已设置",icon:"success"})):t.index.showToast({title:"请输入有效的图片URL",icon:"none"}))}}}};const r=t._export_sfc(a,[["render",function(e,n,a,r,i,o){return t.e({a:t.o(((...e)=>r.goBack&&r.goBack(...e))),b:!r.chatStarted},r.chatStarted?{}:{c:t.f(r.serviceTypes,((e,n,a)=>({a:t.t(e.name),b:n,c:r.selectedServiceIndex===n?1:"",d:t.o((e=>r.selectService(n)),n)})))},{d:!r.chatStarted},r.chatStarted?{}:t.e({e:t.t(r.serviceTypes[r.selectedServiceIndex].name),f:r.currentService.requiresPetInfo},r.currentService.requiresPetInfo?{g:r.petInfo.nick_name,h:t.o((e=>r.petInfo.nick_name=e.detail.value)),i:t.t(r.petTypes[r.petTypeIndex]),j:t.o(((...e)=>r.onPetTypeChange&&r.onPetTypeChange(...e))),k:r.petTypeIndex,l:r.petTypes,m:t.t(r.petInfo.birth||"请选择出生日期"),n:r.petInfo.birth,o:t.o(((...e)=>r.onBirthChange&&r.onBirthChange(...e))),p:t.t(r.genders[r.genderIndex]),q:t.o(((...e)=>r.onGenderChange&&r.onGenderChange(...e))),r:r.genderIndex,s:r.genders,t:t.t(r.fertilityOptions[r.fertilityIndex]),v:t.o(((...e)=>r.onFertilityChange&&r.onFertilityChange(...e))),w:r.fertilityIndex,x:r.fertilityOptions}:{},{y:r.currentService.requiresImage},r.currentService.requiresImage?t.e({z:r.imageUrl},r.imageUrl?{A:r.imageUrl}:{},{B:t.o(((...e)=>r.chooseImage&&r.chooseImage(...e))),C:r.isH5Platform},r.isH5Platform?t.e({D:r.imageUrlInput,E:t.o((e=>r.imageUrlInput=e.detail.value)),F:r.imageUrlInput},r.imageUrlInput?{G:t.o(((...e)=>r.previewUrlImage&&r.previewUrlImage(...e)))}:{}):{}):{},{H:t.t(r.currentService.name),I:t.o(((...e)=>r.startChat&&r.startChat(...e)))}),{J:r.chatStarted},r.chatStarted?t.e({K:t.f(r.messages,((e,n,a)=>t.e({a:e.imageUrl},e.imageUrl?{b:e.imageUrl}:{},{c:t.t(e.content),d:n,e:t.n(e.type)}))),L:r.scrollTop,M:t.o(((...e)=>r.loadMoreHistory&&r.loadMoreHistory(...e))),N:t.o(((...e)=>r.sendMessage&&r.sendMessage(...e))),O:r.isLoading||!r.isConsultationService,P:r.inputMessage,Q:t.o((e=>r.inputMessage=e.detail.value)),R:t.t(r.isLoading?"⌛":"➤"),S:t.o(((...e)=>r.sendMessage&&r.sendMessage(...e))),T:r.isLoading||!r.isConsultationService?1:"",U:r.isConsultationService},r.isConsultationService?{V:t.o(((...e)=>r.chooseAdditionalImage&&r.chooseAdditionalImage(...e)))}:{}):{})}]]);wx.createPage(r);
