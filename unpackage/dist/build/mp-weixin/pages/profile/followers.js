"use strict";var e=Object.defineProperty,o=Object.defineProperties,s=Object.getOwnPropertyDescriptors,t=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,r=(o,s,t)=>s in o?e(o,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[s]=t,n=(e,o)=>{for(var s in o||(o={}))i.call(o,s)&&r(e,s,o[s]);if(t)for(var s of t(o))l.call(o,s)&&r(e,s,o[s]);return e},a=(e,t)=>o(e,s(t)),u=(e,o,s)=>new Promise(((t,i)=>{var l=e=>{try{n(s.next(e))}catch(o){i(o)}},r=e=>{try{n(s.throw(e))}catch(o){i(o)}},n=e=>e.done?t(e.value):Promise.resolve(e.value).then(l,r);n((s=s.apply(e,o)).next())}));const c=require("../../common/vendor.js"),p=require("../../store/user.js"),f=require("../../utils/api.js"),g=require("../../common/assets.js"),d={components:{UserInfoPopup:()=>"../../components/map/UserInfoPopup.js"},setup(){const e=p.useUserStore(),o=c.ref(!0),s=c.ref([]),t=c.ref(!1),i=c.ref(null),l=c.ref([]),r=c.ref(!1),g=c.ref(!1);c.onMounted((()=>u(this,null,(function*(){yield d()}))));const d=()=>u(this,null,(function*(){o.value=!0,g.value=!1;try{if(!e.isAuthenticated)return void c.index.navigateTo({url:"/pages/login/login"});const t=e.userId||c.index.getStorageSync("userId");if(!t)return c.index.showToast({title:"无法获取用户信息",icon:"none"}),void(o.value=!1);const i=yield f.api.user.getFollowers(t);console.log("Followers list:",i),s.value=i;const l=(yield e.fetchUserInfo()).following||[];s.value=s.value.map((e=>a(n({},e),{isFollowing:l.some((o=>o===e._id||o._id&&o._id===e._id))})))}catch(t){console.error("Failed to load followers:",t),o.value=!1,g.value=!0,c.index.showToast({title:"加载失败，请重试",icon:"none"})}finally{o.value=!1}})),w=o=>u(this,null,(function*(){if(e.isAuthenticated)try{const s=yield f.api.user.followUser(o._id);s&&void 0!==s.isFollowing&&(o.isFollowing=s.isFollowing,c.index.showToast({title:o.isFollowing?"关注成功":"取消关注成功",icon:"success"}),yield e.fetchUserStats())}catch(s){console.error("关注操作失败:",s),c.index.showToast({title:"操作失败，请重试",icon:"none"})}else c.index.navigateTo({url:"/pages/login/login"})}));return{isLoading:o,followersList:s,goBack:()=>{c.index.navigateBack()},shareApp:()=>{c.index.showToast({title:"分享功能开发中",icon:"none"})},toggleFollow:w,viewUserProfile:o=>u(this,null,(function*(){i.value=a(n({},o),{isCurrentUser:e.userId===o._id});try{const e=yield f.api.user.getPetsByUser(o._id);l.value=e||[],r.value=o.isFollowing||!1,t.value=!0}catch(s){console.error("获取用户详情失败:",s),l.value=[],t.value=!0}})),formatAvatarUrl:e=>{if(!e)return"/static/images/default-avatar.png";if(e.startsWith("http")||e.startsWith("/static"))return e;if(e.startsWith("/uploads")){return(c.index.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}return"/static/images/default-avatar.png"},showUserPopup:t,selectedUser:i,selectedUserPets:l,isUserFollowing:r,closeUserPopup:()=>{t.value=!1},messageUser:e=>{console.log("发送消息给用户:",e)},followUser:e=>u(this,null,(function*(){yield w(e),r.value=e.isFollowing||!1})),isRetryVisible:g}}};if(!Array){(c.resolveComponent("uni-nav-bar")+c.resolveComponent("uni-icons")+c.resolveComponent("UserInfoPopup"))()}const w=c._export_sfc(d,[["render",function(e,o,s,t,i,l){return c.e({a:c.o(t.goBack),b:c.p({"left-icon":"back",title:"粉丝列表"}),c:t.isLoading},t.isLoading?{d:c.p({type:"spinner-cycle",size:"24",color:"#ff5f15"})}:t.isRetryVisible?{f:c.o(((...o)=>e.loadFollowersList&&e.loadFollowersList(...o)))}:0===t.followersList.length?{h:g._imports_0$5}:c.e({i:!t.isLoading&&t.followersList.length>0},!t.isLoading&&t.followersList.length>0?{j:c.f(t.followersList,((e,o,s)=>c.e({a:t.formatAvatarUrl(e.avatar),b:c.t(e.username||e.nickname||"用户"),c:e.bio},e.bio?{d:c.t(e.bio)}:{},{e:c.t(e.isFollowing?"已关注":"关注"),f:e.isFollowing?1:"",g:c.o((o=>t.toggleFollow(e)),o),h:o,i:c.o((o=>t.viewUserProfile(e)),o)})))}:{}),{e:t.isRetryVisible,g:0===t.followersList.length,k:t.showUserPopup},t.showUserPopup?{l:c.o(t.closeUserPopup),m:c.o(t.messageUser),n:c.o(t.followUser),o:c.p({user:t.selectedUser,pets:t.selectedUserPets,"is-following":t.isUserFollowing,visible:t.showUserPopup})}:{})}]]);wx.createPage(w);
