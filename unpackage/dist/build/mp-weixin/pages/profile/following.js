"use strict";var e=Object.defineProperty,o=Object.defineProperties,i=Object.getOwnPropertyDescriptors,t=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,r=(o,i,t)=>i in o?e(o,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[i]=t,n=(e,o)=>{for(var i in o||(o={}))s.call(o,i)&&r(e,i,o[i]);if(t)for(var i of t(o))l.call(o,i)&&r(e,i,o[i]);return e},a=(e,t)=>o(e,i(t)),u=(e,o,i)=>new Promise(((t,s)=>{var l=e=>{try{n(i.next(e))}catch(o){s(o)}},r=e=>{try{n(i.throw(e))}catch(o){s(o)}},n=e=>e.done?t(e.value):Promise.resolve(e.value).then(l,r);n((i=i.apply(e,o)).next())}));const c=require("../../common/vendor.js"),g=require("../../store/user.js"),p=require("../../utils/api.js"),f=require("../../common/assets.js"),d={components:{UserInfoPopup:()=>"../../components/map/UserInfoPopup.js"},setup(){const e=g.useUserStore(),o=c.ref(!0),i=c.ref([]),t=c.ref(!1),s=c.ref(null),l=c.ref([]),r=c.ref(!1),f=c.ref(!1);c.onMounted((()=>u(this,null,(function*(){yield d()}))));const d=()=>u(this,null,(function*(){o.value=!0,f.value=!1;try{if(!e.isAuthenticated)return void c.index.navigateTo({url:"/pages/login/login"});const t=e.userId||c.index.getStorageSync("userId");if(!t)return c.index.showToast({title:"无法获取用户信息",icon:"none"}),void(o.value=!1);const s=yield p.api.user.getFollowing(t);console.log("关注列表:",s),Array.isArray(s)?i.value=s.map((e=>a(n({},e),{isFollowing:!0}))):i.value=[]}catch(t){console.error("Failed to load following list:",t),o.value=!1,f.value=!0,c.index.showToast({title:"加载失败，请重试",icon:"none"})}finally{o.value=!1}})),w=o=>u(this,null,(function*(){if(e.isAuthenticated)try{const t=yield p.api.user.followUser(o._id);t&&void 0!==t.isFollowing&&(o.isFollowing=t.isFollowing,o.isFollowing||(i.value=i.value.filter((e=>e._id!==o._id))),c.index.showToast({title:o.isFollowing?"关注成功":"取消关注成功",icon:"success"}),yield e.fetchUserStats())}catch(t){console.error("关注操作失败:",t),c.index.showToast({title:"操作失败，请重试",icon:"none"})}else c.index.navigateTo({url:"/pages/login/login"})}));return{isLoading:o,followingList:i,goBack:()=>{c.index.navigateBack()},goExplore:()=>{c.index.switchTab({url:"/pages/community/community"})},toggleFollow:w,viewUserProfile:o=>u(this,null,(function*(){s.value=a(n({},o),{isCurrentUser:e.userId===o._id});try{const e=yield p.api.user.getPetsByUser(o._id);l.value=e||[],r.value=o.isFollowing||!1,t.value=!0}catch(i){console.error("获取用户详情失败:",i),l.value=[],t.value=!0}})),formatAvatarUrl:e=>{if(!e)return"/static/images/default-avatar.png";if(e.startsWith("http")||e.startsWith("/static"))return e;if(e.startsWith("/uploads")){return(c.index.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}return"/static/images/default-avatar.png"},showUserPopup:t,selectedUser:s,selectedUserPets:l,isUserFollowing:r,closeUserPopup:()=>{t.value=!1},messageUser:e=>{console.log("发送消息给用户:",e)},followUser:e=>u(this,null,(function*(){yield w(e),r.value=e.isFollowing||!1})),isRetryVisible:f,loadFollowingList:d}}};if(!Array){(c.resolveComponent("uni-nav-bar")+c.resolveComponent("uni-icons")+c.resolveComponent("UserInfoPopup"))()}const w=c._export_sfc(d,[["render",function(e,o,i,t,s,l){return c.e({a:c.o(t.goBack),b:c.p({"left-icon":"back",title:"我的关注"}),c:t.isLoading},t.isLoading?{d:c.p({type:"spinner-cycle",size:"24",color:"#ff5f15"})}:t.isRetryVisible?{f:c.o(((...e)=>t.loadFollowingList&&t.loadFollowingList(...e)))}:0===t.followingList.length?{h:f._imports_0$4,i:c.o(((...e)=>t.goExplore&&t.goExplore(...e)))}:c.e({j:!t.isLoading&&t.followingList.length>0},!t.isLoading&&t.followingList.length>0?{k:c.f(t.followingList,((e,o,i)=>c.e({a:t.formatAvatarUrl(e.avatar),b:c.t(e.username||e.nickname||"用户"),c:e.bio},e.bio?{d:c.t(e.bio)}:{},{e:c.t(e.isFollowing?"已关注":"关注"),f:e.isFollowing?1:"",g:c.o((o=>t.toggleFollow(e)),o),h:o,i:c.o((o=>t.viewUserProfile(e)),o)})))}:{}),{e:t.isRetryVisible,g:0===t.followingList.length,l:t.showUserPopup},t.showUserPopup?{m:c.o(t.closeUserPopup),n:c.o(t.messageUser),o:c.o(t.followUser),p:c.p({user:t.selectedUser,pets:t.selectedUserPets,"is-following":t.isUserFollowing,visible:t.showUserPopup})}:{})}]]);wx.createPage(w);
