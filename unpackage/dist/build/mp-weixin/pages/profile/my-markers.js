"use strict";var e=Object.defineProperty,t=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,l=(t,o,i)=>o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[o]=i,r=(e,r)=>{for(var a in r||(r={}))o.call(r,a)&&l(e,a,r[a]);if(t)for(var a of t(r))i.call(r,a)&&l(e,a,r[a]);return e},a=(e,t,o)=>new Promise(((i,l)=>{var r=e=>{try{s(o.next(e))}catch(t){l(t)}},a=e=>{try{s(o.throw(e))}catch(t){l(t)}},s=e=>e.done?i(e.value):Promise.resolve(e.value).then(r,a);s((o=o.apply(e,t)).next())}));const s=require("../../common/vendor.js"),n=require("../../common/assets.js"),u=require("../../stores/markerStore.js"),c=require("../../store/user.js"),d={__name:"my-markers",setup(e){const t=u.useMarkerStore(),o=c.useUserStore(),i=s.ref([]),l=s.ref(!0),d=s.ref(!1),p=s.ref(null),v=s.ref(!1),m=s.reactive({_id:"",title:"",description:"",type:"general",customTypeName:"",color:"#FF5733",isPublic:!0,latitude:0,longitude:0,radius:1,properties:{}}),y=["#FF5733","#33FF57","#3357FF","#FF33F5","#F5FF33","#33FFF5"],g=[{value:"general",label:"一般标记"},{value:"pet_friendly",label:"宠物友好"},{value:"danger",label:"危险区域"},{value:"scenic",label:"风景优美"},{value:"pet_service",label:"宠物服务"},{value:"custom",label:"自定义"}],f=()=>a(this,null,(function*(){var e,r;l.value=!0;try{o.userInfo&&o.user||(console.log("用户信息未加载，尝试获取..."),yield o.fetchUserInfo());const l=(null==(e=o.userInfo)?void 0:e._id)||(null==(r=o.user)?void 0:r._id);if(!l)return console.error("用户ID不可用，可能未登录"),s.index.showToast({title:"请先登录",icon:"none"}),void setTimeout((()=>{s.index.navigateTo({url:"/pages/login/login"})}),1500);console.log("开始获取用户标记，用户ID:",l);const a=yield t.fetchUserMarkers(l);i.value=a||[],console.log("获取到用户标记数量:",i.value.length)}catch(a){console.error("获取用户标记失败:",a),s.index.showToast({title:"加载标记失败",icon:"none"})}finally{l.value=!1}})),h=e=>{if(!e)return"未知时间";const t=new Date(e);return`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")}`},b=e=>{if("custom"===e.type&&e.properties&&e.properties.customTypeName)return`自定义: ${e.properties.customTypeName}`;const t=g.find((t=>t.value===e.type));return t?t.label:"未知类型"},w=()=>{if("custom"===m.type&&m.customTypeName)return`自定义: ${m.customTypeName}`;const e=g.find((e=>e.value===m.type));return e?e.label:"请选择标记类型"},x=()=>{s.index.navigateTo({url:"/pages/map/add-marker"})},T=()=>{v.value=!1},F=e=>{const t=e.detail.value;m.type=g[t].value,"custom"!==m.type&&(m.customTypeName="")},_=e=>{m.radius=parseFloat(e.detail.value)},N=()=>{m.isPublic=!m.isPublic},P=()=>a(this,null,(function*(){var e,o;if(!m.title)return void s.index.showToast({title:"请输入标记标题",icon:"none"});if("custom"===m.type&&!m.customTypeName.trim())return void s.index.showToast({title:"请输入自定义类型名称",icon:"none"});const l={title:m.title,description:m.description,type:m.type,color:m.color,radius:m.radius,isPublic:m.isPublic,properties:r({},m.properties)};"custom"===m.type&&(l.properties.customTypeName=m.customTypeName.trim());try{s.index.showLoading({title:"保存中...",mask:!0});const e=yield t.updateMarker({id:m._id,data:l});if(s.index.hideLoading(),e){v.value=!1;const t=i.value.findIndex((e=>e._id===m._id));-1!==t&&(i.value[t]=r({},e)),s.index.showToast({title:"标记已更新",icon:"success"})}else s.index.showModal({title:"更新失败",content:"服务器处理请求失败，请稍后再试",showCancel:!1})}catch(a){s.index.hideLoading(),console.error("更新标记失败:",a);const t=(null==(o=null==(e=a.response)?void 0:e.data)?void 0:o.message)||a.message||"服务器连接失败，请检查网络";s.index.showModal({title:"更新失败",content:t,showCancel:!1})}})),k=()=>a(this,null,(function*(){var e,o;if(!p.value)return;const l=p.value,r=i.value.findIndex((e=>e._id===l));r>=0&&(i.value[r].isDeleting=!0),s.index.showLoading({title:"删除中...",mask:!0});try{const e=yield t.deleteMarker(l);s.index.hideLoading(),e?(s.index.showToast({title:"标记已删除",icon:"success",duration:2e3}),i.value=i.value.filter((e=>e._id!==l))):(r>=0&&(i.value[r].isDeleting=!1),s.index.showModal({title:"删除失败",content:"服务器处理请求失败，请稍后再试",showCancel:!1}))}catch(a){s.index.hideLoading(),r>=0&&(i.value[r].isDeleting=!1),console.error("删除标记失败:",a);const t=(null==(o=null==(e=a.response)?void 0:e.data)?void 0:o.message)||a.message||"服务器连接失败，请检查网络";s.index.showModal({title:"删除失败",content:t,showCancel:!1})}finally{d.value=!1,p.value=null}}));return s.onMounted((()=>{f()})),(e,t)=>s.e({a:l.value},l.value?{}:0===i.value.length?{c:n._imports_0$7,d:s.o(x)}:{e:s.f(i.value,((e,t,o)=>({a:e.icon||"/static/images/marker.png",b:e.color||"#FF5733",c:s.t(e.title),d:s.t(e.description||"无描述"),e:s.t(b(e)),f:s.t(h(e.createdAt)),g:s.o((t=>{return o=e._id,p.value=o,void(d.value=!0);var o}),e._id),h:e._id,i:s.o((t=>(e=>{console.log("编辑标记:",e),Object.assign(m,{_id:e._id,title:e.title||"",description:e.description||"",type:e.type||"general",color:e.color||"#FF5733",isPublic:!1!==e.isPublic,latitude:e.latitude||0,longitude:e.longitude||0,radius:e.radius||1,properties:e.properties||{}}),"custom"===e.type&&e.properties&&e.properties.customTypeName?m.customTypeName=e.properties.customTypeName:m.customTypeName="",v.value=!0})(e)),e._id)})))},{b:0===i.value.length,f:d.value},d.value?{g:s.o((e=>d.value=!1)),h:s.o(k)}:{},{i:v.value},v.value?s.e({j:s.o(T),k:m.title,l:s.o((e=>m.title=e.detail.value)),m:m.description,n:s.o((e=>m.description=e.detail.value)),o:s.t(w()),p:g,q:s.o(F),r:"custom"===m.type},"custom"===m.type?{s:m.customTypeName,t:s.o((e=>m.customTypeName=e.detail.value))}:{},{v:s.f(y,((e,t,o)=>({a:t,b:e,c:m.color===e?1:"",d:s.o((t=>{return o=e,void(m.color=o);var o}),t)}))),w:m.radius||1,x:s.o(_),y:s.t(m.radius||1),z:m.isPublic,A:s.o(N),B:s.o(T),C:s.o(P)}):{})}};wx.createPage(d);
