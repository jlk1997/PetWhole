"use strict";var e=(e,o,n)=>new Promise(((a,l)=>{var t=e=>{try{r(n.next(e))}catch(o){l(o)}},s=e=>{try{r(n.throw(e))}catch(o){l(o)}},r=e=>e.done?a(e.value):Promise.resolve(e.value).then(t,s);r((n=n.apply(e,o)).next())}));const o=require("../../common/vendor.js"),n=require("../../store/user.js"),a=require("../../utils/ui.js"),l={__name:"profile",setup(l){const t=o.ref(!1),s=n.useUserStore(),r=o.ref(!1),i=o.index.getStorageSync("BASE_URL")||"http://49.235.65.37:5000",u=o.computed((()=>{const e=c.value.avatar;if(console.log("个人资料页面头像路径:",e),!e)return"/static/images/default-avatar.png";if(e.startsWith("/uploads/")){const o=i+e;return console.log("个人资料页面完整头像URL:",o),o}return e})),c=o.ref({nickname:"",email:"",phone:"",avatar:"",gender:"unknown",bio:""}),v=[{value:"unknown",label:"请选择性别"},{value:"male",label:"男"},{value:"female",label:"女"},{value:"other",label:"其他"}],g=o.computed((()=>{const e=v.findIndex((e=>e.value===c.value.gender));return console.log("计算性别索引:",c.value.gender,"索引为:",e>=0?e:0),e>=0?e:0})),d=o.computed((()=>c.value.nickname&&c.value.email&&c.value.phone)),h=o.ref(!1),f=o.ref(!1);function m(e){const o=e.detail.value;c.value.gender=v[o].value,console.log("性别变更为:",c.value.gender)}function p(){return e(this,null,(function*(){try{console.log("开始选择图片");const t=yield new Promise(((e,n)=>{o.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:e,fail:n})}));if(!t||!t.tempFilePaths||!t.tempFilePaths.length)return void console.error("未选择图片或返回的图片路径为空");const s=t.tempFilePaths[0];if(console.log("选择的图片路径:",s),!s)return console.error("无效的图片路径"),void a.showToast("选择图片失败");r.value=!0;try{const l=yield new Promise(((e,n)=>{o.index.getFileInfo({filePath:s,success:e,fail:n})}));if(console.log("原始图片大小:",(l.size/1024/1024).toFixed(2)+"MB"),console.log("图片类型:",l.type),l.size>4194304){a.showToast("图片较大，正在压缩...");try{const n=yield function(n){return e(this,null,(function*(){return new Promise(((e,a)=>{o.index.compressImage({src:n,quality:70,width:"60%",height:"60%",success:o=>{e(o.tempFilePath)},fail:o=>{console.error("压缩图片失败:",o),e(n)}})}))}))}(s);console.log("压缩后的图片路径:",n);const a=yield new Promise(((e,a)=>{o.index.getFileInfo({filePath:n,success:e,fail:a})}));console.log("压缩后图片大小:",(a.size/1024/1024).toFixed(2)+"MB"),yield w(n)}catch(n){console.error("压缩图片失败:",n),a.showToast("图片压缩失败，尝试直接上传"),yield w(s)}}else yield w(s)}catch(l){console.error("获取文件信息失败:",l),yield w(s)}}catch(l){console.error("选择图片失败:",l),a.showToast("选择图片失败"),r.value=!1}}))}function w(o){return e(this,null,(function*(){try{if(console.log("开始上传头像，文件路径:",o),!o)return console.error("无效的头像文件路径"),a.showToast("头像文件无效"),!1;const e=yield s.uploadAvatar(o);console.log("头像上传结果:",e);let n=null;if(e&&(n=e.avatar||e.data&&e.data.avatar||null,console.log("提取的头像路径:",n)),n){c.value.avatar=n,a.showToast("头像上传成功");const e=yield s.fetchUserInfo();return e&&e.avatar===n?(console.log("头像已确认成功保存到后端:",n),!0):(console.warn("头像保存可能不完整，后端返回的头像与上传的不一致"),!0)}return console.error("头像上传失败：未获取到有效的头像URL",e),a.showToast("头像上传失败，请重试"),!1}catch(e){return console.error("头像上传失败:",e),e.message&&e.message.includes("网络请求失败")?a.showToast("网络连接失败，请检查网络"):e.message&&e.message.includes("文件读取失败")?a.showToast("文件读取失败，请重新选择图片"):e.message&&e.message.includes("上传失败: 400")?a.showToast("文件格式不支持或已损坏"):a.showToast("头像上传失败，请重试"),!1}finally{r.value=!1}}))}function y(){return e(this,null,(function*(){if(!c.value.nickname)return a.showToast("请输入昵称");if(!c.value.email)return a.showToast("请输入邮箱");if(!c.value.phone)return a.showToast("请输入手机号码");f.value=!0,a.showLoading("保存中...");try{const n={nickname:c.value.nickname,email:c.value.email,bio:c.value.bio||"",phone:c.value.phone||"",gender:c.value.gender||"unknown"};c.value.avatar&&(n.avatar=c.value.avatar),console.log("准备更新个人资料，包含性别信息:",n),Object.keys(n).forEach((e=>{void 0===n[e]&&(n[e]="")}));const l=yield s.updateUserInfo(n);if(console.log("个人资料更新结果:",l),l){if(!function(e,o){if(!e)return!1;const n=["nickname","email","phone","gender"];for(const a of n){if(!e[a])return console.error(`关键字段 ${a} 没有在服务器响应中返回`),!1;e[a]!==o[a]&&console.warn(`字段 ${a} 值不一致: 提交=${o[a]}, 返回=${e[a]}`)}return!0}(l,n))return console.error("后端未成功保存所有字段，中止操作"),void a.showToast({title:"资料保存不完整，请重试",icon:"none"});console.log("所有字段已成功保存到后端"),s.user&&(s.user=l,o.index.setStorageSync("userInfo",JSON.stringify(l)),console.log("后端数据已缓存到本地存储"));try{o.index.setStorageSync("hasCompletedFirstLogin","true"),console.log("已标记用户完成首次登录")}catch(e){console.error("保存登录状态失败:",e)}a.showToast({title:"保存成功",icon:"success"}),setTimeout((()=>{o.index.switchTab({url:"/pages/index/index"}),t.value?console.log("首次登录资料完善完成，跳转回首页"):console.log("资料更新完成，跳转回首页")}),1500)}else a.showToast("后端保存失败，请重试")}catch(n){console.error("保存个人资料失败:",n),a.showToast("保存失败，请重试")}finally{f.value=!1,a.hideLoading()}}))}function T(){o.index.navigateBack()}return o.onMounted((()=>e(this,null,(function*(){h.value=!0;try{console.log("开始从服务器获取用户信息"),yield s.fetchUserInfo();let n=s.user;console.log("服务器返回的用户信息:",n);const l=getCurrentPages(),r=l[l.length-1];let i=!1;r&&r.options&&(i="true"===r.options.firstLogin);let u=!1;try{u="true"===o.index.getStorageSync("hasCompletedFirstLogin"),console.log("用户是否已完成首次登录:",u)}catch(e){console.error("读取登录状态失败:",e)}const v=function(e){if(!e)return console.log("用户信息不存在"),!1;if(!e.nickname||!e.email)return console.log("用户信息不完整: 缺少基本信息"),!1;if(!e.avatar||"/static/images/default-avatar.png"===e.avatar||"static/images/default-avatar.png"===e.avatar)return console.log("用户信息不完整: 未上传头像"),!1;return!0}(n);if(t.value=!u&&!v&&i,console.log("URL参数firstLogin:",i),console.log("用户资料是否完整:",v),console.log("最终判断是否首次登录:",t.value),v&&i)return console.log("用户资料已完整，跳转到主页"),void setTimeout((()=>{o.index.switchTab({url:"/pages/index/index"})}),500);if(n){const e=n.gender||"unknown";c.value={nickname:n.nickname||"",email:n.email||"",phone:n.phone||"",avatar:n.avatar||"",gender:e,bio:n.bio||""},console.log("表单初始化数据:",c.value),console.log("特别关注 - 性别信息:",{"原始用户性别":e,"表单性别":c.value.gender,"性别选项索引":g.value})}else a.showToast("获取用户信息失败");t.value&&a.showToast({title:"请完善您的个人信息",duration:3e3})}catch(n){console.error("加载用户信息失败:",n),a.showToast("获取用户信息失败")}finally{h.value=!1}})))),(e,n)=>o.e({a:o.t(t.value?"完善个人资料":"编辑个人资料"),b:t.value},(t.value,{}),{c:u.value,d:r.value},(r.value,{}),{e:o.o(p),f:c.value.nickname,g:o.o((e=>c.value.nickname=e.detail.value)),h:c.value.email,i:o.o((e=>c.value.email=e.detail.value)),j:c.value.phone,k:o.o((e=>c.value.phone=e.detail.value)),l:o.t(v[g.value].label),m:v,n:g.value,o:o.o(m),p:c.value.bio,q:o.o((e=>c.value.bio=e.detail.value)),r:o.t(f.value?"保存中...":"保存"),s:!d.value||f.value,t:o.o(y),v:!t.value},t.value?{}:{w:o.o(T)})}};wx.createPage(l);
