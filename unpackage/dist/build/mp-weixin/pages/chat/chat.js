"use strict";var e=Object.defineProperty,t=Object.defineProperties,a=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,o=(t,a,s)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s,l=(e,t,a)=>new Promise(((s,n)=>{var r=e=>{try{l(a.next(e))}catch(t){n(t)}},o=e=>{try{l(a.throw(e))}catch(t){n(t)}},l=e=>e.done?s(e.value):Promise.resolve(e.value).then(r,o);l((a=a.apply(e,t)).next())}));const i=require("../../common/vendor.js"),u=require("../../store/user.js"),c=require("../../utils/api.js");require("../../utils/chatService.js");const d=require("../../utils/networkManager.js"),v=require("../../utils/chatStorage.js"),g=require("../../common/assets.js"),h={setup(){const e=u.useUserStore(),g=i.computed((()=>e.user||{})),h=i.computed((()=>g.value.id||g.value._id||"")),f=i.ref({}),p=i.ref(""),m=i.ref(!1),S=i.ref([]),M=i.ref(!1),w=i.ref(!1),I=i.ref(!1),y=i.ref(0),D=i.ref(null),T=i.ref(null),P=i.ref(!1),x=i.ref(""),k=i.ref(!1),b=i.ref({isConnected:!0,networkType:"unknown"}),O=i.ref(!0),U=i.ref(1);let _=null,j=null;const $=()=>{if(!h.value||!p.value)return null;return`private_chat_${[h.value,p.value].sort().join("_")}`},A=()=>l(this,null,(function*(){if(p.value)try{const e=yield c.api.user.getUserInfo(p.value);e&&(e.id||e._id)?f.value=e:(console.warn("获取用户信息失败，使用临时数据"),f.value={id:p.value,username:"聊天用户",avatar:"/static/images/default-avatar.png"}),R()}catch(e){console.error("加载用户信息失败:",e);try{const e=$();if(e){const t=i.index.getStorageSync(`${e}_user`);if(t){const e=JSON.parse(t);f.value=e,console.log("使用缓存的用户信息:",e)}}}catch(t){console.error("读取缓存用户信息失败:",t)}i.index.showToast({title:"加载用户信息失败",icon:"none"})}})),L=(e=!1)=>l(this,null,(function*(){if(p.value&&h.value)if(!M.value||e)try{M.value=!0,e&&(U.value=1,I.value=!1,T.value=null);const a={targetUserId:p.value,page:U.value,limit:20};T.value&&!e&&(a.beforeMessageId=T.value),console.log("加载消息, 参数:",a);let s=[];try{if(c.api.chat.getPrivateMessages){const e=yield c.api.chat.getPrivateMessages(a);s=(null==e?void 0:e.data)||e||[]}else console.warn("没有找到私聊消息API，使用模拟数据"),s=e?Array(5).fill().map(((e,t)=>({id:`msg-${Date.now()}-${t}`,content:`这是一条模拟消息 ${t+1}`,senderId:t%2==0?h.value:p.value,receiverId:t%2==0?p.value:h.value,createTime:new Date(Date.now()-6e4*t).getTime(),status:"sent"}))):Array(3).fill().map(((e,t)=>({id:`msg-old-${Date.now()}-${t}`,content:`这是更早的模拟消息 ${t+1}`,senderId:t%2==0?h.value:p.value,receiverId:t%2==0?p.value:h.value,createTime:new Date(Date.now()-6e4*(t+10)).getTime(),status:"sent"})))}catch(t){if(console.error("API调用失败:",t),d.networkManager.isNetworkError(t)){const e=$();if(e){const t=v.chatStorage.getPrivateMessages(e);t&&t.length>0&&(s=t,console.log("从缓存加载私聊消息",s.length))}}0===s.length&&e&&(s=[{id:`temp-${Date.now()}`,content:"网络连接不佳，无法加载消息历史",senderId:"system",createTime:Date.now(),status:"info",isSystemMessage:!0}])}if(s&&s.length>0){if(e)S.value=s;else{const e=S.value.map((e=>e.id)),t=s.filter((t=>!e.includes(t.id)));if(t.length>0){if(S.value=[...t,...S.value],U.value++,t.length>0){const e=[...t].sort(((e,t)=>new Date(e.createTime)-new Date(t.createTime)))[0];e&&(T.value=e.id,console.log("更新最后加载的消息ID:",T.value))}}else I.value=!0,console.log("没有更多历史消息了")}const t=$();t&&(v.chatStorage.savePrivateMessages(S.value,t),f.value&&(f.value.id||f.value._id)&&i.index.setStorageSync(`${t}_user`,JSON.stringify(f.value))),e&&(yield i.nextTick$1(),F())}else e||(I.value=!0);H()}catch(a){console.error("加载消息失败:",a),i.index.showToast({title:"加载消息失败，请检查网络连接",icon:"none"})}finally{M.value=!1,w.value=!1}else console.log("已有加载请求进行中，跳过")})),q=()=>l(this,null,(function*(){p.value&&h.value&&!M.value&&!I.value?(w.value=!0,yield L(),w.value=!1):w.value=!1})),C=e=>l(this,null,(function*(){const t=S.value.findIndex((t=>t.id===e));if(-1===t)return;const a=S.value[t];S.value[t].status="sending";try{let n;try{c.api.chat.sendPrivateMessage?n=yield c.api.chat.sendPrivateMessage({receiverId:p.value,content:a.content}):(console.warn("没有找到发送私聊消息API，模拟发送成功"),yield new Promise((e=>setTimeout(e,500))),n={id:"msg-"+Date.now(),status:"sent"}),S.value[t].status="sent",n&&(n.id||n._id)&&(S.value[t].id=n.id||n._id);const s=$();s&&v.chatStorage.savePrivateMessages(S.value,s),v.chatStorage.removePendingMessage(e)}catch(s){throw s}}catch(n){console.error("重试发送消息失败:",n),S.value[t].status="failed";const e=$();e&&v.chatStorage.savePrivateMessages(S.value,e),i.index.showToast({title:"发送消息失败，请检查网络",icon:"none"})}})),H=()=>l(this,null,(function*(){if(p.value&&h.value)if(c.api.chat.markMessagesAsRead)try{yield c.api.chat.markMessagesAsRead(p.value),console.log("标记消息已读成功")}catch(e){console.error("标记消息已读失败:",e)}else console.log("没有找到标记消息已读API")})),R=()=>l(this,null,(function*(){if(p.value)try{if(c.api.user.checkUserOnline){const e=yield c.api.user.checkUserOnline(p.value);m.value=(null==e?void 0:e.isOnline)||!1}else m.value=Math.random()>.5}catch(e){console.error("检查用户在线状态失败:",e),m.value=!1}})),F=()=>{y.value=Math.random(),i.nextTick$1((()=>{i.index.createSelectorQuery().in(this).select(".message-list").boundingClientRect((e=>{e&&(y.value=99999)})).exec()}))},E=()=>{j&&(clearInterval(j),j=null),j=setInterval((()=>{O.value&&b.value.isConnected&&(console.log("自动刷新消息"),L(!0))}),15e3)};return i.onLoad((e=>{p.value=e.userId||(i.index.getLaunchOptionsSync().query||{}).userId||"",p.value?(d.networkManager.addListener((e=>{b.value=e,console.log("网络状态更新:",e),e.isConnected&&O.value&&(console.log("网络恢复，刷新消息"),L(!0))})),A(),(()=>{const e=v.chatStorage.getPendingMessages();e&&e.length>0&&(console.log("恢复待处理私聊消息"),e.forEach((e=>{"private"===e.type&&e.data.receiverId===p.value&&(-1===S.value.findIndex((t=>t.id===e.id))&&S.value.push({id:e.id,content:e.content,createTime:e.createTime,senderId:h.value,receiverId:p.value,status:e.status}),"sending"!==e.status&&"failed"!==e.status||C(e.id))})))})(),L(!0),E(),_=setInterval(R,3e4)):(i.index.showToast({title:"用户ID不能为空",icon:"none"}),setTimeout((()=>{i.index.navigateBack()}),1500))})),i.onShow((()=>{O.value=!0,R(),H(),P.value&&b.value.isConnected&&(L(!0),P.value=!1),E()})),i.onHide((()=>{O.value=!1,j&&(clearInterval(j),j=null)})),i.onUnload((()=>{_&&(clearInterval(_),_=null),j&&(clearInterval(j),j=null)})),{chatUser:f,isOnline:m,messages:S,isLoading:M,isRefreshing:w,noMoreMessages:I,scrollTop:y,messageList:D,newMessage:x,inputFocus:k,userInfo:g,userId:h,loadMoreMessages:q,sendMessage:()=>l(this,null,(function*(){if(!x.value.trim()||!p.value||!h.value)return;if(!b.value.isConnected)return void i.index.showToast({title:"网络不可用，请检查网络连接",icon:"none"});const e=x.value.trim();x.value="";const l="temp-"+Date.now(),u={id:l,content:e,createTime:(new Date).getTime(),senderId:h.value,receiverId:p.value,status:"sending"};S.value.push(u);const d=$();d&&v.chatStorage.savePrivateMessages(S.value,d),yield i.nextTick$1(),F();try{let t;try{c.api.chat.sendPrivateMessage?t=yield c.api.chat.sendPrivateMessage({receiverId:p.value,content:e}):(console.warn("没有找到发送私聊消息API，模拟发送成功"),yield new Promise((e=>setTimeout(e,500))),t={id:"msg-"+Date.now(),status:"sent"});const a=S.value.findIndex((e=>e.id===l));-1!==a&&(S.value[a].status="sent",t&&(t.id||t._id)&&(S.value[a].id=t.id||t._id||l),d&&v.chatStorage.savePrivateMessages(S.value,d))}catch(m){throw m}}catch(M){console.error("发送消息失败:",M);const c=S.value.findIndex((e=>e.id===l));-1!==c&&(S.value[c].status="failed",d&&v.chatStorage.savePrivateMessages(S.value,d)),v.chatStorage.savePendingMessage((g=((e,t)=>{for(var a in t||(t={}))n.call(t,a)&&o(e,a,t[a]);if(s)for(var a of s(t))r.call(t,a)&&o(e,a,t[a]);return e})({},u),f={type:"private",data:{receiverId:p.value,content:e}},t(g,a(f)))),i.index.showToast({title:"发送消息失败，请检查网络",icon:"none"})}var g,f})),retryMessage:C,backToList:()=>{i.index.navigateBack()},shouldShowDate:(e,t)=>{if(0===t)return!0;const a=S.value[t-1],s=new Date(a.createTime),n=new Date(e.createTime);return n-s>18e5||s.toDateString()!==n.toDateString()},formatDate:e=>{if(!e)return"";const t=new Date(e),a=new Date;if(t.toDateString()===a.toDateString())return"今天 "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0");const s=new Date;if(s.setDate(s.getDate()-1),t.toDateString()===s.toDateString())return"昨天 "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0");const n=["日","一","二","三","四","五","六"];return Math.floor((a-t)/864e5)<7?"星期"+n[t.getDay()]+" "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0"):t.getFullYear()!==a.getFullYear()?t.getFullYear()+"年"+(t.getMonth()+1)+"月"+t.getDate()+"日 "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0"):t.getMonth()+1+"月"+t.getDate()+"日 "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0")},formatAvatarUrl:e=>{if(!e)return"/static/images/default-avatar.png";if(e.startsWith("http")||e.startsWith("/static"))return e;if(e.startsWith("/uploads")){return(i.index.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}return"/static/images/default-avatar.png"},onScrollToUpper:()=>{M.value||I.value||q()}}}};const f=i._export_sfc(h,[["render",function(e,t,a,s,n,r){return i.e({a:i.o(((...e)=>s.backToList&&s.backToList(...e))),b:i.t(s.chatUser.nickname||s.chatUser.username||"用户"),c:s.isOnline},(s.isOnline,{}),{d:s.isLoading&&s.messages.length>0},(s.isLoading&&s.messages.length,{}),{e:s.noMoreMessages&&s.messages.length>0},(s.noMoreMessages&&s.messages.length,{}),{f:i.f(s.messages,((e,t,a)=>i.e({a:s.shouldShowDate(e,t)},s.shouldShowDate(e,t)?{b:i.t(s.formatDate(e.createTime))}:{},{c:e.senderId!==s.userId},e.senderId!==s.userId?{d:s.formatAvatarUrl(s.chatUser.avatar)}:{},{e:i.t(e.content),f:e.senderId===s.userId?1:"",g:e.senderId===s.userId},e.senderId===s.userId?{h:s.formatAvatarUrl(s.userInfo.avatar)}:{},{i:e.id||t,j:e.senderId===s.userId?1:""}))),g:0===s.messages.length&&!s.isLoading},0!==s.messages.length||s.isLoading?{}:{h:g._imports_0$6},{i:s.scrollTop,j:s.isRefreshing,k:i.o(((...e)=>s.loadMoreMessages&&s.loadMoreMessages(...e))),l:i.o(((...e)=>s.onScrollToUpper&&s.onScrollToUpper(...e))),m:s.inputFocus,n:i.o(((...e)=>s.sendMessage&&s.sendMessage(...e))),o:s.newMessage,p:i.o((e=>s.newMessage=e.detail.value)),q:s.newMessage.trim()?1:"",r:i.o(((...e)=>s.sendMessage&&s.sendMessage(...e)))})}]]);wx.createPage(f);
