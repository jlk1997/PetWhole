"use strict";var e=(e,t,o)=>new Promise(((n,r)=>{var c=e=>{try{l(o.next(e))}catch(t){r(t)}},s=e=>{try{l(o.throw(e))}catch(t){r(t)}},l=e=>e.done?n(e.value):Promise.resolve(e.value).then(c,s);l((o=o.apply(e,t)).next())}));const t=require("../common/vendor.js"),o=t.reactive({}),n=t.ref(!1);function r(){return e(this,null,(function*(){try{const t=`/static/icon-versions.json?t=${Date.now()}`;console.log("尝试加载图标版本信息:",t);const r=yield fetch(t);if(!r.ok)return console.warn(`图标版本信息加载失败 (${r.status}):`,yield r.text()),console.log("使用空图标版本信息"),n.value=!0,{};const c=r.headers.get("content-type");if(!c||!c.includes("application/json"))return console.warn("图标版本信息响应不是JSON格式:",c),n.value=!0,{};try{const e=yield r.json();return console.log("加载到图标版本信息:",e),Object.assign(o,e),n.value=!0,e}catch(e){return console.error("解析图标版本信息JSON失败:",e),n.value=!0,{}}}catch(t){return console.error("加载图标版本信息出错:",t),n.value=!0,{}}}))}function c(e){if(!e)return null;const t=e.startsWith("/")?e:`/${e}`;return o[t]?o[t].version:null}setTimeout((()=>{r().catch((e=>console.error("初始化图标版本信息失败:",e)))}),1e3),exports.checkAllIconsUpdate=function(){return e(this,null,(function*(){const e=yield r();let t=!1;for(const[o,n]of Object.entries(e)){const e=c(o);(!e||n.version>e)&&(t=!0,console.log(`发现图标更新: ${o}, 新版本: ${n.version}`))}return t}))},exports.loadIconVersions=r,exports.refreshDOMIcons=function(e='img[src*="/static/"]'){try{const t=document.querySelectorAll(e);console.log(`找到 ${t.length} 个匹配的图标`);let o=0;return t.forEach(((e,t)=>{const n=function(e,t=!1){if(!e)return"";const o=e.split("?")[0],n=c(o)||Date.now(),r=t?Math.random().toString(36).substring(2,8):"";return`${o}?v=${n}${r?`&r=${r}`:""}`}(e.src.split("?")[0],!0),r=new Image;r.onload=function(){console.log(`图标 ${t+1} 已重新加载: ${n}`)},Array.from(e.attributes).forEach((e=>{"src"!==e.name&&r.setAttribute(e.name,e.value)})),r.src=n,e.parentNode&&(e.parentNode.replaceChild(r,e),o++)})),console.log(`已刷新 ${o} 个图标`),o}catch(t){return console.error("刷新DOM图标失败:",t),0}};
