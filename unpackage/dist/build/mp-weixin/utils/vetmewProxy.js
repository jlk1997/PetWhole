"use strict";const e=require("./vetmew.js");exports.callVetmewAPI=function(t){return o=this,n=arguments,s=function*(t,o={}){const n=o.apiKey||"vmb1c7f72adc9473f7",s=o.apiSecret||"44yth8axrytm8ux23f53c78bjw3kg20h",r=o.apiPath||"/open/v1/chat",a="/vetmew-api"+r;try{let o;console.log("准备调用API，请求数据:",t);try{o=yield e.generateSignature(r,t,s)}catch(c){throw console.error("签名生成失败:",c),c}const g={"Content-Type":"application/json","X-ApiKey":n,"X-Timestamp":o.timestamp,"X-Nonce":o.nonce,"X-Signature":o.signature};console.log("发送API请求",{url:a,headers:g});const d=yield fetch(a,{method:"POST",headers:g,body:JSON.stringify(t)});if(!d.ok)throw new Error(`API请求失败: ${d.status} ${d.statusText}`);const u=yield d.text();if(console.log("接收到原始响应"),u.includes("data:")){console.log("检测到SSE流式响应");const e=u.split("\n\n");console.log(`识别到${e.length}个响应片段`);let t="",o="";for(const n of e){const e=n.trim();if(e&&e.startsWith("data:"))try{if("data: [DONE]"===e){console.log("流式响应完成");break}const n=e.substring(5).trim(),s=JSON.parse(n);s.msg&&(t+=s.msg),s.conversation_id&&!o&&(o=s.conversation_id)}catch(i){console.warn("解析SSE片段失败:",i,e)}}return console.log("完整响应消息:",t),{code:0,message:"成功",data:t,conversation_id:o,streaming:!0}}try{const e=JSON.parse(u);return console.log("解析为标准JSON响应:",e),e}catch(l){return console.error("JSON解析错误:",l),{code:9999,message:"服务器返回了无效的数据格式",data:null,rawResponse:u}}}catch(g){return console.error("汪喵灵灵API调用出错:",g),{code:9999,message:`API调用失败: ${g.message}`,data:null}}},new Promise(((e,t)=>{var r=e=>{try{c(s.next(e))}catch(o){t(o)}},a=e=>{try{c(s.throw(e))}catch(o){t(o)}},c=t=>t.done?e(t.value):Promise.resolve(t.value).then(r,a);c((s=s.apply(o,n)).next())}));var o,n,s};
