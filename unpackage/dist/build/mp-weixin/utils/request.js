"use strict";const e=require("../common/vendor.js"),o=require("./walkStorage.js"),s=require("../config/index.js").config.BASE_API_URL,l=e=>new Promise((s=>{setTimeout((()=>{var l,t;const a=e.url.split("/");let r=null;if(r=a.find((e=>e.startsWith("walk_"))),!r&&a.length>0&&(r=a[a.length-1],"walks"!==r&&"walk"!==r&&""!==r||(r=null)),console.log("遛狗API处理 - 提取的ID:",r,"请求URL:",e.url),"GET"===e.method)if(r){const e=o.walkStorage.getWalkRecord(r);console.log("获取遛狗记录详情:",e),s((null==e?void 0:e.data)||null)}else{const a=o.walkStorage.getAllWalkRecords(),r=(null==(l=e.params)?void 0:l.page)||1,n=(null==(t=e.params)?void 0:t.limit)||10,d=(r-1)*n,u=a.slice(d,d+n);console.log("获取遛狗记录列表, 页码:",r,"每页数量:",n,"记录数:",u.length),s({code:0,message:"获取成功",data:{list:u,total:a.length,page:r,limit:n}})}else if("POST"===e.method&&e.url.includes("/walks/start")){const l=o.walkStorage.saveWalkRecord(e.data);console.log("创建遛狗记录:",l),s(l)}else if("POST"===e.method&&e.url.includes("/end")){const l=o.walkStorage.updateWalkRecord(r,e.data);console.log("更新遛狗记录:",l),s(l)}else if("DELETE"===e.method){if(!r)return console.error("删除遛狗记录失败: 无法从URL中提取记录ID",e.url),void s({code:400,message:"无效的记录ID",data:null});console.log("尝试删除遛狗记录, ID:",r);const l=o.walkStorage.deleteWalkRecord(r);console.log("删除遛狗记录结果:",l),404===l.code?(console.log("本地存储中未找到记录,可能已经被删除,返回成功状态"),s({code:0,message:"记录已删除",data:null})):s(l)}else console.warn("未处理的遛狗API请求类型:",e.method,e.url),s({})}),300)}));exports.request=o=>{if(o.url.includes("/api/walks"))return console.log("检测到遛狗API请求:",o.url),l(o);o.url.includes("/api/community/posts")&&(console.log("检测到社区API请求:",o.url),console.log("使用真实后端处理社区API请求")),o.header||(o.header={});const t=o.timeout||1e4,a=(o.baseURL||s)+o.url;if("GET"===o.method&&o.params){const e=Object.keys(o.params).map((e=>`${encodeURIComponent(e)}=${encodeURIComponent(o.params[e])}`)).join("&");o.url=e?`${a}?${e}`:a}else o.url=a;return new Promise(((s,l)=>{const a=e.index.getStorageSync("token");if(!!!a&&!1!==o.needAuth)return console.log("请求需要认证但没有token"),l({message:"登录已过期，请重新登录",statusCode:401});a&&(o.header.Authorization=`Bearer ${a}`),e.index.request({url:o.url,data:"GET"===o.method?void 0:o.data,method:o.method||"GET",header:o.header,timeout:t,success:t=>{const{statusCode:a,data:r}=t;a>=200&&a<300?s(r):401===a?(e.index.showToast({title:"登录已过期，请重新登录",icon:"none",duration:2e3}),l({message:"登录已过期，请重新登录",statusCode:401,data:r})):l(404===a?{message:"请求的资源不存在",statusCode:404,data:r,url:o.url}:500===a?{message:"服务器错误，请稍后再试",statusCode:500,data:r}:{message:(null==r?void 0:r.message)||`请求失败(${a})`,statusCode:a,data:r})},fail:e=>{console.error("请求失败:",e);const s=e.errMsg.includes("timeout")?"请求超时，请检查网络":"网络错误，请检查网络连接";l({message:s,statusCode:0,error:e,url:o.url})}})}))};
