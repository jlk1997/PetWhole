var __defProp=Object.defineProperty,__defProps=Object.defineProperties,__getOwnPropDescs=Object.getOwnPropertyDescriptors,__getOwnPropSymbols=Object.getOwnPropertySymbols,__hasOwnProp=Object.prototype.hasOwnProperty,__propIsEnum=Object.prototype.propertyIsEnumerable,__defNormalProp=(e,t,a)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,__spreadValues=(e,t)=>{for(var a in t||(t={}))__hasOwnProp.call(t,a)&&__defNormalProp(e,a,t[a]);if(__getOwnPropSymbols)for(var a of __getOwnPropSymbols(t))__propIsEnum.call(t,a)&&__defNormalProp(e,a,t[a]);return e},__spreadProps=(e,t)=>__defProps(e,__getOwnPropDescs(t)),__async=(e,t,a)=>new Promise(((s,o)=>{var r=e=>{try{i(a.next(e))}catch(t){o(t)}},n=e=>{try{i(a.throw(e))}catch(t){o(t)}},i=e=>e.done?s(e.value):Promise.resolve(e.value).then(r,n);i((a=a.apply(e,t)).next())}));if("undefined"==typeof Promise||Promise.prototype.finally||(Promise.prototype.finally=function(e){const t=this.constructor;return this.then((a=>t.resolve(e()).then((()=>a))),(a=>t.resolve(e()).then((()=>{throw a}))))}),"undefined"!=typeof uni&&uni&&uni.requireGlobal){const e=uni.requireGlobal();ArrayBuffer=e.ArrayBuffer,Int8Array=e.Int8Array,Uint8Array=e.Uint8Array,Uint8ClampedArray=e.Uint8ClampedArray,Int16Array=e.Int16Array,Uint16Array=e.Uint16Array,Int32Array=e.Int32Array,Uint32Array=e.Uint32Array,Float32Array=e.Float32Array,Float64Array=e.Float64Array,BigInt64Array=e.BigInt64Array,BigUint64Array=e.BigUint64Array}uni.restoreGlobal&&uni.restoreGlobal(Vue,weex,plus,setTimeout,clearTimeout,setInterval,clearInterval),function(e){"use strict";function t(e){return weex.requireModule(e)}function a(e,t,...a){uni.__log__?uni.__log__(e,t,...a):console[e].apply(console,[...a,t])}const s=t=>(a,s=e.getCurrentInstance())=>{!e.isInSSRComponentSetup&&e.injectHook(t,a,s)},o=s("onShow"),r=s("onHide"),n=s("onLoad"),i=s("onUnload"),l=s("onPullDownRefresh"),c="/static/images/app-logo.png",u=e=>{"string"==typeof e?uni.showToast({title:e,icon:"none",duration:2e3}):uni.showToast(__spreadValues({title:e.title||"",icon:e.icon||"none",duration:e.duration||2e3},e))},d=(e="加载中...")=>{uni.showLoading({title:e,mask:!0})},m=()=>{uni.hideLoading()},p=e=>new Promise((t=>{uni.showModal({title:e.title||"提示",content:e.content||"",showCancel:!1!==e.showCancel,cancelText:e.cancelText||"取消",confirmText:e.confirmText||"确定",confirmColor:e.confirmColor||"#3B9E82",cancelColor:e.cancelColor||"#999999",success:e=>{e.confirm?t(!0):t(!1)},fail:()=>{t(!1)}})})),g=(e,t={})=>{if(e&&!e.startsWith("/")&&(e="/"+e),Object.keys(t).length>0){const a=Object.entries(t).map((([e,t])=>`${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join("&");e=e.includes("?")?`${e}&${a}`:`${e}?${a}`}return new Promise(((t,s)=>{uni.navigateTo({url:e,success:t,fail:o=>{a("error","at utils/ui.js:99","导航失败:",o),o.errMsg&&o.errMsg.includes("tabbar")?uni.switchTab({url:e,success:t,fail:s}):s(o)}})}))},v=(e=1)=>new Promise(((t,s)=>{uni.navigateBack({delta:e,success:t,fail:e=>{a("error","at utils/ui.js:127","返回失败:",e),s(e)}})})),h="dog_walk_records",f=()=>{try{const e=uni.getStorageSync(h);return e?JSON.parse(e):[]}catch(e){return a("error","at utils/walkStorage.js:23","获取本地遛狗记录失败:",e),[]}},y=f,w=e=>{try{const t=f().find((t=>t.id===e));return t?{code:0,message:"获取成功",data:t}:{code:404,message:"未找到记录",data:null}}catch(t){return a("error","at utils/walkStorage.js:137","获取遛狗记录失败:",t),{code:500,message:"获取失败",data:null}}},k=e=>{try{const t=f(),s=`walk_${(new Date).getTime()}_${Math.floor(1e4*Math.random())}`,o=__spreadProps(__spreadValues({id:s},e),{createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()});return t.unshift(o),uni.setStorageSync(h,JSON.stringify(t)),uni.setStorageSync("last_walk_id",s),a("log","at utils/walkStorage.js:54","遛狗记录已保存到本地存储:",o),{code:0,message:"保存成功",data:{walkId:s}}}catch(t){return a("error","at utils/walkStorage.js:63","保存遛狗记录到本地失败:",t),{code:500,message:"保存失败",data:null}}},E=(e,t)=>{try{const s=f(),o=s.findIndex((t=>t.id===e));return-1===o?(a("error","at utils/walkStorage.js:82","未找到要更新的遛狗记录:",e),{code:404,message:"未找到记录",data:null}):(s[o]=__spreadProps(__spreadValues(__spreadValues({},s[o]),t),{updatedAt:(new Date).toISOString()}),uni.setStorageSync(h,JSON.stringify(s)),a("log","at utils/walkStorage.js:100","遛狗记录已更新:",s[o]),{code:0,message:"更新成功",data:s[o]})}catch(s){return a("error","at utils/walkStorage.js:108","更新遛狗记录失败:",s),{code:500,message:"更新失败",data:null}}},N=e=>{try{const t=f(),s=t.filter((t=>t.id!==e));return t.length===s.length?{code:404,message:"未找到要删除的记录",data:null}:(uni.setStorageSync(h,JSON.stringify(s)),a("log","at utils/walkStorage.js:167","遛狗记录已删除:",e),{code:0,message:"删除成功",data:null})}catch(t){return a("error","at utils/walkStorage.js:175","删除遛狗记录失败:",t),{code:500,message:"删除失败",data:null}}},S={BASE_API_URL:"/api",TIMEOUT:3e4,DEBUG:!1,USE_MOCK_API:!1,API_PREFIX:{AUTH:"/api/users",USERS:"/api/users",PETS:"/api/pets",POSTS:"/api/community",WALKS:"/api/users/me/walks",LOCATIONS:"/api/locations"},VERSION:"1.0.0",APP_NAME:"DogRun"},V=S.BASE_API_URL,_=e=>{if(e.url.includes("/api/walks"))return a("log","at utils/request.js:67","检测到遛狗API请求:",e.url),P(e);e.url.includes("/api/community/posts")&&(a("log","at utils/request.js:73","检测到社区API请求:",e.url),a("log","at utils/request.js:75","使用真实后端处理社区API请求")),e.header||(e.header={});const t=e.timeout||1e4,s=(e.baseURL||V)+e.url;if("GET"===e.method&&e.params){const t=Object.keys(e.params).map((t=>`${encodeURIComponent(t)}=${encodeURIComponent(e.params[t])}`)).join("&");e.url=t?`${s}?${t}`:s}else e.url=s;return new Promise(((s,o)=>{const r=uni.getStorageSync("token");if(!!!r&&!1!==e.needAuth)return a("log","at utils/request.js:107","请求需要认证但没有token"),o({message:"登录已过期，请重新登录",statusCode:401});r&&(e.header.Authorization=`Bearer ${r}`),uni.request({url:e.url,data:"GET"===e.method?void 0:e.data,method:e.method||"GET",header:e.header,timeout:t,success:t=>{const{statusCode:a,data:r}=t;a>=200&&a<300?s(r):401===a?(uni.showToast({title:"登录已过期，请重新登录",icon:"none",duration:2e3}),o({message:"登录已过期，请重新登录",statusCode:401,data:r})):o(404===a?{message:"请求的资源不存在",statusCode:404,data:r,url:e.url}:500===a?{message:"服务器错误，请稍后再试",statusCode:500,data:r}:{message:(null==r?void 0:r.message)||`请求失败(${a})`,statusCode:a,data:r})},fail:t=>{a("error","at utils/request.js:170","请求失败:",t);const s=t.errMsg.includes("timeout")?"请求超时，请检查网络":"网络错误，请检查网络连接";o({message:s,statusCode:0,error:t,url:e.url})}})}))},P=e=>new Promise((t=>{setTimeout((()=>{var s,o;const r=e.url.split("/");let n=null;if(n=r.find((e=>e.startsWith("walk_"))),!n&&r.length>0&&(n=r[r.length-1],"walks"!==n&&"walk"!==n&&""!==n||(n=null)),a("log","at utils/request.js:214","遛狗API处理 - 提取的ID:",n,"请求URL:",e.url),"GET"===e.method)if(n){const e=w(n);a("log","at utils/request.js:221","获取遛狗记录详情:",e),t((null==e?void 0:e.data)||null)}else{const r=y(),n=(null==(s=e.params)?void 0:s.page)||1,i=(null==(o=e.params)?void 0:o.limit)||10,l=(n-1)*i,c=r.slice(l,l+i);a("log","at utils/request.js:231","获取遛狗记录列表, 页码:",n,"每页数量:",i,"记录数:",c.length),t({code:0,message:"获取成功",data:{list:c,total:r.length,page:n,limit:i}})}else if("POST"===e.method&&e.url.includes("/walks/start")){const s=k(e.data);a("log","at utils/request.js:247","创建遛狗记录:",s),t(s)}else if("POST"===e.method&&e.url.includes("/end")){const s=E(n,e.data);a("log","at utils/request.js:253","更新遛狗记录:",s),t(s)}else if("DELETE"===e.method){if(!n)return a("error","at utils/request.js:259","删除遛狗记录失败: 无法从URL中提取记录ID",e.url),void t({code:400,message:"无效的记录ID",data:null});a("log","at utils/request.js:268","尝试删除遛狗记录, ID:",n);const s=N(n);a("log","at utils/request.js:270","删除遛狗记录结果:",s),404===s.code?(a("log","at utils/request.js:274","本地存储中未找到记录,可能已经被删除,返回成功状态"),t({code:0,message:"记录已删除",data:null})):t(s)}else a("warn","at utils/request.js:286","未处理的遛狗API请求类型:",e.method,e.url),t({})}),300)})),I=S.BASE_API_URL,x=(new Date(Date.now()-1728e5).toISOString(),new Date(Date.now()-1728e5+27e5).toISOString(),new Date(Date.now()-864e5).toISOString(),new Date(Date.now()-864e5+18e5).toISOString(),e=>(a("log","at utils/api.js:101","原始API响应:",e),e?e.data&&!e.data.data?(a("log","at utils/api.js:112","返回data字段:",e.data),e.data):e.data&&e.data.data?(a("log","at utils/api.js:118","返回嵌套data.data字段:",e.data.data),e.data.data):void 0!==e.code&&e.data?(a("log","at utils/api.js:124","返回标准API格式:",e.data),e.data):(a("log","at utils/api.js:129","返回原始响应"),e):null)),b=e=>__async(this,null,(function*(){try{const t=yield e();return null==t?(a("warn","at utils/api.js:143","API调用返回空结果"),[]):t}catch(t){if(a("error","at utils/api.js:148","API调用失败:",t),404===t.statusCode){if(a("error","at utils/api.js:151","API端点不存在:",t.url),a("error","at utils/api.js:152","这可能是因为后端尚未实现此功能，请联系开发者"),t.url&&(t.url.includes("/api/walks")?a("error","at utils/api.js:157","遛狗API端点不存在: /api/walks，尝试使用此路径失败"):t.url.includes("/api/users/me/walks")&&a("error","at utils/api.js:160","遛狗API端点不存在: /api/users/me/walks，尝试使用此路径失败")),t.url&&(t.url.includes("/walks")||t.url.includes("/posts")))return a("warn","at utils/api.js:166","返回空数组以避免UI崩溃"),[]}else if(401===t.statusCode)try{let e="";if("function"==typeof getCurrentPages){const t=getCurrentPages();if(t&&t.length>0){const a=t[t.length-1];e=(null==a?void 0:a.route)||""}}e.includes("/login/")||uni.navigateTo({url:"/pages/login/login"})}catch(s){a("error","at utils/api.js:190","页面跳转错误:",s)}throw t}})),C=(e,t)=>__async(this,null,(function*(){try{a("log","at utils/api.js:207","仅使用真实API，禁用模拟数据");return yield e()}catch(t){throw a("error","at utils/api.js:211","API调用失败，不使用模拟数据:",t),t}})),T={login:e=>_({url:"/api/users/login",method:"POST",data:e,needAuth:!1}),register:e=>_({url:"/api/users/register",method:"POST",data:e,needAuth:!1})},M={getCurrentUser:()=>_({url:"/api/users/me",method:"GET"}),getUserById:e=>__async(this,null,(function*(){try{if(a("log","at utils/api.js:257","获取用户信息, ID:",e),!e)throw a("error","at utils/api.js:261","获取用户信息失败: 无效的用户ID"),new Error("无效的用户ID");const s=yield _({url:`/api/users/${e}`,method:"GET"}),o=x(s);try{const t=uni.getStorageSync("userId");if(t&&t!==e){const t=yield _({url:"/api/users/me",method:"GET"}),s=x(t);if(s&&s.following){const t=(Array.isArray(s.following)?s.following:[]).some((t=>t===e||"object"==typeof t&&t._id===e));a("log","at utils/api.js:294","检查关注状态:",{userId:e,isFollowing:t}),o&&(o.isFollowing=t)}}}catch(t){a("error","at utils/api.js:303","检查关注状态失败:",t)}return o}catch(t){if(a("error","at utils/api.js:309","获取用户信息失败:",t),500===t.statusCode||404===t.statusCode)return a("warn","at utils/api.js:313","服务器错误或用户不存在，返回默认用户数据"),{_id:e,username:"用户"+e.substring(0,4),nickname:"用户"+e.substring(0,4),avatar:"/static/images/default-avatar.png",bio:"该用户暂无介绍",isFollowing:!1};throw t}})),checkFollowStatus:e=>__async(this,null,(function*(){a("log","at utils/api.js:333","专门检查关注状态, 目标用户ID:",e);try{let r=uni.getStorageSync("userId");if(!r)try{const e=uni.getStorageSync("userInfo");if(e){const t=JSON.parse(e);r=t._id||t.id,a("log","at utils/api.js:346","从userInfo中获取当前用户ID:",r)}}catch(t){a("warn","at utils/api.js:349","解析userInfo失败:",t)}if(!r||r===e)return a("log","at utils/api.js:355","当前用户未登录或尝试检查自己，返回未关注状态"),{isFollowing:!1};a("log","at utils/api.js:359","开始直接检查关注状态, 当前用户:",r,"目标用户:",e);try{const t=yield _({url:`/api/users/${e}`,method:"GET"}),s=x(t);if(s&&void 0!==s.isFollowing)return a("log","at utils/api.js:372","从用户详情中获取到关注状态:",s.isFollowing),{isFollowing:s.isFollowing}}catch(s){a("warn","at utils/api.js:376","尝试从用户详情获取关注状态失败:",s)}try{const t=yield _({url:`/api/users/${r}/following`,method:"GET"}),s=x(t);if(a("log","at utils/api.js:388","成功获取关注列表:",(null==s?void 0:s.length)||0,"个用户"),Array.isArray(s)){const t=s.some((t=>t._id===e||"string"==typeof t&&t===e));return a("log","at utils/api.js:397","从关注列表直接检查关注状态:",{userId:e,isFollowing:t}),{isFollowing:t}}}catch(s){a("warn","at utils/api.js:401","尝试从关注列表检查关注状态失败:",s)}const n=yield _({url:"/api/users/me",method:"GET"}),i=x(n);if(a("log","at utils/api.js:412","获取当前用户信息成功, ID:",null==i?void 0:i._id),i&&i._id&&uni.setStorageSync("userId",i._id),i&&"number"==typeof i.following){a("log","at utils/api.js:421","当前用户following字段是数字(关注数量):",i.following);try{const t=yield _({url:`/api/users/${i._id}/following`,method:"GET"}),s=x(t);if(a("log","at utils/api.js:432","通过API获取关注列表:",(null==s?void 0:s.length)||0,"个用户"),Array.isArray(s)){const t=s.some((t=>t._id===e||"string"==typeof t&&t===e));return a("log","at utils/api.js:440","最终检查关注状态结果:",{userId:e,isFollowing:t}),{isFollowing:t}}}catch(o){a("error","at utils/api.js:444","获取完整关注列表失败:",o)}}if(i&&Array.isArray(i.following)){const t=i.following;a("log","at utils/api.js:453","当前用户的关注列表长度:",t.length);let s=!1;for(const o of t){if(o===e){s=!0,a("log","at utils/api.js:461","找到关注关系(ID字符串):",e);break}if(o&&"object"==typeof o&&o._id===e){s=!0,a("log","at utils/api.js:468","找到关注关系(带_id的对象):",o);break}if(o&&"object"==typeof o&&o.userId===e){s=!0,a("log","at utils/api.js:475","找到关注关系(带userId的对象):",o);break}if(o&&"object"==typeof o&&o.user&&(o.user===e||"object"==typeof o.user&&o.user._id===e)){s=!0,a("log","at utils/api.js:484","找到关注关系(带user的对象):",o);break}}return a("log","at utils/api.js:490","关注状态检查结果:",{userId:e,isFollowing:s}),{isFollowing:s}}return a("log","at utils/api.js:494","未找到关注列表或为空，返回未关注状态"),{isFollowing:!1}}catch(s){return a("error","at utils/api.js:497","检查关注状态失败:",s),{isFollowing:!1}}})),updateProfile:e=>{a("log","at utils/api.js:505","准备发送用户更新数据:",e);const t=__spreadValues({},e);return void 0===t.phone&&void 0!==e.phone&&(t.phone=e.phone),void 0===t.gender&&void 0!==e.gender&&(t.gender=e.gender),a("log","at utils/api.js:519","最终发送的用户数据:",t),_({url:"/api/users/me",method:"PUT",data:t}).then((e=>(e&&(e.phone||void 0===t.phone||(e.phone=t.phone),e.gender||void 0===t.gender||(e.gender=t.gender)),e)))},uploadAvatar:e=>new Promise(((t,s)=>{a("log","at utils/api.js:543","开始上传用户头像，文件路径:",e);const o=uni.getStorageSync("token");return o?e?(a("log","at utils/api.js:556","开始上传文件, 路径:",e),void uni.getFileInfo({filePath:e,success:function(r){a("log","at utils/api.js:562","文件信息:",r),uni.uploadFile({url:I+"/api/users/avatar",filePath:e,name:"avatar",formData:{},header:{Authorization:`Bearer ${o}`},success:o=>{if(a("log","at utils/api.js:575","头像上传响应:",o),o.statusCode>=200&&o.statusCode<300)try{const e=JSON.parse(o.data);a("log","at utils/api.js:581","解析后的响应:",e);const s=e.data&&e.data.avatar||e.avatar||"/static/images/default-avatar.png";t({success:!0,avatar:s,data:{avatar:s}})}catch(r){a("error","at utils/api.js:595","解析响应失败:",r),t({success:!0,avatar:e,data:{avatar:e}})}else a("error","at utils/api.js:605","头像上传请求失败，状态码:",o.statusCode),a("error","at utils/api.js:606","失败响应:",o.data),s(new Error("上传失败: "+o.statusCode))},fail:e=>{a("error","at utils/api.js:611","头像上传请求发送失败:",e),s(new Error("网络请求失败: "+(e.errMsg||"未知错误")))}})},fail:function(e){a("error","at utils/api.js:617","获取文件信息失败:",e),s(new Error("文件读取失败: "+(e.errMsg||"未知错误")))}})):s(new Error("无效的文件路径")):s(new Error("请先登录"))})),getUserStats:e=>__async(this,null,(function*(){try{let t="/api/users/stats/me";e&&(t=`/api/users/${e}/stats`);const a=yield _({url:t,method:"GET"});return x(a)}catch(t){throw a("error","at utils/api.js:638","获取用户统计数据失败:",t),t}})),followUser:e=>__async(this,null,(function*(){try{const t=yield _({url:`/api/users/follow/${e}`,method:"POST"});return x(t)}catch(t){throw a("error","at utils/api.js:652","关注用户失败:",t),t}})),getFollowing:e=>__async(this,null,(function*(){try{const t=e||"me";a("log","at utils/api.js:662","请求关注列表:",`/api/users/${t}/following`);const s=yield _({url:`/api/users/${t}/following`,method:"GET"});return x(s)}catch(t){if(a("error","at utils/api.js:670","获取关注列表失败:",t),500===t.statusCode||404===t.statusCode||0===t.statusCode||!t.statusCode)return a("warn","at utils/api.js:674","服务器错误、网络错误或接口不存在，返回模拟关注列表数据"),[{_id:"mock-following-1",username:"宠物达人",nickname:"达人",avatar:"/static/images/default-avatar.png",bio:"分享养宠心得和小技巧",isFollowing:!0},{_id:"mock-following-2",username:"萌宠专家",nickname:"专家",avatar:"/static/images/default-avatar.png",bio:"喜欢一切毛茸茸的小动物",isFollowing:!0}];throw t}})),getFollowers:e=>__async(this,null,(function*(){try{const t=e||"me";a("log","at utils/api.js:706","请求粉丝列表:",`/api/users/${t}/followers`);const s=yield _({url:`/api/users/${t}/followers`,method:"GET"});return x(s)}catch(t){if(a("error","at utils/api.js:714","获取粉丝列表失败:",t),500===t.statusCode||404===t.statusCode||0===t.statusCode||!t.statusCode)return a("warn","at utils/api.js:718","服务器错误、网络错误或接口不存在，返回模拟粉丝列表数据"),[{_id:"mock-follower-1",username:"铲屎官小明",nickname:"小明",avatar:"/static/images/default-avatar.png",bio:"有一只可爱的小猫",isFollowing:!1},{_id:"mock-follower-2",username:"狗狗爱好者",nickname:"爱好者",avatar:"/static/images/default-avatar.png",bio:"养了三只不同品种的狗狗",isFollowing:!0}];throw t}})),getPetsByUser:e=>__async(this,null,(function*(){try{if(a("log","at utils/api.js:748","获取用户宠物列表, ID:",e),!e)throw a("error","at utils/api.js:752","获取用户宠物列表失败: 无效的用户ID"),new Error("无效的用户ID");const t=e||"me",s=yield _({url:`/api/users/${t}/pets`,method:"GET"});return x(s)}catch(t){return a("error","at utils/api.js:763","获取用户宠物列表失败:",t),500!==t.statusCode&&404!==t.statusCode&&0!==t.statusCode&&t.statusCode||a("warn","at utils/api.js:767","服务器错误、网络错误或宠物列表不存在，返回空列表"),[]}})),changePassword:e=>_({url:"/api/users/password",method:"PUT",data:e}),logout:()=>Promise.resolve({success:!0,message:"已退出登录"}),updateFullProfile:e=>{a("log","at utils/api.js:797","准备发送完整用户资料数据:",e);const t=__spreadProps(__spreadValues({},e),{phone:void 0!==e.phone?e.phone:"",gender:void 0!==e.gender?e.gender:"unknown"});a("log","at utils/api.js:807","最终发送的完整用户数据:",t);return _({url:"/api/users/updateProfile",method:"POST",data:t}).catch((e=>(a("warn","at utils/api.js:821","特殊API端点调用失败，尝试使用标准端点:",e),_({url:"/api/users/me",method:"PUT",data:t}).then((e=>(e&&(e.phone||void 0===t.phone||(e.phone=t.phone),e.gender||void 0===t.gender||(e.gender=t.gender)),e))))))}},D={getMyPets:()=>C((()=>_({url:"/api/pets",method:"GET"}))),getPetById:e=>C((()=>_({url:`/api/pets/${e}`,method:"GET"}))).then((e=>e)),addPet:e=>C((()=>_({url:"/api/pets",method:"POST",data:e}))).then((e=>e)),updatePet:(e,t)=>C((()=>_({url:`/api/pets/${e}`,method:"PUT",data:t}))).then((e=>e)),deletePet:e=>C((()=>_({url:`/api/pets/${e}`,method:"DELETE"}))).then((e=>e||{success:!0})),uploadPetAvatar:(e,t)=>new Promise(((s,o)=>{a("log","at utils/api.js:941","开始上传宠物头像，ID:",e,"文件路径:",t);const r=uni.getStorageSync("token");return r?e?t?(a("log","at utils/api.js:1013","准备使用uni.uploadFile上传:",t),t.includes("skip_validation=true")?(a("log","at utils/api.js:1019","检测到跳过验证标志，直接上传文件 (uni.uploadFile)"),void uni.uploadFile({url:`${I}/api/pets/${e}/avatar`,filePath:t,name:"avatar",formData:{},header:{Authorization:`Bearer ${r}`},success:a=>{var r,n;if(a.statusCode>=200&&a.statusCode<300)try{const o=JSON.parse(a.data);s({success:!0,data:{pet:(null==(r=o.data)?void 0:r.pet)||o.pet||{_id:e,avatar:(null==(n=o.data)?void 0:n.avatar)||o.avatar||t}}})}catch(i){s({success:!0,data:{pet:{_id:e,avatar:t}}})}else o({success:!1,message:`上传失败: ${a.statusCode}`,error:a.data})},fail:e=>{o({success:!1,message:"网络请求失败",error:e})}})):void uni.getFileInfo({filePath:t,success:function(n){if(a("log","at utils/api.js:1067","宠物头像文件信息 (uni.uploadFile):",n),n.size>1048576)return o({success:!1,message:"图片大小不能超过1MB",statusCode:413});uni.uploadFile({url:`${I}/api/pets/${e}/avatar`,filePath:t,name:"avatar",formData:{},header:{Authorization:`Bearer ${r}`},success:r=>{var n,i;if(a("log","at utils/api.js:1080","宠物头像上传原始响应 (uni.uploadFile):",r),r.statusCode>=200&&r.statusCode<300)try{const o=JSON.parse(r.data);a("log","at utils/api.js:1084","解析的宠物头像上传响应 (uni.uploadFile):",o),s({success:!0,data:{pet:(null==(n=o.data)?void 0:n.pet)||o.pet||{_id:e,avatar:(null==(i=o.data)?void 0:i.avatar)||o.avatar||t}}})}catch(l){a("error","at utils/api.js:1095","解析宠物头像上传响应失败 (uni.uploadFile):",l),s({success:!0,data:{pet:{_id:e,avatar:t}}})}else a("error","at utils/api.js:1099","宠物头像上传请求失败 (uni.uploadFile):",r.statusCode,r.data),400===r.statusCode&&"string"==typeof r.data&&r.data.includes("Unexpected end of form")?(a("log","at utils/api.js:1102","检测到表单解析错误 (uni.uploadFile)，但H5的备用方案 (getFileSystemManager) 不可用。"),o({success:!1,message:`上传失败: ${r.statusCode}`,error:r.data})):o({success:!1,message:`上传失败: ${r.statusCode}`,error:r.data})},fail:e=>{a("error","at utils/api.js:1110","宠物头像上传网络请求失败 (uni.uploadFile):",e),o({success:!1,message:"网络请求失败",error:e})}})},fail:function(e){a("error","at utils/api.js:1116","获取文件信息失败 (uni.uploadFile):",e),o({success:!1,message:"文件读取失败",error:e})}})):o({success:!1,message:"文件路径无效",statusCode:400}):o({success:!1,message:"宠物ID无效",statusCode:400}):o({success:!1,message:"请先登录",statusCode:401})})),getPetsByUser:e=>__async(this,null,(function*(){try{const t=yield _({url:`/api/users/${e}/pets`,method:"GET"});return x(t)}catch(t){throw a("error","at utils/api.js:1132","获取用户宠物失败:",t),t}})),analyzeImages:e=>new Promise(((t,s)=>{a("log","at utils/api.js:1140","调用服务器端宠物分析API, 数据:",e);const o=uni.getStorageSync("token"),r={Authorization:o?`Bearer ${o}`:"","Content-Type":"application/json"};uni.request({url:`${I}/api/pet/analyze`,method:"POST",data:{imagePaths:e.imagePaths,userId:e.userId||""},header:r,success:e=>{var o;if(a("log","at utils/api.js:1158","宠物分析API响应:",e),200===e.statusCode)t(e.data);else{const t=404===e.statusCode?"API端点不存在，请确认后端服务是否已实现此功能":(null==(o=e.data)?void 0:o.message)||`服务器错误(${e.statusCode})`;a("error","at utils/api.js:1168","服务器返回错误:",t),s(new Error(t))}},fail:e=>{a("error","at utils/api.js:1173","宠物分析请求失败:",e),s(new Error("网络请求失败，请检查网络连接"))}})})),getAnalysisHistory:e=>new Promise(((t,s)=>{uni.request({url:`${I}/api/pet/analysis-history`,method:"GET",data:{userId:e},header:A(),success:e=>{200===e.statusCode?t(e.data):s(new Error(e.data.message||"获取历史记录失败"))},fail:e=>{a("error","at utils/api.js:1196","获取分析历史失败:",e),s(e)}})})),uploadPetDailyPhoto:(e,t)=>(a("log","at utils/api.js:1205","API - 开始上传宠物日常照片，ID:",e,"路径:",t),t.startsWith("blob:")?new Promise(((s,o)=>{try{a("log","at utils/api.js:1211","API - 处理blob URL，准备转换为base64");const r=new Image;r.crossOrigin="anonymous",r.onload=()=>{try{const t=document.createElement("canvas");t.width=r.width,t.height=r.height;t.getContext("2d").drawImage(r,0,0);const n=t.toDataURL("image/jpeg",.9);a("log","at utils/api.js:1226","API - 转换完成，准备以JSON格式发送"),fetch(`${I}/api/pets/${e}/daily-photo`,{method:"POST",headers:{Authorization:`Bearer ${uni.getStorageSync("token")}`,"Content-Type":"application/json"},body:JSON.stringify({imageData:n,description:""})}).then((e=>{if(!e.ok)throw new Error(`上传失败: ${e.status}`);return e.json()})).then((e=>{a("log","at utils/api.js:1247","API - 上传成功:",e),s(e)})).catch((e=>{a("error","at utils/api.js:1251","API - 上传失败:",e),o(e)}))}catch(t){a("error","at utils/api.js:1255","API - Canvas处理失败:",t),o(t)}},r.onerror=e=>{a("error","at utils/api.js:1261","API - 图片加载失败:",e),o(new Error("图片加载失败"))},r.src=t}catch(r){a("error","at utils/api.js:1267","API - 处理blob URL失败:",r),o(r)}})):new Promise(((s,o)=>{a("log","at utils/api.js:1275","API - 处理本地文件上传"),uni.uploadFile({url:`${I}/api/pets/${e}/daily-photo`,filePath:t,name:"photo",header:{Authorization:`Bearer ${uni.getStorageSync("token")}`},success:e=>{let t;a("log","at utils/api.js:1284","API - 照片上传成功");try{t="string"==typeof e.data?JSON.parse(e.data):e.data,s(t)}catch(r){a("error","at utils/api.js:1294","API - 解析上传响应失败:",r),o(r)}},fail:e=>{a("error","at utils/api.js:1299","API - 照片上传失败:",e),o(e)}})})))};function A(){const e=uni.getStorageSync("token");return{Authorization:e?`Bearer ${e}`:"","Content-Type":"application/json"}}const B={auth:T,user:M,pet:D,community:{getPosts:e=>b((()=>_({url:"/api/community/posts",method:"GET",params:e}))),getFollowingPosts:(e=1,t=10)=>b((()=>_({url:"/api/community/posts/following",method:"GET",params:{page:e,limit:t,feed_type:"following"}}))),getMyPosts:e=>{a("log","at utils/api.js:1335","开始获取我的帖子列表，参数:",e);const t=uni.getStorageSync("token");return t?b((()=>_({url:"/api/community/posts/user/me",method:"GET",params:e,header:{Authorization:`Bearer ${t}`}}))).then((e=>(a("log","at utils/api.js:1358","获取我的帖子成功，结果:",e),e?Array.isArray(e)?{data:e}:e.data||"object"!=typeof e?e:{data:[]}:{data:[]}))).catch((e=>{if(a("error","at utils/api.js:1377","获取我的帖子列表失败，错误详情:",e),500===e.statusCode)return a("warn","at utils/api.js:1381","服务器错误(500)，返回空结果以避免UI崩溃"),{data:[]};throw e})):(a("error","at utils/api.js:1340","获取我的帖子失败: 未登录状态"),Promise.reject({message:"请先登录",statusCode:401}))},getPostById:e=>b((()=>_({url:`/api/community/posts/${e}`,method:"GET"}))),createPost:e=>{a("log","at utils/api.js:1401","开始创建帖子，数据:",e);const t=uni.getStorageSync("token");return t?new Promise(((s,o)=>{_({url:"/api/community/posts",method:"POST",data:e,header:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}}).then((e=>{a("log","at utils/api.js:1423","创建帖子成功，响应:",e),s(e)})).catch((e=>{a("error","at utils/api.js:1426","创建帖子失败，错误:",e);let t="创建帖子失败";500===e.statusCode?t="服务器内部错误，请稍后再试":401===e.statusCode?t="登录已过期，请重新登录":400===e.statusCode&&(t="请求参数错误，请检查输入");let s=__spreadProps(__spreadValues({},e),{message:t,originalMessage:e.message});e.data&&e.data.error&&(s=__spreadProps(__spreadValues({},s),{detailedError:e.data.error,message:e.data.message||t}),a("warn","at utils/api.js:1452","帖子创建详细错误:",s)),o(s)}))})):(a("error","at utils/api.js:1406","创建帖子失败: 未登录状态"),Promise.reject({message:"请先登录",statusCode:401}))},updatePost:(e,t)=>{if(a("log","at utils/api.js:1467","更新帖子，ID:",e,"数据:",t),!e||"string"!=typeof e||!e.trim())return a("error","at utils/api.js:1471","更新帖子失败: 无效的帖子ID:",e),Promise.reject(new Error("无效的帖子ID"));t.images&&!Array.isArray(t.images)&&(t.images=[t.images],a("log","at utils/api.js:1478","转换images为数组:",t.images));try{const s=encodeURIComponent(e.trim()),o=`${I}/api/community/posts/${s}`;return a("log","at utils/api.js:1487","更新帖子URL:",o),new Promise(((e,s)=>{uni.request({url:o,data:t,method:"PUT",header:{Authorization:`Bearer ${uni.getStorageSync("token")}`,"Content-Type":"application/json"},success:t=>{const{statusCode:o,data:r}=t;o>=200&&o<300?(a("log","at utils/api.js:1502","更新帖子成功，响应:",r),e(r)):(a("error","at utils/api.js:1505","更新帖子失败，HTTP状态:",o,r),s({message:(null==r?void 0:r.message)||`更新失败(${o})`,statusCode:o,data:r}))},fail:e=>{a("error","at utils/api.js:1514","更新帖子请求失败:",e),s({message:"网络请求失败",error:e})}})}))}catch(s){return a("error","at utils/api.js:1523","构造更新帖子请求失败:",s),Promise.reject(s)}},deletePost:e=>{a("log","at utils/api.js:1530","尝试删除帖子，ID:",e);const t=uni.getStorageSync("token");return t?new Promise(((s,o)=>{_({url:`/api/community/posts/${e}`,method:"DELETE",header:{Authorization:`Bearer ${t}`}}).then((e=>{a("log","at utils/api.js:1550","删除帖子成功，响应:",e),s(e)})).catch((e=>{a("error","at utils/api.js:1553","删除帖子失败，错误:",e);let t="删除帖子失败";500===e.statusCode?t="服务器内部错误，请稍后再试":401===e.statusCode?t="没有权限删除此帖子":404===e.statusCode&&(t="帖子不存在或已被删除"),o(__spreadProps(__spreadValues({},e),{message:t,originalMessage:e.message}))}))})):(a("error","at utils/api.js:1535","删除帖子失败: 未登录状态"),Promise.reject({message:"请先登录",statusCode:401}))},likePost:e=>_({url:`/api/community/posts/${e}/like`,method:"POST"}),unlikePost:e=>_({url:`/api/community/posts/${e}/like`,method:"DELETE"}),getComments:(e,t)=>b((()=>_({url:`/api/community/posts/${e}/comments`,method:"GET",params:t}))),addComment:(e,t)=>_({url:`/api/community/posts/${e}/comment`,method:"POST",data:t}),deleteComment:(e,t)=>_({url:`/api/community/posts/${e}/comment/${t}`,method:"DELETE"}),getImageUploadUrl:e=>`${I}/api/community/posts/${e}/image`,uploadPostImage:(e,t)=>new Promise(((s,o)=>{a("log","at utils/api.js:1627","开始上传帖子图片到服务器:",t),uni.uploadFile({url:`${I}/api/community/posts/${e}/image`,filePath:t,name:"image",header:{Authorization:`Bearer ${uni.getStorageSync("token")}`},success:e=>{if(a("log","at utils/api.js:1638","图片上传响应:",e),e.statusCode>=200&&e.statusCode<300)try{const r=JSON.parse(e.data);a("log","at utils/api.js:1644","解析的图片上传响应:",r);const n=r.url||r.imageUrl||r.data&&(r.data.url||r.data.imageUrl)||t;if(n)a("log","at utils/api.js:1652","成功获取图片URL:",n),s({success:!0,url:n,message:"图片已上传成功"});else{if(a("error","at utils/api.js:1660","服务器响应中未找到图片URL:",r),r&&!1===r.success)return void o(new Error(r.message||"图片上传失败"));s({success:!0,url:t,message:"已上传但未获取服务器URL，使用本地路径"})}}catch(r){a("error","at utils/api.js:1673","解析图片上传响应失败:",r),s({success:!0,url:t,message:"图片已上传但解析响应失败"})}else a("error","at utils/api.js:1683",`图片上传失败，状态码: ${e.statusCode}`),a("error","at utils/api.js:1684","错误响应:",e.data),o(new Error(`图片上传失败: ${e.statusCode}`))},fail:r=>{a("error","at utils/api.js:1689","图片上传请求失败:",r),a("warn","at utils/api.js:1691","图片上传失败，尝试使用本地路径"),_({url:`${I}/api/community/posts/${e}`,method:"PUT",data:{images:[t]}}).then((()=>{a("log","at utils/api.js:1701","已使用本地路径作为后备方案更新帖子"),s({success:!0,url:t,message:"使用本地图片路径(上传失败)"})})).catch((e=>{a("error","at utils/api.js:1708","使用本地路径更新帖子也失败:",e),o(new Error("图片上传和更新都失败: "+(r.errMsg||"未知错误")))}))}})}))},walk:{getMyWalks:e=>b((()=>_({url:"/api/walks",method:"GET",params:e}))),getWalkById:e=>b((()=>_({url:`/api/walks/${e}`,method:"GET"}))),startWalk:e=>_({url:"/api/walks/start",method:"POST",data:e}),endWalk:(e,t)=>_({url:`/api/walks/${e}/end`,method:"POST",data:t}),deleteWalk:e=>_({url:`/api/walks/${e}`,method:"DELETE"}),updateWalkPoint:(e,t)=>_({url:`/api/walks/${e}/point`,method:"POST",data:t})},location:{updateLocation:e=>b((()=>_({url:"/api/locations/update",method:"PUT",data:e}))),getNearbyUsers:e=>b((()=>_({url:"/api/locations/nearby",method:"GET",params:e}))),toggleLocationSharing:e=>b((()=>_({url:"/api/locations/sharing",method:"PUT",data:e}))),getLocationSharingStatus:()=>b((()=>_({url:"/api/locations/sharing",method:"GET"}))),getUserPets:e=>b((()=>_({url:`/api/pets/user/${e}`,method:"GET"}))),checkFollowStatus:e=>b((()=>_({url:`/api/users/follow/check/${e}`,method:"GET"})))},chat:{sendNearbyMessage:e=>__async(this,null,(function*(){try{const t=yield _({url:"/api/chat/nearby",method:"POST",data:e});return x(t)}catch(t){throw a("error","at utils/api.js:1885","发送附近消息失败:",t),t}})),sendCityMessage:e=>__async(this,null,(function*(){try{const t=yield _({url:"/api/chat/city",method:"POST",data:e});return x(t)}catch(t){throw a("error","at utils/api.js:1904","发送城市消息失败:",t),t}})),getNearbyMessages:e=>__async(this,null,(function*(){try{const t=yield _({url:"/api/chat/nearby",method:"GET",params:e});return x(t)}catch(t){throw a("error","at utils/api.js:1923","获取附近消息失败:",t),t}})),getCityMessages:e=>__async(this,null,(function*(){try{const t=yield _({url:"/api/chat/city",method:"GET",params:e});return x(t)}catch(t){throw a("error","at utils/api.js:1942","获取城市消息失败:",t),t}})),sendPrivateMessage:e=>__async(this,null,(function*(){try{if(!e.receiverId||!e.content)throw new Error("发送消息需要接收者ID和消息内容");const t=yield _({url:"/api/chat/private",method:"POST",data:e});return x(t)}catch(t){throw a("error","at utils/api.js:1966","发送私聊消息失败:",t),t}})),getPrivateMessages:e=>__async(this,null,(function*(){try{if(!e.targetUserId)throw new Error("获取私聊消息需要目标用户ID");const t=yield _({url:"/api/chat/private",method:"GET",params:e});return x(t)}catch(t){throw a("error","at utils/api.js:1990","获取私聊消息失败:",t),t}})),markMessagesAsRead:e=>__async(this,null,(function*(){try{if(!e)throw new Error("标记消息已读需要目标用户ID");const t=yield _({url:`/api/chat/read/${e}`,method:"POST"});return x(t)}catch(t){throw a("error","at utils/api.js:2012","标记消息已读失败:",t),t}})),getUnreadCount:()=>__async(this,null,(function*(){try{const e=yield _({url:"/api/chat/unread",method:"GET"});return x(e)}catch(e){throw a("error","at utils/api.js:2029","获取未读消息数量失败:",e),e}}))},upload:{uploadImage:(e,t={})=>new Promise(((s,o)=>{if(a("log","at utils/api.js:2053","开始上传图片, 文件路径:",e),!e)return a("error","at utils/api.js:2057","上传失败: 无效的文件路径"),o(new Error("无效的文件路径"));const r=uni.getStorageSync("token");uni.uploadFile({url:`${I}/api/upload/image`,filePath:e,name:"file",formData:t,header:{Authorization:r?`Bearer ${r}`:""},success:t=>{if(a("log","at utils/api.js:2075","图片上传响应:",t),t.statusCode>=200&&t.statusCode<300)try{const o=JSON.parse(t.data);a("log","at utils/api.js:2080","解析上传响应:",o);const r=o.url||o.imageUrl||o.data&&(o.data.url||o.data.imageUrl)||e;s({success:!0,url:r,path:r})}catch(r){a("error","at utils/api.js:2095","解析响应失败:",r),s({success:!0,url:e,path:e})}else a("error","at utils/api.js:2104","图片上传失败, 状态码:",t.statusCode),o(new Error(`上传失败: ${t.statusCode}`))},fail:e=>{a("error","at utils/api.js:2120","图片上传请求失败:",e),o(e)}})}))}};
/*!
   * pinia v2.1.7
   * (c) 2023 Eduardo San Martin Morote
   * @license MIT
   */
let U;const j=e=>U=e,F=Symbol();function $(e){return e&&"object"==typeof e&&"[object Object]"===Object.prototype.toString.call(e)&&"function"!=typeof e.toJSON}var L,R;(R=L||(L={})).direct="direct",R.patchObject="patch object",R.patchFunction="patch function";const O=()=>{};function W(t,a,s,o=O){t.push(a);const r=()=>{const e=t.indexOf(a);e>-1&&(t.splice(e,1),o())};return!s&&e.getCurrentScope()&&e.onScopeDispose(r),r}function z(e,...t){e.slice().forEach((e=>{e(...t)}))}const J=e=>e();function q(t,a){t instanceof Map&&a instanceof Map&&a.forEach(((e,a)=>t.set(a,e))),t instanceof Set&&a instanceof Set&&a.forEach(t.add,t);for(const s in a){if(!a.hasOwnProperty(s))continue;const o=a[s],r=t[s];$(r)&&$(o)&&t.hasOwnProperty(s)&&!e.isRef(o)&&!e.isReactive(o)?t[s]=q(r,o):t[s]=o}return t}const H=Symbol();const{assign:G}=Object;function Q(t,a,s={},o,r,n){let i;const l=G({actions:{}},s),c={deep:!0};let u,d,m,p=[],g=[];const v=o.state.value[t];let h;function f(a){let s;u=d=!1,"function"==typeof a?(a(o.state.value[t]),s={type:L.patchFunction,storeId:t,events:m}):(q(o.state.value[t],a),s={type:L.patchObject,payload:a,storeId:t,events:m});const r=h=Symbol();e.nextTick().then((()=>{h===r&&(u=!0)})),d=!0,z(p,s,o.state.value[t])}n||v||(o.state.value[t]={}),e.ref({});const y=n?function(){const{state:e}=s,t=e?e():{};this.$patch((e=>{G(e,t)}))}:O;function w(e,a){return function(){j(o);const s=Array.from(arguments),r=[],n=[];let i;z(g,{args:s,name:e,store:E,after:function(e){r.push(e)},onError:function(e){n.push(e)}});try{i=a.apply(this&&this.$id===t?this:E,s)}catch(l){throw z(n,l),l}return i instanceof Promise?i.then((e=>(z(r,e),e))).catch((e=>(z(n,e),Promise.reject(e)))):(z(r,i),i)}}const k={_p:o,$id:t,$onAction:W.bind(null,g),$patch:f,$reset:y,$subscribe(a,s={}){const r=W(p,a,s.detached,(()=>n())),n=i.run((()=>e.watch((()=>o.state.value[t]),(e=>{("sync"===s.flush?d:u)&&a({storeId:t,type:L.direct,events:m},e)}),G({},c,s))));return r},$dispose:function(){i.stop(),p=[],g=[],o._s.delete(t)}},E=e.reactive(k);o._s.set(t,E);const N=(o._a&&o._a.runWithContext||J)((()=>o._e.run((()=>(i=e.effectScope()).run(a)))));for(const _ in N){const a=N[_];if(e.isRef(a)&&(V=a,!e.isRef(V)||!V.effect)||e.isReactive(a))n||(!v||$(S=a)&&S.hasOwnProperty(H)||(e.isRef(a)?a.value=v[_]:q(a,v[_])),o.state.value[t][_]=a);else if("function"==typeof a){const e=w(_,a);N[_]=e,l.actions[_]=a}}var S,V;return G(E,N),G(e.toRaw(E),N),Object.defineProperty(E,"$state",{get:()=>o.state.value[t],set:e=>{f((t=>{G(t,e)}))}}),o._p.forEach((e=>{G(E,i.run((()=>e({store:E,app:o._a,pinia:o,options:l}))))})),v&&n&&s.hydrate&&s.hydrate(E.$state,v),u=!0,d=!0,E}function K(t,a,s){let o,r;const n="function"==typeof a;function i(t,s){const i=e.hasInjectionContext();(t=t||(i?e.inject(F,null):null))&&j(t),(t=U)._s.has(o)||(n?Q(o,a,r,t):function(t,a,s){const{state:o,actions:r,getters:n}=a,i=s.state.value[t];let l;l=Q(t,(function(){i||(s.state.value[t]=o?o():{});const a=e.toRefs(s.state.value[t]);return G(a,r,Object.keys(n||{}).reduce(((a,o)=>(a[o]=e.markRaw(e.computed((()=>{j(s);const e=s._s.get(t);return n[o].call(e,e)}))),a)),{}))}),a,s,0,!0)}(o,r,t));return t._s.get(o)}return"string"==typeof t?(o=t,r=n?s:a):(r=t,o=t.id),i.$id=o,i}const Y=K("pet",{state:()=>({pets:[],currentPet:null,loading:!1,error:null}),getters:{hasPets:e=>e.pets.length>0},actions:{restorePetState(){try{const e=uni.getStorageSync("pets"),t=uni.getStorageSync("currentPet");e&&(this.pets=JSON.parse(e)),t&&(this.currentPet=JSON.parse(t))}catch(e){a("error","at store/pet.js:34","恢复宠物状态失败:",e)}},savePetState(){try{uni.setStorageSync("pets",JSON.stringify(this.pets)),this.currentPet&&uni.setStorageSync("currentPet",JSON.stringify(this.currentPet))}catch(e){a("error","at store/pet.js:46","保存宠物状态失败:",e)}},fetchPets(){return __async(this,null,(function*(){try{this.loading=!0,this.error=null;if(!X().isAuthenticated)return this.pets=[],[];const e=yield B.pet.getMyPets();return this.pets=e&&Array.isArray(e)?e:[],this.pets.length>0&&!this.currentPet&&(this.currentPet=this.pets[0]),this.savePetState(),this.pets}catch(e){return a("error","at store/pet.js:82","获取宠物列表失败:",e),this.error="获取宠物列表失败",this.pets&&this.pets.length||(this.restorePetState(),this.pets||(this.pets=[])),this.pets||[]}finally{this.loading=!1}}))},getPetById(e){return __async(this,null,(function*(){const t=this.pets.find((t=>t.id===e||t._id===e));if(t)return t.dailyPhotos&&Array.isArray(t.dailyPhotos)&&a("log","at store/pet.js:102","从本地获取宠物信息，处理照片URL"),t;try{this.loading=!0,this.error=null;const t=yield B.pet.getPetById(e);return t?(t.dailyPhotos&&Array.isArray(t.dailyPhotos)&&a("log","at store/pet.js:116","从API获取宠物信息，处理照片URL:",t.dailyPhotos.length),t):null}catch(s){return a("error","at store/pet.js:122","获取宠物详情失败:",s),this.error="获取宠物详情失败",null}finally{this.loading=!1}}))},createPet(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null;const t=yield B.pet.addPet(e);return yield this.fetchPets(),t}catch(t){throw a("error","at store/pet.js:141","创建宠物失败:",t),this.error="创建宠物失败",t}finally{this.loading=!1}}))},updatePet(e,t){return __async(this,null,(function*(){try{this.loading=!0,this.error=null,a("log","at store/pet.js:155","更新宠物信息，ID:",e,"数据:",t);const s=yield B.pet.updatePet(e,t);a("log","at store/pet.js:159","更新宠物API响应:",s),yield this.fetchPets();const o=this.pets.find((t=>t._id===e||t.id===e));return this.currentPet&&(this.currentPet._id===e||this.currentPet.id===e)&&o&&(this.currentPet=o),this.savePetState(),o||s}catch(s){throw a("error","at store/pet.js:177","更新宠物信息失败:",s),this.error="更新宠物信息失败",s}finally{this.loading=!1}}))},deletePet(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null,a("log","at store/pet.js:191","删除宠物，ID:",e);return a("log","at store/pet.js:195","删除宠物API响应:",yield B.pet.deletePet(e)),this.pets=this.pets.filter((t=>t._id!==e&&t.id!==e)),!this.currentPet||this.currentPet._id!==e&&this.currentPet.id!==e||(this.currentPet=this.pets.length>0?this.pets[0]:null),this.savePetState(),{success:!0}}catch(t){throw a("error","at store/pet.js:212","删除宠物失败:",t),this.error="删除宠物失败",t}finally{this.loading=!1}}))},uploadPetAvatar(e,t){return __async(this,null,(function*(){try{this.loading=!0,this.error=null,a("log","at store/pet.js:226","开始上传宠物头像:",e,t);const s=yield B.pet.uploadPetAvatar(e,t);if(a("log","at store/pet.js:230","头像上传结果:",s),s){yield this.fetchPets();const t=this.pets.find((t=>t._id===e||t.id===e));t&&(a("log","at store/pet.js:241","头像更新后的宠物:",t),!this.currentPet||this.currentPet._id!==e&&this.currentPet.id!==e||(this.currentPet=t)),this.savePetState()}return s}catch(s){throw a("error","at store/pet.js:255","上传宠物头像失败:",s),this.error="上传宠物头像失败",s}finally{this.loading=!1}}))},setCurrentPet(e){this.currentPet=e,this.savePetState()},clearPets(){this.pets=[],this.currentPet=null,this.error=null;try{uni.removeStorageSync("pets"),uni.removeStorageSync("currentPet")}catch(e){a("error","at store/pet.js:280","清除宠物数据失败:",e)}},addPet(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null,a("log","at store/pet.js:290","添加宠物，数据:",e);const t=yield B.pet.addPet(e);if(a("log","at store/pet.js:294","添加宠物API响应:",t),yield this.fetchPets(),!this.currentPet&&this.pets&&this.pets.length>0){const e=this.pets[this.pets.length-1];this.setCurrentPet(e)}return this.savePetState(),t}catch(t){throw a("error","at store/pet.js:311","添加宠物失败:",t),this.error="添加宠物失败",t}finally{this.loading=!1}}))},uploadPetDailyPhoto(e,t){return __async(this,null,(function*(){this.loading=!0,this.error=null;try{a("log","at store/pet.js:325","上传宠物日常照片:",e,t);const s=`${uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000"}/api/pets/${e}/daily-photo`,o=uni.getStorageSync("token");return t.startsWith("blob:")?new Promise(((e,r)=>{try{a("log","at store/pet.js:336","处理blob URL:",t);const n=new Image;n.crossOrigin="anonymous",n.onload=()=>{try{const t=document.createElement("canvas");t.width=n.width,t.height=n.height;t.getContext("2d").drawImage(n,0,0);const i=t.toDataURL("image/jpeg",.9);a("log","at store/pet.js:351","转换完成，准备发送base64数据"),fetch(s,{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({imageData:i,description:""})}).then((e=>{if(!e.ok)throw new Error(`上传失败: ${e.status}`);return e.json()})).then((t=>{a("log","at store/pet.js:372","上传成功:",t),e(t)})).catch((e=>{a("error","at store/pet.js:376","上传错误:",e),r(e)}))}catch(t){a("error","at store/pet.js:380","Canvas处理失败:",t),r(t)}},n.onerror=e=>{a("error","at store/pet.js:386","图片加载失败:",e),r(new Error("图片加载失败"))},n.src=t}catch(n){a("error","at store/pet.js:392","处理blob URL失败:",n),r(n)}})):new Promise(((e,r)=>{a("log","at store/pet.js:399","处理本地文件路径:",t),uni.uploadFile({url:s,filePath:t,name:"photo",header:{Authorization:`Bearer ${o}`},success:t=>{let s;a("log","at store/pet.js:409","照片上传成功:",t);try{s="string"==typeof t.data?JSON.parse(t.data):t.data,e(s)}catch(o){a("error","at store/pet.js:421","解析上传响应失败:",o),r(o)}},fail:e=>{a("error","at store/pet.js:426","照片上传失败:",e),r(e)},complete:()=>{this.loading=!1}})}))}catch(s){throw a("error","at store/pet.js:436","上传宠物日常照片失败:",s),this.error=s.message||"上传宠物日常照片失败",s}finally{this.loading=!1}}))}}}),X=K("user",{state:()=>({user:null,token:uni.getStorageSync("token")||null,loading:!1,error:null,stats:null}),getters:{isAuthenticated:e=>!!e.token&&!!e.user,userAvatar:e=>e.user?e.user.avatar||"/static/images/default-avatar.png":"",userId:e=>{var t,a;return(null==(t=e.user)?void 0:t._id)||(null==(a=e.user)?void 0:a.id)||""},nickname:e=>{var t,a;return(null==(t=e.user)?void 0:t.nickname)||(null==(a=e.user)?void 0:a.username)||"游客"}},actions:{login(e,t){return __async(this,null,(function*(){try{this.loading=!0,this.error=null;const s=yield B.user.login(e,t);if(a("log","at store/user.js:33","登录响应:",s),s&&s.token){if(uni.setStorageSync("token",s.token),s.user){const e=__spreadValues({},s.user);e.gender||(a("warn","at store/user.js:44","登录响应中用户信息没有gender字段，设置为默认值unknown"),e.gender="unknown"),this.user=e,uni.setStorageSync("userInfo",JSON.stringify(e)),a("log","at store/user.js:50","登录成功，用户信息已保存:",{user:this.user,gender:this.user.gender})}else a("log","at store/user.js:56","登录响应中无用户信息，获取用户信息"),yield this.fetchUserInfo();return!0}return this.error="登录失败，请检查用户名和密码",!1}catch(s){return a("error","at store/user.js:66","登录失败:",s),this.error="登录失败，请检查网络连接",!1}finally{this.loading=!1}}))},register(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null;return yield B.auth.register(e)}catch(t){throw a("error","at store/user.js:82","注册失败:",t),this.error=t.message||"注册失败，请稍后再试",t}finally{this.loading=!1}}))},fetchUserInfo(){return __async(this,null,(function*(){try{a("log","at store/user.js:93","开始获取用户信息"),this.loading=!0,this.error=null;let t=null;try{const e=uni.getStorageSync("userInfo");e&&(t=JSON.parse(e),a("log","at store/user.js:103","已获取本地存储的用户信息用于备份:",t))}catch(e){a("warn","at store/user.js:106","读取本地用户信息失败:",e)}const s=yield B.user.getCurrentUser();if(a("log","at store/user.js:111","从API获取到的用户信息:",s),s){const e=__spreadValues({},s);return!e.gender&&t&&t.gender?(a("warn","at store/user.js:119","API响应中缺少gender字段，使用本地存储的值:",t.gender),e.gender=t.gender):e.gender||(a("warn","at store/user.js:123","没有找到gender字段，设置为默认值unknown"),e.gender="unknown"),this.user=e,uni.setStorageSync("userInfo",JSON.stringify(e)),a("log","at store/user.js:131","最终更新后的用户信息，确认性别字段存在:",{user:this.user,gender:this.user.gender}),e}if(t)return a("warn","at store/user.js:140","API返回为空，使用本地用户信息:",t),this.user=t,t;throw new Error("获取用户信息失败，返回为空")}catch(t){return a("error","at store/user.js:148","获取用户信息失败:",t),this.error="获取用户信息失败",null}finally{this.loading=!1}}))},updateUserInfo(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null;const s=__spreadProps(__spreadValues({},e),{phone:void 0!==e.phone?e.phone:"",gender:e.gender||"unknown"});a("log","at store/user.js:170","发送到服务器的完整用户数据，特别关注性别字段:",s);let o=null;try{a("log","at store/user.js:176","使用特殊API更新用户前的数据检查:",{gender:s.gender,phone:s.phone}),o=yield B.user.updateFullProfile(s),a("log","at store/user.js:182","使用特殊API更新用户成功:",o),o&&!o.gender&&s.gender&&(a("warn","at store/user.js:186","响应中缺少gender字段，手动添加"),o.gender=s.gender)}catch(t){a("warn","at store/user.js:190","特殊API调用失败，使用标准API:",t),o=yield B.user.updateProfile(s),a("log","at store/user.js:193","使用标准API更新用户成功:",o),o&&!o.gender&&s.gender&&(a("warn","at store/user.js:197","响应中缺少gender字段，手动添加"),o.gender=s.gender)}if(o){const e=__spreadValues({},this.user);return Object.keys(o).forEach((t=>{e[t]=o[t]})),!e.gender&&s.gender&&(e.gender=s.gender),!e.phone&&s.phone&&(e.phone=s.phone),this.user=e,uni.setStorageSync("userInfo",JSON.stringify(e)),a("log","at store/user.js:227","最终更新后的用户数据，确认性别字段存在:",{user:this.user,gender:this.user.gender}),e}return o}catch(s){return a("error","at store/user.js:237","更新用户信息失败:",s),this.error="更新用户信息失败",null}finally{this.loading=!1}}))},uploadAvatar(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null,a("log","at store/user.js:251","开始上传头像:",e);const t=yield B.user.uploadAvatar(e);return a("log","at store/user.js:256","头像上传响应:",t),t&&t.data&&t.data.avatar?this.user&&(this.user.avatar=t.data.avatar,uni.setStorageSync("userInfo",JSON.stringify(this.user)),a("log","at store/user.js:264","用户头像已更新:",this.user.avatar)):t&&t.avatar&&this.user&&(this.user.avatar=t.avatar,uni.setStorageSync("userInfo",JSON.stringify(this.user)),a("log","at store/user.js:272","用户头像已更新(直接返回):",this.user.avatar)),t.data||t}catch(t){return a("error","at store/user.js:279","上传头像失败:",t),this.error="上传头像失败",null}finally{this.loading=!1}}))},fetchUserStats(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null;if(!(e||(this.user?this.user._id:null)))return null;const t=e?yield B.user.getUserStats(e):yield B.user.getUserStats();return(!e||this.user&&this.user._id===e)&&(this.stats=t),t}catch(t){return a("error","at store/user.js:309","获取用户统计信息失败:",t),this.error="获取用户统计信息失败",null}finally{this.loading=!1}}))},followUser(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null;const t=yield B.user.followUser(e);return this.stats&&(this.stats.followingCount+=1),t}catch(t){throw a("error","at store/user.js:329","关注用户失败:",t),this.error="关注用户失败",t}finally{this.loading=!1}}))},unfollowUser(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null;const t=yield B.user.unfollowUser(e);return this.stats&&this.stats.followingCount>0&&(this.stats.followingCount-=1),t}catch(t){throw a("error","at store/user.js:349","取消关注用户失败:",t),this.error="取消关注用户失败",t}finally{this.loading=!1}}))},changePassword(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null;return yield B.user.changePassword(e)}catch(t){throw a("error","at store/user.js:365","修改密码失败:",t),this.error="修改密码失败",t}finally{this.loading=!1}}))},logout(){return __async(this,null,(function*(){try{return this.loading=!0,!0}catch(e){throw a("error","at store/user.js:380","退出登录失败:",e),e}finally{this.user=null,this.token=null,this.stats=null,this.error=null,uni.removeStorageSync("token"),uni.removeStorageSync("userInfo");Y().clearPets(),this.loading=!1}}))},init(){return __async(this,null,(function*(){try{if(this.token){const s=uni.getStorageSync("userInfo");if(s)try{const e=JSON.parse(s);e&&e._id&&(this.user=e,a("log","at store/user.js:414","已从本地存储加载用户信息:",this.user))}catch(e){a("error","at store/user.js:417","解析存储的用户信息失败:",e)}yield this.fetchUserInfo();if(this.user){try{yield this.fetchUserStats()}catch(t){a("warn","at store/user.js:429","获取用户统计数据失败，继续初始化流程:",t)}try{const e=Y();yield e.fetchPets()}catch(t){a("warn","at store/user.js:437","获取宠物列表失败，继续初始化流程:",t)}}}}catch(t){a("error","at store/user.js:442","用户初始化失败:",t),this.token=null,uni.removeStorageSync("token")}}))},updateLocation(e){return __async(this,null,(function*(){try{return this.currentLocation=e,this.token&&(yield B.location.updateLocation({latitude:e.latitude,longitude:e.longitude,timestamp:(new Date).toISOString()})),e}catch(t){return a("error","at store/user.js:463","更新位置失败:",t),null}}))}}}),Z={__name:"login",setup(t){const s=e.ref({username:"",password:""}),o=e.ref(!1),r=e.computed((()=>s.value.username.trim()&&s.value.password.trim()));function n(){return __async(this,null,(function*(){if(r.value){o.value=!0,d("登录中...");try{const o=X(),r=yield B.auth.login({username:s.value.username,password:s.value.password});a("log","at pages/login/login.vue:68","登录响应:",r);let n=r;if(r&&r.data&&(n=r.data),!n||!n.token&&!n.accessToken)throw a("error","at pages/login/login.vue:80","无效的响应数据:",n),new Error("登录失败：服务器响应格式不正确");const i=n.token||n.accessToken;uni.setStorageSync("token",i),o.token=i;let l=n.user;n.user?(o.user=n.user,uni.setStorageSync("userInfo",JSON.stringify(n.user))):n._id||n.id?(l={username:s.value.username,nickname:n.nickname||s.value.username,_id:n._id||n.id||Date.now().toString(),avatar:n.avatar||"/static/images/default-avatar.png"},o.user=l,uni.setStorageSync("userInfo",JSON.stringify(l))):(l=__spreadValues({username:s.value.username},n),o.user=l,uni.setStorageSync("userInfo",JSON.stringify(l)));try{a("log","at pages/login/login.vue:116","登录成功后获取完整用户信息");const e=yield o.fetchUserInfo();e&&(l=e,uni.setStorageSync("userInfo",JSON.stringify(e)),a("log","at pages/login/login.vue:123","已获取并保存最新用户信息:",e))}catch(e){a("error","at pages/login/login.vue:126","获取完整用户信息失败:",e)}a("log","at pages/login/login.vue:131","检查用户资料完整性:",l);const c=function(e){const t=["nickname","email"];if(!e)return a("log","at pages/login/login.vue:217","用户信息不存在"),!1;for(const s of t)if(!e[s]||"string"==typeof e[s]&&""===e[s].trim())return a("log","at pages/login/login.vue:224",`用户信息不完整: 缺少 ${s} 或为空值`),!1;if(!e.avatar||"/static/images/default-avatar.png"===e.avatar||"static/images/default-avatar.png"===e.avatar)return a("log","at pages/login/login.vue:233","用户信息不完整: 未上传头像"),!1;return a("log","at pages/login/login.vue:237","用户信息完整性检查通过:",e),!0}(l);if(a("log","at pages/login/login.vue:133","用户资料是否完整:",c),c){u({title:"登录成功",icon:"success"});try{uni.setStorageSync("hasCompletedFirstLogin","true")}catch(t){a("error","at pages/login/login.vue:159","保存登录状态失败:",t)}setTimeout((()=>{uni.switchTab({url:"/pages/index/index"})}),1500)}else u({title:"请完善个人资料",icon:"none",duration:2e3}),setTimeout((()=>{uni.redirectTo({url:"/pages/profile/profile?firstLogin=true"})}),1e3)}catch(n){a("error","at pages/login/login.vue:170","登录失败:",n),"LOGIN_FAILED"===n.type?(u({title:"账号未注册，请先注册",icon:"none",duration:2e3}),setTimeout((()=>{try{g("/pages/login/register")}catch(e){a("error","at pages/login/login.vue:185","跳转到注册页面失败:",e)}}),1500)):401===n.statusCode?u({title:"用户名或密码错误",icon:"none"}):u({title:n.message||"登录失败，请稍后再试",icon:"none"})}finally{o.value=!1,m()}}}))}function i(){try{g("/pages/login/register")}catch(e){a("error","at pages/login/login.vue:248","跳转到注册页面失败:",e),u("注册功能即将推出!")}}return(t,a)=>(e.openBlock(),e.createElementBlock("view",{class:"login-container"},[e.createElementVNode("view",{class:"logo-container"},[e.createElementVNode("image",{class:"logo",src:c,mode:"aspectFit"}),e.createElementVNode("text",{class:"app-name"},"遛宠派")]),e.createElementVNode("view",{class:"form-container"},[e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("text",{class:"label"},"用户名"),e.withDirectives(e.createElementVNode("input",{class:"input",type:"text","onUpdate:modelValue":a[0]||(a[0]=e=>s.value.username=e),placeholder:"请输入用户名"},null,512),[[e.vModelText,s.value.username]])]),e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("text",{class:"label"},"密码"),e.withDirectives(e.createElementVNode("input",{class:"input",type:"password","onUpdate:modelValue":a[1]||(a[1]=e=>s.value.password=e),placeholder:"请输入密码"},null,512),[[e.vModelText,s.value.password]])]),e.createElementVNode("button",{class:e.normalizeClass(["login-btn",{loading:o.value}]),disabled:!r.value||o.value,onClick:n},e.toDisplayString(o.value?"登录中...":"登 录"),11,["disabled"]),e.createElementVNode("view",{class:"footer"},[e.createElementVNode("text",{class:"register-link",onClick:i},"没有账号？去注册")])])]))}},ee={__name:"register",setup(t){const s=e.ref({username:"",password:"",confirmPassword:"",email:"",nickname:""}),o=e.ref(!1),r=e.computed((()=>{const{username:e,password:t,confirmPassword:a,email:o}=s.value;return e.trim()&&t.trim()&&t.length>=6&&a.trim()&&o.trim()&&t===a}));function n(){return __async(this,null,(function*(){var e,t,r;if(s.value.password.length<6)u({title:"密码长度不能少于6个字符",icon:"none"});else if(s.value.password===s.value.confirmPassword)if(n=s.value.email,/\S+@\S+\.\S+/.test(n)){var n;o.value=!0,d("注册中...");try{const e=yield uni.$api.auth.register({username:s.value.username,password:s.value.password,email:s.value.email,nickname:s.value.nickname||s.value.username});a("log","at pages/login/register.vue:126","注册响应:",e);let t=e;if(e&&e.data&&(t=e.data),!t||!t.token&&!t.accessToken)throw a("error","at pages/login/register.vue:136","无效的响应数据:",t),new Error("注册失败：服务器响应格式不正确");const o=t.token||t.accessToken;if(uni.setStorageSync("token",o),t.user)uni.setStorageSync("userInfo",JSON.stringify(t.user));else{const e={username:s.value.username,nickname:s.value.nickname||s.value.username,_id:t._id||t.id||Date.now().toString(),avatar:"/static/images/default-avatar.png"};uni.setStorageSync("userInfo",JSON.stringify(e))}u({title:"注册成功，请完善信息",icon:"success"}),setTimeout((()=>{uni.redirectTo({url:"/pages/profile/profile?firstLogin=true"})}),1500)}catch(i){a("error","at pages/login/register.vue:169","注册失败:",i),500===i.statusCode?(a("error","at pages/login/register.vue:173","服务器响应详情:",i.data),(null==(e=i.data)?void 0:e.error)&&i.data.error.includes("password")&&i.data.error.includes("shorter than the minimum")?u({title:"密码长度不能少于6个字符",icon:"none",duration:3e3}):(null==(t=i.data)?void 0:t.error)&&i.data.error.includes("email")&&i.data.error.includes("invalid")?u({title:"请输入有效的邮箱地址",icon:"none",duration:3e3}):(null==(r=i.data)?void 0:r.error)&&i.data.error.includes("required")?u({title:"请填写所有必填字段",icon:"none",duration:3e3}):u({title:"注册失败："+(i.message||"系统错误"),icon:"none",duration:3e3})):i.message&&i.message.includes("already exists")?u({title:"用户名已存在，请更换用户名",icon:"none"}):u({title:i.message||"注册失败，请稍后再试",icon:"none"})}finally{o.value=!1,m()}}else u({title:"请输入有效的邮箱地址",icon:"none"});else u({title:"两次输入的密码不一致",icon:"none"})}))}function i(){try{g("/pages/login/login")}catch(e){a("error","at pages/login/register.vue:231","跳转到登录页面失败:",e),uni.navigateBack()}}return(t,a)=>(e.openBlock(),e.createElementBlock("view",{class:"register-container"},[e.createElementVNode("view",{class:"logo-container"},[e.createElementVNode("image",{class:"logo",src:c,mode:"aspectFit"}),e.createElementVNode("text",{class:"app-name"},"DogRun")]),e.createElementVNode("view",{class:"form-container"},[e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("text",{class:"label"},"用户名"),e.withDirectives(e.createElementVNode("input",{class:"input",type:"text","onUpdate:modelValue":a[0]||(a[0]=e=>s.value.username=e),placeholder:"请输入用户名"},null,512),[[e.vModelText,s.value.username]])]),e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("text",{class:"label"},"邮箱"),e.withDirectives(e.createElementVNode("input",{class:"input",type:"text","onUpdate:modelValue":a[1]||(a[1]=e=>s.value.email=e),placeholder:"请输入邮箱"},null,512),[[e.vModelText,s.value.email]])]),e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("text",{class:"label"},"密码"),e.withDirectives(e.createElementVNode("input",{class:"input",type:"password","onUpdate:modelValue":a[2]||(a[2]=e=>s.value.password=e),placeholder:"请输入密码（至少6个字符）"},null,512),[[e.vModelText,s.value.password]]),s.value.password&&s.value.password.length<6?(e.openBlock(),e.createElementBlock("text",{key:0,class:"input-tip"},"密码长度不能少于6个字符")):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("text",{class:"label"},"确认密码"),e.withDirectives(e.createElementVNode("input",{class:"input",type:"password","onUpdate:modelValue":a[3]||(a[3]=e=>s.value.confirmPassword=e),placeholder:"请再次输入密码"},null,512),[[e.vModelText,s.value.confirmPassword]]),s.value.password!==s.value.confirmPassword&&s.value.confirmPassword?(e.openBlock(),e.createElementBlock("text",{key:0,class:"input-tip"},"两次输入的密码不一致")):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("text",{class:"label"},"昵称"),e.withDirectives(e.createElementVNode("input",{class:"input",type:"text","onUpdate:modelValue":a[4]||(a[4]=e=>s.value.nickname=e),placeholder:"请输入昵称（选填）"},null,512),[[e.vModelText,s.value.nickname]])]),e.createElementVNode("button",{class:e.normalizeClass(["register-btn",{loading:o.value}]),disabled:!r.value||o.value,onClick:n},e.toDisplayString(o.value?"注册中...":"注 册"),11,["disabled"]),e.createElementVNode("view",{class:"footer"},[e.createElementVNode("text",{class:"login-link",onClick:i},"已有账号？去登录")])])]))}},te=K("location",{state:()=>({currentLocation:null,nearbyUsers:[],loading:!1,error:null,sharingEnabled:!0,locationUpdateInterval:null}),getters:{hasLocation:e=>!!e.currentLocation,getNearbyUsersList:e=>e.nearbyUsers},actions:{updateLocation(e){return __async(this,null,(function*(){try{return this.loading=!0,this.currentLocation=e,this.sharingEnabled&&(yield B.location.updateLocation({latitude:e.latitude,longitude:e.longitude,timestamp:(new Date).toISOString()})),e}catch(t){throw a("error","at store/location.js:37","更新位置失败:",t),this.error="更新位置失败",t}finally{this.loading=!1}}))},getNearbyUsers(){return __async(this,arguments,(function*(e={}){try{if(this.loading=!0,!this.currentLocation)return{success:!1,message:"没有位置信息"};const t=__spreadValues({latitude:this.currentLocation.latitude,longitude:this.currentLocation.longitude,maxDistance:e.maxDistance||5e3},e),s=__spreadProps(__spreadValues({},t),{latitude:e.latitude||t.latitude,longitude:e.longitude||t.longitude});a("log","at store/location.js:71","获取附近用户，使用参数:",s);const o=yield B.location.getNearbyUsers(s);return o&&o.success?(this.nearbyUsers=o.data||[],o):{success:!1,data:[],message:"获取附近用户失败"}}catch(t){return a("error","at store/location.js:82","获取附近用户失败:",t),this.error="获取附近用户失败",{success:!1,data:[],message:t.message}}finally{this.loading=!1}}))},toggleLocationSharing(e){return __async(this,null,(function*(){try{this.loading=!0,this.sharingEnabled=e;try{yield B.location.toggleLocationSharing({enabled:this.sharingEnabled})}catch(t){a("warn","at store/location.js:102","更新服务器位置共享状态失败，仅在本地更新:",t)}return this.sharingEnabled}catch(s){return a("error","at store/location.js:108","切换位置共享状态失败:",s),this.error="切换位置共享状态失败",null}finally{this.loading=!1}}))},getLocationSharingStatus(){return __async(this,null,(function*(){try{this.loading=!0;const e=yield B.location.getLocationSharingStatus();return this.sharingEnabled=e.data.enabled,this.sharingEnabled}catch(e){return a("error","at store/location.js:126","获取位置共享状态失败:",e),this.error="获取位置共享状态失败",null}finally{this.loading=!1}}))},startLocationUpdates(e=1e4){this.locationUpdateInterval&&clearInterval(this.locationUpdateInterval),this.getUserLocation(),this.locationUpdateInterval=setInterval((()=>{this.getUserLocation()}),e)},stopLocationUpdates(){this.locationUpdateInterval&&(clearInterval(this.locationUpdateInterval),this.locationUpdateInterval=null)},getUserLocation(){return new Promise(((e,t)=>{uni.getLocation({type:"gcj02",success:t=>{const a={latitude:t.latitude,longitude:t.longitude,accuracy:t.accuracy,altitude:t.altitude,timestamp:(new Date).toISOString()};this.updateLocation(a),e(a)},fail:e=>{a("error","at store/location.js:176","获取位置失败:",e),this.error="获取位置失败",t(e)}})}))},clearLocationData(){this.stopLocationUpdates(),this.currentLocation=null,this.nearbyUsers=[],this.error=null},getUserPets(e){return __async(this,null,(function*(){try{this.loading=!0;const t=yield uni.request({url:`${uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000"}/api/pets/user/${e}`,method:"GET",header:{Authorization:`Bearer ${uni.getStorageSync("token")}`}});return 200===t.statusCode&&t.data?t.data:(a("error","at store/location.js:209","获取用户宠物失败:",t),[])}catch(t){return a("error","at store/location.js:213","获取用户宠物出错:",t),[]}finally{this.loading=!1}}))},checkFollowStatus(e){return __async(this,null,(function*(){try{this.loading=!0;const t=yield uni.request({url:`${uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000"}/api/users/follow/check/${e}`,method:"GET",header:{Authorization:`Bearer ${uni.getStorageSync("token")}`}});return 200===t.statusCode&&t.data?t.data:(a("error","at store/location.js:237","检查关注状态失败:",t),{following:!1})}catch(t){return a("error","at store/location.js:241","检查关注状态出错:",t),{following:!1}}finally{this.loading=!1}}))}}}),ae=K("marker",{state:()=>({markers:[],userMarkers:[],loading:!1,error:null,currentMarker:null,selectedMarker:null,markerCache:{data:[],timestamp:null,location:null},pagination:{page:1,limit:20,total:0,pages:0}}),getters:{allMarkers:e=>e.markers,isLoading:e=>e.loading,getError:e=>e.error},actions:{fetchNearbyMarkers(e){return __async(this,arguments,(function*({longitude:e,latitude:t,radius:s=5e3}){var o,r;try{this.loading=!0,a("log","at stores/markerStore.js:37","正在获取附近标记...");if(this.checkCacheValidity({longitude:e,latitude:t})){a("log","at stores/markerStore.js:44","使用缓存的标记数据");const o=this.filterMarkersByDistance(this.markerCache.data,{latitude:t,longitude:e,radius:s});return this.markers=o,this.loading=!1,o}let o=2,r=null,i=0;for(;o>=0;)try{let o="/api/markers",r={};switch(i){case 0:r={longitude:e,latitude:t,radius:s},a("log","at stores/markerStore.js:75","尝试标准地理空间查询");break;case 1:r={longitude:e,latitude:t,radius:s,queryMode:"geoWithin"},a("log","at stores/markerStore.js:85","尝试使用geoWithin查询模式");break;case 2:const n=s/111e3,i=s/(111e3*Math.cos(t*Math.PI/180));r={minLat:t-n,maxLat:t+n,minLng:e-i,maxLng:e+i,useRectQuery:!0},a("log","at stores/markerStore.js:100","尝试使用矩形区域查询");break;case 3:o="/api/markers/all",a("log","at stores/markerStore.js:106","尝试获取所有标记");break;case 4:a("log","at stores/markerStore.js:111","尝试无参数请求获取标记");break;case 5:return o="/api/markers/search",yield this.fetchMarkersByPost({longitude:e,latitude:t,radius:s})}const n=yield _({url:o,method:"GET",params:r,timeout:1e4});a("log","at stores/markerStore.js:129","获取标记响应:",n);let l=[],c=this.pagination;return n.data?(l=n.data.data||n.data,c=n.data.pagination||this.pagination):l=n||[],i>=3&&l.length>0&&(a("log","at stores/markerStore.js:143","在前端筛选附近标记"),l=this.filterMarkersByDistance(l,{latitude:t,longitude:e,radius:s})),this.updateMarkerCache(l,{longitude:e,latitude:t}),this.markers=l,this.pagination=c,this.loading=!1,a("log","at stores/markerStore.js:158",`成功使用策略${i}获取到${l.length}个标记`),l}catch(n){r=n,a("warn","at stores/markerStore.js:162",`获取标记失败，使用策略${i}失败，剩余重试次数: ${o}`,n),i++,i>5&&(i=0,o--),o>=0&&(yield new Promise((e=>setTimeout(e,1e3))))}if(this.markerCache.data&&this.markerCache.data.length>0){a("log","at stores/markerStore.js:182","所有API策略失败，使用过期缓存数据");const o=this.filterMarkersByDistance(this.markerCache.data,{latitude:t,longitude:e,radius:2*s});if(o.length>0)return this.markers=o,this.loading=!1,uni.showToast({title:"使用缓存数据，可能不是最新",icon:"none",duration:2e3}),o}throw r}catch(n){return a("error","at stores/markerStore.js:208","获取附近标记失败:",n),this.error=(null==(r=null==(o=n.response)?void 0:o.data)?void 0:r.message)||"获取标记失败",this.loading=!1,this.markers=[],uni.showToast({title:"服务器暂时不可用，请稍后再试",icon:"none",duration:3e3}),[]}}))},fetchUserMarkers(e){return __async(this,null,(function*(){var t,s;try{this.loading=!0;const t=yield _({url:`/api/markers/user/${e}`,method:"GET"});let a=[];return a=t.data?t.data.data||t.data:t||[],this.userMarkers=a,this.loading=!1,a}catch(o){return a("error","at stores/markerStore.js:246","获取用户标记失败:",o),this.error=(null==(s=null==(t=o.response)?void 0:t.data)?void 0:s.message)||"获取用户标记失败",this.loading=!1,uni.showToast({title:"获取用户标记失败，请检查网络",icon:"none",duration:2e3}),[]}}))},createMarker(e){return __async(this,null,(function*(){var t,s;try{this.loading=!0,a("log","at stores/markerStore.js:263","正在创建新标记，数据:",e);let t=__spreadValues({},e);if(e.images&&e.images.length>0&&(a("log","at stores/markerStore.js:270","标记包含图片数据:",e.images.length,"张图片"),t.images=e.images.map((e=>({url:e.url,caption:e.caption||""})))),!t.latitude||!t.longitude)throw a("error","at stores/markerStore.js:279","标记缺少位置信息"),new Error("标记位置信息不完整");const s=yield _({url:"/api/markers",method:"POST",data:t});a("log","at stores/markerStore.js:290","新标记创建响应:",s);let o=s.data||s;if(o&&(o.data||o._id)){const e=o.data||o;e&&!e._id&&(e._id="marker_"+Date.now()),e&&!e.createdAt&&(e.createdAt=new Date),!e||e.latitude&&e.longitude||(e.latitude=t.latitude,e.longitude=t.longitude),this.markers&&Array.isArray(this.markers)?this.markers.unshift(e):this.markers=[e],this.userMarkers&&Array.isArray(this.userMarkers)&&this.userMarkers.unshift(e),this.updateMarkerCache(this.markers,{latitude:e.latitude,longitude:e.longitude}),this.notifyMarkersUpdated(),this.setCurrentMarker(e)}return this.loading=!1,o}catch(o){throw a("error","at stores/markerStore.js:341","创建标记失败:",o),this.error=(null==(s=null==(t=o.response)?void 0:t.data)?void 0:s.message)||o.message||"创建标记失败",this.loading=!1,o}}))},updateMarker(e){return __async(this,arguments,(function*({id:e,data:t}){var s,o,r,n;try{this.loading=!0;const a=yield _({url:`/api/markers/${e}`,method:"PUT",data:t});let s={};s=a.data?a.data.data||a.data:a||{};const o=this.markers.findIndex((e=>e._id===s._id));-1!==o&&(this.markers[o]=s);const r=this.userMarkers.findIndex((e=>e._id===s._id));return-1!==r&&(this.userMarkers[r]=s),this.selectedMarker&&this.selectedMarker._id===s._id&&(this.selectedMarker=s),this.currentMarker&&this.currentMarker._id===s._id&&(this.currentMarker=s),this.clearAllMarkerCache(),this.notifyMarkersUpdated(),this.loading=!1,uni.showToast({title:"标记更新成功",icon:"success"}),s}catch(i){return a("error","at stores/markerStore.js:398","更新标记失败:",i),this.error=(null==(o=null==(s=i.response)?void 0:s.data)?void 0:o.message)||"更新标记失败",this.loading=!1,uni.showToast({title:(null==(n=null==(r=i.response)?void 0:r.data)?void 0:n.message)||"更新标记失败，请检查网络",icon:"none"}),null}}))},deleteMarker(e){return __async(this,null,(function*(){var t,s,o,r;try{this.loading=!0,a("log","at stores/markerStore.js:415","正在删除标记:",e);let t=2,s=null;for(;t>=0;)try{return a("log","at stores/markerStore.js:429","删除标记响应:",yield _({url:`/api/markers/${e}`,method:"DELETE",timeout:15e3})),this.markers=this.markers.filter((t=>t._id!==e)),this.userMarkers=this.userMarkers.filter((t=>t._id!==e)),this.selectedMarker&&this.selectedMarker._id===e&&(this.selectedMarker=null),this.currentMarker&&this.currentMarker._id===e&&(this.currentMarker=null),this.clearAllMarkerCache(),this.loading=!1,this.notifyMarkersUpdated(),uni.showToast({title:"标记已删除",icon:"success"}),!0}catch(n){s=n,a("warn","at stores/markerStore.js:459",`删除标记失败，剩余重试次数: ${t}`,n),t--,t>=0&&(yield new Promise((e=>setTimeout(e,1e3))))}throw s}catch(n){return a("error","at stores/markerStore.js:472","删除标记失败:",n),this.error=(null==(s=null==(t=n.response)?void 0:t.data)?void 0:s.message)||"删除标记失败",this.loading=!1,uni.showToast({title:(null==(r=null==(o=n.response)?void 0:o.data)?void 0:r.message)||"删除标记失败，请检查网络",icon:"none"}),!1}}))},fetchMarkerById(e){return __async(this,null,(function*(){var t,s;try{this.loading=!0;const t=yield _({url:`/api/markers/${e}`,method:"GET"});let a={};return a=t.data?t.data.data||t.data:t||{},this.selectedMarker=a,this.loading=!1,a}catch(o){return a("error","at stores/markerStore.js:506","获取标记详情失败:",o),this.error=(null==(s=null==(t=o.response)?void 0:t.data)?void 0:s.message)||"获取标记详情失败",this.loading=!1,null}}))},likeMarker(e){return __async(this,null,(function*(){var t,s;try{const t=yield _({url:`/api/markers/${e}/like`,method:"POST"});let a=[];t.data?a=t.data.likes||t.likes||[]:t.likes&&(a=t.likes);const s=this.markers.findIndex((t=>t._id===e));if(-1!==s){const e=__spreadValues({},this.markers[s]);e.likes=a,this.markers[s]=e}const o=this.userMarkers.findIndex((t=>t._id===e));if(-1!==o){const e=__spreadValues({},this.userMarkers[o]);e.likes=a,this.userMarkers[o]=e}return this.selectedMarker&&this.selectedMarker._id===e&&(this.selectedMarker=__spreadProps(__spreadValues({},this.selectedMarker),{likes:a})),t}catch(o){return a("error","at stores/markerStore.js:548","点赞标记失败:",o),uni.showToast({title:(null==(s=null==(t=o.response)?void 0:t.data)?void 0:s.message)||"点赞失败",icon:"none"}),null}}))},unlikeMarker(e){return __async(this,null,(function*(){var t,s;try{const t=yield _({url:`/api/markers/${e}/unlike`,method:"POST"});let a=[];t.data?a=t.data.likes||t.likes||[]:t.likes&&(a=t.likes);const s=this.markers.findIndex((t=>t._id===e));if(-1!==s){const e=__spreadValues({},this.markers[s]);e.likes=a,this.markers[s]=e}const o=this.userMarkers.findIndex((t=>t._id===e));if(-1!==o){const e=__spreadValues({},this.userMarkers[o]);e.likes=a,this.userMarkers[o]=e}return this.selectedMarker&&this.selectedMarker._id===e&&(this.selectedMarker=__spreadProps(__spreadValues({},this.selectedMarker),{likes:a})),t}catch(o){return a("error","at stores/markerStore.js:592","取消点赞标记失败:",o),uni.showToast({title:(null==(s=null==(t=o.response)?void 0:t.data)?void 0:s.message)||"取消点赞失败",icon:"none"}),null}}))},setCurrentMarker(e){this.currentMarker=e},setSelectedMarker(e){this.selectedMarker=e},clearError(){this.error=null},filterMarkersByDistance(e,t){if(!e||!e.length)return[];if(!t||void 0===t.latitude)return e;const{latitude:a,longitude:s,radius:o}=t,r=e.filter((e=>{if(!e.latitude||!e.longitude){if(!e.location||!e.location.coordinates)return!1;e.longitude=e.location.coordinates[0],e.latitude=e.location.coordinates[1]}const t=this.calculateDistance(a,s,e.latitude,e.longitude);return e.distance=t,t<=o}));return r.sort(((e,t)=>e.distance-t.distance)),r},calculateDistance(e,t,a,s){const o=this.toRadians(a-e),r=this.toRadians(s-t),n=Math.sin(o/2)*Math.sin(o/2)+Math.cos(this.toRadians(e))*Math.cos(this.toRadians(a))*Math.sin(r/2)*Math.sin(r/2);return 6371e3*(2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)))},toRadians:e=>e*Math.PI/180,fetchMarkersByPost(e){return __async(this,null,(function*(){try{a("log","at stores/markerStore.js:673","使用POST请求获取标记");const t=yield _({url:"/api/markers/search",method:"POST",data:e,timeout:15e3});let s=[];return s=t.data?t.data.data||t.data:t||[],s.length>0&&this.updateMarkerCache(s,{longitude:e.longitude,latitude:e.latitude}),s}catch(t){throw a("error","at stores/markerStore.js:700","POST请求获取标记失败:",t),t}}))},checkCacheValidity({longitude:e,latitude:t}){if(!this.markerCache.data||0===this.markerCache.data.length)return!1;const a=Date.now()-(this.markerCache.timestamp||0)<18e5;let s=!1;if(this.markerCache.location){s=this.calculateDistance(t,e,this.markerCache.location.latitude,this.markerCache.location.longitude)<2e3}return a&&s},updateMarkerCache(e,t){if(e&&e.length){this.markerCache={data:[...e],timestamp:Date.now(),location:__spreadValues({},t)},a("log","at stores/markerStore.js:741","更新了标记缓存，共",e.length,"个标记");try{uni.setStorageSync("markerCache",JSON.stringify(this.markerCache))}catch(s){a("error","at stores/markerStore.js:747","保存标记缓存失败:",s)}}},restoreMarkerCache(){try{const e=uni.getStorageSync("markerCache");e&&(this.markerCache=JSON.parse(e),a("log","at stores/markerStore.js:757","已恢复标记缓存，时间:",new Date(this.markerCache.timestamp)))}catch(e){a("error","at stores/markerStore.js:760","恢复标记缓存失败:",e)}},clearAllMarkerCache(){a("log","at stores/markerStore.js:766","清除所有标记缓存"),this.markerCache={data:[],timestamp:null,location:null};try{uni.removeStorageSync("markerCache")}catch(e){a("error","at stores/markerStore.js:779","清除本地存储缓存失败:",e)}},notifyMarkersUpdated(){uni.$emit("markers-updated",{timestamp:Date.now()}),a("log","at stores/markerStore.js:789","已发出标记更新通知")}}}),se=e=>{const t=Math.floor(e/3600),a=Math.floor(e%3600/60),s=e%60;return t>0?`${t}小时${a}分`:a>0?`${a}分${s}秒`:`${s}秒`},oe=(e,t)=>{if(!e||0===e)return"--'--\"/km";const a=t/(e/1e3);return`${Math.floor(a/60)}'${Math.floor(a%60).toString().padStart(2,"0")}"/km`},re=(e,t,a,s)=>{const o=ne(a-e),r=ne(s-t),n=Math.sin(o/2)*Math.sin(o/2)+Math.cos(ne(e))*Math.cos(ne(a))*Math.sin(r/2)*Math.sin(r/2);return 6371e3*(2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)))},ne=e=>e*(Math.PI/180),ie=()=>new Promise(((e,t)=>{uni.getLocation({type:"gcj02",success:t=>{e({latitude:t.latitude,longitude:t.longitude})},fail:e=>{a("error","at utils/amap.js:91","获取位置失败",e),t(e)}})})),le={general:'<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#FF5733">\n    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>\n  </svg>',pet_friendly:'<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#34A853">\n    <path d="M4.5 12.65C5.35 12.45 6 11.7 6 10.8c0-1.1-0.9-2-2-2s-2 0.9-2 2c0 0.9 0.65 1.65 1.5 1.85v1.5c-2.5 0.5-4.5 3-4.5 6h2c0-2.5 2-4.5 4.5-4.5s4.5 2 4.5 4.5h2c0-3-2-5.5-4.5-6v-1.5zm17-1.85v1.5c-2.5 0.5-4.5 3-4.5 6h2c0-2.5 2-4.5 4.5-4.5s4.5 2 4.5 4.5h2c0-3-2-5.5-4.5-6v-1.5c0.85-0.2 1.5-0.95 1.5-1.85 0-1.1-0.9-2-2-2s-2 0.9-2 2c0 0.9 0.65 1.65 1.5 1.85zM12 4c-1.1 0-2 0.9-2 2s0.9 2 2 2 2-0.9 2-2-0.9-2-2-2zm0 16c1.1 0 2-0.9 2-2s-0.9-2-2-2-2 0.9-2 2 0.9 2 2 2z"/>\n  </svg>',danger:'<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#EA4335">\n    <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>\n  </svg>',scenic:'<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#4285F4">\n    <path d="M14 6l-3.75 5 2.85 3.8-1.6 1.2C9.38 13.33 2.39 13 2.39 13S2 13.37 2 14.07v5.93c0 1 2 2 2 2h16c1 0 2-1 2-2v-5.93c0-0.7-0.39-1.07-0.39-1.07s-7.01 0.33-9.16 3l-1.6-1.2 3.38-4.5L18 8 14 6z"/>\n  </svg>',pet_service:'<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#FF7F50">\n    <path d="M19 7h-4V3H9v4H5l7 7 7-7zm-8 12v-4h2v4h-2zm4 0v-4h2v4h-2zm-8 0v-4h2v4H7z"/>\n  </svg>',custom:'<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#9370DB">\n    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/>\n    <path d="M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4V7z"/>\n  </svg>'},ce={};Object.keys(le).forEach((e=>{ce[e]="data:image/svg+xml;base64,"+btoa(le[e])}));const ue="#FF5733",de="#34A853",me="#EA4335",pe="#4285F4",ge="#FF7F50",ve="#9370DB",he=(e,t)=>{const a=e.__vccOpts||e;for(const[s,o]of t)a[s]=o;return a};const fe=he({name:"UserInfoPopup",props:{user:{type:Object,default:()=>({})},pets:{type:Array,default:()=>[]},isFollowing:{type:Boolean,default:!1},visible:{type:Boolean,default:!1}},data:()=>({selectedPet:null,combinedPets:[],userIsFollowed:!1}),computed:{effectivePets(){var e;return a("log","at components/map/UserInfoPopup.vue:190","计算有效宠物列表:",{userPets:(null==(e=this.user)?void 0:e.pets)||[],propsPets:this.pets||[]}),this.user&&this.user.pets&&this.user.pets.length>0?this.user.pets:this.pets||[]},shouldShowNoPets(){const e=this.effectivePets.length>0;return a("log","at components/map/UserInfoPopup.vue:206","是否应该显示没有宠物提示:",!e),!e},isCurrentUser(){return this.user&&!0===this.user.isCurrentUser}},watch:{user:{handler(e){a("log","at components/map/UserInfoPopup.vue:218","用户数据变化:",e),this.updateSelectedPet(),e&&this.syncFollowStatus()},immediate:!0,deep:!0},pets:{handler(e){a("log","at components/map/UserInfoPopup.vue:233","传入的宠物列表变化:",e),this.updateSelectedPet()},immediate:!0},effectivePets:{handler(e){a("log","at components/map/UserInfoPopup.vue:241","有效宠物列表变化:",e),e&&e.length>0&&!this.selectedPet&&(this.selectedPet=e[0])}},visible(e){e&&(a("log","at components/map/UserInfoPopup.vue:250","弹窗显示，检查宠物选择状态和关注状态"),this.updateSelectedPet(),this.syncFollowStatus())},isFollowing:{handler(e){a("log","at components/map/UserInfoPopup.vue:259","props中的关注状态变化:",e),this.userIsFollowed=e},immediate:!0}},mounted(){a("log","at components/map/UserInfoPopup.vue:267","UserInfoPopup mounted:",{user:this.user,pets:this.pets,visible:this.visible,isFollowing:this.isFollowing}),this.syncFollowStatus()},methods:{syncFollowStatus(){return a("log","at components/map/UserInfoPopup.vue:279","同步关注状态"),void 0!==this.isFollowing?(a("log","at components/map/UserInfoPopup.vue:284","使用props中传入的关注状态:",this.isFollowing),void(this.userIsFollowed=this.isFollowing)):this.user&&void 0!==this.user.isFollowing?(a("log","at components/map/UserInfoPopup.vue:291","从用户对象中获取关注状态:",this.user.isFollowing),void(this.userIsFollowed=this.user.isFollowing)):(a("log","at components/map/UserInfoPopup.vue:297","没有找到关注状态信息，默认为未关注"),void(this.userIsFollowed=!1))},updateSelectedPet(){const e=this.effectivePets;a("log","at components/map/UserInfoPopup.vue:304","更新选中宠物, 宠物列表:",e),e&&e.length>0?(this.selectedPet=this.user&&this.user.currentPet||e[0],a("log","at components/map/UserInfoPopup.vue:309","设置选中宠物:",this.selectedPet)):(a("log","at components/map/UserInfoPopup.vue:311","没有找到宠物数据"),this.selectedPet=null)},handleClose(){this.$emit("close")},handleFollow(){this.userIsFollowed=!this.userIsFollowed,this.$emit("follow",this.user)},handleMessage(){this.$emit("message",this.user)},selectPet(e){this.selectedPet=e},isActivePet(e){return this.selectedPet&&e&&this.selectedPet.name===e.name},formatPetGender(e){if(!e)return"未知";return{male:"公",female:"母",unknown:"未知"}[e]||e},formatPetAge(e){if("number"==typeof e)return`${e}岁`;if("string"==typeof e&&(e.includes("岁")||/^\d+$/.test(e)))return/^\d+$/.test(e)?`${e}岁`:e;if(this.selectedPet&&void 0!==this.selectedPet.age){if("number"==typeof this.selectedPet.age)return`${this.selectedPet.age}岁`;if("string"==typeof this.selectedPet.age)return this.selectedPet.age.includes("岁")?this.selectedPet.age:`${this.selectedPet.age}岁`}if(!e)return"未知年龄";try{const t=new Date(e),a=new Date;if(isNaN(t.getTime()))return"未知年龄";const s=12*(a.getFullYear()-t.getFullYear())+(a.getMonth()-t.getMonth());if(s<12)return`${s}个月`;{const e=Math.floor(s/12),t=s%12;return t>0?`${e}岁${t}个月`:`${e}岁`}}catch(t){return a("error","at components/map/UserInfoPopup.vue:405","格式化宠物年龄出错:",t),"未知年龄"}},navigateToAddPet(){uni.switchTab({url:"/pages/index/index"}),this.handleClose()},handleImageError(e){a("warn","at components/map/UserInfoPopup.vue:420","图片加载失败:",e.target),e.target.src="/static/images/default-avatar.png"},formatImageUrl(e){if(!e)return"/static/images/default-avatar.png";if(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("/static/"))return e;if(e.startsWith("/uploads")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}if(e.startsWith("uploads/")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+"/"+e}return"/static/images/default-avatar.png"},formatSocialIntention:e=>({strong:"强烈",medium:"较强",mild:"平淡"}[e]||"未知"),formatMatingStatus:e=>({single:"单身待求偶",paired:"有配偶",notLooking:"暂不找配偶"}[e]||"未知"),previewPhoto(e){const t=this.formatImageUrl(e);uni.previewImage({urls:[t],current:t})}}},[["render",function(t,a,s,o,r,n){var i,l,c,u,d,m,p,g,v,h,f,y,w,k,E,N,S,V,_,P,I,x,b,C,T;return e.openBlock(),e.createElementBlock("view",{class:e.normalizeClass(["user-info-popup",{active:s.visible}])},[e.createElementVNode("view",{class:"popup-content"},[e.createElementVNode("view",{class:"close-btn",onClick:a[0]||(a[0]=(...e)=>n.handleClose&&n.handleClose(...e))},"×"),e.createElementVNode("view",{class:"user-info"},[e.createElementVNode("image",{class:"user-avatar",src:n.formatImageUrl(null==(i=s.user)?void 0:i.avatar),mode:"aspectFill",onError:a[1]||(a[1]=(...e)=>n.handleImageError&&n.handleImageError(...e))},null,40,["src"]),e.createElementVNode("view",{class:"user-details"},[e.createElementVNode("text",{class:"username"},e.toDisplayString((null==(l=s.user)?void 0:l.nickname)||(null==(c=s.user)?void 0:c.username)||"用户"),1),s.user&&s.user.isWalking?(e.openBlock(),e.createElementBlock("text",{key:0,class:"status"},"正在遛狗")):(e.openBlock(),e.createElementBlock("text",{key:1,class:"status"},"在线"))])]),s.user&&s.user.currentPet?(e.openBlock(),e.createElementBlock("view",{key:0,class:"pet-info"},[e.createElementVNode("text",{class:"section-title"},"当前宠物"),e.createElementVNode("view",{class:"pet-card"},[e.createElementVNode("image",{class:"pet-avatar",src:n.formatImageUrl(null==(u=s.user.currentPet)?void 0:u.avatar),mode:"aspectFill",onError:a[2]||(a[2]=(...e)=>n.handleImageError&&n.handleImageError(...e))},null,40,["src"]),e.createElementVNode("view",{class:"pet-details"},[e.createElementVNode("text",{class:"pet-name"},e.toDisplayString((null==(d=s.user.currentPet)?void 0:d.name)||"宠物"),1),e.createElementVNode("text",{class:"pet-breed"},e.toDisplayString((null==(m=s.user.currentPet)?void 0:m.breed)||"未知品种"),1),e.createElementVNode("text",{class:"pet-age"},e.toDisplayString(n.formatPetAge(null==(p=s.user.currentPet)?void 0:p.birthdate)),1)])])])):e.createCommentVNode("",!0),n.effectivePets.length>0?(e.openBlock(),e.createElementBlock("view",{key:1,class:"pet-list"},[e.createElementVNode("text",{class:"section-title"},e.toDisplayString(n.isCurrentUser?"我的宠物":"所有宠物"),1),e.createElementVNode("scroll-view",{class:"pet-scroll","scroll-x":""},[e.createElementVNode("view",{class:"pet-cards"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.effectivePets,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:a,class:e.normalizeClass(["pet-card-small",{active:n.isActivePet(t)}]),onClick:e=>n.selectPet(t)},[e.createElementVNode("image",{class:"pet-avatar-small",src:n.formatImageUrl(null==t?void 0:t.avatar),mode:"aspectFill"},null,8,["src"]),e.createElementVNode("text",{class:"pet-name-small"},e.toDisplayString((null==t?void 0:t.name)||"宠物"),1)],10,["onClick"])))),128))])]),r.selectedPet?(e.openBlock(),e.createElementBlock("view",{key:0,class:"pet-detail-card"},[e.createElementVNode("view",{class:"pet-detail-header"},[e.createElementVNode("image",{class:"pet-detail-avatar",src:n.formatImageUrl(null==(g=r.selectedPet)?void 0:g.avatar),mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"pet-detail-info"},[e.createElementVNode("text",{class:"pet-detail-name"},e.toDisplayString((null==(v=r.selectedPet)?void 0:v.name)||"宠物"),1),e.createElementVNode("text",{class:"pet-detail-breed"},e.toDisplayString((null==(h=r.selectedPet)?void 0:h.breed)||"未知品种"),1)])]),e.createElementVNode("view",{class:"pet-attributes"},[e.createElementVNode("view",{class:"pet-attribute"},[e.createElementVNode("text",{class:"attribute-label"},"年龄"),e.createElementVNode("text",{class:"attribute-value"},e.toDisplayString(n.formatPetAge(null==(f=r.selectedPet)?void 0:f.birthdate)||"未知"),1)]),(null==(y=r.selectedPet)?void 0:y.weight)?(e.openBlock(),e.createElementBlock("view",{key:0,class:"pet-attribute"},[e.createElementVNode("text",{class:"attribute-label"},"体重"),e.createElementVNode("text",{class:"attribute-value"},e.toDisplayString(null==(w=r.selectedPet)?void 0:w.weight)+"kg",1)])):e.createCommentVNode("",!0),(null==(k=r.selectedPet)?void 0:k.gender)?(e.openBlock(),e.createElementBlock("view",{key:1,class:"pet-attribute"},[e.createElementVNode("text",{class:"attribute-label"},"性别"),e.createElementVNode("text",{class:"attribute-value"},e.toDisplayString(n.formatPetGender(null==(E=r.selectedPet)?void 0:E.gender)),1)])):e.createCommentVNode("",!0),(null==(N=r.selectedPet)?void 0:N.socialIntention)?(e.openBlock(),e.createElementBlock("view",{key:2,class:"pet-attribute"},[e.createElementVNode("text",{class:"attribute-label"},"社交意向"),e.createElementVNode("text",{class:"attribute-value"},e.toDisplayString(n.formatSocialIntention(null==(S=r.selectedPet)?void 0:S.socialIntention)),1)])):e.createCommentVNode("",!0),(null==(V=r.selectedPet)?void 0:V.matingStatus)?(e.openBlock(),e.createElementBlock("view",{key:3,class:"pet-attribute"},[e.createElementVNode("text",{class:"attribute-label"},"求偶状态"),e.createElementVNode("text",{class:"attribute-value"},e.toDisplayString(n.formatMatingStatus(null==(_=r.selectedPet)?void 0:_.matingStatus)),1)])):e.createCommentVNode("",!0)]),(null==(P=r.selectedPet)?void 0:P.dailyPhotos)&&r.selectedPet.dailyPhotos.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"pet-daily-photos"},[e.createElementVNode("text",{class:"daily-photos-title"},"日常照片"),e.createElementVNode("scroll-view",{class:"photos-scroll","scroll-x":""},[e.createElementVNode("view",{class:"photos-container"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(r.selectedPet.dailyPhotos,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:a,class:"daily-photo-item",onClick:e=>n.previewPhoto(t.url)},[e.createElementVNode("image",{class:"daily-photo",src:n.formatImageUrl(t.url),mode:"aspectFill"},null,8,["src"])],8,["onClick"])))),128))])])])):e.createCommentVNode("",!0),(null==(I=r.selectedPet)?void 0:I.description)?(e.openBlock(),e.createElementBlock("view",{key:1,class:"pet-description"},[e.createElementVNode("text",{class:"description-title"},"个性介绍"),e.createElementVNode("text",{class:"description-text"},e.toDisplayString(null==(x=r.selectedPet)?void 0:x.description),1)])):e.createCommentVNode("",!0)])):e.createCommentVNode("",!0)])):n.shouldShowNoPets?(e.openBlock(),e.createElementBlock("view",{key:2,class:"no-pets-container"},[e.createElementVNode("image",{class:"no-pets-image",src:"/static/images/no-pets.png",mode:"aspectFit"}),e.createElementVNode("text",{class:"no-pets-text"},e.toDisplayString(n.isCurrentUser?"您还没有添加宠物信息":"该用户还没有添加宠物信息"),1),n.isCurrentUser?(e.openBlock(),e.createElementBlock("button",{key:0,class:"add-pet-btn",onClick:a[3]||(a[3]=(...e)=>n.navigateToAddPet&&n.navigateToAddPet(...e))}," 添加宠物信息 ")):e.createCommentVNode("",!0)])):e.createCommentVNode("",!0),s.user&&s.user.isWalking&&s.user.walkStats?(e.openBlock(),e.createElementBlock("view",{key:3,class:"walk-stats"},[e.createElementVNode("text",{class:"section-title"},"遛狗数据"),e.createElementVNode("view",{class:"stats-row"},[e.createElementVNode("view",{class:"stat-item"},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString((null==(b=s.user.walkStats)?void 0:b.distance)||0)+"km",1),e.createElementVNode("text",{class:"stat-label"},"距离")]),e.createElementVNode("view",{class:"stat-item"},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString((null==(C=s.user.walkStats)?void 0:C.duration)||"00:00"),1),e.createElementVNode("text",{class:"stat-label"},"时长")]),e.createElementVNode("view",{class:"stat-item"},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString((null==(T=s.user.walkStats)?void 0:T.speed)||0)+"km/h",1),e.createElementVNode("text",{class:"stat-label"},"配速")])])])):e.createCommentVNode("",!0),n.isCurrentUser?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("view",{key:4,class:"action-buttons"},[e.createElementVNode("button",{class:e.normalizeClass(["action-btn follow-btn",{"follow-active":r.userIsFollowed}]),onClick:a[4]||(a[4]=(...e)=>n.handleFollow&&n.handleFollow(...e))},e.toDisplayString(r.userIsFollowed?"已关注":"关注"),3),e.createElementVNode("button",{class:"action-btn message-btn",onClick:a[5]||(a[5]=(...e)=>n.handleMessage&&n.handleMessage(...e))}," 发信息 ")]))])],2)}],["__scopeId","data-v-5023fdb8"]]),ye={__name:"WalkSummaryPopup",props:{visible:{type:Boolean,default:!1},duration:{type:Number,default:0},distance:{type:Number,default:0},pets:{type:Array,default:()=>[]},selectedPetIndex:{type:Number,default:0},shareContent:{type:String,default:""}},emits:["close","share"],setup(t,{emit:a}){const s=t,o=a,r=e.ref(s.selectedPetIndex||0),n=e.ref(s.shareContent||""),i=e.computed((()=>se(s.duration))),l=e.computed((()=>(s.distance/1e3).toFixed(2))),c=e.computed((()=>oe(s.distance/1e3,s.duration))),u=e.computed((()=>s.pets.map((e=>e.name))));e.watch((()=>s.visible),(e=>{e||(r.value=0,n.value="")})),e.watch((()=>s.pets),(()=>{r.value=0}));const d=()=>{o("close")},m=e=>{r.value=Number(e.detail.value)},p=()=>{s.pets.length>0&&r.value<0?uni.showToast({title:"请选择一个宠物",icon:"none"}):o("share",{selectedPetIndex:r.value,content:n.value})},g=()=>{o("close"),uni.navigateTo({url:"/pages/walk/history"})};return(a,s)=>(e.openBlock(),e.createElementBlock("view",{class:e.normalizeClass(["walk-summary-popup",{active:t.visible}])},[e.createElementVNode("view",{class:"popup-content"},[e.createElementVNode("view",{class:"popup-header"},[e.createElementVNode("text",{class:"title"},"遛狗总结"),e.createElementVNode("text",{class:"close-btn",onClick:d},"×")]),e.createElementVNode("view",{class:"summary-stats"},[e.createElementVNode("view",{class:"stat-item"},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString(i.value),1),e.createElementVNode("text",{class:"stat-label"},"总时长")]),e.createElementVNode("view",{class:"stat-item"},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString(l.value)+" 公里",1),e.createElementVNode("text",{class:"stat-label"},"总距离")]),e.createElementVNode("view",{class:"stat-item"},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString(c.value),1),e.createElementVNode("text",{class:"stat-label"},"平均配速")])]),parseFloat(l.value)>1?(e.openBlock(),e.createElementBlock("view",{key:0,class:"summary-achievement"},[e.createElementVNode("text",{class:"achievement-icon"},"🏆"),e.createElementVNode("text",{class:"achievement-text"},"恭喜你今天遛狗超过1公里!")])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"share-options"},[e.createElementVNode("text",{class:"share-label"},"遛狗完成!"),e.createElementVNode("view",{class:"share-success"},[e.createElementVNode("text",{class:"success-emoji"},"🎉"),e.createElementVNode("text",{class:"success-text"},"恭喜完成遛狗，分享一下今天的心情吧!")]),t.pets.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"pet-select"},[e.createElementVNode("text",null,"选择宠物:"),e.createElementVNode("picker",{mode:"selector",range:u.value,value:r.value,onChange:m},[e.createElementVNode("view",{class:"picker-text"},e.toDisplayString(u.value[r.value]||"请选择"),1)],40,["range","value"])])):e.createCommentVNode("",!0),e.withDirectives(e.createElementVNode("textarea",{class:"share-content","onUpdate:modelValue":s[0]||(s[0]=e=>n.value=e),placeholder:"分享你的遛狗心得..."},null,512),[[e.vModelText,n.value]]),e.createElementVNode("view",{class:"button-group"},[e.createElementVNode("button",{class:"view-btn",onClick:g},"查看记录"),e.createElementVNode("button",{class:"share-btn",onClick:p},"保存并分享")])])])],2))}};var we={VITE_CJS_IGNORE_WARNING:"true",VITE_ROOT_DIR:"D:/caloriesH5/CloudStorage",VITE_USER_NODE_ENV:"production",BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1};const ke=he({components:{UserInfoPopup:fe,WalkSummaryPopup:he(ye,[["__scopeId","data-v-ff033337"]])},setup(){const s=X(),r=Y(),n=te(),i=ae(),l=e.ref(!0),c=e.ref(null),u={};const d={cache:{},get(e){const t=this.normalizeUrl(e);return this.cache[t]||null},put(e,t){const s=this.normalizeUrl(e);return this.cache[s]=t,a("log","at pages/map/map.vue:310","头像缓存更新，当前缓存数:",Object.keys(this.cache).length),t},remove(e){const t=this.normalizeUrl(e);return!!this.cache[t]&&(delete this.cache[t],!0)},clear(){return this.cache={},a("log","at pages/map/map.vue:327","头像缓存已清空"),!0},normalizeUrl(e){if(!e)return"";let t=e.split("?")[0];if(t.startsWith("/uploads/")){t=(we.VITE_API_URL||"http://49.235.65.37:5000")+t}return t}};function m(){const t={motionEvent:!1,deviceOrientation:!1,geolocation:!1,compass:!1,manualSet:!0};let o=null;function r(e,t){"compass"===t||"geolocation"===t||"deviceorientationevent"!==t&&"uniapp-motion"!==t||(e=(360-e)%360);const a={movement:5,geolocation:4,deviceorientationevent:3,"uniapp-motion":2,compass:1,manual:0};(!o||a[t]>a[o])&&(o=t),t===o&&(ne.value=e,function(e){var t;const a=(null==(t=s.userInfo)?void 0:t.id)||"current-user-location";u[a]&&u[a].setRotation&&u[a].setRotation(e)}(e))}return function(){try{"undefined"!=typeof DeviceOrientationEvent&&(t.motionEvent=!0,window.addEventListener("deviceorientation",(e=>{if(null!==e.alpha&&void 0!==e.alpha){r(e.alpha,"deviceorientationevent")}})),a("log","at pages/map/map.vue:375","已注册设备方向事件监听器"))}catch(s){a("warn","at pages/map/map.vue:378","设备方向事件不可用:",s)}try{"function"==typeof uni.onDeviceMotionChange&&(uni.startDeviceMotionListening({interval:"game",success:()=>{t.deviceOrientation=!0,a("log","at pages/map/map.vue:388","uni-app设备方向监听启动成功")},fail:e=>{a("warn","at pages/map/map.vue:391","uni-app设备方向监听启动失败",e)}}),uni.onDeviceMotionChange((e=>{if(void 0!==e.alpha){r(e.alpha,"uniapp-motion")}})))}catch(s){a("warn","at pages/map/map.vue:403","uni-app设备方向API不可用:",s)}try{navigator.geolocation&&navigator.geolocation.watchPosition&&(navigator.geolocation.watchPosition((e=>{if(null!==e.coords.heading&&void 0!==e.coords.heading){t.geolocation=!0;r(e.coords.heading,"geolocation")}}),(e=>{a("warn","at pages/map/map.vue:418","地理位置方向跟踪错误:",e)}),{enableHighAccuracy:!0,maximumAge:0}),a("log","at pages/map/map.vue:425","已启动地理位置方向跟踪"))}catch(s){a("warn","at pages/map/map.vue:428","地理位置方向API不可用:",s)}try{"function"==typeof uni.onCompassChange&&(uni.onCompassChange((e=>{if(void 0!==e.direction){t.compass=!0;r(e.direction,"compass")}})),a("log","at pages/map/map.vue:441","已启动指南针方向跟踪"))}catch(s){a("warn","at pages/map/map.vue:444","指南针API不可用:",s)}!function(){const t=[],a=5;e.watch(P,((e,s)=>{if(e&&s){const o=re(s.latitude,s.longitude,e.latitude,e.longitude);if(o>5){const n=function(e,t,a,s){e=e*Math.PI/180,t=t*Math.PI/180,a=a*Math.PI/180,s=s*Math.PI/180;const o=Math.sin(s-t)*Math.cos(a),r=Math.cos(e)*Math.sin(a)-Math.sin(e)*Math.cos(a)*Math.cos(s-t);let n=180*Math.atan2(o,r)/Math.PI;return n=(n+360)%360,n}(s.latitude,s.longitude,e.latitude,e.longitude);if(t.push({location:e,timestamp:Date.now(),bearing:n,distance:o}),t.length>a&&t.shift(),t.length>=2){let e=0,a=0;if(t.forEach(((s,o)=>{const r=(o+1)/t.length*Math.min(s.distance/10,1);e+=s.bearing*r,a+=r})),a>0){r(e/a,"movement")}}}}}),{deep:!0})}(),setTimeout((()=>{a("log","at pages/map/map.vue:452","方向传感器可用性:",t),t.motionEvent||t.deviceOrientation||t.geolocation||t.compass||(a("warn","at pages/map/map.vue:459","没有可用的方向传感器，用户头像将不会旋转"),Q.value&&uni.showToast({title:"设备不支持方向传感器",icon:"none",duration:2e3}))}),3e3)}(),{setManualHeading:e=>{r(e,"manual")},getOrientationInfo:()=>({currentHeading:ne.value,currentSource:o,supportInfo:__spreadValues({},t)})}}const p=e.ref(!0),g=e.ref(!1),v=e.ref(null),h=()=>{if(p.value=!p.value,c.value){const e=c.value.getAllOverlays("circle"),t=c.value.getAllOverlays("marker").filter((e=>{const t=e.getExtData();return!(t&&t.isUserMarker)}));p.value?(t.forEach((e=>{e.show()})),e.forEach((e=>{e.show()})),a("log","at pages/map/map.vue:666","显示所有标记和覆盖区域")):(t.forEach((e=>{e.hide()})),e.forEach((e=>{e.hide()})),a("log","at pages/map/map.vue:678","隐藏所有标记和覆盖区域，用户头像保持显示")),f()}},f=()=>{if(!c.value)return;c.value.getAllOverlays("marker").filter((e=>{const t=e.getExtData();return t&&t.isUserMarker})).forEach((e=>{e.setzIndex(1e3),e.show()}))},y=()=>__async(this,null,(function*(){try{if(a("log","at pages/map/map.vue:708","加载标记数据..."),!P.value)return void a("warn","at pages/map/map.vue:710","当前位置不可用，无法加载附近标记");a("log","at pages/map/map.vue:714","正在从服务器获取附近标记..."),a("log","at pages/map/map.vue:715","当前位置:",P.value);const t={show:()=>{uni.showLoading({title:"加载标记中...",mask:!1})},hide:()=>{uni.hideLoading()}};t.show();try{const e=yield i.fetchNearbyMarkers({longitude:P.value.longitude,latitude:P.value.latitude,radius:5e3});t.hide(),a("log","at pages/map/map.vue:744","获取到附近标记:",e.length);const s=e.map((e=>{const t=__spreadValues({},e);return t.latitude&&t.longitude||t.location&&t.location.coordinates&&(t.longitude=t.location.coordinates[0],t.latitude=t.location.coordinates[1]),void 0===t.radius||null===t.radius?(t.radius=.5,a("log","at pages/map/map.vue:763",`标记 ${t.title||"未命名"} 没有半径，设置默认值0.5公里`)):a("log","at pages/map/map.vue:765",`标记 ${t.title||"未命名"} 半径: ${t.radius}`),t.color||(t.color=t.color||"#007AFF"),t}));w(s),0===s.length&&uni.showToast({title:"附近没有标记",icon:"none",duration:2e3})}catch(e){if(t.hide(),a("error","at pages/map/map.vue:791","API获取标记失败:",e),uni.showToast({title:"加载标记失败，请重试",icon:"none",duration:2e3}),i.markerCache&&i.markerCache.data&&i.markerCache.data.length>0){a("log","at pages/map/map.vue:802","尝试使用缓存的标记数据");const e=i.filterMarkersByDistance(i.markerCache.data,{latitude:P.value.latitude,longitude:P.value.longitude,radius:5e3});if(e.length>0){const t=e.map((e=>(e.latitude&&e.longitude||e.location&&e.location.coordinates&&(e.longitude=e.location.coordinates[0],e.latitude=e.location.coordinates[1]),e.radius=e.radius||500,e.color=e.color||"#007AFF",e)));w(t),uni.showToast({title:"显示缓存的标记数据",icon:"none",duration:2e3})}else w([])}else w([])}}catch(t){a("error","at pages/map/map.vue:848","加载标记数据失败:",t),uni.hideLoading(),uni.showToast({title:"加载标记失败，请重试",icon:"none",duration:2e3})}})),w=e=>{try{if(a("log","at pages/map/map.vue:865","显示标记数据:",e),!e||!e.length)return void a("log","at pages/map/map.vue:867","没有标记可显示");if(c.value){const e=c.value.getAllOverlays("marker").filter((e=>{const t=e.getExtData();return!(t&&t.isUserMarker)}));e.length>0&&c.value.remove(e),c.value.remove(c.value.getAllOverlays("circle"))}e.forEach((e=>{var t,s,o,r;try{a("log","at pages/map/map.vue:894","添加标记:",e);const n=[e.longitude||(null==(s=null==(t=e.location)?void 0:t.coordinates)?void 0:s[0]),e.latitude||(null==(r=null==(o=e.location)?void 0:o.coordinates)?void 0:r[1])];if(!n[0]||!n[1])return void a("warn","at pages/map/map.vue:900","标记位置无效:",n);e.title||(e.title=e.title||"未命名标记"),e.type||(e.type=e.type||"general");const l=new AMap.Marker({position:n,title:e.title,icon:e.icon||k(e.type),anchor:"bottom-center",offset:new AMap.Pixel(0,0),extData:{marker:e,id:e._id,type:"marker"},clickable:!0});if(c.value.add(l),l.on("click",(t=>{a("log","at pages/map/map.vue:932","标记被点击:",e),i.setSelectedMarker(e),E(e)})),e.radius){let t;if("number"==typeof e.radius)e.radius<100?(t=1e3*e.radius,a("log","at pages/map/map.vue:950",`标记 "${e.title||"未命名"}" [${e._id}] - 转换半径从 ${e.radius}km 到 ${t}m`)):(t=e.radius,a("log","at pages/map/map.vue:954",`标记 "${e.title||"未命名"}" [${e._id}] - 使用原始半径 ${t}m`));else{const s=parseFloat(e.radius)||.5;t=s<100?1e3*s:s,a("log","at pages/map/map.vue:960",`标记 "${e.title||"未命名"}" [${e._id}] - 从字符串转换半径: ${e.radius} -> ${t}m`)}a("log","at pages/map/map.vue:964",`最终使用的覆盖半径: ${t}米 (原始值: ${e.radius})`);const s=new AMap.Circle({center:n,radius:t,strokeColor:e.color||"#1E90FF",strokeWeight:2,strokeOpacity:.8,fillColor:e.color||"#1E90FF",fillOpacity:.15,extData:{marker:e}});c.value.add(s),s.on("click",(t=>{a("log","at pages/map/map.vue:983","标记区域被点击:",e),i.setSelectedMarker(e);const s=t.target,o=s.getOptions().strokeColor,r=s.getOptions().fillColor,n=s.getOptions().fillOpacity;s.setOptions({strokeColor:"#FF3B30",fillColor:"#FF3B30",fillOpacity:.3}),setTimeout((()=>{s.setOptions({strokeColor:o,fillColor:r,fillOpacity:n})}),1e3),E(e)}))}}catch(n){a("error","at pages/map/map.vue:1015","添加单个标记时出错:",n)}})),a("log","at pages/map/map.vue:1019","标记显示完成"),f(),p.value||(h(),h())}catch(t){a("error","at pages/map/map.vue:1030","显示标记时出错:",t)}},k=e=>{if(ce&&ce[e])return ce[e];const t={general:"/static/images/marker.png",pet_friendly:"/static/images/pet-marker.png",danger:"/static/images/danger-marker.png",scenic:"/static/images/park-marker.png",pet_service:"/static/images/shop-marker.png",custom:"/static/images/marker.png"};return t[e]||t.general},E=e=>{var t,s,o,r;if(e)try{a("log","at pages/map/map.vue:1132","显示标记详情弹窗, 原始数据:",e);let l=e;if(e instanceof AMap.Marker){const t=e.getExtData();if(t&&t.marker)l=t.marker,a("log","at pages/map/map.vue:1142","从标记extData中获取到标记数据:",l);else if(t&&t.id){const e=i.markers.find((e=>e._id===t.id));e&&(l=e,a("log","at pages/map/map.vue:1148","从store中获取到标记数据:",l))}else a("warn","at pages/map/map.vue:1151","标记不包含有效的extData数据")}l.title||(l.title="未命名标记"),l.type||(l.type="general"),a("log","at pages/map/map.vue:1163","处理后的标记数据:",l),i.setSelectedMarker(l);const u=l.longitude||(null==(s=null==(t=l.location)?void 0:t.coordinates)?void 0:s[0]),d=l.latitude||(null==(r=null==(o=l.location)?void 0:o.coordinates)?void 0:r[1]);if(e instanceof AMap.Marker&&"function"==typeof e.setAnimation)try{e.setAnimation("AMAP_ANIMATION_BOUNCE"),setTimeout((()=>{e&&"function"==typeof e.setAnimation&&e.setAnimation(null)}),2e3)}catch(n){a("warn","at pages/map/map.vue:1184","设置标记动画效果失败:",n),"function"==typeof e.setzIndex&&e.setzIndex(999)}if(l.images&&l.images.length>0){a("log","at pages/map/map.vue:1195","标记包含图片，跳转到详情页面"),l.user&&"string"==typeof l.user&&(a("log","at pages/map/map.vue:1200","标记只包含用户ID，初始化基本用户对象"),l._processedUserInfo||(l._processedUserInfo=!0,l._originalUserId=l.user));const e=l._id;e?uni.navigateTo({url:`/pages/map/marker-detail?id=${e}`}):uni.showToast({title:"无法获取标记详情",icon:"none"})}else null!=v?(v.value=l,g.value=!0):(a("error","at pages/map/map.vue:1230","selectedMarker未定义"),uni.showModal({title:l.title||"未命名标记",content:l.description||"无描述信息",showCancel:!0,cancelText:"关闭",confirmText:"导航",success:e=>{e.confirm&&u&&d&&c.value&&(c.value.setCenter([u,d]),c.value.setZoom(17))}}))}catch(l){a("error","at pages/map/map.vue:1248","显示标记信息失败:",l),uni.showToast({title:"显示标记信息失败",icon:"none"})}},N=()=>{if(c.value)return c.value;if(a("error","at pages/map/map.vue:1293","地图未初始化，尝试获取地图实例"),"undefined"!=typeof window&&window.__dogRunMapInstance)return a("log","at pages/map/map.vue:1297","从全局变量获取地图实例"),c.value=window.__dogRunMapInstance,c.value;if("undefined"!=typeof window&&window.AMap){const t=document.getElementById("map-container");if(t&&t.__amap_instance__)return c.value=t.__amap_instance__,a("log","at pages/map/map.vue:1307","已从DOM元素获取地图实例"),c.value;if(a("log","at pages/map/map.vue:1312","尝试重新创建地图实例"),!t)throw new Error("无法获取地图容器");try{return c.value=new window.AMap.Map("map-container",{zoom:15,center:[P.value.longitude,P.value.latitude],resizeEnable:!0}),window.__dogRunMapInstance=c.value,t.__amap_instance__=c.value,a("log","at pages/map/map.vue:1322","地图实例已重新创建"),c.value}catch(e){throw a("error","at pages/map/map.vue:1325","无法创建地图实例:",e),new Error("无法创建地图实例: "+e.message)}}throw new Error("地图API未加载")};function S(e,t=!1){if(t&&a("log","at pages/map/map.vue:1339","getFullAvatarUrl处理:",e),!e)return t&&a("log","at pages/map/map.vue:1344","没有提供avatarPath，返回默认头像"),ie;if(e.startsWith("data:image/"))return t&&a("log","at pages/map/map.vue:1350","是base64图片，直接返回"),e;if(e.startsWith("http://")||e.startsWith("https://")){t&&a("log","at pages/map/map.vue:1356","已经是完整URL，直接返回:",e);return e.replace(/["']/g,"")}const s=uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000";if(e.startsWith("/uploads/")){const o=s+e;return t&&a("log","at pages/map/map.vue:1368","是上传路径，添加基础URL:",o),o}if(e.startsWith("uploads/")){const o=s+"/"+e;return t&&a("log","at pages/map/map.vue:1375","是不带前导斜杠的上传路径，添加基础URL:",o),o}t&&a("log","at pages/map/map.vue:1380","未识别的路径类型，尝试添加基础URL:",e);return s+"/"+(e.startsWith("/")?e.substring(1):e)}const V=e.ref(16),P=e.ref({latitude:39.9087,longitude:116.3975}),I=e.ref([]),x=e.ref(null),b=e.ref(null),C=e.ref([]),T=e.ref(!1),M=e.ref([]),D=e.ref(0),A=e.ref(0),U=e.ref(null),j=e.ref(null),F=e.ref([]),$=e.ref(!1),L=e.ref(null),R=e.ref([]),O=e.ref(!1),W=e.ref(!1),z=e.ref(!1),J=e.ref(""),q=e.ref([]),H=e.computed((()=>q.value.map((e=>e.name)))),G=e.ref(0),Q=e.ref(!1),K=e.ref({markerCount:0,markerIds:[],coords:[]}),Z=e.ref(!1),ee=e.ref(!0),ne=e.ref(0),ie="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAAAXNSR0IArs4c6QAAAQNJREFUeF7t1LENACAMBDFYm+WDxAhc6/TXWK/sdWaW+xbYAL/tXgiw+QGMfgABVoHY+4EAo0DMLRBgFIi5BQKMAjG3QIBRIOYWCDAKxNwCAUaBmFsgwCgQcwsEGAViboEAo0DMLRBgFIi5BQKMAjG3QIBRIOYWCDAKxNwCAUaBmFsgwCgQcwsEGAViboEAo0DMLRBgFIi5BQKMAjG3QIBRIOYWCDAKxNwCAUaBmFsgwCgQcwsEGAViboEAo0DMLRBgFIi5BQKMAjG3QIBRIOYWCDAKxPwCxDvF0aa/hxYAAAAASUVORK5CYII=",le=e.computed((()=>{const e=s.userInfo||s.user||{};return a("log","at pages/map/map.vue:1438","用户信息状态:",{"userStore.userAvatar存在":!!s.userAvatar,"userStore.userInfo存在":!!s.userInfo,"userStore.user存在":!!s.user,"头像路径":e.avatar||s.userAvatar}),s.userAvatar?S(s.userAvatar,!0):e.avatar?(a("log","at pages/map/map.vue:1453","头像计算细节:",{"原始路径":e.avatar,"是否以上传路径开头":e.avatar.startsWith("/uploads/"),"环境变量":uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000"}),S(e.avatar,!0)):(a("log","at pages/map/map.vue:1463","未找到用户头像，使用默认蓝色头像"),ie)})),ue=e.ref(null),de=e.computed((()=>{let e=[...I.value];if(ue.value)e=e.filter((e=>"user-location"!==e.id)),e.push(ue.value),a("log","at pages/map/map.vue:1480","添加用户位置标记:",ue.value);else if(P.value&&P.value.latitude){const t={id:"user-location",latitude:P.value.latitude,longitude:P.value.longitude,iconPath:le.value,width:40,height:40,rotate:ne.value,anchor:{x:.5,y:.5}};e.push(t),a("log","at pages/map/map.vue:1498","添加临时用户标记:",t)}else a("warn","at pages/map/map.vue:1500","用户位置标记未创建，且没有位置信息");return e}));function me(){if(ee.value)try{a("log","at pages/map/map.vue:1522","更新位置共享:",{latitude:P.value.latitude,longitude:P.value.longitude}),a("log","at pages/map/map.vue:1528","位置共享已在本地更新（不调用API）");try{n&&"function"==typeof n.updateLocation&&n.updateLocation({latitude:P.value.latitude,longitude:P.value.longitude,timestamp:(new Date).toISOString()}).catch((e=>{a("warn","at pages/map/map.vue:1539","更新位置API调用失败（已忽略）:",e)}))}catch(e){a("warn","at pages/map/map.vue:1544","位置API调用尝试失败（已忽略）:",e)}}catch(t){a("error","at pages/map/map.vue:1547","更新位置共享状态失败:",t)}}function pe(e=0){return __async(this,null,(function*(){try{if(!c.value)return a("log","at pages/map/map.vue:1575","地图未准备好，延迟获取附近用户"),e<5&&setTimeout((()=>pe(e+1)),1500),Promise.resolve({success:!1,message:"地图未准备好"});if(!l.value)return a("log","at pages/map/map.vue:1584","后端API不可用，不获取附近用户"),C.value=[],Promise.resolve({success:!1,message:"后端API不可用"});if(!ee.value)return a("log","at pages/map/map.vue:1591","位置共享未开启，不获取附近用户"),Promise.resolve({success:!1,message:"位置共享未开启"});if(!P.value||!P.value.latitude||!P.value.longitude)return a("error","at pages/map/map.vue:1597","当前位置不可用，稍后重试获取附近用户"),e<5&&setTimeout((()=>pe(e+1)),1500),Promise.resolve({success:!1,message:"当前位置不可用"});a("log","at pages/map/map.vue:1604","获取附近用户...");const t=yield n.getNearbyUsers({latitude:P.value.latitude,longitude:P.value.longitude,maxDistance:5e3}).catch((t=>(a("error","at pages/map/map.vue:1641","位置API错误:",t),e<3&&(a("log","at pages/map/map.vue:1644",`获取附近用户失败，${e+1}/3次重试`),setTimeout((()=>pe(e+1)),2e3)),{success:!1,message:"位置API错误"})));if(t&&t.success&&Array.isArray(t.data)){let e=[];if(s.userInfo&&s.userInfo.id?(e=t.data.filter((e=>e.id!==s.userInfo.id)),a("log","at pages/map/map.vue:1657","过滤后的其他用户数量:",e.length)):(e=t.data,a("log","at pages/map/map.vue:1660","未过滤的用户数量:",e.length)),s.userInfo&&P.value){const t=__spreadProps(__spreadValues({},s.userInfo),{latitude:P.value.latitude,longitude:P.value.longitude,lastUpdated:(new Date).toISOString()});e.length>0?(C.value=[t,...e],a("log","at pages/map/map.vue:1676","合并后的用户列表:",C.value.length,"个用户 (当前用户 + 其他用户)")):(C.value=[t],a("log","at pages/map/map.vue:1679","用户列表只包含当前用户"))}else C.value=e,a("log","at pages/map/map.vue:1683","用户列表不包含当前用户(未登录或无位置)");return ge(),a("log","at pages/map/map.vue:1687","获取到附近用户:",C.value.length),Promise.resolve(t)}if(a("log","at pages/map/map.vue:1694","未获取到附近用户或格式错误:",t),s.userInfo&&P.value){const e=__spreadProps(__spreadValues({},s.userInfo),{latitude:P.value.latitude,longitude:P.value.longitude,lastUpdated:(new Date).toISOString()});C.value=[e],a("log","at pages/map/map.vue:1706","API失败，只显示当前用户"),ge()}else C.value=[],a("log","at pages/map/map.vue:1710","API失败，且无当前用户信息，nearbyUsers为空");return!(e<3)||s.userInfo&&P.value||(a("log","at pages/map/map.vue:1715",`API失败，${e+1}/3次重试`),setTimeout((()=>pe(e+1)),2e3)),Promise.resolve({success:!1,message:"无附近用户",response:t})}catch(t){if(a("error","at pages/map/map.vue:1722","获取附近用户失败",t),s.userInfo&&P.value){const e=__spreadProps(__spreadValues({},s.userInfo),{latitude:P.value.latitude,longitude:P.value.longitude,lastUpdated:(new Date).toISOString()});C.value=[e],a("log","at pages/map/map.vue:1734","异常情况下，只显示当前用户"),ge()}else C.value=[],a("log","at pages/map/map.vue:1738","异常情况下，且无当前用户信息，nearbyUsers为空");return e<3&&(a("log","at pages/map/map.vue:1743",`异常情况，${e+1}/3次重试`),setTimeout((()=>pe(e+1)),2e3)),Promise.reject(t)}}))}function ge(){try{if(!C.value||!C.value.length)return a("log","at pages/map/map.vue:1755","没有附近用户，清除非自身标记"),void(c.value&&de.value&&(de.value.forEach((e=>{var t,o;const r=null==(t=null==e?void 0:e.extData)?void 0:t.userId,n=null==(o=s.userInfo)?void 0:o.id;a("log","at pages/map/map.vue:1764","标记ID:",r,"当前用户ID:",n),r&&n&&r!==n&&(a("log","at pages/map/map.vue:1768","移除非本人标记:",r),c.value.remove(e))})),de.value=de.value.filter((e=>{var t;return!e.extData||!e.extData.userId||e.extData.userId===(null==(t=s.userInfo)?void 0:t.id)}))));a("log","at pages/map/map.vue:1782","更新附近用户标记，用户数量:",C.value.length),de.value&&de.value.length>0&&de.value.forEach((e=>{e&&e.extData&&e.extData.userId!==s.userInfo.id&&e.setMap(null)})),C.value.forEach((e=>{if(!e||!e.id||s.userInfo&&e.id===s.userInfo.id)return;if(!e.latitude||!e.longitude)return void a("log","at pages/map/map.vue:1808","用户缺少位置信息:",e.nickname||e.username);const t=String(e.id),o=[e.longitude,e.latitude];a("log","at pages/map/map.vue:1816",`创建用户[${t}]的标记:`,e.nickname||e.username);let r=e.userAvatar||e.avatar;if(r=S(r,!0),a("log","at pages/map/map.vue:1822","处理用户标记:",t,e.nickname,"头像:",r?"有":"无"),r&&r.startsWith("data:image/"))return void ye(t,o,r);const n=new Image;n.crossOrigin="anonymous",n.onload=()=>{ye(t,o,r)},n.onerror=()=>{a("error","at pages/map/map.vue:1839","获取头像失败，用户ID:",t),fe(o,t)},n.src=r,setTimeout((()=>{n.complete&&0!==n.naturalWidth||(a("error","at pages/map/map.vue:1847","头像加载超时，用户ID:",t),fe(o,t))}),3e3)})),a("log","at pages/map/map.vue:1853","地图标记更新完成")}catch(e){a("error","at pages/map/map.vue:1855","更新地图标记时出错:",e)}}function ve(e,t){if(P.value&&0!==P.value.latitude){const t=e.latitude-P.value.latitude,s=e.longitude-P.value.longitude;if(Math.abs(t)>1e-5||Math.abs(s)>1e-5){const e=180*Math.atan2(s,t)/Math.PI;a("log","at pages/map/map.vue:1953","方位计算：",{dLat:t,dLng:s,calculatedHeading:e}),ne.value=e}}if(P.value=e,a("log","at pages/map/map.vue:1960","位置已更新:",P.value),void 0!==t&&(ne.value=t,a("log","at pages/map/map.vue:1965","使用罗盘朝向:",t)),(!window._lastMarkerUpdateTime||Date.now()-window._lastMarkerUpdateTime>3e4)&&(window._lastMarkerUpdateTime=Date.now(),a("log","at pages/map/map.vue:1972","触发定期标记更新"),s.isAuthenticated&&s.userInfo&&s.userInfo.id&&(a("log","at pages/map/map.vue:1976","使用实际用户ID更新标记:",s.userInfo.id),Ee())),T.value&&F.value.length>0){const t=F.value[F.value.length-1],a=re(t.latitude,t.longitude,e.latitude,e.longitude);a>5&&(F.value.push({latitude:e.latitude,longitude:e.longitude}),M.value=[{points:F.value.map((e=>({latitude:e.latitude,longitude:e.longitude}))),color:"#007AFF",width:4}],D.value+=a)}}function he(){uni.getLocation({type:"gcj02",success:e=>{if(a("log","at pages/map/map.vue:2018","获取当前位置成功:",e),ve({latitude:e.latitude,longitude:e.longitude}),c.value?(a("log","at pages/map/map.vue:2026","位置获取成功，立即将地图中心设置到当前位置"),c.value.setCenter([e.longitude,e.latitude]),c.value.setZoom(16)):a("log","at pages/map/map.vue:2030","地图尚未初始化，无法设置中心点"),s.hasDecidedLocationSharing||(Z.value=!0),window.AMap)try{const e=window.AMap;e.plugin(["AMap.Geolocation"],(function(){new e.Geolocation({enableHighAccuracy:!0,timeout:1e4,convert:!0,showButton:!1,showMarker:!1,showCircle:!1}).getCurrentPosition((function(e,t){"complete"===e?t.position&&(P.value={latitude:t.position.lat,longitude:t.position.lng},c.value&&c.value.setCenter([t.position.lng,t.position.lat])):a("log","at pages/map/map.vue:2069","高德地图定位失败",t)}))}))}catch(t){a("error","at pages/map/map.vue:2074","高德地图初始化失败:",t)}m()},fail:e=>{a("error","at pages/map/map.vue:2086","获取位置失败",e),uni.showToast({title:"获取位置信息失败，请检查定位权限",icon:"none"})}}),x.value=setInterval((()=>{const e=T.value?5:15,t=Date.now(),s=t-(Ie.value||0);s<1e3*e?a("log","at pages/map/map.vue:2109",`距上次位置更新仅${Math.floor(s/1e3)}秒，未达到${e}秒更新间隔`):(Ie.value=t,uni.getLocation({type:"gcj02",success:e=>{var t,s;const o=null==(t=P.value)?void 0:t.latitude,r=null==(s=P.value)?void 0:s.longitude;if(o&&r){const t=re(o,r,e.latitude,e.longitude);if(t<5&&!T.value)return void a("log","at pages/map/map.vue:2132",`位置变化太小(${t.toFixed(2)}米)，忽略更新`)}"function"==typeof uni.onCompassChange?uni.onCompassChange((t=>{ve({latitude:e.latitude,longitude:e.longitude},t.direction)})):ve({latitude:e.latitude,longitude:e.longitude}),ee.value&&me()}}))}),5e3),b.value=setInterval((()=>{pe()}),3e4)}function fe(e,t){if(a("log","at pages/map/map.vue:2169","创建默认标记，用户ID:",t),!e&&P.value&&(e=[P.value.longitude,P.value.latitude]),e||(a("warn","at pages/map/map.vue:2178","createDefaultMarker: 无法获取位置信息，使用默认位置"),e=[116.3,39.9]),!t&&s.userInfo&&a("log","at pages/map/map.vue:2185","从用户存储获取ID:",t=s.userInfo.id),t||a("warn","at pages/map/map.vue:2191","userId未提供且无法获取，使用固定标识符:",t="current-user-marker"),!c.value)return a("error","at pages/map/map.vue:2196","createDefaultMarker: 地图对象未初始化，无法创建标记"),null;const o=c,r=e,n=t;u[n]&&(a("log","at pages/map/map.vue:2207","移除已存在的同ID标记:",n),o.value.remove(u[n]),delete u[n]);try{a("log","at pages/map/map.vue:2213","使用ID创建默认标记:",n);const e=new AMap.Marker({map:o.value,position:r,icon:new AMap.Icon({size:new AMap.Size(30,30),image:"data:image/svg+xml;charset=utf-8,"+encodeURIComponent('\n\t\t\t\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30">\n\t\t\t\t\t\t\t\t<circle cx="15" cy="15" r="14" fill="#007aff" stroke="white" stroke-width="2"/>\n\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t'),imageSize:new AMap.Size(30,30)}),offset:new AMap.Pixel(-15,-15),zIndex:100,extData:{userId:n,type:"default-user"}});return u[n]=e,setTimeout((()=>{try{const t=e.getContentDom();t?(a("log","at pages/map/map.vue:2239","设置默认标记DOM属性，用户ID:",n),t.setAttribute("data-user-id",n),t.setAttribute("data-id",`user-marker-${n}`),t.id=`marker-${n}`,t.classList.add("user-marker"),t.classList.add(`user-marker-${n}`),t.setAttribute("data-marker-type","default-user"),t.setAttribute("data-timestamp",(new Date).getTime()),t.addEventListener("click",(e=>{e.stopPropagation(),a("log","at pages/map/map.vue:2252","默认标记DOM点击, 用户ID:",n),Ce({detail:{markerId:n}})})),t.style.cursor="pointer",t.style.pointerEvents="auto"):a("warn","at pages/map/map.vue:2260","无法获取默认标记DOM")}catch(t){a("error","at pages/map/map.vue:2263","设置默认标记DOM属性时出错:",t)}}),100),de.value&&de.value.push(e),e}catch(i){return a("error","at pages/map/map.vue:2274","创建默认标记时出错:",i),null}}const ye=(e,t,s)=>{if(!c.value)return a("error","at pages/map/map.vue:2283","地图未初始化，无法创建标记"),void setTimeout((()=>{c.value?(a("log","at pages/map/map.vue:2287","地图现在已初始化，重试创建标记"),ye(e,t,s)):a("error","at pages/map/map.vue:2290","重试后地图仍未初始化，标记创建失败")}),2e3);e||(a("warn","at pages/map/map.vue:2298","标记的userId为空，使用固定标识符"),e="current-user-location");try{a("log","at pages/map/map.vue:2303","开始创建用户标记，用户ID:",e);const o=s||le.value,r=d.get(o);if(r)return a("log","at pages/map/map.vue:2311","使用缓存的头像图像:",o.substring(0,50)+"..."),void createMarkerWithProcessedImage(e,t,r);if(o.startsWith("data:image"))return void processImageAndCreateMarker(e,t,o);const n=60,i=56,l=document.createElement("canvas");l.width=n,l.height=n;const m=l.getContext("2d",{willReadFrequently:!0});if(!m)return a("error","at pages/map/map.vue:2336","无法获取canvas上下文"),fe(t,e);m.clearRect(0,0,n,n);const p=new Image;p.crossOrigin="Anonymous",p.onload=function(){try{m.save(),m.beginPath(),m.arc(n/2,n/2,i/2,0,2*Math.PI),m.closePath(),m.clip();const s=(n-i)/2,r=(n-i)/2;m.drawImage(p,s,r,i,i),m.restore(),m.beginPath(),m.arc(n/2,n/2,i/2,0,2*Math.PI),m.lineWidth=2,m.strokeStyle="#2196F3",m.stroke();const g=l.toDataURL("image/png");d.put(o,g),"object"!=typeof u&&(a("warn","at pages/map/map.vue:2382","userMarkers未定义，初始化为空对象"),window.userMarkers={});const v=new AMap.Marker({position:t,icon:new AMap.Icon({size:new AMap.Size(n,n),image:g,imageSize:new AMap.Size(n,n)}),offset:new AMap.Pixel(-n/2,-n/2),zIndex:100,extData:{userId:e,type:"user",isUserMarker:!0}});return c.value.add(v),u[e]=v,setTimeout((()=>{try{const t=v.getContentDom();if(t){a("log","at pages/map/map.vue:2414",`为标记DOM设置用户ID: ${e}`),t.setAttribute("data-user-id",e),t.setAttribute("data-id",`user-marker-${e}`),t.id=`marker-${e}`,t.classList.add("user-marker"),t.classList.add(`user-marker-${e}`),t.setAttribute("data-marker-type","user"),t.setAttribute("data-timestamp",(new Date).getTime()),t.addEventListener("click",(t=>{t.stopPropagation(),a("log","at pages/map/map.vue:2430","用户标记DOM点击, 用户ID:",e),Te(e)})),t.style.cursor="pointer",t.style.pointerEvents="auto";const s=t.querySelector("img");s&&(s.setAttribute("data-user-id",e),s.setAttribute("data-id",`user-image-${e}`))}else a("warn","at pages/map/map.vue:2445","无法获取标记DOM元素")}catch(t){a("error","at pages/map/map.vue:2448","设置标记DOM属性时出错:",t)}}),100),v.on("click",(function(t){a("log","at pages/map/map.vue:2454","标记被点击，用户ID:",e),Te(e)})),setTimeout((()=>Me()),500),a("log","at pages/map/map.vue:2461","成功创建用户标记，用户ID:",e),v}catch(s){return a("error","at pages/map/map.vue:2464","绘制标记图像时出错:",s),fe(t,e)}},p.onerror=function(s){return a("error","at pages/map/map.vue:2471","加载头像图像失败:",s),fe(t,e)},p.src=s}catch(o){return a("error","at pages/map/map.vue:2478","创建用户标记出错:",o),fe(t,e)}},ke=()=>__async(this,null,(function*(){if(s.token&&!s.user)try{a("log","at pages/map/map.vue:2488","发现token但没有用户数据，尝试获取用户信息"),yield s.fetchUserInfo(),a("log","at pages/map/map.vue:2490","成功获取用户数据:",s.user)}catch(e){a("error","at pages/map/map.vue:2492","获取用户信息失败，可能需要重新登录:",e)}if(s.token&&(a("log","at pages/map/map.vue:2498","已有token，假定用户已登录 - isAuthenticated:",s.isAuthenticated),!s.isAuthenticated&&!s.user))try{const e=uni.getStorageSync("userInfo");if(e){const t=JSON.parse(e);s.$patch({user:t}),a("log","at pages/map/map.vue:2510","从本地存储恢复用户信息:",t)}else a("log","at pages/map/map.vue:2512","本地存储中没有用户信息")}catch(t){a("error","at pages/map/map.vue:2515","从本地存储恢复用户信息失败:",t)}a("log","at pages/map/map.vue:2521","当前认证状态:",{"token存在":!!s.token,"user存在":!!s.user,isAuthenticated:s.isAuthenticated})}));function Ee(){var e,t;try{if(!P.value||void 0===P.value.latitude)return a("error","at pages/map/map.vue:2533","当前位置信息不可用，无法添加标记"),void uni.showToast({title:"无法获取位置信息",icon:"none"});let o=(null==(e=s.userInfo)?void 0:e.id)||(null==(t=s.user)?void 0:t._id)||"current-user-location";if(a("log","at pages/map/map.vue:2543","使用用户ID创建标记:",o),c.value){const e=c.value.getAllOverlays("marker");let t=!1;e.forEach((e=>{var s,r;try{const n=null==(r=null==(s=null==e?void 0:e.getExtData)?void 0:s.call(e))?void 0:r.userId;n!==o&&"current-user-location"!==n||(a("log","at pages/map/map.vue:2556",`发现已存在标记(${n})，移除以避免重复`),c.value.remove(e),t=!0)}catch(n){a("warn","at pages/map/map.vue:2561","检查标记时出错:",n)}})),t&&a("log","at pages/map/map.vue:2566","已移除旧标记，创建新标记")}const r=[P.value.longitude,P.value.latitude],n=le.value;a("log","at pages/map/map.vue:2574","创建用户标记，使用头像URL:",n),ye(o,r,n),u["current-user-location"]&&"current-user-location"!==o&&delete u["current-user-location"],a("log","at pages/map/map.vue:2584","已完成创建用户标记")}catch(o){a("error","at pages/map/map.vue:2586","创建标记时出错:",o),uni.showToast({title:"创建位置标记失败",icon:"none"})}}function Ne(e=!1){var t;if(!P.value||void 0===P.value.latitude)return a("error","at pages/map/map.vue:2992","当前位置信息不可用，无法添加标记"),void uni.showToast({title:"无法获取位置信息",icon:"none"});e&&(a("log","at pages/map/map.vue:3002","强制清除头像缓存，使用最新上传的头像"),d.clear());const o=(null==(t=s.userInfo)?void 0:t.id)||"current-user-location",r=[P.value.longitude,P.value.latitude];if(c.value){const e=c.value.getAllOverlays("marker"),t=[];e.forEach((e=>{var o,r;try{const a=null==(r=null==(o=null==e?void 0:e.getExtData)?void 0:o.call(e))?void 0:r.userId;("current-user-location"===a||s.userInfo&&a===s.userInfo.id)&&t.push(e)}catch(n){a("error","at pages/map/map.vue:3024","处理标记时出错:",n)}})),t.length>0&&(a("log","at pages/map/map.vue:3030",`移除 ${t.length} 个用户标记`),c.value.remove(t),t.forEach((e=>{var t,a;const s=null==(a=null==(t=null==e?void 0:e.getExtData)?void 0:t.call(e))?void 0:a.userId;s&&u[s]&&delete u[s]}))),a("log","at pages/map/map.vue:3043","创建新的用户标记，用户ID:",o);const n=le.value;ye(o,r,n)}}e.onMounted((()=>__async(this,null,(function*(){var e;if(a("log","at pages/map/map.vue:2619","组件挂载开始..."),setTimeout((()=>{Ae()}),1e3),De=setInterval((()=>{Me(),(new Date).getSeconds()%10==0&&Ae()}),2e3),i.restoreMarkerCache(),yield ke(),a("log","at pages/map/map.vue:2643","初始用户信息:",s.userInfo||s.user),a("log","at pages/map/map.vue:2644","初始头像路径:",null==(e=s.userInfo||s.user)?void 0:e.avatar),a("log","at pages/map/map.vue:2645","用户认证状态:",s.isAuthenticated),!s.user&&!s.userInfo){a("log","at pages/map/map.vue:2649","用户信息不完整，尝试重新获取...");try{yield s.fetchUserInfo(),a("log","at pages/map/map.vue:2652","已重新获取用户信息:",s.user)}catch(n){a("error","at pages/map/map.vue:2654","获取用户信息失败:",n)}}const t=()=>__async(this,null,(function*(){try{a("log","at pages/map/map.vue:2661","检查后端API连接状态...");a("log","at pages/map/map.vue:2676","后端API连接正常:",yield _({url:"/api",method:"GET",timeout:5e3}).catch((e=>_({url:"/api/users/ping",method:"GET",timeout:5e3})))),l.value=!0}catch(e){a("error","at pages/map/map.vue:2679","后端API连接失败:",e),l.value=!1,uni.showModal({title:"连接问题",content:"无法连接到服务器，部分功能可能不可用。请检查网络连接或稍后重试。",showCancel:!1})}})),o=e=>{if(e&&void 0!==e.latitude)try{if(a("log","at pages/map/map.vue:2725","使用确定位置初始化地图:",e),void 0===window.AMap){a("error","at pages/map/map.vue:2728","AMap未加载"),window.onAMapLoaded=()=>o(e);const t=document.createElement("script");return t.type="text/javascript",t.async=!0,t.src="https://webapi.amap.com/maps?v=2.0&key=9ea84b4333b114c188a67cb42564a48f&callback=onAMapLoaded",void document.head.appendChild(t)}if(!document.getElementById("map-container"))return void a("error","at pages/map/map.vue:2743","找不到地图容器元素(#map-container)");c.value=new window.AMap.Map("map-container",{zoom:16,center:[e.longitude,e.latitude],resizeEnable:!0,animateEnable:!0}),"undefined"!=typeof window&&(window.__dogRunMapInstance=c.value),a("log","at pages/map/map.vue:2760","高德地图初始化完成"),c.value.on("complete",(()=>{a("log","at pages/map/map.vue:2764","地图加载完成，创建用户标记和加载标记数据"),c.value.setCenter([e.longitude,e.latitude]),setTimeout((()=>{Ee(),y(),pe()}),800)})),c.value.on("click",(e=>{a("log","at pages/map/map.vue:2781","高德地图点击事件:",e),xe({detail:{x:e.pixel.x,y:e.pixel.y}})})),setTimeout(Me,2e3)}catch(t){a("error","at pages/map/map.vue:2795","初始化地图出错:",t),uni.showToast({title:"地图初始化失败，请重试",icon:"none"})}else a("error","at pages/map/map.vue:2720","初始化地图需要有效的位置信息")};(()=>{__async(this,null,(function*(){uni.showLoading({title:"正在定位...",mask:!0});try{const s=uni.getStorageSync("last_known_location");let n=null;if(s)try{const e=JSON.parse(s);e&&e.timestamp&&Date.now()-e.timestamp<864e5&&(n={latitude:e.latitude,longitude:e.longitude},a("log","at pages/map/map.vue:2825","使用缓存位置作为临时位置",n),P.value=n)}catch(e){a("warn","at pages/map/map.vue:2831","解析缓存位置失败",e)}const i=yield((e=8e3)=>new Promise(((t,s)=>{const o=setTimeout((()=>{a("log","at pages/map/map.vue:2695","获取位置超时"),s(new Error("获取位置超时"))}),e);uni.getLocation({type:"gcj02",success:e=>{clearTimeout(o),t({latitude:e.latitude,longitude:e.longitude})},fail:e=>{clearTimeout(o),a("error","at pages/map/map.vue:2710","获取位置失败:",e),s(e)}})})))(1e4).catch((e=>(a("warn","at pages/map/map.vue:2837","获取实际位置失败，使用备选方案",e),null)));uni.hideLoading(),i?(P.value=i,a("log","at pages/map/map.vue:2847","获取到实际位置:",i),uni.setStorageSync("last_known_location",JSON.stringify(__spreadProps(__spreadValues({},i),{timestamp:Date.now()})))):P.value||(P.value={latitude:31.31,longitude:121.52},a("warn","at pages/map/map.vue:2857","无法获取位置，使用默认上海位置")),he(),o(P.value),function(){__async(this,null,(function*(){try{const e=yield r.fetchPets();e&&Array.isArray(e)?q.value=e:q.value=[]}catch(e){a("error","at pages/map/map.vue:1927","获取我的宠物失败",e),q.value=[]}}))}(),t()}catch(s){uni.hideLoading(),a("error","at pages/map/map.vue:2874","初始化地图流程出错:",s),uni.showToast({title:"定位失败，使用默认位置",icon:"none"}),P.value||(P.value={latitude:31.31,longitude:121.52}),he(),o(P.value)}}))})(),a("log","at pages/map/map.vue:2896","组件挂载完成")})))),o((()=>{a("log","at pages/map/map.vue:2901","地图页面显示"),c.value&&(a("log","at pages/map/map.vue:2904","刷新地图标记数据"),y())})),e.onBeforeUnmount((()=>{x.value&&clearInterval(x.value),b.value&&clearInterval(b.value),j.value&&clearInterval(j.value),"function"==typeof uni.stopDeviceMotionListening&&uni.stopDeviceMotionListening({success:()=>{a("log","at pages/map/map.vue:2977","设备方向监听已停止")}}),"function"==typeof uni.offCompassChange&&uni.offCompassChange()}));const Se=e.ref(!1),Ve=e.ref("未共享");function _e(){return __async(this,null,(function*(){try{a("log","at pages/map/map.vue:3332","开始保存遛狗记录...");const t=q.value.length>0?q.value[0]._id||q.value[0].id:null,s=q.value.length>0?q.value[0]:null;if(!t)return a("warn","at pages/map/map.vue:3339","没有宠物信息，无法保存遛狗记录"),uni.showToast({title:"请先添加宠物",icon:"none"}),Promise.reject(new Error("没有宠物信息"));const o={pet:{_id:t,name:(null==s?void 0:s.name)||"未命名宠物",avatar:(null==s?void 0:s.avatar)||"/static/images/default-pet.png"},distance:D.value,duration:A.value,startTime:new Date(U.value).toISOString(),endTime:(new Date).toISOString(),route:F.value,mapImageUrl:"/static/images/default-map.png"};a("log","at pages/map/map.vue:3362","发送遛狗记录数据:",{"宠物ID":o.pet._id,"宠物名称":o.pet.name,"距离":`${o.distance}米 (${(o.distance/1e3).toFixed(2)}公里)`,"时长":`${o.duration}秒 (${Math.floor(o.duration/60)}分${o.duration%60}秒)`,"开始时间":new Date(o.startTime).toLocaleString(),"结束时间":new Date(o.endTime).toLocaleString(),"路线点数":o.route.length}),a("log","at pages/map/map.vue:3373","调用API: api.walk.startWalk, URL: /api/walks/start");const r=yield B.walk.startWalk(o);a("log","at pages/map/map.vue:3375","遛狗记录保存结果:",r);let n=null;if(r&&0===r.code&&r.data?(n=r.data.walkId,a("log","at pages/map/map.vue:3383","从标准格式获取walkId:",n)):r&&(r._id||r.id)?(n=r._id||r.id,a("log","at pages/map/map.vue:3387","从对象属性获取walkId:",n)):r&&r.data&&(r.data._id||r.data.id||r.data.walkId)&&(n=r.data._id||r.data.id||r.data.walkId,a("log","at pages/map/map.vue:3391","从嵌套对象获取walkId:",n)),!n)return a("error","at pages/map/map.vue:3395","无法从API响应获取walkId:",r),Promise.reject(new Error("无法获取遛狗记录ID"));a("log","at pages/map/map.vue:3399","遛狗记录创建成功，ID:",n),yield new Promise((e=>setTimeout(e,500)));try{a("log","at pages/map/map.vue:3406",`调用API: api.walk.endWalk, URL: /api/walks/${n}/end`);a("log","at pages/map/map.vue:3413","遛狗记录结束结果:",yield B.walk.endWalk(n,{distance:D.value,duration:A.value,endTime:(new Date).toISOString()}))}catch(e){a("error","at pages/map/map.vue:3416","结束遛狗记录失败，但初始记录已保存:",e)}return uni.showToast({title:"记录已保存",icon:"success"}),setTimeout((()=>{a("log","at pages/map/map.vue:3427","准备跳转到遛狗记录页面..."),uni.navigateTo({url:"/pages/walk/history",success:()=>{a("log","at pages/map/map.vue:3431","成功跳转到遛狗记录页面")},fail:e=>{a("error","at pages/map/map.vue:3434","跳转到遛狗记录页面失败:",e)}})}),3e3),Promise.resolve(n)}catch(s){if(a("error","at pages/map/map.vue:3441","保存遛狗记录出错:",s),a("error","at pages/map/map.vue:3442","错误详情:",s.message||"未知错误"),s.statusCode&&(a("error","at pages/map/map.vue:3444","HTTP状态码:",s.statusCode),404===s.statusCode)){a("error","at pages/map/map.vue:3447","API端点不存在，使用本地存储");try{const e=t("walkStorage")||require("@/utils/walkStorage.js").default,s={pet:{_id:q.value.length>0?q.value[0]._id||q.value[0].id:"default-pet",name:q.value.length>0?q.value[0].name:"未命名宠物",avatar:q.value.length>0?q.value[0].avatar:"/static/images/default-pet.png"},distance:D.value,duration:A.value,startTime:new Date(U.value).toISOString(),endTime:(new Date).toISOString(),route:F.value};a("log","at pages/map/map.vue:3467","尝试使用本地存储保存遛狗记录");const o=e.saveWalkRecord(s);if(a("log","at pages/map/map.vue:3469","本地存储保存结果:",o),o&&0===o.code&&o.data&&o.data.walkId)return Promise.resolve(o.data.walkId);throw new Error("本地存储保存失败")}catch(o){a("error","at pages/map/map.vue:3477","使用本地存储保存失败:",o)}}throw uni.showToast({title:"保存记录失败: "+(s.message||"未知错误"),icon:"none",duration:3e3}),s}}))}const Pe=e.ref(!1),Ie=e.ref(0);function xe(e){if(a("log","at pages/map/map.vue:3666","地图点击事件:",e),Pe.value)return void a("log","at pages/map/map.vue:3670","地图正在拖动，忽略点击");const{x:t,y:s}=e.detail;if(void 0!==t&&void 0!==s){try{const e=document.querySelectorAll(".amap-marker");if(e.length>0){a("log","at pages/map/map.vue:3688","找到高德地图标记:",e.length,"个");for(const o of e){const e=o.getBoundingClientRect();if(t>=e.left&&t<=e.right&&s>=e.top&&s<=e.bottom){a("log","at pages/map/map.vue:3696","点击命中标记元素:",o);const e=o.getAttribute("data-id")||o.id||o.getAttribute("id");if(e)return a("log","at pages/map/map.vue:3705","触发标记点击:",e),void Ce({detail:{markerId:e}});const r=be(t,s);if(r)return a("log","at pages/map/map.vue:3713","找到最接近的用户:",r.nickname||r.username),void Ce({detail:{markerId:r.id}})}}}const o=be(t,s);if(o)return a("log","at pages/map/map.vue:3724","找到最接近的用户:",o.nickname||o.username),void Ce({detail:{markerId:o.id}})}catch(o){a("error","at pages/map/map.vue:3729","处理地图点击事件出错:",o)}$.value&&($.value=!1)}else a("log","at pages/map/map.vue:3679","点击事件没有坐标信息")}function be(e,t){if(!C.value||!C.value.length)return null;const s=document.getElementById("map");if(!s)return null;const o=s.getBoundingClientRect(),r=o.width,n=o.height,i=e-(o.left+r/2),l=t-(o.top+n/2),c=V.value,u=20/c*5e-6,d=20/c*5e-6/Math.cos(P.value.latitude*Math.PI/180),m=P.value.latitude-l*u,p=P.value.longitude+i*d;a("log","at pages/map/map.vue:3768","点击经纬度估计:",{lat:m,lng:p});let g=null,v=1/0;return C.value.forEach((e=>{if(!e.latitude||!e.longitude)return;const t=Math.sqrt(Math.pow((e.latitude-m)/u,2)+Math.pow((e.longitude-p)/d,2));t<30&&t<v&&(v=t,g=e)})),g}function Ce(e){return __async(this,null,(function*(){var t,s,o;try{let r=e.markerId||(null==(t=e.detail)?void 0:t.markerId);if(!r&&(null==(s=e.detail)?void 0:s.marker)&&(r=e.detail.marker.id),!r&&(null==(o=e.detail)?void 0:o.nativeEvent)){const t=e.detail.nativeEvent.target;t&&t.dataset&&(r=t.dataset.userId||t.dataset.id)}r?(a("log","at pages/map/map.vue:3935","获取到标记ID:",r),yield Te(r)):(a("error","at pages/map/map.vue:3938","无法获取标记ID"),Array.isArray(C.value)&&C.value.length>0?(a("log","at pages/map/map.vue:3941","使用第一个附近用户作为备选"),yield Te(C.value[0].id)):uni.showToast({title:"无法获取用户信息",icon:"none"}))}catch(r){a("error","at pages/map/map.vue:3952","标记点击处理出错:",r),uni.showToast({title:"操作失败，请重试",icon:"none"})}}))}function Te(e){return __async(this,null,(function*(){a("log","at pages/map/map.vue:3965","处理用户标记点击事件, 用户ID:",e);try{yield Be(e)}catch(t){a("error","at pages/map/map.vue:3971","处理用户标记点击失败:",t)}}))}function Me(){try{const e=document.querySelectorAll(".amap-marker");if(e.length>0){a("log","at pages/map/map.vue:3981","发现地图标记元素:",e.length,"个");let t=[];e.forEach((e=>{var a;const s=e.getAttribute("data-user-id")||(e.id?null==(a=e.id.match(/marker-([^"\s]+)/))?void 0:a[1]:null);s&&t.push(s)})),a("log","at pages/map/map.vue:3990","地图上的用户ID:",t),setTimeout((()=>{e.forEach((e=>{if(!e.hasAttribute("data-click-handler")){e.addEventListener("click",(t=>{t.stopPropagation(),a("log","at pages/map/map.vue:4001","标记点击事件 (直接):",e);let s=e.getAttribute("data-user-id");if(!s&&e.className){const t=e.className.match(/user-marker-([^"\s]+)/);t&&t[1]&&(s=t[1])}if(!s&&e.id){const t=e.id.match(/marker-([^"\s]+)/);t&&t[1]&&(s=t[1])}if(!s){const t=e.querySelector("img");t&&(s=t.getAttribute("data-user-id"))}a("log","at pages/map/map.vue:4030","尝试提取的用户ID:",s),s?(a("log","at pages/map/map.vue:4033","找到用户ID，触发标记点击事件:",s),Te(s)):C.value&&C.value.length>0&&(a("log","at pages/map/map.vue:4038","无法识别用户ID，使用第一个附近用户"),Te(C.value[0].id))})),e.setAttribute("data-click-handler","true"),e.style.cursor="pointer",e.style.pointerEvents="auto",e.style.zIndex="999";const t=e.querySelector(".amap-icon");if(t){t.style.borderRadius="50%",t.style.overflow="hidden";const s=t.querySelector("img");if(s){const t=e.getAttribute("data-user-id");t&&(s.setAttribute("data-user-id",t),a("log","at pages/map/map.vue:4065","设置图像元素data-user-id属性:",t)),s.style.borderRadius="50%",s.style.width="100%",s.style.height="100%",s.style.objectFit="cover",s.addEventListener("click",(t=>{t.stopPropagation(),a("log","at pages/map/map.vue:4077","图像点击事件");const o=s.getAttribute("data-user-id")||e.getAttribute("data-user-id");a("log","at pages/map/map.vue:4083","图像点击 - 提取的用户ID:",o),o&&(a("log","at pages/map/map.vue:4086","找到图像用户ID，处理标记点击:",o),Te(o))}))}}}}))}),100)}}catch(e){a("error","at pages/map/map.vue:4097","处理地图标记出错:",e)}}let De;function Ae(){var e,t;if(a("log","at pages/map/map.vue:4135","执行标记清理..."),!c.value)return;const o=c.value.getAllOverlays("marker");if(!o||0===o.length)return void a("log","at pages/map/map.vue:4141","地图上没有标记，无需清理");a("log","at pages/map/map.vue:4145",`地图上共有 ${o.length} 个标记`);const r=(null==(e=s.userInfo)?void 0:e.id)||(null==(t=s.user)?void 0:t._id);if(!r)return void a("log","at pages/map/map.vue:4150","未找到当前用户ID，跳过标记清理");a("log","at pages/map/map.vue:4154","当前用户ID:",r);const n=[r,"current-user-location"],i=[];o.forEach((e=>{var t,s;try{const a=(null==(s=null==(t=null==e?void 0:e.getExtData)?void 0:t.call(e))?void 0:s.userId)||"未知";i.push(a)}catch(o){a("error","at pages/map/map.vue:4166","获取标记ID出错:",o)}})),a("log","at pages/map/map.vue:4169","地图上的标记ID:",i);const l=[];o.forEach((e=>{var t,s;try{const o=null==(s=null==(t=null==e?void 0:e.getExtData)?void 0:t.call(e))?void 0:s.userId;if(!o)return a("log","at pages/map/map.vue:4177","找到无ID标记，移除"),void c.value.remove(e);n.includes(o)?(a("log","at pages/map/map.vue:4184",`保留标记ID: ${o}`),l.push(o)):(a("log","at pages/map/map.vue:4187",`移除标记ID: ${o}`),c.value.remove(e),u[o]&&delete u[o])}catch(o){a("error","at pages/map/map.vue:4196","清理标记时出错:",o)}})),a("log","at pages/map/map.vue:4200",`清理完成，保留标记: ${l.join(", ")}`)}e.watch((()=>s.isAuthenticated),(e=>{a("log","at pages/map/map.vue:4106","用户登录状态变更:",e),e?(a("log","at pages/map/map.vue:4109","用户已登录，获取宠物数据"),r.fetchPets().then((e=>{a("log","at pages/map/map.vue:4111","登录后获取宠物数据成功:",e),q.value=e})).catch((e=>{a("error","at pages/map/map.vue:4114","登录后获取宠物数据失败:",e)}))):(a("log","at pages/map/map.vue:4118","用户已登出，清空宠物数据"),q.value=[])})),e.onBeforeUnmount((()=>{De&&clearInterval(De)}));const Be=e=>__async(this,null,(function*(){a("log","at pages/map/map.vue:4438","选中用户标记:",e);try{let o,n=[];if(e===s.userId)o=__spreadProps(__spreadValues({},s.user),{isCurrentUser:!0}),n=r.pets||[];else{if(o=yield B.user.getUserById(e),!o)return void a("error","at pages/map/map.vue:4484","未找到用户信息");o=__spreadProps(__spreadValues({},o),{isCurrentUser:!1});try{n=yield B.pet.getPetsByUser(e)}catch(t){a("error","at pages/map/map.vue:4466","获取用户宠物失败:",t),n=[]}try{if(s.isAuthenticated){const t=yield s.fetchUserInfo();W.value=t.following&&t.following.some((t=>t===e||t._id&&t._id===e))}}catch(t){a("error","at pages/map/map.vue:4480","检查关注状态失败:",t),W.value=!1}}L.value=o,R.value=n,$.value=!0}catch(t){a("error","at pages/map/map.vue:4496","获取用户信息失败:",t)}}));return{userStore:s,petStore:r,mapScale:V,currentLocation:P,markers:I,allMarkers:de,nearbyUsers:C,isWalking:T,walkingPath:M,walkingDistance:D,walkingDuration:A,showUserPopup:$,selectedUser:L,selectedUserPets:R,selectedUserFollowStatus:O,isFollowing:W,showWalkSummary:z,walkShareContent:J,myPets:q,myPetsNames:H,selectedPetIndex:G,showDebug:Q,debugInfo:K,showLocationSharingTip:Z,isLocationShared:ee,userAvatar:le,userHeading:ne,defaultAvatarBase64:ie,userMarker:ue,locationSharingStatusVisible:Se,locationSharingStatus:Ve,formatDuration:se,calculatePace:oe,forceRefreshMarker:Ne,toggleMarker:Ee,toggleWalkingMode:function(){if(a("log","at pages/map/map.vue:3493","切换遛狗模式，当前状态:",T.value),T.value){T.value=!1,clearInterval(j.value),j.value=null,ee.value=!1,Se.value=!1,a("log","at pages/map/map.vue:3507","遛狗结束，时长:",A.value,"秒"),a("log","at pages/map/map.vue:3508","遛狗距离:",D.value,"米");const e=5;A.value>=e?(!function(){const e=(D.value/1e3).toFixed(2),t=se(A.value),a=oe(D.value,A.value),s=H.value.length?H.value.join("、"):"我的宠物";J.value=`我带${s}遛了${e}公里，用时${t}，配速${a}！`}(),_e().then((e=>{a("log","at pages/map/map.vue:3520","遛狗记录保存成功，ID:",e),z.value=!0,uni.showToast({title:"记录已保存",icon:"success",duration:2e3})})).catch((e=>{a("error","at pages/map/map.vue:3530","保存遛狗记录失败:",e),z.value=!0,uni.showToast({title:"记录保存失败，使用本地存储",icon:"none",duration:2e3})}))):(a("log","at pages/map/map.vue:3542","遛狗时间太短，不保存记录"),uni.showToast({title:`遛狗时间太短（少于${e}秒），未保存记录`,icon:"none",duration:2e3}))}else Z.value=!0},confirmLocationSharing:function(){try{ee.value=!0,Z.value=!1,a("log","at pages/map/map.vue:3583","已启用位置共享（本地）"),uni.showToast({title:"已开始位置共享",icon:"success"}),me(),function(){T.value=!0,U.value=Date.now(),D.value=0,A.value=0,F.value=[{latitude:P.value.latitude,longitude:P.value.longitude}],M.value=[{points:[{latitude:P.value.latitude,longitude:P.value.longitude}],color:"#007AFF",width:4}],j.value&&clearInterval(j.value);a("log","at pages/map/map.vue:3625","开始遛狗，设置计时器"),j.value=setInterval((()=>{const e=Date.now(),t=Math.floor((e-U.value)/1e3);A.value=t,t%30==0&&t>0&&a("log","at pages/map/map.vue:3633","遛狗进行中，已经",t,"秒")}),1e3),a("log","at pages/map/map.vue:3638","遛狗模式已开始:",{"开始时间":new Date(U.value).toLocaleTimeString(),"初始位置":F.value[0]})}()}catch(e){a("error","at pages/map/map.vue:3597","开始位置共享出错:",e)}},cancelLocationSharing:function(){try{ee.value=!1,Z.value=!1,a("log","at pages/map/map.vue:3563","已禁用位置共享（本地）"),uni.showToast({title:"已停止位置共享",icon:"none"})}catch(e){a("error","at pages/map/map.vue:3571","停止位置共享出错:",e)}},saveWalkRecord:_e,onMarkerTap:Ce,onMapTap:xe,onMapRegionChange:function(e){a("log","at pages/map/map.vue:3795","地图区域变更:",e),"begin"===e.type&&"drag"===e.causedBy?(a("log","at pages/map/map.vue:3652","地图开始拖动"),Pe.value=!0):"end"===e.type&&"drag"===e.causedBy&&(a("log","at pages/map/map.vue:3658","地图结束拖动"),setTimeout((()=>{Pe.value=!1}),50))},onMapUpdated:function(e){if(a("log","at pages/map/map.vue:3841","地图更新事件触发"),Q.value)try{K.value={markerCount:I.value.length+de.value.length,markerIds:I.value.map((e=>e.id)).concat(de.value.map((e=>e.id))),coords:P.value?[P.value.latitude.toFixed(6),P.value.longitude.toFixed(6)]:[]}}catch(o){a("error","at pages/map/map.vue:3848","更新调试信息错误:",o)}const t=n.sharingEnabled;if(ee.value=t,a("log","at pages/map/map.vue:3855","位置共享状态:",ee.value?"已开启":"已关闭"),!window._lastMarkerCheck||Date.now()-window._lastMarkerCheck>3e4){window._lastMarkerCheck=Date.now();try{const e=de.value.some((e=>"user-location"===e.id));if(P.value&&void 0!==P.value.latitude&&null!==P.value.latitude&&!e){a("log","at pages/map/map.vue:3871","添加用户标记...");const e=le.value,t=s.userInfo?s.userInfo.id:"user-location",o=[P.value.longitude,P.value.latitude];if(e.startsWith("data:image/"))ye(t,o,e);else{const s=new Image;s.crossOrigin="anonymous",s.onload=()=>{ye(t,o,e)},s.onerror=()=>{a("error","at pages/map/map.vue:3895","加载用户头像失败，使用默认头像"),ye(t,o,ie)},s.src=e,setTimeout((()=>{s.complete&&0!==s.naturalWidth||ye(t,o,ie)}),3e3)}}}catch(o){a("error","at pages/map/map.vue:3909","添加标记错误:",o)}}},hideUserPopup:function(){a("log","at pages/map/map.vue:4385","隐藏用户弹窗"),$.value=!1},showMarkerPopup:E,showCustomMarkerPopup:g,selectedMarker:v,getMarkerTypeName:e=>{if(!e)return"普通标记";return{general:"普通标记",pet_friendly:"宠物友好",danger:"危险区域",scenic:"风景区",pet_service:"宠物服务",custom:"自定义"}[e]||"未知类型"},getMarkerTypeIcon:e=>{if(!e)return"📍";return{general:"📍",pet_friendly:"🐾",danger:"⚠️",scenic:"🏞️",pet_service:"🏥",custom:"✨"}[e]||"📍"},getMarkerColor:e=>{if(!e)return"#4285F4";return{general:"#4285F4",pet_friendly:"#34A853",danger:"#EA4335",scenic:"#FBBC05",pet_service:"#FF7F50",custom:"#9370DB"}[e]||"#4285F4"},navigateToMarker:e=>{var t,s,o,r;if(e)try{const a=e.longitude||(null==(s=null==(t=e.location)?void 0:t.coordinates)?void 0:s[0]),n=e.latitude||(null==(r=null==(o=e.location)?void 0:o.coordinates)?void 0:r[1]);a&&n&&c.value&&(c.value.setCenter([a,n]),c.value.setZoom(17),g.value=!1,uni.showToast({title:"正在导航到标记位置",icon:"none",duration:1500}))}catch(n){a("error","at pages/map/map.vue:1123","导航到标记位置失败:",n)}},formatTime:e=>{if(!e)return"未知时间";const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`},getUserName:e=>e?"string"==typeof e?"用户"+e.substr(-4):e.nickname||e.username||"未知用户":"未知用户",centerOnUser(){a("log","at pages/map/map.vue:4574","定位到用户位置");try{if(c.value=N(),!P.value||void 0===P.value.latitude)return a("warn","at pages/map/map.vue:4581","当前位置信息不可用，尝试重新获取位置"),void uni.getLocation({type:"gcj02",success:e=>{a("log","at pages/map/map.vue:4587","重新获取位置成功:",e),P.value={latitude:e.latitude,longitude:e.longitude};const t=[e.longitude,e.latitude];a("log","at pages/map/map.vue:4596","设置地图中心到:",t),c.value.setCenter(t),c.value.setZoom(16),uni.showToast({title:"已定位到当前位置",icon:"none",duration:1e3})},fail:e=>{a("error","at pages/map/map.vue:4608","重新获取位置失败:",e),uni.showToast({title:"获取位置失败，请检查定位权限",icon:"none"})}});const e=[P.value.longitude,P.value.latitude];a("log","at pages/map/map.vue:4620","设置地图中心到:",e),c.value.setCenter(e),c.value.setZoom(16),uni.showToast({title:"已定位到当前位置",icon:"none",duration:1e3})}catch(e){a("error","at pages/map/map.vue:4631","设置地图中心点出错:",e),uni.showToast({title:"定位失败，请重试",icon:"none"})}},zoomIn(){a("log","at pages/map/map.vue:4639","放大地图");try{c.value=N();const e=c.value.getZoom();a("log","at pages/map/map.vue:4646","当前缩放级别:",e);const t=Math.min(e+1,19);a("log","at pages/map/map.vue:4650","新缩放级别:",t),c.value.setZoom(t),uni.showToast({title:"已放大地图",icon:"none",duration:500})}catch(e){a("error","at pages/map/map.vue:4662","地图放大出错:",e),uni.showToast({title:"操作失败，请重试",icon:"none"})}},zoomOut(){a("log","at pages/map/map.vue:4670","缩小地图");try{c.value=N();const e=c.value.getZoom();a("log","at pages/map/map.vue:4677","当前缩放级别:",e);const t=Math.max(e-1,3);a("log","at pages/map/map.vue:4681","新缩放级别:",t),c.value.setZoom(t),uni.showToast({title:"已缩小地图",icon:"none",duration:500})}catch(e){a("error","at pages/map/map.vue:4693","地图缩小出错:",e),uni.showToast({title:"操作失败，请重试",icon:"none"})}},closeUserPopup:function(){a("log","at pages/map/map.vue:4375","关闭用户弹窗"),$.value=!1,L.value=null,R.value=[]},messageUser(e){uni.navigateTo({url:`/pages/profile/message?userId=${e}`})},followUser(e){W.value=!W.value},closeWalkSummary(){a("log","at pages/map/map.vue:4713","关闭步行摘要"),z.value=!1},shareWalkRecord(e){a("log","at pages/map/map.vue:4717","分享遛狗记录到社区",e);const t=e&&e.selectedPetIndex>=0&&q.value.length>e.selectedPetIndex?q.value[e.selectedPetIndex]:null;let s=`我和${t?t.name:"我的宠物"}一起遛了${(D.value/1e3).toFixed(2)}公里，用时${se(A.value)}！`;e&&e.content&&(s+="\n\n"+e.content),z.value=!1,_e().then((e=>{a("log","at pages/map/map.vue:4742","已保存遛狗记录，准备分享到社区，记录ID:",e);const o={_id:e,distance:D.value,duration:A.value,startTime:walkStartTime.value,routeSnapshot:currentRouteSnapshot.value,pet:t?{_id:t._id,name:t.name,avatar:t.avatar}:null};setTimeout((()=>{uni.navigateTo({url:"/pages/community/create",success:e=>{uni.$emit("createPost",{content:s,walkRecord:o}),uni.showToast({title:"正在前往社区",icon:"none",duration:1500})},fail:e=>{a("error","at pages/map/map.vue:4780","导航到社区发帖页面失败:",e),uni.showToast({title:"打开社区页面失败",icon:"none"})}})}),300)})).catch((e=>{a("error","at pages/map/map.vue:4789","保存遛狗记录失败，无法分享到社区:",e),uni.showToast({title:"分享失败，请重试",icon:"none"})}))},reloadUserInfo:function(){return __async(this,null,(function*(){var e,t;try{a("log","at pages/map/map.vue:3177","开始重新加载用户信息..."),a("log","at pages/map/map.vue:3180","当前用户信息:",JSON.stringify(s.userInfo)),a("log","at pages/map/map.vue:3181","当前头像路径:",null==(e=s.userInfo)?void 0:e.avatar),a("log","at pages/map/map.vue:3182","当前计算的头像URL:",le.value),yield s.fetchUserInfo(),a("log","at pages/map/map.vue:3188","更新后的用户信息:",JSON.stringify(s.userInfo)),a("log","at pages/map/map.vue:3189","更新后的头像路径:",null==(t=s.userInfo)?void 0:t.avatar),a("log","at pages/map/map.vue:3190","更新后的计算头像URL:",le.value),a("log","at pages/map/map.vue:3193","环境变量VITE_API_URL:",we.VITE_API_URL),uni.showToast({title:"用户信息已更新",icon:"none"}),setTimeout((()=>{Ne(!0)}),500)}catch(o){a("error","at pages/map/map.vue:3206","重新加载用户信息失败:",o),uni.showToast({title:"更新用户信息失败",icon:"none"})}}))},clearAvatarCache:function(){return __async(this,null,(function*(){var e;try{if(a("log","at pages/map/map.vue:3217","开始清除头像缓存..."),d.clear(),uni.removeStorageSync("userInfo"),a("log","at pages/map/map.vue:3224","已清除本地用户信息缓存"),yield s.fetchUserInfo(),a("log","at pages/map/map.vue:3228","已重新获取用户信息"),null==(e=s.userInfo)?void 0:e.avatar){const e=S(s.userInfo.avatar,!0);if(a("log","at pages/map/map.vue:3234","清除头像URL缓存:",e),uni.removeSavedFile)try{const e=(yield new Promise(((e,t)=>{uni.getSavedFileList({success:t=>e(t.fileList||[]),fail:()=>e([])})}))).filter((e=>e.filePath&&e.filePath.includes("avatar")));if(e.length>0){a("log","at pages/map/map.vue:3252","找到",e.length,"个可能的头像缓存文件");for(const t of e)yield new Promise((e=>{uni.removeSavedFile({filePath:t.filePath,success:()=>a("log","at pages/map/map.vue:3257","已删除缓存文件:",t.filePath),complete:e})}))}}catch(t){a("warn","at pages/map/map.vue:3264","清除文件系统缓存时出错:",t)}try{const t=(new Date).getTime(),o=e.includes("?")?`${e}&t=${t}`:`${e}?t=${t}`;uni.downloadFile({url:o,success:e=>{var t;if(a("log","at pages/map/map.vue:3278","头像重新下载成功"),null==(t=s.userInfo)?void 0:t.id){const t=s.userInfo.id,a=P.value?[P.value.longitude,P.value.latitude]:null;a&&ye(t,a,e.tempFilePath)}},fail:e=>{a("error","at pages/map/map.vue:3292","头像重新下载失败:",e)},complete:()=>{uni.showToast({title:"头像缓存已清除",icon:"success"})}})}catch(o){a("error","at pages/map/map.vue:3303","下载头像时出错:",o),uni.showToast({title:"头像已清除，但重新获取失败",icon:"none"})}}else a("log","at pages/map/map.vue:3310","用户没有头像，无需清除缓存"),uni.showToast({title:"无头像，已清除用户信息",icon:"none"})}catch(r){a("error","at pages/map/map.vue:3317","清除头像缓存失败:",r),uni.showToast({title:"清除头像缓存出错",icon:"none"})}}))},onMapContainerClick:function(e){a("log","at pages/map/map.vue:3806","地图容器点击事件:",e);const{clientX:t,clientY:s}=e,o=document.querySelectorAll(".amap-marker");for(const r of o){const o=r.getBoundingClientRect();if(t>=o.left&&t<=o.right&&s>=o.top&&s<=o.bottom){a("log","at pages/map/map.vue:3819","点击了标记元素:",r);const t=r.getAttribute("data-user-id");if(t)return a("log","at pages/map/map.vue:3824","触发标记点击, 用户ID:",t),e.stopPropagation(),void Ce({detail:{markerId:t}})}}$.value&&($.value=!1)},selectUserMarker:Be,navigateToPetIdentify(){uni.navigateTo({url:"/pages/petIdentify/index"})},showAddMarkerForm:()=>{uni.navigateTo({url:`/pages/map/add-marker?latitude=${P.value.latitude}&longitude=${P.value.longitude}`})},loadMarkers:y,displayMarkers:w,showMarkerInfo:e=>{e&&(i.setCurrentMarker(e),uni.showModal({title:e.title,content:e.description||"暂无描述",showCancel:!0,cancelText:"关闭",confirmText:"导航",success:t=>{t.confirm&&(c.value.setCenter([e.longitude,e.latitude]),c.value.setZoom(16))}}))},toggleMarkersVisibility:h,navigateToAIMedical(){uni.navigateTo({url:"/pages/ai-medical/index"})},refreshMap:function(){a("log","at pages/map/map.vue:232","刷新地图 - 使用浏览器刷新"),uni.showLoading({title:"刷新地图中...",mask:!0});try{if("undefined"!=typeof window)setTimeout((()=>{a("log","at pages/map/map.vue:244","执行页面刷新"),window.location.reload()}),500);else{a("log","at pages/map/map.vue:250","非H5环境，使用uni-app方式刷新");uni.switchTab({url:"/pages/index/index",success:()=>{setTimeout((()=>{uni.switchTab({url:"/pages/map/index",complete:()=>{uni.hideLoading()}})}),300)},fail:()=>{uni.hideLoading(),uni.showToast({title:"刷新失败，请手动切换页面",icon:"none",duration:2e3})}})}}catch(e){a("error","at pages/map/map.vue:280","执行刷新操作时出错:",e),uni.hideLoading(),uni.showToast({title:"刷新失败，请手动切换页面",icon:"none",duration:2e3})}}}}},[["render",function(t,a,s,o,r,n){var i,l,c,u,d,m,p,g,v;const h=e.resolveComponent("UserInfoPopup"),f=e.resolveComponent("WalkSummaryPopup");return e.openBlock(),e.createElementBlock("view",{class:"content map-container"},[o.showDebug?(e.openBlock(),e.createElementBlock("view",{key:0,class:"debug-info"},[e.createElementVNode("text",null,"标记数: "+e.toDisplayString(o.debugInfo.markerCount),1),o.debugInfo.markerIds.length>0?(e.openBlock(),e.createElementBlock("text",{key:0},"ID: "+e.toDisplayString(o.debugInfo.markerIds.join(", ")),1)):e.createCommentVNode("",!0),o.debugInfo.coords.length>0?(e.openBlock(),e.createElementBlock("text",{key:1},"坐标: "+e.toDisplayString(o.debugInfo.coords.join(" | ")),1)):e.createCommentVNode("",!0),e.createElementVNode("text",null,"当前位置: "+e.toDisplayString(o.currentLocation.latitude)+", "+e.toDisplayString(o.currentLocation.longitude),1),e.createElementVNode("text",null,"头像路径: "+e.toDisplayString((null==(i=o.userStore.userInfo)?void 0:i.avatar)||"无"),1),e.createElementVNode("text",null,"完整头像URL: "+e.toDisplayString(o.userAvatar||"无"),1),e.createElementVNode("text",null,"使用的标记: 用户在资料中上传的头像"),e.createElementVNode("text",null,"总标记数: "+e.toDisplayString(o.allMarkers.length),1),e.createElementVNode("text",null,"用户标记: "+e.toDisplayString(o.userMarker?"已创建":"未创建"),1),e.createElementVNode("button",{onClick:a[0]||(a[0]=e=>o.forceRefreshMarker(!1))},"常规刷新"),e.createElementVNode("button",{onClick:a[1]||(a[1]=e=>o.forceRefreshMarker(!0))},"强制使用上传头像"),e.createElementVNode("button",{onClick:a[2]||(a[2]=(...e)=>o.reloadUserInfo&&o.reloadUserInfo(...e))},"重新加载用户信息"),e.createElementVNode("button",{onClick:a[3]||(a[3]=(...e)=>o.clearAvatarCache&&o.clearAvatarCache(...e))},"清除头像缓存"),e.createElementVNode("button",{onClick:a[4]||(a[4]=e=>o.showDebug=!1)},"关闭")])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"map-wrapper",onClick:a[5]||(a[5]=(...e)=>o.onMapContainerClick&&o.onMapContainerClick(...e))},[e.createElementVNode("div",{id:"map-container",class:"map-container"})]),o.showLocationSharingTip?(e.openBlock(),e.createElementBlock("view",{key:1,class:"location-share-tip"},[e.createElementVNode("view",{class:"tip-content"},[e.createElementVNode("text",{class:"tip-text"},"您是否想在地图上与其他宠友分享您的位置？"),e.createElementVNode("view",{class:"tip-buttons"},[e.createElementVNode("view",{class:"tip-btn cancel-btn",onClick:a[6]||(a[6]=(...e)=>o.cancelLocationSharing&&o.cancelLocationSharing(...e))},"暂不分享"),e.createElementVNode("view",{class:"tip-btn confirm-btn",onClick:a[7]||(a[7]=(...e)=>o.confirmLocationSharing&&o.confirmLocationSharing(...e))},"开始分享")])])])):e.createCommentVNode("",!0),o.locationSharingStatusVisible?(e.openBlock(),e.createElementBlock("view",{key:2,class:"location-sharing-status"},[e.createElementVNode("view",{class:e.normalizeClass(["status-icon",{active:o.isLocationShared}])},null,2),e.createElementVNode("text",{class:"status-text"},e.toDisplayString(o.locationSharingStatus),1)])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"toolbar"},[e.createElementVNode("view",{class:"toolbar-item",onClick:a[8]||(a[8]=(...e)=>o.centerOnUser&&o.centerOnUser(...e))},[e.createElementVNode("text",{class:"icon"},"📍"),e.createElementVNode("text",{class:"toolbar-text"},"定位")]),e.createElementVNode("view",{class:"toolbar-item",onClick:a[9]||(a[9]=(...e)=>o.zoomIn&&o.zoomIn(...e))},[e.createElementVNode("text",{class:"icon"},"➕"),e.createElementVNode("text",{class:"toolbar-text"},"放大")]),e.createElementVNode("view",{class:"toolbar-item",onClick:a[10]||(a[10]=(...e)=>o.zoomOut&&o.zoomOut(...e))},[e.createElementVNode("text",{class:"icon"},"➖"),e.createElementVNode("text",{class:"toolbar-text"},"缩小")]),e.createElementVNode("view",{class:"toolbar-item",onClick:a[11]||(a[11]=(...e)=>o.showAddMarkerForm&&o.showAddMarkerForm(...e))},[e.createElementVNode("text",{class:"icon"},"📍"),e.createElementVNode("text",{class:"toolbar-text"},"标记")]),e.createElementVNode("view",{class:"toolbar-item pet-identify",onClick:a[12]||(a[12]=(...e)=>o.navigateToPetIdentify&&o.navigateToPetIdentify(...e))},[e.createElementVNode("text",{class:"icon"},"🔍"),e.createElementVNode("text",{class:"toolbar-text"},"识别")]),e.createElementVNode("view",{class:"toolbar-item",onClick:a[13]||(a[13]=(...e)=>o.toggleMarkersVisibility&&o.toggleMarkersVisibility(...e))},[e.createElementVNode("text",{class:"icon"},"👁️"),e.createElementVNode("text",{class:"toolbar-text"},e.toDisplayString(t.showMarkers?"隐藏标记":"显示标记"),1)]),e.createElementVNode("view",{class:"toolbar-item ai-medical",onClick:a[14]||(a[14]=(...e)=>o.navigateToAIMedical&&o.navigateToAIMedical(...e))},[e.createElementVNode("text",{class:"icon"},"🏥"),e.createElementVNode("text",{class:"toolbar-text"},"AI医疗")])]),e.createElementVNode("view",{class:"start-button",onClick:a[15]||(a[15]=(...e)=>o.toggleWalkingMode&&o.toggleWalkingMode(...e))},[e.createElementVNode("view",{class:e.normalizeClass(["start-button-inner",{active:o.isWalking}])},[e.createElementVNode("text",{class:"start-icon"},e.toDisplayString(o.isWalking?"⏹️":"▶️"),1),e.createElementVNode("text",{class:"start-text"},e.toDisplayString(o.isWalking?"停止":"开始"),1)],2)]),e.createElementVNode("view",{class:"refresh-map-btn",onClick:a[16]||(a[16]=(...e)=>o.refreshMap&&o.refreshMap(...e))},[e.createElementVNode("view",{class:"refresh-btn-inner"},[e.createElementVNode("text",{class:"refresh-icon"},"🔄")])]),o.isWalking?(e.openBlock(),e.createElementBlock("view",{key:3,class:"walking-info"},[e.createElementVNode("view",{class:"info-item"},[e.createElementVNode("text",{class:"label"},"距离"),e.createElementVNode("text",{class:"value"},e.toDisplayString((o.walkingDistance/1e3).toFixed(2))+"km",1)]),e.createElementVNode("view",{class:"info-item"},[e.createElementVNode("text",{class:"label"},"时间"),e.createElementVNode("text",{class:"value"},e.toDisplayString(o.formatDuration(o.walkingDuration)),1)]),e.createElementVNode("view",{class:"info-item"},[e.createElementVNode("text",{class:"label"},"配速"),e.createElementVNode("text",{class:"value"},e.toDisplayString(o.calculatePace(o.walkingDistance,o.walkingDuration)),1)])])):e.createCommentVNode("",!0),o.showUserPopup?(e.openBlock(),e.createBlock(h,{key:4,user:o.selectedUser,pets:o.selectedUserPets,"is-following":o.isFollowing,visible:o.showUserPopup,onClose:o.closeUserPopup,onMessage:o.messageUser,onFollow:o.followUser},null,8,["user","pets","is-following","visible","onClose","onMessage","onFollow"])):e.createCommentVNode("",!0),o.showWalkSummary?(e.openBlock(),e.createBlock(f,{key:5,duration:o.walkingDuration,distance:o.walkingDistance,pets:o.myPets,"selected-pet-index":o.selectedPetIndex,"share-content":o.walkShareContent,onClose:o.closeWalkSummary,onShare:o.shareWalkRecord},null,8,["duration","distance","pets","selected-pet-index","share-content","onClose","onShare"])):e.createCommentVNode("",!0),e.createElementVNode("canvas",{"canvas-id":"debug-canvas",style:{width:"40px",height:"40px",position:"absolute",left:"-100px"}}),o.showCustomMarkerPopup?(e.openBlock(),e.createElementBlock("view",{key:6,class:"custom-marker-popup"},[e.createElementVNode("view",{class:"popup-backdrop",onClick:a[17]||(a[17]=e=>o.showCustomMarkerPopup=!1)}),e.createElementVNode("view",{class:"popup-content"},[e.createElementVNode("view",{class:"popup-header"},[e.createElementVNode("text",{class:"popup-title"},e.toDisplayString((null==(l=o.selectedMarker)?void 0:l.title)||"未命名标记"),1),e.createElementVNode("view",{class:"close-btn",onClick:a[18]||(a[18]=e=>o.showCustomMarkerPopup=!1)},"×")]),e.createElementVNode("view",{class:"popup-body"},[e.createElementVNode("view",{class:"marker-type"},[e.createElementVNode("view",{class:"marker-type-icon",style:e.normalizeStyle({backgroundColor:o.getMarkerColor(null==(c=o.selectedMarker)?void 0:c.type)})},[e.createElementVNode("text",{class:"type-icon"},e.toDisplayString(o.getMarkerTypeIcon(null==(u=o.selectedMarker)?void 0:u.type)),1)],4),e.createElementVNode("text",{class:"marker-type-name"},e.toDisplayString(o.getMarkerTypeName(null==(d=o.selectedMarker)?void 0:d.type)),1)]),e.createElementVNode("view",{class:"marker-description"},[e.createElementVNode("text",{class:"description-text"},e.toDisplayString((null==(m=o.selectedMarker)?void 0:m.description)||"暂无描述内容"),1)]),e.createElementVNode("view",{class:"marker-info"},[(null==(p=o.selectedMarker)?void 0:p.radius)?(e.openBlock(),e.createElementBlock("view",{key:0,class:"info-item"},[e.createElementVNode("text",{class:"info-icon"},"⭕"),e.createElementVNode("text",{class:"info-text"},"覆盖半径: "+e.toDisplayString(o.selectedMarker.radius<100?o.selectedMarker.radius+"公里 ("+(1e3*o.selectedMarker.radius).toFixed(0)+"米)":o.selectedMarker.radius+"米"),1)])):e.createCommentVNode("",!0),(null==(g=o.selectedMarker)?void 0:g.createdAt)?(e.openBlock(),e.createElementBlock("view",{key:1,class:"info-item"},[e.createElementVNode("text",{class:"info-icon"},"🕒"),e.createElementVNode("text",{class:"info-text"},"创建时间: "+e.toDisplayString(o.formatTime(o.selectedMarker.createdAt)),1)])):e.createCommentVNode("",!0),(null==(v=o.selectedMarker)?void 0:v.user)&&"string"!=typeof o.selectedMarker.user?(e.openBlock(),e.createElementBlock("view",{key:2,class:"info-item"},[e.createElementVNode("text",{class:"info-icon"},"👤"),e.createElementVNode("text",{class:"info-text"},"创建者: "+e.toDisplayString(o.getUserName(o.selectedMarker.user)),1)])):e.createCommentVNode("",!0)])]),e.createElementVNode("view",{class:"popup-footer"},[e.createElementVNode("view",{class:"popup-btn cancel-btn",onClick:a[19]||(a[19]=e=>o.showCustomMarkerPopup=!1)},"关闭"),e.createElementVNode("view",{class:"popup-btn confirm-btn",onClick:a[20]||(a[20]=e=>o.navigateToMarker(o.selectedMarker))},"导航")])])])):e.createCommentVNode("",!0)])}]]);const Ee=he({name:"WalkRecordCard",props:{record:{type:Object,required:!0}},methods:{formatDuration(e){if(!e)return"0秒";const t=Math.floor(e/3600),a=Math.floor(e%3600/60);return t>0?`${t}小时${a>0?a+"分钟":""}`:a>0?`${a}分钟`:`${e%60}秒`},formatDurationShort(e){if(!e)return"0秒";const t=Math.floor(e/3600),a=Math.floor(e%3600/60);return t>0?`${t}时${a}分`:a>0?`${a}分钟`:`${e}秒`},formatDate(e){if(!e)return"";try{const t=new Date(e),a=t.getMonth()+1;return`${a}月${t.getDate()}日`}catch(t){return a("error","at components/WalkRecordCard.vue:94","日期格式化错误:",t),""}},formatPetAvatar(e){if(!e)return"/static/images/default-pet.png";if(e.startsWith("http")||e.startsWith("/static"))return e;if(e.startsWith("/uploads")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}return"/static/images/default-pet.png"},getRouteImage(){return this.record.routeImage?this.record.routeImage:"/static/images/default-map.png"},viewDetail(){if(!this.record||!this.record._id)return void uni.showToast({title:"遛狗记录不存在",icon:"none"});this.record._id.startsWith("generated_")?uni.showToast({title:"这是从动态内容解析的遛狗记录，无法查看详情",icon:"none",duration:2500}):uni.navigateTo({url:`/pages/walk/detail?id=${this.record._id}`,fail:e=>{a("error","at components/WalkRecordCard.vue:151","打开遛狗记录详情失败:",e),uni.showToast({title:"无法查看遛狗记录",icon:"none"})}})}}},[["render",function(t,a,s,o,r,n){return e.openBlock(),e.createElementBlock("view",{class:"walk-record-container",onClick:a[0]||(a[0]=(...e)=>n.viewDetail&&n.viewDetail(...e))},[e.createElementVNode("view",{class:"walk-record-title"},[e.createElementVNode("text",{class:"paw-icon"},"🐾"),e.createElementVNode("text",null,"遛狗记录"),e.createElementVNode("text",{class:"arrow-icon"},"👉")]),e.createElementVNode("view",{class:"walk-record-content"},[e.createElementVNode("view",{class:"walk-stats"},[e.createElementVNode("view",{class:"stat-item"},[e.createElementVNode("view",{class:"stat-value"},e.toDisplayString((s.record.distance/1e3).toFixed(2)),1),e.createElementVNode("view",{class:"stat-label"},"公里")]),e.createElementVNode("view",{class:"stat-divider"}),e.createElementVNode("view",{class:"stat-item"},[e.createElementVNode("view",{class:"stat-value"},e.toDisplayString(n.formatDurationShort(s.record.duration)),1),e.createElementVNode("view",{class:"stat-label"},"时长")])]),s.record.pet?(e.openBlock(),e.createElementBlock("view",{key:0,class:"walk-pet-info"},[e.createElementVNode("image",{class:"pet-avatar",src:n.formatPetAvatar(s.record.pet.avatar),mode:"aspectFill"},null,8,["src"]),e.createElementVNode("text",{class:"pet-name"},e.toDisplayString(s.record.pet?s.record.pet.name:"未命名宠物"),1),e.createElementVNode("text",{class:"walk-date"},e.toDisplayString(n.formatDate(s.record.startTime)),1)])):e.createCommentVNode("",!0),s.record.route&&s.record.route.length>0?(e.openBlock(),e.createElementBlock("view",{key:1,class:"map-preview"},[e.createElementVNode("image",{class:"map-image",src:n.getRouteImage(),mode:"aspectFill"},null,8,["src"])])):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"walk-record-footer"},[e.createElementVNode("text",null,"分享遛狗记录可以激励其他铲屎官也加入运动！")])])}],["__scopeId","data-v-8c552cf6"]]);const Ne=he({props:{show:{type:Boolean,default:!1},images:{type:Array,default:()=>[]},initialIndex:{type:Number,default:0}},data:()=>({currentIndex:0}),watch:{initialIndex(e){this.currentIndex=e},show(e){e&&(this.currentIndex=this.initialIndex)}},methods:{handleSwiperChange(e){this.currentIndex=e.detail.current},close(){this.$emit("close")},formatImageUrl(e){if(!e)return"/static/images/default-image.png";if(a("log","at components/ImageViewer.vue:74","图片查看器处理URL:",e),e.startsWith("http")||e.startsWith("/static")||e.startsWith("blob:"))return e;if(e.startsWith("/uploads")){const t=uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000",s=t+e;return a("log","at components/ImageViewer.vue:85","处理相对路径图片URL:",e,"补充基础URL:",t,"完整URL:",s),s}return a("warn","at components/ImageViewer.vue:90","未能识别的图片URL格式:",e),"/static/images/default-image.png"}}},[["render",function(t,a,s,o,r,n){return s.show?(e.openBlock(),e.createElementBlock("view",{key:0,class:"image-viewer",onClick:a[5]||(a[5]=(...e)=>n.close&&n.close(...e))},[e.createElementVNode("swiper",{class:"image-swiper",current:r.currentIndex,onChange:a[2]||(a[2]=(...e)=>n.handleSwiperChange&&n.handleSwiperChange(...e)),circular:"",onClick:a[3]||(a[3]=e.withModifiers((()=>{}),["stop"]))},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.images,((t,s)=>(e.openBlock(),e.createElementBlock("swiper-item",{key:s,class:"swiper-item"},[e.createElementVNode("view",{class:"image-container",onClick:a[1]||(a[1]=(...e)=>n.close&&n.close(...e))},[e.createElementVNode("image",{class:"viewer-image",src:n.formatImageUrl(t),mode:"aspectFit",onClick:a[0]||(a[0]=(...e)=>n.close&&n.close(...e))},null,8,["src"])])])))),128))],40,["current"]),e.createElementVNode("view",{class:"controls"},[e.createElementVNode("text",{class:"indicator"},e.toDisplayString(r.currentIndex+1)+"/"+e.toDisplayString(s.images.length),1),e.createElementVNode("view",{class:"close-button",onClick:a[4]||(a[4]=e.withModifiers(((...e)=>n.close&&n.close(...e)),["stop"]))},"×")])])):e.createCommentVNode("",!0)}],["__scopeId","data-v-67a9d28c"]]);const Se=he({components:{WalkRecordCard:Ee,ImageViewer:Ne,UserInfoPopup:fe},data:()=>({scrollHeight:0,navHeight:110}),setup(){const t=B.community,s=X(),o=e.ref(0),r=e.ref(!1),n=e.ref(!1),i=e.ref(0),l=e.ref(!1),c=e.ref(0),u=e.ref(null),d=e.ref([]),m=e.ref(!1),p=e.ref(null),g=e.ref([]),v=e.ref(!1),h=e=>e&&Array.isArray(e)?e.map((e=>(e=>{if(e.walkRecord)return e;const t=e.content||"";let a=null;const s=t.match(/遛了\s*(\d+\.?\d*)\s*公里/),o=s?1e3*parseFloat(s[1]):null,r=t.match(/用时\s*(\d+)\s*(秒|分钟|小时)/);let n=null;if(r){const e=parseInt(r[1]),t=r[2];"秒"===t?n=e:"分钟"===t?n=60*e:"小时"===t&&(n=3600*e)}const i=t.match(/和\s*([^\s,，。！]+)\s*一起遛/),l=i?i[1]:"我的宠物";return null!==o||null!==n?(a={_id:`generated_${e._id||e.id||Date.now()}`,distance:o||0,duration:n||0,pet:{name:l},startTime:e.createdAt||e.time||(new Date).toISOString()},__spreadProps(__spreadValues({},e),{walkRecord:a})):e})(e))):[],f=(e=!1)=>__async(this,null,(function*(){if(!r.value){r.value=!0,e&&(d.value=[]);try{if(!t)return a("error","at pages/community/community.vue:305","社区API未找到，显示默认数据"),void y();a("log","at pages/community/community.vue:310","加载帖子类型:",0===o.value?"recommended":"following");const e=yield t.getPosts({type:0===o.value?"recommended":"following",limit:20});if(e&&(e.data||Array.isArray(e))){const t=e.data||e;t&&0!==t.length?(i.value=Date.now(),d.value=h(t)):0===o.value?y():d.value=[]}else 0===o.value?y():d.value=[]}catch(s){a("error","at pages/community/community.vue:347","加载帖子失败",s),0===o.value?y():(d.value=[],uni.showToast({title:"没有关注的内容",icon:"none"}))}finally{r.value=!1,uni.stopPullDownRefresh()}}})),y=()=>{const e=[{id:1,username:"狗狗爱好者",userAvatar:"/static/images/default-avatar.png",time:"1小时前",content:"今天和汪汪出去玩，好开心！",likes:12,comments:3,images:["/static/images/default-pet.png"]},{id:2,username:"宠物达人",userAvatar:"/static/images/default-avatar.png",time:"2小时前",content:"分享一下我家狗狗的日常~",likes:24,comments:8,images:["/static/images/default-pet.png","/static/images/default-pet.png","/static/images/default-pet.png"],walkRecord:{_id:"default_walk_record_1",distance:3500,duration:1800,pet:{name:"小白"},startTime:(new Date).toISOString()}},{id:3,username:"jlk1997",userAvatar:"/static/images/default-avatar.png",time:"5分钟前",content:"我和dwqdw一起遛了0.00公里，用时5秒！ caca",likes:0,comments:0}];d.value=h(e)},w=e=>{if(!e)return"/static/images/default-avatar.png";if(e.startsWith("http")||e.startsWith("/static"))return e;if(e.startsWith("/uploads")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}return"object"==typeof e&&e.avatar?w(e.avatar):"/static/images/default-avatar.png"};return{tabs:["推荐","关注"],currentTab:o,posts:d,isLoading:r,isRefreshing:n,lastPublishTime:i,formatDuration:e=>{if(!e)return"0分钟";const t=Math.floor(e/3600),a=Math.floor(e%3600/60);let s="";return t>0?(s+=`${t}小时`,a>0&&(s+=`${a}分钟`)):s+=`${a}分钟`,s},truncateText:(e,t)=>e?e.length<=t?e:e.substring(0,t)+"...":"",previewImage:(e,t)=>{u.value=e,c.value=t,l.value=!0},viewPostDetail:e=>{if(a("log","at pages/community/community.vue:617","查看帖子详情:",e),!e||!e.id&&!e._id)return void uni.showToast({title:"帖子数据无效",icon:"none"});const t=e.id||e._id;try{const a=`post_cache_${t}_${Date.now()}`;uni.setStorageSync(a,JSON.stringify(e)),uni.navigateTo({url:`/pages/community/post-detail?id=${t}&postKey=${a}`})}catch(s){a("error","at pages/community/community.vue:639","保存帖子数据到缓存失败:",s),uni.navigateTo({url:`/pages/community/post-detail?id=${t}`})}},formatDate:(e,t=!1)=>{if(!e)return"";if("string"==typeof e&&!e.includes("T")&&!e.includes("-"))return e;try{const t=new Date(e),a=new Date,s=Math.floor((a-t)/1e3);return s<60?"刚刚":s<3600?Math.floor(s/60)+"分钟前":s<86400?Math.floor(s/3600)+"小时前":s<2592e3?Math.floor(s/86400)+"天前":`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}catch(s){return a("error","at pages/community/community.vue:711","日期格式化错误:",s),e}},switchTab:e=>{o.value!==e?(o.value=e,f(!0)):f(!0)},loadMore:()=>__async(this,null,(function*(){if(!r.value){r.value=!0;try{if(!t)return void(r.value=!1);const e=d.value.length>0?d.value[d.value.length-1].id:null;a("log","at pages/community/community.vue:557","加载更多，类型:",0===o.value?"recommended":"following","最后ID:",e);const s=yield t.getPosts({type:0===o.value?"recommended":"following",limit:10,lastId:e});s&&s.data&&s.data.length>0?d.value=[...d.value,...s.data]:uni.showToast({title:"没有更多内容了",icon:"none"})}catch(e){a("error","at pages/community/community.vue:576","加载更多帖子失败",e),uni.showToast({title:"加载更多失败",icon:"none"})}finally{r.value=!1}}})),navToCreate:()=>{i.value=Date.now(),uni.navigateTo({url:"/pages/community/create"})},likePost:(e,s)=>__async(this,null,(function*(){if(a("log","at pages/community/community.vue:451","Like post:",e,"Index:",s),!e||!e.id&&!e._id)return a("error","at pages/community/community.vue:454","Invalid post ID for like action"),void uni.showToast({title:"无法点赞",icon:"none"});const o=e.id||e._id;void 0===e.isLiked&&(e.isLiked=!1),void 0===e.likes&&(e.likes=0);const r=e.isLiked;e.isLiked=!r,e.likes=r?Math.max((e.likes||1)-1,0):(e.likes||0)+1;try{if(!t)throw new Error("社区API未初始化");const s=yield t.likePost(o,!r);a("log","at pages/community/community.vue:488","Like/unlike success:",s),s&&s.data&&void 0!==s.data.likes&&(e.likes=s.data.likes,e.isLiked=s.data.isLiked)}catch(n){a("error","at pages/community/community.vue:496","Like/unlike error:",n),e.isLiked=r,e.likes=r?(e.likes||0)+1:Math.max((e.likes||1)-1,0),uni.showToast({title:"操作失败，请重试",icon:"none"})}})),viewComments:e=>{if(a("log","at pages/community/community.vue:512","Viewing comments for post:",e),!e||!e.id&&!e._id)return a("error","at pages/community/community.vue:515","Invalid post ID for comments view"),void uni.showToast({title:"无法查看评论",icon:"none"});const t=e.id||e._id;try{const a=`post_cache_${t}_${Date.now()}`;uni.setStorageSync(a,JSON.stringify(e)),uni.navigateTo({url:`/pages/community/post-detail?id=${t}&postKey=${a}&showComments=true`})}catch(s){a("error","at pages/community/community.vue:535","保存帖子数据到缓存失败:",s),uni.navigateTo({url:`/pages/community/post-detail?id=${t}&showComments=true`})}},loadPosts:f,onRefresh:()=>{a("log","at pages/community/community.vue:270","触发下拉刷新"),n.value=!0,f(!0).finally((()=>{setTimeout((()=>{n.value=!1}),300)}))},formatAvatarUrl:w,handleAvatarError:(e,t)=>{a("warn","at pages/community/community.vue:445","头像加载失败:",e,"索引:",t),e.target.src="/static/images/default-avatar.png"},formatImageUrl:e=>{if(!e)return"/static/images/default-pet.png";if(a("log","at pages/community/community.vue:720","社区页面处理图片URL:",e),e.startsWith("http")||e.startsWith("/static")||e.startsWith("blob:"))return e;if(e.startsWith("/uploads")){const t=uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000",s=t+e;return a("log","at pages/community/community.vue:731","处理相对路径图片URL:",e,"补充基础URL:",t,"完整URL:",s),s}return a("warn","at pages/community/community.vue:736","未能识别的图片URL格式:",e),"/static/images/default-pet.png"},viewWalkRecord:e=>{if(!e.walkRecord||!e.walkRecord._id)return void uni.showToast({title:"遛狗记录不存在",icon:"none"});a("log","at pages/community/community.vue:657","查看遛狗记录详情:",e.walkRecord);e.walkRecord._id.startsWith("generated_")?uni.showToast({title:"这是从动态内容解析的遛狗记录，无法查看详情",icon:"none",duration:2500}):uni.navigateTo({url:`/pages/walk/detail?id=${e.walkRecord._id}`,fail:e=>{a("error","at pages/community/community.vue:675","打开遛狗记录详情失败:",e),uni.showToast({title:"无法查看遛狗记录",icon:"none"})}})},getNumberValue:e=>Array.isArray(e)?e.length:"number"==typeof e?e:e&&"object"==typeof e?Object.keys(e).length:0,showImageViewer:l,currentImageIndex:c,currentPost:u,closeImageViewer:()=>{l.value=!1},showUserPopup:m,selectedUser:p,selectedUserPets:g,isFollowing:v,showUserProfile:e=>__async(this,null,(function*(){if(a("log","at pages/community/community.vue:742","显示用户信息:",e),!e||!e._id)return a("error","at pages/community/community.vue:744","无效的用户信息"),void uni.showToast({title:"无法获取用户信息",icon:"none"});const t=s.isAuthenticated&&s.userId===e._id;if(p.value=__spreadProps(__spreadValues({},e),{isCurrentUser:t}),v.value=!1,s.isAuthenticated&&!t)try{a("log","at pages/community/community.vue:768","直接调用checkFollowStatus检查关注状态，用户ID:",e._id);const t=yield B.user.checkFollowStatus(e._id);t&&void 0!==t.isFollowing&&(v.value=t.isFollowing,a("log","at pages/community/community.vue:773","API返回的关注状态:",v.value))}catch(o){a("error","at pages/community/community.vue:776","检查关注状态失败:",o),void 0!==e.isFollowing&&(v.value=e.isFollowing,a("log","at pages/community/community.vue:781","从用户对象获取关注状态:",v.value))}if(a("log","at pages/community/community.vue:786","初始关注状态设置为:",v.value),s.isAuthenticated)try{let s=null;try{a("log","at pages/community/community.vue:795","尝试获取用户详情，ID:",e._id),s=yield B.user.getUserById(e._id),a("log","at pages/community/community.vue:798","获取用户详情成功:",s),s&&void 0!==s.isFollowing&&(v.value=v.value||s.isFollowing,a("log","at pages/community/community.vue:804","综合考虑后的关注状态:",v.value))}catch(r){a("error","at pages/community/community.vue:807","获取用户详情失败, 使用基本信息:",r),s=__spreadProps(__spreadValues({},e),{nickname:e.nickname||e.username||"用户",bio:e.bio||"这位用户还没有个人简介"}),uni.showToast({title:"获取用户详情失败",icon:"none",duration:1500})}if(s){t&&(v.value=!1),p.value=__spreadProps(__spreadValues({},s),{isCurrentUser:t,isFollowing:v.value}),a("log","at pages/community/community.vue:837","更新后的selectedUser和isFollowing:",p.value,v.value);try{a("log","at pages/community/community.vue:841","尝试获取用户宠物列表，用户ID:",e._id);const t=yield B.user.getPetsByUser(e._id);a("log","at pages/community/community.vue:843","获取到的宠物列表:",t),g.value=t||[]}catch(n){a("error","at pages/community/community.vue:846","获取宠物列表失败:",n),g.value=[]}}}catch(o){a("error","at pages/community/community.vue:851","获取用户详情过程中出错:",o),p.value=__spreadProps(__spreadValues({},e),{isCurrentUser:t,isFollowing:v.value,nickname:e.nickname||e.username||"用户",bio:e.bio||"这位用户还没有个人简介"})}a("log","at pages/community/community.vue:864","最终用户信息和关注状态:",{user:p.value,isFollowing:v.value,pets:g.value}),m.value=!0})),closeUserPopup:()=>{m.value=!1,p.value=null,g.value=[]},messageUser:e=>{a("log","at pages/community/community.vue:883","向用户发送消息:",e)},followUser:e=>__async(this,null,(function*(){if(s.isAuthenticated)if(e&&e._id)try{const t=yield B.user.followUser(e._id);t&&void 0!==t.isFollowing&&(v.value=t.isFollowing,uni.showToast({title:v.value?"关注成功":"取消关注成功",icon:"success"}),p.value&&(p.value.isFollowing=v.value),yield s.fetchUserStats(),1!==o.value||v.value||f())}catch(t){a("error","at pages/community/community.vue:926","关注用户操作失败:",t),uni.showToast({title:"操作失败，请重试",icon:"none"})}else a("error","at pages/community/community.vue:896","无效的用户信息");else uni.navigateTo({url:"/pages/login/login"})}))}},onLoad(){const e=uni.getSystemInfoSync(),t=e.windowHeight;e.statusBarHeight;const s=uni.upx2px(170),o=uni.upx2px(100);this.scrollHeight=t-s-o,a("log","at pages/community/community.vue:990","设置滚动区域高度:",this.scrollHeight,"px (已减去tabBar高度)"),this.$nextTick((()=>{uni.$api&&uni.$api.community?this.loadPosts():"function"==typeof this.showDefaultPosts&&this.showDefaultPosts()}))},mounted(){if(uni.$api&&uni.$api.community)this.loadPosts();else{a("warn","at pages/community/community.vue:1011","API尚未准备好，使用默认数据"),this.showDefaultPosts();const e=setInterval((()=>{uni.$api&&uni.$api.community&&(clearInterval(e),this.loadPosts())}),1e3);setTimeout((()=>{clearInterval(e)}),5e3)}},onPullDownRefresh(){a("log","at pages/community/community.vue:1031","页面下拉刷新触发"),this.isRefreshing=!0,this.loadPosts(!0).finally((()=>{uni.stopPullDownRefresh(),setTimeout((()=>{this.isRefreshing=!1}),300)}))},onShow(){const e=Date.now();this.lastPublishTime&&e-this.lastPublishTime<15e3&&(a("log","at pages/community/community.vue:1047","检测到可能发布新帖子，刷新内容"),this.loadPosts&&this.loadPosts(!0))}},[["render",function(t,a,s,o,r,n){var i;const l=e.resolveComponent("walk-record-card"),c=e.resolveComponent("image-viewer"),u=e.resolveComponent("UserInfoPopup");return e.openBlock(),e.createElementBlock("view",{class:"community-container"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("text",{class:"title"},"社区动态"),e.createElementVNode("view",{class:"create-post-btn",onClick:a[0]||(a[0]=(...e)=>o.navToCreate&&o.navToCreate(...e))},[e.createElementVNode("text",{class:"create-icon"},"+"),e.createElementVNode("text",{class:"create-text"},"发布")])]),e.createElementVNode("view",{class:"tabs"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.tabs,((t,a)=>(e.openBlock(),e.createElementBlock("view",{class:e.normalizeClass(["tab-item",{active:o.currentTab===a}]),key:a,onClick:e=>o.switchTab(a)},[e.createElementVNode("text",null,e.toDisplayString(t),1)],10,["onClick"])))),128))]),e.createElementVNode("view",{class:"list-container"},[e.createElementVNode("scroll-view",{class:"post-list","scroll-y":"true",onScrolltolower:a[1]||(a[1]=(...e)=>o.loadMore&&o.loadMore(...e))},[o.posts&&0===o.posts.length&&!o.isLoading?(e.openBlock(),e.createElementBlock("view",{key:0,class:"no-posts"},[0===o.currentTab?(e.openBlock(),e.createElementBlock("text",{key:0},"暂时没有动态，快去发布一条吧！")):(e.openBlock(),e.createElementBlock("text",{key:1},"暂时没有动态，快去关注更多狗友吧！"))])):e.createCommentVNode("",!0),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.posts,((t,a)=>{var s,r;return e.openBlock(),e.createElementBlock("view",{class:"post-item",key:t.id||t._id,onClick:e=>o.viewPostDetail(t)},[e.createElementVNode("view",{class:"post-header"},[e.createElementVNode("view",{class:"user-info"},[e.createElementVNode("image",{class:"user-avatar",src:o.formatAvatarUrl((null==(s=t.user)?void 0:s.avatar)||t.userAvatar),mode:"aspectFill",onClick:e.withModifiers((e=>o.showUserProfile(t.user||{_id:t.userId,username:t.username,avatar:t.userAvatar})),["stop"]),onError:e=>o.handleAvatarError(e,a)},null,40,["src","onClick","onError"]),e.createElementVNode("text",{class:"username"},e.toDisplayString((null==(r=t.user)?void 0:r.username)||t.username||"用户"),1)]),e.createElementVNode("text",{class:"post-time"},e.toDisplayString(o.formatDate(t.createdAt||t.time)),1)]),e.createElementVNode("view",{class:"post-content"},[e.createElementVNode("text",{class:"post-text"},e.toDisplayString(o.truncateText(t.content,40)),1),t.walkRecord?(e.openBlock(),e.createBlock(l,{key:0,record:t.walkRecord},null,8,["record"])):e.createCommentVNode("",!0),t.images&&t.images.length>0?(e.openBlock(),e.createElementBlock("view",{key:1,class:"post-images"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(t.images.slice(0,3),((a,s)=>(e.openBlock(),e.createElementBlock("image",{key:s,src:o.formatImageUrl(a),mode:"aspectFill",class:e.normalizeClass(["post-image",{"single-image":1===t.images.length}]),onClick:e.withModifiers((e=>o.previewImage(t,s)),["stop"])},null,10,["src","onClick"])))),128)),t.images.length>3?(e.openBlock(),e.createElementBlock("view",{key:0,class:"more-images"},[e.createElementVNode("text",null,"+"+e.toDisplayString(t.images.length-3),1)])):e.createCommentVNode("",!0)])):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"post-footer"},[e.createElementVNode("view",{class:"action-item",onClick:e.withModifiers((e=>o.likePost(t,a)),["stop"])},[e.createElementVNode("view",{class:e.normalizeClass(["action-icon like-icon",{active:t.isLiked}])},null,2),e.createElementVNode("text",{class:"action-text"},"点赞 "+e.toDisplayString(o.getNumberValue(t.likes)),1)],8,["onClick"]),e.createElementVNode("view",{class:"action-item",onClick:e.withModifiers((e=>o.viewComments(t)),["stop"])},[e.createElementVNode("view",{class:"action-icon comment-icon"}),e.createElementVNode("text",{class:"action-text"},"评论 "+e.toDisplayString(o.getNumberValue(t.comments)),1)],8,["onClick"])])],8,["onClick"])})),128))],32),o.isLoading?(e.openBlock(),e.createElementBlock("view",{key:0,class:"loading-more"},[e.createElementVNode("text",null,"加载中...")])):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"float-btn",onClick:a[2]||(a[2]=(...e)=>o.navToCreate&&o.navToCreate(...e))},[e.createElementVNode("text",{class:"float-icon"},"+")]),e.createVNode(c,{show:o.showImageViewer,images:(null==(i=o.currentPost)?void 0:i.images)||[],initialIndex:o.currentImageIndex,onClose:o.closeImageViewer},null,8,["show","images","initialIndex","onClose"]),o.showUserPopup?(e.openBlock(),e.createBlock(u,{key:0,user:o.selectedUser,pets:o.selectedUserPets,"is-following":o.isFollowing,visible:o.showUserPopup,onClose:o.closeUserPopup,onMessage:o.messageUser,onFollow:o.followUser},null,8,["user","pets","is-following","visible","onClose","onMessage","onFollow"])):e.createCommentVNode("",!0)])}]]);var Ve={VITE_CJS_IGNORE_WARNING:"true",VITE_ROOT_DIR:"D:/caloriesH5/CloudStorage",VITE_USER_NODE_ENV:"production",BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1};const _e={__name:"index",setup(t){const s=X(),o=Y(),r=e.ref(!1),n=e.ref(null),i=Ve.VITE_API_URL||"http://49.235.65.37:5000",l=e.computed((()=>{const e=s.userAvatar;if(a("log","at pages/index/index.vue:122","当前用户头像路径:",e),e&&e.startsWith("/uploads/")){const t=i+e;return a("log","at pages/index/index.vue:127","完整头像URL:",t),t}return e||"/static/images/default-avatar.png"})),c=e.computed((()=>s.stats||{walkCount:0,totalDistance:0,following:0,followers:0}));function d(){try{const e=uni.getStorageSync("token"),t=uni.getStorageSync("userInfo");e&&t?(n.value=JSON.parse(t),r.value=!0,s.isAuthenticated||(s.token=e,s.user=n.value),n.value&&n.value.avatar&&s.user&&(s.user.avatar=n.value.avatar),function(){__async(this,null,(function*(){if(s.isAuthenticated)try{a("log","at pages/index/index.vue:205","Loaded user stats:",yield s.fetchUserStats())}catch(e){a("error","at pages/index/index.vue:209","获取用户统计数据失败:",e)}}))}()):m()}catch(e){a("error","at pages/index/index.vue:176","加载用户信息失败:",e),m()}}function m(){n.value=null,r.value=!1,s.isAuthenticated&&(s.user=null,s.token=null,s.stats=null)}function v(){s.isAuthenticated?p({title:"退出登录",content:"确定要退出登录吗？",showCancel:!0}).then((e=>{e&&s.logout().then((()=>{m(),u("已成功退出登录")})).catch((e=>{a("error","at pages/index/index.vue:244","退出登录失败:",e),u("退出登录失败，请重试")}))})):g("/pages/login/login")}function h(){return __async(this,null,(function*(){if(!s.isAuthenticated)return u("请先登录");try{const t=(yield new Promise(((e,t)=>{uni.chooseImage({count:6,sizeType:["compressed"],sourceType:["album","camera"],success:e,fail:t})}))).tempFilePaths;u("上传中...");try{const e=yield s.uploadAvatar(t);e&&(e.avatar||e.data&&e.data.avatar)?(u("头像上传成功"),yield s.fetchUserInfo()):u("头像上传失败，请重试")}catch(e){a("error","at pages/index/index.vue:291","头像上传失败:",e),u("头像上传失败，请重试")}}catch(e){a("error","at pages/index/index.vue:295","选择图片失败:",e)}}))}function f(){if(!s.isAuthenticated)return u("请先登录");g("/pages/profile/profile")}function y(){s.isAuthenticated?(a("log","at pages/index/index.vue:319","开始导航到添加宠物页面"),uni.navigateTo({url:"/pages/pet/edit?mode=add",success:e=>{a("log","at pages/index/index.vue:325","导航到添加宠物页面成功",e)},fail:e=>{a("error","at pages/index/index.vue:328","导航到添加宠物页面失败:",e),uni.navigateTo({url:"/pages/pet/edit",success:()=>{a("log","at pages/index/index.vue:334","使用简化路径导航成功");const e=getCurrentPages(),t=e[e.length-1];t&&t.$vm&&(t.$vm.mode="add",a("log","at pages/index/index.vue:340","手动设置页面mode=add"))},fail:e=>{a("error","at pages/index/index.vue:344","使用简化路径仍然失败:",e),uni.navigateTo({url:"/pages/pet/management",success:()=>{a("log","at pages/index/index.vue:350","导航到宠物管理页面成功"),u("请点击添加宠物按钮")},fail:()=>{u("页面跳转失败，请稍后再试")}})}})}})):u("请先登录")}function w(e){r.value||"/pages/login/login"===e?g(e):u("Please login first")}function k(e){if(!e)return"/static/images/default-pet.png";if(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("/static/"))return e;if(e.startsWith("/uploads")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}if(e.startsWith("uploads/")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+"/"+e}return"/static/images/default-pet.png"}function E(e){if(!s.isAuthenticated)return u("请先登录"),void setTimeout((()=>{w("/pages/login/login")}),1500);"following"===e?w("/pages/profile/following"):"followers"===e&&w("/pages/profile/followers")}function N(){s.isAuthenticated?g("/pages/pet/recognition"):u("请先登录")}return e.ref([]),e.onMounted((()=>{const e=uni.getStorageSync("token"),t=uni.getStorageSync("userInfo");if(e&&t){if(d(),o.fetchPets(),s.token){const e=uni.getStorageSync("userInfo");if(e)try{const t=JSON.parse(e);t&&t._id&&(s.user=t,a("log","at pages/index/index.vue:464","已从缓存加载用户信息:",t))}catch(r){a("error","at pages/index/index.vue:467","解析存储的用户信息失败:",r)}setTimeout((()=>{s.fetchUserInfo().then((()=>{a("log","at pages/index/index.vue:474","已从服务器更新用户信息")})).catch((e=>{a("error","at pages/index/index.vue:476","从服务器更新用户信息失败:",e)}))}),500)}}else uni.navigateTo({url:"/pages/login/login",success:()=>{u("请先登录")}})})),e.watch((()=>s.user),(e=>{a("log","at pages/index/index.vue:519","User store changed, refresh data"),e&&(s.fetchUserStats(),o.fetchPets())}),{deep:!0}),e.watch((()=>o.pets),(e=>{a("log","at pages/index/index.vue:529","Pet list updated, total pets:",e.length)}),{deep:!0}),(t,a)=>(e.openBlock(),e.createElementBlock("view",{class:"profile-container"},[e.createElementVNode("view",{class:"user-card"},[e.createElementVNode("view",{class:"avatar-wrapper"},[e.createElementVNode("image",{class:"avatar",src:l.value,mode:"aspectFill",onClick:h},null,8,["src"])]),e.createElementVNode("view",{class:"user-info"},[e.createElementVNode("view",{class:"nickname"},e.toDisplayString(e.unref(s).nickname),1),e.createElementVNode("view",{class:"user-id"},"ID: "+e.toDisplayString(e.unref(s).userId),1)]),e.createElementVNode("view",{class:"edit-btn",onClick:f},[e.createElementVNode("text",null,"编辑资料")])]),e.createElementVNode("view",{class:"stats-card"},[e.createElementVNode("view",{class:"stat-item",onClick:a[0]||(a[0]=e=>w("/pages/walk/history"))},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString(c.value.walkCount||0),1),e.createElementVNode("text",{class:"stat-label"},"遛狗次数")]),e.createElementVNode("view",{class:"stat-item",onClick:a[1]||(a[1]=e=>w("/pages/walk/history"))},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString(c.value.totalDistance||0),1),e.createElementVNode("text",{class:"stat-label"},"总距离(KM)")]),e.createElementVNode("view",{class:"stat-item",onClick:a[2]||(a[2]=e=>E("following"))},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString(c.value.following||0),1),e.createElementVNode("text",{class:"stat-label"},"关注")]),e.createElementVNode("view",{class:"stat-item",onClick:a[3]||(a[3]=e=>E("followers"))},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString(c.value.followers||0),1),e.createElementVNode("text",{class:"stat-label"},"粉丝")])]),e.createElementVNode("view",{class:"section"},[e.createElementVNode("view",{class:"section-header"},[e.createElementVNode("text",{class:"section-title"},"我的宠物"),e.createElementVNode("view",{class:"add-btn",onClick:y},[e.createElementVNode("text",null,"添加宠物")])]),e.unref(o).pets.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"pet-list"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(o).pets,(t=>(e.openBlock(),e.createElementBlock("view",{class:"pet-item",key:t.id||t._id,onClick:e=>{return a=t._id||t.id,void(r.value?g(`/pages/pet/edit?petId=${a}&mode=edit`):u("请先登录"));var a}},[e.createElementVNode("image",{class:"pet-avatar",src:k(t.avatar),mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"pet-info"},[e.createElementVNode("text",{class:"pet-name"},e.toDisplayString(t.name),1),e.createElementVNode("text",{class:"pet-breed"},e.toDisplayString(t.breed),1)]),e.createElementVNode("view",{class:"edit-indicator"},[e.createElementVNode("text",{class:"edit-arrow"},">")])],8,["onClick"])))),128))])):(e.openBlock(),e.createElementBlock("view",{key:1,class:"empty-list"},[e.createElementVNode("text",null,'还没有添加宠物，点击"添加宠物"开始吧！')]))]),e.createElementVNode("view",{class:"menu-section"},[e.createElementVNode("view",{class:"menu-item",onClick:a[4]||(a[4]=e=>w("/pages/walk/history"))},[e.createElementVNode("view",{class:"menu-icon walk-icon"}),e.createElementVNode("text",{class:"menu-text"},"遛狗记录"),e.createElementVNode("view",{class:"arrow-icon"})]),e.createElementVNode("view",{class:"menu-item",onClick:a[5]||(a[5]=e=>w("/pages/community/my-posts"))},[e.createElementVNode("view",{class:"menu-icon post-icon"}),e.createElementVNode("text",{class:"menu-text"},"我的动态"),e.createElementVNode("view",{class:"arrow-icon"})]),e.createElementVNode("view",{class:"menu-item",onClick:a[6]||(a[6]=e=>w("/pages/profile/my-markers"))},[e.createElementVNode("view",{class:"menu-icon map-icon"}),e.createElementVNode("text",{class:"menu-text"},"我的标记"),e.createElementVNode("view",{class:"arrow-icon"})]),e.createElementVNode("view",{class:"menu-item",onClick:N},[e.createElementVNode("view",{class:"menu-icon pet-icon"}),e.createElementVNode("text",{class:"menu-text"},"宠物识别"),e.createElementVNode("view",{class:"arrow-icon"})]),e.createElementVNode("view",{class:"menu-item",onClick:a[7]||(a[7]=e=>w("/pages/profile/settings"))},[e.createElementVNode("view",{class:"menu-icon settings-icon"}),e.createElementVNode("text",{class:"menu-text"},"设置"),e.createElementVNode("view",{class:"arrow-icon"})])]),e.createElementVNode("view",{class:"login-section"},[e.createElementVNode("button",{class:"login-btn",onClick:v},e.toDisplayString(e.unref(s).isAuthenticated?"退出登录":"登录/注册"),1)])]))}};const Pe=he({setup(){const t=e.ref(""),s=e.ref([]),o=e.ref(!1),r=e.ref(null),n=e.ref(null),i=e.ref(!1),l=e.ref("");uni.getLocation({type:"gcj02",success:e=>{a("log","at pages/community/create.vue:110","获取位置成功:",e),n.value={type:"Point",coordinates:[e.longitude,e.latitude]}},fail:e=>{a("error","at pages/community/create.vue:117","获取位置失败:",e),n.value={type:"Point",coordinates:[116.3,39.9]}}});uni.$on("createPost",(e=>{a("log","at pages/community/create.vue:187","收到预填内容:",e),e&&e.content&&(t.value=e.content),e&&e.walkRecord&&(r.value=e.walkRecord,a("log","at pages/community/create.vue:194","设置遛狗记录:",r.value))}));uni.$once("hook:beforeDestroy",(()=>{uni.$off("createPost")}));const c=e=>__async(this,null,(function*(){try{uni.showLoading({title:"加载帖子数据..."});const l=`post_cache_${e}_`;let c=null;const u=uni.getStorageInfoSync().keys||[];for(const e of u)if(e.startsWith(l))try{const t=uni.getStorageSync(e);if(t){c=JSON.parse(t),a("log","at pages/community/create.vue:465","找到缓存的帖子数据:",c);break}}catch(o){a("error","at pages/community/create.vue:469","解析缓存数据失败:",o)}if(!c)try{if(uni.$api&&uni.$api.community&&"function"==typeof uni.$api.community.getPostDetail)c=yield uni.$api.community.getPostDetail(e),a("log","at pages/community/create.vue:480","API获取帖子数据成功:",c);else{a("warn","at pages/community/create.vue:482","API中没有getPostDetail方法，尝试从页面参数获取");const e=getCurrentPages(),t=e[e.length-1].options||{};if(t.postKey)try{const e=uni.getStorageSync(t.postKey);e&&(c=JSON.parse(e),a("log","at pages/community/create.vue:494","从页面参数缓存获取帖子数据:",c))}catch(o){a("error","at pages/community/create.vue:497","解析页面参数缓存数据失败:",o)}}}catch(i){a("error","at pages/community/create.vue:502","从API获取帖子数据失败:",i);const e=getCurrentPages(),t=e[e.length-1].options||{};if(t.postKey)try{const e=uni.getStorageSync(t.postKey);e&&(c=JSON.parse(e),a("log","at pages/community/create.vue:514","从页面参数缓存获取帖子数据:",c))}catch(o){a("error","at pages/community/create.vue:517","解析页面参数缓存数据失败:",o)}}c?(t.value=c.content||"",c.images&&c.images.length>0&&(s.value=[...c.images]),c.walkRecord&&(r.value=c.walkRecord),c.location&&(n.value=c.location)):uni.showToast({title:"获取帖子失败",icon:"none"})}catch(i){a("error","at pages/community/create.vue:548","加载帖子数据失败:",i),uni.showToast({title:"加载帖子数据失败",icon:"none"})}finally{uni.hideLoading()}}));e.onMounted((()=>{const e=getCurrentPages(),o=e[e.length-1].options||{};if(a("log","at pages/community/create.vue:564","页面参数:",o),"edit"===o.mode&&o.id)if(i.value=!0,l.value=o.id,o.postKey)try{const e=uni.getStorageSync(o.postKey);if(e){const o=JSON.parse(e);a("log","at pages/community/create.vue:577","从传入的缓存键加载帖子数据:",o),t.value=o.content||"",o.images&&o.images.length>0&&(s.value=[...o.images]),o.walkRecord&&(r.value=o.walkRecord),o.location&&(n.value=o.location)}else c(o.id)}catch(u){a("error","at pages/community/create.vue:601","解析缓存数据失败:",u),c(o.id)}else c(o.id)}));return{content:t,images:s,isSubmitting:o,walkRecord:r,userLocation:n,isEditMode:i,editPostId:l,formatDuration:e=>{const t=Math.floor(e/3600),a=Math.floor(e%3600/60);let s="";return t>0&&(s+=`${t}小时`),(a>0||t>0)&&(s+=`${a}分钟`),s+=`${e%60}秒`,s},navBack:()=>{uni.navigateBack()},chooseImage:()=>{uni.chooseImage({count:6-s.value.length,sizeType:["compressed"],sourceType:["album","camera"],success:e=>{s.value=[...s.value,...e.tempFilePaths]}})},removeImage:e=>{s.value.splice(e,1)},previewImage:(e,t)=>{uni.previewImage({urls:s.value,current:t,indicator:"number",loop:!0,longPressActions:{itemList:["保存图片","取消"],success:function(e){0===e.tapIndex&&uni.saveImageToPhotosAlbum({filePath:s.value[t],success:function(){uni.showToast({title:"图片已保存",icon:"success"})},fail:function(){uni.showToast({title:"保存失败",icon:"none"})}})}}})},submitPost:()=>__async(this,null,(function*(){if(!t.value.trim())return void uni.showToast({title:"请输入内容",icon:"none"});if(o.value)return;if(o.value=!0,uni.showLoading({title:i.value?"更新中...":"发布中..."}),!n.value)try{yield new Promise((e=>{uni.getLocation({type:"gcj02",success:t=>{n.value={type:"Point",coordinates:[t.longitude,t.latitude]},a("log","at pages/community/create.vue:245","发帖前获取位置成功:",n.value),e()},fail:t=>{a("error","at pages/community/create.vue:249","发帖前获取位置失败:",t),n.value={type:"Point",coordinates:[116.3,39.9]},e()}})}))}catch(c){a("error","at pages/community/create.vue:260","获取位置过程中出错:",c),n.value={type:"Point",coordinates:[116.3,39.9]}}const e={content:t.value,walkRecord:r.value?{_id:r.value._id,distance:r.value.distance,duration:r.value.duration,pet:r.value.pet}:null,location:{type:"Point",coordinates:n.value?n.value.coordinates:[116.3,39.9]}};a("log","at pages/community/create.vue:288",`准备${i.value?"更新":"发送"}的帖子数据:`,e);try{if(!uni.$api||!uni.$api.community)throw new Error("社区API未初始化");let t;i.value&&l.value?(t=yield uni.$api.community.updatePost(l.value,e),a("log","at pages/community/create.vue:302","更新帖子成功，结果:",t)):(t=yield uni.$api.community.createPost(e),a("log","at pages/community/create.vue:306","发布帖子成功，结果:",t));const o=l.value||t&&t._id||t&&t.id||t&&t.data&&t.data._id;if(!o)throw a("error","at pages/community/create.vue:314","无法获取有效的帖子ID:",t),new Error("创建帖子成功但无法获取帖子ID");if(a("log","at pages/community/create.vue:318","获取到的帖子ID:",o),s.value&&s.value.length>0&&o){a("log","at pages/community/create.vue:322","准备上传帖子图片, 帖子ID:",o);try{const e=[];for(let t=0;t<s.value.length;t++)if(s.value[t].startsWith("blob:")||s.value[t].startsWith("file:")||!s.value[t].startsWith("http")){uni.showLoading({title:`上传图片 ${t+1}/${s.value.length}...`});try{const r=yield uni.$api.community.uploadPostImage(o,s.value[t]);a("log","at pages/community/create.vue:341",`图片 ${t+1} 上传成功:`,r),r&&r.url&&e.push(r.url)}catch(u){a("error","at pages/community/create.vue:348",`图片 ${t+1} 上传失败:`,u),uni.showToast({title:`图片 ${t+1} 上传失败，将继续上传其他图片`,icon:"none",duration:2e3});try{"string"==typeof s.value[t]&&(s.value[t].startsWith("file://")||s.value[t].startsWith("/storage/"))&&(a("log","at pages/community/create.vue:361",`尝试保存本地图片路径: ${s.value[t]}`),e.push(s.value[t]))}catch(c){a("error","at pages/community/create.vue:365","保存本地图片路径失败:",c)}}}else(s.value[t].startsWith("http")||s.value[t].startsWith("/uploads"))&&e.push(s.value[t]);if(e.length>0){a("log","at pages/community/create.vue:376","所有图片上传完成，更新帖子图片字段:",e);try{const t=Array.isArray(e)?{images:e}:{images:[e]};if(a("log","at pages/community/create.vue:383","发送更新帖子请求，数据:",t),"string"!=typeof o||!o.trim())throw a("error","at pages/community/create.vue:387","更新图片时发现帖子ID无效:",o),new Error("帖子ID无效，无法更新图片");i.value?(yield uni.$api.community.updatePost(o,t),a("log","at pages/community/create.vue:395","更新帖子图片成功")):a("log","at pages/community/create.vue:398","发布新帖模式，跳过更新帖子图片步骤")}catch(d){a("error","at pages/community/create.vue:401","更新帖子图片字段失败:",d)}}}catch(m){a("error","at pages/community/create.vue:406","上传图片过程中出错:",m)}}uni.hideLoading(),uni.showToast({title:i.value?"更新成功":"发布成功",icon:"success"}),setTimeout((()=>{uni.navigateBack()}),1500)}catch(p){uni.hideLoading(),uni.showToast({title:"发布失败: "+(p.message||"未知错误"),icon:"none",duration:2e3}),a("error","at pages/community/create.vue:435","发布帖子失败",p)}finally{o.value=!1}})),loadPostData:c,testMultipleImages:()=>{uni.chooseImage({count:6,sizeType:["original","compressed"],sourceType:["album"],success:e=>{a("log","at pages/community/create.vue:620","选择了多张图片:",e.tempFilePaths),s.value=[...e.tempFilePaths],t.value||(t.value="测试多图上传功能，这是一个包含多张图片的帖子"),uni.showToast({title:`已选择${e.tempFilePaths.length}张图片`,icon:"none"})}})}}}},[["render",function(t,a,s,o,r,n){return e.openBlock(),e.createElementBlock("view",{class:"create-post"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("view",{class:"back-btn",onClick:a[0]||(a[0]=(...e)=>o.navBack&&o.navBack(...e))},[e.createElementVNode("text",null,"取消")]),e.createElementVNode("text",{class:"title"},e.toDisplayString(o.isEditMode?"编辑动态":"发布动态"),1),e.createElementVNode("view",{class:"submit-btn",onClick:a[1]||(a[1]=(...e)=>o.submitPost&&o.submitPost(...e))},[e.createElementVNode("text",null,e.toDisplayString(o.isEditMode?"更新":"发布"),1)])]),e.createElementVNode("view",{class:"content-area"},[e.withDirectives(e.createElementVNode("textarea",{class:"post-textarea","onUpdate:modelValue":a[2]||(a[2]=e=>o.content=e),placeholder:"分享您的遛狗心得...",maxlength:"500","auto-height":""},null,512),[[e.vModelText,o.content]]),e.createElementVNode("view",{class:"image-upload"},[e.createElementVNode("view",{class:"image-list"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.images,((t,a)=>(e.openBlock(),e.createElementBlock("view",{class:"image-item",key:a},[e.createElementVNode("image",{class:"preview",src:t,mode:"aspectFill",onClick:e=>o.previewImage(t,a)},null,8,["src","onClick"]),e.createElementVNode("text",{class:"delete-btn",onClick:e=>o.removeImage(a)},"×",8,["onClick"])])))),128)),o.images.length<6?(e.openBlock(),e.createElementBlock("view",{key:0,class:"add-image",onClick:a[3]||(a[3]=(...e)=>o.chooseImage&&o.chooseImage(...e))},[e.createElementVNode("text",{class:"add-icon"},"+")])):e.createCommentVNode("",!0)]),0===o.images.length?(e.openBlock(),e.createElementBlock("view",{key:0,class:"test-btn",onClick:a[4]||(a[4]=(...e)=>o.testMultipleImages&&o.testMultipleImages(...e))},[e.createElementVNode("text",null,"选择多张图片测试")])):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"char-counter"},[e.createElementVNode("text",null,e.toDisplayString(o.content.length)+"/500",1)]),o.walkRecord?(e.openBlock(),e.createElementBlock("view",{key:0,class:"walk-record-card"},[e.createElementVNode("view",{class:"card-header"},[e.createElementVNode("text",{class:"card-icon"},"🐾"),e.createElementVNode("text",{class:"card-title"},"遛狗记录")]),e.createElementVNode("view",{class:"card-content"},[e.createElementVNode("view",{class:"card-item"},[e.createElementVNode("text",{class:"item-label"},"距离"),e.createElementVNode("text",{class:"item-value"},e.toDisplayString((o.walkRecord.distance/1e3).toFixed(2))+"公里",1)]),e.createElementVNode("view",{class:"card-item"},[e.createElementVNode("text",{class:"item-label"},"时长"),e.createElementVNode("text",{class:"item-value"},e.toDisplayString(o.formatDuration(o.walkRecord.duration)),1)]),o.walkRecord.pet?(e.openBlock(),e.createElementBlock("view",{key:0,class:"card-item"},[e.createElementVNode("text",{class:"item-label"},"宠物"),e.createElementVNode("view",{class:"pet-info"},[o.walkRecord.pet.avatar?(e.openBlock(),e.createElementBlock("image",{key:0,class:"pet-avatar",src:o.walkRecord.pet.avatar,mode:"aspectFill"},null,8,["src"])):e.createCommentVNode("",!0),e.createElementVNode("text",{class:"pet-name"},e.toDisplayString(o.walkRecord.pet.name||"未命名宠物"),1)])])):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"share-motivation"},[e.createElementVNode("text",{class:"motivation-text"},"分享遛狗记录可以激励其他铲屎官也加入运动!")])])):e.createCommentVNode("",!0)])])}]]);const Ie=he({components:{WalkRecordCard:Ee,ImageViewer:Ne,UserInfoPopup:fe},data:()=>({postId:"",post:null,comments:[],commentContent:"",isLoading:!0,isSubmitting:!1,shouldScrollToComments:!1,showImageViewer:!1,currentImageIndex:0,showUserPopup:!1,selectedUser:null,selectedUserPets:[],isFollowing:!1}),onLoad(e){if(e&&e.id){if(this.postId=e.id,e.postKey)try{const t=uni.getStorageSync(e.postKey);if(t){const e=JSON.parse(t);if(e)return a("log","at pages/community/post-detail.vue:185","从缓存获取帖子数据:",e),this.post=e,void 0===this.post.isLiked&&(this.post.isLiked=!1),void 0===this.post.likes&&(this.post.likes=0),void 0===this.post.comments&&(this.post.comments=0),this.isLoading=!1,void this.loadComments()}}catch(t){a("error","at pages/community/post-detail.vue:203","解析缓存的帖子数据失败:",t)}"true"===e.showComments&&(this.shouldScrollToComments=!0),this.loadPostDetail(),this.loadComments()}else uni.showToast({title:"未找到帖子",icon:"none"}),setTimeout((()=>{uni.navigateBack()}),1500)},onReady(){this.shouldScrollToComments&&setTimeout((()=>{uni.createSelectorQuery().in(this).select(".comment-divider").boundingClientRect((e=>{e&&uni.pageScrollTo({scrollTop:e.top,duration:300})})).exec()}),500)},methods:{getNumberValue:e=>Array.isArray(e)?e.length:"number"==typeof e?e:e&&"object"==typeof e?Object.keys(e).length:0,formatDuration(e){if(!e)return"0分钟";const t=Math.floor(e/3600),a=Math.floor(e%3600/60);let s="";return t>0?(s+=`${t}小时`,a>0&&(s+=`${a}分钟`)):s+=`${a}分钟`,s},navBack(){uni.navigateBack()},formatDate(e){if(!e)return"";if("string"==typeof e&&!e.includes("T")&&!e.includes("-"))return e;try{const t=new Date(e),a=new Date,s=Math.floor((a-t)/1e3);return s<60?"刚刚":s<3600?Math.floor(s/60)+"分钟前":s<86400?Math.floor(s/3600)+"小时前":s<2592e3?Math.floor(s/86400)+"天前":`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}catch(t){return a("error","at pages/community/post-detail.vue:311","日期格式化错误:",t),e}},previewImage(e){this.currentImageIndex=e,this.showImageViewer=!0},closeImageViewer(){this.showImageViewer=!1},showUserProfile(e){return __async(this,null,(function*(){if(a("log","at pages/community/post-detail.vue:329","显示用户信息:",e),!e||!e._id)return a("error","at pages/community/post-detail.vue:331","无效的用户信息"),void uni.showToast({title:"无法获取用户信息",icon:"none"});const t=X(),s=t.isAuthenticated&&t.userId===e._id;if(this.selectedUser=__spreadProps(__spreadValues({},e),{isCurrentUser:s}),this.isFollowing=!1,t.isAuthenticated&&!s)try{a("log","at pages/community/post-detail.vue:357","直接调用checkFollowStatus检查关注状态，用户ID:",e._id);const t=yield B.user.checkFollowStatus(e._id);t&&void 0!==t.isFollowing&&(this.isFollowing=t.isFollowing,a("log","at pages/community/post-detail.vue:362","API返回的关注状态:",this.isFollowing))}catch(o){a("error","at pages/community/post-detail.vue:365","检查关注状态失败:",o),void 0!==e.isFollowing&&(this.isFollowing=e.isFollowing,a("log","at pages/community/post-detail.vue:370","从用户对象获取关注状态:",this.isFollowing))}if(a("log","at pages/community/post-detail.vue:375","初始关注状态设置为:",this.isFollowing),t.isAuthenticated)try{let t=null;try{a("log","at pages/community/post-detail.vue:384","尝试获取用户详情，ID:",e._id),t=yield B.user.getUserById(e._id),a("log","at pages/community/post-detail.vue:387","获取用户详情成功:",t),t&&void 0!==t.isFollowing&&(this.isFollowing=this.isFollowing||t.isFollowing,a("log","at pages/community/post-detail.vue:393","综合考虑后的关注状态:",this.isFollowing))}catch(r){a("error","at pages/community/post-detail.vue:396","获取用户详情失败, 使用基本信息:",r),t=__spreadProps(__spreadValues({},e),{nickname:e.nickname||e.username||"用户",bio:e.bio||"这位用户还没有个人简介"}),uni.showToast({title:"获取用户详情失败",icon:"none",duration:1500})}if(t){s&&(this.isFollowing=!1),this.selectedUser=__spreadProps(__spreadValues({},t),{isCurrentUser:s,isFollowing:this.isFollowing}),a("log","at pages/community/post-detail.vue:426","更新后的selectedUser和isFollowing:",this.selectedUser,this.isFollowing);try{a("log","at pages/community/post-detail.vue:430","尝试获取用户宠物列表，用户ID:",e._id);const t=yield B.user.getPetsByUser(e._id);a("log","at pages/community/post-detail.vue:432","获取到的宠物列表:",t),this.selectedUserPets=t||[]}catch(n){a("error","at pages/community/post-detail.vue:435","获取宠物列表失败:",n),this.selectedUserPets=[]}}}catch(o){a("error","at pages/community/post-detail.vue:440","获取用户信息处理过程出错:",o),this.selectedUser=__spreadProps(__spreadValues({},e),{isCurrentUser:s,isFollowing:this.isFollowing}),uni.showToast({title:"获取用户详情失败",icon:"none"})}a("log","at pages/community/post-detail.vue:457","最终显示的用户信息和关注状态:",{user:this.selectedUser,isFollowing:this.isFollowing,pets:this.selectedUserPets}),this.showUserPopup=!0}))},closeUserPopup(){this.showUserPopup=!1,this.selectedUser=null,this.selectedUserPets=[]},messageUser(e){a("log","at pages/community/post-detail.vue:476","向用户发送消息:",e)},followUser(e){return __async(this,null,(function*(){const t=X();if(t.isAuthenticated)if(e&&e._id)try{const a=yield B.user.followUser(e._id);a&&void 0!==a.isFollowing&&(this.isFollowing=a.isFollowing,this.selectedUser&&(this.selectedUser.isFollowing=this.isFollowing),uni.showToast({title:this.isFollowing?"关注成功":"取消关注成功",icon:"success"}),yield t.fetchUserStats())}catch(s){a("error","at pages/community/post-detail.vue:516","关注用户操作失败:",s),uni.showToast({title:"操作失败，请重试",icon:"none"})}else a("error","at pages/community/post-detail.vue:491","无效的用户信息");else uni.navigateTo({url:"/pages/login/login"})}))},formatAvatarUrl(e){if(!e)return"/static/images/default-avatar.png";if(e.startsWith("http")||e.startsWith("/static"))return e;if(e.startsWith("/uploads")){const t=uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000";return a("log","at pages/community/post-detail.vue:537","处理相对路径头像URL:",e,"补充基础URL:",t),t+e}return"object"==typeof e&&e.avatar?this.formatAvatarUrl(e.avatar):(a("warn","at pages/community/post-detail.vue:547","未能识别的头像URL格式:",e),"/static/images/default-avatar.png")},formatImageUrl(e){if(!e)return"/static/images/default-pet.png";if(a("log","at pages/community/post-detail.vue:555","帖子详情页处理图片URL:",e),e.startsWith("http")||e.startsWith("/static")||e.startsWith("blob:"))return a("log","at pages/community/post-detail.vue:559","返回原始URL:",e),e;if(e.startsWith("/uploads")){const t=uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000",s=t+e;return a("log","at pages/community/post-detail.vue:567","处理相对路径图片URL:",e,"补充基础URL:",t,"完整URL:",s),s}return a("warn","at pages/community/post-detail.vue:572","未能识别的图片URL格式:",e),"/static/images/default-pet.png"},loadPostDetail(){return __async(this,null,(function*(){this.isLoading=!0;try{const t=uni.$api.community;if(!t)throw new Error("社区API未初始化");try{a("log","at pages/community/post-detail.vue:591","尝试加载帖子详情, ID:",this.postId);const e=yield t.getPostDetail(this.postId);if(!e)throw new Error("获取帖子详情失败：空响应");a("log","at pages/community/post-detail.vue:595","获取到帖子详情:",e),void 0===e.isLiked&&(e.isLiked=!1),void 0===e.likes&&(e.likes=0),void 0===e.comments&&(e.comments=0),this.post=this.parseWalkRecordFromContent(e),a("log","at pages/community/post-detail.vue:608","处理后的帖子详情:",this.post)}catch(e){a("error","at pages/community/post-detail.vue:613","获取帖子详情失败:",e),uni.showToast({title:"加载失败，请稍后再试",icon:"none",duration:2e3}),setTimeout((()=>{uni.navigateBack()}),2e3)}}catch(e){a("error","at pages/community/post-detail.vue:627","加载帖子详情过程中发生错误:",e),uni.showToast({title:"加载失败，请稍后再试",icon:"none",duration:2e3}),setTimeout((()=>{uni.navigateBack()}),2e3)}finally{this.isLoading=!1}}))},parseWalkRecordFromContent(e){if(e.walkRecord)return e;const t=e.content||"";let a=null;const s=t.match(/遛了\s*(\d+\.?\d*)\s*公里/),o=s?1e3*parseFloat(s[1]):null,r=t.match(/用时\s*(\d+)\s*(秒|分钟|小时)/);let n=null;if(r){const e=parseInt(r[1]),t=r[2];"秒"===t?n=e:"分钟"===t?n=60*e:"小时"===t&&(n=3600*e)}const i=t.match(/和\s*([^\s,，。！]+)\s*一起遛/),l=i?i[1]:"我的宠物";return null!==o||null!==n?(a={_id:`generated_${e._id||e.id||Date.now()}`,distance:o||0,duration:n||0,pet:{name:l},startTime:e.createdAt||e.time||(new Date).toISOString()},__spreadProps(__spreadValues({},e),{walkRecord:a})):e},loadComments(){return __async(this,null,(function*(){try{if(!uni.$api||!uni.$api.community)return a("error","at pages/community/post-detail.vue:709","社区API未初始化"),void(this.comments=[]);uni.showLoading({title:"加载评论..."});try{a("log","at pages/community/post-detail.vue:721","尝试加载评论, 帖子ID:",this.postId);const e=yield uni.$api.community.getComments(this.postId,{limit:50});if(e&&(e.data||Array.isArray(e))){const t=Array.isArray(e)?e:Array.isArray(e.data)?e.data:[];a("log","at pages/community/post-detail.vue:731","评论列表:",t),this.comments=t}else a("log","at pages/community/post-detail.vue:735","没有找到评论或返回为空"),this.comments=[]}catch(e){a("error","at pages/community/post-detail.vue:739","获取评论失败:",e),this.comments=[]}finally{uni.hideLoading()}}catch(e){a("error","at pages/community/post-detail.vue:746","加载评论过程中发生错误:",e),uni.hideLoading(),this.comments=[]}}))},likePost(){return __async(this,null,(function*(){if(this.post)try{this.post.isLiked=!this.post.isLiked,this.post.likes=this.post.isLiked?(this.post.likes||0)+1:Math.max((this.post.likes||1)-1,0);const e=uni.$api.community;if(!e)throw new Error("社区API未初始化");return yield e.likePost(this.postId,this.post.isLiked),void uni.showToast({title:this.post.isLiked?"点赞成功":"已取消点赞",icon:"none"})}catch(e){return a("error","at pages/community/post-detail.vue:780","点赞操作失败:",e),this.post.isLiked=!this.post.isLiked,this.post.likes=this.post.isLiked?(this.post.likes||0)+1:Math.max((this.post.likes||1)-1,0),void uni.showToast({title:"操作失败",icon:"none"})}}))},submitComment(){return __async(this,null,(function*(){if(this.commentContent.trim()&&!this.isSubmitting){this.isSubmitting=!0;try{if(!uni.$api||!uni.$api.community)throw new Error("社区API未初始化");yield uni.$api.community.addComment(this.postId,{content:this.commentContent}),this.commentContent="",this.loadComments(),this.post&&(this.post.comments=(this.post.comments||0)+1),uni.showToast({title:"评论成功",icon:"success"})}catch(e){a("error","at pages/community/post-detail.vue:829","提交评论失败:",e),uni.showToast({title:"评论失败，请稍后再试",icon:"none"})}finally{this.isSubmitting=!1}}}))},viewWalkRecord(){if(!this.post||!this.post.walkRecord||!this.post.walkRecord._id)return void uni.showToast({title:"遛狗记录不存在",icon:"none"});a("log","at pages/community/post-detail.vue:850","查看遛狗记录详情:",this.post.walkRecord);this.post.walkRecord._id.startsWith("generated_")?uni.showToast({title:"这是从动态内容解析的遛狗记录，无法查看详情",icon:"none",duration:2500}):uni.navigateTo({url:`/pages/walk/detail?id=${this.post.walkRecord._id}`,fail:e=>{a("error","at pages/community/post-detail.vue:868","打开遛狗记录详情失败:",e),uni.showToast({title:"无法查看遛狗记录",icon:"none"})}})}}},[["render",function(t,a,s,o,r,n){var i,l,c;const u=e.resolveComponent("walk-record-card"),d=e.resolveComponent("image-viewer"),m=e.resolveComponent("UserInfoPopup");return e.openBlock(),e.createElementBlock("view",{class:"post-detail-container"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("view",{class:"back-btn",onClick:a[0]||(a[0]=(...e)=>n.navBack&&n.navBack(...e))},[e.createElementVNode("text",null,"返回")]),e.createElementVNode("text",{class:"title"},"帖子详情"),e.createElementVNode("view",{class:"placeholder"})]),e.createElementVNode("scroll-view",{class:"post-content-scrollview","scroll-y":""},[r.isLoading?(e.openBlock(),e.createElementBlock("view",{key:0,class:"loading"},[e.createElementVNode("text",null,"加载中...")])):e.createCommentVNode("",!0),r.isLoading||r.post?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("view",{key:1,class:"not-found"},[e.createElementVNode("text",null,"该帖子不存在或已被删除")])),r.post?(e.openBlock(),e.createElementBlock("view",{key:2,class:"post-detail"},[e.createElementVNode("view",{class:"post-header"},[e.createElementVNode("view",{class:"user-info"},[e.createElementVNode("image",{class:"user-avatar",src:n.formatAvatarUrl((null==(i=r.post.user)?void 0:i.avatar)||r.post.userAvatar),mode:"aspectFill",onClick:a[1]||(a[1]=e=>n.showUserProfile(r.post.user||{_id:r.post.userId,username:r.post.username,avatar:r.post.userAvatar}))},null,8,["src"]),e.createElementVNode("text",{class:"username"},e.toDisplayString(r.post.username||(null==(l=r.post.user)?void 0:l.username)||"用户"),1)]),e.createElementVNode("text",{class:"post-time"},e.toDisplayString(n.formatDate(r.post.time||r.post.createdAt)),1)]),e.createElementVNode("view",{class:"post-content"},[e.createElementVNode("text",{class:"post-text"},e.toDisplayString(r.post.content),1),r.post.walkRecord?(e.openBlock(),e.createBlock(u,{key:0,record:r.post.walkRecord},null,8,["record"])):e.createCommentVNode("",!0),r.post.images&&r.post.images.length>0?(e.openBlock(),e.createElementBlock("view",{key:1,class:"post-images"},[e.createElementVNode("view",{class:"image-container"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(r.post.images,((t,a)=>(e.openBlock(),e.createElementBlock("image",{key:a,src:n.formatImageUrl(t),mode:"aspectFill",class:"post-image",onClick:e=>n.previewImage(a)},null,8,["src","onClick"])))),128))])])):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"post-actions"},[e.createElementVNode("view",{class:"action-item",onClick:a[2]||(a[2]=(...e)=>n.likePost&&n.likePost(...e))},[e.createElementVNode("view",{class:e.normalizeClass(["action-icon like-icon",{active:r.post.isLiked}]),style:{"background-image":"url('/static/images/like-icon.png')","background-size":"contain","background-repeat":"no-repeat"}},null,2),e.createElementVNode("text",{class:"action-text"},[e.createTextVNode("点赞 "),e.createElementVNode("text",{class:"count"},e.toDisplayString(n.getNumberValue(r.post.likes)),1)])]),e.createElementVNode("view",{class:"action-item"},[e.createElementVNode("view",{class:"action-icon comment-icon",style:{"background-image":"url('/static/images/comment-icon.png')","background-size":"contain","background-repeat":"no-repeat"}}),e.createElementVNode("text",{class:"action-text"},[e.createTextVNode("评论 "),e.createElementVNode("text",{class:"count"},e.toDisplayString(n.getNumberValue(r.post.comments)),1)])])]),e.createElementVNode("view",{class:"comment-divider"},[e.createElementVNode("text",null,"评论区")]),e.createElementVNode("view",{class:"comment-list"},[r.comments&&0!==r.comments.length?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("view",{key:0,class:"no-comments"},[e.createElementVNode("text",null,"暂无评论，快来发表第一条评论吧")])),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(r.comments,((t,a)=>{var s,o;return e.openBlock(),e.createElementBlock("view",{class:"comment-item",key:t.id||a},[e.createElementVNode("view",{class:"comment-header"},[e.createElementVNode("view",{class:"comment-user-info"},[e.createElementVNode("image",{class:"comment-avatar",src:n.formatAvatarUrl((null==(s=t.user)?void 0:s.avatar)||t.userAvatar),mode:"aspectFill",onClick:e=>n.showUserProfile(t.user||{_id:t.userId,username:t.username,avatar:t.userAvatar})},null,8,["src","onClick"]),e.createElementVNode("text",{class:"comment-username"},e.toDisplayString(t.username||(null==(o=t.user)?void 0:o.username)||"用户"),1)]),e.createElementVNode("text",{class:"comment-time"},e.toDisplayString(n.formatDate(t.time||t.createdAt)),1)]),e.createElementVNode("view",{class:"comment-content"},[e.createElementVNode("text",null,e.toDisplayString(t.content),1)])])})),128))])])):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"comment-input-area"},[e.withDirectives(e.createElementVNode("input",{class:"comment-input","onUpdate:modelValue":a[3]||(a[3]=e=>r.commentContent=e),placeholder:"写评论...","confirm-type":"send",onConfirm:a[4]||(a[4]=(...e)=>n.submitComment&&n.submitComment(...e))},null,544),[[e.vModelText,r.commentContent]]),e.createElementVNode("view",{class:e.normalizeClass(["send-btn",{active:r.commentContent.trim()}]),onClick:a[5]||(a[5]=(...e)=>n.submitComment&&n.submitComment(...e))},[e.createElementVNode("text",null,"发送")],2)]),e.createVNode(d,{show:r.showImageViewer,images:(null==(c=r.post)?void 0:c.images)||[],initialIndex:r.currentImageIndex,onClose:n.closeImageViewer},null,8,["show","images","initialIndex","onClose"]),r.showUserPopup?(e.openBlock(),e.createBlock(m,{key:0,user:r.selectedUser,pets:r.selectedUserPets,"is-following":r.isFollowing,visible:r.showUserPopup,onClose:n.closeUserPopup,onMessage:n.messageUser,onFollow:n.followUser},null,8,["user","pets","is-following","visible","onClose","onMessage","onFollow"])):e.createCommentVNode("",!0)])}]]),xe=K("pet",{state:()=>({pets:[],currentPet:null,loading:!1,error:null}),getters:{getPets:e=>e.pets,getCurrentPet:e=>e.currentPet},actions:{fetchPets(){return __async(this,null,(function*(){this.loading=!0,this.error=null;try{const e=yield D.getMyPets();return a("log","at store/petStore.js:24","获取宠物列表响应:",e),this.setPets(e),e}catch(e){return a("error","at store/petStore.js:28","获取宠物列表失败:",e),this.error=e.message||"获取宠物列表失败",uni.showToast({title:"获取宠物列表失败",icon:"none"}),[]}finally{this.loading=!1}}))},setPets(e){this.pets=e,uni.setStorageSync("pets",JSON.stringify(e)),!this.currentPet&&e.length>0&&this.setCurrentPet(e[0])},addPet(e){return __async(this,null,(function*(){this.loading=!0,this.error=null;try{const t=yield D.addPet(e);return a("log","at store/petStore.js:57","添加宠物响应:",t),this.pets.push(t),uni.setStorageSync("pets",JSON.stringify(this.pets)),1===this.pets.length&&this.setCurrentPet(t),t}catch(t){throw a("error","at store/petStore.js:67","添加宠物失败:",t),this.error=t.message||"添加宠物失败",t}finally{this.loading=!1}}))},updatePet(e,t){return __async(this,null,(function*(){this.loading=!0,this.error=null;try{const s=yield D.updatePet(e,t);a("log","at store/petStore.js:81","更新宠物响应:",s);const o=this.pets.findIndex((t=>t._id===e));return-1!==o&&(this.pets[o]=s,uni.setStorageSync("pets",JSON.stringify(this.pets)),this.currentPet&&this.currentPet._id===e&&(this.currentPet=s,uni.setStorageSync("currentPet",JSON.stringify(s)))),s}catch(s){throw a("error","at store/petStore.js:95","更新宠物信息失败:",s),this.error=s.message||"更新宠物信息失败",s}finally{this.loading=!1}}))},deletePet(e){return __async(this,null,(function*(){this.loading=!0,this.error=null;try{return yield D.deletePet(e),this.pets=this.pets.filter((t=>t._id!==e)),uni.setStorageSync("pets",JSON.stringify(this.pets)),this.currentPet&&this.currentPet._id===e&&(this.currentPet=this.pets.length>0?this.pets[0]:null,uni.setStorageSync("currentPet",this.currentPet?JSON.stringify(this.currentPet):"")),!0}catch(t){throw a("error","at store/petStore.js:119","删除宠物失败:",t),this.error=t.message||"删除宠物失败",t}finally{this.loading=!1}}))},setCurrentPet(e){this.currentPet=e,uni.setStorageSync("currentPet",JSON.stringify(e))},restorePetState(){try{const e=uni.getStorageSync("pets"),t=uni.getStorageSync("currentPet");e&&(this.pets=JSON.parse(e)),t?this.currentPet=JSON.parse(t):this.pets.length>0&&(this.currentPet=this.pets[0])}catch(e){a("error","at store/petStore.js:149","恢复宠物状态失败:",e)}}}}),be=K("user",{state:()=>({token:uni.getStorageSync("token")||null,userInfo:JSON.parse(uni.getStorageSync("userInfo")||"null"),loading:!1,userStats:null,followingUsers:[],followerUsers:[],error:null}),getters:{isLoggedIn:e=>!!e.token&&!!e.userInfo,userId:e=>{var t;return(null==(t=e.userInfo)?void 0:t._id)||null},username:e=>{var t;return(null==(t=e.userInfo)?void 0:t.username)||""},nickname:e=>{var t,a;return(null==(t=e.userInfo)?void 0:t.nickname)||(null==(a=e.userInfo)?void 0:a.username)||""},avatar:e=>{var t;return(null==(t=e.userInfo)?void 0:t.avatar)||"/static/images/default-avatar.png"}},actions:{register(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null;const t=yield T.register(e);if(!t||!t.token)throw new Error("注册失败：响应中没有包含token");return this.token=t.token,this.userInfo={_id:t._id,username:t.username,email:t.email,nickname:t.nickname,avatar:t.avatar},uni.setStorageSync("token",this.token),uni.setStorageSync("userInfo",JSON.stringify(this.userInfo)),this.userInfo}catch(t){throw this.error=t.message||"注册失败",a("error","at store/userStore.js:53","注册失败:",t),t}finally{this.loading=!1}}))},login(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null;const t=yield T.login(e);if(a("log","at store/userStore.js:69","登录响应:",t),!t||!t.token)throw new Error("登录失败：响应中没有包含token");return this.token=t.token,this.userInfo={_id:t._id,username:t.username,email:t.email,nickname:t.nickname,avatar:t.avatar},uni.setStorageSync("token",this.token),uni.setStorageSync("userInfo",JSON.stringify(this.userInfo)),this.userInfo}catch(t){throw this.error=t.message||"登录失败",a("error","at store/userStore.js:93","登录失败:",t),t}finally{this.loading=!1}}))},getUserInfo(){return __async(this,null,(function*(){if(this.userInfo)return this.userInfo;try{this.loading=!0,this.error=null;const e=yield M.getCurrentUser();if(!e)throw new Error("获取用户信息失败：无效的响应");return this.userInfo=e,uni.setStorageSync("userInfo",JSON.stringify(this.userInfo)),this.userInfo}catch(e){throw this.error=e.message||"获取用户信息失败",a("error","at store/userStore.js:126","获取用户信息失败:",e),e}finally{this.loading=!1}}))},logout(){this.token=null,this.userInfo=null,this.userStats=null,uni.removeStorageSync("token"),uni.removeStorageSync("userInfo"),uni.reLaunch({url:"/pages/login/login"})},fetchUserStats(){return __async(this,null,(function*(){if(!this.isLoggedIn)return null;try{this.loading=!0;const e=yield M.getUserStats();return this.userStats=e,e}catch(e){return a("error","at store/userStore.js:160","获取用户统计信息失败:",e),null}finally{this.loading=!1}}))},fetchFollowing(){return __async(this,null,(function*(){if(!this.isLoggedIn)return[];try{this.loading=!0;const e=yield M.getFollowing();return this.followingUsers=e,e}catch(e){return a("error","at store/userStore.js:177","获取关注列表失败:",e),[]}finally{this.loading=!1}}))},fetchFollowers(){return __async(this,null,(function*(){if(!this.isLoggedIn)return[];try{this.loading=!0;const e=yield M.getFollowers();return this.followerUsers=e,e}catch(e){return a("error","at store/userStore.js:194","获取粉丝列表失败:",e),[]}finally{this.loading=!1}}))},uploadAvatar(e){return __async(this,null,(function*(){try{this.loading=!0;const t=yield M.uploadAvatar(e);return this.userInfo&&(this.userInfo.avatar=t.avatar,uni.setStorageSync("userInfo",JSON.stringify(this.userInfo))),t}catch(t){throw a("error","at store/userStore.js:215","上传头像失败:",t),t}finally{this.loading=!1}}))}}});const Ce=he({setup(){const t=xe(),s=be(),o=e.ref([]),r=()=>__async(this,null,(function*(){try{yield t.fetchPets(),o.value=t.pets.map((e=>{var a;return __spreadProps(__spreadValues({},e),{isDefault:e._id===(null==(a=t.currentPet)?void 0:a._id)})}))}catch(e){a("error","at pages/pet/management.vue:62","Failed to load pets:",e),uni.showToast({title:"加载宠物信息失败",icon:"none"})}}));return e.onMounted((()=>{s.isLoggedIn?r():uni.redirectTo({url:"/pages/login/login"})})),{pets:o,navToAdd:()=>{if(a("log","at pages/pet/management.vue:72","开始导航到添加宠物页面"),!s.isAuthenticated)return a("error","at pages/pet/management.vue:76","用户未登录，无法添加宠物"),uni.showToast({title:"请先登录",icon:"none"}),void setTimeout((()=>{uni.navigateTo({url:"/pages/login/login"})}),1500);uni.navigateTo({url:"/pages/pet/edit?mode=add",success:e=>{a("log","at pages/pet/management.vue:94","导航到添加宠物页面成功",e)},fail:e=>{a("error","at pages/pet/management.vue:97","导航到添加宠物页面失败:",e),uni.navigateTo({url:"/pages/pet/edit",success:()=>{a("log","at pages/pet/management.vue:102","使用简化路径导航成功")},fail:e=>{a("error","at pages/pet/management.vue:105","使用简化路径仍然失败:",e),uni.showToast({title:"页面跳转失败",icon:"none"})}})}})},navToDetail:e=>{uni.navigateTo({url:`/pages/pet/edit?petId=${e}&mode=edit`})},navToEdit:e=>{a("log","at pages/pet/management.vue:125","Navigating to edit pet with ID:",e),uni.navigateTo({url:`/pages/pet/edit?petId=${e}&mode=edit`,success:()=>{a("log","at pages/pet/management.vue:129","Navigation successful")},fail:e=>{a("error","at pages/pet/management.vue:132","Navigation failed:",e)}})},deletePet:e=>__async(this,null,(function*(){try{uni.showLoading({title:"删除中..."});const a=yield B.pet.deletePet(e._id||e.id);if(uni.hideLoading(),!a||!a.success)throw new Error(a.message||"删除失败");t.deletePet(e._id),uni.showToast({title:"删除成功",icon:"success"})}catch(s){uni.hideLoading(),a("error","at pages/pet/management.vue:152","Failed to delete pet:",s),uni.showToast({title:s.message||"删除失败",icon:"none"})}})),setDefault:(e,s=!1)=>__async(this,null,(function*(){try{uni.showLoading({title:"设置中..."});const a=yield B.pet.updatePet(e._id,{isDefault:!0});if(uni.hideLoading(),!a||!a.success)throw new Error(a.message||"设置失败");o.value=o.value.map((t=>__spreadProps(__spreadValues({},t),{isDefault:t._id===e._id}))),t.setCurrentPet(e),s||uni.showToast({title:`已将"${e.name}"设为默认宠物`,icon:"success"})}catch(r){uni.hideLoading(),a("error","at pages/pet/management.vue:185","Failed to set default pet:",r),s||uni.showToast({title:r.message||"设置失败，请重试",icon:"none"})}})),calculatePetAge:e=>{if(!e)return"未知年龄";const t=new Date(e),a=new Date,s=12*(a.getFullYear()-t.getFullYear())+(a.getMonth()-t.getMonth());if(s<12)return`${s}个月`;{const e=Math.floor(s/12),t=s%12;return t>0?`${e}岁${t}个月`:`${e}岁`}},formatImageUrl:e=>{if(!e)return"/static/images/default-pet.png";if(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("/static/"))return e;if(e.startsWith("/uploads")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}if(e.startsWith("uploads/")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+"/"+e}return"/static/images/default-pet.png"}}}},[["render",function(t,a,s,o,r,n){return e.openBlock(),e.createElementBlock("view",{class:"management-container"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("text",{class:"title"},"宠物管理"),e.createElementVNode("view",{class:"add-btn",onClick:a[0]||(a[0]=(...e)=>o.navToAdd&&o.navToAdd(...e))},[e.createElementVNode("text",{class:"add-icon"},"+"),e.createElementVNode("text",{class:"add-text"},"添加宠物")])]),0===o.pets.length?(e.openBlock(),e.createElementBlock("view",{key:0,class:"empty-pets"},[e.createElementVNode("image",{class:"empty-image",src:"/static/images/empty-pets.png",mode:"aspectFit"}),e.createElementVNode("text",{class:"empty-text"},"您还没有添加宠物"),e.createElementVNode("button",{class:"add-pet-btn",onClick:a[1]||(a[1]=(...e)=>o.navToAdd&&o.navToAdd(...e))},"添加宠物")])):(e.openBlock(),e.createElementBlock("view",{key:1,class:"pet-list"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.pets,(t=>(e.openBlock(),e.createElementBlock("view",{class:"pet-item",key:t._id,onClick:e=>o.navToEdit(t._id||t.id)},[e.createElementVNode("view",{class:"pet-content"},[e.createElementVNode("image",{class:"pet-avatar",src:o.formatImageUrl(t.avatar),mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"pet-info"},[e.createElementVNode("view",{class:"pet-name-row"},[e.createElementVNode("text",{class:"pet-name"},e.toDisplayString(t.name),1),e.createElementVNode("text",{class:e.normalizeClass(["pet-gender",t.gender])},e.toDisplayString("male"===t.gender?"♂":"♀"),3)]),e.createElementVNode("text",{class:"pet-breed"},e.toDisplayString(t.breed),1),e.createElementVNode("text",{class:"pet-age"},e.toDisplayString(o.calculatePetAge(t.birthdate)),1)]),t.isDefault?(e.openBlock(),e.createElementBlock("view",{key:0,class:"default-tag"},"默认")):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"edit-indicator"},[e.createElementVNode("text",{class:"edit-text"},"编辑"),e.createElementVNode("text",{class:"edit-arrow"},">")])])],8,["onClick"])))),128))]))])}],["__scopeId","data-v-9b6d49df"]]),Te={__name:"edit",props:{petId:{type:String,default:""},mode:{type:String,default:"add"}},setup(t){const s=Y(),o=e.ref(!1),r=t,n=e.ref({name:"",breed:"",gender:"male",age:"",weight:"",description:"",avatar:"",socialIntention:"medium",matingStatus:"notLooking",dailyPhotos:[]}),i=e.ref(""),l=e.ref("add"),c=e.computed((()=>n.value.name&&n.value.breed));function g(){uni.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:e=>__async(this,null,(function*(){uni.showLoading({title:"处理图片中..."});try{if(n.value.avatar=e.tempFilePaths[0],"edit"===r.mode&&i.value){a("log","at pages/pet/edit.vue:325","上传宠物头像:",i.value,e.tempFilePaths[0]);try{const t=yield s.uploadPetAvatar(i.value,e.tempFilePaths[0]);if(a("log","at pages/pet/edit.vue:330","头像上传结果:",t),!(t&&t.success&&t.data&&t.data.pet))throw new Error("头像上传响应格式不正确");{const e=t.data.pet.avatar;if(!e)throw new Error("返回的头像URL为空");n.value.avatar=k(e),uni.showToast({title:"头像上传成功",icon:"success"})}}catch(t){a("error","at pages/pet/edit.vue:348","头像上传处理失败:",t),uni.showToast({title:"头像上传失败，将在保存时再次尝试",icon:"none"})}}}catch(o){a("error","at pages/pet/edit.vue:358","头像上传失败:",o),uni.showToast({title:"头像上传失败",icon:"none"})}finally{uni.hideLoading()}})),fail:e=>{a("error","at pages/pet/edit.vue:368","选择图片失败:",e),uni.showToast({title:"选择图片失败",icon:"none"})}})}function h(){n.value.dailyPhotos.length>=3?u({title:"最多只能上传3张照片",icon:"none"}):uni.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:e=>{uni.showLoading({title:"处理图片中..."});try{const t={url:e.tempFilePaths[0],uploadDate:new Date,description:""};n.value.dailyPhotos.push(t),uni.hideLoading(),u({title:"已添加照片",icon:"success"}),a("log","at pages/pet/edit.vue:417","已添加临时照片:",t)}catch(t){a("error","at pages/pet/edit.vue:419","添加照片失败:",t),uni.hideLoading(),u({title:"添加照片失败",icon:"none"})}}})}function f(e){a("error","at pages/pet/edit.vue:443","照片加载失败:",e.target),e.target.src="/static/images/default-pet.png"}function y(){return __async(this,null,(function*(){if(c.value){o.value=!0,d("保存中...");try{const o={name:n.value.name,breed:n.value.breed,gender:n.value.gender,age:n.value.age?parseInt(n.value.age):null,weight:n.value.weight?parseFloat(n.value.weight):null,description:n.value.description,socialIntention:n.value.socialIntention,matingStatus:n.value.matingStatus},r=n.value.avatar;let c,d=r&&r.startsWith("blob:"),m=[];if(n.value.dailyPhotos&&n.value.dailyPhotos.length>0){m=n.value.dailyPhotos.filter((e=>e.url&&(e.url.startsWith("blob:")||e.url.startsWith("file:"))));const e=n.value.dailyPhotos.filter((e=>e.url&&!e.url.startsWith("blob:")&&!e.url.startsWith("file:")));o.dailyPhotos=e}if("edit"===l.value&&i.value){if(a("log","at pages/pet/edit.vue:494","更新宠物信息:",i.value,o),c=yield s.updatePet(i.value,o),d){a("log","at pages/pet/edit.vue:499","更新模式: 单独上传头像",r);try{yield s.uploadPetAvatar(i.value,r)}catch(e){a("error","at pages/pet/edit.vue:503","头像上传失败:",e)}}if(m.length>0)try{for(const e of m){const t=yield s.uploadPetDailyPhoto(i.value,e.url);a("log","at pages/pet/edit.vue:512","日常照片上传结果:",t),t&&t.data&&t.data.photo&&t.data.photo.url&&a("log","at pages/pet/edit.vue:516","服务器返回的照片URL:",t.data.photo.url)}}catch(t){a("error","at pages/pet/edit.vue:520","日常照片上传失败:",t)}u({title:"宠物信息已更新",icon:"success"})}else{if(a("log","at pages/pet/edit.vue:530","添加新宠物:",o),c=yield s.addPet(o),!c||!c._id)throw new Error("添加宠物失败，未返回宠物ID");{const o=c._id;if(d){a("log","at pages/pet/edit.vue:538","添加模式: 上传头像",r);try{yield s.uploadPetAvatar(o,r)}catch(e){a("error","at pages/pet/edit.vue:542","头像上传失败:",e)}}if(m.length>0)try{for(const e of m){const t=yield s.uploadPetDailyPhoto(o,e.url);a("log","at pages/pet/edit.vue:551","新增模式 - 日常照片上传结果:",t),t&&t.data&&t.data.photo&&t.data.photo.url&&a("log","at pages/pet/edit.vue:555","服务器返回的照片URL:",t.data.photo.url)}}catch(t){a("error","at pages/pet/edit.vue:559","日常照片上传失败:",t)}u({title:"宠物添加成功",icon:"success"})}}yield s.fetchPets(),setTimeout((()=>{v()}),1500)}catch(r){a("error","at pages/pet/edit.vue:580","保存宠物信息失败:",r),u({title:"保存失败: "+(r.message||"未知错误"),icon:"none"})}finally{o.value=!1,m()}}else u("请填写必填项")}))}function w(){return __async(this,null,(function*(){i.value?p({title:"删除宠物",content:"确定要删除这只宠物吗？此操作不可逆。",showCancel:!0}).then((e=>__async(this,null,(function*(){if(e){o.value=!0,d("删除中...");try{a("log","at pages/pet/edit.vue:608","删除宠物:",i.value),yield s.deletePet(i.value),u({title:"宠物已删除",icon:"success"}),setTimeout((()=>{v()}),1500)}catch(t){a("error","at pages/pet/edit.vue:621","删除宠物失败:",t),u({title:t.message||"删除失败，请重试",icon:"none"})}finally{o.value=!1,m()}}})))):u("无效的宠物ID")}))}function k(e){if(!e)return"/static/images/default-pet.png";if(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("/static/")||e.startsWith("file://"))return e;if(e.startsWith("/uploads")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}if(e.startsWith("uploads/")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+"/"+e}return"/static/images/default-pet.png"}return e.onMounted((()=>__async(this,null,(function*(){a("log","at pages/pet/edit.vue:212","组件加载，参数:",r);const e=getCurrentPages(),t=e[e.length-1].options||{};a("log","at pages/pet/edit.vue:219","页面参数:",t);const c=r.petId||t.petId||t.id;l.value=r.mode||t.mode||"add","add"!==l.value&&"edit"!==l.value&&(a("warn","at pages/pet/edit.vue:229","无效的模式参数:",l.value,'重置为默认值"add"'),l.value="add"),a("log","at pages/pet/edit.vue:233","解析参数:",{petId:c,mode:l.value}),i.value=c,document.title="add"===l.value?"添加宠物":"编辑宠物","edit"===l.value&&c?yield function(e){return __async(this,null,(function*(){if(e){o.value=!0,d("加载宠物信息...");try{a("log","at pages/pet/edit.vue:268","获取宠物数据:",e);const t=yield s.getPetById(e);t?(a("log","at pages/pet/edit.vue:272","获取到宠物数据:",t),n.value={name:t.name||"",breed:t.breed||"",gender:t.gender||"male",age:t.age||"",weight:t.weight||"",description:t.description||"",avatar:k(t.avatar)||"/static/images/default-pet.png",socialIntention:t.socialIntention||"medium",matingStatus:t.matingStatus||"notLooking",dailyPhotos:Array.isArray(t.dailyPhotos)?t.dailyPhotos.map((e=>__spreadProps(__spreadValues({},e),{url:k(e.url)}))):[]}):(a("error","at pages/pet/edit.vue:289","未找到宠物:",e),u({title:"未找到宠物信息",icon:"none"}))}catch(t){a("error","at pages/pet/edit.vue:296","获取宠物信息失败:",t),u({title:"获取宠物信息失败",icon:"none"})}finally{o.value=!1,m()}}}))}(c):(a("log","at pages/pet/edit.vue:243","添加模式，使用默认表单数据"),n.value={name:"",breed:"",gender:"male",age:"",weight:"",description:"",avatar:"/static/images/default-pet.png",socialIntention:"medium",matingStatus:"notLooking",dailyPhotos:[]})})))),(t,a)=>(e.openBlock(),e.createElementBlock("view",{class:"pet-edit-container"},[e.createElementVNode("view",{class:"form-header"},[e.createElementVNode("text",{class:"form-title"},e.toDisplayString("add"===l.value?"添加宠物":"编辑宠物"),1)]),e.createElementVNode("view",{class:"pet-form"},[e.createElementVNode("view",{class:"avatar-section"},[e.createElementVNode("image",{class:"pet-avatar",src:n.value.avatar||"/static/images/default-pet.png",mode:"aspectFill",onClick:g},null,8,["src"]),e.createElementVNode("text",{class:"avatar-tip"},"点击更换头像")]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"宠物名称"),e.withDirectives(e.createElementVNode("input",{class:"form-input","onUpdate:modelValue":a[0]||(a[0]=e=>n.value.name=e),placeholder:"请输入宠物名称"},null,512),[[e.vModelText,n.value.name]])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"品种"),e.withDirectives(e.createElementVNode("input",{class:"form-input","onUpdate:modelValue":a[1]||(a[1]=e=>n.value.breed=e),placeholder:"请输入宠物品种"},null,512),[[e.vModelText,n.value.breed]])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"性别"),e.createElementVNode("view",{class:"gender-selector"},[e.createElementVNode("view",{class:e.normalizeClass(["gender-option",{active:"male"===n.value.gender}]),onClick:a[2]||(a[2]=e=>n.value.gender="male")},[e.createElementVNode("text",null,"公")],2),e.createElementVNode("view",{class:e.normalizeClass(["gender-option",{active:"female"===n.value.gender}]),onClick:a[3]||(a[3]=e=>n.value.gender="female")},[e.createElementVNode("text",null,"母")],2)])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"年龄"),e.withDirectives(e.createElementVNode("input",{class:"form-input","onUpdate:modelValue":a[4]||(a[4]=e=>n.value.age=e),type:"number",placeholder:"请输入宠物年龄"},null,512),[[e.vModelText,n.value.age]])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"体重 (kg)"),e.withDirectives(e.createElementVNode("input",{class:"form-input","onUpdate:modelValue":a[5]||(a[5]=e=>n.value.weight=e),type:"digit",placeholder:"请输入宠物体重"},null,512),[[e.vModelText,n.value.weight]])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"社交意向"),e.createElementVNode("view",{class:"selector-row"},[e.createElementVNode("view",{class:e.normalizeClass(["selector-option",{active:"strong"===n.value.socialIntention}]),onClick:a[6]||(a[6]=e=>n.value.socialIntention="strong")},[e.createElementVNode("text",null,"强烈")],2),e.createElementVNode("view",{class:e.normalizeClass(["selector-option",{active:"medium"===n.value.socialIntention}]),onClick:a[7]||(a[7]=e=>n.value.socialIntention="medium")},[e.createElementVNode("text",null,"较强")],2),e.createElementVNode("view",{class:e.normalizeClass(["selector-option",{active:"mild"===n.value.socialIntention}]),onClick:a[8]||(a[8]=e=>n.value.socialIntention="mild")},[e.createElementVNode("text",null,"平淡")],2)])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"求偶状态"),e.createElementVNode("view",{class:"selector-row"},[e.createElementVNode("view",{class:e.normalizeClass(["selector-option",{active:"single"===n.value.matingStatus}]),onClick:a[9]||(a[9]=e=>n.value.matingStatus="single")},[e.createElementVNode("text",null,"单身待求偶")],2),e.createElementVNode("view",{class:e.normalizeClass(["selector-option",{active:"paired"===n.value.matingStatus}]),onClick:a[10]||(a[10]=e=>n.value.matingStatus="paired")},[e.createElementVNode("text",null,"有配偶")],2),e.createElementVNode("view",{class:e.normalizeClass(["selector-option",{active:"notLooking"===n.value.matingStatus}]),onClick:a[11]||(a[11]=e=>n.value.matingStatus="notLooking")},[e.createElementVNode("text",null,"暂不找配偶")],2)])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"日常照片 (最多3张)"),e.createElementVNode("view",{class:"daily-photos"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.value.dailyPhotos,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:a,class:"photo-item"},[e.createElementVNode("image",{class:"photo-preview",src:t.url,mode:"aspectFill",onError:f},null,40,["src"]),e.createElementVNode("view",{class:"photo-delete",onClick:e=>function(e){e>=0&&e<n.value.dailyPhotos.length&&(n.value.dailyPhotos.splice(e,1),u({title:"已删除照片",icon:"success"}))}(a)},"×",8,["onClick"])])))),128)),n.value.dailyPhotos.length<3?(e.openBlock(),e.createElementBlock("view",{key:0,class:"photo-add",onClick:h},[e.createElementVNode("text",{class:"add-icon"},"+")])):e.createCommentVNode("",!0)])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"个性介绍"),e.withDirectives(e.createElementVNode("textarea",{class:"form-textarea","onUpdate:modelValue":a[12]||(a[12]=e=>n.value.description=e),placeholder:"添加个性信息（选填）"},null,512),[[e.vModelText,n.value.description]])]),e.createElementVNode("button",{class:e.normalizeClass(["submit-btn",{loading:o.value}]),disabled:!c.value||o.value,onClick:y},e.toDisplayString(o.value?"处理中...":"保 存"),11,["disabled"]),"edit"===l.value?(e.openBlock(),e.createElementBlock("button",{key:0,class:"delete-btn",disabled:o.value,onClick:w}," 删除宠物 ",8,["disabled"])):e.createCommentVNode("",!0)])]))}},Me="/api/pet-recognition",De=.3,Ae=e=>new Promise(((t,a)=>{if(e.startsWith("blob:"))try{fetch(e).then((e=>e.blob())).then((e=>{const a=new FileReader;a.onloadend=()=>{const e=a.result.split(",")[1];t(e)},a.readAsDataURL(e)})).catch((e=>a(new Error(`Blob URL处理失败: ${e.message||e}`))))}catch(s){a(new Error(`Blob处理失败: ${s.message||s}`))}else if("undefined"!=typeof uni&&"function"==typeof uni.getFileSystemManager)try{uni.getFileSystemManager().readFile({filePath:e,encoding:"base64",success:e=>{t(e.data)},fail:e=>{a(new Error(`读取文件失败: ${e.errMsg||JSON.stringify(e)}`))}})}catch(s){a(new Error(`文件操作错误: ${s.message||s}`))}else try{const s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="blob",s.onload=function(){if(200===this.status){const e=new FileReader;e.onloadend=function(){const a=e.result.split(",")[1];t(a)},e.readAsDataURL(this.response)}else a(new Error(`加载图片失败，状态码: ${this.status}`))},s.onerror=function(){a(new Error("网络请求图片失败"))},s.send()}catch(s){a(new Error(`H5环境处理图片失败: ${s.message||s}`))}}));function Be(e){return __async(this,null,(function*(){var t;try{a("log","at utils/petAnalysisService.js:103","正在调用后端API进行图像识别...");const s=e.startsWith("data:image")?e:`data:image/jpeg;base64,${e}`;let o=yield function(e){return __async(this,null,(function*(){return new Promise(((t,s)=>{try{const s=new Image;s.onload=function(){try{const o=document.createElement("canvas"),r=800;let n=s.width,i=s.height;n>i&&n>r?(i=Math.round(i*(r/n)),n=r):i>r&&(n=Math.round(n*(r/i)),i=r),o.width=n,o.height=i;o.getContext("2d").drawImage(s,0,0,n,i);const l=o.toDataURL("image/jpeg",.7),c=e.length,u=l.length;a("log","at utils/petAnalysisService.js:213",`图像优化: 原始大小 ${Math.round(c/1024)}KB, 压缩后 ${Math.round(u/1024)}KB, 压缩率 ${Math.round(100*(1-u/c))}%`),t(l)}catch(o){a("error","at utils/petAnalysisService.js:217","压缩图像失败:",o),t(e)}},s.onerror=function(){a("error","at utils/petAnalysisService.js:224","加载图像到Image对象失败"),t(e)},s.src=e}catch(o){a("error","at utils/petAnalysisService.js:232","图像优化过程出错:",o),t(e)}}))}))}(s);const r=yield fetch(Me,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({imageData:o})});if(!r.ok){const e=yield r.json().catch((()=>({})));if(503===r.status&&(null==(t=e.error)?void 0:t.includes("加载中")))throw new Error("AI模型正在加载中，请稍后再试");throw new Error(`后端API返回错误: ${r.status} ${r.statusText} - ${e.error||""}`)}const n=yield r.json();if(a("log","at utils/petAnalysisService.js:140","API原始返回数据:",JSON.stringify(n).substring(0,200)),Array.isArray(n))return a("log","at utils/petAnalysisService.js:144","API返回了有效的预测结果数组:",n.length),n;if(n&&"object"==typeof n){if(a("log","at utils/petAnalysisService.js:148","API返回了非数组格式的结果:",n),n.hasOwnProperty("label")&&n.hasOwnProperty("score"))return[n];if(n.hasOwnProperty("labels")&&n.hasOwnProperty("scores")){const{labels:e,scores:t}=n;return e.map(((e,a)=>({label:e,score:t[a]})))}}throw a("warn","at utils/petAnalysisService.js:164","API返回的数据格式不符合预期:",n),new Error("API返回的数据格式不符合预期")}catch(s){throw a("error","at utils/petAnalysisService.js:167","后端API调用失败:",s),s}}))}const Ue=(e,t)=>{if(a("log","at utils/petAnalysisService.js:270","直接使用API返回的品种数据，不使用本地品种库"),!e||0===e.length)return a("log","at utils/petAnalysisService.js:274","没有接收到有效的预测结果"),null;const s=[...e].sort(((e,t)=>{const a=parseFloat(e.score||e.confidence||0);return parseFloat(t.score||t.confidence||0)-a}));a("log","at utils/petAnalysisService.js:285","排序后的预测结果:",s);const o=s.filter((e=>"dog"!==e.label&&"cat"!==e.label&&"canine"!==e.label&&"pet"!==e.label&&parseFloat(e.score||e.confidence||0)>De));if(0===o.length)return a("log","at utils/petAnalysisService.js:295","没有有效的品种预测结果"),null;const r=o[0];a("log","at utils/petAnalysisService.js:301","使用最高置信度的品种:",r.label,"置信度:",r.score);let n="",i="";r.additional_info&&(n=r.additional_info.description||"",i=r.additional_info.baike_url||"",a("log","at utils/petAnalysisService.js:310","包含百科信息",i?"有链接":"无链接"));let l=n;l?l.length>100&&(l=l.substring(0,100)+"..."):l=`${r.label}的外观特征`;let c="";c=n&&n.length>150?n.substring(100,250)+"...":"具体护理方法请参考专业养宠指南";let u="";if(n&&n.includes("英文名")){const e=n.match(/英文名[：:]\s*([^，。,]+)/);e&&e[1]&&(u=e[1].trim())}const d={name:r.label,englishName:u||r.label,characteristics:{friendliness:n.includes("友好")||n.includes("友善")?85:75,activity:n.includes("活泼")||n.includes("运动")?80:70,trainability:n.includes("聪明")||n.includes("智能")?85:75,grooming:n.includes("毛发")||n.includes("护理")?80:60},features:l,careNote:c,baikeUrl:i,originalScore:parseFloat(r.score||r.confidence||0),apiData:r};return a("log","at utils/petAnalysisService.js:357","创建动态品种:",d.name),{breed:d,confidence:parseFloat(r.score||r.confidence||0),matchScore:parseFloat(r.score||r.confidence||0),source:"百度AI识别",isDynamicBreed:!0,originalLabel:r.label,apiData:r}},je=e=>__async(this,null,(function*(){if(!e||0===e.length)throw new Error("需要提供至少一张图片");try{a("log","at utils/petAnalysisService.js:381","开始分析宠物图片:",e);const s=[];for(const r of e)try{a("log","at utils/petAnalysisService.js:389",`处理图片: ${r}`);const e=yield Ae(r);a("log","at utils/petAnalysisService.js:391",`图片转换为Base64完成，长度: ${e.length}`),a("log","at utils/petAnalysisService.js:394","准备调用API识别...");const t=yield Be(e);if(a("log","at utils/petAnalysisService.js:396","API识别完成，原始响应:",JSON.stringify(t).substring(0,200)),Array.isArray(t)&&t.length>0){a("log","at utils/petAnalysisService.js:400",`收到${t.length}个预测结果`);const e=Ue(t);e?(a("log","at utils/petAnalysisService.js:406","成功创建品种信息:",e.breed.name),s.push({imagePath:r,petType:"dog",breed:e.breed,confidence:e.confidence,source:e.source,originalResponse:t})):(a("log","at utils/petAnalysisService.js:416","无法从API结果创建品种信息"),s.push({imagePath:r,identified:!1,message:"无法识别宠物品种，请提供更清晰的照片",originalResponse:t}))}else a("warn","at utils/petAnalysisService.js:425","API未返回有效结果结构:",t),s.push({imagePath:r,identified:!1,message:"分析结果不明确，请提供更清晰的照片",apiError:"object"==typeof t?JSON.stringify(t):String(t)})}catch(t){a("error","at utils/petAnalysisService.js:434",`分析图片 ${r} 失败:`,t),s.push({imagePath:r,identified:!1,message:`图片处理失败: ${t.message}`,error:t.message})}a("log","at utils/petAnalysisService.js:445","所有分析结果:",JSON.stringify(s,null,2));const o=s.filter((e=>e.breed));if(a("log","at utils/petAnalysisService.js:449",`有${o.length}个有效识别结果`),o.length>0){const e=o.reduce(((e,t)=>parseFloat(t.confidence)>parseFloat(e.confidence)?t:e),o[0]);a("log","at utils/petAnalysisService.js:455","选择置信度最高的结果:",e.breed.name);const{breed:t}=e,s={identified:!0,breed:t.name,breedConfidence:Math.round(100*parseFloat(e.confidence)),features:t.features||"暂无特征描述",characteristics:t.characteristics||{friendliness:75,activity:70,trainability:70,grooming:60},note:t.careNote||"暂无护理建议",recognitionSource:e.source||"API识别",petType:e.petType||"dog"};return t.englishName&&(s.englishName=t.englishName),t.baikeUrl&&(s.baikeUrl=t.baikeUrl),s.purity=parseFloat(e.confidence)>.75?"纯种":"混合",s._debug={originalResponse:e.originalResponse},a("log","at utils/petAnalysisService.js:493","返回最终结果:",JSON.stringify(s,null,2)),s}{const e={identified:!1,message:"无法识别宠物品种，请提供更清晰的照片"};return s.length>0&&s[0].originalResponse&&(e._debug={originalResponse:s[0].originalResponse}),a("log","at utils/petAnalysisService.js:509","返回错误结果:",JSON.stringify(e,null,2)),e}}catch(s){throw a("error","at utils/petAnalysisService.js:513","分析宠物图片失败:",s),new Error(`图像分析失败: ${s.message}`)}})),Fe={__name:"recognition",setup(t){const s=X();Y();const o=e.ref(""),r=e.ref(!1),n=e.ref(null);function i(){return __async(this,null,(function*(){try{const e=yield new Promise(((e,t)=>{uni.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:e,fail:t})}));o.value=e.tempFilePaths[0],function(){__async(this,null,(function*(){if(!o.value)return u("请先选择图片");r.value=!0,d("识别中...");try{const e=yield je([o.value]);a("log","at pages/pet/recognition.vue:134","识别服务返回结果:",e),e.identified?(n.value=e,a("log","at pages/pet/recognition.vue:139","识别成功:",n.value)):u(e.message||"识别失败，请重试")}catch(e){a("error","at pages/pet/recognition.vue:144","分析图片失败:",e),u("识别失败，请重试")}finally{r.value=!1,m()}}))}()}catch(e){a("error","at pages/pet/recognition.vue:118","选择图片失败:",e)}}))}function l(){o.value="",n.value=null}function c(){return n.value?s.isAuthenticated?void uni.navigateTo({url:`/pages/pet/edit?mode=add&breed=${encodeURIComponent(n.value.breed)}&petType=${encodeURIComponent(n.value.petType||"dog")}`,success:()=>{u("请完善宠物信息")},fail:e=>{a("error","at pages/pet/recognition.vue:175","导航到宠物编辑页面失败:",e),u("操作失败，请重试")}}):u("请先登录"):u("没有识别结果")}return e.onMounted((()=>{s.isAuthenticated||(u("请先登录"),setTimeout((()=>{v()}),1500))})),(t,a)=>(e.openBlock(),e.createElementBlock("view",{class:"recognition-container"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("view",{class:"back-btn",onClick:a[0]||(a[0]=(...t)=>e.unref(v)&&e.unref(v)(...t))},[e.createElementVNode("text",{class:"back-arrow"},"←")]),e.createElementVNode("text",{class:"title"},"宠物识别")]),e.createElementVNode("view",{class:"content"},[e.createElementVNode("view",{class:"upload-section"},[e.createElementVNode("view",{class:"upload-box",onClick:i},[o.value?(e.openBlock(),e.createElementBlock("image",{key:0,src:o.value,mode:"aspectFill",class:"preview-image"},null,8,["src"])):(e.openBlock(),e.createElementBlock("view",{key:1,class:"upload-placeholder"},[e.createElementVNode("view",{class:"upload-icon"},"+"),e.createElementVNode("text",{class:"upload-text"},"点击上传宠物照片")]))])]),r.value||n.value?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("view",{key:0,class:"hint-text"},[e.createElementVNode("text",null,"上传一张清晰的宠物照片，我们将为您识别宠物品种")])),r.value?(e.openBlock(),e.createElementBlock("view",{key:1,class:"loading"},[e.createElementVNode("view",{class:"loading-spinner"}),e.createElementVNode("text",{class:"loading-text"},"正在分析...")])):e.createCommentVNode("",!0),n.value?(e.openBlock(),e.createElementBlock("view",{key:2,class:"result-section"},[e.createElementVNode("view",{class:"result-card"},[e.createElementVNode("view",{class:"result-header"},[e.createElementVNode("text",{class:"result-title"},"识别结果")]),e.createElementVNode("view",{class:"result-content"},[e.createElementVNode("text",{class:"breed-name"},e.toDisplayString(n.value.breed),1),n.value.englishName?(e.openBlock(),e.createElementBlock("text",{key:0,class:"breed-english"},e.toDisplayString(n.value.englishName),1)):e.createCommentVNode("",!0),e.createElementVNode("text",{class:"confidence"},"可信度: "+e.toDisplayString(n.value.breedConfidence)+"%",1),e.createElementVNode("text",{class:"pet-type"},"类型: "+e.toDisplayString("dog"===n.value.petType?"狗":"cat"===n.value.petType?"猫":"未知"),1),n.value.purity?(e.openBlock(),e.createElementBlock("text",{key:1,class:"purity"},"纯种可能性: "+e.toDisplayString(n.value.purity),1)):e.createCommentVNode("",!0)]),n.value.features||n.value.note?(e.openBlock(),e.createElementBlock("view",{key:0,class:"breed-info"},[e.createElementVNode("text",{class:"info-title"},"品种介绍:"),e.createElementVNode("text",{class:"info-text"},e.toDisplayString(n.value.features),1),n.value.note?(e.openBlock(),e.createElementBlock("text",{key:0,class:"care-title"},"护理建议:")):e.createCommentVNode("",!0),n.value.note?(e.openBlock(),e.createElementBlock("text",{key:1,class:"care-text"},e.toDisplayString(n.value.note),1)):e.createCommentVNode("",!0)])):e.createCommentVNode("",!0),n.value.characteristics?(e.openBlock(),e.createElementBlock("view",{key:1,class:"breed-chars"},[e.createElementVNode("text",{class:"chars-title"},"性格特点:"),e.createElementVNode("view",{class:"chars-item"},[e.createElementVNode("text",{class:"chars-label"},"友好度"),e.createElementVNode("view",{class:"progress-bar"},[e.createElementVNode("view",{class:"progress-fill",style:e.normalizeStyle({width:n.value.characteristics.friendliness+"%"})},null,4)])]),e.createElementVNode("view",{class:"chars-item"},[e.createElementVNode("text",{class:"chars-label"},"活跃度"),e.createElementVNode("view",{class:"progress-bar"},[e.createElementVNode("view",{class:"progress-fill",style:e.normalizeStyle({width:n.value.characteristics.activity+"%"})},null,4)])]),e.createElementVNode("view",{class:"chars-item"},[e.createElementVNode("text",{class:"chars-label"},"训练难度"),e.createElementVNode("view",{class:"progress-bar"},[e.createElementVNode("view",{class:"progress-fill",style:e.normalizeStyle({width:n.value.characteristics.trainability+"%"})},null,4)])]),e.createElementVNode("view",{class:"chars-item"},[e.createElementVNode("text",{class:"chars-label"},"护理需求"),e.createElementVNode("view",{class:"progress-bar"},[e.createElementVNode("view",{class:"progress-fill",style:e.normalizeStyle({width:n.value.characteristics.grooming+"%"})},null,4)])])])):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"action-buttons"},[e.createElementVNode("button",{class:"action-btn retry-btn",onClick:l},"重新识别"),e.createElementVNode("button",{class:"action-btn save-btn",onClick:c},"保存为我的宠物")])])):e.createCommentVNode("",!0)])]))}};const $e=he({components:{WalkRecordCard:Ee,ImageViewer:Ne},setup(){var t;const s=X(),o=e.ref([]),r=e.ref(!1),n=e.ref(1),i=e.ref(!0),l=null==(t=uni.$api)?void 0:t.community,c=e.ref(!1),d=e.ref(0),m=e.ref(null);function v(e=!1){return __async(this,null,(function*(){var t;if(!r.value&&(e&&(n.value=1,i.value=!0),i.value||e)){r.value=!0;try{a("log","at pages/community/my-posts.vue:179","尝试获取我的帖子，页码:",n.value,"每页数量:",10);const s=yield uni.$api.community.getMyPosts({page:n.value,limit:10});if(!s||!s.data)return a("warn","at pages/community/my-posts.vue:188","获取我的帖子响应格式不正确:",s),e&&(o.value=[]),i.value=!1,void(e&&uni.stopPullDownRefresh());a("log","at pages/community/my-posts.vue:204","获取我的帖子成功，数据:",s.data),o.value=e?(s.data||[]).map((e=>f(e))):[...o.value,...(s.data||[]).map((e=>f(e)))],i.value=10===(null==(t=s.data)?void 0:t.length),n.value++,e&&uni.stopPullDownRefresh()}catch(s){a("error","at pages/community/my-posts.vue:222","获取我的动态失败:",s);const t=s.message||"未知错误",r=s.statusCode||"未知状态码";u({title:`获取动态失败 (${r}): ${t}`,icon:"none"}),(e||0===o.value.length)&&(o.value=[]),i.value=!1,e&&uni.stopPullDownRefresh()}finally{r.value=!1}}}))}function h(e){return __async(this,null,(function*(){r.value=!0;try{a("log","at pages/community/my-posts.vue:334","尝试删除帖子，ID:",e),yield uni.$api.community.deletePost(e),o.value=o.value.filter((t=>t.id!==e&&t._id!==e)),u({title:"动态已删除",icon:"success"})}catch(t){a("error","at pages/community/my-posts.vue:345","删除动态失败:",t);const e=t.message||"未知错误",s=t.statusCode||"未知状态码";u({title:`删除失败 (${s}): ${e}`,icon:"none",duration:3e3}),404===t.statusCode&&(a("log","at pages/community/my-posts.vue:360","帖子可能已被删除，尝试刷新列表"),setTimeout((()=>{v(!0)}),1500))}finally{r.value=!1}}))}function f(e){if(e.walkRecord)return e;const t=e.content||"";let a=null;const s=t.match(/遛了\s*(\d+\.?\d*)\s*公里/),o=s?1e3*parseFloat(s[1]):null,r=t.match(/用时\s*(\d+)\s*(秒|分钟|小时)/);let n=null;if(r){const e=parseInt(r[1]),t=r[2];"秒"===t?n=e:"分钟"===t?n=60*e:"小时"===t&&(n=3600*e)}const i=t.match(/和\s*([^\s,，。！]+)\s*一起遛/),l=i?i[1]:"我的宠物";return null!==o||null!==n?(a={_id:`generated_${e._id||e.id||Date.now()}`,distance:o||0,duration:n||0,pet:{name:l},startTime:e.createdAt||e.time||(new Date).toISOString()},__spreadProps(__spreadValues({},e),{walkRecord:a})):e}return{posts:o,isLoading:r,hasMore:i,userStore:s,formatDate:function(e){if(!e)return"";const t=new Date(e),a=new Date;if(a-t<864e5&&t.getDate()===a.getDate()){const e=t.getHours(),a=t.getMinutes();return`今天 ${e.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`}const s=new Date(a);if(s.setDate(s.getDate()-1),t.getDate()===s.getDate()&&t.getMonth()===s.getMonth()&&t.getFullYear()===s.getFullYear()){const e=t.getHours(),a=t.getMinutes();return`昨天 ${e.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`}return`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")}`},formatImageUrl:function(e){if(!e)return"/static/images/default-pet.png";if(a("log","at pages/community/my-posts.vue:145","我的帖子页面处理图片URL:",e),e.startsWith("http")||e.startsWith("/static")||e.startsWith("blob:"))return e;if(e.startsWith("/uploads")){const t=uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000",s=t+e;return a("log","at pages/community/my-posts.vue:156","处理相对路径图片URL:",e,"补充基础URL:",t,"完整URL:",s),s}return a("warn","at pages/community/my-posts.vue:161","未能识别的图片URL格式:",e),"/static/images/default-pet.png"},loadPosts:v,viewPostDetail:function(e){if(a("log","at pages/community/my-posts.vue:252","查看帖子详情:",e),!e||!e.id&&!e._id)return void uni.showToast({title:"帖子数据无效",icon:"none"});const t=e.id||e._id;try{const a=`post_cache_${t}_${Date.now()}`;uni.setStorageSync(a,JSON.stringify(e)),g(`/pages/community/post-detail?id=${t}&postKey=${a}`)}catch(s){a("error","at pages/community/my-posts.vue:272","保存帖子数据到缓存失败:",s),g(`/pages/community/post-detail?id=${t}`)}},previewImage:function(e,t){m.value=e,d.value=t,c.value=!0},editPost:function(e){if(!e||!e.id&&!e._id)return void uni.showToast({title:"无法编辑，帖子数据无效",icon:"none"});const t=e.id||e._id;try{const a=`post_cache_${t}_${Date.now()}`;uni.setStorageSync(a,JSON.stringify(e)),g(`/pages/community/create?id=${t}&mode=edit&postKey=${a}`)}catch(s){a("error","at pages/community/my-posts.vue:310","缓存帖子数据失败:",s),g(`/pages/community/create?id=${t}&mode=edit`)}},confirmDelete:function(e){p({title:"删除动态",content:"确定要删除这条动态吗？此操作不可恢复。",showCancel:!0}).then((t=>__async(this,null,(function*(){t&&(yield h(e))}))))},deletePost:h,createPost:function(){g("/pages/community/create")},checkLoginAndLoadData:function(){if(!s.isAuthenticated)return u({title:"请先登录",icon:"none"}),void setTimeout((()=>{g("/pages/login/login")}),1500);v()},formatDuration:function(e){if(!e)return"0分钟";const t=Math.floor(e/3600),a=Math.floor(e%3600/60);let s="";return t>0?(s+=`${t}小时`,a>0&&(s+=`${a}分钟`)):s+=`${a}分钟`,s},viewWalkRecord:function(e){if(!e.walkRecord||!e.walkRecord._id)return void uni.showToast({title:"遛狗记录不存在",icon:"none"});a("log","at pages/community/my-posts.vue:421","查看遛狗记录详情:",e.walkRecord),e.walkRecord._id.startsWith("generated_")?uni.showToast({title:"这是从动态内容解析的遛狗记录，无法查看详情",icon:"none",duration:2500}):uni.navigateTo({url:`/pages/walk/detail?id=${e.walkRecord._id}`,fail:e=>{a("error","at pages/community/my-posts.vue:439","打开遛狗记录详情失败:",e),uni.showToast({title:"无法查看遛狗记录",icon:"none"})}})},getNumberValue:function(e){return Array.isArray(e)?e.length:"number"==typeof e?e:e&&"object"==typeof e?Object.keys(e).length:0},truncateText:function(e,t){return e?e.length<=t?e:e.substring(0,t)+"...":""},likePost:function(e,t){return __async(this,null,(function*(){if(t.stopPropagation(),a("log","at pages/community/my-posts.vue:520","点赞帖子:",e),!e||!e.id&&!e._id)return a("error","at pages/community/my-posts.vue:523","无效的帖子ID"),void u({title:"无法点赞",icon:"none"});const s=e.id||e._id;void 0===e.isLiked&&(e.isLiked=!1),void 0===e.likes&&(e.likes=0);const o=e.isLiked;e.isLiked=!o,e.likes=o?Math.max((e.likes||1)-1,0):(e.likes||0)+1;try{if(!l)throw new Error("社区API未初始化");const t=yield l.likePost(s,!o);a("log","at pages/community/my-posts.vue:555","点赞/取消点赞成功:",t),t&&t.data&&void 0!==t.data.likes&&(e.likes=t.data.likes,e.isLiked=t.data.isLiked)}catch(r){a("error","at pages/community/my-posts.vue:563","点赞/取消点赞失败:",r),e.isLiked=o,e.likes=o?(e.likes||0)+1:Math.max((e.likes||1)-1,0),u({title:"操作失败，请重试",icon:"none"})}}))},closeImageViewer:function(){c.value=!1},showImageViewer:c,currentImageIndex:d,currentPost:m}},onLoad(){this.checkLoginAndLoadData()},onPullDownRefresh(){this.loadPosts(!0)},onReachBottom(){this.hasMore&&!this.isLoading&&this.loadPosts()}},[["render",function(t,a,s,o,r,n){var i;const l=e.resolveComponent("walk-record-card"),c=e.resolveComponent("image-viewer");return e.openBlock(),e.createElementBlock("view",{class:"my-posts-container"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("text",{class:"title"},"我的动态")]),o.posts.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"post-list"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.posts,((t,a)=>(e.openBlock(),e.createElementBlock("view",{class:"post-item",key:t.id||t._id,onClick:e=>o.viewPostDetail(t)},[e.createElementVNode("view",{class:"post-header"},[e.createElementVNode("view",{class:"user-info"},[e.createElementVNode("image",{class:"avatar",src:t.avatar||"/static/images/default-avatar.png",mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"name-time"},[e.createElementVNode("text",{class:"username"},e.toDisplayString(t.username||"匿名用户"),1),e.createElementVNode("text",{class:"time"},e.toDisplayString(o.formatDate(t.createdAt||t.createTime)),1)])])]),e.createElementVNode("view",{class:"post-content"},[e.createElementVNode("text",{class:"post-text"},e.toDisplayString(o.truncateText(t.content,40)),1),t.walkRecord?(e.openBlock(),e.createBlock(l,{key:0,record:t.walkRecord},null,8,["record"])):e.createCommentVNode("",!0),t.images&&t.images.length>0?(e.openBlock(),e.createElementBlock("view",{key:1,class:"image-grid"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(t.images.slice(0,3),((a,s)=>(e.openBlock(),e.createElementBlock("image",{key:s,src:o.formatImageUrl(a),mode:"aspectFill",class:"post-image",onClick:e.withModifiers((e=>o.previewImage(t,s)),["stop"])},null,8,["src","onClick"])))),128)),t.images.length>3?(e.openBlock(),e.createElementBlock("view",{key:0,class:"more-images"},"+"+e.toDisplayString(t.images.length-3),1)):e.createCommentVNode("",!0)])):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"post-footer"},[e.createElementVNode("view",{class:"action-item",onClick:e.withModifiers((e=>o.likePost(t,e)),["stop"])},[e.createElementVNode("view",{class:e.normalizeClass(["action-icon like-icon",{active:t.isLiked}]),style:{"background-image":"url('/static/images/like-icon.png')","background-size":"contain","background-repeat":"no-repeat"}},null,2),e.createElementVNode("text",{class:"action-text"},"点赞 "+e.toDisplayString(o.getNumberValue(t.likes)),1)],8,["onClick"]),e.createElementVNode("view",{class:"action-item"},[e.createElementVNode("view",{class:"action-icon comment-icon",style:{"background-image":"url('/static/images/comment-icon.png')","background-size":"contain","background-repeat":"no-repeat"}}),e.createElementVNode("text",{class:"action-text"},"评论 "+e.toDisplayString(o.getNumberValue(t.comments)),1)]),e.createElementVNode("view",{class:"post-actions"},[e.createElementVNode("view",{class:"action-btn delete-btn",onClick:e.withModifiers((e=>o.confirmDelete(t.id||t._id)),["stop"])},"删除",8,["onClick"])])])],8,["onClick"])))),128))])):(e.openBlock(),e.createElementBlock("view",{key:1,class:"empty-list"},[e.createElementVNode("image",{src:"/static/images/empty-posts.png",mode:"aspectFit",class:"empty-icon"}),e.createElementVNode("text",{class:"empty-text"},"还没有发布过动态"),e.createElementVNode("button",{class:"create-btn",onClick:a[0]||(a[0]=(...e)=>o.createPost&&o.createPost(...e))},"发布动态")])),o.isLoading?(e.openBlock(),e.createElementBlock("view",{key:2,class:"loading"},[e.createElementVNode("view",{class:"loading-spinner"}),e.createElementVNode("text",{class:"loading-text"},"加载中...")])):e.createCommentVNode("",!0),e.createVNode(c,{show:o.showImageViewer,images:(null==(i=o.currentPost)?void 0:i.images)||[],initialIndex:o.currentImageIndex,onClose:o.closeImageViewer},null,8,["show","images","initialIndex","onClose"])])}]]);a("log","at pages/walk/history.vue:84","已加载增强版遛狗记录页面 v2.1 - 修复返回导航逻辑");const Le=he({setup(){const t=X(),s=e.ref([]),o=e.ref(!1),r=e.ref(!0),n=10,i=e.ref(1),c=e.ref(!1),u=e.ref(""),d=()=>__async(this,null,(function*(){if(r.value&&!o.value){o.value=!0,u.value="";try{a("log","at pages/walk/history.vue:106","开始加载遛狗记录, 页码:",i.value,"每页数量:",n),a("log","at pages/walk/history.vue:107","API路径: /api/walks");const e=yield B.walk.getMyWalks({page:i.value,limit:n});a("log","at pages/walk/history.vue:114","API响应成功, 返回数据类型:",typeof e,e?"有数据":"无数据"),a("log","at pages/walk/history.vue:115","API响应数据:",JSON.stringify(e));let t=[],o=!1;e&&0===e.code&&e.data?e.data.list&&Array.isArray(e.data.list)&&(a("log","at pages/walk/history.vue:124","标准API返回格式, 记录数量:",e.data.list.length),t=e.data.list,o=t.length<n||e.data.total&&i.value*n>=e.data.total):Array.isArray(e)?(a("log","at pages/walk/history.vue:131","直接返回数组格式, 记录数量:",e.length),t=e,o=t.length<n):e&&"object"==typeof e&&e.data&&(Array.isArray(e.data)?(a("log","at pages/walk/history.vue:138","嵌套数组格式, 记录数量:",e.data.length),t=e.data,o=t.length<n):e.data.list&&Array.isArray(e.data.list)&&(a("log","at pages/walk/history.vue:142","嵌套对象格式, 记录数量:",e.data.list.length),t=e.data.list,o=t.length<n||e.data.total&&i.value*n>=e.data.total)),0===t.length&&1===i.value?(a("log","at pages/walk/history.vue:149","没有找到任何遛狗记录"),u.value="您还没有遛狗记录，快去遛狗吧！",r.value=!1):(a("log","at pages/walk/history.vue:153","成功加载遛狗记录, 数量:",t.length),s.value=1===i.value?[...t]:[...s.value,...t],i.value++,r.value=!o,a("log","at pages/walk/history.vue:157","当前已加载记录总数:",s.value.length,"是否有更多:",r.value))}catch(e){a("error","at pages/walk/history.vue:160","加载遛狗记录失败:",e),a("error","at pages/walk/history.vue:161","错误详情:",e.message||"未知错误"),e.statusCode&&a("error","at pages/walk/history.vue:163","HTTP状态码:",e.statusCode);let t="加载失败，请重试";e&&e.message&&(404===e.statusCode?(t="API接口不存在，后端可能尚未实现此功能",u.value="无法加载遛狗记录，后端API未找到"):401===e.statusCode?(t="登录已过期，请重新登录",setTimeout((()=>{uni.navigateTo({url:"/pages/login/login"})}),1500)):(t=`加载失败: ${e.message}`,u.value="加载遛狗记录失败，请稍后再试")),uni.showToast({title:t,icon:"none",duration:3e3})}finally{o.value=!1,c.value&&(c.value=!1)}}})),m=()=>{s.value=[],i.value=1,r.value=!0},p=e=>{const t=Math.floor(e/3600),a=Math.floor(e%3600/60),s=e%60;return t>0?`${t}小时${a}分`:a>0?`${a}分${s}秒`:`${s}秒`};return e.onMounted((()=>{t.token?d():uni.showToast({title:"请先登录",icon:"none",success:()=>{setTimeout((()=>{uni.navigateTo({url:"/pages/login/login"})}),1500)}})})),l((()=>{a("log","at pages/walk/history.vue:396","页面下拉刷新"),m(),d().finally((()=>{uni.stopPullDownRefresh()}))})),{records:s,isLoading:o,hasMore:r,isRefreshing:c,errorMessage:u,loadMore:()=>{r.value&&!o.value&&d()},onRefresh:()=>{c.value=!0,m(),d()},viewDetail:e=>{uni.navigateTo({url:`/pages/walk/detail?id=${e._id}`})},shareRecord:e=>{var t;const s=`我和${(null==(t=e.pet)?void 0:t.name)||"我的宠物"}一起遛了${(e.distance/1e3).toFixed(2)}公里，用时${p(e.duration)}！`;uni.navigateTo({url:"/pages/community/create",success:t=>{var a;uni.$emit("createPost",{content:s,walkRecord:{_id:e._id,distance:e.distance,duration:e.duration,pet:null==(a=e.pet)?void 0:a._id,startTime:e.startTime,endTime:e.endTime}})},fail:e=>{a("error","at pages/walk/history.vue:253","导航到社区发帖页面失败:",e),uni.showToast({title:"打开社区页面失败",icon:"none"})}})},deleteRecord:e=>{uni.showModal({title:"删除记录",content:"确定要删除这条遛狗记录吗？",success:t=>__async(this,null,(function*(){if(t.confirm)try{o.value=!0,a("log","at pages/walk/history.vue:271","正在删除记录ID:",e._id||e.id);if(a("log","at pages/walk/history.vue:275","删除记录API响应:",yield B.walk.deleteWalk(e._id||e.id)),s.value=s.value.filter((t=>(t._id||t.id)!==(e._id||e.id))),e.id&&e.id.startsWith("walk_"))try{a("log","at pages/walk/history.vue:283","从本地存储中删除记录");require("@/utils/walkStorage.js").default.deleteWalkRecord(e.id)}catch(r){a("error","at pages/walk/history.vue:287","本地存储删除失败:",r)}uni.showToast({title:"删除成功",icon:"success"}),setTimeout((()=>{m(),d()}),1e3)}catch(n){a("error","at pages/walk/history.vue:303","删除记录失败:",n),a("error","at pages/walk/history.vue:304","错误详情:",n.message||"未知错误"),n.statusCode&&a("error","at pages/walk/history.vue:306","HTTP状态码:",n.statusCode),uni.showToast({title:n.message||"删除失败，请重试",icon:"none",duration:3e3})}finally{o.value=!1}}))})},navToMap:()=>{uni.switchTab({url:"/pages/map/map"})},formatDate:e=>{const t=new Date(e);return`${t.getFullYear()}年${t.getMonth()+1}月${t.getDate()}日`},formatTime:e=>{const t=new Date(e);return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`},formatDuration:p,navBack:()=>{getCurrentPages().length>1?uni.navigateBack():uni.switchTab({url:"/pages/my/index"})},loadRecords:d,resetList:m}}},[["render",function(t,a,s,o,r,n){return e.openBlock(),e.createElementBlock("view",{class:"history-container"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("view",{class:"back-btn",onClick:a[0]||(a[0]=(...e)=>o.navBack&&o.navBack(...e))},[e.createElementVNode("text",{class:"back-icon"},"←")]),e.createElementVNode("text",{class:"title"},"遛狗记录")]),e.createElementVNode("scroll-view",{class:"record-list","scroll-y":"true",onScrolltolower:a[2]||(a[2]=(...e)=>o.loadMore&&o.loadMore(...e))},[0!==o.records.length||o.isLoading?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("view",{key:0,class:"no-records"},[e.createElementVNode("image",{class:"empty-image",src:"/static/images/empty-records.png",mode:"aspectFit"}),e.createElementVNode("text",{class:"empty-text"},e.toDisplayString(o.errorMessage||"暂无遛狗记录"),1),e.createElementVNode("button",{class:"start-btn",onClick:a[1]||(a[1]=(...e)=>o.navToMap&&o.navToMap(...e))},"开始遛狗")])),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.records,(t=>{var a,s;return e.openBlock(),e.createElementBlock("view",{class:"record-item",key:t._id,onClick:e=>o.viewDetail(t)},[e.createElementVNode("view",{class:"record-date"},[e.createElementVNode("text",{class:"date"},e.toDisplayString(o.formatDate(t.startTime)),1),e.createElementVNode("text",{class:"time"},e.toDisplayString(o.formatTime(t.startTime)),1)]),e.createElementVNode("view",{class:"record-content"},[e.createElementVNode("view",{class:"record-map"},[e.createElementVNode("image",{class:"map-image",src:t.mapImageUrl||"/static/images/default-map.png",mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"pet-avatar-container"},[e.createElementVNode("image",{class:"pet-avatar",src:(null==(a=t.pet)?void 0:a.avatar)||"/static/images/default-pet.png",mode:"aspectFill"},null,8,["src"])])]),e.createElementVNode("view",{class:"record-info"},[e.createElementVNode("view",{class:"record-title"},[e.createElementVNode("text",null,e.toDisplayString((null==(s=t.pet)?void 0:s.name)||"未知宠物")+"的遛狗记录",1)]),e.createElementVNode("view",{class:"record-stats"},[e.createElementVNode("view",{class:"stat-item"},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString((t.distance/1e3).toFixed(2)),1),e.createElementVNode("text",{class:"stat-unit"},"公里")]),e.createElementVNode("view",{class:"stat-divider"}),e.createElementVNode("view",{class:"stat-item"},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString(o.formatDuration(t.duration)),1),e.createElementVNode("text",{class:"stat-unit"},"时长")])])])]),e.createElementVNode("view",{class:"record-footer"},[e.createElementVNode("view",{class:"action-item",onClick:e.withModifiers((e=>o.shareRecord(t)),["stop"])},[e.createElementVNode("view",{class:"action-icon share-icon"}),e.createElementVNode("text",{class:"action-text"},"分享")],8,["onClick"]),e.createElementVNode("view",{class:"action-item",onClick:e.withModifiers((e=>o.deleteRecord(t)),["stop"])},[e.createElementVNode("view",{class:"action-icon delete-icon"}),e.createElementVNode("text",{class:"action-text"},"删除")],8,["onClick"])])],8,["onClick"])})),128)),o.isLoading?(e.openBlock(),e.createElementBlock("view",{key:1,class:"loading"},[e.createElementVNode("text",null,"加载中...")])):e.createCommentVNode("",!0),o.records.length>0&&!o.hasMore&&!o.isLoading?(e.openBlock(),e.createElementBlock("view",{key:2,class:"end-line"},[e.createElementVNode("text",null,"- 没有更多记录 -")])):e.createCommentVNode("",!0)],32)])}],["__scopeId","data-v-aa58a5b5"]]),Re={__name:"settings",setup(t){const s=X();function o(){g("/pages/profile/profile")}function r(){u("修改密码功能即将推出")}function n(){u("通知设置功能即将推出")}function i(){u("隐私设置功能即将推出")}function l(){u("关于应用功能即将推出")}function c(){return __async(this,null,(function*(){if(yield p({title:"退出登录",content:"确定要退出登录吗？",showCancel:!0}))try{yield s.logout(),u({title:"已退出登录",icon:"success"}),setTimeout((()=>{uni.reLaunch({url:"/pages/login/login"})}),1500)}catch(e){a("error","at pages/profile/settings.vue:94","退出登录失败:",e),u("退出登录失败，请重试")}}))}return(t,a)=>(e.openBlock(),e.createElementBlock("view",{class:"settings-container"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("view",{class:"header-title"},"设置")]),e.createElementVNode("view",{class:"settings-list"},[e.createElementVNode("view",{class:"settings-item",onClick:o},[e.createElementVNode("text",{class:"item-text"},"编辑个人资料"),e.createElementVNode("view",{class:"arrow-icon"})]),e.createElementVNode("view",{class:"settings-item",onClick:r},[e.createElementVNode("text",{class:"item-text"},"修改密码"),e.createElementVNode("view",{class:"arrow-icon"})]),e.createElementVNode("view",{class:"settings-item",onClick:n},[e.createElementVNode("text",{class:"item-text"},"通知设置"),e.createElementVNode("view",{class:"arrow-icon"})]),e.createElementVNode("view",{class:"settings-item",onClick:i},[e.createElementVNode("text",{class:"item-text"},"隐私设置"),e.createElementVNode("view",{class:"arrow-icon"})]),e.createElementVNode("view",{class:"settings-item",onClick:l},[e.createElementVNode("text",{class:"item-text"},"关于应用"),e.createElementVNode("view",{class:"arrow-icon"})])]),e.createElementVNode("view",{class:"footer"},[e.createElementVNode("button",{class:"logout-btn",onClick:c},"退出登录")])]))}},Oe={__name:"profile",setup(t){const s=e.ref(!1),o=X(),r=e.ref(!1),n=uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000",i=e.computed((()=>{const e=l.value.avatar;if(a("log","at pages/profile/profile.vue:71","个人资料页面头像路径:",e),!e)return"/static/images/default-avatar.png";if(e.startsWith("/uploads/")){const t=n+e;return a("log","at pages/profile/profile.vue:80","个人资料页面完整头像URL:",t),t}return e})),l=e.ref({nickname:"",email:"",phone:"",avatar:"",gender:"unknown",bio:""}),c=[{value:"unknown",label:"请选择性别"},{value:"male",label:"男"},{value:"female",label:"女"},{value:"other",label:"其他"}],p=e.computed((()=>{const e=c.findIndex((e=>e.value===l.value.gender));return a("log","at pages/profile/profile.vue:108","计算性别索引:",l.value.gender,"索引为:",e>=0?e:0),e>=0?e:0})),g=e.computed((()=>l.value.nickname&&l.value.email&&l.value.phone)),v=e.ref(!1),h=e.ref(!1);function f(e){const t=e.detail.value;l.value.gender=c[t].value,a("log","at pages/profile/profile.vue:127","性别变更为:",l.value.gender)}function y(){return __async(this,null,(function*(){try{a("log","at pages/profile/profile.vue:133","开始选择图片");const s=yield new Promise(((e,t)=>{uni.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:e,fail:t})}));if(!s||!s.tempFilePaths||!s.tempFilePaths.length)return void a("error","at pages/profile/profile.vue:145","未选择图片或返回的图片路径为空");const o=s.tempFilePaths[0];if(a("log","at pages/profile/profile.vue:150","选择的图片路径:",o),!o)return a("error","at pages/profile/profile.vue:153","无效的图片路径"),void u("选择图片失败");r.value=!0;try{const t=yield new Promise(((e,t)=>{uni.getFileInfo({filePath:o,success:e,fail:t})}));if(a("log","at pages/profile/profile.vue:171","原始图片大小:",(t.size/1024/1024).toFixed(2)+"MB"),a("log","at pages/profile/profile.vue:172","图片类型:",t.type),t.size>4194304){u("图片较大，正在压缩...");try{const e=yield function(e){return __async(this,null,(function*(){return new Promise(((t,s)=>{uni.compressImage({src:e,quality:70,width:"60%",height:"60%",success:e=>{t(e.tempFilePath)},fail:s=>{a("error","at pages/profile/profile.vue:229","压缩图片失败:",s),t(e)}})}))}))}(o);a("log","at pages/profile/profile.vue:181","压缩后的图片路径:",e);a("log","at pages/profile/profile.vue:192","压缩后图片大小:",((yield new Promise(((t,a)=>{uni.getFileInfo({filePath:e,success:t,fail:a})}))).size/1024/1024).toFixed(2)+"MB"),yield w(e)}catch(e){a("error","at pages/profile/profile.vue:197","压缩图片失败:",e),u("图片压缩失败，尝试直接上传"),yield w(o)}}else yield w(o)}catch(t){a("error","at pages/profile/profile.vue:206","获取文件信息失败:",t),yield w(o)}}catch(t){a("error","at pages/profile/profile.vue:211","选择图片失败:",t),u("选择图片失败"),r.value=!1}}))}function w(e){return __async(this,null,(function*(){try{if(a("log","at pages/profile/profile.vue:240","开始上传头像，文件路径:",e),!e)return a("error","at pages/profile/profile.vue:246","无效的头像文件路径"),u("头像文件无效"),!1;const t=yield o.uploadAvatar(e);a("log","at pages/profile/profile.vue:254","头像上传结果:",t);let s=null;if(t&&(s=t.avatar||t.data&&t.data.avatar||null,a("log","at pages/profile/profile.vue:265","提取的头像路径:",s)),s){l.value.avatar=s,u("头像上传成功");const e=yield o.fetchUserInfo();return e&&e.avatar===s?(a("log","at pages/profile/profile.vue:277","头像已确认成功保存到后端:",s),!0):(a("warn","at pages/profile/profile.vue:280","头像保存可能不完整，后端返回的头像与上传的不一致"),!0)}return a("error","at pages/profile/profile.vue:285","头像上传失败：未获取到有效的头像URL",t),u("头像上传失败，请重试"),!1}catch(t){return a("error","at pages/profile/profile.vue:290","头像上传失败:",t),t.message&&t.message.includes("网络请求失败")?u("网络连接失败，请检查网络"):t.message&&t.message.includes("文件读取失败")?u("文件读取失败，请重新选择图片"):t.message&&t.message.includes("上传失败: 400")?u("文件格式不支持或已损坏"):u("头像上传失败，请重试"),!1}finally{r.value=!1}}))}function k(){return __async(this,null,(function*(){if(!l.value.nickname)return u("请输入昵称");if(!l.value.email)return u("请输入邮箱");if(!l.value.phone)return u("请输入手机号码");h.value=!0,d("保存中...");try{const t={nickname:l.value.nickname,email:l.value.email,bio:l.value.bio||"",phone:l.value.phone||"",gender:l.value.gender||"unknown"};l.value.avatar&&(t.avatar=l.value.avatar),a("log","at pages/profile/profile.vue:342","准备更新个人资料，包含性别信息:",t),Object.keys(t).forEach((e=>{void 0===t[e]&&(t[e]="")}));const r=yield o.updateUserInfo(t);if(a("log","at pages/profile/profile.vue:354","个人资料更新结果:",r),r){if(!function(e,t){if(!e)return!1;const s=["nickname","email","phone","gender"];for(const o of s){if(!e[o])return a("error","at pages/profile/profile.vue:430",`关键字段 ${o} 没有在服务器响应中返回`),!1;e[o]!==t[o]&&a("warn","at pages/profile/profile.vue:436",`字段 ${o} 值不一致: 提交=${t[o]}, 返回=${e[o]}`)}return!0}(r,t))return a("error","at pages/profile/profile.vue:362","后端未成功保存所有字段，中止操作"),void u({title:"资料保存不完整，请重试",icon:"none"});a("log","at pages/profile/profile.vue:370","所有字段已成功保存到后端"),o.user&&(o.user=r,uni.setStorageSync("userInfo",JSON.stringify(r)),a("log","at pages/profile/profile.vue:379","后端数据已缓存到本地存储"));try{uni.setStorageSync("hasCompletedFirstLogin","true"),a("log","at pages/profile/profile.vue:385","已标记用户完成首次登录")}catch(e){a("error","at pages/profile/profile.vue:387","保存登录状态失败:",e)}u({title:"保存成功",icon:"success"}),setTimeout((()=>{uni.switchTab({url:"/pages/index/index"}),s.value?a("log","at pages/profile/profile.vue:404","首次登录资料完善完成，跳转回首页"):a("log","at pages/profile/profile.vue:406","资料更新完成，跳转回首页")}),1500)}else u("后端保存失败，请重试")}catch(t){a("error","at pages/profile/profile.vue:413","保存个人资料失败:",t),u("保存失败，请重试")}finally{h.value=!1,m()}}))}function E(){uni.navigateBack()}return e.onMounted((()=>__async(this,null,(function*(){v.value=!0;try{a("log","at pages/profile/profile.vue:454","开始从服务器获取用户信息"),yield o.fetchUserInfo();let t=o.user;a("log","at pages/profile/profile.vue:460","服务器返回的用户信息:",t);const r=getCurrentPages(),n=r[r.length-1];let i=!1;n&&n.options&&(i="true"===n.options.firstLogin);let c=!1;try{c="true"===uni.getStorageSync("hasCompletedFirstLogin"),a("log","at pages/profile/profile.vue:476","用户是否已完成首次登录:",c)}catch(e){a("error","at pages/profile/profile.vue:478","读取登录状态失败:",e)}const d=function(e){if(!e)return a("log","at pages/profile/profile.vue:545","用户信息不存在"),!1;if(!e.nickname||!e.email)return a("log","at pages/profile/profile.vue:551","用户信息不完整: 缺少基本信息"),!1;if(!e.avatar||"/static/images/default-avatar.png"===e.avatar||"static/images/default-avatar.png"===e.avatar)return a("log","at pages/profile/profile.vue:559","用户信息不完整: 未上传头像"),!1;return!0}(t);if(s.value=!c&&!d&&i,a("log","at pages/profile/profile.vue:488","URL参数firstLogin:",i),a("log","at pages/profile/profile.vue:489","用户资料是否完整:",d),a("log","at pages/profile/profile.vue:490","最终判断是否首次登录:",s.value),d&&i)return a("log","at pages/profile/profile.vue:494","用户资料已完整，跳转到主页"),void setTimeout((()=>{uni.switchTab({url:"/pages/index/index"})}),500);if(t){const e=t.gender||"unknown";l.value={nickname:t.nickname||"",email:t.email||"",phone:t.phone||"",avatar:t.avatar||"",gender:e,bio:t.bio||""},a("log","at pages/profile/profile.vue:516","表单初始化数据:",l.value),a("log","at pages/profile/profile.vue:517","特别关注 - 性别信息:",{"原始用户性别":e,"表单性别":l.value.gender,"性别选项索引":p.value})}else u("获取用户信息失败");s.value&&u({title:"请完善您的个人信息",duration:3e3})}catch(t){a("error","at pages/profile/profile.vue:534","加载用户信息失败:",t),u("获取用户信息失败")}finally{v.value=!1}})))),(t,a)=>(e.openBlock(),e.createElementBlock("view",{class:"profile-container"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("view",{class:"header-title"},e.toDisplayString(s.value?"完善个人资料":"编辑个人资料"),1),s.value?(e.openBlock(),e.createElementBlock("view",{key:0,class:"first-login-tip"},"首次登录，请完善个人信息")):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"avatar-section"},[e.createElementVNode("view",{class:"avatar-wrapper"},[e.createElementVNode("image",{class:"avatar",src:i.value,mode:"aspectFill"},null,8,["src"]),r.value?(e.openBlock(),e.createElementBlock("view",{key:0,class:"avatar-loading"},[e.createElementVNode("text",{class:"loading-text"},"上传中...")])):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"change-avatar-btn",onClick:y},"更换头像")]),e.createElementVNode("view",{class:"form-section"},[e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label required"},"昵称"),e.withDirectives(e.createElementVNode("input",{class:"form-input",type:"text","onUpdate:modelValue":a[0]||(a[0]=e=>l.value.nickname=e),placeholder:"请输入昵称"},null,512),[[e.vModelText,l.value.nickname]])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label required"},"邮箱"),e.withDirectives(e.createElementVNode("input",{class:"form-input",type:"text","onUpdate:modelValue":a[1]||(a[1]=e=>l.value.email=e),placeholder:"请输入邮箱"},null,512),[[e.vModelText,l.value.email]])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label required"},"手机号码"),e.withDirectives(e.createElementVNode("input",{class:"form-input",type:"text","onUpdate:modelValue":a[2]||(a[2]=e=>l.value.phone=e),placeholder:"请输入手机号码"},null,512),[[e.vModelText,l.value.phone]])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"性别"),e.createElementVNode("picker",{class:"form-picker",mode:"selector",range:c,"range-key":"label",value:p.value,onChange:f},[e.createElementVNode("view",{class:"picker-text"},e.toDisplayString(c[p.value].label),1)],40,["value"])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"个人签名"),e.withDirectives(e.createElementVNode("textarea",{class:"form-textarea","onUpdate:modelValue":a[3]||(a[3]=e=>l.value.bio=e),placeholder:"请输入个人签名"},null,512),[[e.vModelText,l.value.bio]])])]),e.createElementVNode("view",{class:"button-section"},[e.createElementVNode("button",{class:"save-btn",disabled:!g.value||h.value,onClick:k},e.toDisplayString(h.value?"保存中...":"保存"),9,["disabled"]),s.value?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("button",{key:0,class:"cancel-btn",onClick:E},"取消"))])]))}};const We=he({components:{UserInfoPopup:fe},setup(){const t=X(),s=e.ref(!0),o=e.ref([]),r=e.ref(!1),n=e.ref(null),i=e.ref([]),l=e.ref(!1),c=e.ref(!1);e.onMounted((()=>__async(this,null,(function*(){yield u()}))));const u=()=>__async(this,null,(function*(){s.value=!0,c.value=!1;try{if(!t.isAuthenticated)return void uni.navigateTo({url:"/pages/login/login"});const e=t.userId||uni.getStorageSync("userId");if(!e)return uni.showToast({title:"无法获取用户信息",icon:"none"}),void(s.value=!1);const r=yield B.user.getFollowing(e);a("log","at pages/profile/following.vue:102","关注列表:",r),Array.isArray(r)?o.value=r.map((e=>__spreadProps(__spreadValues({},e),{isFollowing:!0}))):o.value=[]}catch(e){a("error","at pages/profile/following.vue:114","Failed to load following list:",e),s.value=!1,c.value=!0,uni.showToast({title:"加载失败，请重试",icon:"none"})}finally{s.value=!1}})),d=e=>__async(this,null,(function*(){if(t.isAuthenticated)try{const a=yield B.user.followUser(e._id);a&&void 0!==a.isFollowing&&(e.isFollowing=a.isFollowing,e.isFollowing||(o.value=o.value.filter((t=>t._id!==e._id))),uni.showToast({title:e.isFollowing?"关注成功":"取消关注成功",icon:"success"}),yield t.fetchUserStats())}catch(s){a("error","at pages/profile/following.vue:157","关注操作失败:",s),uni.showToast({title:"操作失败，请重试",icon:"none"})}else uni.navigateTo({url:"/pages/login/login"})}));return{isLoading:s,followingList:o,goBack:()=>{uni.navigateBack()},goExplore:()=>{uni.switchTab({url:"/pages/community/community"})},toggleFollow:d,viewUserProfile:e=>__async(this,null,(function*(){n.value=__spreadProps(__spreadValues({},e),{isCurrentUser:t.userId===e._id});try{const t=yield B.user.getPetsByUser(e._id);i.value=t||[],l.value=e.isFollowing||!1,r.value=!0}catch(s){a("error","at pages/profile/following.vue:183","获取用户详情失败:",s),i.value=[],r.value=!0}})),formatAvatarUrl:e=>{if(!e)return"/static/images/default-avatar.png";if(e.startsWith("http")||e.startsWith("/static"))return e;if(e.startsWith("/uploads")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}return"/static/images/default-avatar.png"},showUserPopup:r,selectedUser:n,selectedUserPets:i,isUserFollowing:l,closeUserPopup:()=>{r.value=!1},messageUser:e=>{a("log","at pages/profile/following.vue:197","发送消息给用户:",e)},followUser:e=>__async(this,null,(function*(){yield d(e),l.value=e.isFollowing||!1})),isRetryVisible:c,loadFollowingList:u}}},[["render",function(t,a,s,o,r,n){const i=e.resolveComponent("uni-nav-bar"),l=e.resolveComponent("uni-icons"),c=e.resolveComponent("UserInfoPopup");return e.openBlock(),e.createElementBlock("view",{class:"following-container"},[e.createVNode(i,{"left-icon":"back",onClickLeft:o.goBack,title:"我的关注"},null,8,["onClickLeft"]),o.isLoading?(e.openBlock(),e.createElementBlock("view",{key:0,class:"loading-container"},[e.createVNode(l,{type:"spinner-cycle",size:"24",color:"#ff5f15",class:"loading-icon"}),e.createElementVNode("text",{class:"loading-text"},"加载中...")])):o.isRetryVisible?(e.openBlock(),e.createElementBlock("view",{key:1,class:"retry-container"},[e.createElementVNode("text",{class:"error-text"},"加载失败，请重试"),e.createElementVNode("button",{class:"retry-button",onClick:a[0]||(a[0]=(...e)=>o.loadFollowingList&&o.loadFollowingList(...e))},"重试")])):0===o.followingList.length?(e.openBlock(),e.createElementBlock("view",{key:2,class:"empty-container"},[e.createElementVNode("image",{src:"/static/images/empty-list.png",class:"empty-image"}),e.createElementVNode("text",{class:"empty-text"},"还没有关注任何用户"),e.createElementVNode("button",{class:"explore-btn",onClick:a[1]||(a[1]=(...e)=>o.goExplore&&o.goExplore(...e))},"去探索")])):(e.openBlock(),e.createElementBlock("view",{key:3,class:"following-list"},[!o.isLoading&&o.followingList.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"user-list"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.followingList,((t,a)=>(e.openBlock(),e.createElementBlock("view",{class:"user-item",key:a,onClick:e=>o.viewUserProfile(t)},[e.createElementVNode("image",{class:"user-avatar",src:o.formatAvatarUrl(t.avatar),mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"user-info"},[e.createElementVNode("text",{class:"user-name"},e.toDisplayString(t.username||t.nickname||"用户"),1),t.bio?(e.openBlock(),e.createElementBlock("text",{key:0,class:"user-desc"},e.toDisplayString(t.bio),1)):e.createCommentVNode("",!0)]),e.createElementVNode("button",{class:e.normalizeClass(["follow-btn",{following:t.isFollowing}]),onClick:e.withModifiers((e=>o.toggleFollow(t)),["stop"])},e.toDisplayString(t.isFollowing?"已关注":"关注"),11,["onClick"])],8,["onClick"])))),128))])):e.createCommentVNode("",!0)])),o.showUserPopup?(e.openBlock(),e.createBlock(c,{key:4,user:o.selectedUser,pets:o.selectedUserPets,"is-following":o.isUserFollowing,visible:o.showUserPopup,onClose:o.closeUserPopup,onMessage:o.messageUser,onFollow:o.followUser},null,8,["user","pets","is-following","visible","onClose","onMessage","onFollow"])):e.createCommentVNode("",!0)])}]]);const ze=he({components:{UserInfoPopup:fe},setup(){const t=X(),s=e.ref(!0),o=e.ref([]),r=e.ref(!1),n=e.ref(null),i=e.ref([]),l=e.ref(!1),c=e.ref(!1);e.onMounted((()=>__async(this,null,(function*(){yield u()}))));const u=()=>__async(this,null,(function*(){s.value=!0,c.value=!1;try{if(!t.isAuthenticated)return void uni.navigateTo({url:"/pages/login/login"});const e=t.userId||uni.getStorageSync("userId");if(!e)return uni.showToast({title:"无法获取用户信息",icon:"none"}),void(s.value=!1);const r=yield B.user.getFollowers(e);a("log","at pages/profile/followers.vue:101","Followers list:",r),o.value=r;const n=(yield t.fetchUserInfo()).following||[];o.value=o.value.map((e=>__spreadProps(__spreadValues({},e),{isFollowing:n.some((t=>t===e._id||t._id&&t._id===e._id))})))}catch(e){a("error","at pages/profile/followers.vue:116","Failed to load followers:",e),s.value=!1,c.value=!0,uni.showToast({title:"加载失败，请重试",icon:"none"})}finally{s.value=!1}})),d=e=>__async(this,null,(function*(){if(t.isAuthenticated)try{const a=yield B.user.followUser(e._id);a&&void 0!==a.isFollowing&&(e.isFollowing=a.isFollowing,uni.showToast({title:e.isFollowing?"关注成功":"取消关注成功",icon:"success"}),yield t.fetchUserStats())}catch(s){a("error","at pages/profile/followers.vue:154","关注操作失败:",s),uni.showToast({title:"操作失败，请重试",icon:"none"})}else uni.navigateTo({url:"/pages/login/login"})}));return{isLoading:s,followersList:o,goBack:()=>{uni.navigateBack()},shareApp:()=>{uni.showToast({title:"分享功能开发中",icon:"none"})},toggleFollow:d,viewUserProfile:e=>__async(this,null,(function*(){n.value=__spreadProps(__spreadValues({},e),{isCurrentUser:t.userId===e._id});try{const t=yield B.user.getPetsByUser(e._id);i.value=t||[],l.value=e.isFollowing||!1,r.value=!0}catch(s){a("error","at pages/profile/followers.vue:180","获取用户详情失败:",s),i.value=[],r.value=!0}})),formatAvatarUrl:e=>{if(!e)return"/static/images/default-avatar.png";if(e.startsWith("http")||e.startsWith("/static"))return e;if(e.startsWith("/uploads")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}return"/static/images/default-avatar.png"},showUserPopup:r,selectedUser:n,selectedUserPets:i,isUserFollowing:l,closeUserPopup:()=>{r.value=!1},messageUser:e=>{a("log","at pages/profile/followers.vue:194","发送消息给用户:",e)},followUser:e=>__async(this,null,(function*(){yield d(e),l.value=e.isFollowing||!1})),isRetryVisible:c}}},[["render",function(t,a,s,o,r,n){const i=e.resolveComponent("uni-nav-bar"),l=e.resolveComponent("uni-icons"),c=e.resolveComponent("UserInfoPopup");return e.openBlock(),e.createElementBlock("view",{class:"followers-container"},[e.createVNode(i,{"left-icon":"back",onClickLeft:o.goBack,title:"粉丝列表"},null,8,["onClickLeft"]),o.isLoading?(e.openBlock(),e.createElementBlock("view",{key:0,class:"loading-container"},[e.createVNode(l,{type:"spinner-cycle",size:"24",color:"#ff5f15",class:"loading-icon"}),e.createElementVNode("text",{class:"loading-text"},"加载中...")])):o.isRetryVisible?(e.openBlock(),e.createElementBlock("view",{key:1,class:"retry-container"},[e.createElementVNode("text",{class:"error-text"},"加载失败，请重试"),e.createElementVNode("button",{class:"retry-button",onClick:a[0]||(a[0]=(...e)=>t.loadFollowersList&&t.loadFollowersList(...e))},"重试")])):0===o.followersList.length?(e.openBlock(),e.createElementBlock("view",{key:2,class:"empty-container"},[e.createElementVNode("image",{src:"/static/images/empty-followers.png",class:"empty-image"}),e.createElementVNode("text",{class:"empty-text"},"暂无粉丝")])):(e.openBlock(),e.createElementBlock("view",{key:3,class:"followers-list"},[!o.isLoading&&o.followersList.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"user-list"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.followersList,((t,a)=>(e.openBlock(),e.createElementBlock("view",{class:"user-item",key:a,onClick:e=>o.viewUserProfile(t)},[e.createElementVNode("image",{class:"user-avatar",src:o.formatAvatarUrl(t.avatar),mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"user-info"},[e.createElementVNode("text",{class:"user-name"},e.toDisplayString(t.username||t.nickname||"用户"),1),t.bio?(e.openBlock(),e.createElementBlock("text",{key:0,class:"user-desc"},e.toDisplayString(t.bio),1)):e.createCommentVNode("",!0)]),e.createElementVNode("button",{class:e.normalizeClass(["follow-btn",{following:t.isFollowing}]),onClick:e.withModifiers((e=>o.toggleFollow(t)),["stop"])},e.toDisplayString(t.isFollowing?"已关注":"关注"),11,["onClick"])],8,["onClick"])))),128))])):e.createCommentVNode("",!0)])),o.showUserPopup?(e.openBlock(),e.createBlock(c,{key:4,user:o.selectedUser,pets:o.selectedUserPets,"is-following":o.isUserFollowing,visible:o.showUserPopup,onClose:o.closeUserPopup,onMessage:o.messageUser,onFollow:o.followUser},null,8,["user","pets","is-following","visible","onClose","onMessage","onFollow"])):e.createCommentVNode("",!0)])}]]);const Je=new class{constructor(){this.messageCaches={nearby:[],city:[]},this.messageQueue=[],this.isProcessingQueue=!1,this.loadingStates={nearby:!1,city:!1},this.pagination={nearby:{page:1,limit:20,total:0},city:{page:1,limit:20,total:0}},this.networkStatus={isOnline:!0,lastChecked:Date.now()},this.checkNetworkStatus(),uni.onNetworkStatusChange((e=>{this.handleNetworkChange(e.isConnected)}))}getNearbyMessages(){return __async(this,arguments,(function*(e={}){try{this.loadingStates.nearby=!0,a("log","at utils/chatService.js:63","chatService开始获取附近消息, 参数:",e);const t=__spreadProps(__spreadValues({},e),{page:e.page||this.pagination.nearby.page,limit:e.limit||this.pagination.nearby.limit}),s=yield B.chat.getNearbyMessages(t);a("log","at utils/chatService.js:74","chatService获取到附近消息raw响应:",s),s&&s.pagination&&(this.pagination.nearby=s.pagination);let o=[];if(s&&s.data?o=s.data:Array.isArray(s)&&(o=s),a("log","at utils/chatService.js:91","chatService处理后的消息数据:",o),1===t.page)this.messageCaches.nearby=[...o];else{const e=this.messageCaches.nearby.map((e=>e.id)),t=o.filter((t=>!e.includes(t.id)));this.messageCaches.nearby=[...this.messageCaches.nearby,...t]}return this.messageCaches.nearby.length>50&&(this.messageCaches.nearby=this.messageCaches.nearby.slice(-50)),o}catch(t){if(a("error","at utils/chatService.js:110","获取附近消息失败:",t),this.isNetworkError(t)&&this.messageCaches.nearby.length>0)return a("log","at utils/chatService.js:114","使用缓存的附近消息"),this.messageCaches.nearby;throw t}finally{this.loadingStates.nearby=!1}}))}getCityMessages(){return __async(this,arguments,(function*(e={}){try{if(this.loadingStates.city=!0,a("log","at utils/chatService.js:132","chatService开始获取城市消息, 参数:",e),!e.cityName)return a("error","at utils/chatService.js:135","城市名称不能为空"),[];const t=__spreadProps(__spreadValues({},e),{page:e.page||this.pagination.city.page,limit:e.limit||this.pagination.city.limit}),s=yield B.chat.getCityMessages(t);a("log","at utils/chatService.js:148","chatService获取到城市消息raw响应:",s),s&&s.pagination&&(this.pagination.city=s.pagination);let o=[];if(s&&s.data?o=s.data:Array.isArray(s)&&(o=s),a("log","at utils/chatService.js:165","chatService处理后的城市消息数据:",o),1===t.page)this.messageCaches.city=[...o];else{const e=this.messageCaches.city.map((e=>e.id)),t=o.filter((t=>!e.includes(t.id)));this.messageCaches.city=[...this.messageCaches.city,...t]}return this.messageCaches.city.length>50&&(this.messageCaches.city=this.messageCaches.city.slice(-50)),o}catch(t){if(a("error","at utils/chatService.js:184","获取城市消息失败:",t),this.isNetworkError(t)&&this.messageCaches.city.length>0)return a("log","at utils/chatService.js:188","使用缓存的城市消息"),this.messageCaches.city;throw t}finally{this.loadingStates.city=!1}}))}sendNearbyMessage(e){return __async(this,null,(function*(){return this.sendMessage("nearby",e)}))}sendCityMessage(e){return __async(this,null,(function*(){return this.sendMessage("city",e)}))}sendMessage(e,t){return __async(this,null,(function*(){const a={id:"temp-"+Date.now()+"-"+Math.floor(1e3*Math.random()),content:t.content,createTime:(new Date).getTime(),status:"sending",type:e,data:t,retryCount:0};return this.messageQueue.push(a),this.isProcessingQueue||this.processMessageQueue(),a}))}processMessageQueue(){return __async(this,null,(function*(){if(0!==this.messageQueue.length&&!this.isProcessingQueue){if(this.isProcessingQueue=!0,!this.networkStatus.isOnline)return a("log","at utils/chatService.js:261","网络离线，暂停处理消息队列"),void(this.isProcessingQueue=!1);try{const e=this.messageQueue[0];let t;"nearby"===e.type?t=yield B.chat.sendNearbyMessage(e.data):"city"===e.type&&(t=yield B.chat.sendCityMessage(e.data)),t&&(a("log","at utils/chatService.js:280","消息发送成功:",t),this.messageQueue.shift(),this.updateMessageStatus(e.id,"sent",t))}catch(e){a("error","at utils/chatService.js:289","发送消息失败:",e);const t=this.messageQueue[0];t.retryCount++,t.retryCount>=3?(a("log","at utils/chatService.js:299",`消息 ${t.id} 重试失败 ${t.retryCount} 次，放弃重试`),this.messageQueue.shift(),this.updateMessageStatus(t.id,"failed")):a("log","at utils/chatService.js:304",`消息 ${t.id} 发送失败，将在 2000ms 后重试 (${t.retryCount}/3)`)}finally{this.isProcessingQueue=!1,this.messageQueue.length>0&&setTimeout((()=>{this.processMessageQueue()}),2e3)}}}))}updateMessageStatus(e,t,s=null){a("log","at utils/chatService.js:327","消息状态更新:",e,t,s),uni.$emit("chat:message-status-update",{messageId:e,status:t,serverData:s})}isNetworkError(e){var t,a,s;return(null==(t=e.message)?void 0:t.includes("网络"))||(null==(a=e.message)?void 0:a.includes("Network"))||(null==(s=e.message)?void 0:s.includes("timeout"))||0===e.statusCode||!this.networkStatus.isOnline}checkNetworkStatus(){uni.getNetworkType({success:e=>{const t="none"!==e.networkType;this.handleNetworkChange(t)}})}handleNetworkChange(e){const t=this.networkStatus.isOnline;this.networkStatus.isOnline=e,this.networkStatus.lastChecked=Date.now(),a("log","at utils/chatService.js:373","网络状态更新:",e?"在线":"离线"),!t&&e&&(a("log","at utils/chatService.js:377","网络已恢复，重新处理消息队列"),setTimeout((()=>{this.processMessageQueue()}),1e3)),uni.$emit("chat:network-status-change",{isOnline:e})}};const qe=new class{constructor(){this.status=e.reactive({isConnected:!0,networkType:"unknown",lastChecked:Date.now()}),this.listeners=[],this.checkNetworkStatus(),this.setupListeners()}setupListeners(){uni.onNetworkStatusChange((e=>{this.handleNetworkChange(e)})),setInterval((()=>{this.checkNetworkStatus()}),3e4)}checkNetworkStatus(){return new Promise((e=>{uni.getNetworkType({success:t=>{this.handleNetworkChange(t),e(this.status)},fail:()=>{this.handleNetworkChange({isConnected:!1,networkType:"none"}),e(this.status)}})}))}handleNetworkChange(e){const t=this.status.isConnected;this.status.isConnected=void 0!==e.isConnected?e.isConnected:"none"!==e.networkType,this.status.networkType=e.networkType||"unknown",this.status.lastChecked=Date.now(),a("log","at utils/networkManager.js:73",`网络状态变化: ${this.status.isConnected?"在线":"离线"}, 类型: ${this.status.networkType}`),uni.$emit("network:status-change",__spreadValues({},this.status)),this.notifyListeners(),!t&&this.status.isConnected&&(a("log","at utils/networkManager.js:83","网络已恢复连接"),uni.$emit("network:reconnected",__spreadValues({},this.status))),t&&!this.status.isConnected&&(a("log","at utils/networkManager.js:89","网络已断开连接"),uni.$emit("network:disconnected",__spreadValues({},this.status)),uni.showToast({title:"网络已断开，请检查网络连接",icon:"none",duration:2e3}))}addListener(e){return"function"!=typeof e?(a("error","at utils/networkManager.js:108","网络状态监听器必须是函数"),()=>{}):(this.listeners.push(e),e(__spreadValues({},this.status)),()=>{this.removeListener(e)})}removeListener(e){const t=this.listeners.indexOf(e);-1!==t&&this.listeners.splice(t,1)}notifyListeners(){const e=__spreadValues({},this.status);this.listeners.forEach((t=>{try{t(e)}catch(s){a("error","at utils/networkManager.js:143","网络状态监听器回调错误:",s)}}))}getStatus(){return __spreadValues({},this.status)}isOnline(){return this.status.isConnected}isGoodConnection(){return!!this.status.isConnected&&("wifi"===this.status.networkType||"4g"===this.status.networkType||"5g"===this.status.networkType)}},He="chat_nearby_messages",Ge="chat_city_messages",Qe=6048e5;function Ke(){try{const e=uni.getStorageSync("chat_pending_messages");if(e){return JSON.parse(e).messages||[]}}catch(e){a("error","at utils/chatStorage.js:214","读取待处理消息失败:",e)}return[]}const Ye={getNearbyMessagesCache:function(e=""){const t=e?`${He}_${e}`:He;try{const e=uni.getStorageSync(t);if(e){const s=JSON.parse(e);return s.timestamp&&Date.now()-s.timestamp>Qe?(a("log","at utils/chatStorage.js:26","附近消息缓存已过期，清除缓存"),uni.removeStorageSync(t),[]):s.messages||[]}}catch(s){a("error","at utils/chatStorage.js:34","读取附近消息缓存失败:",s)}return[]},saveNearbyMessagesCache:function(e,t=""){if(!Array.isArray(e))return void a("error","at utils/chatStorage.js:46","保存的消息必须是数组");const s=t?`${He}_${t}`:He;try{const t={messages:e.slice(-100),timestamp:Date.now()};uni.setStorageSync(s,JSON.stringify(t))}catch(o){a("error","at utils/chatStorage.js:62","保存附近消息缓存失败:",o)}},getCityMessagesCache:function(e){if(!e)return a("error","at utils/chatStorage.js:73","获取城市消息缓存需要城市名称"),[];const t=`${Ge}_${e}`;try{const s=uni.getStorageSync(t);if(s){const o=JSON.parse(s);return o.timestamp&&Date.now()-o.timestamp>Qe?(a("log","at utils/chatStorage.js:85",`城市【${e}】消息缓存已过期，清除缓存`),uni.removeStorageSync(t),[]):o.messages||[]}}catch(s){a("error","at utils/chatStorage.js:93",`读取城市【${e}】消息缓存失败:`,s)}return[]},saveCityMessagesCache:function(e,t){if(!Array.isArray(e))return void a("error","at utils/chatStorage.js:105","保存的消息必须是数组");if(!t)return void a("error","at utils/chatStorage.js:110","保存城市消息缓存需要城市名称");const s=`${Ge}_${t}`;try{const t={messages:e.slice(-100),timestamp:Date.now()};uni.setStorageSync(s,JSON.stringify(t))}catch(o){a("error","at utils/chatStorage.js:126",`保存城市【${t}】消息缓存失败:`,o)}},clearExpiredMessageCaches:function(){try{const e=uni.getStorageInfoSync().keys;e.filter((e=>e.startsWith(He)||e.startsWith(Ge))).forEach((e=>{try{const t=uni.getStorageSync(e);if(t){const s=JSON.parse(t);s.timestamp&&Date.now()-s.timestamp>Qe&&(a("log","at utils/chatStorage.js:153",`缓存【${e}】已过期，清除缓存`),uni.removeStorageSync(e))}}catch(t){a("warn","at utils/chatStorage.js:159",`缓存【${e}】数据无效，清除缓存`),uni.removeStorageSync(e)}})),a("log","at utils/chatStorage.js:164","清理过期缓存完成")}catch(e){a("error","at utils/chatStorage.js:166","清理过期缓存失败:",e)}},savePendingMessage:function(e){if(e&&e.id)try{const t=Ke(),a=t.findIndex((t=>t.id===e.id));-1!==a?t[a]=e:t.push(e),uni.setStorageSync("chat_pending_messages",JSON.stringify({messages:t,timestamp:Date.now()}))}catch(t){a("error","at utils/chatStorage.js:198","保存待处理消息失败:",t)}else a("error","at utils/chatStorage.js:176","保存的消息对象无效")},getPendingMessages:Ke,removePendingMessage:function(e){if(e)try{const t=Ke().filter((t=>t.id!==e));uni.setStorageSync("chat_pending_messages",JSON.stringify({messages:t,timestamp:Date.now()}))}catch(t){a("error","at utils/chatStorage.js:235","移除待处理消息失败:",t)}},getPrivateMessages:function(e){if(!e)return a("error","at utils/chatStorage.js:246","获取私聊消息缓存需要缓存键"),[];try{const t=uni.getStorageSync(e);if(t){const s=JSON.parse(t);return s.timestamp&&Date.now()-s.timestamp>Qe?(a("log","at utils/chatStorage.js:257",`私聊消息缓存【${e}】已过期，清除缓存`),uni.removeStorageSync(e),[]):s.messages||[]}}catch(t){a("error","at utils/chatStorage.js:265",`读取私聊消息缓存【${e}】失败:`,t)}return[]},savePrivateMessages:function(e,t){if(Array.isArray(e))if(t)try{const a={messages:e.slice(-100),timestamp:Date.now()};uni.setStorageSync(t,JSON.stringify(a))}catch(s){a("error","at utils/chatStorage.js:297",`保存私聊消息缓存【${t}】失败:`,s)}else a("error","at utils/chatStorage.js:282","保存私聊消息缓存需要缓存键");else a("error","at utils/chatStorage.js:277","保存的消息必须是数组")}},Xe="/static/images/empty-message.png";const Ze=he({setup(){const t=X(),s=e.computed((()=>t.user||{})),l=e.computed((()=>s.value.id||s.value._id||"")),c=e.ref({}),u=e.ref(""),d=e.ref(!1),m=e.ref([]),p=e.ref(!1),g=e.ref(!1),v=e.ref(!1),h=e.ref(0),f=e.ref(null),y=e.ref(null),w=e.ref(!1),k=e.ref(""),E=e.ref(!1),N=e.ref({isConnected:!0,networkType:"unknown"}),S=e.ref(!0),V=e.ref(1);let _=null,P=null;const I=()=>{if(!l.value||!u.value)return null;return`private_chat_${[l.value,u.value].sort().join("_")}`},x=()=>__async(this,null,(function*(){if(u.value)try{const e=yield B.user.getUserInfo(u.value);e&&(e.id||e._id)?c.value=e:(a("warn","at pages/chat/chat.vue:201","获取用户信息失败，使用临时数据"),c.value={id:u.value,username:"聊天用户",avatar:"/static/images/default-avatar.png"}),D()}catch(e){a("error","at pages/chat/chat.vue:213","加载用户信息失败:",e);try{const e=I();if(e){const t=uni.getStorageSync(`${e}_user`);if(t){const e=JSON.parse(t);c.value=e,a("log","at pages/chat/chat.vue:223","使用缓存的用户信息:",e)}}}catch(t){a("error","at pages/chat/chat.vue:227","读取缓存用户信息失败:",t)}uni.showToast({title:"加载用户信息失败",icon:"none"})}})),b=(t=!1)=>__async(this,null,(function*(){if(u.value&&l.value)if(!p.value||t)try{p.value=!0,t&&(V.value=1,v.value=!1,y.value=null);const o={targetUserId:u.value,page:V.value,limit:20};y.value&&!t&&(o.beforeMessageId=y.value),a("log","at pages/chat/chat.vue:267","加载消息, 参数:",o);let r=[];try{if(B.chat.getPrivateMessages){const e=yield B.chat.getPrivateMessages(o);r=(null==e?void 0:e.data)||e||[]}else a("warn","at pages/chat/chat.vue:279","没有找到私聊消息API，使用模拟数据"),r=t?Array(5).fill().map(((e,t)=>({id:`msg-${Date.now()}-${t}`,content:`这是一条模拟消息 ${t+1}`,senderId:t%2==0?l.value:u.value,receiverId:t%2==0?u.value:l.value,createTime:new Date(Date.now()-6e4*t).getTime(),status:"sent"}))):Array(3).fill().map(((e,t)=>({id:`msg-old-${Date.now()}-${t}`,content:`这是更早的模拟消息 ${t+1}`,senderId:t%2==0?l.value:u.value,receiverId:t%2==0?u.value:l.value,createTime:new Date(Date.now()-6e4*(t+10)).getTime(),status:"sent"})))}catch(s){if(a("error","at pages/chat/chat.vue:304","API调用失败:",s),qe.isNetworkError(s)){const e=I();if(e){const t=Ye.getPrivateMessages(e);t&&t.length>0&&(r=t,a("log","at pages/chat/chat.vue:313","从缓存加载私聊消息",r.length))}}0===r.length&&t&&(r=[{id:`temp-${Date.now()}`,content:"网络连接不佳，无法加载消息历史",senderId:"system",createTime:Date.now(),status:"info",isSystemMessage:!0}])}if(r&&r.length>0){if(t)m.value=r;else{const e=m.value.map((e=>e.id)),t=r.filter((t=>!e.includes(t.id)));if(t.length>0){if(m.value=[...t,...m.value],V.value++,t.length>0){const e=[...t].sort(((e,t)=>new Date(e.createTime)-new Date(t.createTime)))[0];e&&(y.value=e.id,a("log","at pages/chat/chat.vue:354","更新最后加载的消息ID:",y.value))}}else v.value=!0,a("log","at pages/chat/chat.vue:359","没有更多历史消息了")}const s=I();s&&(Ye.savePrivateMessages(m.value,s),c.value&&(c.value.id||c.value._id)&&uni.setStorageSync(`${s}_user`,JSON.stringify(c.value))),t&&(yield e.nextTick(),A())}else t||(v.value=!0);M()}catch(o){a("error","at pages/chat/chat.vue:389","加载消息失败:",o),uni.showToast({title:"加载消息失败，请检查网络连接",icon:"none"})}finally{p.value=!1,g.value=!1}else a("log","at pages/chat/chat.vue:242","已有加载请求进行中，跳过")})),C=()=>__async(this,null,(function*(){u.value&&l.value&&!p.value&&!v.value?(g.value=!0,yield b(),g.value=!1):g.value=!1})),T=e=>__async(this,null,(function*(){const t=m.value.findIndex((t=>t.id===e));if(-1===t)return;const s=m.value[t];m.value[t].status="sending";try{let r;try{B.chat.sendPrivateMessage?r=yield B.chat.sendPrivateMessage({receiverId:u.value,content:s.content}):(a("warn","at pages/chat/chat.vue:544","没有找到发送私聊消息API，模拟发送成功"),yield new Promise((e=>setTimeout(e,500))),r={id:"msg-"+Date.now(),status:"sent"}),m.value[t].status="sent",r&&(r.id||r._id)&&(m.value[t].id=r.id||r._id);const o=I();o&&Ye.savePrivateMessages(m.value,o),Ye.removePendingMessage(e)}catch(o){throw o}}catch(r){a("error","at pages/chat/chat.vue:572","重试发送消息失败:",r),m.value[t].status="failed";const e=I();e&&Ye.savePrivateMessages(m.value,e),uni.showToast({title:"发送消息失败，请检查网络",icon:"none"})}})),M=()=>__async(this,null,(function*(){if(u.value&&l.value)if(B.chat.markMessagesAsRead)try{yield B.chat.markMessagesAsRead(u.value),a("log","at pages/chat/chat.vue:598","标记消息已读成功")}catch(e){a("error","at pages/chat/chat.vue:600","标记消息已读失败:",e)}else a("log","at pages/chat/chat.vue:603","没有找到标记消息已读API")})),D=()=>__async(this,null,(function*(){if(u.value)try{if(B.user.checkUserOnline){const e=yield B.user.checkUserOnline(u.value);d.value=(null==e?void 0:e.isOnline)||!1}else d.value=Math.random()>.5}catch(e){a("error","at pages/chat/chat.vue:621","检查用户在线状态失败:",e),d.value=!1}})),A=()=>{h.value=Math.random(),e.nextTick((()=>{uni.createSelectorQuery().in(this).select(".message-list").boundingClientRect((e=>{e&&(h.value=99999)})).exec()}))},U=()=>{P&&(clearInterval(P),P=null),P=setInterval((()=>{S.value&&N.value.isConnected&&(a("log","at pages/chat/chat.vue:663","自动刷新消息"),b(!0))}),15e3)};return n((e=>{u.value=e.userId||(uni.getLaunchOptionsSync().query||{}).userId||"",u.value?(qe.addListener((e=>{N.value=e,a("log","at pages/chat/chat.vue:166","网络状态更新:",e),e.isConnected&&S.value&&(a("log","at pages/chat/chat.vue:170","网络恢复，刷新消息"),b(!0))})),x(),(()=>{const e=Ye.getPendingMessages();e&&e.length>0&&(a("log","at pages/chat/chat.vue:673","恢复待处理私聊消息"),e.forEach((e=>{"private"===e.type&&e.data.receiverId===u.value&&(-1===m.value.findIndex((t=>t.id===e.id))&&m.value.push({id:e.id,content:e.content,createTime:e.createTime,senderId:l.value,receiverId:u.value,status:e.status}),"sending"!==e.status&&"failed"!==e.status||T(e.id))})))})(),b(!0),U(),_=setInterval(D,3e4)):(uni.showToast({title:"用户ID不能为空",icon:"none"}),setTimeout((()=>{uni.navigateBack()}),1500))})),o((()=>{S.value=!0,D(),M(),w.value&&N.value.isConnected&&(b(!0),w.value=!1),U()})),r((()=>{S.value=!1,P&&(clearInterval(P),P=null)})),i((()=>{_&&(clearInterval(_),_=null),P&&(clearInterval(P),P=null)})),{chatUser:c,isOnline:d,messages:m,isLoading:p,isRefreshing:g,noMoreMessages:v,scrollTop:h,messageList:f,newMessage:k,inputFocus:E,userInfo:s,userId:l,loadMoreMessages:C,sendMessage:()=>__async(this,null,(function*(){if(!k.value.trim()||!u.value||!l.value)return;if(!N.value.isConnected)return void uni.showToast({title:"网络不可用，请检查网络连接",icon:"none"});const t=k.value.trim();k.value="";const s="temp-"+Date.now(),o={id:s,content:t,createTime:(new Date).getTime(),senderId:l.value,receiverId:u.value,status:"sending"};m.value.push(o);const r=I();r&&Ye.savePrivateMessages(m.value,r),yield e.nextTick(),A();try{let e;try{B.chat.sendPrivateMessage?e=yield B.chat.sendPrivateMessage({receiverId:u.value,content:t}):(a("warn","at pages/chat/chat.vue:464","没有找到发送私聊消息API，模拟发送成功"),yield new Promise((e=>setTimeout(e,500))),e={id:"msg-"+Date.now(),status:"sent"});const o=m.value.findIndex((e=>e.id===s));-1!==o&&(m.value[o].status="sent",e&&(e.id||e._id)&&(m.value[o].id=e.id||e._id||s),r&&Ye.savePrivateMessages(m.value,r))}catch(n){throw n}}catch(i){a("error","at pages/chat/chat.vue:491","发送消息失败:",i);const e=m.value.findIndex((e=>e.id===s));-1!==e&&(m.value[e].status="failed",r&&Ye.savePrivateMessages(m.value,r)),Ye.savePendingMessage(__spreadProps(__spreadValues({},o),{type:"private",data:{receiverId:u.value,content:t}})),uni.showToast({title:"发送消息失败，请检查网络",icon:"none"})}})),retryMessage:T,backToList:()=>{uni.navigateBack()},shouldShowDate:(e,t)=>{if(0===t)return!0;const a=m.value[t-1],s=new Date(a.createTime),o=new Date(e.createTime);return o-s>18e5||s.toDateString()!==o.toDateString()},formatDate:e=>{if(!e)return"";const t=new Date(e),a=new Date;if(t.toDateString()===a.toDateString())return"今天 "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0");const s=new Date;if(s.setDate(s.getDate()-1),t.toDateString()===s.toDateString())return"昨天 "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0");const o=["日","一","二","三","四","五","六"];return Math.floor((a-t)/864e5)<7?"星期"+o[t.getDay()]+" "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0"):t.getFullYear()!==a.getFullYear()?t.getFullYear()+"年"+(t.getMonth()+1)+"月"+t.getDate()+"日 "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0"):t.getMonth()+1+"月"+t.getDate()+"日 "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0")},formatAvatarUrl:e=>{if(!e)return"/static/images/default-avatar.png";if(e.startsWith("http")||e.startsWith("/static"))return e;if(e.startsWith("/uploads")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}return"/static/images/default-avatar.png"},onScrollToUpper:()=>{p.value||v.value||C()}}}},[["render",function(t,a,s,o,r,n){return e.openBlock(),e.createElementBlock("view",{class:"container"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("view",{class:"back",onClick:a[0]||(a[0]=(...e)=>o.backToList&&o.backToList(...e))},[e.createElementVNode("text",{class:"back-icon"},"←")]),e.createElementVNode("view",{class:"user-info"},[e.createElementVNode("text",{class:"username"},e.toDisplayString(o.chatUser.nickname||o.chatUser.username||"用户"),1),o.isOnline?(e.openBlock(),e.createElementBlock("text",{key:0,class:"status"},"在线")):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"action"},[e.createElementVNode("text",{class:"more-icon"},"⋮")])]),e.createElementVNode("scroll-view",{class:"message-list","scroll-y":"true","scroll-top":o.scrollTop,"scroll-with-animation":!0,"refresher-triggered":o.isRefreshing,"refresher-enabled":"",onRefresherrefresh:a[1]||(a[1]=(...e)=>o.loadMoreMessages&&o.loadMoreMessages(...e)),onScrolltoupper:a[2]||(a[2]=(...e)=>o.onScrollToUpper&&o.onScrollToUpper(...e)),ref:"messageList"},[o.isLoading&&o.messages.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"refresh-tip"},[e.createElementVNode("text",null,"加载更多消息...")])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"messages-container"},[o.noMoreMessages&&o.messages.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"no-more"},[e.createElementVNode("text",null,"没有更多消息了")])):e.createCommentVNode("",!0),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.messages,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:t.id||a,class:e.normalizeClass(["message-item",{"own-message":t.senderId===o.userId}])},[o.shouldShowDate(t,a)?(e.openBlock(),e.createElementBlock("view",{key:0,class:"date-divider"},[e.createElementVNode("text",null,e.toDisplayString(o.formatDate(t.createTime)),1)])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"message-content"},[t.senderId!==o.userId?(e.openBlock(),e.createElementBlock("image",{key:0,class:"avatar",src:o.formatAvatarUrl(o.chatUser.avatar),mode:"aspectFill"},null,8,["src"])):(e.openBlock(),e.createElementBlock("view",{key:1,class:"avatar-placeholder"})),e.createElementVNode("view",{class:e.normalizeClass(["bubble",{"own-bubble":t.senderId===o.userId}])},[e.createElementVNode("text",{class:"message-text"},e.toDisplayString(t.content),1)],2),t.senderId===o.userId?(e.openBlock(),e.createElementBlock("image",{key:2,class:"avatar",src:o.formatAvatarUrl(o.userInfo.avatar),mode:"aspectFill"},null,8,["src"])):(e.openBlock(),e.createElementBlock("view",{key:3,class:"avatar-placeholder"}))])],2)))),128))]),0!==o.messages.length||o.isLoading?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("view",{key:1,class:"empty-state"},[e.createElementVNode("image",{class:"empty-icon",src:Xe,mode:"aspectFit"}),e.createElementVNode("text",{class:"empty-text"},"暂无消息"),e.createElementVNode("text",{class:"empty-tip"},"发送消息开始聊天吧")]))],40,["scroll-top","refresher-triggered"]),e.createElementVNode("view",{class:"input-area"},[e.withDirectives(e.createElementVNode("input",{type:"text",class:"message-input","onUpdate:modelValue":a[3]||(a[3]=e=>o.newMessage=e),placeholder:"输入消息...",focus:o.inputFocus,"confirm-type":"send",onConfirm:a[4]||(a[4]=(...e)=>o.sendMessage&&o.sendMessage(...e))},null,40,["focus"]),[[e.vModelText,o.newMessage]]),e.createElementVNode("view",{class:e.normalizeClass(["send-btn",{active:o.newMessage.trim()}]),onClick:a[5]||(a[5]=(...e)=>o.sendMessage&&o.sendMessage(...e))},[e.createElementVNode("text",null,"发送")],2)])])}]]);const et=he({setup(){const t=X(),s=te(),l=e.computed((()=>t.user||{})),c=e.computed((()=>l.value.id||l.value._id||"")),u=e.ref("nearby"),d=e.ref({isConnected:!0,networkType:"unknown"}),m=e.reactive({latitude:null,longitude:null,address:"",city:"",district:"",lastUpdated:null}),p=e.ref([]),g=e.ref([]),v=e.ref(0),h=e.ref(0),f=e.ref(!1),y=e.ref(!1),w=e.ref(!1),k=e.ref(!1),E=e.ref(""),N=e.ref(!1),S=e.ref(!0),V=e.ref(1),_=e.ref(1);let P=null;const I=e.ref(!0),x=e.ref({atBottom:!0}),b=e.ref({atBottom:!0}),C=()=>__async(this,null,(function*(){try{a("log","at pages/chat/index.vue:317","开始初始化位置信息");const e=s.location;e&&e.latitude&&e.longitude&&(a("log","at pages/chat/index.vue:321","从store获取到位置信息:",e),m.latitude=e.latitude,m.longitude=e.longitude,m.address=e.address||"",m.city=e.city||"",m.district=e.district||"",m.lastUpdated=e.lastUpdated||Date.now(),a("log","at pages/chat/index.vue:329","成功设置位置信息到currentLocation:",m));const t=6e5;!m.latitude||!m.longitude||!m.lastUpdated||Date.now()-m.lastUpdated>t?(a("log","at pages/chat/index.vue:337","位置信息不存在或已过期，重新获取"),yield T()):(a("log","at pages/chat/index.vue:341","使用现有位置信息加载消息"),yield M(),R(),setTimeout((()=>{R()}),500))}catch(e){a("error","at pages/chat/index.vue:353","初始化位置信息失败:",e),uni.showToast({title:"获取位置信息失败，请检查定位权限",icon:"none"})}})),T=()=>__async(this,null,(function*(){try{uni.showLoading({title:"获取位置中...",mask:!1}),a("log","at pages/chat/index.vue:369","开始获取位置");const t=yield ie();a("log","at pages/chat/index.vue:371","获取到位置:",t),t&&t.latitude&&t.longitude?(m.latitude=t.latitude,m.longitude=t.longitude,m.address=t.address||"",m.city=t.city||"",m.district=t.district||"",m.lastUpdated=Date.now(),s.updateLocation({latitude:t.latitude,longitude:t.longitude,address:t.address,city:t.city,district:t.district,lastUpdated:Date.now(),timestamp:(new Date).toISOString()}),a("log","at pages/chat/index.vue:393","位置获取成功，刷新消息，当前位置:",m),uni.hideLoading(),yield e.nextTick(),M()):(a("error","at pages/chat/index.vue:398","获取到的位置数据不完整:",t),uni.hideLoading(),uni.showToast({title:"获取位置信息不完整，请检查定位权限",icon:"none",duration:2e3}))}catch(t){a("error","at pages/chat/index.vue:407","刷新位置信息失败:",t),uni.hideLoading(),uni.showToast({title:"获取位置信息失败，请检查定位权限",icon:"none"})}})),M=()=>__async(this,null,(function*(){if(a("log","at pages/chat/index.vue:418","refreshMessages被调用，当前标签:",u.value),a("log","at pages/chat/index.vue:419","当前位置信息:",m),!m.latitude||!m.longitude)return a("warn","at pages/chat/index.vue:423","刷新消息失败：位置信息不存在"),void uni.showToast({title:"无法获取位置信息，请点击刷新按钮",icon:"none"});try{uni.showLoading({title:"加载中...",mask:!1}),"nearby"===u.value?(a("log","at pages/chat/index.vue:439","开始刷新附近消息"),yield D(!0)):(a("log","at pages/chat/index.vue:442","开始刷新城市消息"),yield A(!0)),uni.hideLoading(),a("log","at pages/chat/index.vue:449","消息刷新完成"),setTimeout((()=>{"nearby"===u.value?v.value=999999:h.value=999999}),100),setTimeout((()=>{"nearby"===u.value?v.value=999999:h.value=999999}),300)}catch(e){uni.hideLoading(),a("error","at pages/chat/index.vue:470","刷新消息时发生错误:",e),uni.showToast({title:"加载消息失败，请稍后再试",icon:"none"})}})),D=(t=!1)=>__async(this,null,(function*(){if(!m.latitude||!m.longitude){a("log","at pages/chat/index.vue:481","位置信息不存在，尝试从store获取");const e=s.location;if(!(e&&e.latitude&&e.longitude))return a("log","at pages/chat/index.vue:493","无法获取位置信息，显示提示"),void uni.showToast({title:"无法获取位置信息，请检查定位权限",icon:"none"});m.latitude=e.latitude,m.longitude=e.longitude,m.address=e.address||"",m.city=e.city||"",m.district=e.district||"",m.lastUpdated=e.lastUpdated||Date.now(),a("log","at pages/chat/index.vue:491","成功从store获取位置信息:",m)}if(!y.value||t)try{y.value=!0,t&&(V.value=1,w.value=!1);const s={latitude:m.latitude,longitude:m.longitude,radius:5e3,page:1,limit:30,sort:"desc"};t||(s.page=V.value),a("log","at pages/chat/index.vue:531","加载附近消息, 参数:",s);const o=yield B.chat.getNearbyMessages(s);a("log","at pages/chat/index.vue:535","API直接返回的附近消息:",o);let r=[];if(o&&o.data?r=o.data:Array.isArray(o)&&(r=o),r.sort(((e,t)=>new Date(e.createTime)-new Date(t.createTime))),a("log","at pages/chat/index.vue:550","处理后的消息数据:",r),r&&r.length>0)t?(p.value=[...r],a("log","at pages/chat/index.vue:557","刷新消息列表，当前消息数:",p.value.length),yield e.nextTick(),U(!0)):(p.value=[...r,...p.value],a("log","at pages/chat/index.vue:565","追加历史消息，当前消息数:",p.value.length)),Ye.saveNearbyMessagesCache(p.value),V.value++;else if(t||(w.value=!0,a("log","at pages/chat/index.vue:577","没有更多消息")),t&&(!r||0===r.length)){const e=Ye.getNearbyMessagesCache();e&&e.length>0&&(a("log","at pages/chat/index.vue:584","从缓存加载附近消息"),e.sort(((e,t)=>new Date(e.createTime)-new Date(t.createTime))),p.value=e)}}catch(o){if(a("error","at pages/chat/index.vue:592","加载附近消息失败:",o),qe.isNetworkError&&qe.isNetworkError(o)){const e=Ye.getNearbyMessagesCache();e&&e.length>0&&(a("log","at pages/chat/index.vue:598","网络错误，从缓存加载附近消息"),(t||0===p.value.length)&&(p.value=e))}uni.showToast({title:"加载消息失败，请检查网络连接",icon:"none"})}finally{y.value=!1}else a("log","at pages/chat/index.vue:503","已有加载请求进行中，跳过")})),A=(t=!1)=>__async(this,null,(function*(){if(!m.city){if(a("log","at pages/chat/index.vue:620","城市信息不存在，尝试从地址中提取"),m.address){const e=m.address.split("市");if(e.length>0){const t=e[0].match(/([^省]+?)市/);if(t&&t[1])m.city=t[1],a("log","at pages/chat/index.vue:630","从地址中提取的城市:",m.city);else{const e=m.address.split(/[省市区县]/);e.length>1&&(m.city=e[1].trim(),a("log","at pages/chat/index.vue:636","从地址分割中提取的城市:",m.city))}}}if(!m.city&&m.latitude&&m.longitude){a("log","at pages/chat/index.vue:644","从经纬度反查城市信息");try{const e=yield ie();e&&e.city?(m.city=e.city,a("log","at pages/chat/index.vue:650","从getCurrentLocation获取到城市:",m.city)):(m.city="上海市",a("log","at pages/chat/index.vue:654","无法获取城市信息，使用默认城市"))}catch(o){a("error","at pages/chat/index.vue:657","反查城市出错:",o),m.city="上海市"}}m.city||(a("log","at pages/chat/index.vue:664","无法获取城市信息，使用默认城市"),m.city="上海市"),m.latitude&&m.longitude?s.updateLocation(__spreadProps(__spreadValues({},s.location),{city:m.city,latitude:m.latitude,longitude:m.longitude,timestamp:(new Date).toISOString()})):a("log","at pages/chat/index.vue:678","无法更新位置store：缺少经纬度信息")}if(!y.value||t)try{y.value=!0,t&&(_.value=1,k.value=!1);const s={cityName:m.city,page:1,limit:30,sort:"desc"};t||(s.page=_.value),a("log","at pages/chat/index.vue:709","加载城市消息, 参数:",s);const o=yield B.chat.getCityMessages(s);a("log","at pages/chat/index.vue:713","API直接返回的城市消息:",o);let r=[];if(o&&o.data?r=o.data:Array.isArray(o)&&(r=o),r.sort(((e,t)=>new Date(e.createTime)-new Date(t.createTime))),a("log","at pages/chat/index.vue:728","处理后的城市消息数据:",r),r&&r.length>0)t?(g.value=[...r],a("log","at pages/chat/index.vue:735","刷新城市消息列表，当前消息数:",g.value.length),yield e.nextTick(),U(!0)):(g.value=[...r,...g.value],a("log","at pages/chat/index.vue:743","追加历史城市消息，当前消息数:",g.value.length)),Ye.saveCityMessagesCache(g.value,m.city),_.value++;else if(t||(k.value=!0,a("log","at pages/chat/index.vue:755","没有更多城市消息")),t&&(!r||0===r.length)){const e=Ye.getCityMessagesCache(m.city);e&&e.length>0&&(a("log","at pages/chat/index.vue:762","从缓存加载城市消息"),g.value=e)}}catch(o){if(a("error","at pages/chat/index.vue:768","加载城市消息失败:",o),qe.isNetworkError&&qe.isNetworkError(o)){const e=Ye.getCityMessagesCache(m.city);e&&e.length>0&&(a("log","at pages/chat/index.vue:774","网络错误，从缓存加载城市消息"),(t||0===g.value.length)&&(g.value=e))}uni.showToast({title:"加载消息失败，请检查网络连接",icon:"none"})}finally{y.value=!1}else a("log","at pages/chat/index.vue:683","已有加载请求进行中，跳过")})),U=(e=!1)=>{a("log","at pages/chat/index.vue:871","执行滚动到底部, 强制滚动:",e),setTimeout((()=>{try{"nearby"===u.value?v.value=999999:h.value=999999,"nearby"===u.value?x.value.atBottom=!0:b.value.atBottom=!0,a("log","at pages/chat/index.vue:892","设置scrollTop以滚动到底部")}catch(e){a("error","at pages/chat/index.vue:894","滚动到底部出错:",e)}}),50)},j=()=>{P&&(clearInterval(P),P=null),P=setInterval((()=>{if(S.value&&d.value.isConnected){a("log","at pages/chat/index.vue:942","自动刷新消息");("nearby"===u.value?x.value.atBottom:b.value.atBottom)?F():a("log","at pages/chat/index.vue:954","用户正在查看历史消息，跳过自动刷新")}}),6e4)},F=()=>__async(this,null,(function*(){if(a("log","at pages/chat/index.vue:962","静默刷新消息"),m.latitude&&m.longitude)try{const t="nearby"===u.value?p.value.length:g.value.length;"nearby"===u.value?yield $():yield L();if(("nearby"===u.value?p.value.length:g.value.length)>t){("nearby"===u.value?x.value.atBottom:b.value.atBottom)?(a("log","at pages/chat/index.vue:996","检测到新消息且用户在底部，滚动到最新消息"),yield e.nextTick(),U(!0)):a("log","at pages/chat/index.vue:1000","有新消息但用户不在底部，不自动滚动")}}catch(t){a("error","at pages/chat/index.vue:1004","静默刷新消息失败:",t)}else a("warn","at pages/chat/index.vue:966","刷新消息失败：位置信息不存在")})),$=()=>__async(this,null,(function*(){try{const e={latitude:m.latitude,longitude:m.longitude,radius:5e3,page:1,limit:30,sort:"desc"};a("log","at pages/chat/index.vue:1021","静默加载附近消息, 参数:",e);const t=yield B.chat.getNearbyMessages(e);let s=[];if(t&&t.data?s=t.data:Array.isArray(t)&&(s=t),s.sort(((e,t)=>new Date(e.createTime)-new Date(t.createTime))),s&&s.length>0){const e=p.value.map((e=>e.id)),t=s.filter((t=>!e.includes(t.id)));if(t.length>0)return p.value=[...p.value,...t],p.value.length>50&&(p.value=p.value.slice(-50)),Ye.saveNearbyMessagesCache(p.value),!0}return!1}catch(e){return a("error","at pages/chat/index.vue:1060","静默加载附近消息失败:",e),!1}})),L=()=>__async(this,null,(function*(){try{const e={cityName:m.city,page:1,limit:30,sort:"desc"};a("log","at pages/chat/index.vue:1076","静默加载城市消息, 参数:",e);const t=yield B.chat.getCityMessages(e);let s=[];if(t&&t.data?s=t.data:Array.isArray(t)&&(s=t),s.sort(((e,t)=>new Date(e.createTime)-new Date(t.createTime))),s&&s.length>0){const e=g.value.map((e=>e.id)),t=s.filter((t=>!e.includes(t.id)));if(t.length>0)return g.value=[...g.value,...t],g.value.length>50&&(g.value=g.value.slice(-50)),Ye.saveCityMessagesCache(g.value,m.city),!0}return!1}catch(e){return a("error","at pages/chat/index.vue:1115","静默加载城市消息失败:",e),!1}}));e.watch(u,(e=>{a("log","at pages/chat/index.vue:1122","标签切换到:",e),"nearby"===e?0===p.value.length?D(!0):setTimeout((()=>{U(!0)}),100):"city"===e&&(0===g.value.length?A(!0):setTimeout((()=>{U(!0)}),100))}));const R=()=>{a("log","at pages/chat/index.vue:1427","强制执行滚动到底部"),setTimeout((()=>{try{"nearby"===u.value?(v.value=99999999,a("log","at pages/chat/index.vue:1435","强制设置附近消息scrollTop:",v.value),x.value.atBottom=!0):(h.value=99999999,a("log","at pages/chat/index.vue:1439","强制设置城市消息scrollTop:",h.value),b.value.atBottom=!0)}catch(e){a("error","at pages/chat/index.vue:1443","forceScrollToBottom出错:",e),"nearby"===u.value?v.value=99999999:h.value=99999999}}),50)};return n((()=>__async(this,null,(function*(){a("log","at pages/chat/index.vue:1456","聊天页面加载"),qe.addListener((e=>{d.value=e,a("log","at pages/chat/index.vue:263","网络状态更新:",e),e.isConnected&&S.value&&(a("log","at pages/chat/index.vue:267","网络恢复，刷新消息"),M())})),uni.$on("network:reconnected",(()=>{S.value&&(a("log","at pages/chat/index.vue:275","网络恢复事件，刷新消息"),M())})),uni.$on("chat:message-status-update",(({messageId:e,status:t,serverData:s})=>{a("log","at pages/chat/index.vue:284","收到消息状态更新:",e,t);const o=a=>{const o=a.findIndex((t=>t.id===e));return-1!==o&&(a[o].status=t,s&&(a[o].id=s.id||s._id||a[o].id,a[o].serverTime=s.createdAt||s.createTime),!0)},r=o(p.value),n=o(g.value);(r||n)&&a("log","at pages/chat/index.vue:309","已更新消息状态")})),Ye.clearExpiredMessageCaches(),(()=>{const e=Ye.getPendingMessages();e&&e.length>0&&(a("log","at pages/chat/index.vue:1149","恢复待处理消息:",e.length),e.forEach((e=>{"nearby"===e.type?(-1===p.value.findIndex((t=>t.id===e.id))&&p.value.push({id:e.id,content:e.content,userId:e.userId,userName:e.userName,userAvatar:e.userAvatar,createTime:e.createTime,status:e.status,distance:0,isOwnMessage:!0}),"sending"!==e.status&&"failed"!==e.status||Je.sendNearbyMessage(e.data)):"city"===e.type&&(-1===g.value.findIndex((t=>t.id===e.id))&&g.value.push({id:e.id,content:e.content,userId:e.userId,userName:e.userName,userAvatar:e.userAvatar,createTime:e.createTime,status:e.status,isOwnMessage:!0}),"sending"!==e.status&&"failed"!==e.status||Je.sendCityMessage(e.data))})))})(),j(),a("log","at pages/chat/index.vue:1474","开始初始化位置和加载消息");try{yield C(),a("log","at pages/chat/index.vue:1478","初始化位置和加载消息完成"),setTimeout((()=>{"nearby"===u.value?v.value=999999:h.value=999999}),300),setTimeout((()=>{"nearby"===u.value?v.value=999999:h.value=999999}),800)}catch(e){a("error","at pages/chat/index.vue:1497","初始化位置和加载消息失败:",e),M(),setTimeout((()=>{R()}),800)}})))),o((()=>{S.value=!0,C(),d.value.isConnected&&M(),j(),setTimeout((()=>{"nearby"===u.value?(v.value=999999,x.value.atBottom=!0):(h.value=999999,b.value.atBottom=!0)}),300),setTimeout((()=>{"nearby"===u.value?v.value=999999:h.value=999999}),600)})),r((()=>{S.value=!1,P&&(clearInterval(P),P=null)})),i((()=>{P&&(clearInterval(P),P=null),uni.$off("chat:message-status-update"),uni.$off("network:reconnected")})),{activeTab:u,currentLocation:m,networkStatus:d,nearbyMessages:p,cityMessages:g,scrollTop:v,cityScrollTop:h,showBackToBottom:f,isLoading:y,noMoreNearbyMessages:w,noMoreCityMessages:k,newMessage:E,inputFocus:N,userInfo:l,userId:c,refreshLocation:T,loadMoreNearbyMessages:()=>{if(w.value||y.value)return;const e=p.value.length;D().then((()=>{const t=p.value.length-e;t>0&&setTimeout((()=>{uni.createSelectorQuery().selectAll(".message-item").boundingClientRect((e=>{if(e&&e.length>0){let a=0;for(let s=0;s<Math.min(t,e.length);s++)a+=e[s].height;"nearby"===u.value&&(v.value+=a)}})).exec()}),100)}))},loadMoreCityMessages:()=>{if(k.value||y.value)return;const e=g.value.length;A().then((()=>{const t=g.value.length-e;t>0&&setTimeout((()=>{uni.createSelectorQuery().selectAll(".message-item").boundingClientRect((e=>{if(e&&e.length>0){let a=0;for(let s=0;s<Math.min(t,e.length);s++)a+=e[s].height;"city"===u.value&&(h.value+=a)}})).exec()}),100)}))},sendMessage:()=>__async(this,null,(function*(){if(!E.value.trim())return;if(!d.value.isConnected)return void uni.showToast({title:"网络不可用，请检查网络连接",icon:"none"});if(!m.latitude||!m.longitude)return void uni.showToast({title:"位置信息不存在，无法发送消息",icon:"none"});const t=E.value.trim();E.value="";const s={id:"temp-"+Date.now(),content:t,userId:c.value,userName:l.value.nickname||l.value.username||"游客",userAvatar:l.value.avatar||"/static/images/default-avatar.png",createTime:(new Date).getTime(),status:"sending",isOwnMessage:!0};if("nearby"===u.value){s.distance=0,p.value.push(s),Ye.savePendingMessage(__spreadProps(__spreadValues({},s),{type:"nearby",data:{content:t,latitude:m.latitude,longitude:m.longitude}}));try{yield Je.sendNearbyMessage({content:t,latitude:m.latitude,longitude:m.longitude})}catch(o){a("error","at pages/chat/index.vue:1262","发送附近消息失败:",o)}}else{g.value.push(s),Ye.savePendingMessage(__spreadProps(__spreadValues({},s),{type:"city",data:{content:t,cityName:m.city,latitude:m.latitude,longitude:m.longitude}}));try{yield Je.sendCityMessage({content:t,cityName:m.city,latitude:m.latitude,longitude:m.longitude})}catch(o){a("error","at pages/chat/index.vue:1290","发送城市消息失败:",o)}}a("log","at pages/chat/index.vue:1295","发送消息后，强制滚动到底部显示新消息"),yield e.nextTick(),"nearby"===u.value?(v.value=0,setTimeout((()=>{v.value=999999,x.value.atBottom=!0}),10)):(h.value=0,setTimeout((()=>{h.value=999999,b.value.atBottom=!0}),10)),setTimeout((()=>{"nearby"===u.value?v.value=999999:h.value=999999,a("log","at pages/chat/index.vue:1327","发送消息后，设置scrollTop完成")}),150)})),shouldShowDate:(e,t,a)=>{if(0===t)return!0;const s=a[t-1],o=new Date(s.createTime),r=new Date(e.createTime);return r-o>18e5||o.toDateString()!==r.toDateString()},formatDate:e=>{if(!e)return"";const t=new Date(e),a=new Date;if(t.toDateString()===a.toDateString())return"今天 "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0");const s=new Date;if(s.setDate(s.getDate()-1),t.toDateString()===s.toDateString())return"昨天 "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0");const o=["日","一","二","三","四","五","六"];return Math.floor((a-t)/864e5)<7?"星期"+o[t.getDay()]+" "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0"):t.getFullYear()!==a.getFullYear()?t.getFullYear()+"年"+(t.getMonth()+1)+"月"+t.getDate()+"日 "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0"):t.getMonth()+1+"月"+t.getDate()+"日 "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0")},formatTime:e=>{if(!e)return"";const t=new Date(e);return t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0")},formatDistance:e=>null==e?"":e<1e3?e+"米":(e/1e3).toFixed(1)+"公里",formatAvatarUrl:e=>{if(!e)return"/static/images/default-avatar.png";if(e.startsWith("http")||e.startsWith("/static"))return e;if(e.startsWith("/uploads")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}return"/static/images/default-avatar.png"},onScroll:e=>{const t=e.detail.scrollTop,a=e.detail.scrollHeight,s=e.detail.scrollHeight-e.detail.scrollTop,o=a-t-s<50;I.value=o,f.value=!o,"nearby"===u.value?x.value={scrollTop:t,scrollHeight:a,clientHeight:s,atBottom:o}:b.value={scrollTop:t,scrollHeight:a,clientHeight:s,atBottom:o}},scrollToBottom:U}}},[["render",function(t,a,s,o,r,n){return e.openBlock(),e.createElementBlock("view",{class:"container"},[e.createElementVNode("view",{class:"tab-container"},[e.createElementVNode("view",{class:e.normalizeClass(["tab",{active:"nearby"===o.activeTab}]),onClick:a[0]||(a[0]=e=>o.activeTab="nearby")},[e.createElementVNode("text",null,"附近 5公里")],2),e.createElementVNode("view",{class:e.normalizeClass(["tab",{active:"city"===o.activeTab}]),onClick:a[1]||(a[1]=e=>o.activeTab="city")},[e.createElementVNode("text",null,"城市频道")],2)]),"nearby"===o.activeTab?(e.openBlock(),e.createElementBlock("view",{key:0,class:"content"},[e.createElementVNode("view",{class:"location-info"},[e.createElementVNode("text",{class:"location-text"},e.toDisplayString(o.currentLocation.address||"正在获取位置..."),1),e.createElementVNode("view",{class:"refresh-btn",onClick:a[2]||(a[2]=(...e)=>o.refreshLocation&&o.refreshLocation(...e))},[e.createElementVNode("text",{class:"refresh-icon"},"🔄")])]),e.createElementVNode("scroll-view",{class:"message-list nearby-message-list","scroll-y":"true","scroll-top":o.scrollTop,"scroll-with-animation":!0,"scroll-animation-duration":100,enhanced:!0,bounces:!1,"show-scrollbar":!1,onScrolltolower:a[3]||(a[3]=(...e)=>o.loadMoreNearbyMessages&&o.loadMoreNearbyMessages(...e)),onScroll:a[4]||(a[4]=(...e)=>o.onScroll&&o.onScroll(...e)),ref:"nearbyMessageList"},[e.createElementVNode("view",{class:"messages-container"},[o.noMoreNearbyMessages&&o.nearbyMessages.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"no-more"},[e.createElementVNode("text",null,"没有更多消息了")])):e.createCommentVNode("",!0),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.nearbyMessages,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:t.id||a,class:"message-item",id:"nearby-msg-"+(t.id||a)},[o.shouldShowDate(t,a,o.nearbyMessages)?(e.openBlock(),e.createElementBlock("view",{key:0,class:"date-divider"},[e.createElementVNode("text",null,e.toDisplayString(o.formatDate(t.createTime)),1)])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"message-content"},[e.createElementVNode("image",{class:"avatar",src:o.formatAvatarUrl(t.userAvatar),mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"message-bubble"},[e.createElementVNode("view",{class:"message-header"},[e.createElementVNode("text",{class:"username"},e.toDisplayString(t.userName),1),e.createElementVNode("text",{class:"time"},e.toDisplayString(o.formatTime(t.createTime)),1)]),e.createElementVNode("text",{class:"message-text"},e.toDisplayString(t.content),1),t.distance?(e.openBlock(),e.createElementBlock("view",{key:0,class:"message-footer"},[e.createElementVNode("text",{class:"distance"},"距离: "+e.toDisplayString(o.formatDistance(t.distance)),1)])):e.createCommentVNode("",!0)])])],8,["id"])))),128))]),0!==o.nearbyMessages.length||o.isLoading?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("view",{key:0,class:"empty-state"},[e.createElementVNode("image",{class:"empty-icon",src:Xe,mode:"aspectFit"}),e.createElementVNode("text",{class:"empty-text"},"附近暂无消息"),e.createElementVNode("text",{class:"empty-tip"},"发送一条消息，成为第一个发言的人吧")])),o.isLoading?(e.openBlock(),e.createElementBlock("view",{key:1,class:"loading-state"},[e.createElementVNode("text",null,"加载中...")])):e.createCommentVNode("",!0)],40,["scroll-top"]),o.showBackToBottom?(e.openBlock(),e.createElementBlock("view",{key:0,class:"back-to-bottom-btn",onClick:a[5]||(a[5]=(...e)=>o.scrollToBottom&&o.scrollToBottom(...e))},[e.createElementVNode("text",{class:"icon"},"↓")])):e.createCommentVNode("",!0)])):e.createCommentVNode("",!0),"city"===o.activeTab?(e.openBlock(),e.createElementBlock("view",{key:1,class:"content"},[e.createElementVNode("view",{class:"location-info"},[e.createElementVNode("text",{class:"location-text"},e.toDisplayString(o.currentLocation.city||"正在获取城市..."),1),e.createElementVNode("view",{class:"refresh-btn",onClick:a[6]||(a[6]=(...e)=>o.refreshLocation&&o.refreshLocation(...e))},[e.createElementVNode("text",{class:"refresh-icon"},"🔄")])]),e.createElementVNode("scroll-view",{class:"message-list city-message-list","scroll-y":"true","scroll-top":o.cityScrollTop,"scroll-with-animation":!0,"scroll-animation-duration":100,enhanced:!0,bounces:!1,"show-scrollbar":!1,onScrolltolower:a[7]||(a[7]=(...e)=>o.loadMoreCityMessages&&o.loadMoreCityMessages(...e)),onScroll:a[8]||(a[8]=(...e)=>o.onScroll&&o.onScroll(...e)),ref:"cityMessageList"},[e.createElementVNode("view",{class:"messages-container"},[o.noMoreCityMessages&&o.cityMessages.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"no-more"},[e.createElementVNode("text",null,"没有更多消息了")])):e.createCommentVNode("",!0),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.cityMessages,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:t.id||a,class:"message-item",id:"city-msg-"+(t.id||a)},[o.shouldShowDate(t,a,o.cityMessages)?(e.openBlock(),e.createElementBlock("view",{key:0,class:"date-divider"},[e.createElementVNode("text",null,e.toDisplayString(o.formatDate(t.createTime)),1)])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"message-content"},[e.createElementVNode("image",{class:"avatar",src:o.formatAvatarUrl(t.userAvatar),mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"message-bubble"},[e.createElementVNode("view",{class:"message-header"},[e.createElementVNode("text",{class:"username"},e.toDisplayString(t.userName),1),e.createElementVNode("text",{class:"time"},e.toDisplayString(o.formatTime(t.createTime)),1)]),e.createElementVNode("text",{class:"message-text"},e.toDisplayString(t.content),1)])])],8,["id"])))),128))]),0!==o.cityMessages.length||o.isLoading?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("view",{key:0,class:"empty-state"},[e.createElementVNode("image",{class:"empty-icon",src:Xe,mode:"aspectFit"}),e.createElementVNode("text",{class:"empty-text"},"城市频道暂无消息"),e.createElementVNode("text",{class:"empty-tip"},"发送一条消息，成为第一个发言的人吧")])),o.isLoading?(e.openBlock(),e.createElementBlock("view",{key:1,class:"loading-state"},[e.createElementVNode("text",null,"加载中...")])):e.createCommentVNode("",!0)],40,["scroll-top"]),o.showBackToBottom?(e.openBlock(),e.createElementBlock("view",{key:0,class:"back-to-bottom-btn",onClick:a[9]||(a[9]=(...e)=>o.scrollToBottom&&o.scrollToBottom(...e))},[e.createElementVNode("text",{class:"icon"},"↓")])):e.createCommentVNode("",!0)])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"input-area"},[e.withDirectives(e.createElementVNode("input",{type:"text",class:"message-input","onUpdate:modelValue":a[10]||(a[10]=e=>o.newMessage=e),placeholder:"输入消息...",focus:o.inputFocus,"confirm-type":"send",onConfirm:a[11]||(a[11]=(...e)=>o.sendMessage&&o.sendMessage(...e))},null,40,["focus"]),[[e.vModelText,o.newMessage]]),e.createElementVNode("view",{class:e.normalizeClass(["send-btn",{active:o.newMessage.trim()}]),onClick:a[12]||(a[12]=(...e)=>o.sendMessage&&o.sendMessage(...e))},[e.createElementVNode("text",null,"发送")],2)])])}]]);const tt=he({setup(){X();const t=Y(),s=ae(),o=e.reactive({title:"",description:"",type:"general",customTypeName:"",color:"#FF5733",isPublic:!0,latitude:39.9087,longitude:116.3975,radius:1,pet:null,images:[]}),r=e.ref([]);e.onMounted((()=>__async(this,null,(function*(){try{const e=yield(()=>{const e=getCurrentPages(),t=e[e.length-1].options||{};let s={latitude:39.9087,longitude:116.3975};return t.latitude&&t.longitude?{latitude:parseFloat(t.latitude),longitude:parseFloat(t.longitude)}:new Promise((e=>{uni.getLocation({type:"gcj02",success:t=>{a("log","at pages/map/add-marker.vue:220","获取当前位置成功:",t),e({latitude:t.latitude,longitude:t.longitude})},fail:t=>{a("error","at pages/map/add-marker.vue:227","获取当前位置失败:",t),e(s)}})}))})();o.latitude=e.latitude,o.longitude=e.longitude,d(),setTimeout((()=>{const e=uni.createMapContext("marker-preview-map");e&&e.moveToLocation({latitude:o.latitude,longitude:o.longitude})}),500)}catch(e){a("error","at pages/map/add-marker.vue:273","初始化位置失败:",e)}}))));const n=[{value:"general",label:"一般标记",icon:ce.general||"/static/images/marker.png",color:ue},{value:"pet_friendly",label:"宠物友好",icon:ce.pet_friendly||"/static/images/pet-marker.png",color:de},{value:"danger",label:"危险区域",icon:ce.danger||"/static/images/danger-marker.png",color:me},{value:"scenic",label:"风景优美",icon:ce.scenic||"/static/images/park-marker.png",color:pe},{value:"pet_service",label:"宠物服务",icon:ce.pet_service||"/static/images/shop-marker.png",color:ge},{value:"custom",label:"自定义",icon:ce.custom||"/static/images/marker.png",color:ve}],i=()=>{const e=n.find((e=>e.value===o.type));return e?e.icon:"/static/images/marker.png"},l=e.computed((()=>[{id:1,latitude:o.latitude,longitude:o.longitude,iconPath:i()||"/static/images/marker.png",width:40,height:40,anchor:{x:.5,y:1},callout:{content:"长按可拖动",color:"#000000",fontSize:12,borderRadius:4,padding:5,display:"ALWAYS"},draggable:!0}])),c=e.computed((()=>({latitude:o.latitude,longitude:o.longitude,color:o.color+"33",fillColor:o.color+"33",radius:1e3*o.radius,strokeWidth:2,strokeColor:o.color}))),u=e.ref([]),d=()=>__async(this,null,(function*(){const e=yield t.fetchPets();u.value=e})),m=(e,t)=>{a("log","at pages/map/add-marker.vue:504","更新标记位置:",e,t),o.latitude=e,o.longitude=t,setTimeout((()=>{const a=uni.createMapContext("marker-preview-map");a&&a.moveToLocation({latitude:e,longitude:t})}),100),uni.showToast({title:"位置已更新",icon:"success",duration:1500})},p=()=>{uni.showToast({title:"无法确定位置，请尝试拖动标记",icon:"none",duration:2e3})},g=e=>e*(Math.PI/180);function v(e){a("log","at pages/map/add-marker.vue:577","选择图片：",e);const t=e.tempFilePaths.map(((t,a)=>({url:t,file:t,caption:"",name:e.tempFiles[a].name||`图片${o.images.length+a+1}`})));o.images.push(...t)}return{markerData:o,markerTypes:n,colorOptions:["#FF5733","#33FF57","#3357FF","#FF33F5","#F5FF33","#33FFF5"],markers:l,mapCircle:c,myPets:u,imageFiles:r,getSelectedTypeLabel:()=>{if("custom"===o.type&&o.customTypeName)return`自定义: ${o.customTypeName}`;const e=n.find((e=>e.value===o.type));return e?e.label:"请选择标记类型"},getSelectedTypeIcon:i,getSelectedPetName:()=>{if(!o.pet)return"请选择关联宠物";const e=u.value.find((e=>e._id===o.pet));return e?e.name:"请选择关联宠物"},selectMarkerType:e=>{o.type=e,"custom"!==o.type&&(o.customTypeName="")},handlePetChange:e=>{const t=e.detail.value;o.pet=u.value[t]._id},handleRadiusChange:e=>{o.radius=parseFloat(parseFloat(e.detail.value).toFixed(2))},handleImageSelect:v,handleImageDelete:function(e){a("log","at pages/map/add-marker.vue:592","删除图片：",e)},removeImage:function(e){o.images.splice(e,1)},previewImage:function(e){const t=o.images.map((e=>e.url));uni.previewImage({urls:t,current:e})},selectColor:e=>{o.color=e},togglePublic:()=>{o.isPublic=!o.isPublic},handleMapTap:e=>{if(a("log","at pages/map/add-marker.vue:395","地图点击原始事件:",e),e&&e.detail&&(a("log","at pages/map/add-marker.vue:399","点击详情:",e.detail),"number"==typeof e.detail.x&&"number"==typeof e.detail.y)){const t=uni.createMapContext("marker-preview-map");if(t&&"function"==typeof t.fromScreenLocation)return void t.fromScreenLocation({x:e.detail.x,y:e.detail.y,success:e=>{m(e.latitude,e.longitude)},fail:e=>{a("error","at pages/map/add-marker.vue:414","坐标转换失败:",e),p()}})}let t,s;e.detail&&"number"==typeof e.detail.latitude&&"number"==typeof e.detail.longitude?(t=e.detail.latitude,s=e.detail.longitude):"number"==typeof e.latitude&&"number"==typeof e.longitude?(t=e.latitude,s=e.longitude):e.target&&"number"==typeof e.target.latitude&&"number"==typeof e.target.longitude?(t=e.target.latitude,s=e.target.longitude):e.detail&&e.detail.target&&"number"==typeof e.detail.target.latitude&&"number"==typeof e.detail.target.longitude&&(t=e.detail.target.latitude,s=e.detail.target.longitude),t&&s?m(t,s):setTimeout((()=>{const e=uni.createMapContext("marker-preview-map");e&&"function"==typeof e.getCenterLocation?e.getCenterLocation({success:e=>{e.latitude&&e.longitude&&(m(e.latitude,e.longitude),uni.showToast({title:"已使用地图中心位置",icon:"none",duration:1500}))}}):p()}),100)},handleMarkerDrag:e=>{if(a("log","at pages/map/add-marker.vue:475","标记拖动事件:",e),e.detail&&"number"==typeof e.detail.latitude&&"number"==typeof e.detail.longitude)m(e.detail.latitude,e.detail.longitude);else if(1===e.markerId){let t,a;e.latitude&&e.longitude?(t=e.latitude,a=e.longitude):e.target&&e.target.latitude&&e.target.longitude&&(t=e.target.latitude,a=e.target.longitude),t&&a&&m(t,a)}},moveToMarker:()=>{uni.createMapContext("marker-preview-map").moveToLocation({latitude:o.latitude,longitude:o.longitude,success:()=>{uni.showToast({title:"已定位到标记",icon:"success",duration:1500})}})},submitMarker:()=>__async(this,null,(function*(){var e,t;if(!o.title)return void uni.showToast({title:"请输入标记标题",icon:"none"});if("custom"===o.type&&!o.customTypeName.trim())return void uni.showToast({title:"请输入自定义类型名称",icon:"none"});try{if("none"===(yield new Promise(((e,t)=>{uni.getNetworkType({success:t=>e(t.networkType),fail:e=>t(e)})}))))return void uni.showModal({title:"网络错误",content:"您当前无网络连接，无法保存标记。请检查网络设置后重试。",showCancel:!1})}catch(l){a("error","at pages/map/add-marker.vue:672","获取网络状态失败:",l)}let r=[];if(o.images&&o.images.length>0)try{uni.showLoading({title:"正在上传图片...",mask:!0});for(let e=0;e<o.images.length;e++){const t=o.images[e];if(!t.url||t.file){if(uni.showLoading({title:`上传图片 ${e+1}/${o.images.length}`,mask:!0}),!t.file)throw a("error","at pages/map/add-marker.vue:707",`图片 ${e+1} 文件路径不存在`),new Error(`图片 ${e+1} 文件路径不存在`);a("log","at pages/map/add-marker.vue:712",`准备上传图片 ${e+1}:`,t.file);try{let s=null;if(s=yield new Promise(((s,r)=>{uni.uploadFile({url:"/api/markers/upload-fallback",filePath:t.file,name:"image",formData:{type:o.type||"default"},success:e=>{if(200===e.statusCode)try{const t=JSON.parse(e.data);s(t)}catch(t){r(new Error("解析响应数据失败"))}else r(new Error(`上传失败，状态码: ${e.statusCode}`))},fail:e=>{r(new Error(`备用上传失败: ${e.errMsg||"未知错误"}`))}}).onProgressUpdate((t=>{a("log","at pages/map/add-marker.vue:746",`上传进度 ${e+1}/${o.images.length}: ${t.progress}%`)}))})),!s||!s.success)throw new Error((null==s?void 0:s.message)||"上传失败");r.push({url:s.url,caption:t.caption||""}),a("log","at pages/map/add-marker.vue:755",`图片 ${e+1} 上传成功:`,s)}catch(c){throw a("error","at pages/map/add-marker.vue:760",`图片 ${e+1} 上传失败:`,c),new Error(`图片 ${e+1} 上传失败: ${c.message}`)}}else r.push({url:t.url,caption:t.caption||""})}a("log","at pages/map/add-marker.vue:765","所有图片上传完成:",r)}catch(l){return a("error","at pages/map/add-marker.vue:767","图片上传失败:",l),uni.hideLoading(),void uni.showModal({title:"图片上传失败",content:l.message||"上传图片时出错，请重试",showCancel:!1})}const n={title:o.title,description:o.description,type:o.type,icon:i(),color:o.color,longitude:o.longitude,latitude:o.latitude,radius:parseFloat(parseFloat(o.radius).toFixed(2)),isPublic:o.isPublic,properties:{},images:r};a("log","at pages/map/add-marker.vue:794","准备保存标记数据:",n),a("log","at pages/map/add-marker.vue:795","覆盖半径值 (km):",n.radius),"custom"===o.type&&(n.properties.customTypeName=o.customTypeName.trim()),o.pet&&(n.pet=o.pet),a("log","at pages/map/add-marker.vue:807","准备保存标记数据:",n);try{uni.showLoading({title:"正在保存...",mask:!0});const e=yield s.createMarker(n);uni.hideLoading(),e?(a("log","at pages/map/add-marker.vue:821","标记保存成功，数据:",e),e.data&&e.data._id?(uni.$emit("marker-created",{marker:e.data,timestamp:Date.now()}),setTimeout((()=>{uni.navigateBack({delta:1,success:()=>{uni.$emit("refresh-map",{timestamp:Date.now()})}})}),1500)):(uni.showToast({title:"标记保存成功",icon:"success"}),setTimeout((()=>{uni.navigateBack({delta:1})}),1500))):uni.showModal({title:"保存失败",content:"标记数据保存失败，请重试。如果问题持续，请联系客服。",showCancel:!1})}catch(l){uni.hideLoading(),a("error","at pages/map/add-marker.vue:867","保存标记时出错:",l);const s=(null==(t=null==(e=l.response)?void 0:e.data)?void 0:t.message)||l.message||"保存失败，请检查网络连接后重试";uni.showModal({title:"保存失败",content:s,showCancel:!1})}})),calculateDistance:(e,t,a,s)=>{if(!(e&&t&&a&&s))return 0;const o=g(a-e),r=g(s-t),n=Math.sin(o/2)*Math.sin(o/2)+Math.cos(g(e))*Math.cos(g(a))*Math.sin(r/2)*Math.sin(r/2);return 6371*(2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)))},deg2rad:g,cancel:()=>{uni.navigateBack()},openFilePicker:function(){uni.chooseImage({count:9-o.images.length,sizeType:["original","compressed"],sourceType:["album","camera"],success:e=>{v({tempFilePaths:e.tempFilePaths,tempFiles:e.tempFiles})},fail:e=>{a("error","at pages/map/add-marker.vue:626","选择图片失败:",e),uni.showToast({title:"选择图片失败",icon:"none"})}})}}}},[["render",function(t,a,s,o,r,n){const i=e.resolveComponent("uni-icons"),l=e.resolveComponent("uni-file-picker");return e.openBlock(),e.createElementBlock("view",{class:"marker-form-container"},[e.createElementVNode("view",{class:"form-header"},[e.createElementVNode("text",{class:"form-title"},"添加地图标记/故事")]),e.createElementVNode("view",{class:"form-content"},[e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},[e.createTextVNode("标记标题"),e.createElementVNode("text",{class:"required"},"*")]),e.withDirectives(e.createElementVNode("input",{class:"form-input",type:"text","onUpdate:modelValue":a[0]||(a[0]=e=>o.markerData.title=e),placeholder:"请输入标记标题",maxlength:"50"},null,512),[[e.vModelText,o.markerData.title]])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"标记描述"),e.withDirectives(e.createElementVNode("textarea",{class:"form-textarea","onUpdate:modelValue":a[1]||(a[1]=e=>o.markerData.description=e),placeholder:"请输入标记描述",maxlength:"200"},null,512),[[e.vModelText,o.markerData.description]])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"上传图片"),e.createElementVNode("view",{class:"image-upload-area"},[0===o.markerData.images.length?(e.openBlock(),e.createElementBlock("view",{key:0,class:"upload-button",onClick:a[2]||(a[2]=(...e)=>o.openFilePicker&&o.openFilePicker(...e))},[e.createVNode(i,{type:"camera-filled",size:"24",color:"#007AFF"}),e.createElementVNode("text",{class:"upload-text"},"点击上传图片")])):e.createCommentVNode("",!0),e.createVNode(l,{ref:"filePicker",modelValue:o.imageFiles,"onUpdate:modelValue":a[3]||(a[3]=e=>o.imageFiles=e),fileMediatype:"image",mode:"grid",limit:9,onSelect:o.handleImageSelect,onDelete:o.handleImageDelete},null,8,["modelValue","onSelect","onDelete"]),o.markerData.images&&o.markerData.images.length>0?(e.openBlock(),e.createElementBlock("view",{key:1,class:"uploaded-images"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.markerData.images,((t,a)=>(e.openBlock(),e.createElementBlock("view",{class:"image-item",key:a},[e.createElementVNode("image",{src:t.url,mode:"aspectFill",class:"preview-image",onClick:e=>o.previewImage(a)},null,8,["src","onClick"]),e.withDirectives(e.createElementVNode("input",{type:"text","onUpdate:modelValue":e=>t.caption=e,placeholder:"请输入图片描述(可选)",class:"image-caption-input"},null,8,["onUpdate:modelValue"]),[[e.vModelText,t.caption]]),e.createElementVNode("view",{class:"image-actions"},[e.createElementVNode("view",{class:"delete-btn",onClick:e=>o.removeImage(a)},[e.createVNode(i,{type:"trash",size:"18"})],8,["onClick"])])])))),128)),o.markerData.images.length<9?(e.openBlock(),e.createElementBlock("view",{key:0,class:"add-more-btn",onClick:a[4]||(a[4]=(...e)=>o.openFilePicker&&o.openFilePicker(...e))},[e.createVNode(i,{type:"plus",size:"20",color:"#007AFF"}),e.createElementVNode("text",null,"添加更多图片")])):e.createCommentVNode("",!0)])):e.createCommentVNode("",!0)])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"标记类型"),e.createElementVNode("view",{class:"marker-type-selector"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.markerTypes,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:a,class:e.normalizeClass(["marker-type-item",{active:o.markerData.type===t.value}]),onClick:e=>o.selectMarkerType(t.value)},[e.createElementVNode("view",{class:"marker-type-icon",style:e.normalizeStyle({backgroundColor:t.color||"#007AFF"})},[t.icon.startsWith("data:")?(e.openBlock(),e.createElementBlock("image",{key:1,src:t.icon,class:"type-icon svg-icon",mode:"aspectFit"},null,8,["src"])):(e.openBlock(),e.createElementBlock("image",{key:0,src:t.icon,class:"type-icon",mode:"aspectFit"},null,8,["src"]))],4),e.createElementVNode("text",{class:"marker-type-label"},e.toDisplayString(t.label),1)],10,["onClick"])))),128))])]),"custom"===o.markerData.type?(e.openBlock(),e.createElementBlock("view",{key:0,class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"自定义类型名称"),e.withDirectives(e.createElementVNode("input",{class:"form-input",type:"text","onUpdate:modelValue":a[5]||(a[5]=e=>o.markerData.customTypeName=e),placeholder:"请输入自定义类型名称",maxlength:"20"},null,512),[[e.vModelText,o.markerData.customTypeName]])])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"标记颜色"),e.createElementVNode("view",{class:"color-selector"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.colorOptions,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:a,class:e.normalizeClass(["color-item",{active:o.markerData.color===t}]),style:e.normalizeStyle({backgroundColor:t}),onClick:e=>o.selectColor(t)},null,14,["onClick"])))),128))])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"覆盖半径 (千米)"),e.createElementVNode("slider",{class:"radius-slider",min:.1,max:10,step:.1,value:o.markerData.radius,"show-value":!0,onChange:a[6]||(a[6]=(...e)=>o.handleRadiusChange&&o.handleRadiusChange(...e))},null,40,["value"]),e.createElementVNode("text",{class:"radius-value"},e.toDisplayString(o.markerData.radius)+"km",1)]),e.createElementVNode("view",{class:"form-item checkbox-item"},[e.createElementVNode("checkbox",{checked:o.markerData.isPublic,onClick:a[7]||(a[7]=(...e)=>o.togglePublic&&o.togglePublic(...e))},null,8,["checked"]),e.createElementVNode("text",{class:"checkbox-label"},"公开此标记（允许其他用户看到）")]),o.myPets.length>0?(e.openBlock(),e.createElementBlock("view",{key:1,class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"关联宠物"),e.createElementVNode("picker",{class:"form-picker",range:o.myPets,"range-key":"name",onChange:a[8]||(a[8]=(...e)=>o.handlePetChange&&o.handlePetChange(...e))},[e.createElementVNode("view",{class:"picker-value"},e.toDisplayString(o.getSelectedPetName()),1)],40,["range"])])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"form-location"},[e.createElementVNode("text",{class:"location-label"},"位置信息"),e.createElementVNode("view",{class:"location-info"},[e.createElementVNode("text",{class:"location-coordinates"},"经度: "+e.toDisplayString(o.markerData.longitude.toFixed(6))+", 纬度: "+e.toDisplayString(o.markerData.latitude.toFixed(6)),1),e.createElementVNode("text",{class:"location-hint"},"点击下方地图可直接标记位置，或拖动标记点调整位置")]),e.createElementVNode("view",{class:"location-map"},[e.createElementVNode("map",{id:"marker-preview-map",class:"mini-map",latitude:o.markerData.latitude,longitude:o.markerData.longitude,markers:o.markers,circles:[o.mapCircle],scale:"16",onTap:a[9]||(a[9]=(...e)=>o.handleMapTap&&o.handleMapTap(...e)),onMarkerdrag:a[10]||(a[10]=(...e)=>o.handleMarkerDrag&&o.handleMarkerDrag(...e)),"show-location":""},null,40,["latitude","longitude","markers","circles"]),e.createElementVNode("view",{class:"map-overlay-tips"},[e.createElementVNode("text",null,"点击地图任意位置 或 长按标记进行拖动")]),e.createElementVNode("view",{class:"map-controls"},[e.createElementVNode("view",{class:"map-control-btn",onClick:a[11]||(a[11]=(...e)=>o.moveToMarker&&o.moveToMarker(...e))},[e.createElementVNode("text",{class:"map-control-text"},"定位到标记")])])])])]),e.createElementVNode("view",{class:"form-actions"},[e.createElementVNode("button",{class:"btn btn-cancel",onClick:a[12]||(a[12]=(...e)=>o.cancel&&o.cancel(...e))},"取消"),e.createElementVNode("button",{class:"btn btn-submit",onClick:a[13]||(a[13]=(...e)=>o.submitMarker&&o.submitMarker(...e))},"保存")])])}]]);const at=he({setup(){const t=e.ref({}),s=ae(),o=X(),r=e.ref(!1),n=e.ref(null),i=e.ref(0),l=e.ref(0),c=e.computed((()=>t.value.images&&t.value.images.length>0?2:1));e.onMounted((()=>__async(this,null,(function*(){var e;try{a("log","at pages/map/marker-detail.vue:181","页面加载，准备获取标记详情");const o=getCurrentPages(),r=o[o.length-1],n=null==(e=null==r?void 0:r.options)?void 0:e.id;if(!n)throw new Error("没有指定标记ID");a("log","at pages/map/marker-detail.vue:190","开始获取标记详情，标记ID:",n);const i=s.selectedMarker;i&&i._id===n?(a("log","at pages/map/marker-detail.vue:195","从store获取标记数据"),t.value=i,a("log","at pages/map/marker-detail.vue:197","标记数据:",JSON.stringify(t.value,null,2)),t.value.user?"string"==typeof t.value.user?(a("log","at pages/map/marker-detail.vue:202","用户信息只有ID，需要获取详情:",t.value.user),yield d(t.value.user)):a("log","at pages/map/marker-detail.vue:205","已有完整用户信息:",t.value.user):a("log","at pages/map/marker-detail.vue:208","标记没有用户信息")):(a("log","at pages/map/marker-detail.vue:212","从API获取标记详情"),yield u(n))}catch(o){a("error","at pages/map/marker-detail.vue:216","标记详情页面初始化失败:",o),uni.showToast({title:"获取标记信息失败",icon:"none"})}}))));const u=e=>new Promise(((s,r)=>{a("log","at pages/map/marker-detail.vue:227","从API获取标记，ID:",e),uni.request({url:`/api/markers/${e}`,method:"GET",header:{Authorization:`Bearer ${o.token}`},success:e=>__async(this,null,(function*(){var o;try{if(200===e.statusCode&&e.data)e.data.success&&e.data.data?t.value=e.data.data:t.value=e.data,a("log","at pages/map/marker-detail.vue:246","标记数据获取成功:",t.value),t.value.user&&"string"==typeof t.value.user?(a("log","at pages/map/marker-detail.vue:250","需要获取用户详情，用户ID:",t.value.user),yield d(t.value.user)):t.value.user?a("log","at pages/map/marker-detail.vue:253","标记包含完整用户信息:",t.value.user):a("log","at pages/map/marker-detail.vue:255","标记没有用户信息"),s(t.value);else{const t=(null==(o=e.data)?void 0:o.message)||"获取标记失败";a("error","at pages/map/marker-detail.vue:261","API响应错误:",t),r(new Error(t))}}catch(n){a("error","at pages/map/marker-detail.vue:265","处理API响应时出错:",n),r(n)}})),fail:e=>{a("error","at pages/map/marker-detail.vue:270","API请求失败:",e),r(e)}})})),d=e=>__async(this,null,(function*(){r.value=!0,n.value=null;try{return a("log","at pages/map/marker-detail.vue:283","开始获取用户信息，ID:",e),new Promise(((s,i)=>{uni.request({url:`/api/users/${e}`,method:"GET",header:{Authorization:`Bearer ${o.token}`},success:o=>{var r;if(200===o.statusCode&&o.data)t.value.user=o.data,a("log","at pages/map/marker-detail.vue:297","用户信息获取成功:",t.value.user),s(t.value.user);else{const i=(null==(r=o.data)?void 0:r.message)||"获取用户信息失败";a("error","at pages/map/marker-detail.vue:301","获取用户信息API响应错误:",i),n.value=new Error(i),t.value.user={username:"用户"+e.substr(-4),nickname:"未知用户"},s(null)}},fail:o=>{a("error","at pages/map/marker-detail.vue:312","获取用户信息请求失败:",o),n.value=o,t.value.user={username:"用户"+e.substr(-4),nickname:"未知用户"},s(null)},complete:()=>{r.value=!1}})}))}catch(s){return a("error","at pages/map/marker-detail.vue:327","获取用户信息处理失败:",s),n.value=s,r.value=!1,t.value.user={username:e?"用户"+e.substr(-4):"未知用户",nickname:"未知用户"},null}})),m=e=>{if(!e)return"/static/images/default-avatar.png";if(e.startsWith("http://")||e.startsWith("https://"))return e;try{let t=uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000";return e.startsWith("/")?t+e:e.startsWith("static/")?"/"+e:t+"/"+e}catch(t){return a("error","at pages/map/marker-detail.vue:408","URL处理错误:",t,e),e.startsWith("/")?e:"/"+e}},p=e=>{if(!e)return"/static/images/default-cover.jpg";try{return e.startsWith("http://")||e.startsWith("https://")?e:m(e)}catch(t){return a("error","at pages/map/marker-detail.vue:427","图片URL处理错误:",t,e),"/static/images/default-cover.jpg"}};return{marker:t,isLoadingUser:r,userError:n,currentPage:i,currentPhotoIndex:l,totalPages:c,getMarkerTypeName:e=>({general:"普通标记",pet_friendly:"宠物友好",danger:"危险区域",scenic:"风景区",pet_service:"宠物服务",custom:"自定义"}[e]||"未知类型"),formatTime:e=>{if(!e)return"未知时间";const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`},getImageUrl:p,getUserAvatar:e=>{if(!e)return"/static/images/default-avatar.png";if("string"==typeof e)return"/static/images/default-avatar.png";const t=e.avatar||"/static/images/default-avatar.png";return m(t)},getUserName:e=>e?"string"==typeof e?"用户"+e.substr(-4):e.nickname||e.username||"未知用户":"未知用户",previewImage:e=>{if(!t.value.images||0===t.value.images.length)return;const a=t.value.images.map((e=>p(e.url)));uni.previewImage({urls:a,current:e})},goBack:()=>{uni.navigateBack()},navigateToMarker:()=>{const e=getCurrentPages(),a=e[e.length-2];a&&a.$vm&&a.$vm.navigateToLocation?(a.$vm.navigateToLocation(t.value),setTimeout((()=>{uni.navigateBack()}),500)):(uni.setStorageSync("navigate_to_marker",t.value),uni.navigateBack())},onPageChange:e=>{i.value=e.detail.current},onPhotoChange:e=>{l.value=e.detail.current},goToPage:e=>{i.value=e}}}},[["render",function(t,a,s,o,r,n){return e.openBlock(),e.createElementBlock("view",{class:"marker-album-container"},[e.createElementVNode("view",{class:"safe-area-top"}),e.createElementVNode("view",{class:"back-button",onClick:a[0]||(a[0]=(...e)=>o.goBack&&o.goBack(...e))},[e.createElementVNode("text",{class:"back-icon"},"←")]),e.createElementVNode("swiper",{class:"main-swiper",current:o.currentPage,onChange:a[2]||(a[2]=(...e)=>o.onPageChange&&o.onPageChange(...e)),"indicator-dots":!1,duration:400},[e.createElementVNode("swiper-item",null,[e.createElementVNode("scroll-view",{class:"album-combined","scroll-y":""},[e.createElementVNode("view",{class:"combined-cover"},[e.createElementVNode("image",{class:"cover-image",src:o.marker.images&&o.marker.images.length>0?o.getImageUrl(o.marker.images[0].url):"/static/images/default-cover.jpg",mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"cover-overlay"}),e.createElementVNode("view",{class:"cover-content"},[e.createElementVNode("text",{class:"cover-title"},e.toDisplayString(o.marker.title||"未命名标记"),1),e.createElementVNode("view",{class:"cover-creator"},[o.isLoadingUser?(e.openBlock(),e.createElementBlock("view",{key:0,class:"loading-user"},[e.createElementVNode("text",null,"加载用户信息...")])):(e.openBlock(),e.createElementBlock(e.Fragment,{key:1},[e.createElementVNode("image",{class:"creator-avatar",src:o.getUserAvatar(o.marker.user),mode:"aspectFill"},null,8,["src"]),e.createElementVNode("text",{class:"creator-name"},e.toDisplayString(o.getUserName(o.marker.user)),1)],64))]),e.createElementVNode("text",{class:"cover-time"},e.toDisplayString(o.formatTime(o.marker.createdAt)),1),e.createElementVNode("view",{class:"cover-type-tag"},[e.createElementVNode("text",null,e.toDisplayString(o.getMarkerTypeName(o.marker.type)),1)])])]),e.createElementVNode("view",{class:"combined-detail"},[e.createElementVNode("view",{class:"detail-header"},[e.createElementVNode("text",{class:"detail-title"},"详情描述")]),e.createElementVNode("view",{class:"detail-content"},[e.createElementVNode("text",{class:"detail-text"},e.toDisplayString(o.marker.description||"暂无描述内容"),1)]),e.createElementVNode("view",{class:"detail-info"},[e.createElementVNode("view",{class:"info-row"},[e.createElementVNode("text",{class:"info-label"},"标记类型"),e.createElementVNode("text",{class:"info-value"},e.toDisplayString(o.getMarkerTypeName(o.marker.type)),1)]),o.marker.radius?(e.openBlock(),e.createElementBlock("view",{key:0,class:"info-row"},[e.createElementVNode("text",{class:"info-label"},"覆盖半径"),e.createElementVNode("text",{class:"info-value"},e.toDisplayString(o.marker.radius)+"米",1)])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"info-row"},[e.createElementVNode("text",{class:"info-label"},"创建时间"),e.createElementVNode("text",{class:"info-value"},e.toDisplayString(o.formatTime(o.marker.createdAt)),1)]),o.isLoadingUser?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("view",{key:1,class:"info-row"},[e.createElementVNode("text",{class:"info-label"},"创建者"),e.createElementVNode("text",{class:"info-value"},e.toDisplayString(o.getUserName(o.marker.user)),1)]))]),o.marker.images&&o.marker.images.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"navigation-hint"},[e.createElementVNode("text",null,"向左滑动查看照片"),e.createElementVNode("text",{class:"arrow-icon"},"→")])):e.createCommentVNode("",!0)])])]),o.marker.images&&o.marker.images.length>0?(e.openBlock(),e.createElementBlock("swiper-item",{key:0},[e.createElementVNode("view",{class:"album-photos"},[e.createElementVNode("swiper",{class:"photos-swiper","indicator-dots":!0,autoplay:!1,duration:300,current:o.currentPhotoIndex,onChange:a[1]||(a[1]=(...e)=>o.onPhotoChange&&o.onPhotoChange(...e))},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.marker.images,((t,a)=>(e.openBlock(),e.createElementBlock("swiper-item",{key:a,onClick:e=>o.previewImage(a)},[e.createElementVNode("view",{class:"photo-container"},[e.createElementVNode("image",{class:"photo-image",src:o.getImageUrl(t.url),mode:"aspectFit"},null,8,["src"]),e.createElementVNode("view",{class:"photo-caption-container"},[e.createElementVNode("text",{class:"photo-caption"},e.toDisplayString(t.caption||"无描述"),1),e.createElementVNode("text",{class:"photo-index"},e.toDisplayString(a+1)+"/"+e.toDisplayString(o.marker.images.length),1)])])],8,["onClick"])))),128))],40,["current"])])])):(e.openBlock(),e.createElementBlock("swiper-item",{key:1},[e.createElementVNode("view",{class:"no-photos"},[e.createElementVNode("text",{class:"no-photos-icon"},"🖼️"),e.createElementVNode("text",{class:"no-photos-text"},"暂无照片")])]))],40,["current"]),e.createElementVNode("view",{class:"album-footer"},[e.createElementVNode("view",{class:"footer-dots"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.totalPages,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:a,class:e.normalizeClass(["footer-dot",{active:o.currentPage===a}]),onClick:e=>o.goToPage(a)},null,10,["onClick"])))),128))]),e.createElementVNode("button",{class:"navigate-btn",onClick:a[3]||(a[3]=(...e)=>o.navigateToMarker&&o.navigateToMarker(...e))},[e.createElementVNode("text",{class:"location-icon"},"📍"),e.createElementVNode("text",null,"导航到此处")])])])}],["__scopeId","data-v-249f7b76"]]);const st=he({setup(){var t;const s=X();e.ref((null==(t=s.userInfo)?void 0:t.id)||"");const o=e.ref([]),r=e.ref(!1),n=e.ref(!1),i=e.ref({breed:"",englishName:"",breedConfidence:0,purity:"",features:"",characteristics:{friendliness:0,activity:0,trainability:0,grooming:0},note:"",petType:"",identified:!0,message:""}),l=e=>{i.value={identified:!1!==e.identified,message:e.message||"",breed:e.breed||"未识别",englishName:e.englishName||"",breedConfidence:e.breedConfidence||0,purity:e.purity||"未识别",features:e.features||"无法获取特征描述",characteristics:e.characteristics||{friendliness:0,activity:0,trainability:0,grooming:0},note:e.note||"",petType:e.petType||"unknown"},i.value.identified&&c(i.value)},c=e=>{try{const t=uni.getStorageSync("petAnalysisHistory")||"[]",a=JSON.parse(t);a.unshift({id:"history-"+Date.now(),timestamp:Date.now(),result:e,images:o.value.map((e=>e.path))});const s=10;a.length>s&&a.splice(s),uni.setStorageSync("petAnalysisHistory",JSON.stringify(a))}catch(t){a("error","at pages/petIdentify/index.vue:317","保存分析历史失败:",t)}},u=e=>{uni.setClipboardData({data:e,success:()=>{uni.showToast({title:"分享内容已复制到剪贴板",icon:"none",duration:2e3})}})};return{imageList:o,maxImageCount:4,isAnalyzing:r,showResult:n,result:i,chooseImage:()=>{uni.chooseImage({count:4-o.value.length,sizeType:["compressed"],sourceType:["album","camera"],success:e=>{const t=e.tempFiles.map((e=>({path:e.path,size:e.size,uploaded:!1})));o.value=[...o.value,...t]},fail:e=>{e.errMsg&&-1!==e.errMsg.indexOf("cancel")?a("log","at pages/petIdentify/index.vue:176","用户取消选择图片"):(a("error","at pages/petIdentify/index.vue:180","选择图片失败:",e),uni.showToast({title:"选择图片失败",icon:"none"}))}})},deleteImage:e=>{o.value.splice(e,1),0===o.value.length&&(n.value=!1)},analyzeImages:()=>__async(this,null,(function*(){if(0!==o.value.length){r.value=!0,n.value=!1;try{uni.showLoading({title:"正在分析图片...",mask:!0});const e=o.value.map((e=>e.path)),t=yield je(e);uni.hideLoading(),!1===t.identified?(uni.showToast({title:t.message||"无法识别，请尝试清晰的宠物照片",icon:"none",duration:3e3}),i.value=__spreadProps(__spreadValues({},t),{breed:"未能识别",breedConfidence:0,purity:"未知",characteristics:{friendliness:0,activity:0,trainability:0,grooming:0}})):(l(t),n.value=!0)}catch(e){a("error","at pages/petIdentify/index.vue:254","分析失败:",e),uni.hideLoading(),uni.showToast({title:e.message||"分析失败，请重试",icon:"none",duration:3e3})}finally{r.value=!1}}else uni.showToast({title:"请先上传宠物照片",icon:"none"})})),formatCharName:e=>({friendliness:"友善度",activity:"活跃度",trainability:"可训练性",grooming:"毛发护理需求"}[e]||e),shareResult:()=>{if(n.value)try{const e=`我的宠物是${i.value.breed}(${i.value.englishName})，${i.value.purity}，${i.value.features}`;uni.share({provider:"weixin",scene:"WXSceneSession",type:0,title:`宠物识别结果：${i.value.breed}`,summary:e.substring(0,80)+"...",imageUrl:o.value.length>0?o.value[0].path:"",success:e=>{a("log","at pages/petIdentify/index.vue:358","分享成功:",e)},fail:t=>{a("error","at pages/petIdentify/index.vue:361","分享失败:",t),u(e)}})}catch(e){a("error","at pages/petIdentify/index.vue:373","分享处理异常:",e),u(`我的宠物是${i.value.breed}，${i.value.purity}`)}else uni.showToast({title:"暂无结果可分享",icon:"none"})},saveResult:()=>{uni.showToast({title:"正在生成图片...",icon:"none"}),setTimeout((()=>{uni.showToast({title:"保存成功",icon:"success"})}),2e3)},goBack:()=>{uni.navigateBack()}}}},[["render",function(t,a,s,o,r,n){return e.openBlock(),e.createElementBlock("view",{class:"container"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("view",{class:"back-btn",onClick:a[0]||(a[0]=(...e)=>o.goBack&&o.goBack(...e))},[e.createElementVNode("text",{class:"icon"},"←")]),e.createElementVNode("text",{class:"title"},"宠物识别分析")]),e.createElementVNode("view",{class:"content"},[e.createElementVNode("view",{class:"tips-section"},[e.createElementVNode("text",{class:"tips-title"},"请上传您宠物的多角度照片"),e.createElementVNode("text",{class:"tips-desc"},"为了更准确分析，建议上传正面、侧面及特写照片")]),e.createElementVNode("view",{class:"upload-section"},[e.createElementVNode("view",{class:"image-list"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.imageList,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:a,class:"image-item"},[e.createElementVNode("image",{src:t.path,mode:"aspectFill",class:"pet-image"},null,8,["src"]),e.createElementVNode("view",{class:"delete-btn",onClick:e=>o.deleteImage(a)},[e.createElementVNode("text",{class:"delete-icon"},"×")],8,["onClick"])])))),128)),o.imageList.length<o.maxImageCount?(e.openBlock(),e.createElementBlock("view",{key:0,class:"add-image-btn",onClick:a[1]||(a[1]=(...e)=>o.chooseImage&&o.chooseImage(...e))},[e.createElementVNode("text",{class:"add-icon"},"+"),e.createElementVNode("text",{class:"add-text"},"添加照片")])):e.createCommentVNode("",!0)])]),e.createElementVNode("view",{class:e.normalizeClass(["analyze-btn",{active:o.imageList.length>0}]),onClick:a[2]||(a[2]=(...e)=>o.analyzeImages&&o.analyzeImages(...e))},[e.createElementVNode("text",null,e.toDisplayString(o.isAnalyzing?"分析中...":"开始识别"),1)],2),o.showResult?(e.openBlock(),e.createElementBlock("view",{key:0,class:"result-section"},[e.createElementVNode("view",{class:"result-header"},[e.createElementVNode("text",{class:"result-title"},"识别结果")]),e.createElementVNode("view",{class:"result-content"},[e.createElementVNode("view",{class:"result-item"},[e.createElementVNode("text",{class:"item-label"},"品种:"),e.createElementVNode("text",{class:"item-value"},e.toDisplayString(o.result.breed),1),e.createElementVNode("text",{class:"confidence"},"(置信度: "+e.toDisplayString(o.result.breedConfidence)+"%)",1)]),e.createElementVNode("view",{class:"result-item"},[e.createElementVNode("text",{class:"item-label"},"血统纯度评估:"),e.createElementVNode("text",{class:"item-value"},e.toDisplayString(o.result.purity),1)]),e.createElementVNode("view",{class:"result-item features"},[e.createElementVNode("text",{class:"item-label"},"特征描述:"),e.createElementVNode("text",{class:"item-value"},e.toDisplayString(o.result.features),1)]),e.createElementVNode("view",{class:"characteristics"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.result.characteristics,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:a,class:"char-item"},[e.createElementVNode("text",{class:"char-label"},e.toDisplayString(o.formatCharName(a))+":",1),e.createElementVNode("view",{class:"char-value-bar"},[e.createElementVNode("view",{class:"char-value-fill",style:e.normalizeStyle({width:t+"%"})},null,4)]),e.createElementVNode("text",{class:"char-percent"},e.toDisplayString(t)+"%",1)])))),128))]),o.result.note?(e.openBlock(),e.createElementBlock("view",{key:0,class:"result-note"},[e.createElementVNode("text",{class:"note-title"},"附加说明:"),e.createElementVNode("text",{class:"note-content"},e.toDisplayString(o.result.note),1)])):e.createCommentVNode("",!0)]),e.createElementVNode("view",{class:"action-buttons"},[e.createElementVNode("view",{class:"action-btn share",onClick:a[3]||(a[3]=(...e)=>o.shareResult&&o.shareResult(...e))},[e.createElementVNode("text",null,"分享结果")]),e.createElementVNode("view",{class:"action-btn save",onClick:a[4]||(a[4]=(...e)=>o.saveResult&&o.saveResult(...e))},[e.createElementVNode("text",null,"保存至相册")])])])):e.createCommentVNode("",!0)])])}]]),ot={__name:"my-markers",setup(t){const s=ae(),o=X(),r=e.ref([]),n=e.ref(!0),i=e.ref(!1),l=e.ref(null),c=e.ref(!1),u=e.reactive({_id:"",title:"",description:"",type:"general",customTypeName:"",color:"#FF5733",isPublic:!0,latitude:0,longitude:0,radius:1,properties:{}}),d=["#FF5733","#33FF57","#3357FF","#FF33F5","#F5FF33","#33FFF5"],m=[{value:"general",label:"一般标记"},{value:"pet_friendly",label:"宠物友好"},{value:"danger",label:"危险区域"},{value:"scenic",label:"风景优美"},{value:"pet_service",label:"宠物服务"},{value:"custom",label:"自定义"}],p=()=>__async(this,null,(function*(){var e,t;n.value=!0;try{o.userInfo&&o.user||(a("log","at pages/profile/my-markers.vue:191","用户信息未加载，尝试获取..."),yield o.fetchUserInfo());const n=(null==(e=o.userInfo)?void 0:e._id)||(null==(t=o.user)?void 0:t._id);if(!n)return a("error","at pages/profile/my-markers.vue:199","用户ID不可用，可能未登录"),uni.showToast({title:"请先登录",icon:"none"}),void setTimeout((()=>{uni.navigateTo({url:"/pages/login/login"})}),1500);a("log","at pages/profile/my-markers.vue:214","开始获取用户标记，用户ID:",n);const i=yield s.fetchUserMarkers(n);r.value=i||[],a("log","at pages/profile/my-markers.vue:220","获取到用户标记数量:",r.value.length)}catch(i){a("error","at pages/profile/my-markers.vue:222","获取用户标记失败:",i),uni.showToast({title:"加载标记失败",icon:"none"})}finally{n.value=!1}})),g=e=>{if(!e)return"未知时间";const t=new Date(e);return`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")}`},v=e=>{if("custom"===e.type&&e.properties&&e.properties.customTypeName)return`自定义: ${e.properties.customTypeName}`;const t=m.find((t=>t.value===e.type));return t?t.label:"未知类型"},h=()=>{if("custom"===u.type&&u.customTypeName)return`自定义: ${u.customTypeName}`;const e=m.find((e=>e.value===u.type));return e?e.label:"请选择标记类型"},f=()=>{uni.navigateTo({url:"/pages/map/add-marker"})},y=()=>{c.value=!1},w=e=>{const t=e.detail.value;u.type=m[t].value,"custom"!==u.type&&(u.customTypeName="")},k=e=>{u.radius=parseFloat(e.detail.value)},E=()=>{u.isPublic=!u.isPublic},N=()=>__async(this,null,(function*(){var e,t;if(!u.title)return void uni.showToast({title:"请输入标记标题",icon:"none"});if("custom"===u.type&&!u.customTypeName.trim())return void uni.showToast({title:"请输入自定义类型名称",icon:"none"});const o={title:u.title,description:u.description,type:u.type,color:u.color,radius:u.radius,isPublic:u.isPublic,properties:__spreadValues({},u.properties)};"custom"===u.type&&(o.properties.customTypeName=u.customTypeName.trim());try{uni.showLoading({title:"保存中...",mask:!0});const e=yield s.updateMarker({id:u._id,data:o});if(uni.hideLoading(),e){c.value=!1;const t=r.value.findIndex((e=>e._id===u._id));-1!==t&&(r.value[t]=__spreadValues({},e)),uni.showToast({title:"标记已更新",icon:"success"})}else uni.showModal({title:"更新失败",content:"服务器处理请求失败，请稍后再试",showCancel:!1})}catch(n){uni.hideLoading(),a("error","at pages/profile/my-markers.vue:407","更新标记失败:",n);const s=(null==(t=null==(e=n.response)?void 0:e.data)?void 0:t.message)||n.message||"服务器连接失败，请检查网络";uni.showModal({title:"更新失败",content:s,showCancel:!1})}})),S=()=>__async(this,null,(function*(){var e,t;if(!l.value)return;const o=l.value,n=r.value.findIndex((e=>e._id===o));n>=0&&(r.value[n].isDeleting=!0),uni.showLoading({title:"删除中...",mask:!0});try{const e=yield s.deleteMarker(o);uni.hideLoading(),e?(uni.showToast({title:"标记已删除",icon:"success",duration:2e3}),r.value=r.value.filter((e=>e._id!==o))):(n>=0&&(r.value[n].isDeleting=!1),uni.showModal({title:"删除失败",content:"服务器处理请求失败，请稍后再试",showCancel:!1}))}catch(c){uni.hideLoading(),n>=0&&(r.value[n].isDeleting=!1),a("error","at pages/profile/my-markers.vue:481","删除标记失败:",c);const s=(null==(t=null==(e=c.response)?void 0:e.data)?void 0:t.message)||c.message||"服务器连接失败，请检查网络";uni.showModal({title:"删除失败",content:s,showCancel:!1})}finally{i.value=!1,l.value=null}}));return e.onMounted((()=>{p()})),(t,s)=>(e.openBlock(),e.createElementBlock("view",{class:"my-markers-container"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("text",{class:"page-title"},"我的标记")]),e.createElementVNode("view",{class:"markers-list"},[n.value?(e.openBlock(),e.createElementBlock("view",{key:0,class:"loading-container"},[e.createElementVNode("text",{class:"loading-text"},"加载中...")])):0===r.value.length?(e.openBlock(),e.createElementBlock("view",{key:1,class:"empty-state"},[e.createElementVNode("image",{class:"empty-icon",src:"/static/images/empty-markers.png",mode:"aspectFit"}),e.createElementVNode("text",{class:"empty-text"},"您还没有添加任何标记"),e.createElementVNode("button",{class:"add-btn",onClick:f},"添加标记")])):(e.openBlock(!0),e.createElementBlock(e.Fragment,{key:2},e.renderList(r.value,((t,s)=>(e.openBlock(),e.createElementBlock("view",{class:"marker-item",key:t._id,onClick:e=>(e=>{a("log","at pages/profile/my-markers.vue:266","编辑标记:",e),Object.assign(u,{_id:e._id,title:e.title||"",description:e.description||"",type:e.type||"general",color:e.color||"#FF5733",isPublic:!1!==e.isPublic,latitude:e.latitude||0,longitude:e.longitude||0,radius:e.radius||1,properties:e.properties||{}}),"custom"===e.type&&e.properties&&e.properties.customTypeName?u.customTypeName=e.properties.customTypeName:u.customTypeName="",c.value=!0})(t)},[e.createElementVNode("view",{class:"marker-icon",style:e.normalizeStyle({backgroundColor:t.color||"#FF5733"})},[e.createElementVNode("image",{class:"icon",src:t.icon||"/static/images/marker.png",mode:"aspectFit"},null,8,["src"])],4),e.createElementVNode("view",{class:"marker-info"},[e.createElementVNode("text",{class:"marker-title"},e.toDisplayString(t.title),1),e.createElementVNode("text",{class:"marker-desc"},e.toDisplayString(t.description||"无描述"),1),e.createElementVNode("text",{class:"marker-type"},"类型: "+e.toDisplayString(v(t)),1),e.createElementVNode("text",{class:"marker-date"},"创建时间: "+e.toDisplayString(g(t.createdAt)),1)]),e.createElementVNode("view",{class:"marker-actions"},[e.createElementVNode("button",{class:"action-btn delete-btn",onClick:e.withModifiers((e=>{return a=t._id,l.value=a,void(i.value=!0);var a}),["stop"])},"删除",8,["onClick"])])],8,["onClick"])))),128))]),i.value?(e.openBlock(),e.createElementBlock("view",{key:0,class:"confirm-dialog"},[e.createElementVNode("view",{class:"dialog-content"},[e.createElementVNode("text",{class:"dialog-title"},"确认删除"),e.createElementVNode("text",{class:"dialog-text"},"确定要删除此标记吗？此操作不可撤销。"),e.createElementVNode("view",{class:"dialog-buttons"},[e.createElementVNode("button",{class:"dialog-btn cancel-btn",onClick:s[0]||(s[0]=e=>i.value=!1)},"取消"),e.createElementVNode("button",{class:"dialog-btn confirm-btn",onClick:S},"确认删除")])])])):e.createCommentVNode("",!0),c.value?(e.openBlock(),e.createElementBlock("view",{key:1,class:"edit-dialog"},[e.createElementVNode("view",{class:"edit-dialog-content"},[e.createElementVNode("view",{class:"edit-dialog-header"},[e.createElementVNode("text",{class:"edit-dialog-title"},"编辑标记"),e.createElementVNode("text",{class:"edit-close-btn",onClick:y},"×")]),e.createElementVNode("view",{class:"edit-form"},[e.createElementVNode("view",{class:"edit-form-item"},[e.createElementVNode("text",{class:"edit-form-label"},[e.createTextVNode("标记标题"),e.createElementVNode("text",{class:"required"},"*")]),e.withDirectives(e.createElementVNode("input",{class:"edit-form-input",type:"text","onUpdate:modelValue":s[1]||(s[1]=e=>u.title=e),placeholder:"请输入标记标题",maxlength:"50"},null,512),[[e.vModelText,u.title]])]),e.createElementVNode("view",{class:"edit-form-item"},[e.createElementVNode("text",{class:"edit-form-label"},"标记描述"),e.withDirectives(e.createElementVNode("textarea",{class:"edit-form-textarea","onUpdate:modelValue":s[2]||(s[2]=e=>u.description=e),placeholder:"请输入标记描述",maxlength:"200"},null,512),[[e.vModelText,u.description]])]),e.createElementVNode("view",{class:"edit-form-item"},[e.createElementVNode("text",{class:"edit-form-label"},"标记类型"),e.createElementVNode("picker",{class:"edit-form-picker",range:m,"range-key":"label",onChange:w},[e.createElementVNode("view",{class:"edit-picker-value"},e.toDisplayString(h()),1)],32)]),"custom"===u.type?(e.openBlock(),e.createElementBlock("view",{key:0,class:"edit-form-item"},[e.createElementVNode("text",{class:"edit-form-label"},"自定义类型名称"),e.withDirectives(e.createElementVNode("input",{class:"edit-form-input",type:"text","onUpdate:modelValue":s[3]||(s[3]=e=>u.customTypeName=e),placeholder:"请输入自定义类型名称",maxlength:"20"},null,512),[[e.vModelText,u.customTypeName]])])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"edit-form-item"},[e.createElementVNode("text",{class:"edit-form-label"},"标记颜色"),e.createElementVNode("view",{class:"edit-color-selector"},[(e.openBlock(),e.createElementBlock(e.Fragment,null,e.renderList(d,((t,a)=>e.createElementVNode("view",{key:a,class:e.normalizeClass(["edit-color-item",{active:u.color===t}]),style:e.normalizeStyle({backgroundColor:t}),onClick:e=>{return a=t,void(u.color=a);var a}},null,14,["onClick"]))),64))])]),e.createElementVNode("view",{class:"edit-form-item"},[e.createElementVNode("text",{class:"edit-form-label"},"覆盖半径 (千米)"),e.createElementVNode("slider",{class:"edit-radius-slider",min:.1,max:10,step:.1,value:u.radius||1,"show-value":!0,onChange:k},null,40,["value"]),e.createElementVNode("text",{class:"edit-radius-value"},e.toDisplayString(u.radius||1)+"km",1)]),e.createElementVNode("view",{class:"edit-form-item checkbox-item"},[e.createElementVNode("checkbox",{checked:u.isPublic,onClick:E},null,8,["checked"]),e.createElementVNode("text",{class:"checkbox-label"},"公开此标记（允许其他用户看到）")]),e.createElementVNode("view",{class:"edit-form-actions"},[e.createElementVNode("button",{class:"edit-btn cancel-btn",onClick:y},"取消"),e.createElementVNode("button",{class:"edit-btn save-btn",onClick:N},"保存")])])])])):e.createCommentVNode("",!0)]))}};var rt=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,62,0,62,0,63,52,53,54,55,56,57,58,59,60,61,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,0,0,0,0,63,0,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51];const nt={getRandomValues(e){if(!(e instanceof Int8Array||e instanceof Uint8Array||e instanceof Int16Array||e instanceof Uint16Array||e instanceof Int32Array||e instanceof Uint32Array||e instanceof Uint8ClampedArray))throw new Error("Expected an integer array");if(e.byteLength>65536)throw new Error("Can only request a maximum of 65536 bytes");return function(e,t){for(var a,s=e.length,o="="===e[s-2]?2:"="===e[s-1]?1:0,r=0,n=s-o&4294967292,i=0;i<n;i+=4)a=rt[e.charCodeAt(i)]<<18|rt[e.charCodeAt(i+1)]<<12|rt[e.charCodeAt(i+2)]<<6|rt[e.charCodeAt(i+3)],t[r++]=a>>16&255,t[r++]=a>>8&255,t[r++]=255&a;1===o&&(a=rt[e.charCodeAt(i)]<<10|rt[e.charCodeAt(i+1)]<<4|rt[e.charCodeAt(i+2)]>>2,t[r++]=a>>8&255,t[r++]=255&a),2===o&&(a=rt[e.charCodeAt(i)]<<2|rt[e.charCodeAt(i+1)]>>4,t[r++]=255&a)}(t("DCloud-Crypto").getRandomValues(e.byteLength),new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),e}};function it(e,t,s){return __async(this,null,(function*(){const o=function(e){const t="abcdefghijklmnopqrstuvwxyz0123456789";let a="";for(let s=0;s<e;s++)a+=t.charAt(Math.floor(36*Math.random()));return a}(8),r=Math.floor(Date.now()/1e3).toString(),n=JSON.stringify(t),i=e+n+o+r;try{const e=yield function(e,t){return __async(this,null,(function*(){try{const a=new TextEncoder,s=a.encode(t),o=a.encode(e),r=yield nt.subtle.importKey("raw",s,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),n=yield nt.subtle.sign("HMAC",r,o);return Array.from(new Uint8Array(n)).map((e=>e.toString(16).padStart(2,"0"))).join("")}catch(s){throw a("error","at utils/vetmew.js:88","HMAC计算失败 (Web Crypto API)",s),s}}))}(i,s),t=function(e){const t=Array.from(e).map((e=>String.fromCharCode(e))).join("");return btoa(t)}(new Uint8Array(e.match(/.{1,2}/g).map((e=>parseInt(e,16)))));return a("log","at utils/vetmew.js:123","签名计算成功",{nonce:o,timestamp:r,signature:t,signStr:i}),{signature:t,timestamp:r,nonce:o}}catch(l){throw a("error","at utils/vetmew.js:136","签名生成失败:",l),l}}))}function lt(e){return __async(this,arguments,(function*(e,t={}){const s=t.apiKey||"vmb1c7f72adc9473f7",o=t.apiSecret||"44yth8axrytm8ux23f53c78bjw3kg20h",r=t.apiPath||"/open/v1/chat",n="/vetmew-api"+r;try{let t;a("log","at utils/vetmewProxy.js:20","准备调用API，请求数据:",e);try{t=yield it(r,e,o)}catch(i){throw a("error","at utils/vetmewProxy.js:27","签名生成失败:",i),i}const u={"Content-Type":"application/json","X-ApiKey":s,"X-Timestamp":t.timestamp,"X-Nonce":t.nonce,"X-Signature":t.signature};a("log","at utils/vetmewProxy.js:40","发送API请求",{url:n,headers:u});const d=yield fetch(n,{method:"POST",headers:u,body:JSON.stringify(e)});if(!d.ok)throw new Error(`API请求失败: ${d.status} ${d.statusText}`);const m=yield d.text();if(a("log","at utils/vetmewProxy.js:58","接收到原始响应"),m.includes("data:")){a("log","at utils/vetmewProxy.js:62","检测到SSE流式响应");const e=m.split("\n\n");a("log","at utils/vetmewProxy.js:66",`识别到${e.length}个响应片段`);let t="",s="";for(const o of e){const e=o.trim();if(e&&e.startsWith("data:"))try{if("data: [DONE]"===e){a("log","at utils/vetmewProxy.js:79","流式响应完成");break}const o=e.substring(5).trim(),r=JSON.parse(o);r.msg&&(t+=r.msg),r.conversation_id&&!s&&(s=r.conversation_id)}catch(l){a("warn","at utils/vetmewProxy.js:97","解析SSE片段失败:",l,e)}}return a("log","at utils/vetmewProxy.js:101","完整响应消息:",t),{code:0,message:"成功",data:t,conversation_id:s,streaming:!0}}try{const e=JSON.parse(m);return a("log","at utils/vetmewProxy.js:115","解析为标准JSON响应:",e),e}catch(c){return a("error","at utils/vetmewProxy.js:118","JSON解析错误:",c),{code:9999,message:"服务器返回了无效的数据格式",data:null,rawResponse:m}}}catch(u){return a("error","at utils/vetmewProxy.js:128","汪喵灵灵API调用出错:",u),{code:9999,message:`API调用失败: ${u.message}`,data:null}}}))}const ct=he({setup(){const s=e.ref([]),o=e.ref(""),r=e.ref(!1),n=e.ref(0),i=e.ref(!1),l=e.ref(""),c=e.ref(""),u=e.ref(""),d=e.ref(""),m=e.ref(0),p=e.computed((()=>{const e="undefined"!=typeof window&&"undefined"!=typeof document,s="undefined"!=typeof uni&&void 0===t;try{const t=uni.getSystemInfoSync(),o=t.platform,r=t.uniPlatform;return a("log","at pages/ai-medical/index.vue:162","环境检测 - 平台:",o,"设备:",t.model,"uni平台:",r),a("log","at pages/ai-medical/index.vue:163","是否H5环境:",e,"是否UniApp H5:",s),e||"web"===o||"web"===r}catch(o){return a("error","at pages/ai-medical/index.vue:168","获取系统信息失败:",o),e}})),g=[{name:"问诊服务",path:"/open/v1/chat",requiresPetInfo:!0,requiresImage:!1,isConsultation:!0},{name:"品种识别",path:"/open/v1/breed-recognition",requiresPetInfo:!1,requiresImage:!0,isConsultation:!1},{name:"情绪分析",path:"/open/v1/emotion-recognition",requiresPetInfo:!1,requiresImage:!0,isConsultation:!1},{name:"粪便分析",path:"/open/v1/feces-recognition",requiresPetInfo:!0,requiresImage:!0,isConsultation:!1},{name:"皮肤分析",path:"/open/v1/skin-recognition",requiresPetInfo:!0,requiresImage:!0,isConsultation:!1},{name:"尿液分析",path:"/open/v1/urine-recognition",requiresPetInfo:!0,requiresImage:!0,isConsultation:!1},{name:"呕吐物分析",path:"/open/v1/vomitus-recognition",requiresPetInfo:!0,requiresImage:!0,isConsultation:!1},{name:"耳道分析",path:"/open/v1/ear-canal-recognition",requiresPetInfo:!0,requiresImage:!0,isConsultation:!1}],v=e.computed((()=>g[m.value])),h=e.computed((()=>v.value.isConsultation)),f=["狗","猫"],y=e.ref(0),w={"狗":1,"猫":2},k=["公","母"],E=e.ref(0),N={"公":1,"母":2},S=["未绝育","已绝育"],V=e.ref(0),_={"未绝育":1,"已绝育":2},P=e.reactive({nick_name:"",breed:1,birth:"2023-01-01",gender:1,fertility:1}),I="vmb1c7f72adc9473f7",x="44yth8axrytm8ux23f53c78bjw3kg20h",b=(e,t)=>{s.value.push({type:"user",content:"图片消息",imageUrl:e}),U(),A(t,e)},C=e=>new Promise(((t,s)=>{if(p.value)return a("log","at pages/ai-medical/index.vue:467","检测到H5环境，不转换base64，使用URL方式"),void t("");try{if("function"!=typeof uni.getFileSystemManager)return a("warn","at pages/ai-medical/index.vue:476","getFileSystemManager不可用，使用URL方式"),void t("");uni.getFileSystemManager().readFile({filePath:e,encoding:"base64",success:e=>{a("log","at pages/ai-medical/index.vue:486","base64转换成功"),t(e.data)},fail:e=>{a("error","at pages/ai-medical/index.vue:490","读取图片失败:",e),t("")}})}catch(o){a("error","at pages/ai-medical/index.vue:496","转换base64发生错误:",o),t("")}})),T=()=>__async(this,null,(function*(){r.value=!0,c.value&&(s.value.push({type:"user",content:"图片分析请求",imageUrl:c.value}),U());try{const t={};if(u.value)t.image=u.value;else if(c.value){if(!c.value.startsWith("http"))return uni.showToast({title:"图片格式不支持，请提供有效URL",icon:"none"}),void(r.value=!1);t.url=c.value}v.value.requiresPetInfo&&(Object.assign(t,{breed:P.breed,birth:P.birth,gender:P.gender,fertility:P.fertility}),"品种识别"!==v.value.name&&"情绪分析"!==v.value.name&&(t.nick_name=P.nick_name)),a("log","at pages/ai-medical/index.vue:612","准备发送分析请求:",t);const o=yield lt(t,{apiKey:I,apiSecret:x,apiPath:v.value.path});if(a("log","at pages/ai-medical/index.vue:621","API响应:",o),o&&0===o.code){let t="";if("string"==typeof o.data)try{const e=JSON.parse(o.data);t=M(e,v.value.name)}catch(e){t=o.data||"分析完成"}else t=M(o.data,v.value.name);s.value.push({type:"ai",content:t})}else B(o)}catch(t){a("error","at pages/ai-medical/index.vue:656","API调用异常:",t),s.value.push({type:"ai",content:"网络连接失败，请检查您的网络后重试。"})}finally{r.value=!1,U()}})),M=(e,t)=>{if(!e)return"分析完成";if("string"==typeof e)return e;if(e.text)return e.text;try{if(Array.isArray(e)&&e.length>0&&e[0].text)return e[0].text;if(e.contents){if("string"==typeof e.contents)return e.contents;if(Array.isArray(e.contents)&&e.contents.length>0)return e.contents.map((e=>e.text||e.content||JSON.stringify(e))).join("\n")}if(e.content)return e.content}catch(s){a("error","at pages/ai-medical/index.vue:704","解析嵌套JSON出错:",s)}switch(t){case"品种识别":if(e.breed)return`识别结果：${e.breed}\n可信度：${(100*e.confidence).toFixed(2)}%`;break;case"情绪分析":if(e.emotion)return`情绪分析结果：${e.emotion}\n可信度：${(100*e.confidence).toFixed(2)}%`;break;case"粪便分析":case"皮肤分析":case"尿液分析":case"呕吐物分析":case"耳道分析":let t="";return e.conclusion&&(t+=`诊断结论：${e.conclusion}\n\n`),e.analysis&&(t+=`详细分析：${e.analysis}\n\n`),e.suggestion&&(t+=`建议：${e.suggestion}`),t||D(e)}return D(e)},D=e=>{try{let a,s="string"==typeof e?e:JSON.stringify(e);try{a="object"==typeof e?e:JSON.parse(s)}catch(t){return s}if(a.text)return a.text;if(a.message)return a.message;if(a.content)return a.content;if(a.data)return D(a.data);if(a.choices&&Array.isArray(a.choices)&&a.choices.length>0){const e=a.choices[0];if(e.text)return e.text;if(e.message&&e.message.content)return e.message.content}return s=JSON.stringify(a,null,2),s=s.replace(/^{|}$/g,""),s=s.replace(/^\s*"([^"]+)":\s*/gm,"$1: "),s=s.replace(/,$/gm,""),s=s.replace(/"msg_id":[^,}]+,?/g,""),s}catch(t){return a("error","at pages/ai-medical/index.vue:783","清理JSON出错:",t),"分析完成，请查看结果"}},A=(e,t="")=>__async(this,null,(function*(){if(!r.value){r.value=!0;try{const n={breed:P.breed,birth:P.birth,gender:P.gender,nick_name:P.nick_name,fertility:P.fertility};if(e&&e.length>0)n.image=e;else if(t&&t.startsWith("http"))n.url=t;else{if(!c.value||!c.value.startsWith("http"))return uni.showToast({title:"无法处理图片，请尝试输入URL",icon:"none"}),void(r.value=!1);n.url=c.value}l.value&&(n.conversation_id=l.value),a("log","at pages/ai-medical/index.vue:927","准备发送图片请求");const i=yield lt(n,{apiKey:I,apiSecret:x,apiPath:v.value.path});if(a("log","at pages/ai-medical/index.vue:936","API响应:",i),i&&0===i.code){i.conversation_id&&(l.value=i.conversation_id);let e="";if("string"==typeof i.data)try{const t=JSON.parse(i.data);e=M(t,v.value.name)}catch(o){e=i.data||"我已分析您上传的图片..."}else e=M(i.data,v.value.name);s.value.push({type:"ai",content:e})}else B(i)}catch(n){a("error","at pages/ai-medical/index.vue:975","图片API调用异常:",n),s.value.push({type:"ai",content:"图片处理失败，请稍后重试。"})}finally{r.value=!1,U()}}})),B=e=>{let t="抱歉，我遇到了一些问题，请稍后再试。";if(e&&e.code)switch(e.code){case 6001:t="无效的API密钥，请联系管理员。";break;case 6002:t="调用过于频繁，请稍后再试。";break;case 6003:t="调用次数不足，请联系管理员。";break;case 6004:case 6005:t="签名验证失败，请联系管理员。";break;case 6006:t="请求参数无效，请检查输入。";break;case 6007:t="会话已结束，请重新开始对话。";break;case 6008:t="系统正忙，请稍后再试。";break;case 6009:t="您的输入包含敏感词汇，请调整后重试。";break;case 9999:e.rawResponse?(a("log","at pages/ai-medical/index.vue:1021","原始错误响应:",e.rawResponse),t=e.rawResponse.includes("<!DOCTYPE html>")?"服务器返回了HTML页面而不是API响应，可能是代理配置错误或服务器异常。":"服务器返回格式错误，请联系管理员。"):t=`服务器连接失败: ${e.message}`;break;default:t=`服务器返回错误: ${e.code||"未知错误"}`}s.value.push({type:"ai",content:t}),a("error","at pages/ai-medical/index.vue:1042","API请求错误:",e)},U=()=>{e.nextTick((()=>{n.value=999999}))};return{messages:s,inputMessage:o,isLoading:r,scrollTop:n,chatStarted:i,petInfo:P,petTypes:f,petTypeIndex:y,genders:k,genderIndex:E,fertilityOptions:S,fertilityIndex:V,imageUrl:c,imageUrlInput:d,isH5Platform:p,serviceTypes:g,selectedServiceIndex:m,currentService:v,isConsultationService:h,goBack:()=>{uni.navigateBack()},sendMessage:()=>__async(this,null,(function*(){if(!o.value.trim()||r.value||!h.value)return;const e=o.value.trim();o.value="",s.value.push({type:"user",content:e}),U(),r.value=!0;try{const o={msg:e,breed:P.breed,birth:P.birth,gender:P.gender,nick_name:P.nick_name,fertility:P.fertility};l.value&&(o.conversation_id=l.value,a("log","at pages/ai-medical/index.vue:822","使用现有会话ID继续对话:",l.value)),a("log","at pages/ai-medical/index.vue:825","准备发送请求:",o);const r=yield lt(o,{apiKey:I,apiSecret:x,apiPath:v.value.path});if(a("log","at pages/ai-medical/index.vue:834","API响应:",r),r&&0===r.code){r.conversation_id&&(l.value=r.conversation_id,a("log","at pages/ai-medical/index.vue:843","保存会话ID:",l.value));let e="";if("string"==typeof r.data)try{const t=JSON.parse(r.data);e=M(t,v.value.name)}catch(t){e=r.data||"我正在分析您的问题..."}else e=M(r.data,v.value.name);s.value.push({type:"ai",content:e})}else B(r)}catch(n){a("error","at pages/ai-medical/index.vue:874","API调用异常:",n),s.value.push({type:"ai",content:"网络连接失败，请检查您的网络后重试。"})}finally{r.value=!1,U()}})),loadMoreHistory:()=>{},onPetTypeChange:e=>{y.value=e.detail.value,P.breed=w[f[y.value]]},onBirthChange:e=>{P.birth=e.detail.value},onGenderChange:e=>{E.value=e.detail.value,P.gender=N[k[E.value]]},onFertilityChange:e=>{V.value=e.detail.value,P.fertility=_[S[V.value]]},startChat:()=>{!v.value.requiresPetInfo||P.nick_name?!v.value.requiresImage||u.value?(i.value=!0,h.value?s.value.push({type:"ai",content:`您好！我是您的AI宠物医生助手。请问${P.nick_name}有什么健康问题呢？我会尽力帮助您。`}):T()):uni.showToast({title:"请上传图片",icon:"none"}):uni.showToast({title:"请输入宠物昵称",icon:"none"})},selectService:e=>{m.value=e},chooseImage:()=>__async(this,null,(function*(){try{const t=yield uni.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"]});if(t.tempFilePaths&&t.tempFilePaths.length>0)if(c.value=t.tempFilePaths[0],d.value="",p.value)try{const e=yield uni.chooseFile({count:1,extension:[".png",".jpg",".jpeg"],type:"image"});if(e.tempFiles&&e.tempFiles.length>0){const t=e.tempFiles[0],s=new FileReader;s.onload=e=>{const t=e.target.result.split(",")[1];u.value=t},s.onerror=()=>{a("error","at pages/ai-medical/index.vue:326","读取文件失败"),uni.showToast({title:"图片读取失败，请尝试输入URL",icon:"none"})},s.readAsDataURL(t)}}catch(e){a("error","at pages/ai-medical/index.vue:335","H5环境下获取文件失败:",e),uni.showToast({title:"H5环境下请使用图片URL或使用App版本",icon:"none"})}else{const e=yield C(t.tempFilePaths[0]);u.value=e}}catch(t){a("error","at pages/ai-medical/index.vue:349","选择图片失败:",t),uni.showToast({title:"选择图片失败，请尝试其他方式",icon:"none"})}})),chooseAdditionalImage:()=>__async(this,null,(function*(){if(!r.value)try{const t=yield uni.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"]});if(t.tempFilePaths&&t.tempFilePaths.length>0){const s=t.tempFilePaths[0];let o="";if(p.value)try{const e=yield uni.chooseFile({count:1,extension:[".png",".jpg",".jpeg"],type:"image"});if(e.tempFiles&&e.tempFiles.length>0){const t=e.tempFiles[0],r=new FileReader;return r.onload=e=>{o=e.target.result.split(",")[1],b(s,o)},r.onerror=()=>{a("error","at pages/ai-medical/index.vue:416","读取文件失败"),b(s,"")},void r.readAsDataURL(t)}}catch(e){return a("error","at pages/ai-medical/index.vue:424","H5环境下获取文件失败:",e),void b(s,"")}else o=yield C(s);b(s,o)}}catch(t){a("error","at pages/ai-medical/index.vue:438","选择图片失败:",t),uni.showToast({title:"选择图片失败",icon:"none",duration:2e3})}})),previewUrlImage:()=>{d.value&&(d.value.startsWith("http")?(c.value=d.value,u.value="",uni.showToast({title:"图片URL已设置",icon:"success"})):uni.showToast({title:"请输入有效的图片URL",icon:"none"}))}}}},[["render",function(t,a,s,o,r,n){return e.openBlock(),e.createElementBlock("view",{class:"ai-medical-container"},[e.createElementVNode("view",{class:"nav-bar"},[e.createElementVNode("view",{class:"back-btn",onClick:a[0]||(a[0]=(...e)=>o.goBack&&o.goBack(...e))},[e.createElementVNode("text",{class:"icon"},"←")]),e.createElementVNode("text",{class:"title"},"AI宠物医疗助手")]),o.chatStarted?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("view",{key:0,class:"service-selector"},[e.createElementVNode("view",{class:"selector-title"},"选择服务类型"),e.createElementVNode("scroll-view",{class:"service-list","scroll-x":"true"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.serviceTypes,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:a,class:e.normalizeClass(["service-item",{active:o.selectedServiceIndex===a}]),onClick:e=>o.selectService(a)},[e.createElementVNode("text",null,e.toDisplayString(t.name),1)],10,["onClick"])))),128))])])),o.chatStarted?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("view",{key:1,class:"pet-info-form"},[e.createElementVNode("view",{class:"form-title"},"填写"+e.toDisplayString(o.serviceTypes[o.selectedServiceIndex].name)+"所需信息",1),o.currentService.requiresPetInfo?(e.openBlock(),e.createElementBlock(e.Fragment,{key:0},[e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"宠物昵称"),e.withDirectives(e.createElementVNode("input",{type:"text","onUpdate:modelValue":a[1]||(a[1]=e=>o.petInfo.nick_name=e),placeholder:"请输入宠物昵称"},null,512),[[e.vModelText,o.petInfo.nick_name]])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"宠物类型"),e.createElementVNode("picker",{onChange:a[2]||(a[2]=(...e)=>o.onPetTypeChange&&o.onPetTypeChange(...e)),value:o.petTypeIndex,range:o.petTypes},[e.createElementVNode("view",{class:"picker-value"},e.toDisplayString(o.petTypes[o.petTypeIndex]),1)],40,["value","range"])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"出生日期"),e.createElementVNode("picker",{mode:"date",value:o.petInfo.birth,onChange:a[3]||(a[3]=(...e)=>o.onBirthChange&&o.onBirthChange(...e))},[e.createElementVNode("view",{class:"picker-value"},e.toDisplayString(o.petInfo.birth||"请选择出生日期"),1)],40,["value"])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"性别"),e.createElementVNode("picker",{onChange:a[4]||(a[4]=(...e)=>o.onGenderChange&&o.onGenderChange(...e)),value:o.genderIndex,range:o.genders},[e.createElementVNode("view",{class:"picker-value"},e.toDisplayString(o.genders[o.genderIndex]),1)],40,["value","range"])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"生育状态"),e.createElementVNode("picker",{onChange:a[5]||(a[5]=(...e)=>o.onFertilityChange&&o.onFertilityChange(...e)),value:o.fertilityIndex,range:o.fertilityOptions},[e.createElementVNode("view",{class:"picker-value"},e.toDisplayString(o.fertilityOptions[o.fertilityIndex]),1)],40,["value","range"])])],64)):e.createCommentVNode("",!0),o.currentService.requiresImage?(e.openBlock(),e.createElementBlock(e.Fragment,{key:1},[e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"上传图片"),e.createElementVNode("view",{class:"image-upload-area",onClick:a[6]||(a[6]=(...e)=>o.chooseImage&&o.chooseImage(...e))},[o.imageUrl?(e.openBlock(),e.createElementBlock("image",{key:0,src:o.imageUrl,mode:"aspectFit",class:"preview-image"},null,8,["src"])):(e.openBlock(),e.createElementBlock("view",{key:1,class:"upload-placeholder"},[e.createElementVNode("text",{class:"upload-icon"},"+"),e.createElementVNode("text",{class:"upload-text"},"点击上传图片")]))])]),o.isH5Platform?(e.openBlock(),e.createElementBlock("view",{key:0,class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"或输入图片URL"),e.withDirectives(e.createElementVNode("input",{type:"text","onUpdate:modelValue":a[7]||(a[7]=e=>o.imageUrlInput=e),placeholder:"https://example.com/image.jpg"},null,512),[[e.vModelText,o.imageUrlInput]]),o.imageUrlInput?(e.openBlock(),e.createElementBlock("view",{key:0,class:"url-preview-btn",onClick:a[8]||(a[8]=(...e)=>o.previewUrlImage&&o.previewUrlImage(...e))},"预览")):e.createCommentVNode("",!0)])):e.createCommentVNode("",!0)],64)):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"start-chat-btn",onClick:a[9]||(a[9]=(...e)=>o.startChat&&o.startChat(...e))},[e.createElementVNode("text",null,"开始"+e.toDisplayString(o.currentService.name),1)])])),o.chatStarted?(e.openBlock(),e.createElementBlock("view",{key:2,class:"chat-interface"},[e.createElementVNode("scroll-view",{class:"chat-container","scroll-y":"true","scroll-top":o.scrollTop,onScrolltoupper:a[10]||(a[10]=(...e)=>o.loadMoreHistory&&o.loadMoreHistory(...e))},[e.createElementVNode("view",{class:"chat-messages"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.messages,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:a,class:e.normalizeClass(["message-item",t.type])},[t.imageUrl?(e.openBlock(),e.createElementBlock("image",{key:0,src:t.imageUrl,mode:"widthFix",class:"message-image"},null,8,["src"])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"message-content"},[e.createElementVNode("text",null,e.toDisplayString(t.content),1)])],2)))),128))])],40,["scroll-top"]),e.createElementVNode("view",{class:"input-area"},[e.createElementVNode("view",{class:"input-box"},[e.withDirectives(e.createElementVNode("input",{type:"text","onUpdate:modelValue":a[11]||(a[11]=e=>o.inputMessage=e),placeholder:"请输入您的问题...",onConfirm:a[12]||(a[12]=(...e)=>o.sendMessage&&o.sendMessage(...e)),disabled:o.isLoading||!o.isConsultationService},null,40,["disabled"]),[[e.vModelText,o.inputMessage]]),e.createElementVNode("view",{class:e.normalizeClass(["send-btn",{disabled:o.isLoading||!o.isConsultationService}]),onClick:a[13]||(a[13]=(...e)=>o.sendMessage&&o.sendMessage(...e))},[e.createElementVNode("text",{class:"icon"},e.toDisplayString(o.isLoading?"⌛":"➤"),1)],2),o.isConsultationService?(e.openBlock(),e.createElementBlock("view",{key:0,class:"upload-btn",onClick:a[14]||(a[14]=(...e)=>o.chooseAdditionalImage&&o.chooseAdditionalImage(...e))},[e.createElementVNode("text",{class:"icon"},"📷")])):e.createCommentVNode("",!0)])])])):e.createCommentVNode("",!0),e.createElementVNode("canvas",{"canvas-id":"imageCanvas",style:{position:"absolute",left:"-1000px",top:"-1000px",width:"100px",height:"100px"}})])}]]);__definePage("pages/login/login",Z),__definePage("pages/login/register",ee),__definePage("pages/map/map",ke),__definePage("pages/community/community",Se),__definePage("pages/index/index",_e),__definePage("pages/community/create",Pe),__definePage("pages/community/post-detail",Ie),__definePage("pages/pet/management",Ce),__definePage("pages/pet/edit",Te),__definePage("pages/pet/recognition",Fe),__definePage("pages/community/my-posts",$e),__definePage("pages/walk/history",Le),__definePage("pages/profile/settings",Re),__definePage("pages/profile/profile",Oe),__definePage("pages/profile/following",We),__definePage("pages/profile/followers",ze),__definePage("pages/chat/chat",Ze),__definePage("pages/chat/index",et),__definePage("pages/map/add-marker",tt),__definePage("pages/map/marker-detail",at),__definePage("pages/petIdentify/index",st),__definePage("pages/profile/my-markers",ot),__definePage("pages/ai-medical/index",ct);const ut=e.reactive({}),dt=e.ref(!1);function mt(){return __async(this,null,(function*(){try{const t=`/static/icon-versions.json?t=${Date.now()}`;a("log","at utils/iconManager.js:24","尝试加载图标版本信息:",t);const s=yield fetch(t);if(!s.ok)return a("warn","at utils/iconManager.js:28",`图标版本信息加载失败 (${s.status}):`,yield s.text()),a("log","at utils/iconManager.js:31","使用空图标版本信息"),dt.value=!0,{};const o=s.headers.get("content-type");if(!o||!o.includes("application/json"))return a("warn","at utils/iconManager.js:39","图标版本信息响应不是JSON格式:",o),dt.value=!0,{};try{const e=yield s.json();return a("log","at utils/iconManager.js:46","加载到图标版本信息:",e),Object.assign(ut,e),dt.value=!0,e}catch(e){return a("error","at utils/iconManager.js:54","解析图标版本信息JSON失败:",e),dt.value=!0,{}}}catch(t){return a("error","at utils/iconManager.js:59","加载图标版本信息出错:",t),dt.value=!0,{}}}))}function pt(e){if(!e)return null;const t=e.startsWith("/")?e:`/${e}`;return ut[t]?ut[t].version:null}function gt(e='img[src*="/static/"]'){try{const t=document.querySelectorAll(e);a("log","at utils/iconManager.js:227",`找到 ${t.length} 个匹配的图标`);let s=0;return t.forEach(((e,t)=>{const o=function(e,t=!1){if(!e)return"";const a=e.split("?")[0],s=pt(a)||Date.now(),o=t?Math.random().toString(36).substring(2,8):"";return`${a}?v=${s}${o?`&r=${o}`:""}`}(e.src.split("?")[0],!0),r=new Image;r.onload=function(){a("log","at utils/iconManager.js:240",`图标 ${t+1} 已重新加载: ${o}`)},Array.from(e.attributes).forEach((e=>{"src"!==e.name&&r.setAttribute(e.name,e.value)})),r.src=o,e.parentNode&&(e.parentNode.replaceChild(r,e),s++)})),a("log","at utils/iconManager.js:260",`已刷新 ${s} 个图标`),s}catch(t){return a("error","at utils/iconManager.js:263","刷新DOM图标失败:",t),0}}setTimeout((()=>{mt().catch((e=>a("error","at utils/iconManager.js:408","初始化图标版本信息失败:",e)))}),1e3);const vt=he({components:{IconLoader:he({name:"IconLoader",emits:["update-applied"],setup(t,{emit:s}){const o=e.ref(!1),r=e.ref(0);let n=null;const i=e.ref(0),l=()=>__async(this,null,(function*(){try{yield mt(),a("log","at components/IconLoader.vue:36","图标版本信息加载完成")}catch(e){a("error","at components/IconLoader.vue:38","加载图标版本信息失败:",e)}})),c=()=>__async(this,null,(function*(){const e=Date.now();if(!(e-i.value<6e5)){i.value=e;try{if(yield function(){return __async(this,null,(function*(){const e=yield mt();let t=!1;for(const[s,o]of Object.entries(e)){const e=pt(s);(!e||o.version>e)&&(t=!0,a("log","at utils/iconManager.js:212",`发现图标更新: ${s}, 新版本: ${o.version}`))}return t}))}()){const e=document.querySelectorAll('img[src*="/static/"]');r.value=e.length,r.value>0&&(o.value=!0)}}catch(t){a("error","at components/IconLoader.vue:66","检查图标更新失败:",t)}}}));return e.onMounted((()=>__async(this,null,(function*(){yield l(),yield c(),n=setInterval(c,18e5)})))),e.onBeforeUnmount((()=>{n&&clearInterval(n)})),{showUpdate:o,pendingUpdates:r,applyUpdates:()=>{try{const e=gt();a("log","at components/IconLoader.vue:75",`已刷新 ${e} 个图标`),o.value=!1,r.value=0,s("update-applied",e)}catch(e){a("error","at components/IconLoader.vue:84","应用图标更新失败:",e)}}}}},[["render",function(t,a,s,o,r,n){return o.showUpdate?(e.openBlock(),e.createElementBlock("view",{key:0,class:"icon-update-notification"},[e.createElementVNode("view",{class:"icon-update-content",onClick:a[0]||(a[0]=(...e)=>o.applyUpdates&&o.applyUpdates(...e))},[e.createElementVNode("text",{class:"icon-update-text"},"发现图标更新，点击应用"),e.createElementVNode("view",{class:"icon-update-badge"},e.toDisplayString(o.pendingUpdates),1)])])):e.createCommentVNode("",!0)}],["__scopeId","data-v-4a93e6d8"]])},onLaunch:function(){a("log","at App.vue:13","App Launch");const e=X(),t=Y(),s=S.BASE_API_URL;if(a("log","at App.vue:21","初始化BASE_URL:",s),uni.setStorageSync("BASE_URL",s),this.initApi(),uni.getStorageSync("token")){try{const t=uni.getStorageSync("userInfo");if(t){const s=JSON.parse(t);s&&s._id&&(e.user=s,a("log","at App.vue:37","从本地存储初始化用户信息:",s.nickname,"头像:",s.avatar))}}catch(o){a("error","at App.vue:41","从本地存储恢复用户信息失败:",o)}e.init().then((()=>(a("log","at App.vue:46","用户状态初始化成功","用户信息:",e.user),e.fetchUserStats()))).catch((e=>{a("error","at App.vue:50","初始化用户状态失败:",e)}))}t.restorePetState?t.restorePetState():a("warn","at App.vue:58","宠物状态恢复方法不存在"),uni.addInterceptor("request",{fail:e=>{a("error","at App.vue:64","请求拦截到错误:",e),(404===e.statusCode||e.errMsg&&e.errMsg.includes("404"))&&(a("warn","at App.vue:68","API请求404错误:",e.errMsg),uni.showToast({title:"网络请求失败，请稍后再试",icon:"none",duration:2e3}))}})},onShow:function(){a("log","at App.vue:79","App Show");const e=X();uni.getStorageSync("token")&&!e.user&&(a("log","at App.vue:84","App Show: 检测到token但用户信息不存在，尝试重新初始化"),e.init().catch((e=>{a("error","at App.vue:86","重新初始化用户状态失败:",e)}))),uni.$api||(a("warn","at App.vue:92","API尚未初始化，尝试重新初始化"),this.initApi())},onHide:function(){a("log","at App.vue:97","App Hide")},methods:{initApi(){try{uni.$api?a("log","at App.vue:130","API已初始化，无需再次初始化"):(a("log","at App.vue:105","正在初始化API..."),uni.$api=B,this.globalData.apiReady=!0,a("log","at App.vue:108","API初始化成功，当前API对象:",Object.keys(uni.$api)),uni.$api.community||(a("warn","at App.vue:112","社区API不存在，创建空对象"),uni.$api.community={getPosts:()=>Promise.resolve([]),getMyPosts:()=>Promise.resolve([]),createPost:()=>Promise.resolve({success:!0}),getPostById:()=>Promise.resolve(null)}),uni.$api.pet||(a("warn","at App.vue:122","宠物API不存在，创建空对象"),uni.$api.pet={getPets:()=>Promise.resolve([]),getPetById:()=>Promise.resolve(null),createPet:()=>Promise.resolve({success:!0})}))}catch(e){a("error","at App.vue:133","API初始化失败:",e),this.globalData.apiReady=!1,uni.$api={community:{getPosts:()=>Promise.resolve([]),getMyPosts:()=>Promise.resolve([]),createPost:()=>Promise.resolve({success:!0}),getPostById:()=>Promise.resolve(null)},pet:{getPets:()=>Promise.resolve([]),getPetById:()=>Promise.resolve(null),createPet:()=>Promise.resolve({success:!0})},auth:{login:()=>Promise.resolve({token:"mock-token"}),register:()=>Promise.resolve({success:!0}),resetPassword:()=>Promise.resolve({success:!0})}},setTimeout((()=>{this.initApi()}),5e3)}},handleIconUpdated(e){a("log","at App.vue:164",`应用图标更新完成，更新了 ${e} 个图标`),uni.showToast({title:`更新了 ${e} 个图标`,icon:"success"})}},globalData:{apiReady:!1}},[["render",function(t,a,s,o,r,n){const i=e.resolveComponent("router-view"),l=e.resolveComponent("IconLoader");return e.openBlock(),e.createElementBlock("div",{class:"app-container"},[e.createVNode(i),e.createVNode(l,{onUpdateApplied:n.handleIconUpdated},null,8,["onUpdateApplied"])])}]]);uni.$api=B;const{app:ht,Vuex:ft,Pinia:yt}=function(){const t=e.createVueApp(vt),s=function(){const t=e.effectScope(!0),a=t.run((()=>e.ref({})));let s=[],o=[];const r=e.markRaw({install(e){j(r),r._a=e,e.provide(F,r),e.config.globalProperties.$pinia=r,o.forEach((e=>s.push(e))),o=[]},use(e){return this._a?s.push(e):o.push(e),this},_p:s,_a:null,_e:t,_s:new Map,state:a});return r}();return t.use(s),uni.$api=B,t.config.errorHandler=(e,t,s)=>{if(a("error","at main.js:24","Vue Error:",e),e.message&&e.message.includes("Failed to fetch dynamically imported module")){a("warn","at main.js:28","动态导入模块失败，模块路径可能有误:",e.message);const t=e.message.match(/http:\/\/localhost:5173\/(.*?)(\?|$)/);t&&t[1]&&(a("warn","at main.js:31","无法加载页面:",t[1]),uni.showToast({title:"页面加载失败",icon:"none",duration:2e3}),setTimeout((()=>{uni.navigateBack({fail:()=>{uni.switchTab({url:"/pages/index/index"})}})}),1500))}else(404===e.status||e.message&&e.message.includes("404"))&&(a("warn","at main.js:55","API请求404错误:",e.message),uni.showToast({title:"网络请求失败，请稍后再试",icon:"none"}))},{app:t}}();uni.Vuex=ft,uni.Pinia=yt,ht.provide("__globalStyles",__uniConfig.styles),ht._component.mpType="app",ht._component.render=()=>{},ht.mount("#app")}(Vue);
