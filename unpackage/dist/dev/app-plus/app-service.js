var __defProp=Object.defineProperty,__defProps=Object.defineProperties,__getOwnPropDescs=Object.getOwnPropertyDescriptors,__getOwnPropSymbols=Object.getOwnPropertySymbols,__hasOwnProp=Object.prototype.hasOwnProperty,__propIsEnum=Object.prototype.propertyIsEnumerable,__defNormalProp=(e,t,a)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,__spreadValues=(e,t)=>{for(var a in t||(t={}))__hasOwnProp.call(t,a)&&__defNormalProp(e,a,t[a]);if(__getOwnPropSymbols)for(var a of __getOwnPropSymbols(t))__propIsEnum.call(t,a)&&__defNormalProp(e,a,t[a]);return e},__spreadProps=(e,t)=>__defProps(e,__getOwnPropDescs(t)),__async=(e,t,a)=>new Promise(((o,s)=>{var r=e=>{try{i(a.next(e))}catch(t){s(t)}},n=e=>{try{i(a.throw(e))}catch(t){s(t)}},i=e=>e.done?o(e.value):Promise.resolve(e.value).then(r,n);i((a=a.apply(e,t)).next())}));if("undefined"==typeof Promise||Promise.prototype.finally||(Promise.prototype.finally=function(e){const t=this.constructor;return this.then((a=>t.resolve(e()).then((()=>a))),(a=>t.resolve(e()).then((()=>{throw a}))))}),"undefined"!=typeof uni&&uni&&uni.requireGlobal){const e=uni.requireGlobal();ArrayBuffer=e.ArrayBuffer,Int8Array=e.Int8Array,Uint8Array=e.Uint8Array,Uint8ClampedArray=e.Uint8ClampedArray,Int16Array=e.Int16Array,Uint16Array=e.Uint16Array,Int32Array=e.Int32Array,Uint32Array=e.Uint32Array,Float32Array=e.Float32Array,Float64Array=e.Float64Array,BigInt64Array=e.BigInt64Array,BigUint64Array=e.BigUint64Array}uni.restoreGlobal&&uni.restoreGlobal(Vue,weex,plus,setTimeout,clearTimeout,setInterval,clearInterval),function(e){"use strict";function t(e){return weex.requireModule(e)}function a(e,t,...a){uni.__log__?uni.__log__(e,t,...a):console[e].apply(console,[...a,t])}const o=t=>(a,o=e.getCurrentInstance())=>{!e.isInSSRComponentSetup&&e.injectHook(t,a,o)},s=o("onShow"),r=o("onHide"),n=o("onLoad"),i=o("onUnload"),l=o("onPullDownRefresh"),c=e=>{"string"==typeof e?uni.showToast({title:e,icon:"none",duration:2e3}):uni.showToast(__spreadValues({title:e.title||"",icon:e.icon||"none",duration:e.duration||2e3},e))},u=(e="åŠ è½½ä¸­...")=>{uni.showLoading({title:e,mask:!0})},d=()=>{uni.hideLoading()},m=e=>new Promise((t=>{uni.showModal({title:e.title||"æç¤º",content:e.content||"",showCancel:!1!==e.showCancel,cancelText:e.cancelText||"å–æ¶ˆ",confirmText:e.confirmText||"ç¡®å®š",confirmColor:e.confirmColor||"#3B9E82",cancelColor:e.cancelColor||"#999999",success:e=>{e.confirm?t(!0):t(!1)},fail:()=>{t(!1)}})})),p=(e,t={})=>{if(e&&!e.startsWith("/")&&(e="/"+e),Object.keys(t).length>0){const a=Object.entries(t).map((([e,t])=>`${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join("&");e=e.includes("?")?`${e}&${a}`:`${e}?${a}`}return new Promise(((t,o)=>{uni.navigateTo({url:e,success:t,fail:s=>{a("error","at utils/ui.js:99","å¯¼èˆªå¤±è´¥:",s),s.errMsg&&s.errMsg.includes("tabbar")?uni.switchTab({url:e,success:t,fail:o}):o(s)}})}))},g=(e=1)=>new Promise(((t,o)=>{uni.navigateBack({delta:e,success:t,fail:e=>{a("error","at utils/ui.js:127","è¿”å›å¤±è´¥:",e),o(e)}})})),v="dog_walk_records",h=()=>{try{const e=uni.getStorageSync(v);return e?JSON.parse(e):[]}catch(e){return a("error","at utils/walkStorage.js:23","è·å–æœ¬åœ°é›ç‹—è®°å½•å¤±è´¥:",e),[]}},f=h,y=e=>{try{const t=h().find((t=>t.id===e));return t?{code:0,message:"è·å–æˆåŠŸ",data:t}:{code:404,message:"æœªæ‰¾åˆ°è®°å½•",data:null}}catch(t){return a("error","at utils/walkStorage.js:137","è·å–é›ç‹—è®°å½•å¤±è´¥:",t),{code:500,message:"è·å–å¤±è´¥",data:null}}},w=e=>{try{const t=h(),o=`walk_${(new Date).getTime()}_${Math.floor(1e4*Math.random())}`,s=__spreadProps(__spreadValues({id:o},e),{createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()});return t.unshift(s),uni.setStorageSync(v,JSON.stringify(t)),uni.setStorageSync("last_walk_id",o),a("log","at utils/walkStorage.js:54","é›ç‹—è®°å½•å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨:",s),{code:0,message:"ä¿å­˜æˆåŠŸ",data:{walkId:o}}}catch(t){return a("error","at utils/walkStorage.js:63","ä¿å­˜é›ç‹—è®°å½•åˆ°æœ¬åœ°å¤±è´¥:",t),{code:500,message:"ä¿å­˜å¤±è´¥",data:null}}},k=(e,t)=>{try{const o=h(),s=o.findIndex((t=>t.id===e));return-1===s?(a("error","at utils/walkStorage.js:82","æœªæ‰¾åˆ°è¦æ›´æ–°çš„é›ç‹—è®°å½•:",e),{code:404,message:"æœªæ‰¾åˆ°è®°å½•",data:null}):(o[s]=__spreadProps(__spreadValues(__spreadValues({},o[s]),t),{updatedAt:(new Date).toISOString()}),uni.setStorageSync(v,JSON.stringify(o)),a("log","at utils/walkStorage.js:100","é›ç‹—è®°å½•å·²æ›´æ–°:",o[s]),{code:0,message:"æ›´æ–°æˆåŠŸ",data:o[s]})}catch(o){return a("error","at utils/walkStorage.js:108","æ›´æ–°é›ç‹—è®°å½•å¤±è´¥:",o),{code:500,message:"æ›´æ–°å¤±è´¥",data:null}}},E=e=>{try{const t=h(),o=t.filter((t=>t.id!==e));return t.length===o.length?{code:404,message:"æœªæ‰¾åˆ°è¦åˆ é™¤çš„è®°å½•",data:null}:(uni.setStorageSync(v,JSON.stringify(o)),a("log","at utils/walkStorage.js:167","é›ç‹—è®°å½•å·²åˆ é™¤:",e),{code:0,message:"åˆ é™¤æˆåŠŸ",data:null})}catch(t){return a("error","at utils/walkStorage.js:175","åˆ é™¤é›ç‹—è®°å½•å¤±è´¥:",t),{code:500,message:"åˆ é™¤å¤±è´¥",data:null}}},N={BASE_API_URL:"http://49.235.65.37:5000",TIMEOUT:3e4,DEBUG:!0,USE_MOCK_API:!1,API_PREFIX:{AUTH:"/api/users",USERS:"/api/users",PETS:"/api/pets",POSTS:"/api/community",WALKS:"/api/users/me/walks",LOCATIONS:"/api/locations"},VERSION:"1.0.0",APP_NAME:"DogRun"},V=N.BASE_API_URL,S=e=>{if(e.url.includes("/api/walks"))return a("log","at utils/request.js:67","æ£€æµ‹åˆ°é›ç‹—APIè¯·æ±‚:",e.url),_(e);e.url.includes("/api/community/posts")&&(a("log","at utils/request.js:73","æ£€æµ‹åˆ°ç¤¾åŒºAPIè¯·æ±‚:",e.url),a("log","at utils/request.js:75","ä½¿ç”¨çœŸå®åç«¯å¤„ç†ç¤¾åŒºAPIè¯·æ±‚")),e.header||(e.header={});const t=e.timeout||1e4,o=(e.baseURL||V)+e.url;if("GET"===e.method&&e.params){const t=Object.keys(e.params).map((t=>`${encodeURIComponent(t)}=${encodeURIComponent(e.params[t])}`)).join("&");e.url=t?`${o}?${t}`:o}else e.url=o;return new Promise(((o,s)=>{const r=uni.getStorageSync("token");if(!!!r&&!1!==e.needAuth)return a("log","at utils/request.js:107","è¯·æ±‚éœ€è¦è®¤è¯ä½†æ²¡æœ‰token"),s({message:"ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•",statusCode:401});r&&(e.header.Authorization=`Bearer ${r}`),uni.request({url:e.url,data:"GET"===e.method?void 0:e.data,method:e.method||"GET",header:e.header,timeout:t,success:t=>{const{statusCode:a,data:r}=t;a>=200&&a<300?o(r):401===a?(uni.showToast({title:"ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•",icon:"none",duration:2e3}),s({message:"ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•",statusCode:401,data:r})):s(404===a?{message:"è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨",statusCode:404,data:r,url:e.url}:500===a?{message:"æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•",statusCode:500,data:r}:{message:(null==r?void 0:r.message)||`è¯·æ±‚å¤±è´¥(${a})`,statusCode:a,data:r})},fail:t=>{a("error","at utils/request.js:170","è¯·æ±‚å¤±è´¥:",t);const o=t.errMsg.includes("timeout")?"è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ":"ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥";s({message:o,statusCode:0,error:t,url:e.url})}})}))},_=e=>new Promise((t=>{setTimeout((()=>{var o,s;const r=e.url.split("/");let n=null;if(n=r.find((e=>e.startsWith("walk_"))),!n&&r.length>0&&(n=r[r.length-1],"walks"!==n&&"walk"!==n&&""!==n||(n=null)),a("log","at utils/request.js:214","é›ç‹—APIå¤„ç† - æå–çš„ID:",n,"è¯·æ±‚URL:",e.url),"GET"===e.method)if(n){const e=y(n);a("log","at utils/request.js:221","è·å–é›ç‹—è®°å½•è¯¦æƒ…:",e),t((null==e?void 0:e.data)||null)}else{const r=f(),n=(null==(o=e.params)?void 0:o.page)||1,i=(null==(s=e.params)?void 0:s.limit)||10,l=(n-1)*i,c=r.slice(l,l+i);a("log","at utils/request.js:231","è·å–é›ç‹—è®°å½•åˆ—è¡¨, é¡µç :",n,"æ¯é¡µæ•°é‡:",i,"è®°å½•æ•°:",c.length),t({code:0,message:"è·å–æˆåŠŸ",data:{list:c,total:r.length,page:n,limit:i}})}else if("POST"===e.method&&e.url.includes("/walks/start")){const o=w(e.data);a("log","at utils/request.js:247","åˆ›å»ºé›ç‹—è®°å½•:",o),t(o)}else if("POST"===e.method&&e.url.includes("/end")){const o=k(n,e.data);a("log","at utils/request.js:253","æ›´æ–°é›ç‹—è®°å½•:",o),t(o)}else if("DELETE"===e.method){if(!n)return a("error","at utils/request.js:259","åˆ é™¤é›ç‹—è®°å½•å¤±è´¥: æ— æ³•ä»URLä¸­æå–è®°å½•ID",e.url),void t({code:400,message:"æ— æ•ˆçš„è®°å½•ID",data:null});a("log","at utils/request.js:268","å°è¯•åˆ é™¤é›ç‹—è®°å½•, ID:",n);const o=E(n);a("log","at utils/request.js:270","åˆ é™¤é›ç‹—è®°å½•ç»“æœ:",o),404===o.code?(a("log","at utils/request.js:274","æœ¬åœ°å­˜å‚¨ä¸­æœªæ‰¾åˆ°è®°å½•,å¯èƒ½å·²ç»è¢«åˆ é™¤,è¿”å›æˆåŠŸçŠ¶æ€"),t({code:0,message:"è®°å½•å·²åˆ é™¤",data:null})):t(o)}else a("warn","at utils/request.js:286","æœªå¤„ç†çš„é›ç‹—APIè¯·æ±‚ç±»å‹:",e.method,e.url),t({})}),300)})),C=N.BASE_API_URL,b=(new Date(Date.now()-1728e5).toISOString(),new Date(Date.now()-1728e5+27e5).toISOString(),new Date(Date.now()-864e5).toISOString(),new Date(Date.now()-864e5+18e5).toISOString(),e=>(a("log","at utils/api.js:101","åŸå§‹APIå“åº”:",e),e?e.data&&!e.data.data?(a("log","at utils/api.js:112","è¿”å›dataå­—æ®µ:",e.data),e.data):e.data&&e.data.data?(a("log","at utils/api.js:118","è¿”å›åµŒå¥—data.dataå­—æ®µ:",e.data.data),e.data.data):void 0!==e.code&&e.data?(a("log","at utils/api.js:124","è¿”å›æ ‡å‡†APIæ ¼å¼:",e.data),e.data):(a("log","at utils/api.js:129","è¿”å›åŸå§‹å“åº”"),e):null)),P=e=>__async(this,null,(function*(){try{const t=yield e();return null==t?(a("warn","at utils/api.js:143","APIè°ƒç”¨è¿”å›ç©ºç»“æœ"),[]):t}catch(t){if(a("error","at utils/api.js:148","APIè°ƒç”¨å¤±è´¥:",t),404===t.statusCode){if(a("error","at utils/api.js:151","APIç«¯ç‚¹ä¸å­˜åœ¨:",t.url),a("error","at utils/api.js:152","è¿™å¯èƒ½æ˜¯å› ä¸ºåç«¯å°šæœªå®ç°æ­¤åŠŸèƒ½ï¼Œè¯·è”ç³»å¼€å‘è€…"),t.url&&(t.url.includes("/api/walks")?a("error","at utils/api.js:157","é›ç‹—APIç«¯ç‚¹ä¸å­˜åœ¨: /api/walksï¼Œå°è¯•ä½¿ç”¨æ­¤è·¯å¾„å¤±è´¥"):t.url.includes("/api/users/me/walks")&&a("error","at utils/api.js:160","é›ç‹—APIç«¯ç‚¹ä¸å­˜åœ¨: /api/users/me/walksï¼Œå°è¯•ä½¿ç”¨æ­¤è·¯å¾„å¤±è´¥")),t.url&&(t.url.includes("/walks")||t.url.includes("/posts")))return a("warn","at utils/api.js:166","è¿”å›ç©ºæ•°ç»„ä»¥é¿å…UIå´©æºƒ"),[]}else if(401===t.statusCode)try{let e="";if("function"==typeof getCurrentPages){const t=getCurrentPages();if(t&&t.length>0){const a=t[t.length-1];e=(null==a?void 0:a.route)||""}}e.includes("/login/")||uni.navigateTo({url:"/pages/login/login"})}catch(o){a("error","at utils/api.js:190","é¡µé¢è·³è½¬é”™è¯¯:",o)}throw t}})),x=(e,t)=>__async(this,null,(function*(){try{a("log","at utils/api.js:207","ä»…ä½¿ç”¨çœŸå®APIï¼Œç¦ç”¨æ¨¡æ‹Ÿæ•°æ®");return yield e()}catch(t){throw a("error","at utils/api.js:211","APIè°ƒç”¨å¤±è´¥ï¼Œä¸ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:",t),t}})),I={login:e=>S({url:"/api/users/login",method:"POST",data:e,needAuth:!1}),register:e=>S({url:"/api/users/register",method:"POST",data:e,needAuth:!1})},T={getCurrentUser:()=>S({url:"/api/users/me",method:"GET"}),getUserById:e=>__async(this,null,(function*(){try{if(a("log","at utils/api.js:257","è·å–ç”¨æˆ·ä¿¡æ¯, ID:",e),!e)throw a("error","at utils/api.js:261","è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: æ— æ•ˆçš„ç”¨æˆ·ID"),new Error("æ— æ•ˆçš„ç”¨æˆ·ID");const o=yield S({url:`/api/users/${e}`,method:"GET"}),s=b(o);try{const t=uni.getStorageSync("userId");if(t&&t!==e){const t=yield S({url:"/api/users/me",method:"GET"}),o=b(t);if(o&&o.following){const t=(Array.isArray(o.following)?o.following:[]).some((t=>t===e||"object"==typeof t&&t._id===e));a("log","at utils/api.js:294","æ£€æŸ¥å…³æ³¨çŠ¶æ€:",{userId:e,isFollowing:t}),s&&(s.isFollowing=t)}}}catch(t){a("error","at utils/api.js:303","æ£€æŸ¥å…³æ³¨çŠ¶æ€å¤±è´¥:",t)}return s}catch(t){if(a("error","at utils/api.js:309","è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",t),500===t.statusCode||404===t.statusCode)return a("warn","at utils/api.js:313","æœåŠ¡å™¨é”™è¯¯æˆ–ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¿”å›é»˜è®¤ç”¨æˆ·æ•°æ®"),{_id:e,username:"ç”¨æˆ·"+e.substring(0,4),nickname:"ç”¨æˆ·"+e.substring(0,4),avatar:"/static/images/default-avatar.png",bio:"è¯¥ç”¨æˆ·æš‚æ— ä»‹ç»",isFollowing:!1};throw t}})),checkFollowStatus:e=>__async(this,null,(function*(){a("log","at utils/api.js:333","ä¸“é—¨æ£€æŸ¥å…³æ³¨çŠ¶æ€, ç›®æ ‡ç”¨æˆ·ID:",e);try{let r=uni.getStorageSync("userId");if(!r)try{const e=uni.getStorageSync("userInfo");if(e){const t=JSON.parse(e);r=t._id||t.id,a("log","at utils/api.js:346","ä»userInfoä¸­è·å–å½“å‰ç”¨æˆ·ID:",r)}}catch(t){a("warn","at utils/api.js:349","è§£æuserInfoå¤±è´¥:",t)}if(!r||r===e)return a("log","at utils/api.js:355","å½“å‰ç”¨æˆ·æœªç™»å½•æˆ–å°è¯•æ£€æŸ¥è‡ªå·±ï¼Œè¿”å›æœªå…³æ³¨çŠ¶æ€"),{isFollowing:!1};a("log","at utils/api.js:359","å¼€å§‹ç›´æ¥æ£€æŸ¥å…³æ³¨çŠ¶æ€, å½“å‰ç”¨æˆ·:",r,"ç›®æ ‡ç”¨æˆ·:",e);try{const t=yield S({url:`/api/users/${e}`,method:"GET"}),o=b(t);if(o&&void 0!==o.isFollowing)return a("log","at utils/api.js:372","ä»ç”¨æˆ·è¯¦æƒ…ä¸­è·å–åˆ°å…³æ³¨çŠ¶æ€:",o.isFollowing),{isFollowing:o.isFollowing}}catch(o){a("warn","at utils/api.js:376","å°è¯•ä»ç”¨æˆ·è¯¦æƒ…è·å–å…³æ³¨çŠ¶æ€å¤±è´¥:",o)}try{const t=yield S({url:`/api/users/${r}/following`,method:"GET"}),o=b(t);if(a("log","at utils/api.js:388","æˆåŠŸè·å–å…³æ³¨åˆ—è¡¨:",(null==o?void 0:o.length)||0,"ä¸ªç”¨æˆ·"),Array.isArray(o)){const t=o.some((t=>t._id===e||"string"==typeof t&&t===e));return a("log","at utils/api.js:397","ä»å…³æ³¨åˆ—è¡¨ç›´æ¥æ£€æŸ¥å…³æ³¨çŠ¶æ€:",{userId:e,isFollowing:t}),{isFollowing:t}}}catch(o){a("warn","at utils/api.js:401","å°è¯•ä»å…³æ³¨åˆ—è¡¨æ£€æŸ¥å…³æ³¨çŠ¶æ€å¤±è´¥:",o)}const n=yield S({url:"/api/users/me",method:"GET"}),i=b(n);if(a("log","at utils/api.js:412","è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯æˆåŠŸ, ID:",null==i?void 0:i._id),i&&i._id&&uni.setStorageSync("userId",i._id),i&&"number"==typeof i.following){a("log","at utils/api.js:421","å½“å‰ç”¨æˆ·followingå­—æ®µæ˜¯æ•°å­—(å…³æ³¨æ•°é‡):",i.following);try{const t=yield S({url:`/api/users/${i._id}/following`,method:"GET"}),o=b(t);if(a("log","at utils/api.js:432","é€šè¿‡APIè·å–å…³æ³¨åˆ—è¡¨:",(null==o?void 0:o.length)||0,"ä¸ªç”¨æˆ·"),Array.isArray(o)){const t=o.some((t=>t._id===e||"string"==typeof t&&t===e));return a("log","at utils/api.js:440","æœ€ç»ˆæ£€æŸ¥å…³æ³¨çŠ¶æ€ç»“æœ:",{userId:e,isFollowing:t}),{isFollowing:t}}}catch(s){a("error","at utils/api.js:444","è·å–å®Œæ•´å…³æ³¨åˆ—è¡¨å¤±è´¥:",s)}}if(i&&Array.isArray(i.following)){const t=i.following;a("log","at utils/api.js:453","å½“å‰ç”¨æˆ·çš„å…³æ³¨åˆ—è¡¨é•¿åº¦:",t.length);let o=!1;for(const s of t){if(s===e){o=!0,a("log","at utils/api.js:461","æ‰¾åˆ°å…³æ³¨å…³ç³»(IDå­—ç¬¦ä¸²):",e);break}if(s&&"object"==typeof s&&s._id===e){o=!0,a("log","at utils/api.js:468","æ‰¾åˆ°å…³æ³¨å…³ç³»(å¸¦_idçš„å¯¹è±¡):",s);break}if(s&&"object"==typeof s&&s.userId===e){o=!0,a("log","at utils/api.js:475","æ‰¾åˆ°å…³æ³¨å…³ç³»(å¸¦userIdçš„å¯¹è±¡):",s);break}if(s&&"object"==typeof s&&s.user&&(s.user===e||"object"==typeof s.user&&s.user._id===e)){o=!0,a("log","at utils/api.js:484","æ‰¾åˆ°å…³æ³¨å…³ç³»(å¸¦userçš„å¯¹è±¡):",s);break}}return a("log","at utils/api.js:490","å…³æ³¨çŠ¶æ€æ£€æŸ¥ç»“æœ:",{userId:e,isFollowing:o}),{isFollowing:o}}return a("log","at utils/api.js:494","æœªæ‰¾åˆ°å…³æ³¨åˆ—è¡¨æˆ–ä¸ºç©ºï¼Œè¿”å›æœªå…³æ³¨çŠ¶æ€"),{isFollowing:!1}}catch(o){return a("error","at utils/api.js:497","æ£€æŸ¥å…³æ³¨çŠ¶æ€å¤±è´¥:",o),{isFollowing:!1}}})),updateProfile:e=>{a("log","at utils/api.js:505","å‡†å¤‡å‘é€ç”¨æˆ·æ›´æ–°æ•°æ®:",e);const t=__spreadValues({},e);return void 0===t.phone&&void 0!==e.phone&&(t.phone=e.phone),void 0===t.gender&&void 0!==e.gender&&(t.gender=e.gender),a("log","at utils/api.js:519","æœ€ç»ˆå‘é€çš„ç”¨æˆ·æ•°æ®:",t),S({url:"/api/users/me",method:"PUT",data:t}).then((e=>(e&&(e.phone||void 0===t.phone||(e.phone=t.phone),e.gender||void 0===t.gender||(e.gender=t.gender)),e)))},uploadAvatar:e=>new Promise(((t,o)=>{a("log","at utils/api.js:543","å¼€å§‹ä¸Šä¼ ç”¨æˆ·å¤´åƒï¼Œæ–‡ä»¶è·¯å¾„:",e);const s=uni.getStorageSync("token");return s?e?(a("log","at utils/api.js:556","å¼€å§‹ä¸Šä¼ æ–‡ä»¶, è·¯å¾„:",e),void uni.getFileInfo({filePath:e,success:function(r){a("log","at utils/api.js:562","æ–‡ä»¶ä¿¡æ¯:",r),uni.uploadFile({url:C+"/api/users/avatar",filePath:e,name:"avatar",formData:{},header:{Authorization:`Bearer ${s}`},success:s=>{if(a("log","at utils/api.js:575","å¤´åƒä¸Šä¼ å“åº”:",s),s.statusCode>=200&&s.statusCode<300)try{const e=JSON.parse(s.data);a("log","at utils/api.js:581","è§£æåçš„å“åº”:",e);const o=e.data&&e.data.avatar||e.avatar||"/static/images/default-avatar.png";t({success:!0,avatar:o,data:{avatar:o}})}catch(r){a("error","at utils/api.js:595","è§£æå“åº”å¤±è´¥:",r),t({success:!0,avatar:e,data:{avatar:e}})}else a("error","at utils/api.js:605","å¤´åƒä¸Šä¼ è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç :",s.statusCode),a("error","at utils/api.js:606","å¤±è´¥å“åº”:",s.data),o(new Error("ä¸Šä¼ å¤±è´¥: "+s.statusCode))},fail:e=>{a("error","at utils/api.js:611","å¤´åƒä¸Šä¼ è¯·æ±‚å‘é€å¤±è´¥:",e),o(new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥: "+(e.errMsg||"æœªçŸ¥é”™è¯¯")))}})},fail:function(e){a("error","at utils/api.js:617","è·å–æ–‡ä»¶ä¿¡æ¯å¤±è´¥:",e),o(new Error("æ–‡ä»¶è¯»å–å¤±è´¥: "+(e.errMsg||"æœªçŸ¥é”™è¯¯")))}})):o(new Error("æ— æ•ˆçš„æ–‡ä»¶è·¯å¾„")):o(new Error("è¯·å…ˆç™»å½•"))})),getUserStats:e=>__async(this,null,(function*(){try{let t="/api/users/stats/me";e&&(t=`/api/users/${e}/stats`);const a=yield S({url:t,method:"GET"});return b(a)}catch(t){throw a("error","at utils/api.js:638","è·å–ç”¨æˆ·ç»Ÿè®¡æ•°æ®å¤±è´¥:",t),t}})),followUser:e=>__async(this,null,(function*(){try{const t=yield S({url:`/api/users/follow/${e}`,method:"POST"});return b(t)}catch(t){throw a("error","at utils/api.js:652","å…³æ³¨ç”¨æˆ·å¤±è´¥:",t),t}})),getFollowing:e=>__async(this,null,(function*(){try{const t=e||"me";a("log","at utils/api.js:662","è¯·æ±‚å…³æ³¨åˆ—è¡¨:",`/api/users/${t}/following`);const o=yield S({url:`/api/users/${t}/following`,method:"GET"});return b(o)}catch(t){if(a("error","at utils/api.js:670","è·å–å…³æ³¨åˆ—è¡¨å¤±è´¥:",t),500===t.statusCode||404===t.statusCode||0===t.statusCode||!t.statusCode)return a("warn","at utils/api.js:674","æœåŠ¡å™¨é”™è¯¯ã€ç½‘ç»œé”™è¯¯æˆ–æ¥å£ä¸å­˜åœ¨ï¼Œè¿”å›æ¨¡æ‹Ÿå…³æ³¨åˆ—è¡¨æ•°æ®"),[{_id:"mock-following-1",username:"å® ç‰©è¾¾äºº",nickname:"è¾¾äºº",avatar:"/static/images/default-avatar.png",bio:"åˆ†äº«å…»å® å¿ƒå¾—å’Œå°æŠ€å·§",isFollowing:!0},{_id:"mock-following-2",username:"èŒå® ä¸“å®¶",nickname:"ä¸“å®¶",avatar:"/static/images/default-avatar.png",bio:"å–œæ¬¢ä¸€åˆ‡æ¯›èŒ¸èŒ¸çš„å°åŠ¨ç‰©",isFollowing:!0}];throw t}})),getFollowers:e=>__async(this,null,(function*(){try{const t=e||"me";a("log","at utils/api.js:706","è¯·æ±‚ç²‰ä¸åˆ—è¡¨:",`/api/users/${t}/followers`);const o=yield S({url:`/api/users/${t}/followers`,method:"GET"});return b(o)}catch(t){if(a("error","at utils/api.js:714","è·å–ç²‰ä¸åˆ—è¡¨å¤±è´¥:",t),500===t.statusCode||404===t.statusCode||0===t.statusCode||!t.statusCode)return a("warn","at utils/api.js:718","æœåŠ¡å™¨é”™è¯¯ã€ç½‘ç»œé”™è¯¯æˆ–æ¥å£ä¸å­˜åœ¨ï¼Œè¿”å›æ¨¡æ‹Ÿç²‰ä¸åˆ—è¡¨æ•°æ®"),[{_id:"mock-follower-1",username:"é“²å±å®˜å°æ˜",nickname:"å°æ˜",avatar:"/static/images/default-avatar.png",bio:"æœ‰ä¸€åªå¯çˆ±çš„å°çŒ«",isFollowing:!1},{_id:"mock-follower-2",username:"ç‹—ç‹—çˆ±å¥½è€…",nickname:"çˆ±å¥½è€…",avatar:"/static/images/default-avatar.png",bio:"å…»äº†ä¸‰åªä¸åŒå“ç§çš„ç‹—ç‹—",isFollowing:!0}];throw t}})),getPetsByUser:e=>__async(this,null,(function*(){try{if(a("log","at utils/api.js:748","è·å–ç”¨æˆ·å® ç‰©åˆ—è¡¨, ID:",e),!e)throw a("error","at utils/api.js:752","è·å–ç”¨æˆ·å® ç‰©åˆ—è¡¨å¤±è´¥: æ— æ•ˆçš„ç”¨æˆ·ID"),new Error("æ— æ•ˆçš„ç”¨æˆ·ID");const t=e||"me",o=yield S({url:`/api/users/${t}/pets`,method:"GET"});return b(o)}catch(t){return a("error","at utils/api.js:763","è·å–ç”¨æˆ·å® ç‰©åˆ—è¡¨å¤±è´¥:",t),500!==t.statusCode&&404!==t.statusCode&&0!==t.statusCode&&t.statusCode||a("warn","at utils/api.js:767","æœåŠ¡å™¨é”™è¯¯ã€ç½‘ç»œé”™è¯¯æˆ–å® ç‰©åˆ—è¡¨ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºåˆ—è¡¨"),[]}})),changePassword:e=>S({url:"/api/users/password",method:"PUT",data:e}),logout:()=>Promise.resolve({success:!0,message:"å·²é€€å‡ºç™»å½•"}),updateFullProfile:e=>{a("log","at utils/api.js:797","å‡†å¤‡å‘é€å®Œæ•´ç”¨æˆ·èµ„æ–™æ•°æ®:",e);const t=__spreadProps(__spreadValues({},e),{phone:void 0!==e.phone?e.phone:"",gender:void 0!==e.gender?e.gender:"unknown"});a("log","at utils/api.js:807","æœ€ç»ˆå‘é€çš„å®Œæ•´ç”¨æˆ·æ•°æ®:",t);return S({url:"/api/users/updateProfile",method:"POST",data:t}).catch((e=>(a("warn","at utils/api.js:821","ç‰¹æ®ŠAPIç«¯ç‚¹è°ƒç”¨å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨æ ‡å‡†ç«¯ç‚¹:",e),S({url:"/api/users/me",method:"PUT",data:t}).then((e=>(e&&(e.phone||void 0===t.phone||(e.phone=t.phone),e.gender||void 0===t.gender||(e.gender=t.gender)),e))))))}},M={getMyPets:()=>x((()=>S({url:"/api/pets",method:"GET"}))),getPetById:e=>x((()=>S({url:`/api/pets/${e}`,method:"GET"}))).then((e=>e)),addPet:e=>x((()=>S({url:"/api/pets",method:"POST",data:e}))).then((e=>e)),updatePet:(e,t)=>x((()=>S({url:`/api/pets/${e}`,method:"PUT",data:t}))).then((e=>e)),deletePet:e=>x((()=>S({url:`/api/pets/${e}`,method:"DELETE"}))).then((e=>e||{success:!0})),uploadPetAvatar:(e,t)=>new Promise(((o,s)=>{a("log","at utils/api.js:941","å¼€å§‹ä¸Šä¼ å® ç‰©å¤´åƒï¼ŒID:",e,"æ–‡ä»¶è·¯å¾„:",t);const r=uni.getStorageSync("token");return r?e?t?(a("log","at utils/api.js:1013","å‡†å¤‡ä½¿ç”¨uni.uploadFileä¸Šä¼ :",t),t.includes("skip_validation=true")?(a("log","at utils/api.js:1019","æ£€æµ‹åˆ°è·³è¿‡éªŒè¯æ ‡å¿—ï¼Œç›´æ¥ä¸Šä¼ æ–‡ä»¶ (uni.uploadFile)"),void uni.uploadFile({url:`${C}/api/pets/${e}/avatar`,filePath:t,name:"avatar",formData:{},header:{Authorization:`Bearer ${r}`},success:a=>{var r,n;if(a.statusCode>=200&&a.statusCode<300)try{const s=JSON.parse(a.data);o({success:!0,data:{pet:(null==(r=s.data)?void 0:r.pet)||s.pet||{_id:e,avatar:(null==(n=s.data)?void 0:n.avatar)||s.avatar||t}}})}catch(i){o({success:!0,data:{pet:{_id:e,avatar:t}}})}else s({success:!1,message:`ä¸Šä¼ å¤±è´¥: ${a.statusCode}`,error:a.data})},fail:e=>{s({success:!1,message:"ç½‘ç»œè¯·æ±‚å¤±è´¥",error:e})}})):void uni.getFileInfo({filePath:t,success:function(n){if(a("log","at utils/api.js:1067","å® ç‰©å¤´åƒæ–‡ä»¶ä¿¡æ¯ (uni.uploadFile):",n),n.size>1048576)return s({success:!1,message:"å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡1MB",statusCode:413});uni.uploadFile({url:`${C}/api/pets/${e}/avatar`,filePath:t,name:"avatar",formData:{},header:{Authorization:`Bearer ${r}`},success:r=>{var n,i;if(a("log","at utils/api.js:1080","å® ç‰©å¤´åƒä¸Šä¼ åŸå§‹å“åº” (uni.uploadFile):",r),r.statusCode>=200&&r.statusCode<300)try{const s=JSON.parse(r.data);a("log","at utils/api.js:1084","è§£æçš„å® ç‰©å¤´åƒä¸Šä¼ å“åº” (uni.uploadFile):",s),o({success:!0,data:{pet:(null==(n=s.data)?void 0:n.pet)||s.pet||{_id:e,avatar:(null==(i=s.data)?void 0:i.avatar)||s.avatar||t}}})}catch(l){a("error","at utils/api.js:1095","è§£æå® ç‰©å¤´åƒä¸Šä¼ å“åº”å¤±è´¥ (uni.uploadFile):",l),o({success:!0,data:{pet:{_id:e,avatar:t}}})}else a("error","at utils/api.js:1099","å® ç‰©å¤´åƒä¸Šä¼ è¯·æ±‚å¤±è´¥ (uni.uploadFile):",r.statusCode,r.data),400===r.statusCode&&"string"==typeof r.data&&r.data.includes("Unexpected end of form")?(a("log","at utils/api.js:1102","æ£€æµ‹åˆ°è¡¨å•è§£æé”™è¯¯ (uni.uploadFile)ï¼Œä½†H5çš„å¤‡ç”¨æ–¹æ¡ˆ (getFileSystemManager) ä¸å¯ç”¨ã€‚"),s({success:!1,message:`ä¸Šä¼ å¤±è´¥: ${r.statusCode}`,error:r.data})):s({success:!1,message:`ä¸Šä¼ å¤±è´¥: ${r.statusCode}`,error:r.data})},fail:e=>{a("error","at utils/api.js:1110","å® ç‰©å¤´åƒä¸Šä¼ ç½‘ç»œè¯·æ±‚å¤±è´¥ (uni.uploadFile):",e),s({success:!1,message:"ç½‘ç»œè¯·æ±‚å¤±è´¥",error:e})}})},fail:function(e){a("error","at utils/api.js:1116","è·å–æ–‡ä»¶ä¿¡æ¯å¤±è´¥ (uni.uploadFile):",e),s({success:!1,message:"æ–‡ä»¶è¯»å–å¤±è´¥",error:e})}})):s({success:!1,message:"æ–‡ä»¶è·¯å¾„æ— æ•ˆ",statusCode:400}):s({success:!1,message:"å® ç‰©IDæ— æ•ˆ",statusCode:400}):s({success:!1,message:"è¯·å…ˆç™»å½•",statusCode:401})})),getPetsByUser:e=>__async(this,null,(function*(){try{const t=yield S({url:`/api/users/${e}/pets`,method:"GET"});return b(t)}catch(t){throw a("error","at utils/api.js:1132","è·å–ç”¨æˆ·å® ç‰©å¤±è´¥:",t),t}})),analyzeImages:e=>new Promise(((t,o)=>{a("log","at utils/api.js:1140","è°ƒç”¨æœåŠ¡å™¨ç«¯å® ç‰©åˆ†æAPI, æ•°æ®:",e);const s=uni.getStorageSync("token"),r={Authorization:s?`Bearer ${s}`:"","Content-Type":"application/json"};uni.request({url:`${C}/api/pet/analyze`,method:"POST",data:{imagePaths:e.imagePaths,userId:e.userId||""},header:r,success:e=>{var s;if(a("log","at utils/api.js:1158","å® ç‰©åˆ†æAPIå“åº”:",e),200===e.statusCode)t(e.data);else{const t=404===e.statusCode?"APIç«¯ç‚¹ä¸å­˜åœ¨ï¼Œè¯·ç¡®è®¤åç«¯æœåŠ¡æ˜¯å¦å·²å®ç°æ­¤åŠŸèƒ½":(null==(s=e.data)?void 0:s.message)||`æœåŠ¡å™¨é”™è¯¯(${e.statusCode})`;a("error","at utils/api.js:1168","æœåŠ¡å™¨è¿”å›é”™è¯¯:",t),o(new Error(t))}},fail:e=>{a("error","at utils/api.js:1173","å® ç‰©åˆ†æè¯·æ±‚å¤±è´¥:",e),o(new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"))}})})),getAnalysisHistory:e=>new Promise(((t,o)=>{uni.request({url:`${C}/api/pet/analysis-history`,method:"GET",data:{userId:e},header:D(),success:e=>{200===e.statusCode?t(e.data):o(new Error(e.data.message||"è·å–å†å²è®°å½•å¤±è´¥"))},fail:e=>{a("error","at utils/api.js:1196","è·å–åˆ†æå†å²å¤±è´¥:",e),o(e)}})})),uploadPetDailyPhoto:(e,t)=>(a("log","at utils/api.js:1205","API - å¼€å§‹ä¸Šä¼ å® ç‰©æ—¥å¸¸ç…§ç‰‡ï¼ŒID:",e,"è·¯å¾„:",t),t.startsWith("blob:")?new Promise(((o,s)=>{try{a("log","at utils/api.js:1211","API - å¤„ç†blob URLï¼Œå‡†å¤‡è½¬æ¢ä¸ºbase64");const r=new Image;r.crossOrigin="anonymous",r.onload=()=>{try{const t=document.createElement("canvas");t.width=r.width,t.height=r.height;t.getContext("2d").drawImage(r,0,0);const n=t.toDataURL("image/jpeg",.9);a("log","at utils/api.js:1226","API - è½¬æ¢å®Œæˆï¼Œå‡†å¤‡ä»¥JSONæ ¼å¼å‘é€"),fetch(`${C}/api/pets/${e}/daily-photo`,{method:"POST",headers:{Authorization:`Bearer ${uni.getStorageSync("token")}`,"Content-Type":"application/json"},body:JSON.stringify({imageData:n,description:""})}).then((e=>{if(!e.ok)throw new Error(`ä¸Šä¼ å¤±è´¥: ${e.status}`);return e.json()})).then((e=>{a("log","at utils/api.js:1247","API - ä¸Šä¼ æˆåŠŸ:",e),o(e)})).catch((e=>{a("error","at utils/api.js:1251","API - ä¸Šä¼ å¤±è´¥:",e),s(e)}))}catch(t){a("error","at utils/api.js:1255","API - Canvaså¤„ç†å¤±è´¥:",t),s(t)}},r.onerror=e=>{a("error","at utils/api.js:1261","API - å›¾ç‰‡åŠ è½½å¤±è´¥:",e),s(new Error("å›¾ç‰‡åŠ è½½å¤±è´¥"))},r.src=t}catch(r){a("error","at utils/api.js:1267","API - å¤„ç†blob URLå¤±è´¥:",r),s(r)}})):new Promise(((o,s)=>{a("log","at utils/api.js:1275","API - å¤„ç†æœ¬åœ°æ–‡ä»¶ä¸Šä¼ "),uni.uploadFile({url:`${C}/api/pets/${e}/daily-photo`,filePath:t,name:"photo",header:{Authorization:`Bearer ${uni.getStorageSync("token")}`},success:e=>{let t;a("log","at utils/api.js:1284","API - ç…§ç‰‡ä¸Šä¼ æˆåŠŸ");try{t="string"==typeof e.data?JSON.parse(e.data):e.data,o(t)}catch(r){a("error","at utils/api.js:1294","API - è§£æä¸Šä¼ å“åº”å¤±è´¥:",r),s(r)}},fail:e=>{a("error","at utils/api.js:1299","API - ç…§ç‰‡ä¸Šä¼ å¤±è´¥:",e),s(e)}})})))};function D(){const e=uni.getStorageSync("token");return{Authorization:e?`Bearer ${e}`:"","Content-Type":"application/json"}}const A={auth:I,user:T,pet:M,community:{getPosts:e=>P((()=>S({url:"/api/community/posts",method:"GET",params:e}))),getFollowingPosts:(e=1,t=10)=>P((()=>S({url:"/api/community/posts/following",method:"GET",params:{page:e,limit:t,feed_type:"following"}}))),getMyPosts:e=>{a("log","at utils/api.js:1335","å¼€å§‹è·å–æˆ‘çš„å¸–å­åˆ—è¡¨ï¼Œå‚æ•°:",e);const t=uni.getStorageSync("token");return t?P((()=>S({url:"/api/community/posts/user/me",method:"GET",params:e,header:{Authorization:`Bearer ${t}`}}))).then((e=>(a("log","at utils/api.js:1358","è·å–æˆ‘çš„å¸–å­æˆåŠŸï¼Œç»“æœ:",e),e?Array.isArray(e)?{data:e}:e.data||"object"!=typeof e?e:{data:[]}:{data:[]}))).catch((e=>{if(a("error","at utils/api.js:1377","è·å–æˆ‘çš„å¸–å­åˆ—è¡¨å¤±è´¥ï¼Œé”™è¯¯è¯¦æƒ…:",e),500===e.statusCode)return a("warn","at utils/api.js:1381","æœåŠ¡å™¨é”™è¯¯(500)ï¼Œè¿”å›ç©ºç»“æœä»¥é¿å…UIå´©æºƒ"),{data:[]};throw e})):(a("error","at utils/api.js:1340","è·å–æˆ‘çš„å¸–å­å¤±è´¥: æœªç™»å½•çŠ¶æ€"),Promise.reject({message:"è¯·å…ˆç™»å½•",statusCode:401}))},getPostById:e=>P((()=>S({url:`/api/community/posts/${e}`,method:"GET"}))),createPost:e=>{a("log","at utils/api.js:1401","å¼€å§‹åˆ›å»ºå¸–å­ï¼Œæ•°æ®:",e);const t=uni.getStorageSync("token");return t?new Promise(((o,s)=>{S({url:"/api/community/posts",method:"POST",data:e,header:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}}).then((e=>{a("log","at utils/api.js:1423","åˆ›å»ºå¸–å­æˆåŠŸï¼Œå“åº”:",e),o(e)})).catch((e=>{a("error","at utils/api.js:1426","åˆ›å»ºå¸–å­å¤±è´¥ï¼Œé”™è¯¯:",e);let t="åˆ›å»ºå¸–å­å¤±è´¥";500===e.statusCode?t="æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•":401===e.statusCode?t="ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•":400===e.statusCode&&(t="è¯·æ±‚å‚æ•°é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥");let o=__spreadProps(__spreadValues({},e),{message:t,originalMessage:e.message});e.data&&e.data.error&&(o=__spreadProps(__spreadValues({},o),{detailedError:e.data.error,message:e.data.message||t}),a("warn","at utils/api.js:1452","å¸–å­åˆ›å»ºè¯¦ç»†é”™è¯¯:",o)),s(o)}))})):(a("error","at utils/api.js:1406","åˆ›å»ºå¸–å­å¤±è´¥: æœªç™»å½•çŠ¶æ€"),Promise.reject({message:"è¯·å…ˆç™»å½•",statusCode:401}))},updatePost:(e,t)=>{if(a("log","at utils/api.js:1467","æ›´æ–°å¸–å­ï¼ŒID:",e,"æ•°æ®:",t),!e||"string"!=typeof e||!e.trim())return a("error","at utils/api.js:1471","æ›´æ–°å¸–å­å¤±è´¥: æ— æ•ˆçš„å¸–å­ID:",e),Promise.reject(new Error("æ— æ•ˆçš„å¸–å­ID"));t.images&&!Array.isArray(t.images)&&(t.images=[t.images],a("log","at utils/api.js:1478","è½¬æ¢imagesä¸ºæ•°ç»„:",t.images));try{const o=encodeURIComponent(e.trim()),s=`${C}/api/community/posts/${o}`;return a("log","at utils/api.js:1487","æ›´æ–°å¸–å­URL:",s),new Promise(((e,o)=>{uni.request({url:s,data:t,method:"PUT",header:{Authorization:`Bearer ${uni.getStorageSync("token")}`,"Content-Type":"application/json"},success:t=>{const{statusCode:s,data:r}=t;s>=200&&s<300?(a("log","at utils/api.js:1502","æ›´æ–°å¸–å­æˆåŠŸï¼Œå“åº”:",r),e(r)):(a("error","at utils/api.js:1505","æ›´æ–°å¸–å­å¤±è´¥ï¼ŒHTTPçŠ¶æ€:",s,r),o({message:(null==r?void 0:r.message)||`æ›´æ–°å¤±è´¥(${s})`,statusCode:s,data:r}))},fail:e=>{a("error","at utils/api.js:1514","æ›´æ–°å¸–å­è¯·æ±‚å¤±è´¥:",e),o({message:"ç½‘ç»œè¯·æ±‚å¤±è´¥",error:e})}})}))}catch(o){return a("error","at utils/api.js:1523","æ„é€ æ›´æ–°å¸–å­è¯·æ±‚å¤±è´¥:",o),Promise.reject(o)}},deletePost:e=>{a("log","at utils/api.js:1530","å°è¯•åˆ é™¤å¸–å­ï¼ŒID:",e);const t=uni.getStorageSync("token");return t?new Promise(((o,s)=>{S({url:`/api/community/posts/${e}`,method:"DELETE",header:{Authorization:`Bearer ${t}`}}).then((e=>{a("log","at utils/api.js:1550","åˆ é™¤å¸–å­æˆåŠŸï¼Œå“åº”:",e),o(e)})).catch((e=>{a("error","at utils/api.js:1553","åˆ é™¤å¸–å­å¤±è´¥ï¼Œé”™è¯¯:",e);let t="åˆ é™¤å¸–å­å¤±è´¥";500===e.statusCode?t="æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•":401===e.statusCode?t="æ²¡æœ‰æƒé™åˆ é™¤æ­¤å¸–å­":404===e.statusCode&&(t="å¸–å­ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤"),s(__spreadProps(__spreadValues({},e),{message:t,originalMessage:e.message}))}))})):(a("error","at utils/api.js:1535","åˆ é™¤å¸–å­å¤±è´¥: æœªç™»å½•çŠ¶æ€"),Promise.reject({message:"è¯·å…ˆç™»å½•",statusCode:401}))},likePost:e=>S({url:`/api/community/posts/${e}/like`,method:"POST"}),unlikePost:e=>S({url:`/api/community/posts/${e}/like`,method:"DELETE"}),getComments:(e,t)=>P((()=>S({url:`/api/community/posts/${e}/comments`,method:"GET",params:t}))),addComment:(e,t)=>S({url:`/api/community/posts/${e}/comment`,method:"POST",data:t}),deleteComment:(e,t)=>S({url:`/api/community/posts/${e}/comment/${t}`,method:"DELETE"}),getImageUploadUrl:e=>`${C}/api/community/posts/${e}/image`,uploadPostImage:(e,t)=>new Promise(((o,s)=>{a("log","at utils/api.js:1627","å¼€å§‹ä¸Šä¼ å¸–å­å›¾ç‰‡åˆ°æœåŠ¡å™¨:",t),uni.uploadFile({url:`${C}/api/community/posts/${e}/image`,filePath:t,name:"image",header:{Authorization:`Bearer ${uni.getStorageSync("token")}`},success:e=>{if(a("log","at utils/api.js:1638","å›¾ç‰‡ä¸Šä¼ å“åº”:",e),e.statusCode>=200&&e.statusCode<300)try{const r=JSON.parse(e.data);a("log","at utils/api.js:1644","è§£æçš„å›¾ç‰‡ä¸Šä¼ å“åº”:",r);const n=r.url||r.imageUrl||r.data&&(r.data.url||r.data.imageUrl)||t;if(n)a("log","at utils/api.js:1652","æˆåŠŸè·å–å›¾ç‰‡URL:",n),o({success:!0,url:n,message:"å›¾ç‰‡å·²ä¸Šä¼ æˆåŠŸ"});else{if(a("error","at utils/api.js:1660","æœåŠ¡å™¨å“åº”ä¸­æœªæ‰¾åˆ°å›¾ç‰‡URL:",r),r&&!1===r.success)return void s(new Error(r.message||"å›¾ç‰‡ä¸Šä¼ å¤±è´¥"));o({success:!0,url:t,message:"å·²ä¸Šä¼ ä½†æœªè·å–æœåŠ¡å™¨URLï¼Œä½¿ç”¨æœ¬åœ°è·¯å¾„"})}}catch(r){a("error","at utils/api.js:1673","è§£æå›¾ç‰‡ä¸Šä¼ å“åº”å¤±è´¥:",r),o({success:!0,url:t,message:"å›¾ç‰‡å·²ä¸Šä¼ ä½†è§£æå“åº”å¤±è´¥"})}else a("error","at utils/api.js:1683",`å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼ŒçŠ¶æ€ç : ${e.statusCode}`),a("error","at utils/api.js:1684","é”™è¯¯å“åº”:",e.data),s(new Error(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${e.statusCode}`))},fail:r=>{a("error","at utils/api.js:1689","å›¾ç‰‡ä¸Šä¼ è¯·æ±‚å¤±è´¥:",r),a("warn","at utils/api.js:1691","å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨æœ¬åœ°è·¯å¾„"),S({url:`${C}/api/community/posts/${e}`,method:"PUT",data:{images:[t]}}).then((()=>{a("log","at utils/api.js:1701","å·²ä½¿ç”¨æœ¬åœ°è·¯å¾„ä½œä¸ºåå¤‡æ–¹æ¡ˆæ›´æ–°å¸–å­"),o({success:!0,url:t,message:"ä½¿ç”¨æœ¬åœ°å›¾ç‰‡è·¯å¾„(ä¸Šä¼ å¤±è´¥)"})})).catch((e=>{a("error","at utils/api.js:1708","ä½¿ç”¨æœ¬åœ°è·¯å¾„æ›´æ–°å¸–å­ä¹Ÿå¤±è´¥:",e),s(new Error("å›¾ç‰‡ä¸Šä¼ å’Œæ›´æ–°éƒ½å¤±è´¥: "+(r.errMsg||"æœªçŸ¥é”™è¯¯")))}))}})}))},walk:{getMyWalks:e=>P((()=>S({url:"/api/walks",method:"GET",params:e}))),getWalkById:e=>P((()=>S({url:`/api/walks/${e}`,method:"GET"}))),startWalk:e=>S({url:"/api/walks/start",method:"POST",data:e}),endWalk:(e,t)=>S({url:`/api/walks/${e}/end`,method:"POST",data:t}),deleteWalk:e=>S({url:`/api/walks/${e}`,method:"DELETE"}),updateWalkPoint:(e,t)=>S({url:`/api/walks/${e}/point`,method:"POST",data:t})},location:{updateLocation:e=>P((()=>S({url:"/api/locations/update",method:"PUT",data:e}))),getNearbyUsers:e=>P((()=>S({url:"/api/locations/nearby",method:"GET",params:e}))),toggleLocationSharing:e=>P((()=>S({url:"/api/locations/sharing",method:"PUT",data:e}))),getLocationSharingStatus:()=>P((()=>S({url:"/api/locations/sharing",method:"GET"}))),getUserPets:e=>P((()=>S({url:`/api/pets/user/${e}`,method:"GET"}))),checkFollowStatus:e=>P((()=>S({url:`/api/users/follow/check/${e}`,method:"GET"})))},chat:{sendNearbyMessage:e=>__async(this,null,(function*(){try{const t=yield S({url:"/api/chat/nearby",method:"POST",data:e});return b(t)}catch(t){throw a("error","at utils/api.js:1885","å‘é€é™„è¿‘æ¶ˆæ¯å¤±è´¥:",t),t}})),sendCityMessage:e=>__async(this,null,(function*(){try{const t=yield S({url:"/api/chat/city",method:"POST",data:e});return b(t)}catch(t){throw a("error","at utils/api.js:1904","å‘é€åŸå¸‚æ¶ˆæ¯å¤±è´¥:",t),t}})),getNearbyMessages:e=>__async(this,null,(function*(){try{const t=yield S({url:"/api/chat/nearby",method:"GET",params:e});return b(t)}catch(t){throw a("error","at utils/api.js:1923","è·å–é™„è¿‘æ¶ˆæ¯å¤±è´¥:",t),t}})),getCityMessages:e=>__async(this,null,(function*(){try{const t=yield S({url:"/api/chat/city",method:"GET",params:e});return b(t)}catch(t){throw a("error","at utils/api.js:1942","è·å–åŸå¸‚æ¶ˆæ¯å¤±è´¥:",t),t}})),sendPrivateMessage:e=>__async(this,null,(function*(){try{if(!e.receiverId||!e.content)throw new Error("å‘é€æ¶ˆæ¯éœ€è¦æ¥æ”¶è€…IDå’Œæ¶ˆæ¯å†…å®¹");const t=yield S({url:"/api/chat/private",method:"POST",data:e});return b(t)}catch(t){throw a("error","at utils/api.js:1966","å‘é€ç§èŠæ¶ˆæ¯å¤±è´¥:",t),t}})),getPrivateMessages:e=>__async(this,null,(function*(){try{if(!e.targetUserId)throw new Error("è·å–ç§èŠæ¶ˆæ¯éœ€è¦ç›®æ ‡ç”¨æˆ·ID");const t=yield S({url:"/api/chat/private",method:"GET",params:e});return b(t)}catch(t){throw a("error","at utils/api.js:1990","è·å–ç§èŠæ¶ˆæ¯å¤±è´¥:",t),t}})),markMessagesAsRead:e=>__async(this,null,(function*(){try{if(!e)throw new Error("æ ‡è®°æ¶ˆæ¯å·²è¯»éœ€è¦ç›®æ ‡ç”¨æˆ·ID");const t=yield S({url:`/api/chat/read/${e}`,method:"POST"});return b(t)}catch(t){throw a("error","at utils/api.js:2012","æ ‡è®°æ¶ˆæ¯å·²è¯»å¤±è´¥:",t),t}})),getUnreadCount:()=>__async(this,null,(function*(){try{const e=yield S({url:"/api/chat/unread",method:"GET"});return b(e)}catch(e){throw a("error","at utils/api.js:2029","è·å–æœªè¯»æ¶ˆæ¯æ•°é‡å¤±è´¥:",e),e}}))},upload:{uploadImage:(e,t={})=>new Promise(((o,s)=>{if(a("log","at utils/api.js:2053","å¼€å§‹ä¸Šä¼ å›¾ç‰‡, æ–‡ä»¶è·¯å¾„:",e),!e)return a("error","at utils/api.js:2057","ä¸Šä¼ å¤±è´¥: æ— æ•ˆçš„æ–‡ä»¶è·¯å¾„"),s(new Error("æ— æ•ˆçš„æ–‡ä»¶è·¯å¾„"));const r=uni.getStorageSync("token");uni.uploadFile({url:`${C}/api/upload/image`,filePath:e,name:"file",formData:t,header:{Authorization:r?`Bearer ${r}`:""},success:t=>{if(a("log","at utils/api.js:2075","å›¾ç‰‡ä¸Šä¼ å“åº”:",t),t.statusCode>=200&&t.statusCode<300)try{const s=JSON.parse(t.data);a("log","at utils/api.js:2080","è§£æä¸Šä¼ å“åº”:",s);const r=s.url||s.imageUrl||s.data&&(s.data.url||s.data.imageUrl)||e;o({success:!0,url:r,path:r})}catch(s){a("error","at utils/api.js:2095","è§£æå“åº”å¤±è´¥:",s),o({success:!0,url:e,path:e})}else a("error","at utils/api.js:2104","å›¾ç‰‡ä¸Šä¼ å¤±è´¥, çŠ¶æ€ç :",t.statusCode),a("warn","at utils/api.js:2108","å¼€å‘æ¨¡å¼: ä½¿ç”¨æœ¬åœ°è·¯å¾„ä½œä¸ºå›é€€"),o({success:!0,url:e,path:e})},fail:t=>{a("error","at utils/api.js:2120","å›¾ç‰‡ä¸Šä¼ è¯·æ±‚å¤±è´¥:",t),a("warn","at utils/api.js:2124","å¼€å‘æ¨¡å¼: ç½‘ç»œé”™è¯¯ï¼Œä½¿ç”¨æœ¬åœ°è·¯å¾„ä½œä¸ºå›é€€"),o({success:!0,url:e,path:e})}})}))}};function B(e,t,a){return Array.isArray(e)?(e.length=Math.max(e.length,t),e.splice(t,1,a),a):(e[t]=a,a)}function U(e,t){Array.isArray(e)?e.splice(t,1):delete e[t]}function j(){return"undefined"!=typeof navigator&&"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}}const F="function"==typeof Proxy;let L,$,O;function R(){return void 0!==L||("undefined"!=typeof window&&window.performance?(L=!0,$=window.performance):"undefined"!=typeof global&&(null===(e=global.perf_hooks)||void 0===e?void 0:e.performance)?(L=!0,$=global.perf_hooks.performance):L=!1),L?$.now():Date.now();var e}class W{constructor(e,t){this.target=null,this.targetQueue=[],this.onQueue=[],this.plugin=e,this.hook=t;const a={};if(e.settings)for(const n in e.settings){const t=e.settings[n];a[n]=t.defaultValue}const o=`__vue-devtools-plugin-settings__${e.id}`;let s=Object.assign({},a);try{const e=localStorage.getItem(o),t=JSON.parse(e);Object.assign(s,t)}catch(r){}this.fallbacks={getSettings:()=>s,setSettings(e){try{localStorage.setItem(o,JSON.stringify(e))}catch(r){}s=e},now:()=>R()},t&&t.on("plugin:settings:set",((e,t)=>{e===this.plugin.id&&this.fallbacks.setSettings(t)})),this.proxiedOn=new Proxy({},{get:(e,t)=>this.target?this.target.on[t]:(...e)=>{this.onQueue.push({method:t,args:e})}}),this.proxiedTarget=new Proxy({},{get:(e,t)=>this.target?this.target[t]:"on"===t?this.proxiedOn:Object.keys(this.fallbacks).includes(t)?(...e)=>(this.targetQueue.push({method:t,args:e,resolve:()=>{}}),this.fallbacks[t](...e)):(...e)=>new Promise((a=>{this.targetQueue.push({method:t,args:e,resolve:a})}))})}setRealTarget(e){return __async(this,null,(function*(){this.target=e;for(const e of this.onQueue)this.target.on[e.method](...e.args);for(const e of this.targetQueue)e.resolve(yield this.target[e.method](...e.args))}))}}function z(e,t){const a=e,o=j(),s=j().__VUE_DEVTOOLS_GLOBAL_HOOK__,r=F&&a.enableEarlyProxy;if(!s||!o.__VUE_DEVTOOLS_PLUGIN_API_AVAILABLE__&&r){const e=r?new W(a,s):null;(o.__VUE_DEVTOOLS_PLUGINS__=o.__VUE_DEVTOOLS_PLUGINS__||[]).push({pluginDescriptor:a,setupFn:t,proxy:e}),e&&t(e.proxiedTarget)}else s.emit("devtools-plugin:setup",e,t)}
/*!
   * pinia v2.1.7
   * (c) 2023 Eduardo San Martin Morote
   * @license MIT
   */const J=e=>O=e,H=Symbol("pinia");function q(e){return e&&"object"==typeof e&&"[object Object]"===Object.prototype.toString.call(e)&&"function"!=typeof e.toJSON}var G,Q;(Q=G||(G={})).direct="direct",Q.patchObject="patch object",Q.patchFunction="patch function";const K="undefined"!=typeof window,Y=K,X=(()=>"object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof global&&global.global===global?global:"object"==typeof globalThis?globalThis:{HTMLElement:null})();function Z(e,t,a){const o=new XMLHttpRequest;o.open("GET",e),o.responseType="blob",o.onload=function(){se(o.response,t,a)},o.onerror=function(){console.error("could not download file")},o.send()}function ee(e){const t=new XMLHttpRequest;t.open("HEAD",e,!1);try{t.send()}catch(a){}return t.status>=200&&t.status<=299}function te(e){try{e.dispatchEvent(new MouseEvent("click"))}catch(t){const a=document.createEvent("MouseEvents");a.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),e.dispatchEvent(a)}}const ae="object"==typeof navigator?navigator:{userAgent:""},oe=(()=>/Macintosh/.test(ae.userAgent)&&/AppleWebKit/.test(ae.userAgent)&&!/Safari/.test(ae.userAgent))(),se=K?"undefined"!=typeof HTMLAnchorElement&&"download"in HTMLAnchorElement.prototype&&!oe?function(e,t="download",a){const o=document.createElement("a");o.download=t,o.rel="noopener","string"==typeof e?(o.href=e,o.origin!==location.origin?ee(o.href)?Z(e,t,a):(o.target="_blank",te(o)):te(o)):(o.href=URL.createObjectURL(e),setTimeout((function(){URL.revokeObjectURL(o.href)}),4e4),setTimeout((function(){te(o)}),0))}:"msSaveOrOpenBlob"in ae?function(e,t="download",a){if("string"==typeof e)if(ee(e))Z(e,t,a);else{const t=document.createElement("a");t.href=e,t.target="_blank",setTimeout((function(){te(t)}))}else navigator.msSaveOrOpenBlob(function(e,{autoBom:t=!1}={}){return t&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob([String.fromCharCode(65279),e],{type:e.type}):e}(e,a),t)}:function(e,t,a,o){(o=o||open("","_blank"))&&(o.document.title=o.document.body.innerText="downloading...");if("string"==typeof e)return Z(e,t,a);const s="application/octet-stream"===e.type,r=/constructor/i.test(String(X.HTMLElement))||"safari"in X,n=/CriOS\/[\d]+/.test(navigator.userAgent);if((n||s&&r||oe)&&"undefined"!=typeof FileReader){const t=new FileReader;t.onloadend=function(){let e=t.result;if("string"!=typeof e)throw o=null,new Error("Wrong reader.result type");e=n?e:e.replace(/^data:[^;]*;/,"data:attachment/file;"),o?o.location.href=e:location.assign(e),o=null},t.readAsDataURL(e)}else{const t=URL.createObjectURL(e);o?o.location.assign(t):location.href=t,o=null,setTimeout((function(){URL.revokeObjectURL(t)}),4e4)}}:()=>{};function re(e,t){const a="ğŸ "+e;"function"==typeof __VUE_DEVTOOLS_TOAST__?__VUE_DEVTOOLS_TOAST__(a,t):"error"===t?console.error(a):"warn"===t?console.warn(a):console.log(a)}function ne(e){return"_a"in e&&"install"in e}function ie(){if(!("clipboard"in navigator))return re("Your browser doesn't support the Clipboard API","error"),!0}function le(e){return!!(e instanceof Error&&e.message.toLowerCase().includes("document is not focused"))&&(re('You need to activate the "Emulate a focused page" setting in the "Rendering" panel of devtools.',"warn"),!0)}let ce;function ue(e){return __async(this,null,(function*(){try{const t=(ce||(ce=document.createElement("input"),ce.type="file",ce.accept=".json"),function(){return new Promise(((e,t)=>{ce.onchange=()=>__async(this,null,(function*(){const t=ce.files;if(!t)return e(null);const a=t.item(0);return e(a?{text:yield a.text(),file:a}:null)})),ce.oncancel=()=>e(null),ce.onerror=t,ce.click()}))}),a=yield t();if(!a)return;const{text:o,file:s}=a;de(e,JSON.parse(o)),re(`Global state imported from "${s.name}".`)}catch(t){re("Failed to import the state from JSON. Check the console for more details.","error"),console.error(t)}}))}function de(e,t){for(const a in t){const o=e.state.value[a];o?Object.assign(o,t[a]):e.state.value[a]=t[a]}}function me(e){return{_custom:{display:e}}}const pe="ğŸ Pinia (root)",ge="_root";function ve(e){return ne(e)?{id:ge,label:pe}:{id:e.$id,label:e.$id}}function he(e){return e?Array.isArray(e)?e.reduce(((e,t)=>(e.keys.push(t.key),e.operations.push(t.type),e.oldValue[t.key]=t.oldValue,e.newValue[t.key]=t.newValue,e)),{oldValue:{},keys:[],operations:[],newValue:{}}):{operation:me(e.type),key:me(e.key),oldValue:e.oldValue,newValue:e.newValue}:{}}function fe(e){switch(e){case G.direct:return"mutation";case G.patchFunction:case G.patchObject:return"$patch";default:return"unknown"}}let ye=!0;const we=[],ke="pinia:mutations",Ee="pinia",{assign:Ne}=Object,Ve=e=>"ğŸ "+e;function Se(t,a){z({id:"dev.esm.pinia",label:"Pinia ğŸ",logo:"https://pinia.vuejs.org/logo.svg",packageName:"pinia",homepage:"https://pinia.vuejs.org",componentStateTypes:we,app:t},(o=>{"function"!=typeof o.now&&re("You seem to be using an outdated version of Vue Devtools. Are you still using the Beta release instead of the stable one? You can find the links at https://devtools.vuejs.org/guide/installation.html."),o.addTimelineLayer({id:ke,label:"Pinia ğŸ",color:15064968}),o.addInspector({id:Ee,label:"Pinia ğŸ",icon:"storage",treeFilterPlaceholder:"Search stores",actions:[{icon:"content_copy",action:()=>{!function(e){__async(this,null,(function*(){if(!ie())try{yield navigator.clipboard.writeText(JSON.stringify(e.state.value)),re("Global state copied to clipboard.")}catch(t){if(le(t))return;re("Failed to serialize the state. Check the console for more details.","error"),console.error(t)}}))}(a)},tooltip:"Serialize and copy the state"},{icon:"content_paste",action:()=>__async(this,null,(function*(){yield function(e){return __async(this,null,(function*(){if(!ie())try{de(e,JSON.parse(yield navigator.clipboard.readText())),re("Global state pasted from clipboard.")}catch(t){if(le(t))return;re("Failed to deserialize the state from clipboard. Check the console for more details.","error"),console.error(t)}}))}(a),o.sendInspectorTree(Ee),o.sendInspectorState(Ee)})),tooltip:"Replace the state with the content of your clipboard"},{icon:"save",action:()=>{!function(e){__async(this,null,(function*(){try{se(new Blob([JSON.stringify(e.state.value)],{type:"text/plain;charset=utf-8"}),"pinia-state.json")}catch(t){re("Failed to export the state as JSON. Check the console for more details.","error"),console.error(t)}}))}(a)},tooltip:"Save the state as a JSON file"},{icon:"folder_open",action:()=>__async(this,null,(function*(){yield ue(a),o.sendInspectorTree(Ee),o.sendInspectorState(Ee)})),tooltip:"Import the state from a JSON file"}],nodeActions:[{icon:"restore",tooltip:'Reset the state (with "$reset")',action:e=>{const t=a._s.get(e);t?"function"!=typeof t.$reset?re(`Cannot reset "${e}" store because it doesn't have a "$reset" method implemented.`,"warn"):(t.$reset(),re(`Store "${e}" reset.`)):re(`Cannot reset "${e}" store because it wasn't found.`,"warn")}}]}),o.on.inspectComponent(((t,a)=>{const o=t.componentInstance&&t.componentInstance.proxy;if(o&&o._pStores){const a=t.componentInstance.proxy._pStores;Object.values(a).forEach((a=>{t.instanceData.state.push({type:Ve(a.$id),key:"state",editable:!0,value:a._isOptionsAPI?{_custom:{value:e.toRaw(a.$state),actions:[{icon:"restore",tooltip:"Reset the state of this store",action:()=>a.$reset()}]}}:Object.keys(a.$state).reduce(((e,t)=>(e[t]=a.$state[t],e)),{})}),a._getters&&a._getters.length&&t.instanceData.state.push({type:Ve(a.$id),key:"getters",editable:!1,value:a._getters.reduce(((e,t)=>{try{e[t]=a[t]}catch(o){e[t]=o}return e}),{})})}))}})),o.on.getInspectorTree((e=>{if(e.app===t&&e.inspectorId===Ee){let t=[a];t=t.concat(Array.from(a._s.values())),e.rootNodes=(e.filter?t.filter((t=>"$id"in t?t.$id.toLowerCase().includes(e.filter.toLowerCase()):pe.toLowerCase().includes(e.filter.toLowerCase()))):t).map(ve)}})),o.on.getInspectorState((e=>{if(e.app===t&&e.inspectorId===Ee){const t=e.nodeId===ge?a:a._s.get(e.nodeId);if(!t)return;t&&(e.state=function(e){if(ne(e)){const t=Array.from(e._s.keys()),a=e._s;return{state:t.map((t=>({editable:!0,key:t,value:e.state.value[t]}))),getters:t.filter((e=>a.get(e)._getters)).map((e=>{const t=a.get(e);return{editable:!1,key:e,value:t._getters.reduce(((e,a)=>(e[a]=t[a],e)),{})}}))}}const t={state:Object.keys(e.$state).map((t=>({editable:!0,key:t,value:e.$state[t]})))};return e._getters&&e._getters.length&&(t.getters=e._getters.map((t=>({editable:!1,key:t,value:e[t]})))),e._customProperties.size&&(t.customProperties=Array.from(e._customProperties).map((t=>({editable:!0,key:t,value:e[t]})))),t}(t))}})),o.on.editInspectorState(((e,o)=>{if(e.app===t&&e.inspectorId===Ee){const t=e.nodeId===ge?a:a._s.get(e.nodeId);if(!t)return re(`store "${e.nodeId}" not found`,"error");const{path:o}=e;ne(t)?o.unshift("state"):1===o.length&&t._customProperties.has(o[0])&&!(o[0]in t.$state)||o.unshift("$state"),ye=!1,e.set(t,o,e.state.value),ye=!0}})),o.on.editComponentState((e=>{if(e.type.startsWith("ğŸ")){const t=e.type.replace(/^ğŸ\s*/,""),o=a._s.get(t);if(!o)return re(`store "${t}" not found`,"error");const{path:s}=e;if("state"!==s[0])return re(`Invalid path for store "${t}":\n${s}\nOnly state can be modified.`);s[0]="$state",ye=!1,e.set(o,s,e.state.value),ye=!0}}))}))}let _e,Ce=0;function be(t,a,o){const s=a.reduce(((a,o)=>(a[o]=e.toRaw(t)[o],a)),{});for(const e in s)t[e]=function(){const a=Ce,r=o?new Proxy(t,{get:(...e)=>(_e=a,Reflect.get(...e)),set:(...e)=>(_e=a,Reflect.set(...e))}):t;_e=a;const n=s[e].apply(r,arguments);return _e=void 0,n}}function Pe({app:t,store:a,options:o}){if(a.$id.startsWith("__hot:"))return;a._isOptionsAPI=!!o.state,be(a,Object.keys(o.actions),a._isOptionsAPI);const s=a._hotUpdate;e.toRaw(a)._hotUpdate=function(e){s.apply(this,arguments),be(a,Object.keys(e._hmrPayload.actions),!!a._isOptionsAPI)},function(t,a){we.includes(Ve(a.$id))||we.push(Ve(a.$id)),z({id:"dev.esm.pinia",label:"Pinia ğŸ",logo:"https://pinia.vuejs.org/logo.svg",packageName:"pinia",homepage:"https://pinia.vuejs.org",componentStateTypes:we,app:t,settings:{logStoreChanges:{label:"Notify about new/deleted stores",type:"boolean",defaultValue:!0}}},(t=>{const o="function"==typeof t.now?t.now.bind(t):Date.now;a.$onAction((({after:e,onError:s,name:r,args:n})=>{const i=Ce++;t.addTimelineEvent({layerId:ke,event:{time:o(),title:"ğŸ›« "+r,subtitle:"start",data:{store:me(a.$id),action:me(r),args:n},groupId:i}}),e((e=>{_e=void 0,t.addTimelineEvent({layerId:ke,event:{time:o(),title:"ğŸ›¬ "+r,subtitle:"end",data:{store:me(a.$id),action:me(r),args:n,result:e},groupId:i}})})),s((e=>{_e=void 0,t.addTimelineEvent({layerId:ke,event:{time:o(),logType:"error",title:"ğŸ’¥ "+r,subtitle:"end",data:{store:me(a.$id),action:me(r),args:n,error:e},groupId:i}})}))}),!0),a._customProperties.forEach((s=>{e.watch((()=>e.unref(a[s])),((e,a)=>{t.notifyComponentUpdate(),t.sendInspectorState(Ee),ye&&t.addTimelineEvent({layerId:ke,event:{time:o(),title:"Change",subtitle:s,data:{newValue:e,oldValue:a},groupId:_e}})}),{deep:!0})})),a.$subscribe((({events:e,type:s},r)=>{if(t.notifyComponentUpdate(),t.sendInspectorState(Ee),!ye)return;const n={time:o(),title:fe(s),data:Ne({store:me(a.$id)},he(e)),groupId:_e};s===G.patchFunction?n.subtitle="â¤µï¸":s===G.patchObject?n.subtitle="ğŸ§©":e&&!Array.isArray(e)&&(n.subtitle=e.type),e&&(n.data["rawEvent(s)"]={_custom:{display:"DebuggerEvent",type:"object",tooltip:"raw DebuggerEvent[]",value:e}}),t.addTimelineEvent({layerId:ke,event:n})}),{detached:!0,flush:"sync"});const s=a._hotUpdate;a._hotUpdate=e.markRaw((e=>{s(e),t.addTimelineEvent({layerId:ke,event:{time:o(),title:"ğŸ”¥ "+a.$id,subtitle:"HMR update",data:{store:me(a.$id),info:me("HMR update")}}}),t.notifyComponentUpdate(),t.sendInspectorTree(Ee),t.sendInspectorState(Ee)}));const{$dispose:r}=a;a.$dispose=()=>{r(),t.notifyComponentUpdate(),t.sendInspectorTree(Ee),t.sendInspectorState(Ee),t.getSettings().logStoreChanges&&re(`Disposed "${a.$id}" store ğŸ—‘`)},t.notifyComponentUpdate(),t.sendInspectorTree(Ee),t.sendInspectorState(Ee),t.getSettings().logStoreChanges&&re(`"${a.$id}" store installed ğŸ†•`)}))}(t,a)}function xe(t,a){for(const o in a){const s=a[o];if(!(o in t))continue;const r=t[o];q(r)&&q(s)&&!e.isRef(s)&&!e.isReactive(s)?t[o]=xe(r,s):t[o]=s}return t}const Ie=()=>{};function Te(t,a,o,s=Ie){t.push(a);const r=()=>{const e=t.indexOf(a);e>-1&&(t.splice(e,1),s())};return!o&&e.getCurrentScope()&&e.onScopeDispose(r),r}function Me(e,...t){e.slice().forEach((e=>{e(...t)}))}const De=e=>e();function Ae(t,a){t instanceof Map&&a instanceof Map&&a.forEach(((e,a)=>t.set(a,e))),t instanceof Set&&a instanceof Set&&a.forEach(t.add,t);for(const o in a){if(!a.hasOwnProperty(o))continue;const s=a[o],r=t[o];q(r)&&q(s)&&t.hasOwnProperty(o)&&!e.isRef(s)&&!e.isReactive(s)?t[o]=Ae(r,s):t[o]=s}return t}const Be=Symbol("pinia:skipHydration");const{assign:Ue}=Object;function je(t){return!(!e.isRef(t)||!t.effect)}function Fe(t,a,o,s){const{state:r,actions:n,getters:i}=a,l=o.state.value[t];let c;return c=Le(t,(function(){l||s||(o.state.value[t]=r?r():{});const a=s?e.toRefs(e.ref(r?r():{}).value):e.toRefs(o.state.value[t]);return Ue(a,n,Object.keys(i||{}).reduce(((s,r)=>(r in a&&console.warn(`[ğŸ]: A getter cannot have the same name as another state property. Rename one of them. Found with "${r}" in store "${t}".`),s[r]=e.markRaw(e.computed((()=>{J(o);const e=o._s.get(t);return i[r].call(e,e)}))),s)),{}))}),a,o,s,!0),c}function Le(t,a,o={},s,r,n){let i;const l=Ue({actions:{}},o);if(!s._e.active)throw new Error("Pinia destroyed");const c={deep:!0};let u,d;c.onTrigger=e=>{u?m=e:0!=u||V._hotUpdating||(Array.isArray(m)?m.push(e):console.error("ğŸ debuggerEvents should be an array. This is most likely an internal Pinia bug."))};let m,p=[],g=[];const v=s.state.value[t];n||v||r||(s.state.value[t]={});const h=e.ref({});let f;function y(a){let o;u=d=!1,m=[],"function"==typeof a?(a(s.state.value[t]),o={type:G.patchFunction,storeId:t,events:m}):(Ae(s.state.value[t],a),o={type:G.patchObject,payload:a,storeId:t,events:m});const r=f=Symbol();e.nextTick().then((()=>{f===r&&(u=!0)})),d=!0,Me(p,o,s.state.value[t])}const w=n?function(){const{state:e}=o,t=e?e():{};this.$patch((e=>{Ue(e,t)}))}:()=>{throw new Error(`ğŸ: Store "${t}" is built using the setup syntax and does not implement $reset().`)};function k(e,a){return function(){J(s);const o=Array.from(arguments),r=[],n=[];let i;Me(g,{args:o,name:e,store:V,after:function(e){r.push(e)},onError:function(e){n.push(e)}});try{i=a.apply(this&&this.$id===t?this:V,o)}catch(l){throw Me(n,l),l}return i instanceof Promise?i.then((e=>(Me(r,e),e))).catch((e=>(Me(n,e),Promise.reject(e)))):(Me(r,i),i)}}const E=e.markRaw({actions:{},getters:{},state:[],hotState:h}),N={_p:s,$id:t,$onAction:Te.bind(null,g),$patch:y,$reset:w,$subscribe(a,o={}){const r=Te(p,a,o.detached,(()=>n())),n=i.run((()=>e.watch((()=>s.state.value[t]),(e=>{("sync"===o.flush?d:u)&&a({storeId:t,type:G.direct,events:m},e)}),Ue({},c,o))));return r},$dispose:function(){i.stop(),p=[],g=[],s._s.delete(t)}},V=e.reactive(Ue({_hmrPayload:E,_customProperties:e.markRaw(new Set)},N));s._s.set(t,V);const S=(s._a&&s._a.runWithContext||De)((()=>s._e.run((()=>(i=e.effectScope()).run(a)))));for(const C in S){const a=S[C];if(e.isRef(a)&&!je(a)||e.isReactive(a))r?B(h.value,C,e.toRef(S,C)):n||(!v||q(_=a)&&_.hasOwnProperty(Be)||(e.isRef(a)?a.value=v[C]:Ae(a,v[C])),s.state.value[t][C]=a),E.state.push(C);else if("function"==typeof a){const e=r?a:k(C,a);S[C]=e,E.actions[C]=a,l.actions[C]=a}else if(je(a)&&(E.getters[C]=n?o.getters[C]:a,K)){(S._getters||(S._getters=e.markRaw([]))).push(C)}}var _;if(Ue(V,S),Ue(e.toRaw(V),S),Object.defineProperty(V,"$state",{get:()=>r?h.value:s.state.value[t],set:e=>{if(r)throw new Error("cannot set hotState");y((t=>{Ue(t,e)}))}}),V._hotUpdate=e.markRaw((a=>{V._hotUpdating=!0,a._hmrPayload.state.forEach((t=>{if(t in V.$state){const e=a.$state[t],o=V.$state[t];"object"==typeof e&&q(e)&&q(o)?xe(e,o):a.$state[t]=o}B(V,t,e.toRef(a.$state,t))})),Object.keys(V.$state).forEach((e=>{e in a.$state||U(V,e)})),u=!1,d=!1,s.state.value[t]=e.toRef(a._hmrPayload,"hotState"),d=!0,e.nextTick().then((()=>{u=!0}));for(const e in a._hmrPayload.actions){const t=a[e];B(V,e,k(e,t))}for(const t in a._hmrPayload.getters){const o=a._hmrPayload.getters[t],r=n?e.computed((()=>(J(s),o.call(V,V)))):o;B(V,t,r)}Object.keys(V._hmrPayload.getters).forEach((e=>{e in a._hmrPayload.getters||U(V,e)})),Object.keys(V._hmrPayload.actions).forEach((e=>{e in a._hmrPayload.actions||U(V,e)})),V._hmrPayload=a._hmrPayload,V._getters=a._getters,V._hotUpdating=!1})),Y){const e={writable:!0,configurable:!0,enumerable:!1};["_p","_hmrPayload","_getters","_customProperties"].forEach((t=>{Object.defineProperty(V,t,Ue({value:V[t]},e))}))}return s._p.forEach((e=>{if(Y){const t=i.run((()=>e({store:V,app:s._a,pinia:s,options:l})));Object.keys(t||{}).forEach((e=>V._customProperties.add(e))),Ue(V,t)}else Ue(V,i.run((()=>e({store:V,app:s._a,pinia:s,options:l}))))})),V.$state&&"object"==typeof V.$state&&"function"==typeof V.$state.constructor&&!V.$state.constructor.toString().includes("[native code]")&&console.warn(`[ğŸ]: The "state" must be a plain object. It cannot be\n\tstate: () => new MyClass()\nFound in store "${V.$id}".`),v&&n&&o.hydrate&&o.hydrate(V.$state,v),u=!0,d=!0,V}function $e(t,a,o){let s,r;const n="function"==typeof a;if("string"==typeof t)s=t,r=n?o:a;else if(r=t,s=t.id,"string"!=typeof s)throw new Error('[ğŸ]: "defineStore()" must be passed a store id as its first argument.');function i(t,o){const l=e.hasInjectionContext();if((t=t||(l?e.inject(H,null):null))&&J(t),!O)throw new Error('[ğŸ]: "getActivePinia()" was called but there was no active Pinia. Are you trying to use a store before calling "app.use(pinia)"?\nSee https://pinia.vuejs.org/core-concepts/outside-component-usage.html for help.\nThis will fail in production.');(t=O)._s.has(s)||(n?Le(s,a,r,t):Fe(s,r,t),i._pinia=t);const c=t._s.get(s);if(o){const e="__hot:"+s,i=n?Le(e,a,r,t,!0):Fe(e,Ue({},r),t,!0);o._hotUpdate(i),delete t.state.value[e],t._s.delete(e)}if(K){const t=e.getCurrentInstance();if(t&&t.proxy&&!o){const e=t.proxy;("_pStores"in e?e._pStores:e._pStores={})[s]=c}}return c}return i.$id=s,i}const Oe=$e("pet",{state:()=>({pets:[],currentPet:null,loading:!1,error:null}),getters:{hasPets:e=>e.pets.length>0},actions:{restorePetState(){try{const e=uni.getStorageSync("pets"),t=uni.getStorageSync("currentPet");e&&(this.pets=JSON.parse(e)),t&&(this.currentPet=JSON.parse(t))}catch(e){a("error","at store/pet.js:34","æ¢å¤å® ç‰©çŠ¶æ€å¤±è´¥:",e)}},savePetState(){try{uni.setStorageSync("pets",JSON.stringify(this.pets)),this.currentPet&&uni.setStorageSync("currentPet",JSON.stringify(this.currentPet))}catch(e){a("error","at store/pet.js:46","ä¿å­˜å® ç‰©çŠ¶æ€å¤±è´¥:",e)}},fetchPets(){return __async(this,null,(function*(){try{this.loading=!0,this.error=null;if(!Re().isAuthenticated)return this.pets=[],[];const e=yield A.pet.getMyPets();return this.pets=e&&Array.isArray(e)?e:[],this.pets.length>0&&!this.currentPet&&(this.currentPet=this.pets[0]),this.savePetState(),this.pets}catch(e){return a("error","at store/pet.js:82","è·å–å® ç‰©åˆ—è¡¨å¤±è´¥:",e),this.error="è·å–å® ç‰©åˆ—è¡¨å¤±è´¥",this.pets&&this.pets.length||(this.restorePetState(),this.pets||(this.pets=[])),this.pets||[]}finally{this.loading=!1}}))},getPetById(e){return __async(this,null,(function*(){const t=this.pets.find((t=>t.id===e||t._id===e));if(t)return t.dailyPhotos&&Array.isArray(t.dailyPhotos)&&a("log","at store/pet.js:102","ä»æœ¬åœ°è·å–å® ç‰©ä¿¡æ¯ï¼Œå¤„ç†ç…§ç‰‡URL"),t;try{this.loading=!0,this.error=null;const t=yield A.pet.getPetById(e);return t?(t.dailyPhotos&&Array.isArray(t.dailyPhotos)&&a("log","at store/pet.js:116","ä»APIè·å–å® ç‰©ä¿¡æ¯ï¼Œå¤„ç†ç…§ç‰‡URL:",t.dailyPhotos.length),t):null}catch(o){return a("error","at store/pet.js:122","è·å–å® ç‰©è¯¦æƒ…å¤±è´¥:",o),this.error="è·å–å® ç‰©è¯¦æƒ…å¤±è´¥",null}finally{this.loading=!1}}))},createPet(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null;const t=yield A.pet.addPet(e);return yield this.fetchPets(),t}catch(t){throw a("error","at store/pet.js:141","åˆ›å»ºå® ç‰©å¤±è´¥:",t),this.error="åˆ›å»ºå® ç‰©å¤±è´¥",t}finally{this.loading=!1}}))},updatePet(e,t){return __async(this,null,(function*(){try{this.loading=!0,this.error=null,a("log","at store/pet.js:155","æ›´æ–°å® ç‰©ä¿¡æ¯ï¼ŒID:",e,"æ•°æ®:",t);const o=yield A.pet.updatePet(e,t);a("log","at store/pet.js:159","æ›´æ–°å® ç‰©APIå“åº”:",o),yield this.fetchPets();const s=this.pets.find((t=>t._id===e||t.id===e));return this.currentPet&&(this.currentPet._id===e||this.currentPet.id===e)&&s&&(this.currentPet=s),this.savePetState(),s||o}catch(o){throw a("error","at store/pet.js:177","æ›´æ–°å® ç‰©ä¿¡æ¯å¤±è´¥:",o),this.error="æ›´æ–°å® ç‰©ä¿¡æ¯å¤±è´¥",o}finally{this.loading=!1}}))},deletePet(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null,a("log","at store/pet.js:191","åˆ é™¤å® ç‰©ï¼ŒID:",e);return a("log","at store/pet.js:195","åˆ é™¤å® ç‰©APIå“åº”:",yield A.pet.deletePet(e)),this.pets=this.pets.filter((t=>t._id!==e&&t.id!==e)),!this.currentPet||this.currentPet._id!==e&&this.currentPet.id!==e||(this.currentPet=this.pets.length>0?this.pets[0]:null),this.savePetState(),{success:!0}}catch(t){throw a("error","at store/pet.js:212","åˆ é™¤å® ç‰©å¤±è´¥:",t),this.error="åˆ é™¤å® ç‰©å¤±è´¥",t}finally{this.loading=!1}}))},uploadPetAvatar(e,t){return __async(this,null,(function*(){try{this.loading=!0,this.error=null,a("log","at store/pet.js:226","å¼€å§‹ä¸Šä¼ å® ç‰©å¤´åƒ:",e,t);const o=yield A.pet.uploadPetAvatar(e,t);if(a("log","at store/pet.js:230","å¤´åƒä¸Šä¼ ç»“æœ:",o),o){yield this.fetchPets();const t=this.pets.find((t=>t._id===e||t.id===e));t&&(a("log","at store/pet.js:241","å¤´åƒæ›´æ–°åçš„å® ç‰©:",t),!this.currentPet||this.currentPet._id!==e&&this.currentPet.id!==e||(this.currentPet=t)),this.savePetState()}return o}catch(o){throw a("error","at store/pet.js:255","ä¸Šä¼ å® ç‰©å¤´åƒå¤±è´¥:",o),this.error="ä¸Šä¼ å® ç‰©å¤´åƒå¤±è´¥",o}finally{this.loading=!1}}))},setCurrentPet(e){this.currentPet=e,this.savePetState()},clearPets(){this.pets=[],this.currentPet=null,this.error=null;try{uni.removeStorageSync("pets"),uni.removeStorageSync("currentPet")}catch(e){a("error","at store/pet.js:280","æ¸…é™¤å® ç‰©æ•°æ®å¤±è´¥:",e)}},addPet(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null,a("log","at store/pet.js:290","æ·»åŠ å® ç‰©ï¼Œæ•°æ®:",e);const t=yield A.pet.addPet(e);if(a("log","at store/pet.js:294","æ·»åŠ å® ç‰©APIå“åº”:",t),yield this.fetchPets(),!this.currentPet&&this.pets&&this.pets.length>0){const e=this.pets[this.pets.length-1];this.setCurrentPet(e)}return this.savePetState(),t}catch(t){throw a("error","at store/pet.js:311","æ·»åŠ å® ç‰©å¤±è´¥:",t),this.error="æ·»åŠ å® ç‰©å¤±è´¥",t}finally{this.loading=!1}}))},uploadPetDailyPhoto(e,t){return __async(this,null,(function*(){this.loading=!0,this.error=null;try{a("log","at store/pet.js:325","ä¸Šä¼ å® ç‰©æ—¥å¸¸ç…§ç‰‡:",e,t);const o=`${uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000"}/api/pets/${e}/daily-photo`,s=uni.getStorageSync("token");return t.startsWith("blob:")?new Promise(((e,r)=>{try{a("log","at store/pet.js:336","å¤„ç†blob URL:",t);const n=new Image;n.crossOrigin="anonymous",n.onload=()=>{try{const t=document.createElement("canvas");t.width=n.width,t.height=n.height;t.getContext("2d").drawImage(n,0,0);const i=t.toDataURL("image/jpeg",.9);a("log","at store/pet.js:351","è½¬æ¢å®Œæˆï¼Œå‡†å¤‡å‘é€base64æ•°æ®"),fetch(o,{method:"POST",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"},body:JSON.stringify({imageData:i,description:""})}).then((e=>{if(!e.ok)throw new Error(`ä¸Šä¼ å¤±è´¥: ${e.status}`);return e.json()})).then((t=>{a("log","at store/pet.js:372","ä¸Šä¼ æˆåŠŸ:",t),e(t)})).catch((e=>{a("error","at store/pet.js:376","ä¸Šä¼ é”™è¯¯:",e),r(e)}))}catch(t){a("error","at store/pet.js:380","Canvaså¤„ç†å¤±è´¥:",t),r(t)}},n.onerror=e=>{a("error","at store/pet.js:386","å›¾ç‰‡åŠ è½½å¤±è´¥:",e),r(new Error("å›¾ç‰‡åŠ è½½å¤±è´¥"))},n.src=t}catch(n){a("error","at store/pet.js:392","å¤„ç†blob URLå¤±è´¥:",n),r(n)}})):new Promise(((e,r)=>{a("log","at store/pet.js:399","å¤„ç†æœ¬åœ°æ–‡ä»¶è·¯å¾„:",t),uni.uploadFile({url:o,filePath:t,name:"photo",header:{Authorization:`Bearer ${s}`},success:t=>{let o;a("log","at store/pet.js:409","ç…§ç‰‡ä¸Šä¼ æˆåŠŸ:",t);try{o="string"==typeof t.data?JSON.parse(t.data):t.data,e(o)}catch(s){a("error","at store/pet.js:421","è§£æä¸Šä¼ å“åº”å¤±è´¥:",s),r(s)}},fail:e=>{a("error","at store/pet.js:426","ç…§ç‰‡ä¸Šä¼ å¤±è´¥:",e),r(e)},complete:()=>{this.loading=!1}})}))}catch(o){throw a("error","at store/pet.js:436","ä¸Šä¼ å® ç‰©æ—¥å¸¸ç…§ç‰‡å¤±è´¥:",o),this.error=o.message||"ä¸Šä¼ å® ç‰©æ—¥å¸¸ç…§ç‰‡å¤±è´¥",o}finally{this.loading=!1}}))}}}),Re=$e("user",{state:()=>({user:null,token:uni.getStorageSync("token")||null,loading:!1,error:null,stats:null}),getters:{isAuthenticated:e=>!!e.token&&!!e.user,userAvatar:e=>e.user?e.user.avatar||"/static/images/default-avatar.png":"",userId:e=>{var t,a;return(null==(t=e.user)?void 0:t._id)||(null==(a=e.user)?void 0:a.id)||""},nickname:e=>{var t,a;return(null==(t=e.user)?void 0:t.nickname)||(null==(a=e.user)?void 0:a.username)||"æ¸¸å®¢"}},actions:{login(e,t){return __async(this,null,(function*(){try{this.loading=!0,this.error=null;const o=yield A.user.login(e,t);if(a("log","at store/user.js:33","ç™»å½•å“åº”:",o),o&&o.token){if(uni.setStorageSync("token",o.token),o.user){const e=__spreadValues({},o.user);e.gender||(a("warn","at store/user.js:44","ç™»å½•å“åº”ä¸­ç”¨æˆ·ä¿¡æ¯æ²¡æœ‰genderå­—æ®µï¼Œè®¾ç½®ä¸ºé»˜è®¤å€¼unknown"),e.gender="unknown"),this.user=e,uni.setStorageSync("userInfo",JSON.stringify(e)),a("log","at store/user.js:50","ç™»å½•æˆåŠŸï¼Œç”¨æˆ·ä¿¡æ¯å·²ä¿å­˜:",{user:this.user,gender:this.user.gender})}else a("log","at store/user.js:56","ç™»å½•å“åº”ä¸­æ— ç”¨æˆ·ä¿¡æ¯ï¼Œè·å–ç”¨æˆ·ä¿¡æ¯"),yield this.fetchUserInfo();return!0}return this.error="ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ",!1}catch(o){return a("error","at store/user.js:66","ç™»å½•å¤±è´¥:",o),this.error="ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥",!1}finally{this.loading=!1}}))},register(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null;return yield A.auth.register(e)}catch(t){throw a("error","at store/user.js:82","æ³¨å†Œå¤±è´¥:",t),this.error=t.message||"æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åå†è¯•",t}finally{this.loading=!1}}))},fetchUserInfo(){return __async(this,null,(function*(){try{a("log","at store/user.js:93","å¼€å§‹è·å–ç”¨æˆ·ä¿¡æ¯"),this.loading=!0,this.error=null;let t=null;try{const e=uni.getStorageSync("userInfo");e&&(t=JSON.parse(e),a("log","at store/user.js:103","å·²è·å–æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯ç”¨äºå¤‡ä»½:",t))}catch(e){a("warn","at store/user.js:106","è¯»å–æœ¬åœ°ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",e)}const o=yield A.user.getCurrentUser();if(a("log","at store/user.js:111","ä»APIè·å–åˆ°çš„ç”¨æˆ·ä¿¡æ¯:",o),o){const e=__spreadValues({},o);return!e.gender&&t&&t.gender?(a("warn","at store/user.js:119","APIå“åº”ä¸­ç¼ºå°‘genderå­—æ®µï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨çš„å€¼:",t.gender),e.gender=t.gender):e.gender||(a("warn","at store/user.js:123","æ²¡æœ‰æ‰¾åˆ°genderå­—æ®µï¼Œè®¾ç½®ä¸ºé»˜è®¤å€¼unknown"),e.gender="unknown"),this.user=e,uni.setStorageSync("userInfo",JSON.stringify(e)),a("log","at store/user.js:131","æœ€ç»ˆæ›´æ–°åçš„ç”¨æˆ·ä¿¡æ¯ï¼Œç¡®è®¤æ€§åˆ«å­—æ®µå­˜åœ¨:",{user:this.user,gender:this.user.gender}),e}if(t)return a("warn","at store/user.js:140","APIè¿”å›ä¸ºç©ºï¼Œä½¿ç”¨æœ¬åœ°ç”¨æˆ·ä¿¡æ¯:",t),this.user=t,t;throw new Error("è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¿”å›ä¸ºç©º")}catch(t){return a("error","at store/user.js:148","è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",t),this.error="è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥",null}finally{this.loading=!1}}))},updateUserInfo(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null;const o=__spreadProps(__spreadValues({},e),{phone:void 0!==e.phone?e.phone:"",gender:e.gender||"unknown"});a("log","at store/user.js:170","å‘é€åˆ°æœåŠ¡å™¨çš„å®Œæ•´ç”¨æˆ·æ•°æ®ï¼Œç‰¹åˆ«å…³æ³¨æ€§åˆ«å­—æ®µ:",o);let s=null;try{a("log","at store/user.js:176","ä½¿ç”¨ç‰¹æ®ŠAPIæ›´æ–°ç”¨æˆ·å‰çš„æ•°æ®æ£€æŸ¥:",{gender:o.gender,phone:o.phone}),s=yield A.user.updateFullProfile(o),a("log","at store/user.js:182","ä½¿ç”¨ç‰¹æ®ŠAPIæ›´æ–°ç”¨æˆ·æˆåŠŸ:",s),s&&!s.gender&&o.gender&&(a("warn","at store/user.js:186","å“åº”ä¸­ç¼ºå°‘genderå­—æ®µï¼Œæ‰‹åŠ¨æ·»åŠ "),s.gender=o.gender)}catch(t){a("warn","at store/user.js:190","ç‰¹æ®ŠAPIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æ ‡å‡†API:",t),s=yield A.user.updateProfile(o),a("log","at store/user.js:193","ä½¿ç”¨æ ‡å‡†APIæ›´æ–°ç”¨æˆ·æˆåŠŸ:",s),s&&!s.gender&&o.gender&&(a("warn","at store/user.js:197","å“åº”ä¸­ç¼ºå°‘genderå­—æ®µï¼Œæ‰‹åŠ¨æ·»åŠ "),s.gender=o.gender)}if(s){const e=__spreadValues({},this.user);return Object.keys(s).forEach((t=>{e[t]=s[t]})),!e.gender&&o.gender&&(e.gender=o.gender),!e.phone&&o.phone&&(e.phone=o.phone),this.user=e,uni.setStorageSync("userInfo",JSON.stringify(e)),a("log","at store/user.js:227","æœ€ç»ˆæ›´æ–°åçš„ç”¨æˆ·æ•°æ®ï¼Œç¡®è®¤æ€§åˆ«å­—æ®µå­˜åœ¨:",{user:this.user,gender:this.user.gender}),e}return s}catch(o){return a("error","at store/user.js:237","æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",o),this.error="æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥",null}finally{this.loading=!1}}))},uploadAvatar(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null,a("log","at store/user.js:251","å¼€å§‹ä¸Šä¼ å¤´åƒ:",e);const t=yield A.user.uploadAvatar(e);return a("log","at store/user.js:256","å¤´åƒä¸Šä¼ å“åº”:",t),t&&t.data&&t.data.avatar?this.user&&(this.user.avatar=t.data.avatar,uni.setStorageSync("userInfo",JSON.stringify(this.user)),a("log","at store/user.js:264","ç”¨æˆ·å¤´åƒå·²æ›´æ–°:",this.user.avatar)):t&&t.avatar&&this.user&&(this.user.avatar=t.avatar,uni.setStorageSync("userInfo",JSON.stringify(this.user)),a("log","at store/user.js:272","ç”¨æˆ·å¤´åƒå·²æ›´æ–°(ç›´æ¥è¿”å›):",this.user.avatar)),t.data||t}catch(t){return a("error","at store/user.js:279","ä¸Šä¼ å¤´åƒå¤±è´¥:",t),this.error="ä¸Šä¼ å¤´åƒå¤±è´¥",null}finally{this.loading=!1}}))},fetchUserStats(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null;if(!(e||(this.user?this.user._id:null)))return null;const t=e?yield A.user.getUserStats(e):yield A.user.getUserStats();return(!e||this.user&&this.user._id===e)&&(this.stats=t),t}catch(t){return a("error","at store/user.js:309","è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:",t),this.error="è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯å¤±è´¥",null}finally{this.loading=!1}}))},followUser(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null;const t=yield A.user.followUser(e);return this.stats&&(this.stats.followingCount+=1),t}catch(t){throw a("error","at store/user.js:329","å…³æ³¨ç”¨æˆ·å¤±è´¥:",t),this.error="å…³æ³¨ç”¨æˆ·å¤±è´¥",t}finally{this.loading=!1}}))},unfollowUser(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null;const t=yield A.user.unfollowUser(e);return this.stats&&this.stats.followingCount>0&&(this.stats.followingCount-=1),t}catch(t){throw a("error","at store/user.js:349","å–æ¶ˆå…³æ³¨ç”¨æˆ·å¤±è´¥:",t),this.error="å–æ¶ˆå…³æ³¨ç”¨æˆ·å¤±è´¥",t}finally{this.loading=!1}}))},changePassword(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null;return yield A.user.changePassword(e)}catch(t){throw a("error","at store/user.js:365","ä¿®æ”¹å¯†ç å¤±è´¥:",t),this.error="ä¿®æ”¹å¯†ç å¤±è´¥",t}finally{this.loading=!1}}))},logout(){return __async(this,null,(function*(){try{return this.loading=!0,!0}catch(e){throw a("error","at store/user.js:380","é€€å‡ºç™»å½•å¤±è´¥:",e),e}finally{this.user=null,this.token=null,this.stats=null,this.error=null,uni.removeStorageSync("token"),uni.removeStorageSync("userInfo");Oe().clearPets(),this.loading=!1}}))},init(){return __async(this,null,(function*(){try{if(this.token){const o=uni.getStorageSync("userInfo");if(o)try{const e=JSON.parse(o);e&&e._id&&(this.user=e,a("log","at store/user.js:414","å·²ä»æœ¬åœ°å­˜å‚¨åŠ è½½ç”¨æˆ·ä¿¡æ¯:",this.user))}catch(e){a("error","at store/user.js:417","è§£æå­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",e)}yield this.fetchUserInfo();if(this.user){try{yield this.fetchUserStats()}catch(t){a("warn","at store/user.js:429","è·å–ç”¨æˆ·ç»Ÿè®¡æ•°æ®å¤±è´¥ï¼Œç»§ç»­åˆå§‹åŒ–æµç¨‹:",t)}try{const e=Oe();yield e.fetchPets()}catch(t){a("warn","at store/user.js:437","è·å–å® ç‰©åˆ—è¡¨å¤±è´¥ï¼Œç»§ç»­åˆå§‹åŒ–æµç¨‹:",t)}}}}catch(t){a("error","at store/user.js:442","ç”¨æˆ·åˆå§‹åŒ–å¤±è´¥:",t),this.token=null,uni.removeStorageSync("token")}}))},updateLocation(e){return __async(this,null,(function*(){try{return this.currentLocation=e,this.token&&(yield A.location.updateLocation({latitude:e.latitude,longitude:e.longitude,timestamp:(new Date).toISOString()})),e}catch(t){return a("error","at store/user.js:463","æ›´æ–°ä½ç½®å¤±è´¥:",t),null}}))}}}),We="/static/images/app-logo.png",ze=(e,t)=>{const a=e.__vccOpts||e;for(const[o,s]of t)a[o]=s;return a};const Je=ze({__name:"login",setup(t,{expose:o}){o();const s=e.ref({username:"",password:""}),r=e.ref(!1),n=e.computed((()=>s.value.username.trim()&&s.value.password.trim()));function i(e){const t=["nickname","email"];if(!e)return a("log","at pages/login/login.vue:217","ç”¨æˆ·ä¿¡æ¯ä¸å­˜åœ¨"),!1;for(const o of t)if(!e[o]||"string"==typeof e[o]&&""===e[o].trim())return a("log","at pages/login/login.vue:224",`ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´: ç¼ºå°‘ ${o} æˆ–ä¸ºç©ºå€¼`),!1;return e.avatar&&"/static/images/default-avatar.png"!==e.avatar&&"static/images/default-avatar.png"!==e.avatar?(a("log","at pages/login/login.vue:237","ç”¨æˆ·ä¿¡æ¯å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡:",e),!0):(a("log","at pages/login/login.vue:233","ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´: æœªä¸Šä¼ å¤´åƒ"),!1)}const l={form:s,isLoading:r,isValid:n,handleLogin:function(){return __async(this,null,(function*(){if(n.value){r.value=!0,u("ç™»å½•ä¸­...");try{const o=Re(),r=yield A.auth.login({username:s.value.username,password:s.value.password});a("log","at pages/login/login.vue:68","ç™»å½•å“åº”:",r);let n=r;if(r&&r.data&&(n=r.data),!n||!n.token&&!n.accessToken)throw a("error","at pages/login/login.vue:80","æ— æ•ˆçš„å“åº”æ•°æ®:",n),new Error("ç™»å½•å¤±è´¥ï¼šæœåŠ¡å™¨å“åº”æ ¼å¼ä¸æ­£ç¡®");const l=n.token||n.accessToken;uni.setStorageSync("token",l),o.token=l;let u=n.user;n.user?(o.user=n.user,uni.setStorageSync("userInfo",JSON.stringify(n.user))):n._id||n.id?(u={username:s.value.username,nickname:n.nickname||s.value.username,_id:n._id||n.id||Date.now().toString(),avatar:n.avatar||"/static/images/default-avatar.png"},o.user=u,uni.setStorageSync("userInfo",JSON.stringify(u))):(u=__spreadValues({username:s.value.username},n),o.user=u,uni.setStorageSync("userInfo",JSON.stringify(u)));try{a("log","at pages/login/login.vue:116","ç™»å½•æˆåŠŸåè·å–å®Œæ•´ç”¨æˆ·ä¿¡æ¯");const e=yield o.fetchUserInfo();e&&(u=e,uni.setStorageSync("userInfo",JSON.stringify(e)),a("log","at pages/login/login.vue:123","å·²è·å–å¹¶ä¿å­˜æœ€æ–°ç”¨æˆ·ä¿¡æ¯:",e))}catch(e){a("error","at pages/login/login.vue:126","è·å–å®Œæ•´ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",e)}a("log","at pages/login/login.vue:131","æ£€æŸ¥ç”¨æˆ·èµ„æ–™å®Œæ•´æ€§:",u);const d=i(u);if(a("log","at pages/login/login.vue:133","ç”¨æˆ·èµ„æ–™æ˜¯å¦å®Œæ•´:",d),d){c({title:"ç™»å½•æˆåŠŸ",icon:"success"});try{uni.setStorageSync("hasCompletedFirstLogin","true")}catch(t){a("error","at pages/login/login.vue:159","ä¿å­˜ç™»å½•çŠ¶æ€å¤±è´¥:",t)}setTimeout((()=>{uni.switchTab({url:"/pages/index/index"})}),1500)}else c({title:"è¯·å®Œå–„ä¸ªäººèµ„æ–™",icon:"none",duration:2e3}),setTimeout((()=>{uni.redirectTo({url:"/pages/profile/profile?firstLogin=true"})}),1e3)}catch(o){a("error","at pages/login/login.vue:170","ç™»å½•å¤±è´¥:",o),"LOGIN_FAILED"===o.type?(c({title:"è´¦å·æœªæ³¨å†Œï¼Œè¯·å…ˆæ³¨å†Œ",icon:"none",duration:2e3}),setTimeout((()=>{try{p("/pages/login/register")}catch(e){a("error","at pages/login/login.vue:185","è·³è½¬åˆ°æ³¨å†Œé¡µé¢å¤±è´¥:",e)}}),1500)):401===o.statusCode?c({title:"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯",icon:"none"}):c({title:o.message||"ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åå†è¯•",icon:"none"})}finally{r.value=!1,d()}}}))},checkProfileCompleteness:i,goToRegister:function(){try{p("/pages/login/register")}catch(e){a("error","at pages/login/login.vue:248","è·³è½¬åˆ°æ³¨å†Œé¡µé¢å¤±è´¥:",e),c("æ³¨å†ŒåŠŸèƒ½å³å°†æ¨å‡º!")}},ref:e.ref,computed:e.computed,get showToast(){return c},get showLoading(){return u},get hideLoading(){return d},get navigateTo(){return p},get api(){return A},get useUserStore(){return Re}};return Object.defineProperty(l,"__isScriptSetup",{enumerable:!1,value:!0}),l}},[["render",function(t,a,o,s,r,n){return e.openBlock(),e.createElementBlock("view",{class:"login-container"},[e.createElementVNode("view",{class:"logo-container"},[e.createElementVNode("image",{class:"logo",src:We,mode:"aspectFit"}),e.createElementVNode("text",{class:"app-name"},"é›å® æ´¾")]),e.createElementVNode("view",{class:"form-container"},[e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("text",{class:"label"},"ç”¨æˆ·å"),e.withDirectives(e.createElementVNode("input",{class:"input",type:"text","onUpdate:modelValue":a[0]||(a[0]=e=>s.form.username=e),placeholder:"è¯·è¾“å…¥ç”¨æˆ·å"},null,512),[[e.vModelText,s.form.username]])]),e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("text",{class:"label"},"å¯†ç "),e.withDirectives(e.createElementVNode("input",{class:"input",type:"password","onUpdate:modelValue":a[1]||(a[1]=e=>s.form.password=e),placeholder:"è¯·è¾“å…¥å¯†ç "},null,512),[[e.vModelText,s.form.password]])]),e.createElementVNode("button",{class:e.normalizeClass(["login-btn",{loading:s.isLoading}]),disabled:!s.isValid||s.isLoading,onClick:s.handleLogin},e.toDisplayString(s.isLoading?"ç™»å½•ä¸­...":"ç™» å½•"),11,["disabled"]),e.createElementVNode("view",{class:"footer"},[e.createElementVNode("text",{class:"register-link",onClick:s.goToRegister},"æ²¡æœ‰è´¦å·ï¼Ÿå»æ³¨å†Œ")])])])}],["__file","D:/caloriesH5/CloudStorage/pages/login/login.vue"]]);const He=ze({__name:"register",setup(t,{expose:o}){o();const s=e.ref({username:"",password:"",confirmPassword:"",email:"",nickname:""}),r=e.ref(!1),n=e.computed((()=>{const{username:e,password:t,confirmPassword:a,email:o}=s.value;return e.trim()&&t.trim()&&t.length>=6&&a.trim()&&o.trim()&&t===a})),i=e=>/\S+@\S+\.\S+/.test(e);const l={form:s,isLoading:r,isValid:n,isValidEmail:i,isValidPassword:e=>e&&e.length>=6,handleRegister:function(){return __async(this,null,(function*(){var e,t,o;if(s.value.password.length<6)c({title:"å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä¸ªå­—ç¬¦",icon:"none"});else if(s.value.password===s.value.confirmPassword)if(i(s.value.email)){r.value=!0,u("æ³¨å†Œä¸­...");try{const e=yield uni.$api.auth.register({username:s.value.username,password:s.value.password,email:s.value.email,nickname:s.value.nickname||s.value.username});a("log","at pages/login/register.vue:126","æ³¨å†Œå“åº”:",e);let t=e;if(e&&e.data&&(t=e.data),!t||!t.token&&!t.accessToken)throw a("error","at pages/login/register.vue:136","æ— æ•ˆçš„å“åº”æ•°æ®:",t),new Error("æ³¨å†Œå¤±è´¥ï¼šæœåŠ¡å™¨å“åº”æ ¼å¼ä¸æ­£ç¡®");const o=t.token||t.accessToken;if(uni.setStorageSync("token",o),t.user)uni.setStorageSync("userInfo",JSON.stringify(t.user));else{const e={username:s.value.username,nickname:s.value.nickname||s.value.username,_id:t._id||t.id||Date.now().toString(),avatar:"/static/images/default-avatar.png"};uni.setStorageSync("userInfo",JSON.stringify(e))}c({title:"æ³¨å†ŒæˆåŠŸï¼Œè¯·å®Œå–„ä¿¡æ¯",icon:"success"}),setTimeout((()=>{uni.redirectTo({url:"/pages/profile/profile?firstLogin=true"})}),1500)}catch(n){a("error","at pages/login/register.vue:169","æ³¨å†Œå¤±è´¥:",n),500===n.statusCode?(a("error","at pages/login/register.vue:173","æœåŠ¡å™¨å“åº”è¯¦æƒ…:",n.data),(null==(e=n.data)?void 0:e.error)&&n.data.error.includes("password")&&n.data.error.includes("shorter than the minimum")?c({title:"å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä¸ªå­—ç¬¦",icon:"none",duration:3e3}):(null==(t=n.data)?void 0:t.error)&&n.data.error.includes("email")&&n.data.error.includes("invalid")?c({title:"è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€",icon:"none",duration:3e3}):(null==(o=n.data)?void 0:o.error)&&n.data.error.includes("required")?c({title:"è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ",icon:"none",duration:3e3}):c({title:"æ³¨å†Œå¤±è´¥ï¼š"+(n.message||"ç³»ç»Ÿé”™è¯¯"),icon:"none",duration:3e3})):n.message&&n.message.includes("already exists")?c({title:"ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·æ›´æ¢ç”¨æˆ·å",icon:"none"}):c({title:n.message||"æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åå†è¯•",icon:"none"})}finally{r.value=!1,d()}}else c({title:"è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€",icon:"none"});else c({title:"ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´",icon:"none"})}))},goToLogin:function(){try{p("/pages/login/login")}catch(e){a("error","at pages/login/register.vue:231","è·³è½¬åˆ°ç™»å½•é¡µé¢å¤±è´¥:",e),uni.navigateBack()}},ref:e.ref,computed:e.computed,get showToast(){return c},get showLoading(){return u},get hideLoading(){return d},get navigateTo(){return p}};return Object.defineProperty(l,"__isScriptSetup",{enumerable:!1,value:!0}),l}},[["render",function(t,a,o,s,r,n){return e.openBlock(),e.createElementBlock("view",{class:"register-container"},[e.createElementVNode("view",{class:"logo-container"},[e.createElementVNode("image",{class:"logo",src:We,mode:"aspectFit"}),e.createElementVNode("text",{class:"app-name"},"DogRun")]),e.createElementVNode("view",{class:"form-container"},[e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("text",{class:"label"},"ç”¨æˆ·å"),e.withDirectives(e.createElementVNode("input",{class:"input",type:"text","onUpdate:modelValue":a[0]||(a[0]=e=>s.form.username=e),placeholder:"è¯·è¾“å…¥ç”¨æˆ·å"},null,512),[[e.vModelText,s.form.username]])]),e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("text",{class:"label"},"é‚®ç®±"),e.withDirectives(e.createElementVNode("input",{class:"input",type:"text","onUpdate:modelValue":a[1]||(a[1]=e=>s.form.email=e),placeholder:"è¯·è¾“å…¥é‚®ç®±"},null,512),[[e.vModelText,s.form.email]])]),e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("text",{class:"label"},"å¯†ç "),e.withDirectives(e.createElementVNode("input",{class:"input",type:"password","onUpdate:modelValue":a[2]||(a[2]=e=>s.form.password=e),placeholder:"è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä¸ªå­—ç¬¦ï¼‰"},null,512),[[e.vModelText,s.form.password]]),s.form.password&&s.form.password.length<6?(e.openBlock(),e.createElementBlock("text",{key:0,class:"input-tip"},"å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä¸ªå­—ç¬¦")):e.createCommentVNode("v-if",!0)]),e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("text",{class:"label"},"ç¡®è®¤å¯†ç "),e.withDirectives(e.createElementVNode("input",{class:"input",type:"password","onUpdate:modelValue":a[3]||(a[3]=e=>s.form.confirmPassword=e),placeholder:"è¯·å†æ¬¡è¾“å…¥å¯†ç "},null,512),[[e.vModelText,s.form.confirmPassword]]),s.form.password!==s.form.confirmPassword&&s.form.confirmPassword?(e.openBlock(),e.createElementBlock("text",{key:0,class:"input-tip"},"ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´")):e.createCommentVNode("v-if",!0)]),e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("text",{class:"label"},"æ˜µç§°"),e.withDirectives(e.createElementVNode("input",{class:"input",type:"text","onUpdate:modelValue":a[4]||(a[4]=e=>s.form.nickname=e),placeholder:"è¯·è¾“å…¥æ˜µç§°ï¼ˆé€‰å¡«ï¼‰"},null,512),[[e.vModelText,s.form.nickname]])]),e.createElementVNode("button",{class:e.normalizeClass(["register-btn",{loading:s.isLoading}]),disabled:!s.isValid||s.isLoading,onClick:s.handleRegister},e.toDisplayString(s.isLoading?"æ³¨å†Œä¸­...":"æ³¨ å†Œ"),11,["disabled"]),e.createElementVNode("view",{class:"footer"},[e.createElementVNode("text",{class:"login-link",onClick:s.goToLogin},"å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•")])])])}],["__file","D:/caloriesH5/CloudStorage/pages/login/register.vue"]]),qe=$e("location",{state:()=>({currentLocation:null,nearbyUsers:[],loading:!1,error:null,sharingEnabled:!0,locationUpdateInterval:null}),getters:{hasLocation:e=>!!e.currentLocation,getNearbyUsersList:e=>e.nearbyUsers},actions:{updateLocation(e){return __async(this,null,(function*(){try{return this.loading=!0,this.currentLocation=e,this.sharingEnabled&&(yield A.location.updateLocation({latitude:e.latitude,longitude:e.longitude,timestamp:(new Date).toISOString()})),e}catch(t){throw a("error","at store/location.js:37","æ›´æ–°ä½ç½®å¤±è´¥:",t),this.error="æ›´æ–°ä½ç½®å¤±è´¥",t}finally{this.loading=!1}}))},getNearbyUsers(){return __async(this,arguments,(function*(e={}){try{if(this.loading=!0,!this.currentLocation)return{success:!1,message:"æ²¡æœ‰ä½ç½®ä¿¡æ¯"};const t=__spreadValues({latitude:this.currentLocation.latitude,longitude:this.currentLocation.longitude,maxDistance:e.maxDistance||5e3},e),o=__spreadProps(__spreadValues({},t),{latitude:e.latitude||t.latitude,longitude:e.longitude||t.longitude});a("log","at store/location.js:71","è·å–é™„è¿‘ç”¨æˆ·ï¼Œä½¿ç”¨å‚æ•°:",o);const s=yield A.location.getNearbyUsers(o);return s&&s.success?(this.nearbyUsers=s.data||[],s):{success:!1,data:[],message:"è·å–é™„è¿‘ç”¨æˆ·å¤±è´¥"}}catch(t){return a("error","at store/location.js:82","è·å–é™„è¿‘ç”¨æˆ·å¤±è´¥:",t),this.error="è·å–é™„è¿‘ç”¨æˆ·å¤±è´¥",{success:!1,data:[],message:t.message}}finally{this.loading=!1}}))},toggleLocationSharing(e){return __async(this,null,(function*(){try{this.loading=!0,this.sharingEnabled=e;try{yield A.location.toggleLocationSharing({enabled:this.sharingEnabled})}catch(t){a("warn","at store/location.js:102","æ›´æ–°æœåŠ¡å™¨ä½ç½®å…±äº«çŠ¶æ€å¤±è´¥ï¼Œä»…åœ¨æœ¬åœ°æ›´æ–°:",t)}return this.sharingEnabled}catch(o){return a("error","at store/location.js:108","åˆ‡æ¢ä½ç½®å…±äº«çŠ¶æ€å¤±è´¥:",o),this.error="åˆ‡æ¢ä½ç½®å…±äº«çŠ¶æ€å¤±è´¥",null}finally{this.loading=!1}}))},getLocationSharingStatus(){return __async(this,null,(function*(){try{this.loading=!0;const e=yield A.location.getLocationSharingStatus();return this.sharingEnabled=e.data.enabled,this.sharingEnabled}catch(e){return a("error","at store/location.js:126","è·å–ä½ç½®å…±äº«çŠ¶æ€å¤±è´¥:",e),this.error="è·å–ä½ç½®å…±äº«çŠ¶æ€å¤±è´¥",null}finally{this.loading=!1}}))},startLocationUpdates(e=1e4){this.locationUpdateInterval&&clearInterval(this.locationUpdateInterval),this.getUserLocation(),this.locationUpdateInterval=setInterval((()=>{this.getUserLocation()}),e)},stopLocationUpdates(){this.locationUpdateInterval&&(clearInterval(this.locationUpdateInterval),this.locationUpdateInterval=null)},getUserLocation(){return new Promise(((e,t)=>{uni.getLocation({type:"gcj02",success:t=>{const a={latitude:t.latitude,longitude:t.longitude,accuracy:t.accuracy,altitude:t.altitude,timestamp:(new Date).toISOString()};this.updateLocation(a),e(a)},fail:e=>{a("error","at store/location.js:176","è·å–ä½ç½®å¤±è´¥:",e),this.error="è·å–ä½ç½®å¤±è´¥",t(e)}})}))},clearLocationData(){this.stopLocationUpdates(),this.currentLocation=null,this.nearbyUsers=[],this.error=null},getUserPets(e){return __async(this,null,(function*(){try{this.loading=!0;const t=yield uni.request({url:`${uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000"}/api/pets/user/${e}`,method:"GET",header:{Authorization:`Bearer ${uni.getStorageSync("token")}`}});return 200===t.statusCode&&t.data?t.data:(a("error","at store/location.js:209","è·å–ç”¨æˆ·å® ç‰©å¤±è´¥:",t),[])}catch(t){return a("error","at store/location.js:213","è·å–ç”¨æˆ·å® ç‰©å‡ºé”™:",t),[]}finally{this.loading=!1}}))},checkFollowStatus(e){return __async(this,null,(function*(){try{this.loading=!0;const t=yield uni.request({url:`${uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000"}/api/users/follow/check/${e}`,method:"GET",header:{Authorization:`Bearer ${uni.getStorageSync("token")}`}});return 200===t.statusCode&&t.data?t.data:(a("error","at store/location.js:237","æ£€æŸ¥å…³æ³¨çŠ¶æ€å¤±è´¥:",t),{following:!1})}catch(t){return a("error","at store/location.js:241","æ£€æŸ¥å…³æ³¨çŠ¶æ€å‡ºé”™:",t),{following:!1}}finally{this.loading=!1}}))}}}),Ge=$e("marker",{state:()=>({markers:[],userMarkers:[],loading:!1,error:null,currentMarker:null,selectedMarker:null,markerCache:{data:[],timestamp:null,location:null},pagination:{page:1,limit:20,total:0,pages:0}}),getters:{allMarkers:e=>e.markers,isLoading:e=>e.loading,getError:e=>e.error},actions:{fetchNearbyMarkers(e){return __async(this,arguments,(function*({longitude:e,latitude:t,radius:o=5e3}){var s,r;try{this.loading=!0,a("log","at stores/markerStore.js:37","æ­£åœ¨è·å–é™„è¿‘æ ‡è®°...");if(this.checkCacheValidity({longitude:e,latitude:t})){a("log","at stores/markerStore.js:44","ä½¿ç”¨ç¼“å­˜çš„æ ‡è®°æ•°æ®");const s=this.filterMarkersByDistance(this.markerCache.data,{latitude:t,longitude:e,radius:o});return this.markers=s,this.loading=!1,s}let s=2,r=null,i=0;for(;s>=0;)try{let s="/api/markers",r={};switch(i){case 0:r={longitude:e,latitude:t,radius:o},a("log","at stores/markerStore.js:75","å°è¯•æ ‡å‡†åœ°ç†ç©ºé—´æŸ¥è¯¢");break;case 1:r={longitude:e,latitude:t,radius:o,queryMode:"geoWithin"},a("log","at stores/markerStore.js:85","å°è¯•ä½¿ç”¨geoWithinæŸ¥è¯¢æ¨¡å¼");break;case 2:const n=o/111e3,i=o/(111e3*Math.cos(t*Math.PI/180));r={minLat:t-n,maxLat:t+n,minLng:e-i,maxLng:e+i,useRectQuery:!0},a("log","at stores/markerStore.js:100","å°è¯•ä½¿ç”¨çŸ©å½¢åŒºåŸŸæŸ¥è¯¢");break;case 3:s="/api/markers/all",a("log","at stores/markerStore.js:106","å°è¯•è·å–æ‰€æœ‰æ ‡è®°");break;case 4:a("log","at stores/markerStore.js:111","å°è¯•æ— å‚æ•°è¯·æ±‚è·å–æ ‡è®°");break;case 5:return s="/api/markers/search",yield this.fetchMarkersByPost({longitude:e,latitude:t,radius:o})}const n=yield S({url:s,method:"GET",params:r,timeout:1e4});a("log","at stores/markerStore.js:129","è·å–æ ‡è®°å“åº”:",n);let l=[],c=this.pagination;return n.data?(l=n.data.data||n.data,c=n.data.pagination||this.pagination):l=n||[],i>=3&&l.length>0&&(a("log","at stores/markerStore.js:143","åœ¨å‰ç«¯ç­›é€‰é™„è¿‘æ ‡è®°"),l=this.filterMarkersByDistance(l,{latitude:t,longitude:e,radius:o})),this.updateMarkerCache(l,{longitude:e,latitude:t}),this.markers=l,this.pagination=c,this.loading=!1,a("log","at stores/markerStore.js:158",`æˆåŠŸä½¿ç”¨ç­–ç•¥${i}è·å–åˆ°${l.length}ä¸ªæ ‡è®°`),l}catch(n){r=n,a("warn","at stores/markerStore.js:162",`è·å–æ ‡è®°å¤±è´¥ï¼Œä½¿ç”¨ç­–ç•¥${i}å¤±è´¥ï¼Œå‰©ä½™é‡è¯•æ¬¡æ•°: ${s}`,n),i++,i>5&&(i=0,s--),s>=0&&(yield new Promise((e=>setTimeout(e,1e3))))}if(this.markerCache.data&&this.markerCache.data.length>0){a("log","at stores/markerStore.js:182","æ‰€æœ‰APIç­–ç•¥å¤±è´¥ï¼Œä½¿ç”¨è¿‡æœŸç¼“å­˜æ•°æ®");const s=this.filterMarkersByDistance(this.markerCache.data,{latitude:t,longitude:e,radius:2*o});if(s.length>0)return this.markers=s,this.loading=!1,uni.showToast({title:"ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œå¯èƒ½ä¸æ˜¯æœ€æ–°",icon:"none",duration:2e3}),s}throw r}catch(n){return a("error","at stores/markerStore.js:208","è·å–é™„è¿‘æ ‡è®°å¤±è´¥:",n),this.error=(null==(r=null==(s=n.response)?void 0:s.data)?void 0:r.message)||"è·å–æ ‡è®°å¤±è´¥",this.loading=!1,this.markers=[],uni.showToast({title:"æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•",icon:"none",duration:3e3}),[]}}))},fetchUserMarkers(e){return __async(this,null,(function*(){var t,o;try{this.loading=!0;const t=yield S({url:`/api/markers/user/${e}`,method:"GET"});let a=[];return a=t.data?t.data.data||t.data:t||[],this.userMarkers=a,this.loading=!1,a}catch(s){return a("error","at stores/markerStore.js:246","è·å–ç”¨æˆ·æ ‡è®°å¤±è´¥:",s),this.error=(null==(o=null==(t=s.response)?void 0:t.data)?void 0:o.message)||"è·å–ç”¨æˆ·æ ‡è®°å¤±è´¥",this.loading=!1,uni.showToast({title:"è·å–ç”¨æˆ·æ ‡è®°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ",icon:"none",duration:2e3}),[]}}))},createMarker(e){return __async(this,null,(function*(){var t,o;try{this.loading=!0,a("log","at stores/markerStore.js:263","æ­£åœ¨åˆ›å»ºæ–°æ ‡è®°ï¼Œæ•°æ®:",e);let t=__spreadValues({},e);if(e.images&&e.images.length>0&&(a("log","at stores/markerStore.js:270","æ ‡è®°åŒ…å«å›¾ç‰‡æ•°æ®:",e.images.length,"å¼ å›¾ç‰‡"),t.images=e.images.map((e=>({url:e.url,caption:e.caption||""})))),!t.latitude||!t.longitude)throw a("error","at stores/markerStore.js:279","æ ‡è®°ç¼ºå°‘ä½ç½®ä¿¡æ¯"),new Error("æ ‡è®°ä½ç½®ä¿¡æ¯ä¸å®Œæ•´");const o=yield S({url:"/api/markers",method:"POST",data:t});a("log","at stores/markerStore.js:290","æ–°æ ‡è®°åˆ›å»ºå“åº”:",o);let s=o.data||o;if(s&&(s.data||s._id)){const e=s.data||s;e&&!e._id&&(e._id="marker_"+Date.now()),e&&!e.createdAt&&(e.createdAt=new Date),!e||e.latitude&&e.longitude||(e.latitude=t.latitude,e.longitude=t.longitude),this.markers&&Array.isArray(this.markers)?this.markers.unshift(e):this.markers=[e],this.userMarkers&&Array.isArray(this.userMarkers)&&this.userMarkers.unshift(e),this.updateMarkerCache(this.markers,{latitude:e.latitude,longitude:e.longitude}),this.notifyMarkersUpdated(),this.setCurrentMarker(e)}return this.loading=!1,s}catch(s){throw a("error","at stores/markerStore.js:341","åˆ›å»ºæ ‡è®°å¤±è´¥:",s),this.error=(null==(o=null==(t=s.response)?void 0:t.data)?void 0:o.message)||s.message||"åˆ›å»ºæ ‡è®°å¤±è´¥",this.loading=!1,s}}))},updateMarker(e){return __async(this,arguments,(function*({id:e,data:t}){var o,s,r,n;try{this.loading=!0;const a=yield S({url:`/api/markers/${e}`,method:"PUT",data:t});let o={};o=a.data?a.data.data||a.data:a||{};const s=this.markers.findIndex((e=>e._id===o._id));-1!==s&&(this.markers[s]=o);const r=this.userMarkers.findIndex((e=>e._id===o._id));return-1!==r&&(this.userMarkers[r]=o),this.selectedMarker&&this.selectedMarker._id===o._id&&(this.selectedMarker=o),this.currentMarker&&this.currentMarker._id===o._id&&(this.currentMarker=o),this.clearAllMarkerCache(),this.notifyMarkersUpdated(),this.loading=!1,uni.showToast({title:"æ ‡è®°æ›´æ–°æˆåŠŸ",icon:"success"}),o}catch(i){return a("error","at stores/markerStore.js:398","æ›´æ–°æ ‡è®°å¤±è´¥:",i),this.error=(null==(s=null==(o=i.response)?void 0:o.data)?void 0:s.message)||"æ›´æ–°æ ‡è®°å¤±è´¥",this.loading=!1,uni.showToast({title:(null==(n=null==(r=i.response)?void 0:r.data)?void 0:n.message)||"æ›´æ–°æ ‡è®°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ",icon:"none"}),null}}))},deleteMarker(e){return __async(this,null,(function*(){var t,o,s,r;try{this.loading=!0,a("log","at stores/markerStore.js:415","æ­£åœ¨åˆ é™¤æ ‡è®°:",e);let t=2,o=null;for(;t>=0;)try{return a("log","at stores/markerStore.js:429","åˆ é™¤æ ‡è®°å“åº”:",yield S({url:`/api/markers/${e}`,method:"DELETE",timeout:15e3})),this.markers=this.markers.filter((t=>t._id!==e)),this.userMarkers=this.userMarkers.filter((t=>t._id!==e)),this.selectedMarker&&this.selectedMarker._id===e&&(this.selectedMarker=null),this.currentMarker&&this.currentMarker._id===e&&(this.currentMarker=null),this.clearAllMarkerCache(),this.loading=!1,this.notifyMarkersUpdated(),uni.showToast({title:"æ ‡è®°å·²åˆ é™¤",icon:"success"}),!0}catch(n){o=n,a("warn","at stores/markerStore.js:459",`åˆ é™¤æ ‡è®°å¤±è´¥ï¼Œå‰©ä½™é‡è¯•æ¬¡æ•°: ${t}`,n),t--,t>=0&&(yield new Promise((e=>setTimeout(e,1e3))))}throw o}catch(n){return a("error","at stores/markerStore.js:472","åˆ é™¤æ ‡è®°å¤±è´¥:",n),this.error=(null==(o=null==(t=n.response)?void 0:t.data)?void 0:o.message)||"åˆ é™¤æ ‡è®°å¤±è´¥",this.loading=!1,uni.showToast({title:(null==(r=null==(s=n.response)?void 0:s.data)?void 0:r.message)||"åˆ é™¤æ ‡è®°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ",icon:"none"}),!1}}))},fetchMarkerById(e){return __async(this,null,(function*(){var t,o;try{this.loading=!0;const t=yield S({url:`/api/markers/${e}`,method:"GET"});let a={};return a=t.data?t.data.data||t.data:t||{},this.selectedMarker=a,this.loading=!1,a}catch(s){return a("error","at stores/markerStore.js:506","è·å–æ ‡è®°è¯¦æƒ…å¤±è´¥:",s),this.error=(null==(o=null==(t=s.response)?void 0:t.data)?void 0:o.message)||"è·å–æ ‡è®°è¯¦æƒ…å¤±è´¥",this.loading=!1,null}}))},likeMarker(e){return __async(this,null,(function*(){var t,o;try{const t=yield S({url:`/api/markers/${e}/like`,method:"POST"});let a=[];t.data?a=t.data.likes||t.likes||[]:t.likes&&(a=t.likes);const o=this.markers.findIndex((t=>t._id===e));if(-1!==o){const e=__spreadValues({},this.markers[o]);e.likes=a,this.markers[o]=e}const s=this.userMarkers.findIndex((t=>t._id===e));if(-1!==s){const e=__spreadValues({},this.userMarkers[s]);e.likes=a,this.userMarkers[s]=e}return this.selectedMarker&&this.selectedMarker._id===e&&(this.selectedMarker=__spreadProps(__spreadValues({},this.selectedMarker),{likes:a})),t}catch(s){return a("error","at stores/markerStore.js:548","ç‚¹èµæ ‡è®°å¤±è´¥:",s),uni.showToast({title:(null==(o=null==(t=s.response)?void 0:t.data)?void 0:o.message)||"ç‚¹èµå¤±è´¥",icon:"none"}),null}}))},unlikeMarker(e){return __async(this,null,(function*(){var t,o;try{const t=yield S({url:`/api/markers/${e}/unlike`,method:"POST"});let a=[];t.data?a=t.data.likes||t.likes||[]:t.likes&&(a=t.likes);const o=this.markers.findIndex((t=>t._id===e));if(-1!==o){const e=__spreadValues({},this.markers[o]);e.likes=a,this.markers[o]=e}const s=this.userMarkers.findIndex((t=>t._id===e));if(-1!==s){const e=__spreadValues({},this.userMarkers[s]);e.likes=a,this.userMarkers[s]=e}return this.selectedMarker&&this.selectedMarker._id===e&&(this.selectedMarker=__spreadProps(__spreadValues({},this.selectedMarker),{likes:a})),t}catch(s){return a("error","at stores/markerStore.js:592","å–æ¶ˆç‚¹èµæ ‡è®°å¤±è´¥:",s),uni.showToast({title:(null==(o=null==(t=s.response)?void 0:t.data)?void 0:o.message)||"å–æ¶ˆç‚¹èµå¤±è´¥",icon:"none"}),null}}))},setCurrentMarker(e){this.currentMarker=e},setSelectedMarker(e){this.selectedMarker=e},clearError(){this.error=null},filterMarkersByDistance(e,t){if(!e||!e.length)return[];if(!t||void 0===t.latitude)return e;const{latitude:a,longitude:o,radius:s}=t,r=e.filter((e=>{if(!e.latitude||!e.longitude){if(!e.location||!e.location.coordinates)return!1;e.longitude=e.location.coordinates[0],e.latitude=e.location.coordinates[1]}const t=this.calculateDistance(a,o,e.latitude,e.longitude);return e.distance=t,t<=s}));return r.sort(((e,t)=>e.distance-t.distance)),r},calculateDistance(e,t,a,o){const s=this.toRadians(a-e),r=this.toRadians(o-t),n=Math.sin(s/2)*Math.sin(s/2)+Math.cos(this.toRadians(e))*Math.cos(this.toRadians(a))*Math.sin(r/2)*Math.sin(r/2);return 6371e3*(2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)))},toRadians:e=>e*Math.PI/180,fetchMarkersByPost(e){return __async(this,null,(function*(){try{a("log","at stores/markerStore.js:673","ä½¿ç”¨POSTè¯·æ±‚è·å–æ ‡è®°");const t=yield S({url:"/api/markers/search",method:"POST",data:e,timeout:15e3});let o=[];return o=t.data?t.data.data||t.data:t||[],o.length>0&&this.updateMarkerCache(o,{longitude:e.longitude,latitude:e.latitude}),o}catch(t){throw a("error","at stores/markerStore.js:700","POSTè¯·æ±‚è·å–æ ‡è®°å¤±è´¥:",t),t}}))},checkCacheValidity({longitude:e,latitude:t}){if(!this.markerCache.data||0===this.markerCache.data.length)return!1;const a=Date.now()-(this.markerCache.timestamp||0)<18e5;let o=!1;if(this.markerCache.location){o=this.calculateDistance(t,e,this.markerCache.location.latitude,this.markerCache.location.longitude)<2e3}return a&&o},updateMarkerCache(e,t){if(e&&e.length){this.markerCache={data:[...e],timestamp:Date.now(),location:__spreadValues({},t)},a("log","at stores/markerStore.js:741","æ›´æ–°äº†æ ‡è®°ç¼“å­˜ï¼Œå…±",e.length,"ä¸ªæ ‡è®°");try{uni.setStorageSync("markerCache",JSON.stringify(this.markerCache))}catch(o){a("error","at stores/markerStore.js:747","ä¿å­˜æ ‡è®°ç¼“å­˜å¤±è´¥:",o)}}},restoreMarkerCache(){try{const e=uni.getStorageSync("markerCache");e&&(this.markerCache=JSON.parse(e),a("log","at stores/markerStore.js:757","å·²æ¢å¤æ ‡è®°ç¼“å­˜ï¼Œæ—¶é—´:",new Date(this.markerCache.timestamp)))}catch(e){a("error","at stores/markerStore.js:760","æ¢å¤æ ‡è®°ç¼“å­˜å¤±è´¥:",e)}},clearAllMarkerCache(){a("log","at stores/markerStore.js:766","æ¸…é™¤æ‰€æœ‰æ ‡è®°ç¼“å­˜"),this.markerCache={data:[],timestamp:null,location:null};try{uni.removeStorageSync("markerCache")}catch(e){a("error","at stores/markerStore.js:779","æ¸…é™¤æœ¬åœ°å­˜å‚¨ç¼“å­˜å¤±è´¥:",e)}},notifyMarkersUpdated(){uni.$emit("markers-updated",{timestamp:Date.now()}),a("log","at stores/markerStore.js:789","å·²å‘å‡ºæ ‡è®°æ›´æ–°é€šçŸ¥")}}}),Qe=e=>{const t=Math.floor(e/3600),a=Math.floor(e%3600/60),o=e%60;return t>0?`${t}å°æ—¶${a}åˆ†`:a>0?`${a}åˆ†${o}ç§’`:`${o}ç§’`},Ke=(e,t)=>{if(!e||0===e)return"--'--\"/km";const a=t/(e/1e3);return`${Math.floor(a/60)}'${Math.floor(a%60).toString().padStart(2,"0")}"/km`},Ye=(e,t,a,o)=>{const s=Xe(a-e),r=Xe(o-t),n=Math.sin(s/2)*Math.sin(s/2)+Math.cos(Xe(e))*Math.cos(Xe(a))*Math.sin(r/2)*Math.sin(r/2);return 6371e3*(2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)))},Xe=e=>e*(Math.PI/180),Ze=()=>new Promise(((e,t)=>{uni.getLocation({type:"gcj02",success:t=>{e({latitude:t.latitude,longitude:t.longitude})},fail:e=>{a("error","at utils/amap.js:91","è·å–ä½ç½®å¤±è´¥",e),t(e)}})})),et={general:'<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#FF5733">\n    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>\n  </svg>',pet_friendly:'<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#34A853">\n    <path d="M4.5 12.65C5.35 12.45 6 11.7 6 10.8c0-1.1-0.9-2-2-2s-2 0.9-2 2c0 0.9 0.65 1.65 1.5 1.85v1.5c-2.5 0.5-4.5 3-4.5 6h2c0-2.5 2-4.5 4.5-4.5s4.5 2 4.5 4.5h2c0-3-2-5.5-4.5-6v-1.5zm17-1.85v1.5c-2.5 0.5-4.5 3-4.5 6h2c0-2.5 2-4.5 4.5-4.5s4.5 2 4.5 4.5h2c0-3-2-5.5-4.5-6v-1.5c0.85-0.2 1.5-0.95 1.5-1.85 0-1.1-0.9-2-2-2s-2 0.9-2 2c0 0.9 0.65 1.65 1.5 1.85zM12 4c-1.1 0-2 0.9-2 2s0.9 2 2 2 2-0.9 2-2-0.9-2-2-2zm0 16c1.1 0 2-0.9 2-2s-0.9-2-2-2-2 0.9-2 2 0.9 2 2 2z"/>\n  </svg>',danger:'<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#EA4335">\n    <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>\n  </svg>',scenic:'<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#4285F4">\n    <path d="M14 6l-3.75 5 2.85 3.8-1.6 1.2C9.38 13.33 2.39 13 2.39 13S2 13.37 2 14.07v5.93c0 1 2 2 2 2h16c1 0 2-1 2-2v-5.93c0-0.7-0.39-1.07-0.39-1.07s-7.01 0.33-9.16 3l-1.6-1.2 3.38-4.5L18 8 14 6z"/>\n  </svg>',pet_service:'<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#FF7F50">\n    <path d="M19 7h-4V3H9v4H5l7 7 7-7zm-8 12v-4h2v4h-2zm4 0v-4h2v4h-2zm-8 0v-4h2v4H7z"/>\n  </svg>',custom:'<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#9370DB">\n    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/>\n    <path d="M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4V7z"/>\n  </svg>'},tt={};Object.keys(et).forEach((e=>{tt[e]="data:image/svg+xml;base64,"+btoa(et[e])}));const at="#FF5733",ot="#34A853",st="#EA4335",rt="#4285F4",nt="#FF7F50",it="#9370DB";const lt=ze({name:"UserInfoPopup",props:{user:{type:Object,default:()=>({})},pets:{type:Array,default:()=>[]},isFollowing:{type:Boolean,default:!1},visible:{type:Boolean,default:!1}},data:()=>({selectedPet:null,combinedPets:[],userIsFollowed:!1}),computed:{effectivePets(){var e;return a("log","at components/map/UserInfoPopup.vue:190","è®¡ç®—æœ‰æ•ˆå® ç‰©åˆ—è¡¨:",{userPets:(null==(e=this.user)?void 0:e.pets)||[],propsPets:this.pets||[]}),this.user&&this.user.pets&&this.user.pets.length>0?this.user.pets:this.pets||[]},shouldShowNoPets(){const e=this.effectivePets.length>0;return a("log","at components/map/UserInfoPopup.vue:206","æ˜¯å¦åº”è¯¥æ˜¾ç¤ºæ²¡æœ‰å® ç‰©æç¤º:",!e),!e},isCurrentUser(){return this.user&&!0===this.user.isCurrentUser}},watch:{user:{handler(e){a("log","at components/map/UserInfoPopup.vue:218","ç”¨æˆ·æ•°æ®å˜åŒ–:",e),this.updateSelectedPet(),e&&this.syncFollowStatus()},immediate:!0,deep:!0},pets:{handler(e){a("log","at components/map/UserInfoPopup.vue:233","ä¼ å…¥çš„å® ç‰©åˆ—è¡¨å˜åŒ–:",e),this.updateSelectedPet()},immediate:!0},effectivePets:{handler(e){a("log","at components/map/UserInfoPopup.vue:241","æœ‰æ•ˆå® ç‰©åˆ—è¡¨å˜åŒ–:",e),e&&e.length>0&&!this.selectedPet&&(this.selectedPet=e[0])}},visible(e){e&&(a("log","at components/map/UserInfoPopup.vue:250","å¼¹çª—æ˜¾ç¤ºï¼Œæ£€æŸ¥å® ç‰©é€‰æ‹©çŠ¶æ€å’Œå…³æ³¨çŠ¶æ€"),this.updateSelectedPet(),this.syncFollowStatus())},isFollowing:{handler(e){a("log","at components/map/UserInfoPopup.vue:259","propsä¸­çš„å…³æ³¨çŠ¶æ€å˜åŒ–:",e),this.userIsFollowed=e},immediate:!0}},mounted(){a("log","at components/map/UserInfoPopup.vue:267","UserInfoPopup mounted:",{user:this.user,pets:this.pets,visible:this.visible,isFollowing:this.isFollowing}),this.syncFollowStatus()},methods:{syncFollowStatus(){return a("log","at components/map/UserInfoPopup.vue:279","åŒæ­¥å…³æ³¨çŠ¶æ€"),void 0!==this.isFollowing?(a("log","at components/map/UserInfoPopup.vue:284","ä½¿ç”¨propsä¸­ä¼ å…¥çš„å…³æ³¨çŠ¶æ€:",this.isFollowing),void(this.userIsFollowed=this.isFollowing)):this.user&&void 0!==this.user.isFollowing?(a("log","at components/map/UserInfoPopup.vue:291","ä»ç”¨æˆ·å¯¹è±¡ä¸­è·å–å…³æ³¨çŠ¶æ€:",this.user.isFollowing),void(this.userIsFollowed=this.user.isFollowing)):(a("log","at components/map/UserInfoPopup.vue:297","æ²¡æœ‰æ‰¾åˆ°å…³æ³¨çŠ¶æ€ä¿¡æ¯ï¼Œé»˜è®¤ä¸ºæœªå…³æ³¨"),void(this.userIsFollowed=!1))},updateSelectedPet(){const e=this.effectivePets;a("log","at components/map/UserInfoPopup.vue:304","æ›´æ–°é€‰ä¸­å® ç‰©, å® ç‰©åˆ—è¡¨:",e),e&&e.length>0?(this.selectedPet=this.user&&this.user.currentPet||e[0],a("log","at components/map/UserInfoPopup.vue:309","è®¾ç½®é€‰ä¸­å® ç‰©:",this.selectedPet)):(a("log","at components/map/UserInfoPopup.vue:311","æ²¡æœ‰æ‰¾åˆ°å® ç‰©æ•°æ®"),this.selectedPet=null)},handleClose(){this.$emit("close")},handleFollow(){this.userIsFollowed=!this.userIsFollowed,this.$emit("follow",this.user)},handleMessage(){this.$emit("message",this.user)},selectPet(e){this.selectedPet=e},isActivePet(e){return this.selectedPet&&e&&this.selectedPet.name===e.name},formatPetGender(e){if(!e)return"æœªçŸ¥";return{male:"å…¬",female:"æ¯",unknown:"æœªçŸ¥"}[e]||e},formatPetAge(e){if("number"==typeof e)return`${e}å²`;if("string"==typeof e&&(e.includes("å²")||/^\d+$/.test(e)))return/^\d+$/.test(e)?`${e}å²`:e;if(this.selectedPet&&void 0!==this.selectedPet.age){if("number"==typeof this.selectedPet.age)return`${this.selectedPet.age}å²`;if("string"==typeof this.selectedPet.age)return this.selectedPet.age.includes("å²")?this.selectedPet.age:`${this.selectedPet.age}å²`}if(!e)return"æœªçŸ¥å¹´é¾„";try{const t=new Date(e),a=new Date;if(isNaN(t.getTime()))return"æœªçŸ¥å¹´é¾„";const o=12*(a.getFullYear()-t.getFullYear())+(a.getMonth()-t.getMonth());if(o<12)return`${o}ä¸ªæœˆ`;{const e=Math.floor(o/12),t=o%12;return t>0?`${e}å²${t}ä¸ªæœˆ`:`${e}å²`}}catch(t){return a("error","at components/map/UserInfoPopup.vue:405","æ ¼å¼åŒ–å® ç‰©å¹´é¾„å‡ºé”™:",t),"æœªçŸ¥å¹´é¾„"}},navigateToAddPet(){uni.switchTab({url:"/pages/index/index"}),this.handleClose()},handleImageError(e){a("warn","at components/map/UserInfoPopup.vue:420","å›¾ç‰‡åŠ è½½å¤±è´¥:",e.target),e.target.src="/static/images/default-avatar.png"},formatImageUrl(e){if(!e)return"/static/images/default-avatar.png";if(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("/static/"))return e;if(e.startsWith("/uploads")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}if(e.startsWith("uploads/")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+"/"+e}return"/static/images/default-avatar.png"},formatSocialIntention:e=>({strong:"å¼ºçƒˆ",medium:"è¾ƒå¼º",mild:"å¹³æ·¡"}[e]||"æœªçŸ¥"),formatMatingStatus:e=>({single:"å•èº«å¾…æ±‚å¶",paired:"æœ‰é…å¶",notLooking:"æš‚ä¸æ‰¾é…å¶"}[e]||"æœªçŸ¥"),previewPhoto(e){const t=this.formatImageUrl(e);uni.previewImage({urls:[t],current:t})}}},[["render",function(t,a,o,s,r,n){var i,l,c,u,d,m,p,g,v,h,f,y,w,k,E,N,V,S,_,C,b,P,x,I,T;return e.openBlock(),e.createElementBlock("view",{class:e.normalizeClass(["user-info-popup",{active:o.visible}])},[e.createElementVNode("view",{class:"popup-content"},[e.createElementVNode("view",{class:"close-btn",onClick:a[0]||(a[0]=(...e)=>n.handleClose&&n.handleClose(...e))},"Ã—"),e.createCommentVNode(" ç”¨æˆ·ä¿¡æ¯ "),e.createElementVNode("view",{class:"user-info"},[e.createElementVNode("image",{class:"user-avatar",src:n.formatImageUrl(null==(i=o.user)?void 0:i.avatar),mode:"aspectFill",onError:a[1]||(a[1]=(...e)=>n.handleImageError&&n.handleImageError(...e))},null,40,["src"]),e.createElementVNode("view",{class:"user-details"},[e.createElementVNode("text",{class:"username"},e.toDisplayString((null==(l=o.user)?void 0:l.nickname)||(null==(c=o.user)?void 0:c.username)||"ç”¨æˆ·"),1),o.user&&o.user.isWalking?(e.openBlock(),e.createElementBlock("text",{key:0,class:"status"},"æ­£åœ¨é›ç‹—")):(e.openBlock(),e.createElementBlock("text",{key:1,class:"status"},"åœ¨çº¿"))])]),e.createCommentVNode(" å® ç‰©ä¿¡æ¯ - å½“å‰å® ç‰© "),o.user&&o.user.currentPet?(e.openBlock(),e.createElementBlock("view",{key:0,class:"pet-info"},[e.createElementVNode("text",{class:"section-title"},"å½“å‰å® ç‰©"),e.createElementVNode("view",{class:"pet-card"},[e.createElementVNode("image",{class:"pet-avatar",src:n.formatImageUrl(null==(u=o.user.currentPet)?void 0:u.avatar),mode:"aspectFill",onError:a[2]||(a[2]=(...e)=>n.handleImageError&&n.handleImageError(...e))},null,40,["src"]),e.createElementVNode("view",{class:"pet-details"},[e.createElementVNode("text",{class:"pet-name"},e.toDisplayString((null==(d=o.user.currentPet)?void 0:d.name)||"å® ç‰©"),1),e.createElementVNode("text",{class:"pet-breed"},e.toDisplayString((null==(m=o.user.currentPet)?void 0:m.breed)||"æœªçŸ¥å“ç§"),1),e.createElementVNode("text",{class:"pet-age"},e.toDisplayString(n.formatPetAge(null==(p=o.user.currentPet)?void 0:p.birthdate)),1)])])])):e.createCommentVNode("v-if",!0),e.createCommentVNode(" å® ç‰©åˆ—è¡¨ "),n.effectivePets.length>0?(e.openBlock(),e.createElementBlock("view",{key:1,class:"pet-list"},[e.createElementVNode("text",{class:"section-title"},e.toDisplayString(n.isCurrentUser?"æˆ‘çš„å® ç‰©":"æ‰€æœ‰å® ç‰©"),1),e.createCommentVNode(" å® ç‰©å¡ç‰‡åˆ—è¡¨ "),e.createElementVNode("scroll-view",{class:"pet-scroll","scroll-x":""},[e.createElementVNode("view",{class:"pet-cards"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.effectivePets,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:a,class:e.normalizeClass(["pet-card-small",{active:n.isActivePet(t)}]),onClick:e=>n.selectPet(t)},[e.createElementVNode("image",{class:"pet-avatar-small",src:n.formatImageUrl(null==t?void 0:t.avatar),mode:"aspectFill"},null,8,["src"]),e.createElementVNode("text",{class:"pet-name-small"},e.toDisplayString((null==t?void 0:t.name)||"å® ç‰©"),1)],10,["onClick"])))),128))])]),e.createCommentVNode(" é€‰ä¸­å® ç‰©çš„è¯¦ç»†ä¿¡æ¯ "),r.selectedPet?(e.openBlock(),e.createElementBlock("view",{key:0,class:"pet-detail-card"},[e.createElementVNode("view",{class:"pet-detail-header"},[e.createElementVNode("image",{class:"pet-detail-avatar",src:n.formatImageUrl(null==(g=r.selectedPet)?void 0:g.avatar),mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"pet-detail-info"},[e.createElementVNode("text",{class:"pet-detail-name"},e.toDisplayString((null==(v=r.selectedPet)?void 0:v.name)||"å® ç‰©"),1),e.createElementVNode("text",{class:"pet-detail-breed"},e.toDisplayString((null==(h=r.selectedPet)?void 0:h.breed)||"æœªçŸ¥å“ç§"),1)])]),e.createElementVNode("view",{class:"pet-attributes"},[e.createElementVNode("view",{class:"pet-attribute"},[e.createElementVNode("text",{class:"attribute-label"},"å¹´é¾„"),e.createElementVNode("text",{class:"attribute-value"},e.toDisplayString(n.formatPetAge(null==(f=r.selectedPet)?void 0:f.birthdate)||"æœªçŸ¥"),1)]),(null==(y=r.selectedPet)?void 0:y.weight)?(e.openBlock(),e.createElementBlock("view",{key:0,class:"pet-attribute"},[e.createElementVNode("text",{class:"attribute-label"},"ä½“é‡"),e.createElementVNode("text",{class:"attribute-value"},e.toDisplayString(null==(w=r.selectedPet)?void 0:w.weight)+"kg",1)])):e.createCommentVNode("v-if",!0),(null==(k=r.selectedPet)?void 0:k.gender)?(e.openBlock(),e.createElementBlock("view",{key:1,class:"pet-attribute"},[e.createElementVNode("text",{class:"attribute-label"},"æ€§åˆ«"),e.createElementVNode("text",{class:"attribute-value"},e.toDisplayString(n.formatPetGender(null==(E=r.selectedPet)?void 0:E.gender)),1)])):e.createCommentVNode("v-if",!0),(null==(N=r.selectedPet)?void 0:N.socialIntention)?(e.openBlock(),e.createElementBlock("view",{key:2,class:"pet-attribute"},[e.createElementVNode("text",{class:"attribute-label"},"ç¤¾äº¤æ„å‘"),e.createElementVNode("text",{class:"attribute-value"},e.toDisplayString(n.formatSocialIntention(null==(V=r.selectedPet)?void 0:V.socialIntention)),1)])):e.createCommentVNode("v-if",!0),(null==(S=r.selectedPet)?void 0:S.matingStatus)?(e.openBlock(),e.createElementBlock("view",{key:3,class:"pet-attribute"},[e.createElementVNode("text",{class:"attribute-label"},"æ±‚å¶çŠ¶æ€"),e.createElementVNode("text",{class:"attribute-value"},e.toDisplayString(n.formatMatingStatus(null==(_=r.selectedPet)?void 0:_.matingStatus)),1)])):e.createCommentVNode("v-if",!0)]),e.createCommentVNode(" æ—¥å¸¸ç…§ç‰‡å±•ç¤º "),(null==(C=r.selectedPet)?void 0:C.dailyPhotos)&&r.selectedPet.dailyPhotos.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"pet-daily-photos"},[e.createElementVNode("text",{class:"daily-photos-title"},"æ—¥å¸¸ç…§ç‰‡"),e.createElementVNode("scroll-view",{class:"photos-scroll","scroll-x":""},[e.createElementVNode("view",{class:"photos-container"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(r.selectedPet.dailyPhotos,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:a,class:"daily-photo-item",onClick:e=>n.previewPhoto(t.url)},[e.createElementVNode("image",{class:"daily-photo",src:n.formatImageUrl(t.url),mode:"aspectFill"},null,8,["src"])],8,["onClick"])))),128))])])])):e.createCommentVNode("v-if",!0),(null==(b=r.selectedPet)?void 0:b.description)?(e.openBlock(),e.createElementBlock("view",{key:1,class:"pet-description"},[e.createElementVNode("text",{class:"description-title"},"ä¸ªæ€§ä»‹ç»"),e.createElementVNode("text",{class:"description-text"},e.toDisplayString(null==(P=r.selectedPet)?void 0:P.description),1)])):e.createCommentVNode("v-if",!0)])):e.createCommentVNode("v-if",!0)])):n.shouldShowNoPets?(e.openBlock(),e.createElementBlock(e.Fragment,{key:2},[e.createCommentVNode(" æ²¡æœ‰å® ç‰©æ—¶çš„æç¤º "),e.createElementVNode("view",{class:"no-pets-container"},[e.createElementVNode("image",{class:"no-pets-image",src:"/static/images/no-pets.png",mode:"aspectFit"}),e.createElementVNode("text",{class:"no-pets-text"},e.toDisplayString(n.isCurrentUser?"æ‚¨è¿˜æ²¡æœ‰æ·»åŠ å® ç‰©ä¿¡æ¯":"è¯¥ç”¨æˆ·è¿˜æ²¡æœ‰æ·»åŠ å® ç‰©ä¿¡æ¯"),1),n.isCurrentUser?(e.openBlock(),e.createElementBlock("button",{key:0,class:"add-pet-btn",onClick:a[3]||(a[3]=(...e)=>n.navigateToAddPet&&n.navigateToAddPet(...e))}," æ·»åŠ å® ç‰©ä¿¡æ¯ ")):e.createCommentVNode("v-if",!0)])],2112)):e.createCommentVNode("v-if",!0),e.createCommentVNode(" æ­¥è¡Œç»Ÿè®¡ "),o.user&&o.user.isWalking&&o.user.walkStats?(e.openBlock(),e.createElementBlock("view",{key:3,class:"walk-stats"},[e.createElementVNode("text",{class:"section-title"},"é›ç‹—æ•°æ®"),e.createElementVNode("view",{class:"stats-row"},[e.createElementVNode("view",{class:"stat-item"},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString((null==(x=o.user.walkStats)?void 0:x.distance)||0)+"km",1),e.createElementVNode("text",{class:"stat-label"},"è·ç¦»")]),e.createElementVNode("view",{class:"stat-item"},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString((null==(I=o.user.walkStats)?void 0:I.duration)||"00:00"),1),e.createElementVNode("text",{class:"stat-label"},"æ—¶é•¿")]),e.createElementVNode("view",{class:"stat-item"},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString((null==(T=o.user.walkStats)?void 0:T.speed)||0)+"km/h",1),e.createElementVNode("text",{class:"stat-label"},"é…é€Ÿ")])])])):e.createCommentVNode("v-if",!0),e.createCommentVNode(" æ“ä½œæŒ‰é’® "),n.isCurrentUser?e.createCommentVNode("v-if",!0):(e.openBlock(),e.createElementBlock("view",{key:4,class:"action-buttons"},[e.createElementVNode("button",{class:e.normalizeClass(["action-btn follow-btn",{"follow-active":r.userIsFollowed}]),onClick:a[4]||(a[4]=(...e)=>n.handleFollow&&n.handleFollow(...e))},e.toDisplayString(r.userIsFollowed?"å·²å…³æ³¨":"å…³æ³¨"),3),e.createElementVNode("button",{class:"action-btn message-btn",onClick:a[5]||(a[5]=(...e)=>n.handleMessage&&n.handleMessage(...e))}," å‘ä¿¡æ¯ ")]))])],2)}],["__scopeId","data-v-bda030eb"],["__file","D:/caloriesH5/CloudStorage/components/map/UserInfoPopup.vue"]]);const ct=ze({components:{UserInfoPopup:lt,WalkSummaryPopup:ze({__name:"WalkSummaryPopup",props:{visible:{type:Boolean,default:!1},duration:{type:Number,default:0},distance:{type:Number,default:0},pets:{type:Array,default:()=>[]},selectedPetIndex:{type:Number,default:0},shareContent:{type:String,default:""}},emits:["close","share"],setup(t,{expose:a,emit:o}){a();const s=t,r=o,n=e.ref(s.selectedPetIndex||0),i=e.ref(s.shareContent||""),l=e.computed((()=>Qe(s.duration))),c=e.computed((()=>(s.distance/1e3).toFixed(2))),u=e.computed((()=>Ke(s.distance/1e3,s.duration))),d=e.computed((()=>s.pets.map((e=>e.name))));e.watch((()=>s.visible),(e=>{e||(n.value=0,i.value="")})),e.watch((()=>s.pets),(()=>{n.value=0}));const m={props:s,emit:r,selectedPetIndex:n,shareContent:i,formattedDuration:l,formattedDistance:c,pace:u,petNames:d,handleClose:()=>{r("close")},onPetChange:e=>{n.value=Number(e.detail.value)},handleShare:()=>{s.pets.length>0&&n.value<0?uni.showToast({title:"è¯·é€‰æ‹©ä¸€ä¸ªå® ç‰©",icon:"none"}):r("share",{selectedPetIndex:n.value,content:i.value})},viewHistory:()=>{r("close"),uni.navigateTo({url:"/pages/walk/history"})},ref:e.ref,computed:e.computed,watch:e.watch,get formatDuration(){return Qe},get calculatePace(){return Ke}};return Object.defineProperty(m,"__isScriptSetup",{enumerable:!1,value:!0}),m}},[["render",function(t,a,o,s,r,n){return e.openBlock(),e.createElementBlock("view",{class:e.normalizeClass(["walk-summary-popup",{active:o.visible}])},[e.createElementVNode("view",{class:"popup-content"},[e.createElementVNode("view",{class:"popup-header"},[e.createElementVNode("text",{class:"title"},"é›ç‹—æ€»ç»“"),e.createElementVNode("text",{class:"close-btn",onClick:s.handleClose},"Ã—")]),e.createElementVNode("view",{class:"summary-stats"},[e.createElementVNode("view",{class:"stat-item"},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString(s.formattedDuration),1),e.createElementVNode("text",{class:"stat-label"},"æ€»æ—¶é•¿")]),e.createElementVNode("view",{class:"stat-item"},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString(s.formattedDistance)+" å…¬é‡Œ",1),e.createElementVNode("text",{class:"stat-label"},"æ€»è·ç¦»")]),e.createElementVNode("view",{class:"stat-item"},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString(s.pace),1),e.createElementVNode("text",{class:"stat-label"},"å¹³å‡é…é€Ÿ")])]),parseFloat(s.formattedDistance)>1?(e.openBlock(),e.createElementBlock("view",{key:0,class:"summary-achievement"},[e.createElementVNode("text",{class:"achievement-icon"},"ğŸ†"),e.createElementVNode("text",{class:"achievement-text"},"æ­å–œä½ ä»Šå¤©é›ç‹—è¶…è¿‡1å…¬é‡Œ!")])):e.createCommentVNode("v-if",!0),e.createCommentVNode(" Optional: Static map image placeholder "),e.createCommentVNode(' <view class="summary-map-placeholder">åœ°å›¾åŒºåŸŸ</view> '),e.createElementVNode("view",{class:"share-options"},[e.createElementVNode("text",{class:"share-label"},"é›ç‹—å®Œæˆ!"),e.createElementVNode("view",{class:"share-success"},[e.createElementVNode("text",{class:"success-emoji"},"ğŸ‰"),e.createElementVNode("text",{class:"success-text"},"æ­å–œå®Œæˆé›ç‹—ï¼Œåˆ†äº«ä¸€ä¸‹ä»Šå¤©çš„å¿ƒæƒ…å§!")]),o.pets.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"pet-select"},[e.createElementVNode("text",null,"é€‰æ‹©å® ç‰©:"),e.createElementVNode("picker",{mode:"selector",range:s.petNames,value:s.selectedPetIndex,onChange:s.onPetChange},[e.createElementVNode("view",{class:"picker-text"},e.toDisplayString(s.petNames[s.selectedPetIndex]||"è¯·é€‰æ‹©"),1)],40,["range","value"])])):e.createCommentVNode("v-if",!0),e.withDirectives(e.createElementVNode("textarea",{class:"share-content","onUpdate:modelValue":a[0]||(a[0]=e=>s.shareContent=e),placeholder:"åˆ†äº«ä½ çš„é›ç‹—å¿ƒå¾—..."},null,512),[[e.vModelText,s.shareContent]]),e.createElementVNode("view",{class:"button-group"},[e.createElementVNode("button",{class:"view-btn",onClick:s.viewHistory},"æŸ¥çœ‹è®°å½•"),e.createElementVNode("button",{class:"share-btn",onClick:s.handleShare},"ä¿å­˜å¹¶åˆ†äº«")])])])],2)}],["__scopeId","data-v-d75cc90b"],["__file","D:/caloriesH5/CloudStorage/components/map/WalkSummaryPopup.vue"]])},setup(){const o=Re(),r=Oe(),n=qe(),i=Ge(),l=e.ref(!0),c=e.ref(null),u={};const d={cache:{},get(e){const t=this.normalizeUrl(e);return this.cache[t]||null},put(e,t){const o=this.normalizeUrl(e);return this.cache[o]=t,a("log","at pages/map/map.vue:310","å¤´åƒç¼“å­˜æ›´æ–°ï¼Œå½“å‰ç¼“å­˜æ•°:",Object.keys(this.cache).length),t},remove(e){const t=this.normalizeUrl(e);return!!this.cache[t]&&(delete this.cache[t],!0)},clear(){return this.cache={},a("log","at pages/map/map.vue:327","å¤´åƒç¼“å­˜å·²æ¸…ç©º"),!0},normalizeUrl(e){if(!e)return"";let t=e.split("?")[0];if(t.startsWith("/uploads/")){t="http://49.235.65.37:5000"+t}return t}};function m(){const t={motionEvent:!1,deviceOrientation:!1,geolocation:!1,compass:!1,manualSet:!0};let s=null;function r(e,t){"compass"===t||"geolocation"===t||"deviceorientationevent"!==t&&"uniapp-motion"!==t||(e=(360-e)%360);const a={movement:5,geolocation:4,deviceorientationevent:3,"uniapp-motion":2,compass:1,manual:0};(!s||a[t]>a[s])&&(s=t),t===s&&(Z.value=e,function(e){var t;const a=(null==(t=o.userInfo)?void 0:t.id)||"current-user-location";u[a]&&u[a].setRotation&&u[a].setRotation(e)}(e))}return function(){try{"undefined"!=typeof DeviceOrientationEvent&&(t.motionEvent=!0,window.addEventListener("deviceorientation",(e=>{if(null!==e.alpha&&void 0!==e.alpha){r(e.alpha,"deviceorientationevent")}})),a("log","at pages/map/map.vue:375","å·²æ³¨å†Œè®¾å¤‡æ–¹å‘äº‹ä»¶ç›‘å¬å™¨"))}catch(o){a("warn","at pages/map/map.vue:378","è®¾å¤‡æ–¹å‘äº‹ä»¶ä¸å¯ç”¨:",o)}try{"function"==typeof uni.onDeviceMotionChange&&(uni.startDeviceMotionListening({interval:"game",success:()=>{t.deviceOrientation=!0,a("log","at pages/map/map.vue:388","uni-appè®¾å¤‡æ–¹å‘ç›‘å¬å¯åŠ¨æˆåŠŸ")},fail:e=>{a("warn","at pages/map/map.vue:391","uni-appè®¾å¤‡æ–¹å‘ç›‘å¬å¯åŠ¨å¤±è´¥",e)}}),uni.onDeviceMotionChange((e=>{if(void 0!==e.alpha){r(e.alpha,"uniapp-motion")}})))}catch(o){a("warn","at pages/map/map.vue:403","uni-appè®¾å¤‡æ–¹å‘APIä¸å¯ç”¨:",o)}try{navigator.geolocation&&navigator.geolocation.watchPosition&&(navigator.geolocation.watchPosition((e=>{if(null!==e.coords.heading&&void 0!==e.coords.heading){t.geolocation=!0;r(e.coords.heading,"geolocation")}}),(e=>{a("warn","at pages/map/map.vue:418","åœ°ç†ä½ç½®æ–¹å‘è·Ÿè¸ªé”™è¯¯:",e)}),{enableHighAccuracy:!0,maximumAge:0}),a("log","at pages/map/map.vue:425","å·²å¯åŠ¨åœ°ç†ä½ç½®æ–¹å‘è·Ÿè¸ª"))}catch(o){a("warn","at pages/map/map.vue:428","åœ°ç†ä½ç½®æ–¹å‘APIä¸å¯ç”¨:",o)}try{"function"==typeof uni.onCompassChange&&(uni.onCompassChange((e=>{if(void 0!==e.direction){t.compass=!0;r(e.direction,"compass")}})),a("log","at pages/map/map.vue:441","å·²å¯åŠ¨æŒ‡å—é’ˆæ–¹å‘è·Ÿè¸ª"))}catch(o){a("warn","at pages/map/map.vue:444","æŒ‡å—é’ˆAPIä¸å¯ç”¨:",o)}!function(){const t=[],a=5;e.watch(C,((e,o)=>{if(e&&o){const s=Ye(o.latitude,o.longitude,e.latitude,e.longitude);if(s>5){const n=function(e,t,a,o){e=e*Math.PI/180,t=t*Math.PI/180,a=a*Math.PI/180,o=o*Math.PI/180;const s=Math.sin(o-t)*Math.cos(a),r=Math.cos(e)*Math.sin(a)-Math.sin(e)*Math.cos(a)*Math.cos(o-t);let n=180*Math.atan2(s,r)/Math.PI;return n=(n+360)%360,n}(o.latitude,o.longitude,e.latitude,e.longitude);if(t.push({location:e,timestamp:Date.now(),bearing:n,distance:s}),t.length>a&&t.shift(),t.length>=2){let e=0,a=0;if(t.forEach(((o,s)=>{const r=(s+1)/t.length*Math.min(o.distance/10,1);e+=o.bearing*r,a+=r})),a>0){r(e/a,"movement")}}}}}),{deep:!0})}(),setTimeout((()=>{a("log","at pages/map/map.vue:452","æ–¹å‘ä¼ æ„Ÿå™¨å¯ç”¨æ€§:",t),t.motionEvent||t.deviceOrientation||t.geolocation||t.compass||(a("warn","at pages/map/map.vue:459","æ²¡æœ‰å¯ç”¨çš„æ–¹å‘ä¼ æ„Ÿå™¨ï¼Œç”¨æˆ·å¤´åƒå°†ä¸ä¼šæ—‹è½¬"),Q.value&&uni.showToast({title:"è®¾å¤‡ä¸æ”¯æŒæ–¹å‘ä¼ æ„Ÿå™¨",icon:"none",duration:2e3}))}),3e3)}(),{setManualHeading:e=>{r(e,"manual")},getOrientationInfo:()=>({currentHeading:Z.value,currentSource:s,supportInfo:__spreadValues({},t)})}}const p=e.ref(!0),g=e.ref(!1),v=e.ref(null),h=()=>{if(p.value=!p.value,c.value){const e=c.value.getAllOverlays("circle"),t=c.value.getAllOverlays("marker").filter((e=>{const t=e.getExtData();return!(t&&t.isUserMarker)}));p.value?(t.forEach((e=>{e.show()})),e.forEach((e=>{e.show()})),a("log","at pages/map/map.vue:666","æ˜¾ç¤ºæ‰€æœ‰æ ‡è®°å’Œè¦†ç›–åŒºåŸŸ")):(t.forEach((e=>{e.hide()})),e.forEach((e=>{e.hide()})),a("log","at pages/map/map.vue:678","éšè—æ‰€æœ‰æ ‡è®°å’Œè¦†ç›–åŒºåŸŸï¼Œç”¨æˆ·å¤´åƒä¿æŒæ˜¾ç¤º")),f()}},f=()=>{if(!c.value)return;c.value.getAllOverlays("marker").filter((e=>{const t=e.getExtData();return t&&t.isUserMarker})).forEach((e=>{e.setzIndex(1e3),e.show()}))},y=()=>__async(this,null,(function*(){try{if(a("log","at pages/map/map.vue:708","åŠ è½½æ ‡è®°æ•°æ®..."),!C.value)return void a("warn","at pages/map/map.vue:710","å½“å‰ä½ç½®ä¸å¯ç”¨ï¼Œæ— æ³•åŠ è½½é™„è¿‘æ ‡è®°");a("log","at pages/map/map.vue:714","æ­£åœ¨ä»æœåŠ¡å™¨è·å–é™„è¿‘æ ‡è®°..."),a("log","at pages/map/map.vue:715","å½“å‰ä½ç½®:",C.value);const t={show:()=>{uni.showLoading({title:"åŠ è½½æ ‡è®°ä¸­...",mask:!1})},hide:()=>{uni.hideLoading()}};t.show();try{const e=yield i.fetchNearbyMarkers({longitude:C.value.longitude,latitude:C.value.latitude,radius:5e3});t.hide(),a("log","at pages/map/map.vue:744","è·å–åˆ°é™„è¿‘æ ‡è®°:",e.length);const o=e.map((e=>{const t=__spreadValues({},e);return t.latitude&&t.longitude||t.location&&t.location.coordinates&&(t.longitude=t.location.coordinates[0],t.latitude=t.location.coordinates[1]),void 0===t.radius||null===t.radius?(t.radius=.5,a("log","at pages/map/map.vue:763",`æ ‡è®° ${t.title||"æœªå‘½å"} æ²¡æœ‰åŠå¾„ï¼Œè®¾ç½®é»˜è®¤å€¼0.5å…¬é‡Œ`)):a("log","at pages/map/map.vue:765",`æ ‡è®° ${t.title||"æœªå‘½å"} åŠå¾„: ${t.radius}`),t.color||(t.color=t.color||"#007AFF"),t}));w(o),0===o.length&&uni.showToast({title:"é™„è¿‘æ²¡æœ‰æ ‡è®°",icon:"none",duration:2e3})}catch(e){if(t.hide(),a("error","at pages/map/map.vue:791","APIè·å–æ ‡è®°å¤±è´¥:",e),uni.showToast({title:"åŠ è½½æ ‡è®°å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none",duration:2e3}),i.markerCache&&i.markerCache.data&&i.markerCache.data.length>0){a("log","at pages/map/map.vue:802","å°è¯•ä½¿ç”¨ç¼“å­˜çš„æ ‡è®°æ•°æ®");const e=i.filterMarkersByDistance(i.markerCache.data,{latitude:C.value.latitude,longitude:C.value.longitude,radius:5e3});if(e.length>0){const t=e.map((e=>(e.latitude&&e.longitude||e.location&&e.location.coordinates&&(e.longitude=e.location.coordinates[0],e.latitude=e.location.coordinates[1]),e.radius=e.radius||500,e.color=e.color||"#007AFF",e)));w(t),uni.showToast({title:"æ˜¾ç¤ºç¼“å­˜çš„æ ‡è®°æ•°æ®",icon:"none",duration:2e3})}else w([])}else w([])}}catch(t){a("error","at pages/map/map.vue:848","åŠ è½½æ ‡è®°æ•°æ®å¤±è´¥:",t),uni.hideLoading(),uni.showToast({title:"åŠ è½½æ ‡è®°å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none",duration:2e3})}})),w=e=>{try{if(a("log","at pages/map/map.vue:865","æ˜¾ç¤ºæ ‡è®°æ•°æ®:",e),!e||!e.length)return void a("log","at pages/map/map.vue:867","æ²¡æœ‰æ ‡è®°å¯æ˜¾ç¤º");if(c.value){const e=c.value.getAllOverlays("marker").filter((e=>{const t=e.getExtData();return!(t&&t.isUserMarker)}));e.length>0&&c.value.remove(e),c.value.remove(c.value.getAllOverlays("circle"))}e.forEach((e=>{var t,o,s,r;try{a("log","at pages/map/map.vue:894","æ·»åŠ æ ‡è®°:",e);const n=[e.longitude||(null==(o=null==(t=e.location)?void 0:t.coordinates)?void 0:o[0]),e.latitude||(null==(r=null==(s=e.location)?void 0:s.coordinates)?void 0:r[1])];if(!n[0]||!n[1])return void a("warn","at pages/map/map.vue:900","æ ‡è®°ä½ç½®æ— æ•ˆ:",n);e.title||(e.title=e.title||"æœªå‘½åæ ‡è®°"),e.type||(e.type=e.type||"general");const l=new AMap.Marker({position:n,title:e.title,icon:e.icon||k(e.type),anchor:"bottom-center",offset:new AMap.Pixel(0,0),extData:{marker:e,id:e._id,type:"marker"},clickable:!0});if(c.value.add(l),l.on("click",(t=>{a("log","at pages/map/map.vue:932","æ ‡è®°è¢«ç‚¹å‡»:",e),i.setSelectedMarker(e),E(e)})),e.radius){let t;if("number"==typeof e.radius)e.radius<100?(t=1e3*e.radius,a("log","at pages/map/map.vue:950",`æ ‡è®° "${e.title||"æœªå‘½å"}" [${e._id}] - è½¬æ¢åŠå¾„ä» ${e.radius}km åˆ° ${t}m`)):(t=e.radius,a("log","at pages/map/map.vue:954",`æ ‡è®° "${e.title||"æœªå‘½å"}" [${e._id}] - ä½¿ç”¨åŸå§‹åŠå¾„ ${t}m`));else{const o=parseFloat(e.radius)||.5;t=o<100?1e3*o:o,a("log","at pages/map/map.vue:960",`æ ‡è®° "${e.title||"æœªå‘½å"}" [${e._id}] - ä»å­—ç¬¦ä¸²è½¬æ¢åŠå¾„: ${e.radius} -> ${t}m`)}a("log","at pages/map/map.vue:964",`æœ€ç»ˆä½¿ç”¨çš„è¦†ç›–åŠå¾„: ${t}ç±³ (åŸå§‹å€¼: ${e.radius})`);const o=new AMap.Circle({center:n,radius:t,strokeColor:e.color||"#1E90FF",strokeWeight:2,strokeOpacity:.8,fillColor:e.color||"#1E90FF",fillOpacity:.15,extData:{marker:e}});c.value.add(o),o.on("click",(t=>{a("log","at pages/map/map.vue:983","æ ‡è®°åŒºåŸŸè¢«ç‚¹å‡»:",e),i.setSelectedMarker(e);const o=t.target,s=o.getOptions().strokeColor,r=o.getOptions().fillColor,n=o.getOptions().fillOpacity;o.setOptions({strokeColor:"#FF3B30",fillColor:"#FF3B30",fillOpacity:.3}),setTimeout((()=>{o.setOptions({strokeColor:s,fillColor:r,fillOpacity:n})}),1e3),E(e)}))}}catch(n){a("error","at pages/map/map.vue:1015","æ·»åŠ å•ä¸ªæ ‡è®°æ—¶å‡ºé”™:",n)}})),a("log","at pages/map/map.vue:1019","æ ‡è®°æ˜¾ç¤ºå®Œæˆ"),f(),p.value||(h(),h())}catch(t){a("error","at pages/map/map.vue:1030","æ˜¾ç¤ºæ ‡è®°æ—¶å‡ºé”™:",t)}},k=e=>{if(tt&&tt[e])return tt[e];const t={general:"/static/images/marker.png",pet_friendly:"/static/images/pet-marker.png",danger:"/static/images/danger-marker.png",scenic:"/static/images/park-marker.png",pet_service:"/static/images/shop-marker.png",custom:"/static/images/marker.png"};return t[e]||t.general},E=e=>{var t,o,s,r;if(e)try{a("log","at pages/map/map.vue:1132","æ˜¾ç¤ºæ ‡è®°è¯¦æƒ…å¼¹çª—, åŸå§‹æ•°æ®:",e);let l=e;if(e instanceof AMap.Marker){const t=e.getExtData();if(t&&t.marker)l=t.marker,a("log","at pages/map/map.vue:1142","ä»æ ‡è®°extDataä¸­è·å–åˆ°æ ‡è®°æ•°æ®:",l);else if(t&&t.id){const e=i.markers.find((e=>e._id===t.id));e&&(l=e,a("log","at pages/map/map.vue:1148","ä»storeä¸­è·å–åˆ°æ ‡è®°æ•°æ®:",l))}else a("warn","at pages/map/map.vue:1151","æ ‡è®°ä¸åŒ…å«æœ‰æ•ˆçš„extDataæ•°æ®")}l.title||(l.title="æœªå‘½åæ ‡è®°"),l.type||(l.type="general"),a("log","at pages/map/map.vue:1163","å¤„ç†åçš„æ ‡è®°æ•°æ®:",l),i.setSelectedMarker(l);const u=l.longitude||(null==(o=null==(t=l.location)?void 0:t.coordinates)?void 0:o[0]),d=l.latitude||(null==(r=null==(s=l.location)?void 0:s.coordinates)?void 0:r[1]);if(e instanceof AMap.Marker&&"function"==typeof e.setAnimation)try{e.setAnimation("AMAP_ANIMATION_BOUNCE"),setTimeout((()=>{e&&"function"==typeof e.setAnimation&&e.setAnimation(null)}),2e3)}catch(n){a("warn","at pages/map/map.vue:1184","è®¾ç½®æ ‡è®°åŠ¨ç”»æ•ˆæœå¤±è´¥:",n),"function"==typeof e.setzIndex&&e.setzIndex(999)}if(l.images&&l.images.length>0){a("log","at pages/map/map.vue:1195","æ ‡è®°åŒ…å«å›¾ç‰‡ï¼Œè·³è½¬åˆ°è¯¦æƒ…é¡µé¢"),l.user&&"string"==typeof l.user&&(a("log","at pages/map/map.vue:1200","æ ‡è®°åªåŒ…å«ç”¨æˆ·IDï¼Œåˆå§‹åŒ–åŸºæœ¬ç”¨æˆ·å¯¹è±¡"),l._processedUserInfo||(l._processedUserInfo=!0,l._originalUserId=l.user));const e=l._id;e?uni.navigateTo({url:`/pages/map/marker-detail?id=${e}`}):uni.showToast({title:"æ— æ³•è·å–æ ‡è®°è¯¦æƒ…",icon:"none"})}else null!=v?(v.value=l,g.value=!0):(a("error","at pages/map/map.vue:1230","selectedMarkeræœªå®šä¹‰"),uni.showModal({title:l.title||"æœªå‘½åæ ‡è®°",content:l.description||"æ— æè¿°ä¿¡æ¯",showCancel:!0,cancelText:"å…³é—­",confirmText:"å¯¼èˆª",success:e=>{e.confirm&&u&&d&&c.value&&(c.value.setCenter([u,d]),c.value.setZoom(17))}}))}catch(l){a("error","at pages/map/map.vue:1248","æ˜¾ç¤ºæ ‡è®°ä¿¡æ¯å¤±è´¥:",l),uni.showToast({title:"æ˜¾ç¤ºæ ‡è®°ä¿¡æ¯å¤±è´¥",icon:"none"})}},N=()=>{if(c.value)return c.value;if(a("error","at pages/map/map.vue:1293","åœ°å›¾æœªåˆå§‹åŒ–ï¼Œå°è¯•è·å–åœ°å›¾å®ä¾‹"),"undefined"!=typeof window&&window.__dogRunMapInstance)return a("log","at pages/map/map.vue:1297","ä»å…¨å±€å˜é‡è·å–åœ°å›¾å®ä¾‹"),c.value=window.__dogRunMapInstance,c.value;if("undefined"!=typeof window&&window.AMap){const t=document.getElementById("map-container");if(t&&t.__amap_instance__)return c.value=t.__amap_instance__,a("log","at pages/map/map.vue:1307","å·²ä»DOMå…ƒç´ è·å–åœ°å›¾å®ä¾‹"),c.value;if(a("log","at pages/map/map.vue:1312","å°è¯•é‡æ–°åˆ›å»ºåœ°å›¾å®ä¾‹"),!t)throw new Error("æ— æ³•è·å–åœ°å›¾å®¹å™¨");try{return c.value=new window.AMap.Map("map-container",{zoom:15,center:[C.value.longitude,C.value.latitude],resizeEnable:!0}),window.__dogRunMapInstance=c.value,t.__amap_instance__=c.value,a("log","at pages/map/map.vue:1322","åœ°å›¾å®ä¾‹å·²é‡æ–°åˆ›å»º"),c.value}catch(e){throw a("error","at pages/map/map.vue:1325","æ— æ³•åˆ›å»ºåœ°å›¾å®ä¾‹:",e),new Error("æ— æ³•åˆ›å»ºåœ°å›¾å®ä¾‹: "+e.message)}}throw new Error("åœ°å›¾APIæœªåŠ è½½")};function V(e,t=!1){if(t&&a("log","at pages/map/map.vue:1339","getFullAvatarUrlå¤„ç†:",e),!e)return t&&a("log","at pages/map/map.vue:1344","æ²¡æœ‰æä¾›avatarPathï¼Œè¿”å›é»˜è®¤å¤´åƒ"),ee;if(e.startsWith("data:image/"))return t&&a("log","at pages/map/map.vue:1350","æ˜¯base64å›¾ç‰‡ï¼Œç›´æ¥è¿”å›"),e;if(e.startsWith("http://")||e.startsWith("https://")){t&&a("log","at pages/map/map.vue:1356","å·²ç»æ˜¯å®Œæ•´URLï¼Œç›´æ¥è¿”å›:",e);return e.replace(/["']/g,"")}const o=uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000";if(e.startsWith("/uploads/")){const s=o+e;return t&&a("log","at pages/map/map.vue:1368","æ˜¯ä¸Šä¼ è·¯å¾„ï¼Œæ·»åŠ åŸºç¡€URL:",s),s}if(e.startsWith("uploads/")){const s=o+"/"+e;return t&&a("log","at pages/map/map.vue:1375","æ˜¯ä¸å¸¦å‰å¯¼æ–œæ çš„ä¸Šä¼ è·¯å¾„ï¼Œæ·»åŠ åŸºç¡€URL:",s),s}t&&a("log","at pages/map/map.vue:1380","æœªè¯†åˆ«çš„è·¯å¾„ç±»å‹ï¼Œå°è¯•æ·»åŠ åŸºç¡€URL:",e);return o+"/"+(e.startsWith("/")?e.substring(1):e)}const _=e.ref(16),C=e.ref({latitude:39.9087,longitude:116.3975}),b=e.ref([]),P=e.ref(null),x=e.ref(null),I=e.ref([]),T=e.ref(!1),M=e.ref([]),D=e.ref(0),B=e.ref(0),U=e.ref(null),j=e.ref(null),F=e.ref([]),L=e.ref(!1),$=e.ref(null),O=e.ref([]),R=e.ref(!1),W=e.ref(!1),z=e.ref(!1),J=e.ref(""),H=e.ref([]),q=e.computed((()=>H.value.map((e=>e.name)))),G=e.ref(0),Q=e.ref(!1),K=e.ref({markerCount:0,markerIds:[],coords:[]}),Y=e.ref(!1),X=e.ref(!0),Z=e.ref(0),ee="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAAAXNSR0IArs4c6QAAAQNJREFUeF7t1LENACAMBDFYm+WDxAhc6/TXWK/sdWaW+xbYAL/tXgiw+QGMfgABVoHY+4EAo0DMLRBgFIi5BQKMAjG3QIBRIOYWCDAKxNwCAUaBmFsgwCgQcwsEGAViboEAo0DMLRBgFIi5BQKMAjG3QIBRIOYWCDAKxNwCAUaBmFsgwCgQcwsEGAViboEAo0DMLRBgFIi5BQKMAjG3QIBRIOYWCDAKxNwCAUaBmFsgwCgQcwsEGAViboEAo0DMLRBgFIi5BQKMAjG3QIBRIOYWCDAKxPwCxDvF0aa/hxYAAAAASUVORK5CYII=",te=e.computed((()=>{const e=o.userInfo||o.user||{};return a("log","at pages/map/map.vue:1438","ç”¨æˆ·ä¿¡æ¯çŠ¶æ€:",{"userStore.userAvatarå­˜åœ¨":!!o.userAvatar,"userStore.userInfoå­˜åœ¨":!!o.userInfo,"userStore.userå­˜åœ¨":!!o.user,"å¤´åƒè·¯å¾„":e.avatar||o.userAvatar}),o.userAvatar?V(o.userAvatar,!0):e.avatar?(a("log","at pages/map/map.vue:1453","å¤´åƒè®¡ç®—ç»†èŠ‚:",{"åŸå§‹è·¯å¾„":e.avatar,"æ˜¯å¦ä»¥ä¸Šä¼ è·¯å¾„å¼€å¤´":e.avatar.startsWith("/uploads/"),"ç¯å¢ƒå˜é‡":uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000"}),V(e.avatar,!0)):(a("log","at pages/map/map.vue:1463","æœªæ‰¾åˆ°ç”¨æˆ·å¤´åƒï¼Œä½¿ç”¨é»˜è®¤è“è‰²å¤´åƒ"),ee)})),ae=e.ref(null),oe=e.computed((()=>{let e=[...b.value];if(ae.value)e=e.filter((e=>"user-location"!==e.id)),e.push(ae.value),a("log","at pages/map/map.vue:1480","æ·»åŠ ç”¨æˆ·ä½ç½®æ ‡è®°:",ae.value);else if(C.value&&C.value.latitude){const t={id:"user-location",latitude:C.value.latitude,longitude:C.value.longitude,iconPath:te.value,width:40,height:40,rotate:Z.value,anchor:{x:.5,y:.5}};e.push(t),a("log","at pages/map/map.vue:1498","æ·»åŠ ä¸´æ—¶ç”¨æˆ·æ ‡è®°:",t)}else a("warn","at pages/map/map.vue:1500","ç”¨æˆ·ä½ç½®æ ‡è®°æœªåˆ›å»ºï¼Œä¸”æ²¡æœ‰ä½ç½®ä¿¡æ¯");return e}));function se(){if(X.value)try{a("log","at pages/map/map.vue:1522","æ›´æ–°ä½ç½®å…±äº«:",{latitude:C.value.latitude,longitude:C.value.longitude}),a("log","at pages/map/map.vue:1528","ä½ç½®å…±äº«å·²åœ¨æœ¬åœ°æ›´æ–°ï¼ˆä¸è°ƒç”¨APIï¼‰");try{n&&"function"==typeof n.updateLocation&&n.updateLocation({latitude:C.value.latitude,longitude:C.value.longitude,timestamp:(new Date).toISOString()}).catch((e=>{a("warn","at pages/map/map.vue:1539","æ›´æ–°ä½ç½®APIè°ƒç”¨å¤±è´¥ï¼ˆå·²å¿½ç•¥ï¼‰:",e)}))}catch(e){a("warn","at pages/map/map.vue:1544","ä½ç½®APIè°ƒç”¨å°è¯•å¤±è´¥ï¼ˆå·²å¿½ç•¥ï¼‰:",e)}}catch(t){a("error","at pages/map/map.vue:1547","æ›´æ–°ä½ç½®å…±äº«çŠ¶æ€å¤±è´¥:",t)}}function re(e=0){return __async(this,null,(function*(){try{if(!c.value)return a("log","at pages/map/map.vue:1575","åœ°å›¾æœªå‡†å¤‡å¥½ï¼Œå»¶è¿Ÿè·å–é™„è¿‘ç”¨æˆ·"),e<5&&setTimeout((()=>re(e+1)),1500),Promise.resolve({success:!1,message:"åœ°å›¾æœªå‡†å¤‡å¥½"});if(!l.value)return a("log","at pages/map/map.vue:1584","åç«¯APIä¸å¯ç”¨ï¼Œä¸è·å–é™„è¿‘ç”¨æˆ·"),I.value=[],Promise.resolve({success:!1,message:"åç«¯APIä¸å¯ç”¨"});if(!X.value)return a("log","at pages/map/map.vue:1591","ä½ç½®å…±äº«æœªå¼€å¯ï¼Œä¸è·å–é™„è¿‘ç”¨æˆ·"),Promise.resolve({success:!1,message:"ä½ç½®å…±äº«æœªå¼€å¯"});if(!C.value||!C.value.latitude||!C.value.longitude)return a("error","at pages/map/map.vue:1597","å½“å‰ä½ç½®ä¸å¯ç”¨ï¼Œç¨åé‡è¯•è·å–é™„è¿‘ç”¨æˆ·"),e<5&&setTimeout((()=>re(e+1)),1500),Promise.resolve({success:!1,message:"å½“å‰ä½ç½®ä¸å¯ç”¨"});if(a("log","at pages/map/map.vue:1604","è·å–é™„è¿‘ç”¨æˆ·..."),a("log","at pages/map/map.vue:1608","å¼€å‘ç¯å¢ƒ: æ·»åŠ å½“å‰ç”¨æˆ·åˆ°é™„è¿‘ç”¨æˆ·åˆ—è¡¨"),o.userInfo&&C.value){const e=__spreadProps(__spreadValues({},o.userInfo),{latitude:C.value.latitude,longitude:C.value.longitude,lastUpdated:(new Date).toISOString()});return I.value=[e],a("log","at pages/map/map.vue:1622","å·²æ·»åŠ å½“å‰ç”¨æˆ·åˆ°é™„è¿‘ç”¨æˆ·åˆ—è¡¨:",e),ne(),Promise.resolve({success:!0,message:"å¼€å‘ç¯å¢ƒåªè¿”å›å½“å‰ç”¨æˆ·",data:[e]})}const t=yield n.getNearbyUsers({latitude:C.value.latitude,longitude:C.value.longitude,maxDistance:5e3}).catch((t=>(a("error","at pages/map/map.vue:1641","ä½ç½®APIé”™è¯¯:",t),e<3&&(a("log","at pages/map/map.vue:1644",`è·å–é™„è¿‘ç”¨æˆ·å¤±è´¥ï¼Œ${e+1}/3æ¬¡é‡è¯•`),setTimeout((()=>re(e+1)),2e3)),{success:!1,message:"ä½ç½®APIé”™è¯¯"})));if(t&&t.success&&Array.isArray(t.data)){let e=[];if(o.userInfo&&o.userInfo.id?(e=t.data.filter((e=>e.id!==o.userInfo.id)),a("log","at pages/map/map.vue:1657","è¿‡æ»¤åçš„å…¶ä»–ç”¨æˆ·æ•°é‡:",e.length)):(e=t.data,a("log","at pages/map/map.vue:1660","æœªè¿‡æ»¤çš„ç”¨æˆ·æ•°é‡:",e.length)),o.userInfo&&C.value){const t=__spreadProps(__spreadValues({},o.userInfo),{latitude:C.value.latitude,longitude:C.value.longitude,lastUpdated:(new Date).toISOString()});e.length>0?(I.value=[t,...e],a("log","at pages/map/map.vue:1676","åˆå¹¶åçš„ç”¨æˆ·åˆ—è¡¨:",I.value.length,"ä¸ªç”¨æˆ· (å½“å‰ç”¨æˆ· + å…¶ä»–ç”¨æˆ·)")):(I.value=[t],a("log","at pages/map/map.vue:1679","ç”¨æˆ·åˆ—è¡¨åªåŒ…å«å½“å‰ç”¨æˆ·"))}else I.value=e,a("log","at pages/map/map.vue:1683","ç”¨æˆ·åˆ—è¡¨ä¸åŒ…å«å½“å‰ç”¨æˆ·(æœªç™»å½•æˆ–æ— ä½ç½®)");return ne(),a("log","at pages/map/map.vue:1687","è·å–åˆ°é™„è¿‘ç”¨æˆ·:",I.value.length),Promise.resolve(t)}if(a("log","at pages/map/map.vue:1694","æœªè·å–åˆ°é™„è¿‘ç”¨æˆ·æˆ–æ ¼å¼é”™è¯¯:",t),o.userInfo&&C.value){const e=__spreadProps(__spreadValues({},o.userInfo),{latitude:C.value.latitude,longitude:C.value.longitude,lastUpdated:(new Date).toISOString()});I.value=[e],a("log","at pages/map/map.vue:1706","APIå¤±è´¥ï¼Œåªæ˜¾ç¤ºå½“å‰ç”¨æˆ·"),ne()}else I.value=[],a("log","at pages/map/map.vue:1710","APIå¤±è´¥ï¼Œä¸”æ— å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ŒnearbyUsersä¸ºç©º");return!(e<3)||o.userInfo&&C.value||(a("log","at pages/map/map.vue:1715",`APIå¤±è´¥ï¼Œ${e+1}/3æ¬¡é‡è¯•`),setTimeout((()=>re(e+1)),2e3)),Promise.resolve({success:!1,message:"æ— é™„è¿‘ç”¨æˆ·",response:t})}catch(t){if(a("error","at pages/map/map.vue:1722","è·å–é™„è¿‘ç”¨æˆ·å¤±è´¥",t),o.userInfo&&C.value){const e=__spreadProps(__spreadValues({},o.userInfo),{latitude:C.value.latitude,longitude:C.value.longitude,lastUpdated:(new Date).toISOString()});I.value=[e],a("log","at pages/map/map.vue:1734","å¼‚å¸¸æƒ…å†µä¸‹ï¼Œåªæ˜¾ç¤ºå½“å‰ç”¨æˆ·"),ne()}else I.value=[],a("log","at pages/map/map.vue:1738","å¼‚å¸¸æƒ…å†µä¸‹ï¼Œä¸”æ— å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ŒnearbyUsersä¸ºç©º");return e<3&&(a("log","at pages/map/map.vue:1743",`å¼‚å¸¸æƒ…å†µï¼Œ${e+1}/3æ¬¡é‡è¯•`),setTimeout((()=>re(e+1)),2e3)),Promise.reject(t)}}))}function ne(){try{return I.value&&I.value.length?(a("log","at pages/map/map.vue:1782","æ›´æ–°é™„è¿‘ç”¨æˆ·æ ‡è®°ï¼Œç”¨æˆ·æ•°é‡:",I.value.length),void a("log","at pages/map/map.vue:1786","å¼€å‘ç¯å¢ƒï¼Œä»…æ˜¾ç¤ºè‡ªå·±çš„æ ‡è®°")):(a("log","at pages/map/map.vue:1755","æ²¡æœ‰é™„è¿‘ç”¨æˆ·ï¼Œæ¸…é™¤éè‡ªèº«æ ‡è®°"),void(c.value&&oe.value&&(oe.value.forEach((e=>{var t,s;const r=null==(t=null==e?void 0:e.extData)?void 0:t.userId,n=null==(s=o.userInfo)?void 0:s.id;a("log","at pages/map/map.vue:1764","æ ‡è®°ID:",r,"å½“å‰ç”¨æˆ·ID:",n),r&&n&&r!==n&&(a("log","at pages/map/map.vue:1768","ç§»é™¤éæœ¬äººæ ‡è®°:",r),c.value.remove(e))})),oe.value=oe.value.filter((e=>{var t;return!e.extData||!e.extData.userId||e.extData.userId===(null==(t=o.userInfo)?void 0:t.id)})))))}catch(e){a("error","at pages/map/map.vue:1855","æ›´æ–°åœ°å›¾æ ‡è®°æ—¶å‡ºé”™:",e)}}function ie(e,t){if(C.value&&0!==C.value.latitude){const t=e.latitude-C.value.latitude,o=e.longitude-C.value.longitude;if(Math.abs(t)>1e-5||Math.abs(o)>1e-5){const e=180*Math.atan2(o,t)/Math.PI;a("log","at pages/map/map.vue:1953","æ–¹ä½è®¡ç®—ï¼š",{dLat:t,dLng:o,calculatedHeading:e}),Z.value=e}}if(C.value=e,a("log","at pages/map/map.vue:1960","ä½ç½®å·²æ›´æ–°:",C.value),void 0!==t&&(Z.value=t,a("log","at pages/map/map.vue:1965","ä½¿ç”¨ç½—ç›˜æœå‘:",t)),(!window._lastMarkerUpdateTime||Date.now()-window._lastMarkerUpdateTime>3e4)&&(window._lastMarkerUpdateTime=Date.now(),a("log","at pages/map/map.vue:1972","è§¦å‘å®šæœŸæ ‡è®°æ›´æ–°"),o.isAuthenticated&&o.userInfo&&o.userInfo.id&&(a("log","at pages/map/map.vue:1976","ä½¿ç”¨å®é™…ç”¨æˆ·IDæ›´æ–°æ ‡è®°:",o.userInfo.id),me())),T.value&&F.value.length>0){const t=F.value[F.value.length-1],a=Ye(t.latitude,t.longitude,e.latitude,e.longitude);a>5&&(F.value.push({latitude:e.latitude,longitude:e.longitude}),M.value=[{points:F.value.map((e=>({latitude:e.latitude,longitude:e.longitude}))),color:"#007AFF",width:4}],D.value+=a)}}function le(){uni.getLocation({type:"gcj02",success:e=>{if(a("log","at pages/map/map.vue:2018","è·å–å½“å‰ä½ç½®æˆåŠŸ:",e),ie({latitude:e.latitude,longitude:e.longitude}),c.value?(a("log","at pages/map/map.vue:2026","ä½ç½®è·å–æˆåŠŸï¼Œç«‹å³å°†åœ°å›¾ä¸­å¿ƒè®¾ç½®åˆ°å½“å‰ä½ç½®"),c.value.setCenter([e.longitude,e.latitude]),c.value.setZoom(16)):a("log","at pages/map/map.vue:2030","åœ°å›¾å°šæœªåˆå§‹åŒ–ï¼Œæ— æ³•è®¾ç½®ä¸­å¿ƒç‚¹"),o.hasDecidedLocationSharing||(Y.value=!0),window.AMap)try{const e=window.AMap;e.plugin(["AMap.Geolocation"],(function(){new e.Geolocation({enableHighAccuracy:!0,timeout:1e4,convert:!0,showButton:!1,showMarker:!1,showCircle:!1}).getCurrentPosition((function(e,t){"complete"===e?t.position&&(C.value={latitude:t.position.lat,longitude:t.position.lng},c.value&&c.value.setCenter([t.position.lng,t.position.lat])):a("log","at pages/map/map.vue:2069","é«˜å¾·åœ°å›¾å®šä½å¤±è´¥",t)}))}))}catch(t){a("error","at pages/map/map.vue:2074","é«˜å¾·åœ°å›¾åˆå§‹åŒ–å¤±è´¥:",t)}m()},fail:e=>{a("error","at pages/map/map.vue:2086","è·å–ä½ç½®å¤±è´¥",e),uni.showToast({title:"è·å–ä½ç½®ä¿¡æ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥å®šä½æƒé™",icon:"none"})}}),P.value=setInterval((()=>{const e=T.value?5:15,t=Date.now(),o=t-(ye.value||0);o<1e3*e?a("log","at pages/map/map.vue:2109",`è·ä¸Šæ¬¡ä½ç½®æ›´æ–°ä»…${Math.floor(o/1e3)}ç§’ï¼Œæœªè¾¾åˆ°${e}ç§’æ›´æ–°é—´éš”`):(ye.value=t,uni.getLocation({type:"gcj02",success:e=>{var t,o;const s=null==(t=C.value)?void 0:t.latitude,r=null==(o=C.value)?void 0:o.longitude;if(s&&r){const t=Ye(s,r,e.latitude,e.longitude);if(t<5&&!T.value)return void a("log","at pages/map/map.vue:2132",`ä½ç½®å˜åŒ–å¤ªå°(${t.toFixed(2)}ç±³)ï¼Œå¿½ç•¥æ›´æ–°`)}"function"==typeof uni.onCompassChange?uni.onCompassChange((t=>{ie({latitude:e.latitude,longitude:e.longitude},t.direction)})):ie({latitude:e.latitude,longitude:e.longitude}),X.value&&se()}}))}),5e3),x.value=setInterval((()=>{re()}),3e4)}function ce(e,t){if(a("log","at pages/map/map.vue:2169","åˆ›å»ºé»˜è®¤æ ‡è®°ï¼Œç”¨æˆ·ID:",t),!e&&C.value&&(e=[C.value.longitude,C.value.latitude]),e||(a("warn","at pages/map/map.vue:2178","createDefaultMarker: æ— æ³•è·å–ä½ç½®ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®"),e=[116.3,39.9]),!t&&o.userInfo&&a("log","at pages/map/map.vue:2185","ä»ç”¨æˆ·å­˜å‚¨è·å–ID:",t=o.userInfo.id),t||a("warn","at pages/map/map.vue:2191","userIdæœªæä¾›ä¸”æ— æ³•è·å–ï¼Œä½¿ç”¨å›ºå®šæ ‡è¯†ç¬¦:",t="current-user-marker"),!c.value)return a("error","at pages/map/map.vue:2196","createDefaultMarker: åœ°å›¾å¯¹è±¡æœªåˆå§‹åŒ–ï¼Œæ— æ³•åˆ›å»ºæ ‡è®°"),null;const s=c,r=e,n=t;u[n]&&(a("log","at pages/map/map.vue:2207","ç§»é™¤å·²å­˜åœ¨çš„åŒIDæ ‡è®°:",n),s.value.remove(u[n]),delete u[n]);try{a("log","at pages/map/map.vue:2213","ä½¿ç”¨IDåˆ›å»ºé»˜è®¤æ ‡è®°:",n);const e=new AMap.Marker({map:s.value,position:r,icon:new AMap.Icon({size:new AMap.Size(30,30),image:"data:image/svg+xml;charset=utf-8,"+encodeURIComponent('\n\t\t\t\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30">\n\t\t\t\t\t\t\t\t<circle cx="15" cy="15" r="14" fill="#007aff" stroke="white" stroke-width="2"/>\n\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t'),imageSize:new AMap.Size(30,30)}),offset:new AMap.Pixel(-15,-15),zIndex:100,extData:{userId:n,type:"default-user"}});return u[n]=e,setTimeout((()=>{try{const t=e.getContentDom();t?(a("log","at pages/map/map.vue:2239","è®¾ç½®é»˜è®¤æ ‡è®°DOMå±æ€§ï¼Œç”¨æˆ·ID:",n),t.setAttribute("data-user-id",n),t.setAttribute("data-id",`user-marker-${n}`),t.id=`marker-${n}`,t.classList.add("user-marker"),t.classList.add(`user-marker-${n}`),t.setAttribute("data-marker-type","default-user"),t.setAttribute("data-timestamp",(new Date).getTime()),t.addEventListener("click",(e=>{e.stopPropagation(),a("log","at pages/map/map.vue:2252","é»˜è®¤æ ‡è®°DOMç‚¹å‡», ç”¨æˆ·ID:",n),Ee({detail:{markerId:n}})})),t.style.cursor="pointer",t.style.pointerEvents="auto"):a("warn","at pages/map/map.vue:2260","æ— æ³•è·å–é»˜è®¤æ ‡è®°DOM")}catch(t){a("error","at pages/map/map.vue:2263","è®¾ç½®é»˜è®¤æ ‡è®°DOMå±æ€§æ—¶å‡ºé”™:",t)}}),100),oe.value&&oe.value.push(e),e}catch(i){return a("error","at pages/map/map.vue:2274","åˆ›å»ºé»˜è®¤æ ‡è®°æ—¶å‡ºé”™:",i),null}}const ue=(e,t,o)=>{if(!c.value)return a("error","at pages/map/map.vue:2283","åœ°å›¾æœªåˆå§‹åŒ–ï¼Œæ— æ³•åˆ›å»ºæ ‡è®°"),void setTimeout((()=>{c.value?(a("log","at pages/map/map.vue:2287","åœ°å›¾ç°åœ¨å·²åˆå§‹åŒ–ï¼Œé‡è¯•åˆ›å»ºæ ‡è®°"),ue(e,t,o)):a("error","at pages/map/map.vue:2290","é‡è¯•ååœ°å›¾ä»æœªåˆå§‹åŒ–ï¼Œæ ‡è®°åˆ›å»ºå¤±è´¥")}),2e3);e||(a("warn","at pages/map/map.vue:2298","æ ‡è®°çš„userIdä¸ºç©ºï¼Œä½¿ç”¨å›ºå®šæ ‡è¯†ç¬¦"),e="current-user-location");try{a("log","at pages/map/map.vue:2303","å¼€å§‹åˆ›å»ºç”¨æˆ·æ ‡è®°ï¼Œç”¨æˆ·ID:",e);const s=o||te.value,r=d.get(s);if(r)return a("log","at pages/map/map.vue:2311","ä½¿ç”¨ç¼“å­˜çš„å¤´åƒå›¾åƒ:",s.substring(0,50)+"..."),void createMarkerWithProcessedImage(e,t,r);if(s.startsWith("data:image"))return void processImageAndCreateMarker(e,t,s);const n=60,i=56,l=document.createElement("canvas");l.width=n,l.height=n;const m=l.getContext("2d",{willReadFrequently:!0});if(!m)return a("error","at pages/map/map.vue:2336","æ— æ³•è·å–canvasä¸Šä¸‹æ–‡"),ce(t,e);m.clearRect(0,0,n,n);const p=new Image;p.crossOrigin="Anonymous",p.onload=function(){try{m.save(),m.beginPath(),m.arc(n/2,n/2,i/2,0,2*Math.PI),m.closePath(),m.clip();const o=(n-i)/2,r=(n-i)/2;m.drawImage(p,o,r,i,i),m.restore(),m.beginPath(),m.arc(n/2,n/2,i/2,0,2*Math.PI),m.lineWidth=2,m.strokeStyle="#2196F3",m.stroke();const g=l.toDataURL("image/png");d.put(s,g),"object"!=typeof u&&(a("warn","at pages/map/map.vue:2382","userMarkersæœªå®šä¹‰ï¼Œåˆå§‹åŒ–ä¸ºç©ºå¯¹è±¡"),window.userMarkers={});const v=new AMap.Marker({position:t,icon:new AMap.Icon({size:new AMap.Size(n,n),image:g,imageSize:new AMap.Size(n,n)}),offset:new AMap.Pixel(-n/2,-n/2),zIndex:100,extData:{userId:e,type:"user",isUserMarker:!0}});return c.value.add(v),u[e]=v,setTimeout((()=>{try{const t=v.getContentDom();if(t){a("log","at pages/map/map.vue:2414",`ä¸ºæ ‡è®°DOMè®¾ç½®ç”¨æˆ·ID: ${e}`),t.setAttribute("data-user-id",e),t.setAttribute("data-id",`user-marker-${e}`),t.id=`marker-${e}`,t.classList.add("user-marker"),t.classList.add(`user-marker-${e}`),t.setAttribute("data-marker-type","user"),t.setAttribute("data-timestamp",(new Date).getTime()),t.addEventListener("click",(t=>{t.stopPropagation(),a("log","at pages/map/map.vue:2430","ç”¨æˆ·æ ‡è®°DOMç‚¹å‡», ç”¨æˆ·ID:",e),Ne(e)})),t.style.cursor="pointer",t.style.pointerEvents="auto";const o=t.querySelector("img");o&&(o.setAttribute("data-user-id",e),o.setAttribute("data-id",`user-image-${e}`))}else a("warn","at pages/map/map.vue:2445","æ— æ³•è·å–æ ‡è®°DOMå…ƒç´ ")}catch(t){a("error","at pages/map/map.vue:2448","è®¾ç½®æ ‡è®°DOMå±æ€§æ—¶å‡ºé”™:",t)}}),100),v.on("click",(function(t){a("log","at pages/map/map.vue:2454","æ ‡è®°è¢«ç‚¹å‡»ï¼Œç”¨æˆ·ID:",e),Ne(e)})),setTimeout((()=>Ve()),500),a("log","at pages/map/map.vue:2461","æˆåŠŸåˆ›å»ºç”¨æˆ·æ ‡è®°ï¼Œç”¨æˆ·ID:",e),v}catch(o){return a("error","at pages/map/map.vue:2464","ç»˜åˆ¶æ ‡è®°å›¾åƒæ—¶å‡ºé”™:",o),ce(t,e)}},p.onerror=function(o){return a("error","at pages/map/map.vue:2471","åŠ è½½å¤´åƒå›¾åƒå¤±è´¥:",o),ce(t,e)},p.src=o}catch(s){return a("error","at pages/map/map.vue:2478","åˆ›å»ºç”¨æˆ·æ ‡è®°å‡ºé”™:",s),ce(t,e)}},de=()=>__async(this,null,(function*(){if(o.token&&!o.user)try{a("log","at pages/map/map.vue:2488","å‘ç°tokenä½†æ²¡æœ‰ç”¨æˆ·æ•°æ®ï¼Œå°è¯•è·å–ç”¨æˆ·ä¿¡æ¯"),yield o.fetchUserInfo(),a("log","at pages/map/map.vue:2490","æˆåŠŸè·å–ç”¨æˆ·æ•°æ®:",o.user)}catch(e){a("error","at pages/map/map.vue:2492","è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œå¯èƒ½éœ€è¦é‡æ–°ç™»å½•:",e)}if(o.token&&(a("log","at pages/map/map.vue:2498","å·²æœ‰tokenï¼Œå‡å®šç”¨æˆ·å·²ç™»å½• - isAuthenticated:",o.isAuthenticated),!o.isAuthenticated&&!o.user))try{const e=uni.getStorageSync("userInfo");if(e){const t=JSON.parse(e);o.$patch({user:t}),a("log","at pages/map/map.vue:2510","ä»æœ¬åœ°å­˜å‚¨æ¢å¤ç”¨æˆ·ä¿¡æ¯:",t)}else a("log","at pages/map/map.vue:2512","æœ¬åœ°å­˜å‚¨ä¸­æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯")}catch(t){a("error","at pages/map/map.vue:2515","ä»æœ¬åœ°å­˜å‚¨æ¢å¤ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",t)}a("log","at pages/map/map.vue:2521","å½“å‰è®¤è¯çŠ¶æ€:",{"tokenå­˜åœ¨":!!o.token,"userå­˜åœ¨":!!o.user,isAuthenticated:o.isAuthenticated})}));function me(){var e,t;try{if(!C.value||void 0===C.value.latitude)return a("error","at pages/map/map.vue:2533","å½“å‰ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ï¼Œæ— æ³•æ·»åŠ æ ‡è®°"),void uni.showToast({title:"æ— æ³•è·å–ä½ç½®ä¿¡æ¯",icon:"none"});let s=(null==(e=o.userInfo)?void 0:e.id)||(null==(t=o.user)?void 0:t._id)||"current-user-location";if(a("log","at pages/map/map.vue:2543","ä½¿ç”¨ç”¨æˆ·IDåˆ›å»ºæ ‡è®°:",s),c.value){const e=c.value.getAllOverlays("marker");let t=!1;e.forEach((e=>{var o,r;try{const n=null==(r=null==(o=null==e?void 0:e.getExtData)?void 0:o.call(e))?void 0:r.userId;n!==s&&"current-user-location"!==n||(a("log","at pages/map/map.vue:2556",`å‘ç°å·²å­˜åœ¨æ ‡è®°(${n})ï¼Œç§»é™¤ä»¥é¿å…é‡å¤`),c.value.remove(e),t=!0)}catch(n){a("warn","at pages/map/map.vue:2561","æ£€æŸ¥æ ‡è®°æ—¶å‡ºé”™:",n)}})),t&&a("log","at pages/map/map.vue:2566","å·²ç§»é™¤æ—§æ ‡è®°ï¼Œåˆ›å»ºæ–°æ ‡è®°")}const r=[C.value.longitude,C.value.latitude],n=te.value;a("log","at pages/map/map.vue:2574","åˆ›å»ºç”¨æˆ·æ ‡è®°ï¼Œä½¿ç”¨å¤´åƒURL:",n),ue(s,r,n),u["current-user-location"]&&"current-user-location"!==s&&delete u["current-user-location"],a("log","at pages/map/map.vue:2584","å·²å®Œæˆåˆ›å»ºç”¨æˆ·æ ‡è®°")}catch(s){a("error","at pages/map/map.vue:2586","åˆ›å»ºæ ‡è®°æ—¶å‡ºé”™:",s),uni.showToast({title:"åˆ›å»ºä½ç½®æ ‡è®°å¤±è´¥",icon:"none"})}}function pe(e=!1){var t;if(!C.value||void 0===C.value.latitude)return a("error","at pages/map/map.vue:2992","å½“å‰ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ï¼Œæ— æ³•æ·»åŠ æ ‡è®°"),void uni.showToast({title:"æ— æ³•è·å–ä½ç½®ä¿¡æ¯",icon:"none"});e&&(a("log","at pages/map/map.vue:3002","å¼ºåˆ¶æ¸…é™¤å¤´åƒç¼“å­˜ï¼Œä½¿ç”¨æœ€æ–°ä¸Šä¼ çš„å¤´åƒ"),d.clear());const s=(null==(t=o.userInfo)?void 0:t.id)||"current-user-location",r=[C.value.longitude,C.value.latitude];if(c.value){const e=c.value.getAllOverlays("marker"),t=[];e.forEach((e=>{var s,r;try{const a=null==(r=null==(s=null==e?void 0:e.getExtData)?void 0:s.call(e))?void 0:r.userId;("current-user-location"===a||o.userInfo&&a===o.userInfo.id)&&t.push(e)}catch(n){a("error","at pages/map/map.vue:3024","å¤„ç†æ ‡è®°æ—¶å‡ºé”™:",n)}})),t.length>0&&(a("log","at pages/map/map.vue:3030",`ç§»é™¤ ${t.length} ä¸ªç”¨æˆ·æ ‡è®°`),c.value.remove(t),t.forEach((e=>{var t,a;const o=null==(a=null==(t=null==e?void 0:e.getExtData)?void 0:t.call(e))?void 0:a.userId;o&&u[o]&&delete u[o]}))),a("log","at pages/map/map.vue:3043","åˆ›å»ºæ–°çš„ç”¨æˆ·æ ‡è®°ï¼Œç”¨æˆ·ID:",s);const n=te.value;ue(s,r,n)}}e.onMounted((()=>__async(this,null,(function*(){var e;if(a("log","at pages/map/map.vue:2619","ç»„ä»¶æŒ‚è½½å¼€å§‹..."),setTimeout((()=>{_e()}),1e3),Se=setInterval((()=>{Ve(),(new Date).getSeconds()%10==0&&_e()}),2e3),i.restoreMarkerCache(),yield de(),a("log","at pages/map/map.vue:2643","åˆå§‹ç”¨æˆ·ä¿¡æ¯:",o.userInfo||o.user),a("log","at pages/map/map.vue:2644","åˆå§‹å¤´åƒè·¯å¾„:",null==(e=o.userInfo||o.user)?void 0:e.avatar),a("log","at pages/map/map.vue:2645","ç”¨æˆ·è®¤è¯çŠ¶æ€:",o.isAuthenticated),!o.user&&!o.userInfo){a("log","at pages/map/map.vue:2649","ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´ï¼Œå°è¯•é‡æ–°è·å–...");try{yield o.fetchUserInfo(),a("log","at pages/map/map.vue:2652","å·²é‡æ–°è·å–ç”¨æˆ·ä¿¡æ¯:",o.user)}catch(n){a("error","at pages/map/map.vue:2654","è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",n)}}const t=()=>__async(this,null,(function*(){try{a("log","at pages/map/map.vue:2661","æ£€æŸ¥åç«¯APIè¿æ¥çŠ¶æ€...");a("log","at pages/map/map.vue:2676","åç«¯APIè¿æ¥æ­£å¸¸:",yield S({url:"/api",method:"GET",timeout:5e3}).catch((e=>S({url:"/api/users/ping",method:"GET",timeout:5e3})))),l.value=!0}catch(e){a("error","at pages/map/map.vue:2679","åç«¯APIè¿æ¥å¤±è´¥:",e),l.value=!1,uni.showModal({title:"è¿æ¥é—®é¢˜",content:"æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚",showCancel:!1})}})),s=e=>{if(e&&void 0!==e.latitude)try{if(a("log","at pages/map/map.vue:2725","ä½¿ç”¨ç¡®å®šä½ç½®åˆå§‹åŒ–åœ°å›¾:",e),void 0===window.AMap){a("error","at pages/map/map.vue:2728","AMapæœªåŠ è½½"),window.onAMapLoaded=()=>s(e);const t=document.createElement("script");return t.type="text/javascript",t.async=!0,t.src="https://webapi.amap.com/maps?v=2.0&key=9ea84b4333b114c188a67cb42564a48f&callback=onAMapLoaded",void document.head.appendChild(t)}if(!document.getElementById("map-container"))return void a("error","at pages/map/map.vue:2743","æ‰¾ä¸åˆ°åœ°å›¾å®¹å™¨å…ƒç´ (#map-container)");c.value=new window.AMap.Map("map-container",{zoom:16,center:[e.longitude,e.latitude],resizeEnable:!0,animateEnable:!0}),"undefined"!=typeof window&&(window.__dogRunMapInstance=c.value),a("log","at pages/map/map.vue:2760","é«˜å¾·åœ°å›¾åˆå§‹åŒ–å®Œæˆ"),c.value.on("complete",(()=>{a("log","at pages/map/map.vue:2764","åœ°å›¾åŠ è½½å®Œæˆï¼Œåˆ›å»ºç”¨æˆ·æ ‡è®°å’ŒåŠ è½½æ ‡è®°æ•°æ®"),c.value.setCenter([e.longitude,e.latitude]),setTimeout((()=>{me(),y(),re()}),800)})),c.value.on("click",(e=>{a("log","at pages/map/map.vue:2781","é«˜å¾·åœ°å›¾ç‚¹å‡»äº‹ä»¶:",e),we({detail:{x:e.pixel.x,y:e.pixel.y}})})),setTimeout(Ve,2e3)}catch(t){a("error","at pages/map/map.vue:2795","åˆå§‹åŒ–åœ°å›¾å‡ºé”™:",t),uni.showToast({title:"åœ°å›¾åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}else a("error","at pages/map/map.vue:2720","åˆå§‹åŒ–åœ°å›¾éœ€è¦æœ‰æ•ˆçš„ä½ç½®ä¿¡æ¯")};(()=>{__async(this,null,(function*(){uni.showLoading({title:"æ­£åœ¨å®šä½...",mask:!0});try{const o=uni.getStorageSync("last_known_location");let n=null;if(o)try{const e=JSON.parse(o);e&&e.timestamp&&Date.now()-e.timestamp<864e5&&(n={latitude:e.latitude,longitude:e.longitude},a("log","at pages/map/map.vue:2825","ä½¿ç”¨ç¼“å­˜ä½ç½®ä½œä¸ºä¸´æ—¶ä½ç½®",n),C.value=n)}catch(e){a("warn","at pages/map/map.vue:2831","è§£æç¼“å­˜ä½ç½®å¤±è´¥",e)}const i=yield((e=8e3)=>new Promise(((t,o)=>{const s=setTimeout((()=>{a("log","at pages/map/map.vue:2695","è·å–ä½ç½®è¶…æ—¶"),o(new Error("è·å–ä½ç½®è¶…æ—¶"))}),e);uni.getLocation({type:"gcj02",success:e=>{clearTimeout(s),t({latitude:e.latitude,longitude:e.longitude})},fail:e=>{clearTimeout(s),a("error","at pages/map/map.vue:2710","è·å–ä½ç½®å¤±è´¥:",e),o(e)}})})))(1e4).catch((e=>(a("warn","at pages/map/map.vue:2837","è·å–å®é™…ä½ç½®å¤±è´¥ï¼Œä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆ",e),null)));uni.hideLoading(),i?(C.value=i,a("log","at pages/map/map.vue:2847","è·å–åˆ°å®é™…ä½ç½®:",i),uni.setStorageSync("last_known_location",JSON.stringify(__spreadProps(__spreadValues({},i),{timestamp:Date.now()})))):C.value||(C.value={latitude:31.31,longitude:121.52},a("warn","at pages/map/map.vue:2857","æ— æ³•è·å–ä½ç½®ï¼Œä½¿ç”¨é»˜è®¤ä¸Šæµ·ä½ç½®")),le(),s(C.value),function(){__async(this,null,(function*(){try{const e=yield r.fetchPets();e&&Array.isArray(e)?H.value=e:H.value=[]}catch(e){a("error","at pages/map/map.vue:1927","è·å–æˆ‘çš„å® ç‰©å¤±è´¥",e),H.value=[]}}))}(),t()}catch(o){uni.hideLoading(),a("error","at pages/map/map.vue:2874","åˆå§‹åŒ–åœ°å›¾æµç¨‹å‡ºé”™:",o),uni.showToast({title:"å®šä½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®",icon:"none"}),C.value||(C.value={latitude:31.31,longitude:121.52}),le(),s(C.value)}}))})(),a("log","at pages/map/map.vue:2896","ç»„ä»¶æŒ‚è½½å®Œæˆ")})))),s((()=>{a("log","at pages/map/map.vue:2901","åœ°å›¾é¡µé¢æ˜¾ç¤º"),c.value&&(a("log","at pages/map/map.vue:2904","åˆ·æ–°åœ°å›¾æ ‡è®°æ•°æ®"),y())})),e.onBeforeUnmount((()=>{P.value&&clearInterval(P.value),x.value&&clearInterval(x.value),j.value&&clearInterval(j.value),"function"==typeof uni.stopDeviceMotionListening&&uni.stopDeviceMotionListening({success:()=>{a("log","at pages/map/map.vue:2977","è®¾å¤‡æ–¹å‘ç›‘å¬å·²åœæ­¢")}}),"function"==typeof uni.offCompassChange&&uni.offCompassChange()}));const ge=e.ref(!1),ve=e.ref("æœªå…±äº«");function he(){return __async(this,null,(function*(){try{a("log","at pages/map/map.vue:3332","å¼€å§‹ä¿å­˜é›ç‹—è®°å½•...");const t=H.value.length>0?H.value[0]._id||H.value[0].id:null,o=H.value.length>0?H.value[0]:null;if(!t)return a("warn","at pages/map/map.vue:3339","æ²¡æœ‰å® ç‰©ä¿¡æ¯ï¼Œæ— æ³•ä¿å­˜é›ç‹—è®°å½•"),uni.showToast({title:"è¯·å…ˆæ·»åŠ å® ç‰©",icon:"none"}),Promise.reject(new Error("æ²¡æœ‰å® ç‰©ä¿¡æ¯"));const s={pet:{_id:t,name:(null==o?void 0:o.name)||"æœªå‘½åå® ç‰©",avatar:(null==o?void 0:o.avatar)||"/static/images/default-pet.png"},distance:D.value,duration:B.value,startTime:new Date(U.value).toISOString(),endTime:(new Date).toISOString(),route:F.value,mapImageUrl:"/static/images/default-map.png"};a("log","at pages/map/map.vue:3362","å‘é€é›ç‹—è®°å½•æ•°æ®:",{"å® ç‰©ID":s.pet._id,"å® ç‰©åç§°":s.pet.name,"è·ç¦»":`${s.distance}ç±³ (${(s.distance/1e3).toFixed(2)}å…¬é‡Œ)`,"æ—¶é•¿":`${s.duration}ç§’ (${Math.floor(s.duration/60)}åˆ†${s.duration%60}ç§’)`,"å¼€å§‹æ—¶é—´":new Date(s.startTime).toLocaleString(),"ç»“æŸæ—¶é—´":new Date(s.endTime).toLocaleString(),"è·¯çº¿ç‚¹æ•°":s.route.length}),a("log","at pages/map/map.vue:3373","è°ƒç”¨API: api.walk.startWalk, URL: /api/walks/start");const r=yield A.walk.startWalk(s);a("log","at pages/map/map.vue:3375","é›ç‹—è®°å½•ä¿å­˜ç»“æœ:",r);let n=null;if(r&&0===r.code&&r.data?(n=r.data.walkId,a("log","at pages/map/map.vue:3383","ä»æ ‡å‡†æ ¼å¼è·å–walkId:",n)):r&&(r._id||r.id)?(n=r._id||r.id,a("log","at pages/map/map.vue:3387","ä»å¯¹è±¡å±æ€§è·å–walkId:",n)):r&&r.data&&(r.data._id||r.data.id||r.data.walkId)&&(n=r.data._id||r.data.id||r.data.walkId,a("log","at pages/map/map.vue:3391","ä»åµŒå¥—å¯¹è±¡è·å–walkId:",n)),!n)return a("error","at pages/map/map.vue:3395","æ— æ³•ä»APIå“åº”è·å–walkId:",r),Promise.reject(new Error("æ— æ³•è·å–é›ç‹—è®°å½•ID"));a("log","at pages/map/map.vue:3399","é›ç‹—è®°å½•åˆ›å»ºæˆåŠŸï¼ŒID:",n),yield new Promise((e=>setTimeout(e,500)));try{a("log","at pages/map/map.vue:3406",`è°ƒç”¨API: api.walk.endWalk, URL: /api/walks/${n}/end`);a("log","at pages/map/map.vue:3413","é›ç‹—è®°å½•ç»“æŸç»“æœ:",yield A.walk.endWalk(n,{distance:D.value,duration:B.value,endTime:(new Date).toISOString()}))}catch(e){a("error","at pages/map/map.vue:3416","ç»“æŸé›ç‹—è®°å½•å¤±è´¥ï¼Œä½†åˆå§‹è®°å½•å·²ä¿å­˜:",e)}return uni.showToast({title:"è®°å½•å·²ä¿å­˜",icon:"success"}),setTimeout((()=>{a("log","at pages/map/map.vue:3427","å‡†å¤‡è·³è½¬åˆ°é›ç‹—è®°å½•é¡µé¢..."),uni.navigateTo({url:"/pages/walk/history",success:()=>{a("log","at pages/map/map.vue:3431","æˆåŠŸè·³è½¬åˆ°é›ç‹—è®°å½•é¡µé¢")},fail:e=>{a("error","at pages/map/map.vue:3434","è·³è½¬åˆ°é›ç‹—è®°å½•é¡µé¢å¤±è´¥:",e)}})}),3e3),Promise.resolve(n)}catch(o){if(a("error","at pages/map/map.vue:3441","ä¿å­˜é›ç‹—è®°å½•å‡ºé”™:",o),a("error","at pages/map/map.vue:3442","é”™è¯¯è¯¦æƒ…:",o.message||"æœªçŸ¥é”™è¯¯"),o.statusCode&&(a("error","at pages/map/map.vue:3444","HTTPçŠ¶æ€ç :",o.statusCode),404===o.statusCode)){a("error","at pages/map/map.vue:3447","APIç«¯ç‚¹ä¸å­˜åœ¨ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨");try{const e=t("walkStorage")||require("@/utils/walkStorage.js").default,o={pet:{_id:H.value.length>0?H.value[0]._id||H.value[0].id:"default-pet",name:H.value.length>0?H.value[0].name:"æœªå‘½åå® ç‰©",avatar:H.value.length>0?H.value[0].avatar:"/static/images/default-pet.png"},distance:D.value,duration:B.value,startTime:new Date(U.value).toISOString(),endTime:(new Date).toISOString(),route:F.value};a("log","at pages/map/map.vue:3467","å°è¯•ä½¿ç”¨æœ¬åœ°å­˜å‚¨ä¿å­˜é›ç‹—è®°å½•");const s=e.saveWalkRecord(o);if(a("log","at pages/map/map.vue:3469","æœ¬åœ°å­˜å‚¨ä¿å­˜ç»“æœ:",s),s&&0===s.code&&s.data&&s.data.walkId)return Promise.resolve(s.data.walkId);throw new Error("æœ¬åœ°å­˜å‚¨ä¿å­˜å¤±è´¥")}catch(s){a("error","at pages/map/map.vue:3477","ä½¿ç”¨æœ¬åœ°å­˜å‚¨ä¿å­˜å¤±è´¥:",s)}}throw uni.showToast({title:"ä¿å­˜è®°å½•å¤±è´¥: "+(o.message||"æœªçŸ¥é”™è¯¯"),icon:"none",duration:3e3}),o}}))}const fe=e.ref(!1),ye=e.ref(0);function we(e){if(a("log","at pages/map/map.vue:3666","åœ°å›¾ç‚¹å‡»äº‹ä»¶:",e),fe.value)return void a("log","at pages/map/map.vue:3670","åœ°å›¾æ­£åœ¨æ‹–åŠ¨ï¼Œå¿½ç•¥ç‚¹å‡»");const{x:t,y:o}=e.detail;if(void 0!==t&&void 0!==o){try{const e=document.querySelectorAll(".amap-marker");if(e.length>0){a("log","at pages/map/map.vue:3688","æ‰¾åˆ°é«˜å¾·åœ°å›¾æ ‡è®°:",e.length,"ä¸ª");for(const s of e){const e=s.getBoundingClientRect();if(t>=e.left&&t<=e.right&&o>=e.top&&o<=e.bottom){a("log","at pages/map/map.vue:3696","ç‚¹å‡»å‘½ä¸­æ ‡è®°å…ƒç´ :",s);const e=s.getAttribute("data-id")||s.id||s.getAttribute("id");if(e)return a("log","at pages/map/map.vue:3705","è§¦å‘æ ‡è®°ç‚¹å‡»:",e),void Ee({detail:{markerId:e}});const r=ke(t,o);if(r)return a("log","at pages/map/map.vue:3713","æ‰¾åˆ°æœ€æ¥è¿‘çš„ç”¨æˆ·:",r.nickname||r.username),void Ee({detail:{markerId:r.id}})}}}const s=ke(t,o);if(s)return a("log","at pages/map/map.vue:3724","æ‰¾åˆ°æœ€æ¥è¿‘çš„ç”¨æˆ·:",s.nickname||s.username),void Ee({detail:{markerId:s.id}})}catch(s){a("error","at pages/map/map.vue:3729","å¤„ç†åœ°å›¾ç‚¹å‡»äº‹ä»¶å‡ºé”™:",s)}L.value&&(L.value=!1)}else a("log","at pages/map/map.vue:3679","ç‚¹å‡»äº‹ä»¶æ²¡æœ‰åæ ‡ä¿¡æ¯")}function ke(e,t){if(!I.value||!I.value.length)return null;const o=document.getElementById("map");if(!o)return null;const s=o.getBoundingClientRect(),r=s.width,n=s.height,i=e-(s.left+r/2),l=t-(s.top+n/2),c=_.value,u=20/c*5e-6,d=20/c*5e-6/Math.cos(C.value.latitude*Math.PI/180),m=C.value.latitude-l*u,p=C.value.longitude+i*d;a("log","at pages/map/map.vue:3768","ç‚¹å‡»ç»çº¬åº¦ä¼°è®¡:",{lat:m,lng:p});let g=null,v=1/0;return I.value.forEach((e=>{if(!e.latitude||!e.longitude)return;const t=Math.sqrt(Math.pow((e.latitude-m)/u,2)+Math.pow((e.longitude-p)/d,2));t<30&&t<v&&(v=t,g=e)})),g}function Ee(e){return __async(this,null,(function*(){var t,o,s;try{let r=e.markerId||(null==(t=e.detail)?void 0:t.markerId);if(!r&&(null==(o=e.detail)?void 0:o.marker)&&(r=e.detail.marker.id),!r&&(null==(s=e.detail)?void 0:s.nativeEvent)){const t=e.detail.nativeEvent.target;t&&t.dataset&&(r=t.dataset.userId||t.dataset.id)}r?(a("log","at pages/map/map.vue:3935","è·å–åˆ°æ ‡è®°ID:",r),yield Ne(r)):(a("error","at pages/map/map.vue:3938","æ— æ³•è·å–æ ‡è®°ID"),Array.isArray(I.value)&&I.value.length>0?(a("log","at pages/map/map.vue:3941","ä½¿ç”¨ç¬¬ä¸€ä¸ªé™„è¿‘ç”¨æˆ·ä½œä¸ºå¤‡é€‰"),yield Ne(I.value[0].id)):uni.showToast({title:"æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯",icon:"none"}))}catch(r){a("error","at pages/map/map.vue:3952","æ ‡è®°ç‚¹å‡»å¤„ç†å‡ºé”™:",r),uni.showToast({title:"æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}}))}function Ne(e){return __async(this,null,(function*(){a("log","at pages/map/map.vue:3965","å¤„ç†ç”¨æˆ·æ ‡è®°ç‚¹å‡»äº‹ä»¶, ç”¨æˆ·ID:",e);try{yield Ce(e)}catch(t){a("error","at pages/map/map.vue:3971","å¤„ç†ç”¨æˆ·æ ‡è®°ç‚¹å‡»å¤±è´¥:",t)}}))}function Ve(){try{const e=document.querySelectorAll(".amap-marker");if(e.length>0){a("log","at pages/map/map.vue:3981","å‘ç°åœ°å›¾æ ‡è®°å…ƒç´ :",e.length,"ä¸ª");let t=[];e.forEach((e=>{var a;const o=e.getAttribute("data-user-id")||(e.id?null==(a=e.id.match(/marker-([^"\s]+)/))?void 0:a[1]:null);o&&t.push(o)})),a("log","at pages/map/map.vue:3990","åœ°å›¾ä¸Šçš„ç”¨æˆ·ID:",t),setTimeout((()=>{e.forEach((e=>{if(!e.hasAttribute("data-click-handler")){e.addEventListener("click",(t=>{t.stopPropagation(),a("log","at pages/map/map.vue:4001","æ ‡è®°ç‚¹å‡»äº‹ä»¶ (ç›´æ¥):",e);let o=e.getAttribute("data-user-id");if(!o&&e.className){const t=e.className.match(/user-marker-([^"\s]+)/);t&&t[1]&&(o=t[1])}if(!o&&e.id){const t=e.id.match(/marker-([^"\s]+)/);t&&t[1]&&(o=t[1])}if(!o){const t=e.querySelector("img");t&&(o=t.getAttribute("data-user-id"))}a("log","at pages/map/map.vue:4030","å°è¯•æå–çš„ç”¨æˆ·ID:",o),o?(a("log","at pages/map/map.vue:4033","æ‰¾åˆ°ç”¨æˆ·IDï¼Œè§¦å‘æ ‡è®°ç‚¹å‡»äº‹ä»¶:",o),Ne(o)):I.value&&I.value.length>0&&(a("log","at pages/map/map.vue:4038","æ— æ³•è¯†åˆ«ç”¨æˆ·IDï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªé™„è¿‘ç”¨æˆ·"),Ne(I.value[0].id))})),e.setAttribute("data-click-handler","true"),e.style.cursor="pointer",e.style.pointerEvents="auto",e.style.zIndex="999";const t=e.querySelector(".amap-icon");if(t){t.style.borderRadius="50%",t.style.overflow="hidden";const o=t.querySelector("img");if(o){const t=e.getAttribute("data-user-id");t&&(o.setAttribute("data-user-id",t),a("log","at pages/map/map.vue:4065","è®¾ç½®å›¾åƒå…ƒç´ data-user-idå±æ€§:",t)),o.style.borderRadius="50%",o.style.width="100%",o.style.height="100%",o.style.objectFit="cover",o.addEventListener("click",(t=>{t.stopPropagation(),a("log","at pages/map/map.vue:4077","å›¾åƒç‚¹å‡»äº‹ä»¶");const s=o.getAttribute("data-user-id")||e.getAttribute("data-user-id");a("log","at pages/map/map.vue:4083","å›¾åƒç‚¹å‡» - æå–çš„ç”¨æˆ·ID:",s),s&&(a("log","at pages/map/map.vue:4086","æ‰¾åˆ°å›¾åƒç”¨æˆ·IDï¼Œå¤„ç†æ ‡è®°ç‚¹å‡»:",s),Ne(s))}))}}}}))}),100)}}catch(e){a("error","at pages/map/map.vue:4097","å¤„ç†åœ°å›¾æ ‡è®°å‡ºé”™:",e)}}let Se;function _e(){var e,t;if(a("log","at pages/map/map.vue:4135","æ‰§è¡Œæ ‡è®°æ¸…ç†..."),!c.value)return;const s=c.value.getAllOverlays("marker");if(!s||0===s.length)return void a("log","at pages/map/map.vue:4141","åœ°å›¾ä¸Šæ²¡æœ‰æ ‡è®°ï¼Œæ— éœ€æ¸…ç†");a("log","at pages/map/map.vue:4145",`åœ°å›¾ä¸Šå…±æœ‰ ${s.length} ä¸ªæ ‡è®°`);const r=(null==(e=o.userInfo)?void 0:e.id)||(null==(t=o.user)?void 0:t._id);if(!r)return void a("log","at pages/map/map.vue:4150","æœªæ‰¾åˆ°å½“å‰ç”¨æˆ·IDï¼Œè·³è¿‡æ ‡è®°æ¸…ç†");a("log","at pages/map/map.vue:4154","å½“å‰ç”¨æˆ·ID:",r);const n=[r,"current-user-location"],i=[];s.forEach((e=>{var t,o;try{const a=(null==(o=null==(t=null==e?void 0:e.getExtData)?void 0:t.call(e))?void 0:o.userId)||"æœªçŸ¥";i.push(a)}catch(s){a("error","at pages/map/map.vue:4166","è·å–æ ‡è®°IDå‡ºé”™:",s)}})),a("log","at pages/map/map.vue:4169","åœ°å›¾ä¸Šçš„æ ‡è®°ID:",i);const l=[];s.forEach((e=>{var t,o;try{const s=null==(o=null==(t=null==e?void 0:e.getExtData)?void 0:t.call(e))?void 0:o.userId;if(!s)return a("log","at pages/map/map.vue:4177","æ‰¾åˆ°æ— IDæ ‡è®°ï¼Œç§»é™¤"),void c.value.remove(e);n.includes(s)?(a("log","at pages/map/map.vue:4184",`ä¿ç•™æ ‡è®°ID: ${s}`),l.push(s)):(a("log","at pages/map/map.vue:4187",`ç§»é™¤æ ‡è®°ID: ${s}`),c.value.remove(e),u[s]&&delete u[s])}catch(s){a("error","at pages/map/map.vue:4196","æ¸…ç†æ ‡è®°æ—¶å‡ºé”™:",s)}})),a("log","at pages/map/map.vue:4200",`æ¸…ç†å®Œæˆï¼Œä¿ç•™æ ‡è®°: ${l.join(", ")}`)}e.watch((()=>o.isAuthenticated),(e=>{a("log","at pages/map/map.vue:4106","ç”¨æˆ·ç™»å½•çŠ¶æ€å˜æ›´:",e),e?(a("log","at pages/map/map.vue:4109","ç”¨æˆ·å·²ç™»å½•ï¼Œè·å–å® ç‰©æ•°æ®"),r.fetchPets().then((e=>{a("log","at pages/map/map.vue:4111","ç™»å½•åè·å–å® ç‰©æ•°æ®æˆåŠŸ:",e),H.value=e})).catch((e=>{a("error","at pages/map/map.vue:4114","ç™»å½•åè·å–å® ç‰©æ•°æ®å¤±è´¥:",e)}))):(a("log","at pages/map/map.vue:4118","ç”¨æˆ·å·²ç™»å‡ºï¼Œæ¸…ç©ºå® ç‰©æ•°æ®"),H.value=[])})),e.onBeforeUnmount((()=>{Se&&clearInterval(Se)}));const Ce=e=>__async(this,null,(function*(){a("log","at pages/map/map.vue:4438","é€‰ä¸­ç”¨æˆ·æ ‡è®°:",e);try{let s,n=[];if(e===o.userId)s=__spreadProps(__spreadValues({},o.user),{isCurrentUser:!0}),n=r.pets||[];else{if(s=yield A.user.getUserById(e),!s)return void a("error","at pages/map/map.vue:4484","æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯");s=__spreadProps(__spreadValues({},s),{isCurrentUser:!1});try{n=yield A.pet.getPetsByUser(e)}catch(t){a("error","at pages/map/map.vue:4466","è·å–ç”¨æˆ·å® ç‰©å¤±è´¥:",t),n=[]}try{if(o.isAuthenticated){const t=yield o.fetchUserInfo();W.value=t.following&&t.following.some((t=>t===e||t._id&&t._id===e))}}catch(t){a("error","at pages/map/map.vue:4480","æ£€æŸ¥å…³æ³¨çŠ¶æ€å¤±è´¥:",t),W.value=!1}}$.value=s,O.value=n,L.value=!0}catch(t){a("error","at pages/map/map.vue:4496","è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",t)}}));return{userStore:o,petStore:r,mapScale:_,currentLocation:C,markers:b,allMarkers:oe,nearbyUsers:I,isWalking:T,walkingPath:M,walkingDistance:D,walkingDuration:B,showUserPopup:L,selectedUser:$,selectedUserPets:O,selectedUserFollowStatus:R,isFollowing:W,showWalkSummary:z,walkShareContent:J,myPets:H,myPetsNames:q,selectedPetIndex:G,showDebug:Q,debugInfo:K,showLocationSharingTip:Y,isLocationShared:X,userAvatar:te,userHeading:Z,defaultAvatarBase64:ee,userMarker:ae,locationSharingStatusVisible:ge,locationSharingStatus:ve,formatDuration:Qe,calculatePace:Ke,forceRefreshMarker:pe,toggleMarker:me,toggleWalkingMode:function(){if(a("log","at pages/map/map.vue:3493","åˆ‡æ¢é›ç‹—æ¨¡å¼ï¼Œå½“å‰çŠ¶æ€:",T.value),T.value){T.value=!1,clearInterval(j.value),j.value=null,X.value=!1,ge.value=!1,a("log","at pages/map/map.vue:3507","é›ç‹—ç»“æŸï¼Œæ—¶é•¿:",B.value,"ç§’"),a("log","at pages/map/map.vue:3508","é›ç‹—è·ç¦»:",D.value,"ç±³");const e=5;B.value>=e?(!function(){const e=(D.value/1e3).toFixed(2),t=Qe(B.value),a=Ke(D.value,B.value),o=q.value.length?q.value.join("ã€"):"æˆ‘çš„å® ç‰©";J.value=`æˆ‘å¸¦${o}é›äº†${e}å…¬é‡Œï¼Œç”¨æ—¶${t}ï¼Œé…é€Ÿ${a}ï¼`}(),he().then((e=>{a("log","at pages/map/map.vue:3520","é›ç‹—è®°å½•ä¿å­˜æˆåŠŸï¼ŒID:",e),z.value=!0,uni.showToast({title:"è®°å½•å·²ä¿å­˜",icon:"success",duration:2e3})})).catch((e=>{a("error","at pages/map/map.vue:3530","ä¿å­˜é›ç‹—è®°å½•å¤±è´¥:",e),z.value=!0,uni.showToast({title:"è®°å½•ä¿å­˜å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨",icon:"none",duration:2e3})}))):(a("log","at pages/map/map.vue:3542","é›ç‹—æ—¶é—´å¤ªçŸ­ï¼Œä¸ä¿å­˜è®°å½•"),uni.showToast({title:`é›ç‹—æ—¶é—´å¤ªçŸ­ï¼ˆå°‘äº${e}ç§’ï¼‰ï¼Œæœªä¿å­˜è®°å½•`,icon:"none",duration:2e3}))}else Y.value=!0},confirmLocationSharing:function(){try{X.value=!0,Y.value=!1,a("log","at pages/map/map.vue:3583","å·²å¯ç”¨ä½ç½®å…±äº«ï¼ˆæœ¬åœ°ï¼‰"),uni.showToast({title:"å·²å¼€å§‹ä½ç½®å…±äº«",icon:"success"}),se(),function(){T.value=!0,U.value=Date.now(),D.value=0,B.value=0,F.value=[{latitude:C.value.latitude,longitude:C.value.longitude}],M.value=[{points:[{latitude:C.value.latitude,longitude:C.value.longitude}],color:"#007AFF",width:4}],j.value&&clearInterval(j.value);a("log","at pages/map/map.vue:3625","å¼€å§‹é›ç‹—ï¼Œè®¾ç½®è®¡æ—¶å™¨"),j.value=setInterval((()=>{const e=Date.now(),t=Math.floor((e-U.value)/1e3);B.value=t,t%30==0&&t>0&&a("log","at pages/map/map.vue:3633","é›ç‹—è¿›è¡Œä¸­ï¼Œå·²ç»",t,"ç§’")}),1e3),a("log","at pages/map/map.vue:3638","é›ç‹—æ¨¡å¼å·²å¼€å§‹:",{"å¼€å§‹æ—¶é—´":new Date(U.value).toLocaleTimeString(),"åˆå§‹ä½ç½®":F.value[0]})}()}catch(e){a("error","at pages/map/map.vue:3597","å¼€å§‹ä½ç½®å…±äº«å‡ºé”™:",e)}},cancelLocationSharing:function(){try{X.value=!1,Y.value=!1,a("log","at pages/map/map.vue:3563","å·²ç¦ç”¨ä½ç½®å…±äº«ï¼ˆæœ¬åœ°ï¼‰"),uni.showToast({title:"å·²åœæ­¢ä½ç½®å…±äº«",icon:"none"})}catch(e){a("error","at pages/map/map.vue:3571","åœæ­¢ä½ç½®å…±äº«å‡ºé”™:",e)}},saveWalkRecord:he,onMarkerTap:Ee,onMapTap:we,onMapRegionChange:function(e){a("log","at pages/map/map.vue:3795","åœ°å›¾åŒºåŸŸå˜æ›´:",e),"begin"===e.type&&"drag"===e.causedBy?(a("log","at pages/map/map.vue:3652","åœ°å›¾å¼€å§‹æ‹–åŠ¨"),fe.value=!0):"end"===e.type&&"drag"===e.causedBy&&(a("log","at pages/map/map.vue:3658","åœ°å›¾ç»“æŸæ‹–åŠ¨"),setTimeout((()=>{fe.value=!1}),50))},onMapUpdated:function(e){if(a("log","at pages/map/map.vue:3841","åœ°å›¾æ›´æ–°äº‹ä»¶è§¦å‘"),Q.value)try{K.value={markerCount:b.value.length+oe.value.length,markerIds:b.value.map((e=>e.id)).concat(oe.value.map((e=>e.id))),coords:C.value?[C.value.latitude.toFixed(6),C.value.longitude.toFixed(6)]:[]}}catch(s){a("error","at pages/map/map.vue:3848","æ›´æ–°è°ƒè¯•ä¿¡æ¯é”™è¯¯:",s)}const t=n.sharingEnabled;if(X.value=t,a("log","at pages/map/map.vue:3855","ä½ç½®å…±äº«çŠ¶æ€:",X.value?"å·²å¼€å¯":"å·²å…³é—­"),!window._lastMarkerCheck||Date.now()-window._lastMarkerCheck>3e4){window._lastMarkerCheck=Date.now();try{const e=oe.value.some((e=>"user-location"===e.id));if(C.value&&void 0!==C.value.latitude&&null!==C.value.latitude&&!e){a("log","at pages/map/map.vue:3871","æ·»åŠ ç”¨æˆ·æ ‡è®°...");const e=te.value,t=o.userInfo?o.userInfo.id:"user-location",s=[C.value.longitude,C.value.latitude];if(e.startsWith("data:image/"))ue(t,s,e);else{const o=new Image;o.crossOrigin="anonymous",o.onload=()=>{ue(t,s,e)},o.onerror=()=>{a("error","at pages/map/map.vue:3895","åŠ è½½ç”¨æˆ·å¤´åƒå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ"),ue(t,s,ee)},o.src=e,setTimeout((()=>{o.complete&&0!==o.naturalWidth||ue(t,s,ee)}),3e3)}}}catch(s){a("error","at pages/map/map.vue:3909","æ·»åŠ æ ‡è®°é”™è¯¯:",s)}}},hideUserPopup:function(){a("log","at pages/map/map.vue:4385","éšè—ç”¨æˆ·å¼¹çª—"),L.value=!1},showMarkerPopup:E,showCustomMarkerPopup:g,selectedMarker:v,getMarkerTypeName:e=>{if(!e)return"æ™®é€šæ ‡è®°";return{general:"æ™®é€šæ ‡è®°",pet_friendly:"å® ç‰©å‹å¥½",danger:"å±é™©åŒºåŸŸ",scenic:"é£æ™¯åŒº",pet_service:"å® ç‰©æœåŠ¡",custom:"è‡ªå®šä¹‰"}[e]||"æœªçŸ¥ç±»å‹"},getMarkerTypeIcon:e=>{if(!e)return"ğŸ“";return{general:"ğŸ“",pet_friendly:"ğŸ¾",danger:"âš ï¸",scenic:"ğŸï¸",pet_service:"ğŸ¥",custom:"âœ¨"}[e]||"ğŸ“"},getMarkerColor:e=>{if(!e)return"#4285F4";return{general:"#4285F4",pet_friendly:"#34A853",danger:"#EA4335",scenic:"#FBBC05",pet_service:"#FF7F50",custom:"#9370DB"}[e]||"#4285F4"},navigateToMarker:e=>{var t,o,s,r;if(e)try{const a=e.longitude||(null==(o=null==(t=e.location)?void 0:t.coordinates)?void 0:o[0]),n=e.latitude||(null==(r=null==(s=e.location)?void 0:s.coordinates)?void 0:r[1]);a&&n&&c.value&&(c.value.setCenter([a,n]),c.value.setZoom(17),g.value=!1,uni.showToast({title:"æ­£åœ¨å¯¼èˆªåˆ°æ ‡è®°ä½ç½®",icon:"none",duration:1500}))}catch(n){a("error","at pages/map/map.vue:1123","å¯¼èˆªåˆ°æ ‡è®°ä½ç½®å¤±è´¥:",n)}},formatTime:e=>{if(!e)return"æœªçŸ¥æ—¶é—´";const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`},getUserName:e=>e?"string"==typeof e?"ç”¨æˆ·"+e.substr(-4):e.nickname||e.username||"æœªçŸ¥ç”¨æˆ·":"æœªçŸ¥ç”¨æˆ·",centerOnUser(){a("log","at pages/map/map.vue:4574","å®šä½åˆ°ç”¨æˆ·ä½ç½®");try{if(c.value=N(),!C.value||void 0===C.value.latitude)return a("warn","at pages/map/map.vue:4581","å½“å‰ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ï¼Œå°è¯•é‡æ–°è·å–ä½ç½®"),void uni.getLocation({type:"gcj02",success:e=>{a("log","at pages/map/map.vue:4587","é‡æ–°è·å–ä½ç½®æˆåŠŸ:",e),C.value={latitude:e.latitude,longitude:e.longitude};const t=[e.longitude,e.latitude];a("log","at pages/map/map.vue:4596","è®¾ç½®åœ°å›¾ä¸­å¿ƒåˆ°:",t),c.value.setCenter(t),c.value.setZoom(16),uni.showToast({title:"å·²å®šä½åˆ°å½“å‰ä½ç½®",icon:"none",duration:1e3})},fail:e=>{a("error","at pages/map/map.vue:4608","é‡æ–°è·å–ä½ç½®å¤±è´¥:",e),uni.showToast({title:"è·å–ä½ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥å®šä½æƒé™",icon:"none"})}});const e=[C.value.longitude,C.value.latitude];a("log","at pages/map/map.vue:4620","è®¾ç½®åœ°å›¾ä¸­å¿ƒåˆ°:",e),c.value.setCenter(e),c.value.setZoom(16),uni.showToast({title:"å·²å®šä½åˆ°å½“å‰ä½ç½®",icon:"none",duration:1e3})}catch(e){a("error","at pages/map/map.vue:4631","è®¾ç½®åœ°å›¾ä¸­å¿ƒç‚¹å‡ºé”™:",e),uni.showToast({title:"å®šä½å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}},zoomIn(){a("log","at pages/map/map.vue:4639","æ”¾å¤§åœ°å›¾");try{c.value=N();const e=c.value.getZoom();a("log","at pages/map/map.vue:4646","å½“å‰ç¼©æ”¾çº§åˆ«:",e);const t=Math.min(e+1,19);a("log","at pages/map/map.vue:4650","æ–°ç¼©æ”¾çº§åˆ«:",t),c.value.setZoom(t),uni.showToast({title:"å·²æ”¾å¤§åœ°å›¾",icon:"none",duration:500})}catch(e){a("error","at pages/map/map.vue:4662","åœ°å›¾æ”¾å¤§å‡ºé”™:",e),uni.showToast({title:"æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}},zoomOut(){a("log","at pages/map/map.vue:4670","ç¼©å°åœ°å›¾");try{c.value=N();const e=c.value.getZoom();a("log","at pages/map/map.vue:4677","å½“å‰ç¼©æ”¾çº§åˆ«:",e);const t=Math.max(e-1,3);a("log","at pages/map/map.vue:4681","æ–°ç¼©æ”¾çº§åˆ«:",t),c.value.setZoom(t),uni.showToast({title:"å·²ç¼©å°åœ°å›¾",icon:"none",duration:500})}catch(e){a("error","at pages/map/map.vue:4693","åœ°å›¾ç¼©å°å‡ºé”™:",e),uni.showToast({title:"æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}},closeUserPopup:function(){a("log","at pages/map/map.vue:4375","å…³é—­ç”¨æˆ·å¼¹çª—"),L.value=!1,$.value=null,O.value=[]},messageUser(e){uni.navigateTo({url:`/pages/profile/message?userId=${e}`})},followUser(e){W.value=!W.value},closeWalkSummary(){a("log","at pages/map/map.vue:4713","å…³é—­æ­¥è¡Œæ‘˜è¦"),z.value=!1},shareWalkRecord(e){a("log","at pages/map/map.vue:4717","åˆ†äº«é›ç‹—è®°å½•åˆ°ç¤¾åŒº",e);const t=e&&e.selectedPetIndex>=0&&H.value.length>e.selectedPetIndex?H.value[e.selectedPetIndex]:null;let o=`æˆ‘å’Œ${t?t.name:"æˆ‘çš„å® ç‰©"}ä¸€èµ·é›äº†${(D.value/1e3).toFixed(2)}å…¬é‡Œï¼Œç”¨æ—¶${Qe(B.value)}ï¼`;e&&e.content&&(o+="\n\n"+e.content),z.value=!1,he().then((e=>{a("log","at pages/map/map.vue:4742","å·²ä¿å­˜é›ç‹—è®°å½•ï¼Œå‡†å¤‡åˆ†äº«åˆ°ç¤¾åŒºï¼Œè®°å½•ID:",e);const s={_id:e,distance:D.value,duration:B.value,startTime:walkStartTime.value,routeSnapshot:currentRouteSnapshot.value,pet:t?{_id:t._id,name:t.name,avatar:t.avatar}:null};setTimeout((()=>{uni.navigateTo({url:"/pages/community/create",success:e=>{uni.$emit("createPost",{content:o,walkRecord:s}),uni.showToast({title:"æ­£åœ¨å‰å¾€ç¤¾åŒº",icon:"none",duration:1500})},fail:e=>{a("error","at pages/map/map.vue:4780","å¯¼èˆªåˆ°ç¤¾åŒºå‘å¸–é¡µé¢å¤±è´¥:",e),uni.showToast({title:"æ‰“å¼€ç¤¾åŒºé¡µé¢å¤±è´¥",icon:"none"})}})}),300)})).catch((e=>{a("error","at pages/map/map.vue:4789","ä¿å­˜é›ç‹—è®°å½•å¤±è´¥ï¼Œæ— æ³•åˆ†äº«åˆ°ç¤¾åŒº:",e),uni.showToast({title:"åˆ†äº«å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}))},reloadUserInfo:function(){return __async(this,null,(function*(){var e,t;try{a("log","at pages/map/map.vue:3177","å¼€å§‹é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯..."),a("log","at pages/map/map.vue:3180","å½“å‰ç”¨æˆ·ä¿¡æ¯:",JSON.stringify(o.userInfo)),a("log","at pages/map/map.vue:3181","å½“å‰å¤´åƒè·¯å¾„:",null==(e=o.userInfo)?void 0:e.avatar),a("log","at pages/map/map.vue:3182","å½“å‰è®¡ç®—çš„å¤´åƒURL:",te.value),yield o.fetchUserInfo(),a("log","at pages/map/map.vue:3188","æ›´æ–°åçš„ç”¨æˆ·ä¿¡æ¯:",JSON.stringify(o.userInfo)),a("log","at pages/map/map.vue:3189","æ›´æ–°åçš„å¤´åƒè·¯å¾„:",null==(t=o.userInfo)?void 0:t.avatar),a("log","at pages/map/map.vue:3190","æ›´æ–°åçš„è®¡ç®—å¤´åƒURL:",te.value),a("log","at pages/map/map.vue:3193","ç¯å¢ƒå˜é‡VITE_API_URL:","http://49.235.65.37:5000"),uni.showToast({title:"ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°",icon:"none"}),setTimeout((()=>{pe(!0)}),500)}catch(s){a("error","at pages/map/map.vue:3206","é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",s),uni.showToast({title:"æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥",icon:"none"})}}))},clearAvatarCache:function(){return __async(this,null,(function*(){var e;try{if(a("log","at pages/map/map.vue:3217","å¼€å§‹æ¸…é™¤å¤´åƒç¼“å­˜..."),d.clear(),uni.removeStorageSync("userInfo"),a("log","at pages/map/map.vue:3224","å·²æ¸…é™¤æœ¬åœ°ç”¨æˆ·ä¿¡æ¯ç¼“å­˜"),yield o.fetchUserInfo(),a("log","at pages/map/map.vue:3228","å·²é‡æ–°è·å–ç”¨æˆ·ä¿¡æ¯"),null==(e=o.userInfo)?void 0:e.avatar){const e=V(o.userInfo.avatar,!0);if(a("log","at pages/map/map.vue:3234","æ¸…é™¤å¤´åƒURLç¼“å­˜:",e),uni.removeSavedFile)try{const e=(yield new Promise(((e,t)=>{uni.getSavedFileList({success:t=>e(t.fileList||[]),fail:()=>e([])})}))).filter((e=>e.filePath&&e.filePath.includes("avatar")));if(e.length>0){a("log","at pages/map/map.vue:3252","æ‰¾åˆ°",e.length,"ä¸ªå¯èƒ½çš„å¤´åƒç¼“å­˜æ–‡ä»¶");for(const t of e)yield new Promise((e=>{uni.removeSavedFile({filePath:t.filePath,success:()=>a("log","at pages/map/map.vue:3257","å·²åˆ é™¤ç¼“å­˜æ–‡ä»¶:",t.filePath),complete:e})}))}}catch(t){a("warn","at pages/map/map.vue:3264","æ¸…é™¤æ–‡ä»¶ç³»ç»Ÿç¼“å­˜æ—¶å‡ºé”™:",t)}try{const t=(new Date).getTime(),s=e.includes("?")?`${e}&t=${t}`:`${e}?t=${t}`;uni.downloadFile({url:s,success:e=>{var t;if(a("log","at pages/map/map.vue:3278","å¤´åƒé‡æ–°ä¸‹è½½æˆåŠŸ"),null==(t=o.userInfo)?void 0:t.id){const t=o.userInfo.id,a=C.value?[C.value.longitude,C.value.latitude]:null;a&&ue(t,a,e.tempFilePath)}},fail:e=>{a("error","at pages/map/map.vue:3292","å¤´åƒé‡æ–°ä¸‹è½½å¤±è´¥:",e)},complete:()=>{uni.showToast({title:"å¤´åƒç¼“å­˜å·²æ¸…é™¤",icon:"success"})}})}catch(s){a("error","at pages/map/map.vue:3303","ä¸‹è½½å¤´åƒæ—¶å‡ºé”™:",s),uni.showToast({title:"å¤´åƒå·²æ¸…é™¤ï¼Œä½†é‡æ–°è·å–å¤±è´¥",icon:"none"})}}else a("log","at pages/map/map.vue:3310","ç”¨æˆ·æ²¡æœ‰å¤´åƒï¼Œæ— éœ€æ¸…é™¤ç¼“å­˜"),uni.showToast({title:"æ— å¤´åƒï¼Œå·²æ¸…é™¤ç”¨æˆ·ä¿¡æ¯",icon:"none"})}catch(r){a("error","at pages/map/map.vue:3317","æ¸…é™¤å¤´åƒç¼“å­˜å¤±è´¥:",r),uni.showToast({title:"æ¸…é™¤å¤´åƒç¼“å­˜å‡ºé”™",icon:"none"})}}))},onMapContainerClick:function(e){a("log","at pages/map/map.vue:3806","åœ°å›¾å®¹å™¨ç‚¹å‡»äº‹ä»¶:",e);const{clientX:t,clientY:o}=e,s=document.querySelectorAll(".amap-marker");for(const r of s){const s=r.getBoundingClientRect();if(t>=s.left&&t<=s.right&&o>=s.top&&o<=s.bottom){a("log","at pages/map/map.vue:3819","ç‚¹å‡»äº†æ ‡è®°å…ƒç´ :",r);const t=r.getAttribute("data-user-id");if(t)return a("log","at pages/map/map.vue:3824","è§¦å‘æ ‡è®°ç‚¹å‡», ç”¨æˆ·ID:",t),e.stopPropagation(),void Ee({detail:{markerId:t}})}}L.value&&(L.value=!1)},selectUserMarker:Ce,navigateToPetIdentify(){uni.navigateTo({url:"/pages/petIdentify/index"})},showAddMarkerForm:()=>{uni.navigateTo({url:`/pages/map/add-marker?latitude=${C.value.latitude}&longitude=${C.value.longitude}`})},loadMarkers:y,displayMarkers:w,showMarkerInfo:e=>{e&&(i.setCurrentMarker(e),uni.showModal({title:e.title,content:e.description||"æš‚æ— æè¿°",showCancel:!0,cancelText:"å…³é—­",confirmText:"å¯¼èˆª",success:t=>{t.confirm&&(c.value.setCenter([e.longitude,e.latitude]),c.value.setZoom(16))}}))},toggleMarkersVisibility:h,navigateToAIMedical(){uni.navigateTo({url:"/pages/ai-medical/index"})},refreshMap:function(){a("log","at pages/map/map.vue:232","åˆ·æ–°åœ°å›¾ - ä½¿ç”¨æµè§ˆå™¨åˆ·æ–°"),uni.showLoading({title:"åˆ·æ–°åœ°å›¾ä¸­...",mask:!0});try{if("undefined"!=typeof window)setTimeout((()=>{a("log","at pages/map/map.vue:244","æ‰§è¡Œé¡µé¢åˆ·æ–°"),window.location.reload()}),500);else{a("log","at pages/map/map.vue:250","éH5ç¯å¢ƒï¼Œä½¿ç”¨uni-appæ–¹å¼åˆ·æ–°");uni.switchTab({url:"/pages/index/index",success:()=>{setTimeout((()=>{uni.switchTab({url:"/pages/map/index",complete:()=>{uni.hideLoading()}})}),300)},fail:()=>{uni.hideLoading(),uni.showToast({title:"åˆ·æ–°å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ‡æ¢é¡µé¢",icon:"none",duration:2e3})}})}}catch(e){a("error","at pages/map/map.vue:280","æ‰§è¡Œåˆ·æ–°æ“ä½œæ—¶å‡ºé”™:",e),uni.hideLoading(),uni.showToast({title:"åˆ·æ–°å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ‡æ¢é¡µé¢",icon:"none",duration:2e3})}}}}},[["render",function(t,a,o,s,r,n){var i,l,c,u,d,m,p,g,v;const h=e.resolveComponent("UserInfoPopup"),f=e.resolveComponent("WalkSummaryPopup");return e.openBlock(),e.createElementBlock("view",{class:"content map-container"},[e.createCommentVNode(" è°ƒè¯•ä¿¡æ¯é¢æ¿ "),s.showDebug?(e.openBlock(),e.createElementBlock("view",{key:0,class:"debug-info"},[e.createElementVNode("text",null,"æ ‡è®°æ•°: "+e.toDisplayString(s.debugInfo.markerCount),1),s.debugInfo.markerIds.length>0?(e.openBlock(),e.createElementBlock("text",{key:0},"ID: "+e.toDisplayString(s.debugInfo.markerIds.join(", ")),1)):e.createCommentVNode("v-if",!0),s.debugInfo.coords.length>0?(e.openBlock(),e.createElementBlock("text",{key:1},"åæ ‡: "+e.toDisplayString(s.debugInfo.coords.join(" | ")),1)):e.createCommentVNode("v-if",!0),e.createElementVNode("text",null,"å½“å‰ä½ç½®: "+e.toDisplayString(s.currentLocation.latitude)+", "+e.toDisplayString(s.currentLocation.longitude),1),e.createElementVNode("text",null,"å¤´åƒè·¯å¾„: "+e.toDisplayString((null==(i=s.userStore.userInfo)?void 0:i.avatar)||"æ— "),1),e.createElementVNode("text",null,"å®Œæ•´å¤´åƒURL: "+e.toDisplayString(s.userAvatar||"æ— "),1),e.createElementVNode("text",null,"ä½¿ç”¨çš„æ ‡è®°: ç”¨æˆ·åœ¨èµ„æ–™ä¸­ä¸Šä¼ çš„å¤´åƒ"),e.createElementVNode("text",null,"æ€»æ ‡è®°æ•°: "+e.toDisplayString(s.allMarkers.length),1),e.createElementVNode("text",null,"ç”¨æˆ·æ ‡è®°: "+e.toDisplayString(s.userMarker?"å·²åˆ›å»º":"æœªåˆ›å»º"),1),e.createElementVNode("button",{onClick:a[0]||(a[0]=e=>s.forceRefreshMarker(!1))},"å¸¸è§„åˆ·æ–°"),e.createElementVNode("button",{onClick:a[1]||(a[1]=e=>s.forceRefreshMarker(!0))},"å¼ºåˆ¶ä½¿ç”¨ä¸Šä¼ å¤´åƒ"),e.createElementVNode("button",{onClick:a[2]||(a[2]=(...e)=>s.reloadUserInfo&&s.reloadUserInfo(...e))},"é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯"),e.createElementVNode("button",{onClick:a[3]||(a[3]=(...e)=>s.clearAvatarCache&&s.clearAvatarCache(...e))},"æ¸…é™¤å¤´åƒç¼“å­˜"),e.createElementVNode("button",{onClick:a[4]||(a[4]=e=>s.showDebug=!1)},"å…³é—­")])):e.createCommentVNode("v-if",!0),e.createCommentVNode(" åœ°å›¾ç»„ä»¶ - å®Œå–„äº‹ä»¶å¤„ç† "),e.createElementVNode("view",{class:"map-wrapper",onClick:a[5]||(a[5]=(...e)=>s.onMapContainerClick&&s.onMapContainerClick(...e))},[e.createElementVNode("div",{id:"map-container",class:"map-container"})]),e.createCommentVNode(" ä½ç½®å…±äº«æç¤º "),s.showLocationSharingTip?(e.openBlock(),e.createElementBlock("view",{key:1,class:"location-share-tip"},[e.createElementVNode("view",{class:"tip-content"},[e.createElementVNode("text",{class:"tip-text"},"æ‚¨æ˜¯å¦æƒ³åœ¨åœ°å›¾ä¸Šä¸å…¶ä»–å® å‹åˆ†äº«æ‚¨çš„ä½ç½®ï¼Ÿ"),e.createElementVNode("view",{class:"tip-buttons"},[e.createElementVNode("view",{class:"tip-btn cancel-btn",onClick:a[6]||(a[6]=(...e)=>s.cancelLocationSharing&&s.cancelLocationSharing(...e))},"æš‚ä¸åˆ†äº«"),e.createElementVNode("view",{class:"tip-btn confirm-btn",onClick:a[7]||(a[7]=(...e)=>s.confirmLocationSharing&&s.confirmLocationSharing(...e))},"å¼€å§‹åˆ†äº«")])])])):e.createCommentVNode("v-if",!0),e.createCommentVNode(" ä½ç½®å…±äº«çŠ¶æ€æŒ‡ç¤ºå™¨ "),s.locationSharingStatusVisible?(e.openBlock(),e.createElementBlock("view",{key:2,class:"location-sharing-status"},[e.createElementVNode("view",{class:e.normalizeClass(["status-icon",{active:s.isLocationShared}])},null,2),e.createElementVNode("text",{class:"status-text"},e.toDisplayString(s.locationSharingStatus),1)])):e.createCommentVNode("v-if",!0),e.createCommentVNode(" åœ°å›¾å·¥å…·æ  "),e.createElementVNode("view",{class:"toolbar"},[e.createElementVNode("view",{class:"toolbar-item",onClick:a[8]||(a[8]=(...e)=>s.centerOnUser&&s.centerOnUser(...e))},[e.createElementVNode("text",{class:"icon"},"ğŸ“"),e.createElementVNode("text",{class:"toolbar-text"},"å®šä½")]),e.createElementVNode("view",{class:"toolbar-item",onClick:a[9]||(a[9]=(...e)=>s.zoomIn&&s.zoomIn(...e))},[e.createElementVNode("text",{class:"icon"},"â•"),e.createElementVNode("text",{class:"toolbar-text"},"æ”¾å¤§")]),e.createElementVNode("view",{class:"toolbar-item",onClick:a[10]||(a[10]=(...e)=>s.zoomOut&&s.zoomOut(...e))},[e.createElementVNode("text",{class:"icon"},"â–"),e.createElementVNode("text",{class:"toolbar-text"},"ç¼©å°")]),e.createElementVNode("view",{class:"toolbar-item",onClick:a[11]||(a[11]=(...e)=>s.showAddMarkerForm&&s.showAddMarkerForm(...e))},[e.createElementVNode("text",{class:"icon"},"ğŸ“"),e.createElementVNode("text",{class:"toolbar-text"},"æ ‡è®°")]),e.createElementVNode("view",{class:"toolbar-item pet-identify",onClick:a[12]||(a[12]=(...e)=>s.navigateToPetIdentify&&s.navigateToPetIdentify(...e))},[e.createElementVNode("text",{class:"icon"},"ğŸ”"),e.createElementVNode("text",{class:"toolbar-text"},"è¯†åˆ«")]),e.createElementVNode("view",{class:"toolbar-item",onClick:a[13]||(a[13]=(...e)=>s.toggleMarkersVisibility&&s.toggleMarkersVisibility(...e))},[e.createElementVNode("text",{class:"icon"},"ğŸ‘ï¸"),e.createElementVNode("text",{class:"toolbar-text"},e.toDisplayString(t.showMarkers?"éšè—æ ‡è®°":"æ˜¾ç¤ºæ ‡è®°"),1)]),e.createElementVNode("view",{class:"toolbar-item ai-medical",onClick:a[14]||(a[14]=(...e)=>s.navigateToAIMedical&&s.navigateToAIMedical(...e))},[e.createElementVNode("text",{class:"icon"},"ğŸ¥"),e.createElementVNode("text",{class:"toolbar-text"},"AIåŒ»ç–—")])]),e.createCommentVNode(" æ·»åŠ æ ‡è®°æŒ‰é’® "),e.createCommentVNode(' <view class="add-marker-btn" @click="showAddMarkerForm">\n\t\t\t<uni-icons type="plusempty" size="24" color="#FFFFFF"></uni-icons>\n\t\t\t<text class="btn-text">æ·»åŠ æ ‡è®°</text>\n\t\t</view> '),e.createCommentVNode(" å¼€å§‹/åœæ­¢é›ç‹—æŒ‰é’® "),e.createElementVNode("view",{class:"start-button",onClick:a[15]||(a[15]=(...e)=>s.toggleWalkingMode&&s.toggleWalkingMode(...e))},[e.createElementVNode("view",{class:e.normalizeClass(["start-button-inner",{active:s.isWalking}])},[e.createElementVNode("text",{class:"start-icon"},e.toDisplayString(s.isWalking?"â¹ï¸":"â–¶ï¸"),1),e.createElementVNode("text",{class:"start-text"},e.toDisplayString(s.isWalking?"åœæ­¢":"å¼€å§‹"),1)],2)]),e.createCommentVNode(" æ·»åŠ åœ°å›¾åˆ·æ–°æŒ‰é’® "),e.createElementVNode("view",{class:"refresh-map-btn",onClick:a[16]||(a[16]=(...e)=>s.refreshMap&&s.refreshMap(...e))},[e.createElementVNode("view",{class:"refresh-btn-inner"},[e.createElementVNode("text",{class:"refresh-icon"},"ğŸ”„")])]),e.createCommentVNode(" é›ç‹—çŠ¶æ€ä¿¡æ¯ "),s.isWalking?(e.openBlock(),e.createElementBlock("view",{key:3,class:"walking-info"},[e.createElementVNode("view",{class:"info-item"},[e.createElementVNode("text",{class:"label"},"è·ç¦»"),e.createElementVNode("text",{class:"value"},e.toDisplayString((s.walkingDistance/1e3).toFixed(2))+"km",1)]),e.createElementVNode("view",{class:"info-item"},[e.createElementVNode("text",{class:"label"},"æ—¶é—´"),e.createElementVNode("text",{class:"value"},e.toDisplayString(s.formatDuration(s.walkingDuration)),1)]),e.createElementVNode("view",{class:"info-item"},[e.createElementVNode("text",{class:"label"},"é…é€Ÿ"),e.createElementVNode("text",{class:"value"},e.toDisplayString(s.calculatePace(s.walkingDistance,s.walkingDuration)),1)])])):e.createCommentVNode("v-if",!0),e.createCommentVNode(" ç”¨æˆ·ä¿¡æ¯å¼¹çª— "),s.showUserPopup?(e.openBlock(),e.createBlock(h,{key:4,user:s.selectedUser,pets:s.selectedUserPets,"is-following":s.isFollowing,visible:s.showUserPopup,onClose:s.closeUserPopup,onMessage:s.messageUser,onFollow:s.followUser},null,8,["user","pets","is-following","visible","onClose","onMessage","onFollow"])):e.createCommentVNode("v-if",!0),e.createCommentVNode(" é›ç‹—ç»“æŸç»Ÿè®¡å¼¹çª— "),s.showWalkSummary?(e.openBlock(),e.createBlock(f,{key:5,duration:s.walkingDuration,distance:s.walkingDistance,pets:s.myPets,"selected-pet-index":s.selectedPetIndex,"share-content":s.walkShareContent,onClose:s.closeWalkSummary,onShare:s.shareWalkRecord},null,8,["duration","distance","pets","selected-pet-index","share-content","onClose","onShare"])):e.createCommentVNode("v-if",!0),e.createCommentVNode(" ä¸´æ—¶æŒ‰é’® - åˆ‡æ¢æ˜¾ç¤ºç”¨æˆ·å¤´åƒ/é»˜è®¤æ ‡è®° "),e.createCommentVNode('\n\t\t<view \n\t\t\t@click="toggleMarker" \n\t\t\tstyle="position: absolute; bottom: 220px; right: 20px; background: rgba(0,122,255,0.9); color: white; padding: 10px; border-radius: 5px; z-index: 999;"\n\t\t>\n\t\t\tåˆ‡æ¢æ ‡è®°\n\t\t\t\t</view>\n\t\t'),e.createCommentVNode(" éšè—çš„Canvasç”¨äºç”Ÿæˆæœ¬åœ°å›¾ç‰‡ "),e.createElementVNode("canvas",{"canvas-id":"debug-canvas",style:{width:"40px",height:"40px",position:"absolute",left:"-100px"}}),e.createCommentVNode(" è‡ªå®šä¹‰æ ‡è®°å¼¹çª— "),s.showCustomMarkerPopup?(e.openBlock(),e.createElementBlock("view",{key:6,class:"custom-marker-popup"},[e.createElementVNode("view",{class:"popup-backdrop",onClick:a[17]||(a[17]=e=>s.showCustomMarkerPopup=!1)}),e.createElementVNode("view",{class:"popup-content"},[e.createElementVNode("view",{class:"popup-header"},[e.createElementVNode("text",{class:"popup-title"},e.toDisplayString((null==(l=s.selectedMarker)?void 0:l.title)||"æœªå‘½åæ ‡è®°"),1),e.createElementVNode("view",{class:"close-btn",onClick:a[18]||(a[18]=e=>s.showCustomMarkerPopup=!1)},"Ã—")]),e.createElementVNode("view",{class:"popup-body"},[e.createElementVNode("view",{class:"marker-type"},[e.createElementVNode("view",{class:"marker-type-icon",style:e.normalizeStyle({backgroundColor:s.getMarkerColor(null==(c=s.selectedMarker)?void 0:c.type)})},[e.createElementVNode("text",{class:"type-icon"},e.toDisplayString(s.getMarkerTypeIcon(null==(u=s.selectedMarker)?void 0:u.type)),1)],4),e.createElementVNode("text",{class:"marker-type-name"},e.toDisplayString(s.getMarkerTypeName(null==(d=s.selectedMarker)?void 0:d.type)),1)]),e.createElementVNode("view",{class:"marker-description"},[e.createElementVNode("text",{class:"description-text"},e.toDisplayString((null==(m=s.selectedMarker)?void 0:m.description)||"æš‚æ— æè¿°å†…å®¹"),1)]),e.createElementVNode("view",{class:"marker-info"},[(null==(p=s.selectedMarker)?void 0:p.radius)?(e.openBlock(),e.createElementBlock("view",{key:0,class:"info-item"},[e.createElementVNode("text",{class:"info-icon"},"â­•"),e.createElementVNode("text",{class:"info-text"},"è¦†ç›–åŠå¾„: "+e.toDisplayString(s.selectedMarker.radius<100?s.selectedMarker.radius+"å…¬é‡Œ ("+(1e3*s.selectedMarker.radius).toFixed(0)+"ç±³)":s.selectedMarker.radius+"ç±³"),1)])):e.createCommentVNode("v-if",!0),(null==(g=s.selectedMarker)?void 0:g.createdAt)?(e.openBlock(),e.createElementBlock("view",{key:1,class:"info-item"},[e.createElementVNode("text",{class:"info-icon"},"ğŸ•’"),e.createElementVNode("text",{class:"info-text"},"åˆ›å»ºæ—¶é—´: "+e.toDisplayString(s.formatTime(s.selectedMarker.createdAt)),1)])):e.createCommentVNode("v-if",!0),(null==(v=s.selectedMarker)?void 0:v.user)&&"string"!=typeof s.selectedMarker.user?(e.openBlock(),e.createElementBlock("view",{key:2,class:"info-item"},[e.createElementVNode("text",{class:"info-icon"},"ğŸ‘¤"),e.createElementVNode("text",{class:"info-text"},"åˆ›å»ºè€…: "+e.toDisplayString(s.getUserName(s.selectedMarker.user)),1)])):e.createCommentVNode("v-if",!0)])]),e.createElementVNode("view",{class:"popup-footer"},[e.createElementVNode("view",{class:"popup-btn cancel-btn",onClick:a[19]||(a[19]=e=>s.showCustomMarkerPopup=!1)},"å…³é—­"),e.createElementVNode("view",{class:"popup-btn confirm-btn",onClick:a[20]||(a[20]=e=>s.navigateToMarker(s.selectedMarker))},"å¯¼èˆª")])])])):e.createCommentVNode("v-if",!0)])}],["__file","D:/caloriesH5/CloudStorage/pages/map/map.vue"]]);const ut=ze({name:"WalkRecordCard",props:{record:{type:Object,required:!0}},methods:{formatDuration(e){if(!e)return"0ç§’";const t=Math.floor(e/3600),a=Math.floor(e%3600/60);return t>0?`${t}å°æ—¶${a>0?a+"åˆ†é’Ÿ":""}`:a>0?`${a}åˆ†é’Ÿ`:`${e%60}ç§’`},formatDurationShort(e){if(!e)return"0ç§’";const t=Math.floor(e/3600),a=Math.floor(e%3600/60);return t>0?`${t}æ—¶${a}åˆ†`:a>0?`${a}åˆ†é’Ÿ`:`${e}ç§’`},formatDate(e){if(!e)return"";try{const t=new Date(e),a=t.getMonth()+1;return`${a}æœˆ${t.getDate()}æ—¥`}catch(t){return a("error","at components/WalkRecordCard.vue:94","æ—¥æœŸæ ¼å¼åŒ–é”™è¯¯:",t),""}},formatPetAvatar(e){if(!e)return"/static/images/default-pet.png";if(e.startsWith("http")||e.startsWith("/static"))return e;if(e.startsWith("/uploads")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}return"/static/images/default-pet.png"},getRouteImage(){return this.record.routeImage?this.record.routeImage:"/static/images/default-map.png"},viewDetail(){if(!this.record||!this.record._id)return void uni.showToast({title:"é›ç‹—è®°å½•ä¸å­˜åœ¨",icon:"none"});this.record._id.startsWith("generated_")?uni.showToast({title:"è¿™æ˜¯ä»åŠ¨æ€å†…å®¹è§£æçš„é›ç‹—è®°å½•ï¼Œæ— æ³•æŸ¥çœ‹è¯¦æƒ…",icon:"none",duration:2500}):uni.navigateTo({url:`/pages/walk/detail?id=${this.record._id}`,fail:e=>{a("error","at components/WalkRecordCard.vue:151","æ‰“å¼€é›ç‹—è®°å½•è¯¦æƒ…å¤±è´¥:",e),uni.showToast({title:"æ— æ³•æŸ¥çœ‹é›ç‹—è®°å½•",icon:"none"})}})}}},[["render",function(t,a,o,s,r,n){return e.openBlock(),e.createElementBlock("view",{class:"walk-record-container",onClick:a[0]||(a[0]=(...e)=>n.viewDetail&&n.viewDetail(...e))},[e.createElementVNode("view",{class:"walk-record-title"},[e.createElementVNode("text",{class:"paw-icon"},"ğŸ¾"),e.createElementVNode("text",null,"é›ç‹—è®°å½•"),e.createElementVNode("text",{class:"arrow-icon"},"ğŸ‘‰")]),e.createElementVNode("view",{class:"walk-record-content"},[e.createElementVNode("view",{class:"walk-stats"},[e.createElementVNode("view",{class:"stat-item"},[e.createElementVNode("view",{class:"stat-value"},e.toDisplayString((o.record.distance/1e3).toFixed(2)),1),e.createElementVNode("view",{class:"stat-label"},"å…¬é‡Œ")]),e.createElementVNode("view",{class:"stat-divider"}),e.createElementVNode("view",{class:"stat-item"},[e.createElementVNode("view",{class:"stat-value"},e.toDisplayString(n.formatDurationShort(o.record.duration)),1),e.createElementVNode("view",{class:"stat-label"},"æ—¶é•¿")])]),o.record.pet?(e.openBlock(),e.createElementBlock("view",{key:0,class:"walk-pet-info"},[e.createElementVNode("image",{class:"pet-avatar",src:n.formatPetAvatar(o.record.pet.avatar),mode:"aspectFill"},null,8,["src"]),e.createElementVNode("text",{class:"pet-name"},e.toDisplayString(o.record.pet?o.record.pet.name:"æœªå‘½åå® ç‰©"),1),e.createElementVNode("text",{class:"walk-date"},e.toDisplayString(n.formatDate(o.record.startTime)),1)])):e.createCommentVNode("v-if",!0),o.record.route&&o.record.route.length>0?(e.openBlock(),e.createElementBlock("view",{key:1,class:"map-preview"},[e.createElementVNode("image",{class:"map-image",src:n.getRouteImage(),mode:"aspectFill"},null,8,["src"])])):e.createCommentVNode("v-if",!0)]),e.createElementVNode("view",{class:"walk-record-footer"},[e.createElementVNode("text",null,"åˆ†äº«é›ç‹—è®°å½•å¯ä»¥æ¿€åŠ±å…¶ä»–é“²å±å®˜ä¹ŸåŠ å…¥è¿åŠ¨ï¼")])])}],["__scopeId","data-v-d76807fc"],["__file","D:/caloriesH5/CloudStorage/components/WalkRecordCard.vue"]]);const dt=ze({props:{show:{type:Boolean,default:!1},images:{type:Array,default:()=>[]},initialIndex:{type:Number,default:0}},data:()=>({currentIndex:0}),watch:{initialIndex(e){this.currentIndex=e},show(e){e&&(this.currentIndex=this.initialIndex)}},methods:{handleSwiperChange(e){this.currentIndex=e.detail.current},close(){this.$emit("close")},formatImageUrl(e){if(!e)return"/static/images/default-image.png";if(a("log","at components/ImageViewer.vue:74","å›¾ç‰‡æŸ¥çœ‹å™¨å¤„ç†URL:",e),e.startsWith("http")||e.startsWith("/static")||e.startsWith("blob:"))return e;if(e.startsWith("/uploads")){const t=uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000",o=t+e;return a("log","at components/ImageViewer.vue:85","å¤„ç†ç›¸å¯¹è·¯å¾„å›¾ç‰‡URL:",e,"è¡¥å……åŸºç¡€URL:",t,"å®Œæ•´URL:",o),o}return a("warn","at components/ImageViewer.vue:90","æœªèƒ½è¯†åˆ«çš„å›¾ç‰‡URLæ ¼å¼:",e),"/static/images/default-image.png"}}},[["render",function(t,a,o,s,r,n){return o.show?(e.openBlock(),e.createElementBlock("view",{key:0,class:"image-viewer",onClick:a[5]||(a[5]=(...e)=>n.close&&n.close(...e))},[e.createElementVNode("swiper",{class:"image-swiper",current:r.currentIndex,onChange:a[2]||(a[2]=(...e)=>n.handleSwiperChange&&n.handleSwiperChange(...e)),circular:"",onClick:a[3]||(a[3]=e.withModifiers((()=>{}),["stop"]))},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.images,((t,o)=>(e.openBlock(),e.createElementBlock("swiper-item",{key:o,class:"swiper-item"},[e.createElementVNode("view",{class:"image-container",onClick:a[1]||(a[1]=(...e)=>n.close&&n.close(...e))},[e.createElementVNode("image",{class:"viewer-image",src:n.formatImageUrl(t),mode:"aspectFit",onClick:a[0]||(a[0]=(...e)=>n.close&&n.close(...e))},null,8,["src"])])])))),128))],40,["current"]),e.createElementVNode("view",{class:"controls"},[e.createElementVNode("text",{class:"indicator"},e.toDisplayString(r.currentIndex+1)+"/"+e.toDisplayString(o.images.length),1),e.createElementVNode("view",{class:"close-button",onClick:a[4]||(a[4]=e.withModifiers(((...e)=>n.close&&n.close(...e)),["stop"]))},"Ã—")])])):e.createCommentVNode("v-if",!0)}],["__scopeId","data-v-a9a40036"],["__file","D:/caloriesH5/CloudStorage/components/ImageViewer.vue"]]);const mt=ze({components:{WalkRecordCard:ut,ImageViewer:dt,UserInfoPopup:lt},data:()=>({scrollHeight:0,navHeight:110}),setup(){const t=A.community,o=Re(),s=e.ref(0),r=e.ref(!1),n=e.ref(!1),i=e.ref(0),l=e.ref(!1),c=e.ref(0),u=e.ref(null),d=e.ref([]),m=e.ref(!1),p=e.ref(null),g=e.ref([]),v=e.ref(!1),h=e=>e&&Array.isArray(e)?e.map((e=>(e=>{if(e.walkRecord)return e;const t=e.content||"";let a=null;const o=t.match(/é›äº†\s*(\d+\.?\d*)\s*å…¬é‡Œ/),s=o?1e3*parseFloat(o[1]):null,r=t.match(/ç”¨æ—¶\s*(\d+)\s*(ç§’|åˆ†é’Ÿ|å°æ—¶)/);let n=null;if(r){const e=parseInt(r[1]),t=r[2];"ç§’"===t?n=e:"åˆ†é’Ÿ"===t?n=60*e:"å°æ—¶"===t&&(n=3600*e)}const i=t.match(/å’Œ\s*([^\s,ï¼Œã€‚ï¼]+)\s*ä¸€èµ·é›/),l=i?i[1]:"æˆ‘çš„å® ç‰©";return null!==s||null!==n?(a={_id:`generated_${e._id||e.id||Date.now()}`,distance:s||0,duration:n||0,pet:{name:l},startTime:e.createdAt||e.time||(new Date).toISOString()},__spreadProps(__spreadValues({},e),{walkRecord:a})):e})(e))):[],f=(e=!1)=>__async(this,null,(function*(){if(!r.value){r.value=!0,e&&(d.value=[]);try{if(!t)return a("error","at pages/community/community.vue:305","ç¤¾åŒºAPIæœªæ‰¾åˆ°ï¼Œæ˜¾ç¤ºé»˜è®¤æ•°æ®"),void y();a("log","at pages/community/community.vue:310","åŠ è½½å¸–å­ç±»å‹:",0===s.value?"recommended":"following");const e=yield t.getPosts({type:0===s.value?"recommended":"following",limit:20});if(e&&(e.data||Array.isArray(e))){const t=e.data||e;t&&0!==t.length?(i.value=Date.now(),d.value=h(t)):0===s.value?y():d.value=[]}else 0===s.value?y():d.value=[]}catch(o){a("error","at pages/community/community.vue:347","åŠ è½½å¸–å­å¤±è´¥",o),0===s.value?y():(d.value=[],uni.showToast({title:"æ²¡æœ‰å…³æ³¨çš„å†…å®¹",icon:"none"}))}finally{r.value=!1,uni.stopPullDownRefresh()}}})),y=()=>{const e=[{id:1,username:"ç‹—ç‹—çˆ±å¥½è€…",userAvatar:"/static/images/default-avatar.png",time:"1å°æ—¶å‰",content:"ä»Šå¤©å’Œæ±ªæ±ªå‡ºå»ç©ï¼Œå¥½å¼€å¿ƒï¼",likes:12,comments:3,images:["/static/images/default-pet.png"]},{id:2,username:"å® ç‰©è¾¾äºº",userAvatar:"/static/images/default-avatar.png",time:"2å°æ—¶å‰",content:"åˆ†äº«ä¸€ä¸‹æˆ‘å®¶ç‹—ç‹—çš„æ—¥å¸¸~",likes:24,comments:8,images:["/static/images/default-pet.png","/static/images/default-pet.png","/static/images/default-pet.png"],walkRecord:{_id:"default_walk_record_1",distance:3500,duration:1800,pet:{name:"å°ç™½"},startTime:(new Date).toISOString()}},{id:3,username:"jlk1997",userAvatar:"/static/images/default-avatar.png",time:"5åˆ†é’Ÿå‰",content:"æˆ‘å’Œdwqdwä¸€èµ·é›äº†0.00å…¬é‡Œï¼Œç”¨æ—¶5ç§’ï¼ caca",likes:0,comments:0}];d.value=h(e)},w=e=>{if(!e)return"/static/images/default-avatar.png";if(e.startsWith("http")||e.startsWith("/static"))return e;if(e.startsWith("/uploads")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}return"object"==typeof e&&e.avatar?w(e.avatar):"/static/images/default-avatar.png"};return{tabs:["æ¨è","å…³æ³¨"],currentTab:s,posts:d,isLoading:r,isRefreshing:n,lastPublishTime:i,formatDuration:e=>{if(!e)return"0åˆ†é’Ÿ";const t=Math.floor(e/3600),a=Math.floor(e%3600/60);let o="";return t>0?(o+=`${t}å°æ—¶`,a>0&&(o+=`${a}åˆ†é’Ÿ`)):o+=`${a}åˆ†é’Ÿ`,o},truncateText:(e,t)=>e?e.length<=t?e:e.substring(0,t)+"...":"",previewImage:(e,t)=>{u.value=e,c.value=t,l.value=!0},viewPostDetail:e=>{if(a("log","at pages/community/community.vue:617","æŸ¥çœ‹å¸–å­è¯¦æƒ…:",e),!e||!e.id&&!e._id)return void uni.showToast({title:"å¸–å­æ•°æ®æ— æ•ˆ",icon:"none"});const t=e.id||e._id;try{const a=`post_cache_${t}_${Date.now()}`;uni.setStorageSync(a,JSON.stringify(e)),uni.navigateTo({url:`/pages/community/post-detail?id=${t}&postKey=${a}`})}catch(o){a("error","at pages/community/community.vue:639","ä¿å­˜å¸–å­æ•°æ®åˆ°ç¼“å­˜å¤±è´¥:",o),uni.navigateTo({url:`/pages/community/post-detail?id=${t}`})}},formatDate:(e,t=!1)=>{if(!e)return"";if("string"==typeof e&&!e.includes("T")&&!e.includes("-"))return e;try{const t=new Date(e),a=new Date,o=Math.floor((a-t)/1e3);return o<60?"åˆšåˆš":o<3600?Math.floor(o/60)+"åˆ†é’Ÿå‰":o<86400?Math.floor(o/3600)+"å°æ—¶å‰":o<2592e3?Math.floor(o/86400)+"å¤©å‰":`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}catch(o){return a("error","at pages/community/community.vue:711","æ—¥æœŸæ ¼å¼åŒ–é”™è¯¯:",o),e}},switchTab:e=>{s.value!==e?(s.value=e,f(!0)):f(!0)},loadMore:()=>__async(this,null,(function*(){if(!r.value){r.value=!0;try{if(!t)return void(r.value=!1);const e=d.value.length>0?d.value[d.value.length-1].id:null;a("log","at pages/community/community.vue:557","åŠ è½½æ›´å¤šï¼Œç±»å‹:",0===s.value?"recommended":"following","æœ€åID:",e);const o=yield t.getPosts({type:0===s.value?"recommended":"following",limit:10,lastId:e});o&&o.data&&o.data.length>0?d.value=[...d.value,...o.data]:uni.showToast({title:"æ²¡æœ‰æ›´å¤šå†…å®¹äº†",icon:"none"})}catch(e){a("error","at pages/community/community.vue:576","åŠ è½½æ›´å¤šå¸–å­å¤±è´¥",e),uni.showToast({title:"åŠ è½½æ›´å¤šå¤±è´¥",icon:"none"})}finally{r.value=!1}}})),navToCreate:()=>{i.value=Date.now(),uni.navigateTo({url:"/pages/community/create"})},likePost:(e,o)=>__async(this,null,(function*(){if(a("log","at pages/community/community.vue:451","Like post:",e,"Index:",o),!e||!e.id&&!e._id)return a("error","at pages/community/community.vue:454","Invalid post ID for like action"),void uni.showToast({title:"æ— æ³•ç‚¹èµ",icon:"none"});const s=e.id||e._id;void 0===e.isLiked&&(e.isLiked=!1),void 0===e.likes&&(e.likes=0);const r=e.isLiked;e.isLiked=!r,e.likes=r?Math.max((e.likes||1)-1,0):(e.likes||0)+1;try{if(!t)throw new Error("ç¤¾åŒºAPIæœªåˆå§‹åŒ–");const o=yield t.likePost(s,!r);a("log","at pages/community/community.vue:488","Like/unlike success:",o),o&&o.data&&void 0!==o.data.likes&&(e.likes=o.data.likes,e.isLiked=o.data.isLiked)}catch(n){a("error","at pages/community/community.vue:496","Like/unlike error:",n),e.isLiked=r,e.likes=r?(e.likes||0)+1:Math.max((e.likes||1)-1,0),uni.showToast({title:"æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}})),viewComments:e=>{if(a("log","at pages/community/community.vue:512","Viewing comments for post:",e),!e||!e.id&&!e._id)return a("error","at pages/community/community.vue:515","Invalid post ID for comments view"),void uni.showToast({title:"æ— æ³•æŸ¥çœ‹è¯„è®º",icon:"none"});const t=e.id||e._id;try{const a=`post_cache_${t}_${Date.now()}`;uni.setStorageSync(a,JSON.stringify(e)),uni.navigateTo({url:`/pages/community/post-detail?id=${t}&postKey=${a}&showComments=true`})}catch(o){a("error","at pages/community/community.vue:535","ä¿å­˜å¸–å­æ•°æ®åˆ°ç¼“å­˜å¤±è´¥:",o),uni.navigateTo({url:`/pages/community/post-detail?id=${t}&showComments=true`})}},loadPosts:f,onRefresh:()=>{a("log","at pages/community/community.vue:270","è§¦å‘ä¸‹æ‹‰åˆ·æ–°"),n.value=!0,f(!0).finally((()=>{setTimeout((()=>{n.value=!1}),300)}))},formatAvatarUrl:w,handleAvatarError:(e,t)=>{a("warn","at pages/community/community.vue:445","å¤´åƒåŠ è½½å¤±è´¥:",e,"ç´¢å¼•:",t),e.target.src="/static/images/default-avatar.png"},formatImageUrl:e=>{if(!e)return"/static/images/default-pet.png";if(a("log","at pages/community/community.vue:720","ç¤¾åŒºé¡µé¢å¤„ç†å›¾ç‰‡URL:",e),e.startsWith("http")||e.startsWith("/static")||e.startsWith("blob:"))return e;if(e.startsWith("/uploads")){const t=uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000",o=t+e;return a("log","at pages/community/community.vue:731","å¤„ç†ç›¸å¯¹è·¯å¾„å›¾ç‰‡URL:",e,"è¡¥å……åŸºç¡€URL:",t,"å®Œæ•´URL:",o),o}return a("warn","at pages/community/community.vue:736","æœªèƒ½è¯†åˆ«çš„å›¾ç‰‡URLæ ¼å¼:",e),"/static/images/default-pet.png"},viewWalkRecord:e=>{if(!e.walkRecord||!e.walkRecord._id)return void uni.showToast({title:"é›ç‹—è®°å½•ä¸å­˜åœ¨",icon:"none"});a("log","at pages/community/community.vue:657","æŸ¥çœ‹é›ç‹—è®°å½•è¯¦æƒ…:",e.walkRecord);e.walkRecord._id.startsWith("generated_")?uni.showToast({title:"è¿™æ˜¯ä»åŠ¨æ€å†…å®¹è§£æçš„é›ç‹—è®°å½•ï¼Œæ— æ³•æŸ¥çœ‹è¯¦æƒ…",icon:"none",duration:2500}):uni.navigateTo({url:`/pages/walk/detail?id=${e.walkRecord._id}`,fail:e=>{a("error","at pages/community/community.vue:675","æ‰“å¼€é›ç‹—è®°å½•è¯¦æƒ…å¤±è´¥:",e),uni.showToast({title:"æ— æ³•æŸ¥çœ‹é›ç‹—è®°å½•",icon:"none"})}})},getNumberValue:e=>Array.isArray(e)?e.length:"number"==typeof e?e:e&&"object"==typeof e?Object.keys(e).length:0,showImageViewer:l,currentImageIndex:c,currentPost:u,closeImageViewer:()=>{l.value=!1},showUserPopup:m,selectedUser:p,selectedUserPets:g,isFollowing:v,showUserProfile:e=>__async(this,null,(function*(){if(a("log","at pages/community/community.vue:742","æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯:",e),!e||!e._id)return a("error","at pages/community/community.vue:744","æ— æ•ˆçš„ç”¨æˆ·ä¿¡æ¯"),void uni.showToast({title:"æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯",icon:"none"});const t=o.isAuthenticated&&o.userId===e._id;if(p.value=__spreadProps(__spreadValues({},e),{isCurrentUser:t}),v.value=!1,o.isAuthenticated&&!t)try{a("log","at pages/community/community.vue:768","ç›´æ¥è°ƒç”¨checkFollowStatusæ£€æŸ¥å…³æ³¨çŠ¶æ€ï¼Œç”¨æˆ·ID:",e._id);const t=yield A.user.checkFollowStatus(e._id);t&&void 0!==t.isFollowing&&(v.value=t.isFollowing,a("log","at pages/community/community.vue:773","APIè¿”å›çš„å…³æ³¨çŠ¶æ€:",v.value))}catch(s){a("error","at pages/community/community.vue:776","æ£€æŸ¥å…³æ³¨çŠ¶æ€å¤±è´¥:",s),void 0!==e.isFollowing&&(v.value=e.isFollowing,a("log","at pages/community/community.vue:781","ä»ç”¨æˆ·å¯¹è±¡è·å–å…³æ³¨çŠ¶æ€:",v.value))}if(a("log","at pages/community/community.vue:786","åˆå§‹å…³æ³¨çŠ¶æ€è®¾ç½®ä¸º:",v.value),o.isAuthenticated)try{let o=null;try{a("log","at pages/community/community.vue:795","å°è¯•è·å–ç”¨æˆ·è¯¦æƒ…ï¼ŒID:",e._id),o=yield A.user.getUserById(e._id),a("log","at pages/community/community.vue:798","è·å–ç”¨æˆ·è¯¦æƒ…æˆåŠŸ:",o),o&&void 0!==o.isFollowing&&(v.value=v.value||o.isFollowing,a("log","at pages/community/community.vue:804","ç»¼åˆè€ƒè™‘åçš„å…³æ³¨çŠ¶æ€:",v.value))}catch(r){a("error","at pages/community/community.vue:807","è·å–ç”¨æˆ·è¯¦æƒ…å¤±è´¥, ä½¿ç”¨åŸºæœ¬ä¿¡æ¯:",r),o=__spreadProps(__spreadValues({},e),{nickname:e.nickname||e.username||"ç”¨æˆ·",bio:e.bio||"è¿™ä½ç”¨æˆ·è¿˜æ²¡æœ‰ä¸ªäººç®€ä»‹"}),uni.showToast({title:"è·å–ç”¨æˆ·è¯¦æƒ…å¤±è´¥",icon:"none",duration:1500})}if(o){t&&(v.value=!1),p.value=__spreadProps(__spreadValues({},o),{isCurrentUser:t,isFollowing:v.value}),a("log","at pages/community/community.vue:837","æ›´æ–°åçš„selectedUserå’ŒisFollowing:",p.value,v.value);try{a("log","at pages/community/community.vue:841","å°è¯•è·å–ç”¨æˆ·å® ç‰©åˆ—è¡¨ï¼Œç”¨æˆ·ID:",e._id);const t=yield A.user.getPetsByUser(e._id);a("log","at pages/community/community.vue:843","è·å–åˆ°çš„å® ç‰©åˆ—è¡¨:",t),g.value=t||[]}catch(n){a("error","at pages/community/community.vue:846","è·å–å® ç‰©åˆ—è¡¨å¤±è´¥:",n),g.value=[]}}}catch(s){a("error","at pages/community/community.vue:851","è·å–ç”¨æˆ·è¯¦æƒ…è¿‡ç¨‹ä¸­å‡ºé”™:",s),p.value=__spreadProps(__spreadValues({},e),{isCurrentUser:t,isFollowing:v.value,nickname:e.nickname||e.username||"ç”¨æˆ·",bio:e.bio||"è¿™ä½ç”¨æˆ·è¿˜æ²¡æœ‰ä¸ªäººç®€ä»‹"})}a("log","at pages/community/community.vue:864","æœ€ç»ˆç”¨æˆ·ä¿¡æ¯å’Œå…³æ³¨çŠ¶æ€:",{user:p.value,isFollowing:v.value,pets:g.value}),m.value=!0})),closeUserPopup:()=>{m.value=!1,p.value=null,g.value=[]},messageUser:e=>{a("log","at pages/community/community.vue:883","å‘ç”¨æˆ·å‘é€æ¶ˆæ¯:",e)},followUser:e=>__async(this,null,(function*(){if(o.isAuthenticated)if(e&&e._id)try{const t=yield A.user.followUser(e._id);t&&void 0!==t.isFollowing&&(v.value=t.isFollowing,uni.showToast({title:v.value?"å…³æ³¨æˆåŠŸ":"å–æ¶ˆå…³æ³¨æˆåŠŸ",icon:"success"}),p.value&&(p.value.isFollowing=v.value),yield o.fetchUserStats(),1!==s.value||v.value||f())}catch(t){a("error","at pages/community/community.vue:926","å…³æ³¨ç”¨æˆ·æ“ä½œå¤±è´¥:",t),uni.showToast({title:"æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}else a("error","at pages/community/community.vue:896","æ— æ•ˆçš„ç”¨æˆ·ä¿¡æ¯");else uni.navigateTo({url:"/pages/login/login"})}))}},onLoad(){const e=uni.getSystemInfoSync(),t=e.windowHeight;e.statusBarHeight;const o=uni.upx2px(170),s=uni.upx2px(100);this.scrollHeight=t-o-s,a("log","at pages/community/community.vue:990","è®¾ç½®æ»šåŠ¨åŒºåŸŸé«˜åº¦:",this.scrollHeight,"px (å·²å‡å»tabBaré«˜åº¦)"),this.$nextTick((()=>{uni.$api&&uni.$api.community?this.loadPosts():"function"==typeof this.showDefaultPosts&&this.showDefaultPosts()}))},mounted(){if(uni.$api&&uni.$api.community)this.loadPosts();else{a("warn","at pages/community/community.vue:1011","APIå°šæœªå‡†å¤‡å¥½ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®"),this.showDefaultPosts();const e=setInterval((()=>{uni.$api&&uni.$api.community&&(clearInterval(e),this.loadPosts())}),1e3);setTimeout((()=>{clearInterval(e)}),5e3)}},onPullDownRefresh(){a("log","at pages/community/community.vue:1031","é¡µé¢ä¸‹æ‹‰åˆ·æ–°è§¦å‘"),this.isRefreshing=!0,this.loadPosts(!0).finally((()=>{uni.stopPullDownRefresh(),setTimeout((()=>{this.isRefreshing=!1}),300)}))},onShow(){const e=Date.now();this.lastPublishTime&&e-this.lastPublishTime<15e3&&(a("log","at pages/community/community.vue:1047","æ£€æµ‹åˆ°å¯èƒ½å‘å¸ƒæ–°å¸–å­ï¼Œåˆ·æ–°å†…å®¹"),this.loadPosts&&this.loadPosts(!0))}},[["render",function(t,a,o,s,r,n){var i;const l=e.resolveComponent("walk-record-card"),c=e.resolveComponent("image-viewer"),u=e.resolveComponent("UserInfoPopup");return e.openBlock(),e.createElementBlock("view",{class:"community-container"},[e.createCommentVNode(" é¡¶éƒ¨æ ‡é¢˜æ  "),e.createElementVNode("view",{class:"header"},[e.createElementVNode("text",{class:"title"},"ç¤¾åŒºåŠ¨æ€"),e.createElementVNode("view",{class:"create-post-btn",onClick:a[0]||(a[0]=(...e)=>s.navToCreate&&s.navToCreate(...e))},[e.createElementVNode("text",{class:"create-icon"},"+"),e.createElementVNode("text",{class:"create-text"},"å‘å¸ƒ")])]),e.createCommentVNode(" Tabåˆ‡æ¢ "),e.createElementVNode("view",{class:"tabs"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.tabs,((t,a)=>(e.openBlock(),e.createElementBlock("view",{class:e.normalizeClass(["tab-item",{active:s.currentTab===a}]),key:a,onClick:e=>s.switchTab(a)},[e.createElementVNode("text",null,e.toDisplayString(t),1)],10,["onClick"])))),128))]),e.createCommentVNode(" å¸–å­åˆ—è¡¨ "),e.createElementVNode("view",{class:"list-container"},[e.createElementVNode("scroll-view",{class:"post-list","scroll-y":"true",onScrolltolower:a[1]||(a[1]=(...e)=>s.loadMore&&s.loadMore(...e))},[s.posts&&0===s.posts.length&&!s.isLoading?(e.openBlock(),e.createElementBlock("view",{key:0,class:"no-posts"},[0===s.currentTab?(e.openBlock(),e.createElementBlock("text",{key:0},"æš‚æ—¶æ²¡æœ‰åŠ¨æ€ï¼Œå¿«å»å‘å¸ƒä¸€æ¡å§ï¼")):(e.openBlock(),e.createElementBlock("text",{key:1},"æš‚æ—¶æ²¡æœ‰åŠ¨æ€ï¼Œå¿«å»å…³æ³¨æ›´å¤šç‹—å‹å§ï¼"))])):e.createCommentVNode("v-if",!0),e.createCommentVNode(" å¸–å­é¡¹ "),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.posts,((t,a)=>{var o,r;return e.openBlock(),e.createElementBlock("view",{class:"post-item",key:t.id||t._id,onClick:e=>s.viewPostDetail(t)},[e.createElementVNode("view",{class:"post-header"},[e.createElementVNode("view",{class:"user-info"},[e.createElementVNode("image",{class:"user-avatar",src:s.formatAvatarUrl((null==(o=t.user)?void 0:o.avatar)||t.userAvatar),mode:"aspectFill",onClick:e.withModifiers((e=>s.showUserProfile(t.user||{_id:t.userId,username:t.username,avatar:t.userAvatar})),["stop"]),onError:e=>s.handleAvatarError(e,a)},null,40,["src","onClick","onError"]),e.createElementVNode("text",{class:"username"},e.toDisplayString((null==(r=t.user)?void 0:r.username)||t.username||"ç”¨æˆ·"),1)]),e.createElementVNode("text",{class:"post-time"},e.toDisplayString(s.formatDate(t.createdAt||t.time)),1)]),e.createElementVNode("view",{class:"post-content"},[e.createElementVNode("text",{class:"post-text"},e.toDisplayString(s.truncateText(t.content,40)),1),e.createCommentVNode(" é›ç‹—è®°å½•å¡ç‰‡ "),t.walkRecord?(e.openBlock(),e.createBlock(l,{key:0,record:t.walkRecord},null,8,["record"])):e.createCommentVNode("v-if",!0),e.createCommentVNode(" å¸–å­å›¾ç‰‡ "),t.images&&t.images.length>0?(e.openBlock(),e.createElementBlock("view",{key:1,class:"post-images"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(t.images.slice(0,3),((a,o)=>(e.openBlock(),e.createElementBlock("image",{key:o,src:s.formatImageUrl(a),mode:"aspectFill",class:e.normalizeClass(["post-image",{"single-image":1===t.images.length}]),onClick:e.withModifiers((e=>s.previewImage(t,o)),["stop"])},null,10,["src","onClick"])))),128)),t.images.length>3?(e.openBlock(),e.createElementBlock("view",{key:0,class:"more-images"},[e.createElementVNode("text",null,"+"+e.toDisplayString(t.images.length-3),1)])):e.createCommentVNode("v-if",!0)])):e.createCommentVNode("v-if",!0)]),e.createElementVNode("view",{class:"post-footer"},[e.createElementVNode("view",{class:"action-item",onClick:e.withModifiers((e=>s.likePost(t,a)),["stop"])},[e.createElementVNode("view",{class:e.normalizeClass(["action-icon like-icon",{active:t.isLiked}])},null,2),e.createElementVNode("text",{class:"action-text"},"ç‚¹èµ "+e.toDisplayString(s.getNumberValue(t.likes)),1)],8,["onClick"]),e.createElementVNode("view",{class:"action-item",onClick:e.withModifiers((e=>s.viewComments(t)),["stop"])},[e.createElementVNode("view",{class:"action-icon comment-icon"}),e.createElementVNode("text",{class:"action-text"},"è¯„è®º "+e.toDisplayString(s.getNumberValue(t.comments)),1)],8,["onClick"])])],8,["onClick"])})),128))],32),s.isLoading?(e.openBlock(),e.createElementBlock("view",{key:0,class:"loading-more"},[e.createElementVNode("text",null,"åŠ è½½ä¸­...")])):e.createCommentVNode("v-if",!0)]),e.createCommentVNode(" æ‚¬æµ®åˆ›å»ºæŒ‰é’® "),e.createElementVNode("view",{class:"float-btn",onClick:a[2]||(a[2]=(...e)=>s.navToCreate&&s.navToCreate(...e))},[e.createElementVNode("text",{class:"float-icon"},"+")]),e.createCommentVNode(" å›¾ç‰‡æŸ¥çœ‹å™¨ "),e.createVNode(c,{show:s.showImageViewer,images:(null==(i=s.currentPost)?void 0:i.images)||[],initialIndex:s.currentImageIndex,onClose:s.closeImageViewer},null,8,["show","images","initialIndex","onClose"]),e.createCommentVNode(" ç”¨æˆ·ä¿¡æ¯å¼¹çª— "),s.showUserPopup?(e.openBlock(),e.createBlock(u,{key:0,user:s.selectedUser,pets:s.selectedUserPets,"is-following":s.isFollowing,visible:s.showUserPopup,onClose:s.closeUserPopup,onMessage:s.messageUser,onFollow:s.followUser},null,8,["user","pets","is-following","visible","onClose","onMessage","onFollow"])):e.createCommentVNode("v-if",!0)])}],["__file","D:/caloriesH5/CloudStorage/pages/community/community.vue"]]);const pt=ze({__name:"index",setup(t,{expose:o}){o();const s=Re(),r=Oe(),n=e.ref(!1),i=e.ref(null),l="http://49.235.65.37:5000",u=e.computed((()=>{const e=s.userAvatar;if(a("log","at pages/index/index.vue:122","å½“å‰ç”¨æˆ·å¤´åƒè·¯å¾„:",e),e&&e.startsWith("/uploads/")){const t=l+e;return a("log","at pages/index/index.vue:127","å®Œæ•´å¤´åƒURL:",t),t}return e||"/static/images/default-avatar.png"})),d=e.computed((()=>s.stats||{walkCount:0,totalDistance:0,following:0,followers:0})),g=e.ref([]);function v(){try{const e=uni.getStorageSync("token"),t=uni.getStorageSync("userInfo");e&&t?(i.value=JSON.parse(t),n.value=!0,s.isAuthenticated||(s.token=e,s.user=i.value),i.value&&i.value.avatar&&s.user&&(s.user.avatar=i.value.avatar),f()):h()}catch(e){a("error","at pages/index/index.vue:176","åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",e),h()}}function h(){i.value=null,n.value=!1,s.isAuthenticated&&(s.user=null,s.token=null,s.stats=null)}function f(){return __async(this,null,(function*(){if(s.isAuthenticated)try{a("log","at pages/index/index.vue:205","Loaded user stats:",yield s.fetchUserStats())}catch(e){a("error","at pages/index/index.vue:209","è·å–ç”¨æˆ·ç»Ÿè®¡æ•°æ®å¤±è´¥:",e)}}))}function y(e){n.value||"/pages/login/login"===e?p(e):c("Please login first")}e.onMounted((()=>{const e=uni.getStorageSync("token"),t=uni.getStorageSync("userInfo");if(e&&t){if(v(),r.fetchPets(),s.token){const e=uni.getStorageSync("userInfo");if(e)try{const t=JSON.parse(e);t&&t._id&&(s.user=t,a("log","at pages/index/index.vue:464","å·²ä»ç¼“å­˜åŠ è½½ç”¨æˆ·ä¿¡æ¯:",t))}catch(o){a("error","at pages/index/index.vue:467","è§£æå­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",o)}setTimeout((()=>{s.fetchUserInfo().then((()=>{a("log","at pages/index/index.vue:474","å·²ä»æœåŠ¡å™¨æ›´æ–°ç”¨æˆ·ä¿¡æ¯")})).catch((e=>{a("error","at pages/index/index.vue:476","ä»æœåŠ¡å™¨æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",e)}))}),500)}}else uni.navigateTo({url:"/pages/login/login",success:()=>{c("è¯·å…ˆç™»å½•")}})})),e.watch((()=>s.user),(e=>{a("log","at pages/index/index.vue:519","User store changed, refresh data"),e&&(s.fetchUserStats(),r.fetchPets())}),{deep:!0}),e.watch((()=>r.pets),(e=>{a("log","at pages/index/index.vue:529","Pet list updated, total pets:",e.length)}),{deep:!0});const w={userStore:s,petStore:r,isLoggedIn:n,userInfo:i,apiBaseUrl:l,displayAvatar:u,stats:d,pets:g,loadUserInfo:v,resetUserInfo:h,loadUserStats:f,loadPets:function(){return __async(this,null,(function*(){if(s.isAuthenticated)try{yield r.fetchPets()}catch(e){a("error","at pages/index/index.vue:223","è·å–å® ç‰©æ•°æ®å¤±è´¥:",e)}}))},toggleLogin:function(){s.isAuthenticated?m({title:"é€€å‡ºç™»å½•",content:"ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ",showCancel:!0}).then((e=>{e&&s.logout().then((()=>{h(),c("å·²æˆåŠŸé€€å‡ºç™»å½•")})).catch((e=>{a("error","at pages/index/index.vue:244","é€€å‡ºç™»å½•å¤±è´¥:",e),c("é€€å‡ºç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•")}))})):p("/pages/login/login")},changeAvatar:function(){return __async(this,null,(function*(){if(!s.isAuthenticated)return c("è¯·å…ˆç™»å½•");try{const t=(yield new Promise(((e,t)=>{uni.chooseImage({count:6,sizeType:["compressed"],sourceType:["album","camera"],success:e,fail:t})}))).tempFilePaths;c("ä¸Šä¼ ä¸­...");try{const e=yield s.uploadAvatar(t);e&&(e.avatar||e.data&&e.data.avatar)?(c("å¤´åƒä¸Šä¼ æˆåŠŸ"),yield s.fetchUserInfo()):c("å¤´åƒä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•")}catch(e){a("error","at pages/index/index.vue:291","å¤´åƒä¸Šä¼ å¤±è´¥:",e),c("å¤´åƒä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•")}}catch(e){a("error","at pages/index/index.vue:295","é€‰æ‹©å›¾ç‰‡å¤±è´¥:",e)}}))},editProfile:function(){if(!s.isAuthenticated)return c("è¯·å…ˆç™»å½•");p("/pages/profile/profile")},addPet:function(){s.isAuthenticated?(a("log","at pages/index/index.vue:319","å¼€å§‹å¯¼èˆªåˆ°æ·»åŠ å® ç‰©é¡µé¢"),uni.navigateTo({url:"/pages/pet/edit?mode=add",success:e=>{a("log","at pages/index/index.vue:325","å¯¼èˆªåˆ°æ·»åŠ å® ç‰©é¡µé¢æˆåŠŸ",e)},fail:e=>{a("error","at pages/index/index.vue:328","å¯¼èˆªåˆ°æ·»åŠ å® ç‰©é¡µé¢å¤±è´¥:",e),uni.navigateTo({url:"/pages/pet/edit",success:()=>{a("log","at pages/index/index.vue:334","ä½¿ç”¨ç®€åŒ–è·¯å¾„å¯¼èˆªæˆåŠŸ");const e=getCurrentPages(),t=e[e.length-1];t&&t.$vm&&(t.$vm.mode="add",a("log","at pages/index/index.vue:340","æ‰‹åŠ¨è®¾ç½®é¡µé¢mode=add"))},fail:e=>{a("error","at pages/index/index.vue:344","ä½¿ç”¨ç®€åŒ–è·¯å¾„ä»ç„¶å¤±è´¥:",e),uni.navigateTo({url:"/pages/pet/management",success:()=>{a("log","at pages/index/index.vue:350","å¯¼èˆªåˆ°å® ç‰©ç®¡ç†é¡µé¢æˆåŠŸ"),c("è¯·ç‚¹å‡»æ·»åŠ å® ç‰©æŒ‰é’®")},fail:()=>{c("é¡µé¢è·³è½¬å¤±è´¥ï¼Œè¯·ç¨åå†è¯•")}})}})}})):c("è¯·å…ˆç™»å½•")},navTo:y,editPet:function(e){n.value?p(`/pages/pet/edit?petId=${e}&mode=edit`):c("è¯·å…ˆç™»å½•")},formatImageUrl:function(e){if(!e)return"/static/images/default-pet.png";if(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("/static/"))return e;if(e.startsWith("/uploads")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}if(e.startsWith("uploads/")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+"/"+e}return"/static/images/default-pet.png"},showFollowList:function(e){if(!s.isAuthenticated)return c("è¯·å…ˆç™»å½•"),void setTimeout((()=>{y("/pages/login/login")}),1500);"following"===e?y("/pages/profile/following"):"followers"===e&&y("/pages/profile/followers")},onShow:function(){if(s.isAuthenticated||uni.getStorageSync("token"))if(s.isAuthenticated)s.fetchUserStats(),r.fetchPets();else{const e=uni.getStorageSync("token");e&&!s.token&&(s.token=e,s.init().then((()=>{s.user||uni.navigateTo({url:"/pages/login/login"})})))}else uni.navigateTo({url:"/pages/login/login",success:()=>{c("è¯·å…ˆç™»å½•")}})},openPetRecognition:function(){s.isAuthenticated?p("/pages/pet/recognition"):c("è¯·å…ˆç™»å½•")},handleAddMarker:function(){s.isAuthenticated?uni.navigateTo({url:"/pages/map/index"}):c("è¯·å…ˆç™»å½•")},handleRefreshLocation:function(){uni.getLocation({type:"gcj02",success:e=>{var t;const{latitude:a,longitude:o}=e;null==(t=mapContext.value)||t.moveToLocation({latitude:a,longitude:o})},fail:()=>{c("è·å–ä½ç½®å¤±è´¥")}})},ref:e.ref,computed:e.computed,onMounted:e.onMounted,watch:e.watch,get useUserStore(){return Re},get usePetStore(){return Oe},get showToast(){return c},get showModal(){return m},get navigateTo(){return p}};return Object.defineProperty(w,"__isScriptSetup",{enumerable:!1,value:!0}),w}},[["render",function(t,a,o,s,r,n){return e.openBlock(),e.createElementBlock("view",{class:"profile-container"},[e.createCommentVNode(" ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ "),e.createElementVNode("view",{class:"user-card"},[e.createElementVNode("view",{class:"avatar-wrapper"},[e.createElementVNode("image",{class:"avatar",src:s.displayAvatar,mode:"aspectFill",onClick:s.changeAvatar},null,8,["src"])]),e.createElementVNode("view",{class:"user-info"},[e.createElementVNode("view",{class:"nickname"},e.toDisplayString(s.userStore.nickname),1),e.createElementVNode("view",{class:"user-id"},"ID: "+e.toDisplayString(s.userStore.userId),1)]),e.createElementVNode("view",{class:"edit-btn",onClick:s.editProfile},[e.createElementVNode("text",null,"ç¼–è¾‘èµ„æ–™")])]),e.createCommentVNode(" ç”¨æˆ·ç»Ÿè®¡ "),e.createElementVNode("view",{class:"stats-card"},[e.createElementVNode("view",{class:"stat-item",onClick:a[0]||(a[0]=e=>s.navTo("/pages/walk/history"))},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString(s.stats.walkCount||0),1),e.createElementVNode("text",{class:"stat-label"},"é›ç‹—æ¬¡æ•°")]),e.createElementVNode("view",{class:"stat-item",onClick:a[1]||(a[1]=e=>s.navTo("/pages/walk/history"))},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString(s.stats.totalDistance||0),1),e.createElementVNode("text",{class:"stat-label"},"æ€»è·ç¦»(KM)")]),e.createElementVNode("view",{class:"stat-item",onClick:a[2]||(a[2]=e=>s.showFollowList("following"))},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString(s.stats.following||0),1),e.createElementVNode("text",{class:"stat-label"},"å…³æ³¨")]),e.createElementVNode("view",{class:"stat-item",onClick:a[3]||(a[3]=e=>s.showFollowList("followers"))},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString(s.stats.followers||0),1),e.createElementVNode("text",{class:"stat-label"},"ç²‰ä¸")])]),e.createCommentVNode(" å® ç‰©åˆ—è¡¨ "),e.createElementVNode("view",{class:"section"},[e.createElementVNode("view",{class:"section-header"},[e.createElementVNode("text",{class:"section-title"},"æˆ‘çš„å® ç‰©"),e.createElementVNode("view",{class:"add-btn",onClick:s.addPet},[e.createElementVNode("text",null,"æ·»åŠ å® ç‰©")])]),s.petStore.pets.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"pet-list"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.petStore.pets,(t=>(e.openBlock(),e.createElementBlock("view",{class:"pet-item",key:t.id||t._id,onClick:e=>s.editPet(t._id||t.id)},[e.createElementVNode("image",{class:"pet-avatar",src:s.formatImageUrl(t.avatar),mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"pet-info"},[e.createElementVNode("text",{class:"pet-name"},e.toDisplayString(t.name),1),e.createElementVNode("text",{class:"pet-breed"},e.toDisplayString(t.breed),1)]),e.createElementVNode("view",{class:"edit-indicator"},[e.createElementVNode("text",{class:"edit-arrow"},">")])],8,["onClick"])))),128))])):(e.openBlock(),e.createElementBlock("view",{key:1,class:"empty-list"},[e.createElementVNode("text",null,'è¿˜æ²¡æœ‰æ·»åŠ å® ç‰©ï¼Œç‚¹å‡»"æ·»åŠ å® ç‰©"å¼€å§‹å§ï¼')]))]),e.createCommentVNode(" åŠŸèƒ½èœå• "),e.createElementVNode("view",{class:"menu-section"},[e.createElementVNode("view",{class:"menu-item",onClick:a[4]||(a[4]=e=>s.navTo("/pages/walk/history"))},[e.createElementVNode("view",{class:"menu-icon walk-icon"}),e.createElementVNode("text",{class:"menu-text"},"é›ç‹—è®°å½•"),e.createElementVNode("view",{class:"arrow-icon"})]),e.createElementVNode("view",{class:"menu-item",onClick:a[5]||(a[5]=e=>s.navTo("/pages/community/my-posts"))},[e.createElementVNode("view",{class:"menu-icon post-icon"}),e.createElementVNode("text",{class:"menu-text"},"æˆ‘çš„åŠ¨æ€"),e.createElementVNode("view",{class:"arrow-icon"})]),e.createElementVNode("view",{class:"menu-item",onClick:a[6]||(a[6]=e=>s.navTo("/pages/profile/my-markers"))},[e.createElementVNode("view",{class:"menu-icon map-icon"}),e.createElementVNode("text",{class:"menu-text"},"æˆ‘çš„æ ‡è®°"),e.createElementVNode("view",{class:"arrow-icon"})]),e.createElementVNode("view",{class:"menu-item",onClick:s.openPetRecognition},[e.createElementVNode("view",{class:"menu-icon pet-icon"}),e.createElementVNode("text",{class:"menu-text"},"å® ç‰©è¯†åˆ«"),e.createElementVNode("view",{class:"arrow-icon"})]),e.createElementVNode("view",{class:"menu-item",onClick:a[7]||(a[7]=e=>s.navTo("/pages/profile/settings"))},[e.createElementVNode("view",{class:"menu-icon settings-icon"}),e.createElementVNode("text",{class:"menu-text"},"è®¾ç½®"),e.createElementVNode("view",{class:"arrow-icon"})])]),e.createCommentVNode(" ç™»å½•æŒ‰é’® "),e.createElementVNode("view",{class:"login-section"},[e.createElementVNode("button",{class:"login-btn",onClick:s.toggleLogin},e.toDisplayString(s.userStore.isAuthenticated?"é€€å‡ºç™»å½•":"ç™»å½•/æ³¨å†Œ"),1)])])}],["__file","D:/caloriesH5/CloudStorage/pages/index/index.vue"]]);const gt=ze({setup(){const t=e.ref(""),o=e.ref([]),s=e.ref(!1),r=e.ref(null),n=e.ref(null),i=e.ref(!1),l=e.ref("");uni.getLocation({type:"gcj02",success:e=>{a("log","at pages/community/create.vue:110","è·å–ä½ç½®æˆåŠŸ:",e),n.value={type:"Point",coordinates:[e.longitude,e.latitude]}},fail:e=>{a("error","at pages/community/create.vue:117","è·å–ä½ç½®å¤±è´¥:",e),n.value={type:"Point",coordinates:[116.3,39.9]}}});uni.$on("createPost",(e=>{a("log","at pages/community/create.vue:187","æ”¶åˆ°é¢„å¡«å†…å®¹:",e),e&&e.content&&(t.value=e.content),e&&e.walkRecord&&(r.value=e.walkRecord,a("log","at pages/community/create.vue:194","è®¾ç½®é›ç‹—è®°å½•:",r.value))}));uni.$once("hook:beforeDestroy",(()=>{uni.$off("createPost")}));const c=e=>__async(this,null,(function*(){try{uni.showLoading({title:"åŠ è½½å¸–å­æ•°æ®..."});const l=`post_cache_${e}_`;let c=null;const u=uni.getStorageInfoSync().keys||[];for(const e of u)if(e.startsWith(l))try{const t=uni.getStorageSync(e);if(t){c=JSON.parse(t),a("log","at pages/community/create.vue:465","æ‰¾åˆ°ç¼“å­˜çš„å¸–å­æ•°æ®:",c);break}}catch(s){a("error","at pages/community/create.vue:469","è§£æç¼“å­˜æ•°æ®å¤±è´¥:",s)}if(!c)try{if(uni.$api&&uni.$api.community&&"function"==typeof uni.$api.community.getPostDetail)c=yield uni.$api.community.getPostDetail(e),a("log","at pages/community/create.vue:480","APIè·å–å¸–å­æ•°æ®æˆåŠŸ:",c);else{a("warn","at pages/community/create.vue:482","APIä¸­æ²¡æœ‰getPostDetailæ–¹æ³•ï¼Œå°è¯•ä»é¡µé¢å‚æ•°è·å–");const e=getCurrentPages(),t=e[e.length-1].options||{};if(t.postKey)try{const e=uni.getStorageSync(t.postKey);e&&(c=JSON.parse(e),a("log","at pages/community/create.vue:494","ä»é¡µé¢å‚æ•°ç¼“å­˜è·å–å¸–å­æ•°æ®:",c))}catch(s){a("error","at pages/community/create.vue:497","è§£æé¡µé¢å‚æ•°ç¼“å­˜æ•°æ®å¤±è´¥:",s)}}}catch(i){a("error","at pages/community/create.vue:502","ä»APIè·å–å¸–å­æ•°æ®å¤±è´¥:",i);const e=getCurrentPages(),t=e[e.length-1].options||{};if(t.postKey)try{const e=uni.getStorageSync(t.postKey);e&&(c=JSON.parse(e),a("log","at pages/community/create.vue:514","ä»é¡µé¢å‚æ•°ç¼“å­˜è·å–å¸–å­æ•°æ®:",c))}catch(s){a("error","at pages/community/create.vue:517","è§£æé¡µé¢å‚æ•°ç¼“å­˜æ•°æ®å¤±è´¥:",s)}}c?(t.value=c.content||"",c.images&&c.images.length>0&&(o.value=[...c.images]),c.walkRecord&&(r.value=c.walkRecord),c.location&&(n.value=c.location)):uni.showToast({title:"è·å–å¸–å­å¤±è´¥",icon:"none"})}catch(i){a("error","at pages/community/create.vue:548","åŠ è½½å¸–å­æ•°æ®å¤±è´¥:",i),uni.showToast({title:"åŠ è½½å¸–å­æ•°æ®å¤±è´¥",icon:"none"})}finally{uni.hideLoading()}}));e.onMounted((()=>{const e=getCurrentPages(),s=e[e.length-1].options||{};if(a("log","at pages/community/create.vue:564","é¡µé¢å‚æ•°:",s),"edit"===s.mode&&s.id)if(i.value=!0,l.value=s.id,s.postKey)try{const e=uni.getStorageSync(s.postKey);if(e){const s=JSON.parse(e);a("log","at pages/community/create.vue:577","ä»ä¼ å…¥çš„ç¼“å­˜é”®åŠ è½½å¸–å­æ•°æ®:",s),t.value=s.content||"",s.images&&s.images.length>0&&(o.value=[...s.images]),s.walkRecord&&(r.value=s.walkRecord),s.location&&(n.value=s.location)}else c(s.id)}catch(u){a("error","at pages/community/create.vue:601","è§£æç¼“å­˜æ•°æ®å¤±è´¥:",u),c(s.id)}else c(s.id)}));return{content:t,images:o,isSubmitting:s,walkRecord:r,userLocation:n,isEditMode:i,editPostId:l,formatDuration:e=>{const t=Math.floor(e/3600),a=Math.floor(e%3600/60);let o="";return t>0&&(o+=`${t}å°æ—¶`),(a>0||t>0)&&(o+=`${a}åˆ†é’Ÿ`),o+=`${e%60}ç§’`,o},navBack:()=>{uni.navigateBack()},chooseImage:()=>{uni.chooseImage({count:6-o.value.length,sizeType:["compressed"],sourceType:["album","camera"],success:e=>{o.value=[...o.value,...e.tempFilePaths]}})},removeImage:e=>{o.value.splice(e,1)},previewImage:(e,t)=>{uni.previewImage({urls:o.value,current:t,indicator:"number",loop:!0,longPressActions:{itemList:["ä¿å­˜å›¾ç‰‡","å–æ¶ˆ"],success:function(e){0===e.tapIndex&&uni.saveImageToPhotosAlbum({filePath:o.value[t],success:function(){uni.showToast({title:"å›¾ç‰‡å·²ä¿å­˜",icon:"success"})},fail:function(){uni.showToast({title:"ä¿å­˜å¤±è´¥",icon:"none"})}})}}})},submitPost:()=>__async(this,null,(function*(){if(!t.value.trim())return void uni.showToast({title:"è¯·è¾“å…¥å†…å®¹",icon:"none"});if(s.value)return;if(s.value=!0,uni.showLoading({title:i.value?"æ›´æ–°ä¸­...":"å‘å¸ƒä¸­..."}),!n.value)try{yield new Promise((e=>{uni.getLocation({type:"gcj02",success:t=>{n.value={type:"Point",coordinates:[t.longitude,t.latitude]},a("log","at pages/community/create.vue:245","å‘å¸–å‰è·å–ä½ç½®æˆåŠŸ:",n.value),e()},fail:t=>{a("error","at pages/community/create.vue:249","å‘å¸–å‰è·å–ä½ç½®å¤±è´¥:",t),n.value={type:"Point",coordinates:[116.3,39.9]},e()}})}))}catch(c){a("error","at pages/community/create.vue:260","è·å–ä½ç½®è¿‡ç¨‹ä¸­å‡ºé”™:",c),n.value={type:"Point",coordinates:[116.3,39.9]}}const e={content:t.value,walkRecord:r.value?{_id:r.value._id,distance:r.value.distance,duration:r.value.duration,pet:r.value.pet}:null,location:{type:"Point",coordinates:n.value?n.value.coordinates:[116.3,39.9]}};a("log","at pages/community/create.vue:288",`å‡†å¤‡${i.value?"æ›´æ–°":"å‘é€"}çš„å¸–å­æ•°æ®:`,e);try{if(!uni.$api||!uni.$api.community)throw new Error("ç¤¾åŒºAPIæœªåˆå§‹åŒ–");let t;i.value&&l.value?(t=yield uni.$api.community.updatePost(l.value,e),a("log","at pages/community/create.vue:302","æ›´æ–°å¸–å­æˆåŠŸï¼Œç»“æœ:",t)):(t=yield uni.$api.community.createPost(e),a("log","at pages/community/create.vue:306","å‘å¸ƒå¸–å­æˆåŠŸï¼Œç»“æœ:",t));const s=l.value||t&&t._id||t&&t.id||t&&t.data&&t.data._id;if(!s)throw a("error","at pages/community/create.vue:314","æ— æ³•è·å–æœ‰æ•ˆçš„å¸–å­ID:",t),new Error("åˆ›å»ºå¸–å­æˆåŠŸä½†æ— æ³•è·å–å¸–å­ID");if(a("log","at pages/community/create.vue:318","è·å–åˆ°çš„å¸–å­ID:",s),o.value&&o.value.length>0&&s){a("log","at pages/community/create.vue:322","å‡†å¤‡ä¸Šä¼ å¸–å­å›¾ç‰‡, å¸–å­ID:",s);try{const e=[];for(let t=0;t<o.value.length;t++)if(o.value[t].startsWith("blob:")||o.value[t].startsWith("file:")||!o.value[t].startsWith("http")){uni.showLoading({title:`ä¸Šä¼ å›¾ç‰‡ ${t+1}/${o.value.length}...`});try{const r=yield uni.$api.community.uploadPostImage(s,o.value[t]);a("log","at pages/community/create.vue:341",`å›¾ç‰‡ ${t+1} ä¸Šä¼ æˆåŠŸ:`,r),r&&r.url&&e.push(r.url)}catch(u){a("error","at pages/community/create.vue:348",`å›¾ç‰‡ ${t+1} ä¸Šä¼ å¤±è´¥:`,u),uni.showToast({title:`å›¾ç‰‡ ${t+1} ä¸Šä¼ å¤±è´¥ï¼Œå°†ç»§ç»­ä¸Šä¼ å…¶ä»–å›¾ç‰‡`,icon:"none",duration:2e3});try{"string"==typeof o.value[t]&&(o.value[t].startsWith("file://")||o.value[t].startsWith("/storage/"))&&(a("log","at pages/community/create.vue:361",`å°è¯•ä¿å­˜æœ¬åœ°å›¾ç‰‡è·¯å¾„: ${o.value[t]}`),e.push(o.value[t]))}catch(c){a("error","at pages/community/create.vue:365","ä¿å­˜æœ¬åœ°å›¾ç‰‡è·¯å¾„å¤±è´¥:",c)}}}else(o.value[t].startsWith("http")||o.value[t].startsWith("/uploads"))&&e.push(o.value[t]);if(e.length>0){a("log","at pages/community/create.vue:376","æ‰€æœ‰å›¾ç‰‡ä¸Šä¼ å®Œæˆï¼Œæ›´æ–°å¸–å­å›¾ç‰‡å­—æ®µ:",e);try{const t=Array.isArray(e)?{images:e}:{images:[e]};if(a("log","at pages/community/create.vue:383","å‘é€æ›´æ–°å¸–å­è¯·æ±‚ï¼Œæ•°æ®:",t),"string"!=typeof s||!s.trim())throw a("error","at pages/community/create.vue:387","æ›´æ–°å›¾ç‰‡æ—¶å‘ç°å¸–å­IDæ— æ•ˆ:",s),new Error("å¸–å­IDæ— æ•ˆï¼Œæ— æ³•æ›´æ–°å›¾ç‰‡");i.value?(yield uni.$api.community.updatePost(s,t),a("log","at pages/community/create.vue:395","æ›´æ–°å¸–å­å›¾ç‰‡æˆåŠŸ")):a("log","at pages/community/create.vue:398","å‘å¸ƒæ–°å¸–æ¨¡å¼ï¼Œè·³è¿‡æ›´æ–°å¸–å­å›¾ç‰‡æ­¥éª¤")}catch(d){a("error","at pages/community/create.vue:401","æ›´æ–°å¸–å­å›¾ç‰‡å­—æ®µå¤±è´¥:",d)}}}catch(m){a("error","at pages/community/create.vue:406","ä¸Šä¼ å›¾ç‰‡è¿‡ç¨‹ä¸­å‡ºé”™:",m)}}uni.hideLoading(),uni.showToast({title:i.value?"æ›´æ–°æˆåŠŸ":"å‘å¸ƒæˆåŠŸ",icon:"success"}),setTimeout((()=>{uni.navigateBack()}),1500)}catch(p){uni.hideLoading(),uni.showToast({title:"å‘å¸ƒå¤±è´¥: "+(p.message||"æœªçŸ¥é”™è¯¯"),icon:"none",duration:2e3}),a("error","at pages/community/create.vue:435","å‘å¸ƒå¸–å­å¤±è´¥",p)}finally{s.value=!1}})),loadPostData:c,testMultipleImages:()=>{uni.chooseImage({count:6,sizeType:["original","compressed"],sourceType:["album"],success:e=>{a("log","at pages/community/create.vue:620","é€‰æ‹©äº†å¤šå¼ å›¾ç‰‡:",e.tempFilePaths),o.value=[...e.tempFilePaths],t.value||(t.value="æµ‹è¯•å¤šå›¾ä¸Šä¼ åŠŸèƒ½ï¼Œè¿™æ˜¯ä¸€ä¸ªåŒ…å«å¤šå¼ å›¾ç‰‡çš„å¸–å­"),uni.showToast({title:`å·²é€‰æ‹©${e.tempFilePaths.length}å¼ å›¾ç‰‡`,icon:"none"})}})}}}},[["render",function(t,a,o,s,r,n){return e.openBlock(),e.createElementBlock("view",{class:"create-post"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("view",{class:"back-btn",onClick:a[0]||(a[0]=(...e)=>s.navBack&&s.navBack(...e))},[e.createElementVNode("text",null,"å–æ¶ˆ")]),e.createElementVNode("text",{class:"title"},e.toDisplayString(s.isEditMode?"ç¼–è¾‘åŠ¨æ€":"å‘å¸ƒåŠ¨æ€"),1),e.createElementVNode("view",{class:"submit-btn",onClick:a[1]||(a[1]=(...e)=>s.submitPost&&s.submitPost(...e))},[e.createElementVNode("text",null,e.toDisplayString(s.isEditMode?"æ›´æ–°":"å‘å¸ƒ"),1)])]),e.createElementVNode("view",{class:"content-area"},[e.withDirectives(e.createElementVNode("textarea",{class:"post-textarea","onUpdate:modelValue":a[2]||(a[2]=e=>s.content=e),placeholder:"åˆ†äº«æ‚¨çš„é›ç‹—å¿ƒå¾—...",maxlength:"500","auto-height":""},null,512),[[e.vModelText,s.content]]),e.createCommentVNode(" å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ "),e.createElementVNode("view",{class:"image-upload"},[e.createElementVNode("view",{class:"image-list"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.images,((t,a)=>(e.openBlock(),e.createElementBlock("view",{class:"image-item",key:a},[e.createElementVNode("image",{class:"preview",src:t,mode:"aspectFill",onClick:e=>s.previewImage(t,a)},null,8,["src","onClick"]),e.createElementVNode("text",{class:"delete-btn",onClick:e=>s.removeImage(a)},"Ã—",8,["onClick"])])))),128)),s.images.length<6?(e.openBlock(),e.createElementBlock("view",{key:0,class:"add-image",onClick:a[3]||(a[3]=(...e)=>s.chooseImage&&s.chooseImage(...e))},[e.createElementVNode("text",{class:"add-icon"},"+")])):e.createCommentVNode("v-if",!0)]),e.createCommentVNode(" å¤šå›¾æµ‹è¯•æŒ‰é’® "),0===s.images.length?(e.openBlock(),e.createElementBlock("view",{key:0,class:"test-btn",onClick:a[4]||(a[4]=(...e)=>s.testMultipleImages&&s.testMultipleImages(...e))},[e.createElementVNode("text",null,"é€‰æ‹©å¤šå¼ å›¾ç‰‡æµ‹è¯•")])):e.createCommentVNode("v-if",!0)]),e.createElementVNode("view",{class:"char-counter"},[e.createElementVNode("text",null,e.toDisplayString(s.content.length)+"/500",1)]),e.createCommentVNode(" é›ç‹—è®°å½•å¡ç‰‡ "),s.walkRecord?(e.openBlock(),e.createElementBlock("view",{key:0,class:"walk-record-card"},[e.createElementVNode("view",{class:"card-header"},[e.createElementVNode("text",{class:"card-icon"},"ğŸ¾"),e.createElementVNode("text",{class:"card-title"},"é›ç‹—è®°å½•")]),e.createElementVNode("view",{class:"card-content"},[e.createElementVNode("view",{class:"card-item"},[e.createElementVNode("text",{class:"item-label"},"è·ç¦»"),e.createElementVNode("text",{class:"item-value"},e.toDisplayString((s.walkRecord.distance/1e3).toFixed(2))+"å…¬é‡Œ",1)]),e.createElementVNode("view",{class:"card-item"},[e.createElementVNode("text",{class:"item-label"},"æ—¶é•¿"),e.createElementVNode("text",{class:"item-value"},e.toDisplayString(s.formatDuration(s.walkRecord.duration)),1)]),s.walkRecord.pet?(e.openBlock(),e.createElementBlock("view",{key:0,class:"card-item"},[e.createElementVNode("text",{class:"item-label"},"å® ç‰©"),e.createElementVNode("view",{class:"pet-info"},[s.walkRecord.pet.avatar?(e.openBlock(),e.createElementBlock("image",{key:0,class:"pet-avatar",src:s.walkRecord.pet.avatar,mode:"aspectFill"},null,8,["src"])):e.createCommentVNode("v-if",!0),e.createElementVNode("text",{class:"pet-name"},e.toDisplayString(s.walkRecord.pet.name||"æœªå‘½åå® ç‰©"),1)])])):e.createCommentVNode("v-if",!0)]),e.createElementVNode("view",{class:"share-motivation"},[e.createElementVNode("text",{class:"motivation-text"},"åˆ†äº«é›ç‹—è®°å½•å¯ä»¥æ¿€åŠ±å…¶ä»–é“²å±å®˜ä¹ŸåŠ å…¥è¿åŠ¨!")])])):e.createCommentVNode("v-if",!0)])])}],["__file","D:/caloriesH5/CloudStorage/pages/community/create.vue"]]);const vt=ze({components:{WalkRecordCard:ut,ImageViewer:dt,UserInfoPopup:lt},data:()=>({postId:"",post:null,comments:[],commentContent:"",isLoading:!0,isSubmitting:!1,shouldScrollToComments:!1,showImageViewer:!1,currentImageIndex:0,showUserPopup:!1,selectedUser:null,selectedUserPets:[],isFollowing:!1}),onLoad(e){if(e&&e.id){if(this.postId=e.id,e.postKey)try{const t=uni.getStorageSync(e.postKey);if(t){const e=JSON.parse(t);if(e)return a("log","at pages/community/post-detail.vue:185","ä»ç¼“å­˜è·å–å¸–å­æ•°æ®:",e),this.post=e,void 0===this.post.isLiked&&(this.post.isLiked=!1),void 0===this.post.likes&&(this.post.likes=0),void 0===this.post.comments&&(this.post.comments=0),this.isLoading=!1,void this.loadComments()}}catch(t){a("error","at pages/community/post-detail.vue:203","è§£æç¼“å­˜çš„å¸–å­æ•°æ®å¤±è´¥:",t)}"true"===e.showComments&&(this.shouldScrollToComments=!0),this.loadPostDetail(),this.loadComments()}else uni.showToast({title:"æœªæ‰¾åˆ°å¸–å­",icon:"none"}),setTimeout((()=>{uni.navigateBack()}),1500)},onReady(){this.shouldScrollToComments&&setTimeout((()=>{uni.createSelectorQuery().in(this).select(".comment-divider").boundingClientRect((e=>{e&&uni.pageScrollTo({scrollTop:e.top,duration:300})})).exec()}),500)},methods:{getNumberValue:e=>Array.isArray(e)?e.length:"number"==typeof e?e:e&&"object"==typeof e?Object.keys(e).length:0,formatDuration(e){if(!e)return"0åˆ†é’Ÿ";const t=Math.floor(e/3600),a=Math.floor(e%3600/60);let o="";return t>0?(o+=`${t}å°æ—¶`,a>0&&(o+=`${a}åˆ†é’Ÿ`)):o+=`${a}åˆ†é’Ÿ`,o},navBack(){uni.navigateBack()},formatDate(e){if(!e)return"";if("string"==typeof e&&!e.includes("T")&&!e.includes("-"))return e;try{const t=new Date(e),a=new Date,o=Math.floor((a-t)/1e3);return o<60?"åˆšåˆš":o<3600?Math.floor(o/60)+"åˆ†é’Ÿå‰":o<86400?Math.floor(o/3600)+"å°æ—¶å‰":o<2592e3?Math.floor(o/86400)+"å¤©å‰":`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}catch(t){return a("error","at pages/community/post-detail.vue:311","æ—¥æœŸæ ¼å¼åŒ–é”™è¯¯:",t),e}},previewImage(e){this.currentImageIndex=e,this.showImageViewer=!0},closeImageViewer(){this.showImageViewer=!1},showUserProfile(e){return __async(this,null,(function*(){if(a("log","at pages/community/post-detail.vue:329","æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯:",e),!e||!e._id)return a("error","at pages/community/post-detail.vue:331","æ— æ•ˆçš„ç”¨æˆ·ä¿¡æ¯"),void uni.showToast({title:"æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯",icon:"none"});const t=Re(),o=t.isAuthenticated&&t.userId===e._id;if(this.selectedUser=__spreadProps(__spreadValues({},e),{isCurrentUser:o}),this.isFollowing=!1,t.isAuthenticated&&!o)try{a("log","at pages/community/post-detail.vue:357","ç›´æ¥è°ƒç”¨checkFollowStatusæ£€æŸ¥å…³æ³¨çŠ¶æ€ï¼Œç”¨æˆ·ID:",e._id);const t=yield A.user.checkFollowStatus(e._id);t&&void 0!==t.isFollowing&&(this.isFollowing=t.isFollowing,a("log","at pages/community/post-detail.vue:362","APIè¿”å›çš„å…³æ³¨çŠ¶æ€:",this.isFollowing))}catch(s){a("error","at pages/community/post-detail.vue:365","æ£€æŸ¥å…³æ³¨çŠ¶æ€å¤±è´¥:",s),void 0!==e.isFollowing&&(this.isFollowing=e.isFollowing,a("log","at pages/community/post-detail.vue:370","ä»ç”¨æˆ·å¯¹è±¡è·å–å…³æ³¨çŠ¶æ€:",this.isFollowing))}if(a("log","at pages/community/post-detail.vue:375","åˆå§‹å…³æ³¨çŠ¶æ€è®¾ç½®ä¸º:",this.isFollowing),t.isAuthenticated)try{let t=null;try{a("log","at pages/community/post-detail.vue:384","å°è¯•è·å–ç”¨æˆ·è¯¦æƒ…ï¼ŒID:",e._id),t=yield A.user.getUserById(e._id),a("log","at pages/community/post-detail.vue:387","è·å–ç”¨æˆ·è¯¦æƒ…æˆåŠŸ:",t),t&&void 0!==t.isFollowing&&(this.isFollowing=this.isFollowing||t.isFollowing,a("log","at pages/community/post-detail.vue:393","ç»¼åˆè€ƒè™‘åçš„å…³æ³¨çŠ¶æ€:",this.isFollowing))}catch(r){a("error","at pages/community/post-detail.vue:396","è·å–ç”¨æˆ·è¯¦æƒ…å¤±è´¥, ä½¿ç”¨åŸºæœ¬ä¿¡æ¯:",r),t=__spreadProps(__spreadValues({},e),{nickname:e.nickname||e.username||"ç”¨æˆ·",bio:e.bio||"è¿™ä½ç”¨æˆ·è¿˜æ²¡æœ‰ä¸ªäººç®€ä»‹"}),uni.showToast({title:"è·å–ç”¨æˆ·è¯¦æƒ…å¤±è´¥",icon:"none",duration:1500})}if(t){o&&(this.isFollowing=!1),this.selectedUser=__spreadProps(__spreadValues({},t),{isCurrentUser:o,isFollowing:this.isFollowing}),a("log","at pages/community/post-detail.vue:426","æ›´æ–°åçš„selectedUserå’ŒisFollowing:",this.selectedUser,this.isFollowing);try{a("log","at pages/community/post-detail.vue:430","å°è¯•è·å–ç”¨æˆ·å® ç‰©åˆ—è¡¨ï¼Œç”¨æˆ·ID:",e._id);const t=yield A.user.getPetsByUser(e._id);a("log","at pages/community/post-detail.vue:432","è·å–åˆ°çš„å® ç‰©åˆ—è¡¨:",t),this.selectedUserPets=t||[]}catch(n){a("error","at pages/community/post-detail.vue:435","è·å–å® ç‰©åˆ—è¡¨å¤±è´¥:",n),this.selectedUserPets=[]}}}catch(s){a("error","at pages/community/post-detail.vue:440","è·å–ç”¨æˆ·ä¿¡æ¯å¤„ç†è¿‡ç¨‹å‡ºé”™:",s),this.selectedUser=__spreadProps(__spreadValues({},e),{isCurrentUser:o,isFollowing:this.isFollowing}),uni.showToast({title:"è·å–ç”¨æˆ·è¯¦æƒ…å¤±è´¥",icon:"none"})}a("log","at pages/community/post-detail.vue:457","æœ€ç»ˆæ˜¾ç¤ºçš„ç”¨æˆ·ä¿¡æ¯å’Œå…³æ³¨çŠ¶æ€:",{user:this.selectedUser,isFollowing:this.isFollowing,pets:this.selectedUserPets}),this.showUserPopup=!0}))},closeUserPopup(){this.showUserPopup=!1,this.selectedUser=null,this.selectedUserPets=[]},messageUser(e){a("log","at pages/community/post-detail.vue:476","å‘ç”¨æˆ·å‘é€æ¶ˆæ¯:",e)},followUser(e){return __async(this,null,(function*(){const t=Re();if(t.isAuthenticated)if(e&&e._id)try{const a=yield A.user.followUser(e._id);a&&void 0!==a.isFollowing&&(this.isFollowing=a.isFollowing,this.selectedUser&&(this.selectedUser.isFollowing=this.isFollowing),uni.showToast({title:this.isFollowing?"å…³æ³¨æˆåŠŸ":"å–æ¶ˆå…³æ³¨æˆåŠŸ",icon:"success"}),yield t.fetchUserStats())}catch(o){a("error","at pages/community/post-detail.vue:516","å…³æ³¨ç”¨æˆ·æ“ä½œå¤±è´¥:",o),uni.showToast({title:"æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}else a("error","at pages/community/post-detail.vue:491","æ— æ•ˆçš„ç”¨æˆ·ä¿¡æ¯");else uni.navigateTo({url:"/pages/login/login"})}))},formatAvatarUrl(e){if(!e)return"/static/images/default-avatar.png";if(e.startsWith("http")||e.startsWith("/static"))return e;if(e.startsWith("/uploads")){const t=uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000";return a("log","at pages/community/post-detail.vue:537","å¤„ç†ç›¸å¯¹è·¯å¾„å¤´åƒURL:",e,"è¡¥å……åŸºç¡€URL:",t),t+e}return"object"==typeof e&&e.avatar?this.formatAvatarUrl(e.avatar):(a("warn","at pages/community/post-detail.vue:547","æœªèƒ½è¯†åˆ«çš„å¤´åƒURLæ ¼å¼:",e),"/static/images/default-avatar.png")},formatImageUrl(e){if(!e)return"/static/images/default-pet.png";if(a("log","at pages/community/post-detail.vue:555","å¸–å­è¯¦æƒ…é¡µå¤„ç†å›¾ç‰‡URL:",e),e.startsWith("http")||e.startsWith("/static")||e.startsWith("blob:"))return a("log","at pages/community/post-detail.vue:559","è¿”å›åŸå§‹URL:",e),e;if(e.startsWith("/uploads")){const t=uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000",o=t+e;return a("log","at pages/community/post-detail.vue:567","å¤„ç†ç›¸å¯¹è·¯å¾„å›¾ç‰‡URL:",e,"è¡¥å……åŸºç¡€URL:",t,"å®Œæ•´URL:",o),o}return a("warn","at pages/community/post-detail.vue:572","æœªèƒ½è¯†åˆ«çš„å›¾ç‰‡URLæ ¼å¼:",e),"/static/images/default-pet.png"},loadPostDetail(){return __async(this,null,(function*(){this.isLoading=!0;try{const t=uni.$api.community;if(!t)throw new Error("ç¤¾åŒºAPIæœªåˆå§‹åŒ–");try{a("log","at pages/community/post-detail.vue:591","å°è¯•åŠ è½½å¸–å­è¯¦æƒ…, ID:",this.postId);const e=yield t.getPostDetail(this.postId);if(!e)throw new Error("è·å–å¸–å­è¯¦æƒ…å¤±è´¥ï¼šç©ºå“åº”");a("log","at pages/community/post-detail.vue:595","è·å–åˆ°å¸–å­è¯¦æƒ…:",e),void 0===e.isLiked&&(e.isLiked=!1),void 0===e.likes&&(e.likes=0),void 0===e.comments&&(e.comments=0),this.post=this.parseWalkRecordFromContent(e),a("log","at pages/community/post-detail.vue:608","å¤„ç†åçš„å¸–å­è¯¦æƒ…:",this.post)}catch(e){a("error","at pages/community/post-detail.vue:613","è·å–å¸–å­è¯¦æƒ…å¤±è´¥:",e),uni.showToast({title:"åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åå†è¯•",icon:"none",duration:2e3}),setTimeout((()=>{uni.navigateBack()}),2e3)}}catch(e){a("error","at pages/community/post-detail.vue:627","åŠ è½½å¸–å­è¯¦æƒ…è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:",e),uni.showToast({title:"åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åå†è¯•",icon:"none",duration:2e3}),setTimeout((()=>{uni.navigateBack()}),2e3)}finally{this.isLoading=!1}}))},parseWalkRecordFromContent(e){if(e.walkRecord)return e;const t=e.content||"";let a=null;const o=t.match(/é›äº†\s*(\d+\.?\d*)\s*å…¬é‡Œ/),s=o?1e3*parseFloat(o[1]):null,r=t.match(/ç”¨æ—¶\s*(\d+)\s*(ç§’|åˆ†é’Ÿ|å°æ—¶)/);let n=null;if(r){const e=parseInt(r[1]),t=r[2];"ç§’"===t?n=e:"åˆ†é’Ÿ"===t?n=60*e:"å°æ—¶"===t&&(n=3600*e)}const i=t.match(/å’Œ\s*([^\s,ï¼Œã€‚ï¼]+)\s*ä¸€èµ·é›/),l=i?i[1]:"æˆ‘çš„å® ç‰©";return null!==s||null!==n?(a={_id:`generated_${e._id||e.id||Date.now()}`,distance:s||0,duration:n||0,pet:{name:l},startTime:e.createdAt||e.time||(new Date).toISOString()},__spreadProps(__spreadValues({},e),{walkRecord:a})):e},loadComments(){return __async(this,null,(function*(){try{if(!uni.$api||!uni.$api.community)return a("error","at pages/community/post-detail.vue:709","ç¤¾åŒºAPIæœªåˆå§‹åŒ–"),void(this.comments=[]);uni.showLoading({title:"åŠ è½½è¯„è®º..."});try{a("log","at pages/community/post-detail.vue:721","å°è¯•åŠ è½½è¯„è®º, å¸–å­ID:",this.postId);const e=yield uni.$api.community.getComments(this.postId,{limit:50});if(e&&(e.data||Array.isArray(e))){const t=Array.isArray(e)?e:Array.isArray(e.data)?e.data:[];a("log","at pages/community/post-detail.vue:731","è¯„è®ºåˆ—è¡¨:",t),this.comments=t}else a("log","at pages/community/post-detail.vue:735","æ²¡æœ‰æ‰¾åˆ°è¯„è®ºæˆ–è¿”å›ä¸ºç©º"),this.comments=[]}catch(e){a("error","at pages/community/post-detail.vue:739","è·å–è¯„è®ºå¤±è´¥:",e),this.comments=[]}finally{uni.hideLoading()}}catch(e){a("error","at pages/community/post-detail.vue:746","åŠ è½½è¯„è®ºè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:",e),uni.hideLoading(),this.comments=[]}}))},likePost(){return __async(this,null,(function*(){if(this.post)try{this.post.isLiked=!this.post.isLiked,this.post.likes=this.post.isLiked?(this.post.likes||0)+1:Math.max((this.post.likes||1)-1,0);const e=uni.$api.community;if(!e)throw new Error("ç¤¾åŒºAPIæœªåˆå§‹åŒ–");return yield e.likePost(this.postId,this.post.isLiked),void uni.showToast({title:this.post.isLiked?"ç‚¹èµæˆåŠŸ":"å·²å–æ¶ˆç‚¹èµ",icon:"none"})}catch(e){return a("error","at pages/community/post-detail.vue:780","ç‚¹èµæ“ä½œå¤±è´¥:",e),this.post.isLiked=!this.post.isLiked,this.post.likes=this.post.isLiked?(this.post.likes||0)+1:Math.max((this.post.likes||1)-1,0),void uni.showToast({title:"æ“ä½œå¤±è´¥",icon:"none"})}}))},submitComment(){return __async(this,null,(function*(){if(this.commentContent.trim()&&!this.isSubmitting){this.isSubmitting=!0;try{if(!uni.$api||!uni.$api.community)throw new Error("ç¤¾åŒºAPIæœªåˆå§‹åŒ–");yield uni.$api.community.addComment(this.postId,{content:this.commentContent}),this.commentContent="",this.loadComments(),this.post&&(this.post.comments=(this.post.comments||0)+1),uni.showToast({title:"è¯„è®ºæˆåŠŸ",icon:"success"})}catch(e){a("error","at pages/community/post-detail.vue:829","æäº¤è¯„è®ºå¤±è´¥:",e),uni.showToast({title:"è¯„è®ºå¤±è´¥ï¼Œè¯·ç¨åå†è¯•",icon:"none"})}finally{this.isSubmitting=!1}}}))},viewWalkRecord(){if(!this.post||!this.post.walkRecord||!this.post.walkRecord._id)return void uni.showToast({title:"é›ç‹—è®°å½•ä¸å­˜åœ¨",icon:"none"});a("log","at pages/community/post-detail.vue:850","æŸ¥çœ‹é›ç‹—è®°å½•è¯¦æƒ…:",this.post.walkRecord);this.post.walkRecord._id.startsWith("generated_")?uni.showToast({title:"è¿™æ˜¯ä»åŠ¨æ€å†…å®¹è§£æçš„é›ç‹—è®°å½•ï¼Œæ— æ³•æŸ¥çœ‹è¯¦æƒ…",icon:"none",duration:2500}):uni.navigateTo({url:`/pages/walk/detail?id=${this.post.walkRecord._id}`,fail:e=>{a("error","at pages/community/post-detail.vue:868","æ‰“å¼€é›ç‹—è®°å½•è¯¦æƒ…å¤±è´¥:",e),uni.showToast({title:"æ— æ³•æŸ¥çœ‹é›ç‹—è®°å½•",icon:"none"})}})}}},[["render",function(t,a,o,s,r,n){var i,l,c;const u=e.resolveComponent("walk-record-card"),d=e.resolveComponent("image-viewer"),m=e.resolveComponent("UserInfoPopup");return e.openBlock(),e.createElementBlock("view",{class:"post-detail-container"},[e.createCommentVNode(" é¡¶éƒ¨æ ‡é¢˜æ  "),e.createElementVNode("view",{class:"header"},[e.createElementVNode("view",{class:"back-btn",onClick:a[0]||(a[0]=(...e)=>n.navBack&&n.navBack(...e))},[e.createElementVNode("text",null,"è¿”å›")]),e.createElementVNode("text",{class:"title"},"å¸–å­è¯¦æƒ…"),e.createElementVNode("view",{class:"placeholder"})]),e.createCommentVNode(" å¸–å­å†…å®¹ "),e.createElementVNode("scroll-view",{class:"post-content-scrollview","scroll-y":""},[e.createCommentVNode(" åŠ è½½ä¸­æç¤º "),r.isLoading?(e.openBlock(),e.createElementBlock("view",{key:0,class:"loading"},[e.createElementVNode("text",null,"åŠ è½½ä¸­...")])):e.createCommentVNode("v-if",!0),e.createCommentVNode(" å¸–å­ä¸å­˜åœ¨æç¤º "),r.isLoading||r.post?e.createCommentVNode("v-if",!0):(e.openBlock(),e.createElementBlock("view",{key:1,class:"not-found"},[e.createElementVNode("text",null,"è¯¥å¸–å­ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤")])),e.createCommentVNode(" å¸–å­è¯¦æƒ… "),r.post?(e.openBlock(),e.createElementBlock("view",{key:2,class:"post-detail"},[e.createCommentVNode(" å¸–å­å¤´éƒ¨ "),e.createElementVNode("view",{class:"post-header"},[e.createElementVNode("view",{class:"user-info"},[e.createElementVNode("image",{class:"user-avatar",src:n.formatAvatarUrl((null==(i=r.post.user)?void 0:i.avatar)||r.post.userAvatar),mode:"aspectFill",onClick:a[1]||(a[1]=e=>n.showUserProfile(r.post.user||{_id:r.post.userId,username:r.post.username,avatar:r.post.userAvatar}))},null,8,["src"]),e.createElementVNode("text",{class:"username"},e.toDisplayString(r.post.username||(null==(l=r.post.user)?void 0:l.username)||"ç”¨æˆ·"),1)]),e.createElementVNode("text",{class:"post-time"},e.toDisplayString(n.formatDate(r.post.time||r.post.createdAt)),1)]),e.createCommentVNode(" å¸–å­å†…å®¹ "),e.createElementVNode("view",{class:"post-content"},[e.createElementVNode("text",{class:"post-text"},e.toDisplayString(r.post.content),1),e.createCommentVNode(" é›ç‹—è®°å½•å¡ç‰‡ "),r.post.walkRecord?(e.openBlock(),e.createBlock(u,{key:0,record:r.post.walkRecord},null,8,["record"])):e.createCommentVNode("v-if",!0),e.createCommentVNode(" å¸–å­å›¾ç‰‡ "),r.post.images&&r.post.images.length>0?(e.openBlock(),e.createElementBlock("view",{key:1,class:"post-images"},[e.createElementVNode("view",{class:"image-container"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(r.post.images,((t,a)=>(e.openBlock(),e.createElementBlock("image",{key:a,src:n.formatImageUrl(t),mode:"aspectFill",class:"post-image",onClick:e=>n.previewImage(a)},null,8,["src","onClick"])))),128))])])):e.createCommentVNode("v-if",!0)]),e.createCommentVNode(" å¸–å­äº’åŠ¨åŒº "),e.createElementVNode("view",{class:"post-actions"},[e.createElementVNode("view",{class:"action-item",onClick:a[2]||(a[2]=(...e)=>n.likePost&&n.likePost(...e))},[e.createElementVNode("view",{class:e.normalizeClass(["action-icon like-icon",{active:r.post.isLiked}]),style:{"background-image":"url('/static/images/like-icon.png')","background-size":"contain","background-repeat":"no-repeat"}},null,2),e.createElementVNode("text",{class:"action-text"},[e.createTextVNode("ç‚¹èµ "),e.createElementVNode("text",{class:"count"},e.toDisplayString(n.getNumberValue(r.post.likes)),1)])]),e.createElementVNode("view",{class:"action-item"},[e.createElementVNode("view",{class:"action-icon comment-icon",style:{"background-image":"url('/static/images/comment-icon.png')","background-size":"contain","background-repeat":"no-repeat"}}),e.createElementVNode("text",{class:"action-text"},[e.createTextVNode("è¯„è®º "),e.createElementVNode("text",{class:"count"},e.toDisplayString(n.getNumberValue(r.post.comments)),1)])])]),e.createCommentVNode(" è¯„è®ºåŒºåˆ†å‰²çº¿ "),e.createElementVNode("view",{class:"comment-divider"},[e.createElementVNode("text",null,"è¯„è®ºåŒº")]),e.createCommentVNode(" è¯„è®ºåˆ—è¡¨ "),e.createElementVNode("view",{class:"comment-list"},[r.comments&&0!==r.comments.length?e.createCommentVNode("v-if",!0):(e.openBlock(),e.createElementBlock("view",{key:0,class:"no-comments"},[e.createElementVNode("text",null,"æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§")])),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(r.comments,((t,a)=>{var o,s;return e.openBlock(),e.createElementBlock("view",{class:"comment-item",key:t.id||a},[e.createElementVNode("view",{class:"comment-header"},[e.createElementVNode("view",{class:"comment-user-info"},[e.createElementVNode("image",{class:"comment-avatar",src:n.formatAvatarUrl((null==(o=t.user)?void 0:o.avatar)||t.userAvatar),mode:"aspectFill",onClick:e=>n.showUserProfile(t.user||{_id:t.userId,username:t.username,avatar:t.userAvatar})},null,8,["src","onClick"]),e.createElementVNode("text",{class:"comment-username"},e.toDisplayString(t.username||(null==(s=t.user)?void 0:s.username)||"ç”¨æˆ·"),1)]),e.createElementVNode("text",{class:"comment-time"},e.toDisplayString(n.formatDate(t.time||t.createdAt)),1)]),e.createElementVNode("view",{class:"comment-content"},[e.createElementVNode("text",null,e.toDisplayString(t.content),1)])])})),128))])])):e.createCommentVNode("v-if",!0)]),e.createCommentVNode(" åº•éƒ¨è¯„è®ºè¾“å…¥åŒº "),e.createElementVNode("view",{class:"comment-input-area"},[e.withDirectives(e.createElementVNode("input",{class:"comment-input","onUpdate:modelValue":a[3]||(a[3]=e=>r.commentContent=e),placeholder:"å†™è¯„è®º...","confirm-type":"send",onConfirm:a[4]||(a[4]=(...e)=>n.submitComment&&n.submitComment(...e))},null,544),[[e.vModelText,r.commentContent]]),e.createElementVNode("view",{class:e.normalizeClass(["send-btn",{active:r.commentContent.trim()}]),onClick:a[5]||(a[5]=(...e)=>n.submitComment&&n.submitComment(...e))},[e.createElementVNode("text",null,"å‘é€")],2)]),e.createCommentVNode(" å›¾ç‰‡æŸ¥çœ‹å™¨ "),e.createVNode(d,{show:r.showImageViewer,images:(null==(c=r.post)?void 0:c.images)||[],initialIndex:r.currentImageIndex,onClose:n.closeImageViewer},null,8,["show","images","initialIndex","onClose"]),e.createCommentVNode(" ç”¨æˆ·ä¿¡æ¯å¼¹çª— "),r.showUserPopup?(e.openBlock(),e.createBlock(m,{key:0,user:r.selectedUser,pets:r.selectedUserPets,"is-following":r.isFollowing,visible:r.showUserPopup,onClose:n.closeUserPopup,onMessage:n.messageUser,onFollow:n.followUser},null,8,["user","pets","is-following","visible","onClose","onMessage","onFollow"])):e.createCommentVNode("v-if",!0)])}],["__file","D:/caloriesH5/CloudStorage/pages/community/post-detail.vue"]]),ht=$e("pet",{state:()=>({pets:[],currentPet:null,loading:!1,error:null}),getters:{getPets:e=>e.pets,getCurrentPet:e=>e.currentPet},actions:{fetchPets(){return __async(this,null,(function*(){this.loading=!0,this.error=null;try{const e=yield M.getMyPets();return a("log","at store/petStore.js:24","è·å–å® ç‰©åˆ—è¡¨å“åº”:",e),this.setPets(e),e}catch(e){return a("error","at store/petStore.js:28","è·å–å® ç‰©åˆ—è¡¨å¤±è´¥:",e),this.error=e.message||"è·å–å® ç‰©åˆ—è¡¨å¤±è´¥",uni.showToast({title:"è·å–å® ç‰©åˆ—è¡¨å¤±è´¥",icon:"none"}),[]}finally{this.loading=!1}}))},setPets(e){this.pets=e,uni.setStorageSync("pets",JSON.stringify(e)),!this.currentPet&&e.length>0&&this.setCurrentPet(e[0])},addPet(e){return __async(this,null,(function*(){this.loading=!0,this.error=null;try{const t=yield M.addPet(e);return a("log","at store/petStore.js:57","æ·»åŠ å® ç‰©å“åº”:",t),this.pets.push(t),uni.setStorageSync("pets",JSON.stringify(this.pets)),1===this.pets.length&&this.setCurrentPet(t),t}catch(t){throw a("error","at store/petStore.js:67","æ·»åŠ å® ç‰©å¤±è´¥:",t),this.error=t.message||"æ·»åŠ å® ç‰©å¤±è´¥",t}finally{this.loading=!1}}))},updatePet(e,t){return __async(this,null,(function*(){this.loading=!0,this.error=null;try{const o=yield M.updatePet(e,t);a("log","at store/petStore.js:81","æ›´æ–°å® ç‰©å“åº”:",o);const s=this.pets.findIndex((t=>t._id===e));return-1!==s&&(this.pets[s]=o,uni.setStorageSync("pets",JSON.stringify(this.pets)),this.currentPet&&this.currentPet._id===e&&(this.currentPet=o,uni.setStorageSync("currentPet",JSON.stringify(o)))),o}catch(o){throw a("error","at store/petStore.js:95","æ›´æ–°å® ç‰©ä¿¡æ¯å¤±è´¥:",o),this.error=o.message||"æ›´æ–°å® ç‰©ä¿¡æ¯å¤±è´¥",o}finally{this.loading=!1}}))},deletePet(e){return __async(this,null,(function*(){this.loading=!0,this.error=null;try{return yield M.deletePet(e),this.pets=this.pets.filter((t=>t._id!==e)),uni.setStorageSync("pets",JSON.stringify(this.pets)),this.currentPet&&this.currentPet._id===e&&(this.currentPet=this.pets.length>0?this.pets[0]:null,uni.setStorageSync("currentPet",this.currentPet?JSON.stringify(this.currentPet):"")),!0}catch(t){throw a("error","at store/petStore.js:119","åˆ é™¤å® ç‰©å¤±è´¥:",t),this.error=t.message||"åˆ é™¤å® ç‰©å¤±è´¥",t}finally{this.loading=!1}}))},setCurrentPet(e){this.currentPet=e,uni.setStorageSync("currentPet",JSON.stringify(e))},restorePetState(){try{const e=uni.getStorageSync("pets"),t=uni.getStorageSync("currentPet");e&&(this.pets=JSON.parse(e)),t?this.currentPet=JSON.parse(t):this.pets.length>0&&(this.currentPet=this.pets[0])}catch(e){a("error","at store/petStore.js:149","æ¢å¤å® ç‰©çŠ¶æ€å¤±è´¥:",e)}}}}),ft=$e("user",{state:()=>({token:uni.getStorageSync("token")||null,userInfo:JSON.parse(uni.getStorageSync("userInfo")||"null"),loading:!1,userStats:null,followingUsers:[],followerUsers:[],error:null}),getters:{isLoggedIn:e=>!!e.token&&!!e.userInfo,userId:e=>{var t;return(null==(t=e.userInfo)?void 0:t._id)||null},username:e=>{var t;return(null==(t=e.userInfo)?void 0:t.username)||""},nickname:e=>{var t,a;return(null==(t=e.userInfo)?void 0:t.nickname)||(null==(a=e.userInfo)?void 0:a.username)||""},avatar:e=>{var t;return(null==(t=e.userInfo)?void 0:t.avatar)||"/static/images/default-avatar.png"}},actions:{register(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null;const t=yield I.register(e);if(!t||!t.token)throw new Error("æ³¨å†Œå¤±è´¥ï¼šå“åº”ä¸­æ²¡æœ‰åŒ…å«token");return this.token=t.token,this.userInfo={_id:t._id,username:t.username,email:t.email,nickname:t.nickname,avatar:t.avatar},uni.setStorageSync("token",this.token),uni.setStorageSync("userInfo",JSON.stringify(this.userInfo)),this.userInfo}catch(t){throw this.error=t.message||"æ³¨å†Œå¤±è´¥",a("error","at store/userStore.js:53","æ³¨å†Œå¤±è´¥:",t),t}finally{this.loading=!1}}))},login(e){return __async(this,null,(function*(){try{this.loading=!0,this.error=null;const t=yield I.login(e);if(a("log","at store/userStore.js:69","ç™»å½•å“åº”:",t),!t||!t.token)throw new Error("ç™»å½•å¤±è´¥ï¼šå“åº”ä¸­æ²¡æœ‰åŒ…å«token");return this.token=t.token,this.userInfo={_id:t._id,username:t.username,email:t.email,nickname:t.nickname,avatar:t.avatar},uni.setStorageSync("token",this.token),uni.setStorageSync("userInfo",JSON.stringify(this.userInfo)),this.userInfo}catch(t){throw this.error=t.message||"ç™»å½•å¤±è´¥",a("error","at store/userStore.js:93","ç™»å½•å¤±è´¥:",t),t}finally{this.loading=!1}}))},getUserInfo(){return __async(this,null,(function*(){if(this.userInfo)return this.userInfo;try{this.loading=!0,this.error=null;const e=yield T.getCurrentUser();if(!e)throw new Error("è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼šæ— æ•ˆçš„å“åº”");return this.userInfo=e,uni.setStorageSync("userInfo",JSON.stringify(this.userInfo)),this.userInfo}catch(e){throw this.error=e.message||"è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥",a("error","at store/userStore.js:126","è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",e),e}finally{this.loading=!1}}))},logout(){this.token=null,this.userInfo=null,this.userStats=null,uni.removeStorageSync("token"),uni.removeStorageSync("userInfo"),uni.reLaunch({url:"/pages/login/login"})},fetchUserStats(){return __async(this,null,(function*(){if(!this.isLoggedIn)return null;try{this.loading=!0;const e=yield T.getUserStats();return this.userStats=e,e}catch(e){return a("error","at store/userStore.js:160","è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:",e),null}finally{this.loading=!1}}))},fetchFollowing(){return __async(this,null,(function*(){if(!this.isLoggedIn)return[];try{this.loading=!0;const e=yield T.getFollowing();return this.followingUsers=e,e}catch(e){return a("error","at store/userStore.js:177","è·å–å…³æ³¨åˆ—è¡¨å¤±è´¥:",e),[]}finally{this.loading=!1}}))},fetchFollowers(){return __async(this,null,(function*(){if(!this.isLoggedIn)return[];try{this.loading=!0;const e=yield T.getFollowers();return this.followerUsers=e,e}catch(e){return a("error","at store/userStore.js:194","è·å–ç²‰ä¸åˆ—è¡¨å¤±è´¥:",e),[]}finally{this.loading=!1}}))},uploadAvatar(e){return __async(this,null,(function*(){try{this.loading=!0;const t=yield T.uploadAvatar(e);return this.userInfo&&(this.userInfo.avatar=t.avatar,uni.setStorageSync("userInfo",JSON.stringify(this.userInfo))),t}catch(t){throw a("error","at store/userStore.js:215","ä¸Šä¼ å¤´åƒå¤±è´¥:",t),t}finally{this.loading=!1}}))}}});const yt=ze({setup(){const t=ht(),o=ft(),s=e.ref([]),r=()=>__async(this,null,(function*(){try{yield t.fetchPets(),s.value=t.pets.map((e=>{var a;return __spreadProps(__spreadValues({},e),{isDefault:e._id===(null==(a=t.currentPet)?void 0:a._id)})}))}catch(e){a("error","at pages/pet/management.vue:62","Failed to load pets:",e),uni.showToast({title:"åŠ è½½å® ç‰©ä¿¡æ¯å¤±è´¥",icon:"none"})}}));return e.onMounted((()=>{o.isLoggedIn?r():uni.redirectTo({url:"/pages/login/login"})})),{pets:s,navToAdd:()=>{if(a("log","at pages/pet/management.vue:72","å¼€å§‹å¯¼èˆªåˆ°æ·»åŠ å® ç‰©é¡µé¢"),!o.isAuthenticated)return a("error","at pages/pet/management.vue:76","ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•æ·»åŠ å® ç‰©"),uni.showToast({title:"è¯·å…ˆç™»å½•",icon:"none"}),void setTimeout((()=>{uni.navigateTo({url:"/pages/login/login"})}),1500);uni.navigateTo({url:"/pages/pet/edit?mode=add",success:e=>{a("log","at pages/pet/management.vue:94","å¯¼èˆªåˆ°æ·»åŠ å® ç‰©é¡µé¢æˆåŠŸ",e)},fail:e=>{a("error","at pages/pet/management.vue:97","å¯¼èˆªåˆ°æ·»åŠ å® ç‰©é¡µé¢å¤±è´¥:",e),uni.navigateTo({url:"/pages/pet/edit",success:()=>{a("log","at pages/pet/management.vue:102","ä½¿ç”¨ç®€åŒ–è·¯å¾„å¯¼èˆªæˆåŠŸ")},fail:e=>{a("error","at pages/pet/management.vue:105","ä½¿ç”¨ç®€åŒ–è·¯å¾„ä»ç„¶å¤±è´¥:",e),uni.showToast({title:"é¡µé¢è·³è½¬å¤±è´¥",icon:"none"})}})}})},navToDetail:e=>{uni.navigateTo({url:`/pages/pet/edit?petId=${e}&mode=edit`})},navToEdit:e=>{a("log","at pages/pet/management.vue:125","Navigating to edit pet with ID:",e),uni.navigateTo({url:`/pages/pet/edit?petId=${e}&mode=edit`,success:()=>{a("log","at pages/pet/management.vue:129","Navigation successful")},fail:e=>{a("error","at pages/pet/management.vue:132","Navigation failed:",e)}})},deletePet:e=>__async(this,null,(function*(){try{uni.showLoading({title:"åˆ é™¤ä¸­..."});const a=yield A.pet.deletePet(e._id||e.id);if(uni.hideLoading(),!a||!a.success)throw new Error(a.message||"åˆ é™¤å¤±è´¥");t.deletePet(e._id),uni.showToast({title:"åˆ é™¤æˆåŠŸ",icon:"success"})}catch(o){uni.hideLoading(),a("error","at pages/pet/management.vue:152","Failed to delete pet:",o),uni.showToast({title:o.message||"åˆ é™¤å¤±è´¥",icon:"none"})}})),setDefault:(e,o=!1)=>__async(this,null,(function*(){try{uni.showLoading({title:"è®¾ç½®ä¸­..."});const a=yield A.pet.updatePet(e._id,{isDefault:!0});if(uni.hideLoading(),!a||!a.success)throw new Error(a.message||"è®¾ç½®å¤±è´¥");s.value=s.value.map((t=>__spreadProps(__spreadValues({},t),{isDefault:t._id===e._id}))),t.setCurrentPet(e),o||uni.showToast({title:`å·²å°†"${e.name}"è®¾ä¸ºé»˜è®¤å® ç‰©`,icon:"success"})}catch(r){uni.hideLoading(),a("error","at pages/pet/management.vue:185","Failed to set default pet:",r),o||uni.showToast({title:r.message||"è®¾ç½®å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}})),calculatePetAge:e=>{if(!e)return"æœªçŸ¥å¹´é¾„";const t=new Date(e),a=new Date,o=12*(a.getFullYear()-t.getFullYear())+(a.getMonth()-t.getMonth());if(o<12)return`${o}ä¸ªæœˆ`;{const e=Math.floor(o/12),t=o%12;return t>0?`${e}å²${t}ä¸ªæœˆ`:`${e}å²`}},formatImageUrl:e=>{if(!e)return"/static/images/default-pet.png";if(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("/static/"))return e;if(e.startsWith("/uploads")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}if(e.startsWith("uploads/")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+"/"+e}return"/static/images/default-pet.png"}}}},[["render",function(t,a,o,s,r,n){return e.openBlock(),e.createElementBlock("view",{class:"management-container"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("text",{class:"title"},"å® ç‰©ç®¡ç†"),e.createElementVNode("view",{class:"add-btn",onClick:a[0]||(a[0]=(...e)=>s.navToAdd&&s.navToAdd(...e))},[e.createElementVNode("text",{class:"add-icon"},"+"),e.createElementVNode("text",{class:"add-text"},"æ·»åŠ å® ç‰©")])]),0===s.pets.length?(e.openBlock(),e.createElementBlock("view",{key:0,class:"empty-pets"},[e.createElementVNode("image",{class:"empty-image",src:"/static/images/empty-pets.png",mode:"aspectFit"}),e.createElementVNode("text",{class:"empty-text"},"æ‚¨è¿˜æ²¡æœ‰æ·»åŠ å® ç‰©"),e.createElementVNode("button",{class:"add-pet-btn",onClick:a[1]||(a[1]=(...e)=>s.navToAdd&&s.navToAdd(...e))},"æ·»åŠ å® ç‰©")])):(e.openBlock(),e.createElementBlock("view",{key:1,class:"pet-list"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.pets,(t=>(e.openBlock(),e.createElementBlock("view",{class:"pet-item",key:t._id,onClick:e=>s.navToEdit(t._id||t.id)},[e.createElementVNode("view",{class:"pet-content"},[e.createElementVNode("image",{class:"pet-avatar",src:s.formatImageUrl(t.avatar),mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"pet-info"},[e.createElementVNode("view",{class:"pet-name-row"},[e.createElementVNode("text",{class:"pet-name"},e.toDisplayString(t.name),1),e.createElementVNode("text",{class:e.normalizeClass(["pet-gender",t.gender])},e.toDisplayString("male"===t.gender?"â™‚":"â™€"),3)]),e.createElementVNode("text",{class:"pet-breed"},e.toDisplayString(t.breed),1),e.createElementVNode("text",{class:"pet-age"},e.toDisplayString(s.calculatePetAge(t.birthdate)),1)]),t.isDefault?(e.openBlock(),e.createElementBlock("view",{key:0,class:"default-tag"},"é»˜è®¤")):e.createCommentVNode("v-if",!0),e.createElementVNode("view",{class:"edit-indicator"},[e.createElementVNode("text",{class:"edit-text"},"ç¼–è¾‘"),e.createElementVNode("text",{class:"edit-arrow"},">")])])],8,["onClick"])))),128))]))])}],["__scopeId","data-v-3676ecd4"],["__file","D:/caloriesH5/CloudStorage/pages/pet/management.vue"]]);const wt=ze({__name:"edit",props:{petId:{type:String,default:""},mode:{type:String,default:"add"}},setup(t,{expose:o}){o();const s=Oe(),r=e.ref(!1),n=t,i=e.ref({name:"",breed:"",gender:"male",age:"",weight:"",description:"",avatar:"",socialIntention:"medium",matingStatus:"notLooking",dailyPhotos:[]}),l=e.ref(""),p=e.ref("add"),v=e.computed((()=>i.value.name&&i.value.breed));function h(e){return __async(this,null,(function*(){if(e){r.value=!0,u("åŠ è½½å® ç‰©ä¿¡æ¯...");try{a("log","at pages/pet/edit.vue:268","è·å–å® ç‰©æ•°æ®:",e);const t=yield s.getPetById(e);t?(a("log","at pages/pet/edit.vue:272","è·å–åˆ°å® ç‰©æ•°æ®:",t),i.value={name:t.name||"",breed:t.breed||"",gender:t.gender||"male",age:t.age||"",weight:t.weight||"",description:t.description||"",avatar:f(t.avatar)||"/static/images/default-pet.png",socialIntention:t.socialIntention||"medium",matingStatus:t.matingStatus||"notLooking",dailyPhotos:Array.isArray(t.dailyPhotos)?t.dailyPhotos.map((e=>__spreadProps(__spreadValues({},e),{url:f(e.url)}))):[]}):(a("error","at pages/pet/edit.vue:289","æœªæ‰¾åˆ°å® ç‰©:",e),c({title:"æœªæ‰¾åˆ°å® ç‰©ä¿¡æ¯",icon:"none"}))}catch(t){a("error","at pages/pet/edit.vue:296","è·å–å® ç‰©ä¿¡æ¯å¤±è´¥:",t),c({title:"è·å–å® ç‰©ä¿¡æ¯å¤±è´¥",icon:"none"})}finally{r.value=!1,d()}}}))}function f(e){if(!e)return"/static/images/default-pet.png";if(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("/static/")||e.startsWith("file://"))return e;if(e.startsWith("/uploads")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}if(e.startsWith("uploads/")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+"/"+e}return"/static/images/default-pet.png"}e.onMounted((()=>__async(this,null,(function*(){a("log","at pages/pet/edit.vue:212","ç»„ä»¶åŠ è½½ï¼Œå‚æ•°:",n);const e=getCurrentPages(),t=e[e.length-1].options||{};a("log","at pages/pet/edit.vue:219","é¡µé¢å‚æ•°:",t);const o=n.petId||t.petId||t.id;p.value=n.mode||t.mode||"add","add"!==p.value&&"edit"!==p.value&&(a("warn","at pages/pet/edit.vue:229","æ— æ•ˆçš„æ¨¡å¼å‚æ•°:",p.value,'é‡ç½®ä¸ºé»˜è®¤å€¼"add"'),p.value="add"),a("log","at pages/pet/edit.vue:233","è§£æå‚æ•°:",{petId:o,mode:p.value}),l.value=o,document.title="add"===p.value?"æ·»åŠ å® ç‰©":"ç¼–è¾‘å® ç‰©","edit"===p.value&&o?yield h(o):(a("log","at pages/pet/edit.vue:243","æ·»åŠ æ¨¡å¼ï¼Œä½¿ç”¨é»˜è®¤è¡¨å•æ•°æ®"),i.value={name:"",breed:"",gender:"male",age:"",weight:"",description:"",avatar:"/static/images/default-pet.png",socialIntention:"medium",matingStatus:"notLooking",dailyPhotos:[]})}))));const y={petStore:s,isLoading:r,props:n,form:i,currentPetId:l,pageMode:p,isFormValid:v,loadPetData:h,chooseAvatar:function(){uni.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:e=>__async(this,null,(function*(){uni.showLoading({title:"å¤„ç†å›¾ç‰‡ä¸­..."});try{if(i.value.avatar=e.tempFilePaths[0],"edit"===n.mode&&l.value){a("log","at pages/pet/edit.vue:325","ä¸Šä¼ å® ç‰©å¤´åƒ:",l.value,e.tempFilePaths[0]);try{const t=yield s.uploadPetAvatar(l.value,e.tempFilePaths[0]);if(a("log","at pages/pet/edit.vue:330","å¤´åƒä¸Šä¼ ç»“æœ:",t),!(t&&t.success&&t.data&&t.data.pet))throw new Error("å¤´åƒä¸Šä¼ å“åº”æ ¼å¼ä¸æ­£ç¡®");{const e=t.data.pet.avatar;if(!e)throw new Error("è¿”å›çš„å¤´åƒURLä¸ºç©º");i.value.avatar=f(e),uni.showToast({title:"å¤´åƒä¸Šä¼ æˆåŠŸ",icon:"success"})}}catch(t){a("error","at pages/pet/edit.vue:348","å¤´åƒä¸Šä¼ å¤„ç†å¤±è´¥:",t),uni.showToast({title:"å¤´åƒä¸Šä¼ å¤±è´¥ï¼Œå°†åœ¨ä¿å­˜æ—¶å†æ¬¡å°è¯•",icon:"none"})}}}catch(o){a("error","at pages/pet/edit.vue:358","å¤´åƒä¸Šä¼ å¤±è´¥:",o),uni.showToast({title:"å¤´åƒä¸Šä¼ å¤±è´¥",icon:"none"})}finally{uni.hideLoading()}})),fail:e=>{a("error","at pages/pet/edit.vue:368","é€‰æ‹©å›¾ç‰‡å¤±è´¥:",e),uni.showToast({title:"é€‰æ‹©å›¾ç‰‡å¤±è´¥",icon:"none"})}})},addDailyPhoto:function(){i.value.dailyPhotos.length>=3?c({title:"æœ€å¤šåªèƒ½ä¸Šä¼ 3å¼ ç…§ç‰‡",icon:"none"}):uni.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:e=>{uni.showLoading({title:"å¤„ç†å›¾ç‰‡ä¸­..."});try{const t={url:e.tempFilePaths[0],uploadDate:new Date,description:""};i.value.dailyPhotos.push(t),uni.hideLoading(),c({title:"å·²æ·»åŠ ç…§ç‰‡",icon:"success"}),a("log","at pages/pet/edit.vue:417","å·²æ·»åŠ ä¸´æ—¶ç…§ç‰‡:",t)}catch(t){a("error","at pages/pet/edit.vue:419","æ·»åŠ ç…§ç‰‡å¤±è´¥:",t),uni.hideLoading(),c({title:"æ·»åŠ ç…§ç‰‡å¤±è´¥",icon:"none"})}}})},removePhoto:function(e){e>=0&&e<i.value.dailyPhotos.length&&(i.value.dailyPhotos.splice(e,1),c({title:"å·²åˆ é™¤ç…§ç‰‡",icon:"success"}))},handlePhotoError:function(e){a("error","at pages/pet/edit.vue:443","ç…§ç‰‡åŠ è½½å¤±è´¥:",e.target),e.target.src="/static/images/default-pet.png"},handleSubmit:function(){return __async(this,null,(function*(){if(v.value){r.value=!0,u("ä¿å­˜ä¸­...");try{const o={name:i.value.name,breed:i.value.breed,gender:i.value.gender,age:i.value.age?parseInt(i.value.age):null,weight:i.value.weight?parseFloat(i.value.weight):null,description:i.value.description,socialIntention:i.value.socialIntention,matingStatus:i.value.matingStatus},r=i.value.avatar;let n,u=r&&r.startsWith("blob:"),d=[];if(i.value.dailyPhotos&&i.value.dailyPhotos.length>0){d=i.value.dailyPhotos.filter((e=>e.url&&(e.url.startsWith("blob:")||e.url.startsWith("file:"))));const e=i.value.dailyPhotos.filter((e=>e.url&&!e.url.startsWith("blob:")&&!e.url.startsWith("file:")));o.dailyPhotos=e}if("edit"===p.value&&l.value){if(a("log","at pages/pet/edit.vue:494","æ›´æ–°å® ç‰©ä¿¡æ¯:",l.value,o),n=yield s.updatePet(l.value,o),u){a("log","at pages/pet/edit.vue:499","æ›´æ–°æ¨¡å¼: å•ç‹¬ä¸Šä¼ å¤´åƒ",r);try{yield s.uploadPetAvatar(l.value,r)}catch(e){a("error","at pages/pet/edit.vue:503","å¤´åƒä¸Šä¼ å¤±è´¥:",e)}}if(d.length>0)try{for(const e of d){const t=yield s.uploadPetDailyPhoto(l.value,e.url);a("log","at pages/pet/edit.vue:512","æ—¥å¸¸ç…§ç‰‡ä¸Šä¼ ç»“æœ:",t),t&&t.data&&t.data.photo&&t.data.photo.url&&a("log","at pages/pet/edit.vue:516","æœåŠ¡å™¨è¿”å›çš„ç…§ç‰‡URL:",t.data.photo.url)}}catch(t){a("error","at pages/pet/edit.vue:520","æ—¥å¸¸ç…§ç‰‡ä¸Šä¼ å¤±è´¥:",t)}c({title:"å® ç‰©ä¿¡æ¯å·²æ›´æ–°",icon:"success"})}else{if(a("log","at pages/pet/edit.vue:530","æ·»åŠ æ–°å® ç‰©:",o),n=yield s.addPet(o),!n||!n._id)throw new Error("æ·»åŠ å® ç‰©å¤±è´¥ï¼Œæœªè¿”å›å® ç‰©ID");{const o=n._id;if(u){a("log","at pages/pet/edit.vue:538","æ·»åŠ æ¨¡å¼: ä¸Šä¼ å¤´åƒ",r);try{yield s.uploadPetAvatar(o,r)}catch(e){a("error","at pages/pet/edit.vue:542","å¤´åƒä¸Šä¼ å¤±è´¥:",e)}}if(d.length>0)try{for(const e of d){const t=yield s.uploadPetDailyPhoto(o,e.url);a("log","at pages/pet/edit.vue:551","æ–°å¢æ¨¡å¼ - æ—¥å¸¸ç…§ç‰‡ä¸Šä¼ ç»“æœ:",t),t&&t.data&&t.data.photo&&t.data.photo.url&&a("log","at pages/pet/edit.vue:555","æœåŠ¡å™¨è¿”å›çš„ç…§ç‰‡URL:",t.data.photo.url)}}catch(t){a("error","at pages/pet/edit.vue:559","æ—¥å¸¸ç…§ç‰‡ä¸Šä¼ å¤±è´¥:",t)}c({title:"å® ç‰©æ·»åŠ æˆåŠŸ",icon:"success"})}}yield s.fetchPets(),setTimeout((()=>{g()}),1500)}catch(o){a("error","at pages/pet/edit.vue:580","ä¿å­˜å® ç‰©ä¿¡æ¯å¤±è´¥:",o),c({title:"ä¿å­˜å¤±è´¥: "+(o.message||"æœªçŸ¥é”™è¯¯"),icon:"none"})}finally{r.value=!1,d()}}else c("è¯·å¡«å†™å¿…å¡«é¡¹")}))},handleDelete:function(){return __async(this,null,(function*(){l.value?m({title:"åˆ é™¤å® ç‰©",content:"ç¡®å®šè¦åˆ é™¤è¿™åªå® ç‰©å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚",showCancel:!0}).then((e=>__async(this,null,(function*(){if(e){r.value=!0,u("åˆ é™¤ä¸­...");try{a("log","at pages/pet/edit.vue:608","åˆ é™¤å® ç‰©:",l.value),yield s.deletePet(l.value),c({title:"å® ç‰©å·²åˆ é™¤",icon:"success"}),setTimeout((()=>{g()}),1500)}catch(t){a("error","at pages/pet/edit.vue:621","åˆ é™¤å® ç‰©å¤±è´¥:",t),c({title:t.message||"åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}finally{r.value=!1,d()}}})))):c("æ— æ•ˆçš„å® ç‰©ID")}))},formatImageUrl:f,ref:e.ref,computed:e.computed,onMounted:e.onMounted,reactive:e.reactive,get usePetStore(){return Oe},get showToast(){return c},get showLoading(){return u},get hideLoading(){return d},get navigateBack(){return g},get showModal(){return m}};return Object.defineProperty(y,"__isScriptSetup",{enumerable:!1,value:!0}),y}},[["render",function(t,a,o,s,r,n){return e.openBlock(),e.createElementBlock("view",{class:"pet-edit-container"},[e.createElementVNode("view",{class:"form-header"},[e.createElementVNode("text",{class:"form-title"},e.toDisplayString("add"===s.pageMode?"æ·»åŠ å® ç‰©":"ç¼–è¾‘å® ç‰©"),1)]),e.createElementVNode("view",{class:"pet-form"},[e.createElementVNode("view",{class:"avatar-section"},[e.createElementVNode("image",{class:"pet-avatar",src:s.form.avatar||"/static/images/default-pet.png",mode:"aspectFill",onClick:s.chooseAvatar},null,8,["src"]),e.createElementVNode("text",{class:"avatar-tip"},"ç‚¹å‡»æ›´æ¢å¤´åƒ")]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"å® ç‰©åç§°"),e.withDirectives(e.createElementVNode("input",{class:"form-input","onUpdate:modelValue":a[0]||(a[0]=e=>s.form.name=e),placeholder:"è¯·è¾“å…¥å® ç‰©åç§°"},null,512),[[e.vModelText,s.form.name]])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"å“ç§"),e.withDirectives(e.createElementVNode("input",{class:"form-input","onUpdate:modelValue":a[1]||(a[1]=e=>s.form.breed=e),placeholder:"è¯·è¾“å…¥å® ç‰©å“ç§"},null,512),[[e.vModelText,s.form.breed]])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"æ€§åˆ«"),e.createElementVNode("view",{class:"gender-selector"},[e.createElementVNode("view",{class:e.normalizeClass(["gender-option",{active:"male"===s.form.gender}]),onClick:a[2]||(a[2]=e=>s.form.gender="male")},[e.createElementVNode("text",null,"å…¬")],2),e.createElementVNode("view",{class:e.normalizeClass(["gender-option",{active:"female"===s.form.gender}]),onClick:a[3]||(a[3]=e=>s.form.gender="female")},[e.createElementVNode("text",null,"æ¯")],2)])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"å¹´é¾„"),e.withDirectives(e.createElementVNode("input",{class:"form-input","onUpdate:modelValue":a[4]||(a[4]=e=>s.form.age=e),type:"number",placeholder:"è¯·è¾“å…¥å® ç‰©å¹´é¾„"},null,512),[[e.vModelText,s.form.age]])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"ä½“é‡ (kg)"),e.withDirectives(e.createElementVNode("input",{class:"form-input","onUpdate:modelValue":a[5]||(a[5]=e=>s.form.weight=e),type:"digit",placeholder:"è¯·è¾“å…¥å® ç‰©ä½“é‡"},null,512),[[e.vModelText,s.form.weight]])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"ç¤¾äº¤æ„å‘"),e.createElementVNode("view",{class:"selector-row"},[e.createElementVNode("view",{class:e.normalizeClass(["selector-option",{active:"strong"===s.form.socialIntention}]),onClick:a[6]||(a[6]=e=>s.form.socialIntention="strong")},[e.createElementVNode("text",null,"å¼ºçƒˆ")],2),e.createElementVNode("view",{class:e.normalizeClass(["selector-option",{active:"medium"===s.form.socialIntention}]),onClick:a[7]||(a[7]=e=>s.form.socialIntention="medium")},[e.createElementVNode("text",null,"è¾ƒå¼º")],2),e.createElementVNode("view",{class:e.normalizeClass(["selector-option",{active:"mild"===s.form.socialIntention}]),onClick:a[8]||(a[8]=e=>s.form.socialIntention="mild")},[e.createElementVNode("text",null,"å¹³æ·¡")],2)])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"æ±‚å¶çŠ¶æ€"),e.createElementVNode("view",{class:"selector-row"},[e.createElementVNode("view",{class:e.normalizeClass(["selector-option",{active:"single"===s.form.matingStatus}]),onClick:a[9]||(a[9]=e=>s.form.matingStatus="single")},[e.createElementVNode("text",null,"å•èº«å¾…æ±‚å¶")],2),e.createElementVNode("view",{class:e.normalizeClass(["selector-option",{active:"paired"===s.form.matingStatus}]),onClick:a[10]||(a[10]=e=>s.form.matingStatus="paired")},[e.createElementVNode("text",null,"æœ‰é…å¶")],2),e.createElementVNode("view",{class:e.normalizeClass(["selector-option",{active:"notLooking"===s.form.matingStatus}]),onClick:a[11]||(a[11]=e=>s.form.matingStatus="notLooking")},[e.createElementVNode("text",null,"æš‚ä¸æ‰¾é…å¶")],2)])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"æ—¥å¸¸ç…§ç‰‡ (æœ€å¤š3å¼ )"),e.createElementVNode("view",{class:"daily-photos"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.form.dailyPhotos,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:a,class:"photo-item"},[e.createElementVNode("image",{class:"photo-preview",src:t.url,mode:"aspectFill",onError:s.handlePhotoError},null,40,["src"]),e.createElementVNode("view",{class:"photo-delete",onClick:e=>s.removePhoto(a)},"Ã—",8,["onClick"])])))),128)),s.form.dailyPhotos.length<3?(e.openBlock(),e.createElementBlock("view",{key:0,class:"photo-add",onClick:s.addDailyPhoto},[e.createElementVNode("text",{class:"add-icon"},"+")])):e.createCommentVNode("v-if",!0)])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"ä¸ªæ€§ä»‹ç»"),e.withDirectives(e.createElementVNode("textarea",{class:"form-textarea","onUpdate:modelValue":a[12]||(a[12]=e=>s.form.description=e),placeholder:"æ·»åŠ ä¸ªæ€§ä¿¡æ¯ï¼ˆé€‰å¡«ï¼‰"},null,512),[[e.vModelText,s.form.description]])]),e.createElementVNode("button",{class:e.normalizeClass(["submit-btn",{loading:s.isLoading}]),disabled:!s.isFormValid||s.isLoading,onClick:s.handleSubmit},e.toDisplayString(s.isLoading?"å¤„ç†ä¸­...":"ä¿ å­˜"),11,["disabled"]),"edit"===s.pageMode?(e.openBlock(),e.createElementBlock("button",{key:0,class:"delete-btn",disabled:s.isLoading,onClick:s.handleDelete}," åˆ é™¤å® ç‰© ",8,["disabled"])):e.createCommentVNode("v-if",!0)])])}],["__file","D:/caloriesH5/CloudStorage/pages/pet/edit.vue"]]),kt="/api/pet-recognition",Et=.3,Nt=e=>new Promise(((t,a)=>{if(e.startsWith("blob:"))try{fetch(e).then((e=>e.blob())).then((e=>{const a=new FileReader;a.onloadend=()=>{const e=a.result.split(",")[1];t(e)},a.readAsDataURL(e)})).catch((e=>a(new Error(`Blob URLå¤„ç†å¤±è´¥: ${e.message||e}`))))}catch(o){a(new Error(`Blobå¤„ç†å¤±è´¥: ${o.message||o}`))}else if("undefined"!=typeof uni&&"function"==typeof uni.getFileSystemManager)try{uni.getFileSystemManager().readFile({filePath:e,encoding:"base64",success:e=>{t(e.data)},fail:e=>{a(new Error(`è¯»å–æ–‡ä»¶å¤±è´¥: ${e.errMsg||JSON.stringify(e)}`))}})}catch(o){a(new Error(`æ–‡ä»¶æ“ä½œé”™è¯¯: ${o.message||o}`))}else try{const o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="blob",o.onload=function(){if(200===this.status){const e=new FileReader;e.onloadend=function(){const a=e.result.split(",")[1];t(a)},e.readAsDataURL(this.response)}else a(new Error(`åŠ è½½å›¾ç‰‡å¤±è´¥ï¼ŒçŠ¶æ€ç : ${this.status}`))},o.onerror=function(){a(new Error("ç½‘ç»œè¯·æ±‚å›¾ç‰‡å¤±è´¥"))},o.send()}catch(o){a(new Error(`H5ç¯å¢ƒå¤„ç†å›¾ç‰‡å¤±è´¥: ${o.message||o}`))}}));function Vt(e){return __async(this,null,(function*(){var t;try{a("log","at utils/petAnalysisService.js:103","æ­£åœ¨è°ƒç”¨åç«¯APIè¿›è¡Œå›¾åƒè¯†åˆ«...");const o=e.startsWith("data:image")?e:`data:image/jpeg;base64,${e}`;let s=yield function(e){return __async(this,null,(function*(){return new Promise(((t,o)=>{try{const o=new Image;o.onload=function(){try{const s=document.createElement("canvas"),r=800;let n=o.width,i=o.height;n>i&&n>r?(i=Math.round(i*(r/n)),n=r):i>r&&(n=Math.round(n*(r/i)),i=r),s.width=n,s.height=i;s.getContext("2d").drawImage(o,0,0,n,i);const l=s.toDataURL("image/jpeg",.7),c=e.length,u=l.length;a("log","at utils/petAnalysisService.js:213",`å›¾åƒä¼˜åŒ–: åŸå§‹å¤§å° ${Math.round(c/1024)}KB, å‹ç¼©å ${Math.round(u/1024)}KB, å‹ç¼©ç‡ ${Math.round(100*(1-u/c))}%`),t(l)}catch(s){a("error","at utils/petAnalysisService.js:217","å‹ç¼©å›¾åƒå¤±è´¥:",s),t(e)}},o.onerror=function(){a("error","at utils/petAnalysisService.js:224","åŠ è½½å›¾åƒåˆ°Imageå¯¹è±¡å¤±è´¥"),t(e)},o.src=e}catch(s){a("error","at utils/petAnalysisService.js:232","å›¾åƒä¼˜åŒ–è¿‡ç¨‹å‡ºé”™:",s),t(e)}}))}))}(o);const r=yield fetch(kt,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({imageData:s})});if(!r.ok){const e=yield r.json().catch((()=>({})));if(503===r.status&&(null==(t=e.error)?void 0:t.includes("åŠ è½½ä¸­")))throw new Error("AIæ¨¡å‹æ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨åå†è¯•");throw new Error(`åç«¯APIè¿”å›é”™è¯¯: ${r.status} ${r.statusText} - ${e.error||""}`)}const n=yield r.json();if(a("log","at utils/petAnalysisService.js:140","APIåŸå§‹è¿”å›æ•°æ®:",JSON.stringify(n).substring(0,200)),Array.isArray(n))return a("log","at utils/petAnalysisService.js:144","APIè¿”å›äº†æœ‰æ•ˆçš„é¢„æµ‹ç»“æœæ•°ç»„:",n.length),n;if(n&&"object"==typeof n){if(a("log","at utils/petAnalysisService.js:148","APIè¿”å›äº†éæ•°ç»„æ ¼å¼çš„ç»“æœ:",n),n.hasOwnProperty("label")&&n.hasOwnProperty("score"))return[n];if(n.hasOwnProperty("labels")&&n.hasOwnProperty("scores")){const{labels:e,scores:t}=n;return e.map(((e,a)=>({label:e,score:t[a]})))}}throw a("warn","at utils/petAnalysisService.js:164","APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸ç¬¦åˆé¢„æœŸ:",n),new Error("APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸ç¬¦åˆé¢„æœŸ")}catch(o){throw a("error","at utils/petAnalysisService.js:167","åç«¯APIè°ƒç”¨å¤±è´¥:",o),o}}))}const St=(e,t)=>{if(a("log","at utils/petAnalysisService.js:270","ç›´æ¥ä½¿ç”¨APIè¿”å›çš„å“ç§æ•°æ®ï¼Œä¸ä½¿ç”¨æœ¬åœ°å“ç§åº“"),!e||0===e.length)return a("log","at utils/petAnalysisService.js:274","æ²¡æœ‰æ¥æ”¶åˆ°æœ‰æ•ˆçš„é¢„æµ‹ç»“æœ"),null;const o=[...e].sort(((e,t)=>{const a=parseFloat(e.score||e.confidence||0);return parseFloat(t.score||t.confidence||0)-a}));a("log","at utils/petAnalysisService.js:285","æ’åºåçš„é¢„æµ‹ç»“æœ:",o);const s=o.filter((e=>"dog"!==e.label&&"cat"!==e.label&&"canine"!==e.label&&"pet"!==e.label&&parseFloat(e.score||e.confidence||0)>Et));if(0===s.length)return a("log","at utils/petAnalysisService.js:295","æ²¡æœ‰æœ‰æ•ˆçš„å“ç§é¢„æµ‹ç»“æœ"),null;const r=s[0];a("log","at utils/petAnalysisService.js:301","ä½¿ç”¨æœ€é«˜ç½®ä¿¡åº¦çš„å“ç§:",r.label,"ç½®ä¿¡åº¦:",r.score);let n="",i="";r.additional_info&&(n=r.additional_info.description||"",i=r.additional_info.baike_url||"",a("log","at utils/petAnalysisService.js:310","åŒ…å«ç™¾ç§‘ä¿¡æ¯",i?"æœ‰é“¾æ¥":"æ— é“¾æ¥"));let l=n;l?l.length>100&&(l=l.substring(0,100)+"..."):l=`${r.label}çš„å¤–è§‚ç‰¹å¾`;let c="";c=n&&n.length>150?n.substring(100,250)+"...":"å…·ä½“æŠ¤ç†æ–¹æ³•è¯·å‚è€ƒä¸“ä¸šå…»å® æŒ‡å—";let u="";if(n&&n.includes("è‹±æ–‡å")){const e=n.match(/è‹±æ–‡å[ï¼š:]\s*([^ï¼Œã€‚,]+)/);e&&e[1]&&(u=e[1].trim())}const d={name:r.label,englishName:u||r.label,characteristics:{friendliness:n.includes("å‹å¥½")||n.includes("å‹å–„")?85:75,activity:n.includes("æ´»æ³¼")||n.includes("è¿åŠ¨")?80:70,trainability:n.includes("èªæ˜")||n.includes("æ™ºèƒ½")?85:75,grooming:n.includes("æ¯›å‘")||n.includes("æŠ¤ç†")?80:60},features:l,careNote:c,baikeUrl:i,originalScore:parseFloat(r.score||r.confidence||0),apiData:r};return a("log","at utils/petAnalysisService.js:357","åˆ›å»ºåŠ¨æ€å“ç§:",d.name),{breed:d,confidence:parseFloat(r.score||r.confidence||0),matchScore:parseFloat(r.score||r.confidence||0),source:"ç™¾åº¦AIè¯†åˆ«",isDynamicBreed:!0,originalLabel:r.label,apiData:r}},_t=e=>__async(this,null,(function*(){if(!e||0===e.length)throw new Error("éœ€è¦æä¾›è‡³å°‘ä¸€å¼ å›¾ç‰‡");try{a("log","at utils/petAnalysisService.js:381","å¼€å§‹åˆ†æå® ç‰©å›¾ç‰‡:",e);const o=[];for(const r of e)try{a("log","at utils/petAnalysisService.js:389",`å¤„ç†å›¾ç‰‡: ${r}`);const e=yield Nt(r);a("log","at utils/petAnalysisService.js:391",`å›¾ç‰‡è½¬æ¢ä¸ºBase64å®Œæˆï¼Œé•¿åº¦: ${e.length}`),a("log","at utils/petAnalysisService.js:394","å‡†å¤‡è°ƒç”¨APIè¯†åˆ«...");const t=yield Vt(e);if(a("log","at utils/petAnalysisService.js:396","APIè¯†åˆ«å®Œæˆï¼ŒåŸå§‹å“åº”:",JSON.stringify(t).substring(0,200)),Array.isArray(t)&&t.length>0){a("log","at utils/petAnalysisService.js:400",`æ”¶åˆ°${t.length}ä¸ªé¢„æµ‹ç»“æœ`);const e=St(t);e?(a("log","at utils/petAnalysisService.js:406","æˆåŠŸåˆ›å»ºå“ç§ä¿¡æ¯:",e.breed.name),o.push({imagePath:r,petType:"dog",breed:e.breed,confidence:e.confidence,source:e.source,originalResponse:t})):(a("log","at utils/petAnalysisService.js:416","æ— æ³•ä»APIç»“æœåˆ›å»ºå“ç§ä¿¡æ¯"),o.push({imagePath:r,identified:!1,message:"æ— æ³•è¯†åˆ«å® ç‰©å“ç§ï¼Œè¯·æä¾›æ›´æ¸…æ™°çš„ç…§ç‰‡",originalResponse:t}))}else a("warn","at utils/petAnalysisService.js:425","APIæœªè¿”å›æœ‰æ•ˆç»“æœç»“æ„:",t),o.push({imagePath:r,identified:!1,message:"åˆ†æç»“æœä¸æ˜ç¡®ï¼Œè¯·æä¾›æ›´æ¸…æ™°çš„ç…§ç‰‡",apiError:"object"==typeof t?JSON.stringify(t):String(t)})}catch(t){a("error","at utils/petAnalysisService.js:434",`åˆ†æå›¾ç‰‡ ${r} å¤±è´¥:`,t),o.push({imagePath:r,identified:!1,message:`å›¾ç‰‡å¤„ç†å¤±è´¥: ${t.message}`,error:t.message})}a("log","at utils/petAnalysisService.js:445","æ‰€æœ‰åˆ†æç»“æœ:",JSON.stringify(o,null,2));const s=o.filter((e=>e.breed));if(a("log","at utils/petAnalysisService.js:449",`æœ‰${s.length}ä¸ªæœ‰æ•ˆè¯†åˆ«ç»“æœ`),s.length>0){const e=s.reduce(((e,t)=>parseFloat(t.confidence)>parseFloat(e.confidence)?t:e),s[0]);a("log","at utils/petAnalysisService.js:455","é€‰æ‹©ç½®ä¿¡åº¦æœ€é«˜çš„ç»“æœ:",e.breed.name);const{breed:t}=e,o={identified:!0,breed:t.name,breedConfidence:Math.round(100*parseFloat(e.confidence)),features:t.features||"æš‚æ— ç‰¹å¾æè¿°",characteristics:t.characteristics||{friendliness:75,activity:70,trainability:70,grooming:60},note:t.careNote||"æš‚æ— æŠ¤ç†å»ºè®®",recognitionSource:e.source||"APIè¯†åˆ«",petType:e.petType||"dog"};return t.englishName&&(o.englishName=t.englishName),t.baikeUrl&&(o.baikeUrl=t.baikeUrl),o.purity=parseFloat(e.confidence)>.75?"çº¯ç§":"æ··åˆ",o._debug={originalResponse:e.originalResponse},a("log","at utils/petAnalysisService.js:493","è¿”å›æœ€ç»ˆç»“æœ:",JSON.stringify(o,null,2)),o}{const e={identified:!1,message:"æ— æ³•è¯†åˆ«å® ç‰©å“ç§ï¼Œè¯·æä¾›æ›´æ¸…æ™°çš„ç…§ç‰‡"};return o.length>0&&o[0].originalResponse&&(e._debug={originalResponse:o[0].originalResponse}),a("log","at utils/petAnalysisService.js:509","è¿”å›é”™è¯¯ç»“æœ:",JSON.stringify(e,null,2)),e}}catch(o){throw a("error","at utils/petAnalysisService.js:513","åˆ†æå® ç‰©å›¾ç‰‡å¤±è´¥:",o),new Error(`å›¾åƒåˆ†æå¤±è´¥: ${o.message}`)}}));const Ct=ze({__name:"recognition",setup(t,{expose:o}){o();const s=Re(),r=Oe(),n=e.ref(""),i=e.ref(!1),l=e.ref(null);function m(){return __async(this,null,(function*(){if(!n.value)return c("è¯·å…ˆé€‰æ‹©å›¾ç‰‡");i.value=!0,u("è¯†åˆ«ä¸­...");try{const e=yield _t([n.value]);a("log","at pages/pet/recognition.vue:134","è¯†åˆ«æœåŠ¡è¿”å›ç»“æœ:",e),e.identified?(l.value=e,a("log","at pages/pet/recognition.vue:139","è¯†åˆ«æˆåŠŸ:",l.value)):c(e.message||"è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•")}catch(e){a("error","at pages/pet/recognition.vue:144","åˆ†æå›¾ç‰‡å¤±è´¥:",e),c("è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•")}finally{i.value=!1,d()}}))}e.onMounted((()=>{s.isAuthenticated||(c("è¯·å…ˆç™»å½•"),setTimeout((()=>{g()}),1500))}));const p={userStore:s,petStore:r,imageUrl:n,analyzing:i,result:l,chooseImage:function(){return __async(this,null,(function*(){try{const e=yield new Promise(((e,t)=>{uni.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:e,fail:t})}));n.value=e.tempFilePaths[0],m()}catch(e){a("error","at pages/pet/recognition.vue:118","é€‰æ‹©å›¾ç‰‡å¤±è´¥:",e)}}))},analyzeImage:m,reset:function(){n.value="",l.value=null},saveToPet:function(){return l.value?s.isAuthenticated?void uni.navigateTo({url:`/pages/pet/edit?mode=add&breed=${encodeURIComponent(l.value.breed)}&petType=${encodeURIComponent(l.value.petType||"dog")}`,success:()=>{c("è¯·å®Œå–„å® ç‰©ä¿¡æ¯")},fail:e=>{a("error","at pages/pet/recognition.vue:175","å¯¼èˆªåˆ°å® ç‰©ç¼–è¾‘é¡µé¢å¤±è´¥:",e),c("æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•")}}):c("è¯·å…ˆç™»å½•"):c("æ²¡æœ‰è¯†åˆ«ç»“æœ")},ref:e.ref,onMounted:e.onMounted,get showToast(){return c},get showLoading(){return u},get hideLoading(){return d},get navigateBack(){return g},get analyzePetImages(){return _t},get useUserStore(){return Re},get usePetStore(){return Oe}};return Object.defineProperty(p,"__isScriptSetup",{enumerable:!1,value:!0}),p}},[["render",function(t,a,o,s,r,n){return e.openBlock(),e.createElementBlock("view",{class:"recognition-container"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("view",{class:"back-btn",onClick:a[0]||(a[0]=(...e)=>s.navigateBack&&s.navigateBack(...e))},[e.createElementVNode("text",{class:"back-arrow"},"â†")]),e.createElementVNode("text",{class:"title"},"å® ç‰©è¯†åˆ«")]),e.createElementVNode("view",{class:"content"},[e.createElementVNode("view",{class:"upload-section"},[e.createElementVNode("view",{class:"upload-box",onClick:s.chooseImage},[s.imageUrl?(e.openBlock(),e.createElementBlock("image",{key:0,src:s.imageUrl,mode:"aspectFill",class:"preview-image"},null,8,["src"])):(e.openBlock(),e.createElementBlock("view",{key:1,class:"upload-placeholder"},[e.createElementVNode("view",{class:"upload-icon"},"+"),e.createElementVNode("text",{class:"upload-text"},"ç‚¹å‡»ä¸Šä¼ å® ç‰©ç…§ç‰‡")]))])]),s.analyzing||s.result?e.createCommentVNode("v-if",!0):(e.openBlock(),e.createElementBlock("view",{key:0,class:"hint-text"},[e.createElementVNode("text",null,"ä¸Šä¼ ä¸€å¼ æ¸…æ™°çš„å® ç‰©ç…§ç‰‡ï¼Œæˆ‘ä»¬å°†ä¸ºæ‚¨è¯†åˆ«å® ç‰©å“ç§")])),s.analyzing?(e.openBlock(),e.createElementBlock("view",{key:1,class:"loading"},[e.createElementVNode("view",{class:"loading-spinner"}),e.createElementVNode("text",{class:"loading-text"},"æ­£åœ¨åˆ†æ...")])):e.createCommentVNode("v-if",!0),s.result?(e.openBlock(),e.createElementBlock("view",{key:2,class:"result-section"},[e.createElementVNode("view",{class:"result-card"},[e.createElementVNode("view",{class:"result-header"},[e.createElementVNode("text",{class:"result-title"},"è¯†åˆ«ç»“æœ")]),e.createElementVNode("view",{class:"result-content"},[e.createElementVNode("text",{class:"breed-name"},e.toDisplayString(s.result.breed),1),s.result.englishName?(e.openBlock(),e.createElementBlock("text",{key:0,class:"breed-english"},e.toDisplayString(s.result.englishName),1)):e.createCommentVNode("v-if",!0),e.createElementVNode("text",{class:"confidence"},"å¯ä¿¡åº¦: "+e.toDisplayString(s.result.breedConfidence)+"%",1),e.createElementVNode("text",{class:"pet-type"},"ç±»å‹: "+e.toDisplayString("dog"===s.result.petType?"ç‹—":"cat"===s.result.petType?"çŒ«":"æœªçŸ¥"),1),s.result.purity?(e.openBlock(),e.createElementBlock("text",{key:1,class:"purity"},"çº¯ç§å¯èƒ½æ€§: "+e.toDisplayString(s.result.purity),1)):e.createCommentVNode("v-if",!0)]),s.result.features||s.result.note?(e.openBlock(),e.createElementBlock("view",{key:0,class:"breed-info"},[e.createElementVNode("text",{class:"info-title"},"å“ç§ä»‹ç»:"),e.createElementVNode("text",{class:"info-text"},e.toDisplayString(s.result.features),1),s.result.note?(e.openBlock(),e.createElementBlock("text",{key:0,class:"care-title"},"æŠ¤ç†å»ºè®®:")):e.createCommentVNode("v-if",!0),s.result.note?(e.openBlock(),e.createElementBlock("text",{key:1,class:"care-text"},e.toDisplayString(s.result.note),1)):e.createCommentVNode("v-if",!0)])):e.createCommentVNode("v-if",!0),s.result.characteristics?(e.openBlock(),e.createElementBlock("view",{key:1,class:"breed-chars"},[e.createElementVNode("text",{class:"chars-title"},"æ€§æ ¼ç‰¹ç‚¹:"),e.createElementVNode("view",{class:"chars-item"},[e.createElementVNode("text",{class:"chars-label"},"å‹å¥½åº¦"),e.createElementVNode("view",{class:"progress-bar"},[e.createElementVNode("view",{class:"progress-fill",style:e.normalizeStyle({width:s.result.characteristics.friendliness+"%"})},null,4)])]),e.createElementVNode("view",{class:"chars-item"},[e.createElementVNode("text",{class:"chars-label"},"æ´»è·ƒåº¦"),e.createElementVNode("view",{class:"progress-bar"},[e.createElementVNode("view",{class:"progress-fill",style:e.normalizeStyle({width:s.result.characteristics.activity+"%"})},null,4)])]),e.createElementVNode("view",{class:"chars-item"},[e.createElementVNode("text",{class:"chars-label"},"è®­ç»ƒéš¾åº¦"),e.createElementVNode("view",{class:"progress-bar"},[e.createElementVNode("view",{class:"progress-fill",style:e.normalizeStyle({width:s.result.characteristics.trainability+"%"})},null,4)])]),e.createElementVNode("view",{class:"chars-item"},[e.createElementVNode("text",{class:"chars-label"},"æŠ¤ç†éœ€æ±‚"),e.createElementVNode("view",{class:"progress-bar"},[e.createElementVNode("view",{class:"progress-fill",style:e.normalizeStyle({width:s.result.characteristics.grooming+"%"})},null,4)])])])):e.createCommentVNode("v-if",!0)]),e.createElementVNode("view",{class:"action-buttons"},[e.createElementVNode("button",{class:"action-btn retry-btn",onClick:s.reset},"é‡æ–°è¯†åˆ«"),e.createElementVNode("button",{class:"action-btn save-btn",onClick:s.saveToPet},"ä¿å­˜ä¸ºæˆ‘çš„å® ç‰©")])])):e.createCommentVNode("v-if",!0)])])}],["__file","D:/caloriesH5/CloudStorage/pages/pet/recognition.vue"]]);const bt=ze({components:{WalkRecordCard:ut,ImageViewer:dt},setup(){var t;const o=Re(),s=e.ref([]),r=e.ref(!1),n=e.ref(1),i=e.ref(!0),l=null==(t=uni.$api)?void 0:t.community,u=e.ref(!1),d=e.ref(0),g=e.ref(null);function v(e=!1){return __async(this,null,(function*(){var t;if(!r.value&&(e&&(n.value=1,i.value=!0),i.value||e)){r.value=!0;try{a("log","at pages/community/my-posts.vue:179","å°è¯•è·å–æˆ‘çš„å¸–å­ï¼Œé¡µç :",n.value,"æ¯é¡µæ•°é‡:",10);const o=yield uni.$api.community.getMyPosts({page:n.value,limit:10});if(!o||!o.data)return a("warn","at pages/community/my-posts.vue:188","è·å–æˆ‘çš„å¸–å­å“åº”æ ¼å¼ä¸æ­£ç¡®:",o),e&&(s.value=[]),i.value=!1,void(e&&uni.stopPullDownRefresh());a("log","at pages/community/my-posts.vue:204","è·å–æˆ‘çš„å¸–å­æˆåŠŸï¼Œæ•°æ®:",o.data),s.value=e?(o.data||[]).map((e=>f(e))):[...s.value,...(o.data||[]).map((e=>f(e)))],i.value=10===(null==(t=o.data)?void 0:t.length),n.value++,e&&uni.stopPullDownRefresh()}catch(o){a("error","at pages/community/my-posts.vue:222","è·å–æˆ‘çš„åŠ¨æ€å¤±è´¥:",o);const t=o.message||"æœªçŸ¥é”™è¯¯",r=o.statusCode||"æœªçŸ¥çŠ¶æ€ç ";c({title:`è·å–åŠ¨æ€å¤±è´¥ (${r}): ${t}`,icon:"none"}),(e||0===s.value.length)&&(s.value=[]),i.value=!1,e&&uni.stopPullDownRefresh()}finally{r.value=!1}}}))}function h(e){return __async(this,null,(function*(){r.value=!0;try{a("log","at pages/community/my-posts.vue:334","å°è¯•åˆ é™¤å¸–å­ï¼ŒID:",e),yield uni.$api.community.deletePost(e),s.value=s.value.filter((t=>t.id!==e&&t._id!==e)),c({title:"åŠ¨æ€å·²åˆ é™¤",icon:"success"})}catch(t){a("error","at pages/community/my-posts.vue:345","åˆ é™¤åŠ¨æ€å¤±è´¥:",t);const e=t.message||"æœªçŸ¥é”™è¯¯",o=t.statusCode||"æœªçŸ¥çŠ¶æ€ç ";c({title:`åˆ é™¤å¤±è´¥ (${o}): ${e}`,icon:"none",duration:3e3}),404===t.statusCode&&(a("log","at pages/community/my-posts.vue:360","å¸–å­å¯èƒ½å·²è¢«åˆ é™¤ï¼Œå°è¯•åˆ·æ–°åˆ—è¡¨"),setTimeout((()=>{v(!0)}),1500))}finally{r.value=!1}}))}function f(e){if(e.walkRecord)return e;const t=e.content||"";let a=null;const o=t.match(/é›äº†\s*(\d+\.?\d*)\s*å…¬é‡Œ/),s=o?1e3*parseFloat(o[1]):null,r=t.match(/ç”¨æ—¶\s*(\d+)\s*(ç§’|åˆ†é’Ÿ|å°æ—¶)/);let n=null;if(r){const e=parseInt(r[1]),t=r[2];"ç§’"===t?n=e:"åˆ†é’Ÿ"===t?n=60*e:"å°æ—¶"===t&&(n=3600*e)}const i=t.match(/å’Œ\s*([^\s,ï¼Œã€‚ï¼]+)\s*ä¸€èµ·é›/),l=i?i[1]:"æˆ‘çš„å® ç‰©";return null!==s||null!==n?(a={_id:`generated_${e._id||e.id||Date.now()}`,distance:s||0,duration:n||0,pet:{name:l},startTime:e.createdAt||e.time||(new Date).toISOString()},__spreadProps(__spreadValues({},e),{walkRecord:a})):e}return{posts:s,isLoading:r,hasMore:i,userStore:o,formatDate:function(e){if(!e)return"";const t=new Date(e),a=new Date;if(a-t<864e5&&t.getDate()===a.getDate()){const e=t.getHours(),a=t.getMinutes();return`ä»Šå¤© ${e.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`}const o=new Date(a);if(o.setDate(o.getDate()-1),t.getDate()===o.getDate()&&t.getMonth()===o.getMonth()&&t.getFullYear()===o.getFullYear()){const e=t.getHours(),a=t.getMinutes();return`æ˜¨å¤© ${e.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`}return`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")}`},formatImageUrl:function(e){if(!e)return"/static/images/default-pet.png";if(a("log","at pages/community/my-posts.vue:145","æˆ‘çš„å¸–å­é¡µé¢å¤„ç†å›¾ç‰‡URL:",e),e.startsWith("http")||e.startsWith("/static")||e.startsWith("blob:"))return e;if(e.startsWith("/uploads")){const t=uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000",o=t+e;return a("log","at pages/community/my-posts.vue:156","å¤„ç†ç›¸å¯¹è·¯å¾„å›¾ç‰‡URL:",e,"è¡¥å……åŸºç¡€URL:",t,"å®Œæ•´URL:",o),o}return a("warn","at pages/community/my-posts.vue:161","æœªèƒ½è¯†åˆ«çš„å›¾ç‰‡URLæ ¼å¼:",e),"/static/images/default-pet.png"},loadPosts:v,viewPostDetail:function(e){if(a("log","at pages/community/my-posts.vue:252","æŸ¥çœ‹å¸–å­è¯¦æƒ…:",e),!e||!e.id&&!e._id)return void uni.showToast({title:"å¸–å­æ•°æ®æ— æ•ˆ",icon:"none"});const t=e.id||e._id;try{const a=`post_cache_${t}_${Date.now()}`;uni.setStorageSync(a,JSON.stringify(e)),p(`/pages/community/post-detail?id=${t}&postKey=${a}`)}catch(o){a("error","at pages/community/my-posts.vue:272","ä¿å­˜å¸–å­æ•°æ®åˆ°ç¼“å­˜å¤±è´¥:",o),p(`/pages/community/post-detail?id=${t}`)}},previewImage:function(e,t){g.value=e,d.value=t,u.value=!0},editPost:function(e){if(!e||!e.id&&!e._id)return void uni.showToast({title:"æ— æ³•ç¼–è¾‘ï¼Œå¸–å­æ•°æ®æ— æ•ˆ",icon:"none"});const t=e.id||e._id;try{const a=`post_cache_${t}_${Date.now()}`;uni.setStorageSync(a,JSON.stringify(e)),p(`/pages/community/create?id=${t}&mode=edit&postKey=${a}`)}catch(o){a("error","at pages/community/my-posts.vue:310","ç¼“å­˜å¸–å­æ•°æ®å¤±è´¥:",o),p(`/pages/community/create?id=${t}&mode=edit`)}},confirmDelete:function(e){m({title:"åˆ é™¤åŠ¨æ€",content:"ç¡®å®šè¦åˆ é™¤è¿™æ¡åŠ¨æ€å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚",showCancel:!0}).then((t=>__async(this,null,(function*(){t&&(yield h(e))}))))},deletePost:h,createPost:function(){p("/pages/community/create")},checkLoginAndLoadData:function(){if(!o.isAuthenticated)return c({title:"è¯·å…ˆç™»å½•",icon:"none"}),void setTimeout((()=>{p("/pages/login/login")}),1500);v()},formatDuration:function(e){if(!e)return"0åˆ†é’Ÿ";const t=Math.floor(e/3600),a=Math.floor(e%3600/60);let o="";return t>0?(o+=`${t}å°æ—¶`,a>0&&(o+=`${a}åˆ†é’Ÿ`)):o+=`${a}åˆ†é’Ÿ`,o},viewWalkRecord:function(e){if(!e.walkRecord||!e.walkRecord._id)return void uni.showToast({title:"é›ç‹—è®°å½•ä¸å­˜åœ¨",icon:"none"});a("log","at pages/community/my-posts.vue:421","æŸ¥çœ‹é›ç‹—è®°å½•è¯¦æƒ…:",e.walkRecord),e.walkRecord._id.startsWith("generated_")?uni.showToast({title:"è¿™æ˜¯ä»åŠ¨æ€å†…å®¹è§£æçš„é›ç‹—è®°å½•ï¼Œæ— æ³•æŸ¥çœ‹è¯¦æƒ…",icon:"none",duration:2500}):uni.navigateTo({url:`/pages/walk/detail?id=${e.walkRecord._id}`,fail:e=>{a("error","at pages/community/my-posts.vue:439","æ‰“å¼€é›ç‹—è®°å½•è¯¦æƒ…å¤±è´¥:",e),uni.showToast({title:"æ— æ³•æŸ¥çœ‹é›ç‹—è®°å½•",icon:"none"})}})},getNumberValue:function(e){return Array.isArray(e)?e.length:"number"==typeof e?e:e&&"object"==typeof e?Object.keys(e).length:0},truncateText:function(e,t){return e?e.length<=t?e:e.substring(0,t)+"...":""},likePost:function(e,t){return __async(this,null,(function*(){if(t.stopPropagation(),a("log","at pages/community/my-posts.vue:520","ç‚¹èµå¸–å­:",e),!e||!e.id&&!e._id)return a("error","at pages/community/my-posts.vue:523","æ— æ•ˆçš„å¸–å­ID"),void c({title:"æ— æ³•ç‚¹èµ",icon:"none"});const o=e.id||e._id;void 0===e.isLiked&&(e.isLiked=!1),void 0===e.likes&&(e.likes=0);const s=e.isLiked;e.isLiked=!s,e.likes=s?Math.max((e.likes||1)-1,0):(e.likes||0)+1;try{if(!l)throw new Error("ç¤¾åŒºAPIæœªåˆå§‹åŒ–");const t=yield l.likePost(o,!s);a("log","at pages/community/my-posts.vue:555","ç‚¹èµ/å–æ¶ˆç‚¹èµæˆåŠŸ:",t),t&&t.data&&void 0!==t.data.likes&&(e.likes=t.data.likes,e.isLiked=t.data.isLiked)}catch(r){a("error","at pages/community/my-posts.vue:563","ç‚¹èµ/å–æ¶ˆç‚¹èµå¤±è´¥:",r),e.isLiked=s,e.likes=s?(e.likes||0)+1:Math.max((e.likes||1)-1,0),c({title:"æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}}))},closeImageViewer:function(){u.value=!1},showImageViewer:u,currentImageIndex:d,currentPost:g}},onLoad(){this.checkLoginAndLoadData()},onPullDownRefresh(){this.loadPosts(!0)},onReachBottom(){this.hasMore&&!this.isLoading&&this.loadPosts()}},[["render",function(t,a,o,s,r,n){var i;const l=e.resolveComponent("walk-record-card"),c=e.resolveComponent("image-viewer");return e.openBlock(),e.createElementBlock("view",{class:"my-posts-container"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("text",{class:"title"},"æˆ‘çš„åŠ¨æ€")]),s.posts.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"post-list"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.posts,((t,a)=>(e.openBlock(),e.createElementBlock("view",{class:"post-item",key:t.id||t._id,onClick:e=>s.viewPostDetail(t)},[e.createElementVNode("view",{class:"post-header"},[e.createElementVNode("view",{class:"user-info"},[e.createElementVNode("image",{class:"avatar",src:t.avatar||"/static/images/default-avatar.png",mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"name-time"},[e.createElementVNode("text",{class:"username"},e.toDisplayString(t.username||"åŒ¿åç”¨æˆ·"),1),e.createElementVNode("text",{class:"time"},e.toDisplayString(s.formatDate(t.createdAt||t.createTime)),1)])])]),e.createElementVNode("view",{class:"post-content"},[e.createElementVNode("text",{class:"post-text"},e.toDisplayString(s.truncateText(t.content,40)),1),e.createCommentVNode(" é›ç‹—è®°å½•å¡ç‰‡ "),t.walkRecord?(e.openBlock(),e.createBlock(l,{key:0,record:t.walkRecord},null,8,["record"])):e.createCommentVNode("v-if",!0),t.images&&t.images.length>0?(e.openBlock(),e.createElementBlock("view",{key:1,class:"image-grid"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(t.images.slice(0,3),((a,o)=>(e.openBlock(),e.createElementBlock("image",{key:o,src:s.formatImageUrl(a),mode:"aspectFill",class:"post-image",onClick:e.withModifiers((e=>s.previewImage(t,o)),["stop"])},null,8,["src","onClick"])))),128)),t.images.length>3?(e.openBlock(),e.createElementBlock("view",{key:0,class:"more-images"},"+"+e.toDisplayString(t.images.length-3),1)):e.createCommentVNode("v-if",!0)])):e.createCommentVNode("v-if",!0)]),e.createElementVNode("view",{class:"post-footer"},[e.createElementVNode("view",{class:"action-item",onClick:e.withModifiers((e=>s.likePost(t,e)),["stop"])},[e.createElementVNode("view",{class:e.normalizeClass(["action-icon like-icon",{active:t.isLiked}]),style:{"background-image":"url('/static/images/like-icon.png')","background-size":"contain","background-repeat":"no-repeat"}},null,2),e.createElementVNode("text",{class:"action-text"},"ç‚¹èµ "+e.toDisplayString(s.getNumberValue(t.likes)),1)],8,["onClick"]),e.createElementVNode("view",{class:"action-item"},[e.createElementVNode("view",{class:"action-icon comment-icon",style:{"background-image":"url('/static/images/comment-icon.png')","background-size":"contain","background-repeat":"no-repeat"}}),e.createElementVNode("text",{class:"action-text"},"è¯„è®º "+e.toDisplayString(s.getNumberValue(t.comments)),1)]),e.createElementVNode("view",{class:"post-actions"},[e.createElementVNode("view",{class:"action-btn delete-btn",onClick:e.withModifiers((e=>s.confirmDelete(t.id||t._id)),["stop"])},"åˆ é™¤",8,["onClick"])])])],8,["onClick"])))),128))])):(e.openBlock(),e.createElementBlock("view",{key:1,class:"empty-list"},[e.createElementVNode("image",{src:"/static/images/empty-posts.png",mode:"aspectFit",class:"empty-icon"}),e.createElementVNode("text",{class:"empty-text"},"è¿˜æ²¡æœ‰å‘å¸ƒè¿‡åŠ¨æ€"),e.createElementVNode("button",{class:"create-btn",onClick:a[0]||(a[0]=(...e)=>s.createPost&&s.createPost(...e))},"å‘å¸ƒåŠ¨æ€")])),s.isLoading?(e.openBlock(),e.createElementBlock("view",{key:2,class:"loading"},[e.createElementVNode("view",{class:"loading-spinner"}),e.createElementVNode("text",{class:"loading-text"},"åŠ è½½ä¸­...")])):e.createCommentVNode("v-if",!0),e.createCommentVNode(" å›¾ç‰‡æŸ¥çœ‹å™¨ "),e.createVNode(c,{show:s.showImageViewer,images:(null==(i=s.currentPost)?void 0:i.images)||[],initialIndex:s.currentImageIndex,onClose:s.closeImageViewer},null,8,["show","images","initialIndex","onClose"])])}],["__file","D:/caloriesH5/CloudStorage/pages/community/my-posts.vue"]]);a("log","at pages/walk/history.vue:84","å·²åŠ è½½å¢å¼ºç‰ˆé›ç‹—è®°å½•é¡µé¢ v2.1 - ä¿®å¤è¿”å›å¯¼èˆªé€»è¾‘");const Pt=ze({setup(){const t=Re(),o=e.ref([]),s=e.ref(!1),r=e.ref(!0),n=10,i=e.ref(1),c=e.ref(!1),u=e.ref(""),d=()=>__async(this,null,(function*(){if(r.value&&!s.value){s.value=!0,u.value="";try{a("log","at pages/walk/history.vue:106","å¼€å§‹åŠ è½½é›ç‹—è®°å½•, é¡µç :",i.value,"æ¯é¡µæ•°é‡:",n),a("log","at pages/walk/history.vue:107","APIè·¯å¾„: /api/walks");const e=yield A.walk.getMyWalks({page:i.value,limit:n});a("log","at pages/walk/history.vue:114","APIå“åº”æˆåŠŸ, è¿”å›æ•°æ®ç±»å‹:",typeof e,e?"æœ‰æ•°æ®":"æ— æ•°æ®"),a("log","at pages/walk/history.vue:115","APIå“åº”æ•°æ®:",JSON.stringify(e));let t=[],s=!1;e&&0===e.code&&e.data?e.data.list&&Array.isArray(e.data.list)&&(a("log","at pages/walk/history.vue:124","æ ‡å‡†APIè¿”å›æ ¼å¼, è®°å½•æ•°é‡:",e.data.list.length),t=e.data.list,s=t.length<n||e.data.total&&i.value*n>=e.data.total):Array.isArray(e)?(a("log","at pages/walk/history.vue:131","ç›´æ¥è¿”å›æ•°ç»„æ ¼å¼, è®°å½•æ•°é‡:",e.length),t=e,s=t.length<n):e&&"object"==typeof e&&e.data&&(Array.isArray(e.data)?(a("log","at pages/walk/history.vue:138","åµŒå¥—æ•°ç»„æ ¼å¼, è®°å½•æ•°é‡:",e.data.length),t=e.data,s=t.length<n):e.data.list&&Array.isArray(e.data.list)&&(a("log","at pages/walk/history.vue:142","åµŒå¥—å¯¹è±¡æ ¼å¼, è®°å½•æ•°é‡:",e.data.list.length),t=e.data.list,s=t.length<n||e.data.total&&i.value*n>=e.data.total)),0===t.length&&1===i.value?(a("log","at pages/walk/history.vue:149","æ²¡æœ‰æ‰¾åˆ°ä»»ä½•é›ç‹—è®°å½•"),u.value="æ‚¨è¿˜æ²¡æœ‰é›ç‹—è®°å½•ï¼Œå¿«å»é›ç‹—å§ï¼",r.value=!1):(a("log","at pages/walk/history.vue:153","æˆåŠŸåŠ è½½é›ç‹—è®°å½•, æ•°é‡:",t.length),o.value=1===i.value?[...t]:[...o.value,...t],i.value++,r.value=!s,a("log","at pages/walk/history.vue:157","å½“å‰å·²åŠ è½½è®°å½•æ€»æ•°:",o.value.length,"æ˜¯å¦æœ‰æ›´å¤š:",r.value))}catch(e){a("error","at pages/walk/history.vue:160","åŠ è½½é›ç‹—è®°å½•å¤±è´¥:",e),a("error","at pages/walk/history.vue:161","é”™è¯¯è¯¦æƒ…:",e.message||"æœªçŸ¥é”™è¯¯"),e.statusCode&&a("error","at pages/walk/history.vue:163","HTTPçŠ¶æ€ç :",e.statusCode);let t="åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•";e&&e.message&&(404===e.statusCode?(t="APIæ¥å£ä¸å­˜åœ¨ï¼Œåç«¯å¯èƒ½å°šæœªå®ç°æ­¤åŠŸèƒ½",u.value="æ— æ³•åŠ è½½é›ç‹—è®°å½•ï¼Œåç«¯APIæœªæ‰¾åˆ°"):401===e.statusCode?(t="ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•",setTimeout((()=>{uni.navigateTo({url:"/pages/login/login"})}),1500)):(t=`åŠ è½½å¤±è´¥: ${e.message}`,u.value="åŠ è½½é›ç‹—è®°å½•å¤±è´¥ï¼Œè¯·ç¨åå†è¯•")),uni.showToast({title:t,icon:"none",duration:3e3})}finally{s.value=!1,c.value&&(c.value=!1)}}})),m=()=>{o.value=[],i.value=1,r.value=!0},p=e=>{const t=Math.floor(e/3600),a=Math.floor(e%3600/60),o=e%60;return t>0?`${t}å°æ—¶${a}åˆ†`:a>0?`${a}åˆ†${o}ç§’`:`${o}ç§’`};return e.onMounted((()=>{t.token?d():uni.showToast({title:"è¯·å…ˆç™»å½•",icon:"none",success:()=>{setTimeout((()=>{uni.navigateTo({url:"/pages/login/login"})}),1500)}})})),l((()=>{a("log","at pages/walk/history.vue:396","é¡µé¢ä¸‹æ‹‰åˆ·æ–°"),m(),d().finally((()=>{uni.stopPullDownRefresh()}))})),{records:o,isLoading:s,hasMore:r,isRefreshing:c,errorMessage:u,loadMore:()=>{r.value&&!s.value&&d()},onRefresh:()=>{c.value=!0,m(),d()},viewDetail:e=>{uni.navigateTo({url:`/pages/walk/detail?id=${e._id}`})},shareRecord:e=>{var t;const o=`æˆ‘å’Œ${(null==(t=e.pet)?void 0:t.name)||"æˆ‘çš„å® ç‰©"}ä¸€èµ·é›äº†${(e.distance/1e3).toFixed(2)}å…¬é‡Œï¼Œç”¨æ—¶${p(e.duration)}ï¼`;uni.navigateTo({url:"/pages/community/create",success:t=>{var a;uni.$emit("createPost",{content:o,walkRecord:{_id:e._id,distance:e.distance,duration:e.duration,pet:null==(a=e.pet)?void 0:a._id,startTime:e.startTime,endTime:e.endTime}})},fail:e=>{a("error","at pages/walk/history.vue:253","å¯¼èˆªåˆ°ç¤¾åŒºå‘å¸–é¡µé¢å¤±è´¥:",e),uni.showToast({title:"æ‰“å¼€ç¤¾åŒºé¡µé¢å¤±è´¥",icon:"none"})}})},deleteRecord:e=>{uni.showModal({title:"åˆ é™¤è®°å½•",content:"ç¡®å®šè¦åˆ é™¤è¿™æ¡é›ç‹—è®°å½•å—ï¼Ÿ",success:t=>__async(this,null,(function*(){if(t.confirm)try{s.value=!0,a("log","at pages/walk/history.vue:271","æ­£åœ¨åˆ é™¤è®°å½•ID:",e._id||e.id);if(a("log","at pages/walk/history.vue:275","åˆ é™¤è®°å½•APIå“åº”:",yield A.walk.deleteWalk(e._id||e.id)),o.value=o.value.filter((t=>(t._id||t.id)!==(e._id||e.id))),e.id&&e.id.startsWith("walk_"))try{a("log","at pages/walk/history.vue:283","ä»æœ¬åœ°å­˜å‚¨ä¸­åˆ é™¤è®°å½•");require("@/utils/walkStorage.js").default.deleteWalkRecord(e.id)}catch(r){a("error","at pages/walk/history.vue:287","æœ¬åœ°å­˜å‚¨åˆ é™¤å¤±è´¥:",r)}uni.showToast({title:"åˆ é™¤æˆåŠŸ",icon:"success"}),setTimeout((()=>{m(),d()}),1e3)}catch(n){a("error","at pages/walk/history.vue:303","åˆ é™¤è®°å½•å¤±è´¥:",n),a("error","at pages/walk/history.vue:304","é”™è¯¯è¯¦æƒ…:",n.message||"æœªçŸ¥é”™è¯¯"),n.statusCode&&a("error","at pages/walk/history.vue:306","HTTPçŠ¶æ€ç :",n.statusCode),uni.showToast({title:n.message||"åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none",duration:3e3})}finally{s.value=!1}}))})},navToMap:()=>{uni.switchTab({url:"/pages/map/map"})},formatDate:e=>{const t=new Date(e);return`${t.getFullYear()}å¹´${t.getMonth()+1}æœˆ${t.getDate()}æ—¥`},formatTime:e=>{const t=new Date(e);return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`},formatDuration:p,navBack:()=>{getCurrentPages().length>1?uni.navigateBack():uni.switchTab({url:"/pages/my/index"})},loadRecords:d,resetList:m}}},[["render",function(t,a,o,s,r,n){return e.openBlock(),e.createElementBlock("view",{class:"history-container"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("view",{class:"back-btn",onClick:a[0]||(a[0]=(...e)=>s.navBack&&s.navBack(...e))},[e.createElementVNode("text",{class:"back-icon"},"â†")]),e.createElementVNode("text",{class:"title"},"é›ç‹—è®°å½•")]),e.createElementVNode("scroll-view",{class:"record-list","scroll-y":"true",onScrolltolower:a[2]||(a[2]=(...e)=>s.loadMore&&s.loadMore(...e))},[0!==s.records.length||s.isLoading?e.createCommentVNode("v-if",!0):(e.openBlock(),e.createElementBlock("view",{key:0,class:"no-records"},[e.createElementVNode("image",{class:"empty-image",src:"/static/images/empty-records.png",mode:"aspectFit"}),e.createElementVNode("text",{class:"empty-text"},e.toDisplayString(s.errorMessage||"æš‚æ— é›ç‹—è®°å½•"),1),e.createElementVNode("button",{class:"start-btn",onClick:a[1]||(a[1]=(...e)=>s.navToMap&&s.navToMap(...e))},"å¼€å§‹é›ç‹—")])),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.records,(t=>{var a,o;return e.openBlock(),e.createElementBlock("view",{class:"record-item",key:t._id,onClick:e=>s.viewDetail(t)},[e.createElementVNode("view",{class:"record-date"},[e.createElementVNode("text",{class:"date"},e.toDisplayString(s.formatDate(t.startTime)),1),e.createElementVNode("text",{class:"time"},e.toDisplayString(s.formatTime(t.startTime)),1)]),e.createElementVNode("view",{class:"record-content"},[e.createElementVNode("view",{class:"record-map"},[e.createElementVNode("image",{class:"map-image",src:t.mapImageUrl||"/static/images/default-map.png",mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"pet-avatar-container"},[e.createElementVNode("image",{class:"pet-avatar",src:(null==(a=t.pet)?void 0:a.avatar)||"/static/images/default-pet.png",mode:"aspectFill"},null,8,["src"])])]),e.createElementVNode("view",{class:"record-info"},[e.createElementVNode("view",{class:"record-title"},[e.createElementVNode("text",null,e.toDisplayString((null==(o=t.pet)?void 0:o.name)||"æœªçŸ¥å® ç‰©")+"çš„é›ç‹—è®°å½•",1)]),e.createElementVNode("view",{class:"record-stats"},[e.createElementVNode("view",{class:"stat-item"},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString((t.distance/1e3).toFixed(2)),1),e.createElementVNode("text",{class:"stat-unit"},"å…¬é‡Œ")]),e.createElementVNode("view",{class:"stat-divider"}),e.createElementVNode("view",{class:"stat-item"},[e.createElementVNode("text",{class:"stat-value"},e.toDisplayString(s.formatDuration(t.duration)),1),e.createElementVNode("text",{class:"stat-unit"},"æ—¶é•¿")])])])]),e.createElementVNode("view",{class:"record-footer"},[e.createElementVNode("view",{class:"action-item",onClick:e.withModifiers((e=>s.shareRecord(t)),["stop"])},[e.createElementVNode("view",{class:"action-icon share-icon"}),e.createElementVNode("text",{class:"action-text"},"åˆ†äº«")],8,["onClick"]),e.createElementVNode("view",{class:"action-item",onClick:e.withModifiers((e=>s.deleteRecord(t)),["stop"])},[e.createElementVNode("view",{class:"action-icon delete-icon"}),e.createElementVNode("text",{class:"action-text"},"åˆ é™¤")],8,["onClick"])])],8,["onClick"])})),128)),s.isLoading?(e.openBlock(),e.createElementBlock("view",{key:1,class:"loading"},[e.createElementVNode("text",null,"åŠ è½½ä¸­...")])):e.createCommentVNode("v-if",!0),s.records.length>0&&!s.hasMore&&!s.isLoading?(e.openBlock(),e.createElementBlock("view",{key:2,class:"end-line"},[e.createElementVNode("text",null,"- æ²¡æœ‰æ›´å¤šè®°å½• -")])):e.createCommentVNode("v-if",!0)],32)])}],["__scopeId","data-v-ade21e36"],["__file","D:/caloriesH5/CloudStorage/pages/walk/history.vue"]]);const xt=ze({__name:"settings",setup(e,{expose:t}){t();const o=Re();const s={userStore:o,editProfile:function(){p("/pages/profile/profile")},changePassword:function(){c("ä¿®æ”¹å¯†ç åŠŸèƒ½å³å°†æ¨å‡º")},manageNotifications:function(){c("é€šçŸ¥è®¾ç½®åŠŸèƒ½å³å°†æ¨å‡º")},privacySettings:function(){c("éšç§è®¾ç½®åŠŸèƒ½å³å°†æ¨å‡º")},aboutApp:function(){c("å…³äºåº”ç”¨åŠŸèƒ½å³å°†æ¨å‡º")},handleLogout:function(){return __async(this,null,(function*(){if(yield m({title:"é€€å‡ºç™»å½•",content:"ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ",showCancel:!0}))try{yield o.logout(),c({title:"å·²é€€å‡ºç™»å½•",icon:"success"}),setTimeout((()=>{uni.reLaunch({url:"/pages/login/login"})}),1500)}catch(e){a("error","at pages/profile/settings.vue:94","é€€å‡ºç™»å½•å¤±è´¥:",e),c("é€€å‡ºç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•")}}))},get useUserStore(){return Re},get showToast(){return c},get showModal(){return m},get navigateTo(){return p},get navigateBack(){return g}};return Object.defineProperty(s,"__isScriptSetup",{enumerable:!1,value:!0}),s}},[["render",function(t,a,o,s,r,n){return e.openBlock(),e.createElementBlock("view",{class:"settings-container"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("view",{class:"header-title"},"è®¾ç½®")]),e.createElementVNode("view",{class:"settings-list"},[e.createElementVNode("view",{class:"settings-item",onClick:s.editProfile},[e.createElementVNode("text",{class:"item-text"},"ç¼–è¾‘ä¸ªäººèµ„æ–™"),e.createElementVNode("view",{class:"arrow-icon"})]),e.createElementVNode("view",{class:"settings-item",onClick:s.changePassword},[e.createElementVNode("text",{class:"item-text"},"ä¿®æ”¹å¯†ç "),e.createElementVNode("view",{class:"arrow-icon"})]),e.createElementVNode("view",{class:"settings-item",onClick:s.manageNotifications},[e.createElementVNode("text",{class:"item-text"},"é€šçŸ¥è®¾ç½®"),e.createElementVNode("view",{class:"arrow-icon"})]),e.createElementVNode("view",{class:"settings-item",onClick:s.privacySettings},[e.createElementVNode("text",{class:"item-text"},"éšç§è®¾ç½®"),e.createElementVNode("view",{class:"arrow-icon"})]),e.createElementVNode("view",{class:"settings-item",onClick:s.aboutApp},[e.createElementVNode("text",{class:"item-text"},"å…³äºåº”ç”¨"),e.createElementVNode("view",{class:"arrow-icon"})])]),e.createElementVNode("view",{class:"footer"},[e.createElementVNode("button",{class:"logout-btn",onClick:s.handleLogout},"é€€å‡ºç™»å½•")])])}],["__file","D:/caloriesH5/CloudStorage/pages/profile/settings.vue"]]);const It=ze({__name:"profile",setup(t,{expose:o}){o();const s=e.ref(!1),r=Re(),n=e.ref(!1),i=uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000",l=e.computed((()=>{const e=m.value.avatar;if(a("log","at pages/profile/profile.vue:71","ä¸ªäººèµ„æ–™é¡µé¢å¤´åƒè·¯å¾„:",e),!e)return"/static/images/default-avatar.png";if(e.startsWith("/uploads/")){const t=i+e;return a("log","at pages/profile/profile.vue:80","ä¸ªäººèµ„æ–™é¡µé¢å®Œæ•´å¤´åƒURL:",t),t}return e})),m=e.ref({nickname:"",email:"",phone:"",avatar:"",gender:"unknown",bio:""}),p=[{value:"unknown",label:"è¯·é€‰æ‹©æ€§åˆ«"},{value:"male",label:"ç”·"},{value:"female",label:"å¥³"},{value:"other",label:"å…¶ä»–"}],g=e.computed((()=>{const e=p.findIndex((e=>e.value===m.value.gender));return a("log","at pages/profile/profile.vue:108","è®¡ç®—æ€§åˆ«ç´¢å¼•:",m.value.gender,"ç´¢å¼•ä¸º:",e>=0?e:0),e>=0?e:0})),v=e.computed((()=>m.value.nickname&&m.value.email&&m.value.phone)),h=e.ref(!1),f=e.ref(!1);function y(e){return __async(this,null,(function*(){return new Promise(((t,o)=>{uni.compressImage({src:e,quality:70,width:"60%",height:"60%",success:e=>{t(e.tempFilePath)},fail:o=>{a("error","at pages/profile/profile.vue:229","å‹ç¼©å›¾ç‰‡å¤±è´¥:",o),t(e)}})}))}))}function w(e){return __async(this,null,(function*(){try{if(a("log","at pages/profile/profile.vue:240","å¼€å§‹ä¸Šä¼ å¤´åƒï¼Œæ–‡ä»¶è·¯å¾„:",e),!e)return a("error","at pages/profile/profile.vue:246","æ— æ•ˆçš„å¤´åƒæ–‡ä»¶è·¯å¾„"),c("å¤´åƒæ–‡ä»¶æ— æ•ˆ"),!1;const t=yield r.uploadAvatar(e);a("log","at pages/profile/profile.vue:254","å¤´åƒä¸Šä¼ ç»“æœ:",t);let o=null;if(t&&(o=t.avatar||t.data&&t.data.avatar||null,a("log","at pages/profile/profile.vue:265","æå–çš„å¤´åƒè·¯å¾„:",o)),o){m.value.avatar=o,c("å¤´åƒä¸Šä¼ æˆåŠŸ");const e=yield r.fetchUserInfo();return e&&e.avatar===o?(a("log","at pages/profile/profile.vue:277","å¤´åƒå·²ç¡®è®¤æˆåŠŸä¿å­˜åˆ°åç«¯:",o),!0):(a("warn","at pages/profile/profile.vue:280","å¤´åƒä¿å­˜å¯èƒ½ä¸å®Œæ•´ï¼Œåç«¯è¿”å›çš„å¤´åƒä¸ä¸Šä¼ çš„ä¸ä¸€è‡´"),!0)}return a("error","at pages/profile/profile.vue:285","å¤´åƒä¸Šä¼ å¤±è´¥ï¼šæœªè·å–åˆ°æœ‰æ•ˆçš„å¤´åƒURL",t),c("å¤´åƒä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•"),!1}catch(t){return a("error","at pages/profile/profile.vue:290","å¤´åƒä¸Šä¼ å¤±è´¥:",t),t.message&&t.message.includes("ç½‘ç»œè¯·æ±‚å¤±è´¥")?c("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"):t.message&&t.message.includes("æ–‡ä»¶è¯»å–å¤±è´¥")?c("æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡æ–°é€‰æ‹©å›¾ç‰‡"):t.message&&t.message.includes("ä¸Šä¼ å¤±è´¥: 400")?c("æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒæˆ–å·²æŸå"):c("å¤´åƒä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•"),!1}finally{n.value=!1}}))}function k(e,t){if(!e)return!1;const o=["nickname","email","phone","gender"];for(const s of o){if(!e[s])return a("error","at pages/profile/profile.vue:430",`å…³é”®å­—æ®µ ${s} æ²¡æœ‰åœ¨æœåŠ¡å™¨å“åº”ä¸­è¿”å›`),!1;e[s]!==t[s]&&a("warn","at pages/profile/profile.vue:436",`å­—æ®µ ${s} å€¼ä¸ä¸€è‡´: æäº¤=${t[s]}, è¿”å›=${e[s]}`)}return!0}function E(e){return e?e.nickname&&e.email?!(!e.avatar||"/static/images/default-avatar.png"===e.avatar||"static/images/default-avatar.png"===e.avatar)||(a("log","at pages/profile/profile.vue:559","ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´: æœªä¸Šä¼ å¤´åƒ"),!1):(a("log","at pages/profile/profile.vue:551","ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´: ç¼ºå°‘åŸºæœ¬ä¿¡æ¯"),!1):(a("log","at pages/profile/profile.vue:545","ç”¨æˆ·ä¿¡æ¯ä¸å­˜åœ¨"),!1)}e.onMounted((()=>__async(this,null,(function*(){h.value=!0;try{a("log","at pages/profile/profile.vue:454","å¼€å§‹ä»æœåŠ¡å™¨è·å–ç”¨æˆ·ä¿¡æ¯"),yield r.fetchUserInfo();let t=r.user;a("log","at pages/profile/profile.vue:460","æœåŠ¡å™¨è¿”å›çš„ç”¨æˆ·ä¿¡æ¯:",t);const o=getCurrentPages(),n=o[o.length-1];let i=!1;n&&n.options&&(i="true"===n.options.firstLogin);let l=!1;try{l="true"===uni.getStorageSync("hasCompletedFirstLogin"),a("log","at pages/profile/profile.vue:476","ç”¨æˆ·æ˜¯å¦å·²å®Œæˆé¦–æ¬¡ç™»å½•:",l)}catch(e){a("error","at pages/profile/profile.vue:478","è¯»å–ç™»å½•çŠ¶æ€å¤±è´¥:",e)}const u=E(t);if(s.value=!l&&!u&&i,a("log","at pages/profile/profile.vue:488","URLå‚æ•°firstLogin:",i),a("log","at pages/profile/profile.vue:489","ç”¨æˆ·èµ„æ–™æ˜¯å¦å®Œæ•´:",u),a("log","at pages/profile/profile.vue:490","æœ€ç»ˆåˆ¤æ–­æ˜¯å¦é¦–æ¬¡ç™»å½•:",s.value),u&&i)return a("log","at pages/profile/profile.vue:494","ç”¨æˆ·èµ„æ–™å·²å®Œæ•´ï¼Œè·³è½¬åˆ°ä¸»é¡µ"),void setTimeout((()=>{uni.switchTab({url:"/pages/index/index"})}),500);if(t){const e=t.gender||"unknown";m.value={nickname:t.nickname||"",email:t.email||"",phone:t.phone||"",avatar:t.avatar||"",gender:e,bio:t.bio||""},a("log","at pages/profile/profile.vue:516","è¡¨å•åˆå§‹åŒ–æ•°æ®:",m.value),a("log","at pages/profile/profile.vue:517","ç‰¹åˆ«å…³æ³¨ - æ€§åˆ«ä¿¡æ¯:",{"åŸå§‹ç”¨æˆ·æ€§åˆ«":e,"è¡¨å•æ€§åˆ«":m.value.gender,"æ€§åˆ«é€‰é¡¹ç´¢å¼•":g.value})}else c("è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥");s.value&&c({title:"è¯·å®Œå–„æ‚¨çš„ä¸ªäººä¿¡æ¯",duration:3e3})}catch(t){a("error","at pages/profile/profile.vue:534","åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",t),c("è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥")}finally{h.value=!1}}))));const N={isFirstLogin:s,userStore:r,avatarLoading:n,apiBaseUrl:i,displayAvatar:l,form:m,genderOptions:p,genderIndex:g,isFormValid:v,isLoading:h,isSubmitting:f,onGenderChange:function(e){const t=e.detail.value;m.value.gender=p[t].value,a("log","at pages/profile/profile.vue:127","æ€§åˆ«å˜æ›´ä¸º:",m.value.gender)},changeAvatar:function(){return __async(this,null,(function*(){try{a("log","at pages/profile/profile.vue:133","å¼€å§‹é€‰æ‹©å›¾ç‰‡");const o=yield new Promise(((e,t)=>{uni.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:e,fail:t})}));if(!o||!o.tempFilePaths||!o.tempFilePaths.length)return void a("error","at pages/profile/profile.vue:145","æœªé€‰æ‹©å›¾ç‰‡æˆ–è¿”å›çš„å›¾ç‰‡è·¯å¾„ä¸ºç©º");const s=o.tempFilePaths[0];if(a("log","at pages/profile/profile.vue:150","é€‰æ‹©çš„å›¾ç‰‡è·¯å¾„:",s),!s)return a("error","at pages/profile/profile.vue:153","æ— æ•ˆçš„å›¾ç‰‡è·¯å¾„"),void c("é€‰æ‹©å›¾ç‰‡å¤±è´¥");n.value=!0;try{const t=yield new Promise(((e,t)=>{uni.getFileInfo({filePath:s,success:e,fail:t})}));if(a("log","at pages/profile/profile.vue:171","åŸå§‹å›¾ç‰‡å¤§å°:",(t.size/1024/1024).toFixed(2)+"MB"),a("log","at pages/profile/profile.vue:172","å›¾ç‰‡ç±»å‹:",t.type),t.size>4194304){c("å›¾ç‰‡è¾ƒå¤§ï¼Œæ­£åœ¨å‹ç¼©...");try{const e=yield y(s);a("log","at pages/profile/profile.vue:181","å‹ç¼©åçš„å›¾ç‰‡è·¯å¾„:",e);a("log","at pages/profile/profile.vue:192","å‹ç¼©åå›¾ç‰‡å¤§å°:",((yield new Promise(((t,a)=>{uni.getFileInfo({filePath:e,success:t,fail:a})}))).size/1024/1024).toFixed(2)+"MB"),yield w(e)}catch(e){a("error","at pages/profile/profile.vue:197","å‹ç¼©å›¾ç‰‡å¤±è´¥:",e),c("å›¾ç‰‡å‹ç¼©å¤±è´¥ï¼Œå°è¯•ç›´æ¥ä¸Šä¼ "),yield w(s)}}else yield w(s)}catch(t){a("error","at pages/profile/profile.vue:206","è·å–æ–‡ä»¶ä¿¡æ¯å¤±è´¥:",t),yield w(s)}}catch(t){a("error","at pages/profile/profile.vue:211","é€‰æ‹©å›¾ç‰‡å¤±è´¥:",t),c("é€‰æ‹©å›¾ç‰‡å¤±è´¥"),n.value=!1}}))},compressImage:y,uploadAvatar:w,saveProfile:function(){return __async(this,null,(function*(){if(!m.value.nickname)return c("è¯·è¾“å…¥æ˜µç§°");if(!m.value.email)return c("è¯·è¾“å…¥é‚®ç®±");if(!m.value.phone)return c("è¯·è¾“å…¥æ‰‹æœºå·ç ");f.value=!0,u("ä¿å­˜ä¸­...");try{const t={nickname:m.value.nickname,email:m.value.email,bio:m.value.bio||"",phone:m.value.phone||"",gender:m.value.gender||"unknown"};m.value.avatar&&(t.avatar=m.value.avatar),a("log","at pages/profile/profile.vue:342","å‡†å¤‡æ›´æ–°ä¸ªäººèµ„æ–™ï¼ŒåŒ…å«æ€§åˆ«ä¿¡æ¯:",t),Object.keys(t).forEach((e=>{void 0===t[e]&&(t[e]="")}));const o=yield r.updateUserInfo(t);if(a("log","at pages/profile/profile.vue:354","ä¸ªäººèµ„æ–™æ›´æ–°ç»“æœ:",o),o){if(!k(o,t))return a("error","at pages/profile/profile.vue:362","åç«¯æœªæˆåŠŸä¿å­˜æ‰€æœ‰å­—æ®µï¼Œä¸­æ­¢æ“ä½œ"),void c({title:"èµ„æ–™ä¿å­˜ä¸å®Œæ•´ï¼Œè¯·é‡è¯•",icon:"none"});a("log","at pages/profile/profile.vue:370","æ‰€æœ‰å­—æ®µå·²æˆåŠŸä¿å­˜åˆ°åç«¯"),r.user&&(r.user=o,uni.setStorageSync("userInfo",JSON.stringify(o)),a("log","at pages/profile/profile.vue:379","åç«¯æ•°æ®å·²ç¼“å­˜åˆ°æœ¬åœ°å­˜å‚¨"));try{uni.setStorageSync("hasCompletedFirstLogin","true"),a("log","at pages/profile/profile.vue:385","å·²æ ‡è®°ç”¨æˆ·å®Œæˆé¦–æ¬¡ç™»å½•")}catch(e){a("error","at pages/profile/profile.vue:387","ä¿å­˜ç™»å½•çŠ¶æ€å¤±è´¥:",e)}c({title:"ä¿å­˜æˆåŠŸ",icon:"success"}),setTimeout((()=>{uni.switchTab({url:"/pages/index/index"}),s.value?a("log","at pages/profile/profile.vue:404","é¦–æ¬¡ç™»å½•èµ„æ–™å®Œå–„å®Œæˆï¼Œè·³è½¬å›é¦–é¡µ"):a("log","at pages/profile/profile.vue:406","èµ„æ–™æ›´æ–°å®Œæˆï¼Œè·³è½¬å›é¦–é¡µ")}),1500)}else c("åç«¯ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•")}catch(t){a("error","at pages/profile/profile.vue:413","ä¿å­˜ä¸ªäººèµ„æ–™å¤±è´¥:",t),c("ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•")}finally{f.value=!1,d()}}))},validateServerResponse:k,goBack:function(){uni.navigateBack()},checkProfileCompleteness:E,ref:e.ref,computed:e.computed,onMounted:e.onMounted,get useUserStore(){return Re},get showToast(){return c},get showLoading(){return u},get hideLoading(){return d}};return Object.defineProperty(N,"__isScriptSetup",{enumerable:!1,value:!0}),N}},[["render",function(t,a,o,s,r,n){return e.openBlock(),e.createElementBlock("view",{class:"profile-container"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("view",{class:"header-title"},e.toDisplayString(s.isFirstLogin?"å®Œå–„ä¸ªäººèµ„æ–™":"ç¼–è¾‘ä¸ªäººèµ„æ–™"),1),s.isFirstLogin?(e.openBlock(),e.createElementBlock("view",{key:0,class:"first-login-tip"},"é¦–æ¬¡ç™»å½•ï¼Œè¯·å®Œå–„ä¸ªäººä¿¡æ¯")):e.createCommentVNode("v-if",!0)]),e.createElementVNode("view",{class:"avatar-section"},[e.createElementVNode("view",{class:"avatar-wrapper"},[e.createElementVNode("image",{class:"avatar",src:s.displayAvatar,mode:"aspectFill"},null,8,["src"]),s.avatarLoading?(e.openBlock(),e.createElementBlock("view",{key:0,class:"avatar-loading"},[e.createElementVNode("text",{class:"loading-text"},"ä¸Šä¼ ä¸­...")])):e.createCommentVNode("v-if",!0)]),e.createElementVNode("view",{class:"change-avatar-btn",onClick:s.changeAvatar},"æ›´æ¢å¤´åƒ")]),e.createElementVNode("view",{class:"form-section"},[e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label required"},"æ˜µç§°"),e.withDirectives(e.createElementVNode("input",{class:"form-input",type:"text","onUpdate:modelValue":a[0]||(a[0]=e=>s.form.nickname=e),placeholder:"è¯·è¾“å…¥æ˜µç§°"},null,512),[[e.vModelText,s.form.nickname]])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label required"},"é‚®ç®±"),e.withDirectives(e.createElementVNode("input",{class:"form-input",type:"text","onUpdate:modelValue":a[1]||(a[1]=e=>s.form.email=e),placeholder:"è¯·è¾“å…¥é‚®ç®±"},null,512),[[e.vModelText,s.form.email]])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label required"},"æ‰‹æœºå·ç "),e.withDirectives(e.createElementVNode("input",{class:"form-input",type:"text","onUpdate:modelValue":a[2]||(a[2]=e=>s.form.phone=e),placeholder:"è¯·è¾“å…¥æ‰‹æœºå·ç "},null,512),[[e.vModelText,s.form.phone]])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"æ€§åˆ«"),e.createElementVNode("picker",{class:"form-picker",mode:"selector",range:s.genderOptions,"range-key":"label",value:s.genderIndex,onChange:s.onGenderChange},[e.createElementVNode("view",{class:"picker-text"},e.toDisplayString(s.genderOptions[s.genderIndex].label),1)],40,["value"])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"ä¸ªäººç­¾å"),e.withDirectives(e.createElementVNode("textarea",{class:"form-textarea","onUpdate:modelValue":a[3]||(a[3]=e=>s.form.bio=e),placeholder:"è¯·è¾“å…¥ä¸ªäººç­¾å"},null,512),[[e.vModelText,s.form.bio]])])]),e.createElementVNode("view",{class:"button-section"},[e.createElementVNode("button",{class:"save-btn",disabled:!s.isFormValid||s.isSubmitting,onClick:s.saveProfile},e.toDisplayString(s.isSubmitting?"ä¿å­˜ä¸­...":"ä¿å­˜"),9,["disabled"]),s.isFirstLogin?e.createCommentVNode("v-if",!0):(e.openBlock(),e.createElementBlock("button",{key:0,class:"cancel-btn",onClick:s.goBack},"å–æ¶ˆ"))])])}],["__file","D:/caloriesH5/CloudStorage/pages/profile/profile.vue"]]);const Tt=ze({components:{UserInfoPopup:lt},setup(){const t=Re(),o=e.ref(!0),s=e.ref([]),r=e.ref(!1),n=e.ref(null),i=e.ref([]),l=e.ref(!1),c=e.ref(!1);e.onMounted((()=>__async(this,null,(function*(){yield u()}))));const u=()=>__async(this,null,(function*(){o.value=!0,c.value=!1;try{if(!t.isAuthenticated)return void uni.navigateTo({url:"/pages/login/login"});const e=t.userId||uni.getStorageSync("userId");if(!e)return uni.showToast({title:"æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯",icon:"none"}),void(o.value=!1);const r=yield A.user.getFollowing(e);a("log","at pages/profile/following.vue:102","å…³æ³¨åˆ—è¡¨:",r),Array.isArray(r)?s.value=r.map((e=>__spreadProps(__spreadValues({},e),{isFollowing:!0}))):s.value=[]}catch(e){a("error","at pages/profile/following.vue:114","Failed to load following list:",e),o.value=!1,c.value=!0,uni.showToast({title:"åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}finally{o.value=!1}})),d=e=>__async(this,null,(function*(){if(t.isAuthenticated)try{const a=yield A.user.followUser(e._id);a&&void 0!==a.isFollowing&&(e.isFollowing=a.isFollowing,e.isFollowing||(s.value=s.value.filter((t=>t._id!==e._id))),uni.showToast({title:e.isFollowing?"å…³æ³¨æˆåŠŸ":"å–æ¶ˆå…³æ³¨æˆåŠŸ",icon:"success"}),yield t.fetchUserStats())}catch(o){a("error","at pages/profile/following.vue:157","å…³æ³¨æ“ä½œå¤±è´¥:",o),uni.showToast({title:"æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}else uni.navigateTo({url:"/pages/login/login"})}));return{isLoading:o,followingList:s,goBack:()=>{uni.navigateBack()},goExplore:()=>{uni.switchTab({url:"/pages/community/community"})},toggleFollow:d,viewUserProfile:e=>__async(this,null,(function*(){n.value=__spreadProps(__spreadValues({},e),{isCurrentUser:t.userId===e._id});try{const t=yield A.user.getPetsByUser(e._id);i.value=t||[],l.value=e.isFollowing||!1,r.value=!0}catch(o){a("error","at pages/profile/following.vue:183","è·å–ç”¨æˆ·è¯¦æƒ…å¤±è´¥:",o),i.value=[],r.value=!0}})),formatAvatarUrl:e=>{if(!e)return"/static/images/default-avatar.png";if(e.startsWith("http")||e.startsWith("/static"))return e;if(e.startsWith("/uploads")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}return"/static/images/default-avatar.png"},showUserPopup:r,selectedUser:n,selectedUserPets:i,isUserFollowing:l,closeUserPopup:()=>{r.value=!1},messageUser:e=>{a("log","at pages/profile/following.vue:197","å‘é€æ¶ˆæ¯ç»™ç”¨æˆ·:",e)},followUser:e=>__async(this,null,(function*(){yield d(e),l.value=e.isFollowing||!1})),isRetryVisible:c,loadFollowingList:u}}},[["render",function(t,a,o,s,r,n){const i=e.resolveComponent("uni-nav-bar"),l=e.resolveComponent("uni-icons"),c=e.resolveComponent("UserInfoPopup");return e.openBlock(),e.createElementBlock("view",{class:"following-container"},[e.createVNode(i,{"left-icon":"back",onClickLeft:s.goBack,title:"æˆ‘çš„å…³æ³¨"},null,8,["onClickLeft"]),e.createCommentVNode(" Loading state "),s.isLoading?(e.openBlock(),e.createElementBlock("view",{key:0,class:"loading-container"},[e.createVNode(l,{type:"spinner-cycle",size:"24",color:"#ff5f15",class:"loading-icon"}),e.createElementVNode("text",{class:"loading-text"},"åŠ è½½ä¸­...")])):s.isRetryVisible?(e.openBlock(),e.createElementBlock(e.Fragment,{key:1},[e.createCommentVNode(" Retry state "),e.createElementVNode("view",{class:"retry-container"},[e.createElementVNode("text",{class:"error-text"},"åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•"),e.createElementVNode("button",{class:"retry-button",onClick:a[0]||(a[0]=(...e)=>s.loadFollowingList&&s.loadFollowingList(...e))},"é‡è¯•")])],2112)):0===s.followingList.length?(e.openBlock(),e.createElementBlock(e.Fragment,{key:2},[e.createCommentVNode(" Empty state "),e.createElementVNode("view",{class:"empty-container"},[e.createElementVNode("image",{src:"/static/images/empty-list.png",class:"empty-image"}),e.createElementVNode("text",{class:"empty-text"},"è¿˜æ²¡æœ‰å…³æ³¨ä»»ä½•ç”¨æˆ·"),e.createElementVNode("button",{class:"explore-btn",onClick:a[1]||(a[1]=(...e)=>s.goExplore&&s.goExplore(...e))},"å»æ¢ç´¢")])],2112)):(e.openBlock(),e.createElementBlock(e.Fragment,{key:3},[e.createCommentVNode(" Following list "),e.createElementVNode("view",{class:"following-list"},[!s.isLoading&&s.followingList.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"user-list"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.followingList,((t,a)=>(e.openBlock(),e.createElementBlock("view",{class:"user-item",key:a,onClick:e=>s.viewUserProfile(t)},[e.createElementVNode("image",{class:"user-avatar",src:s.formatAvatarUrl(t.avatar),mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"user-info"},[e.createElementVNode("text",{class:"user-name"},e.toDisplayString(t.username||t.nickname||"ç”¨æˆ·"),1),t.bio?(e.openBlock(),e.createElementBlock("text",{key:0,class:"user-desc"},e.toDisplayString(t.bio),1)):e.createCommentVNode("v-if",!0)]),e.createElementVNode("button",{class:e.normalizeClass(["follow-btn",{following:t.isFollowing}]),onClick:e.withModifiers((e=>s.toggleFollow(t)),["stop"])},e.toDisplayString(t.isFollowing?"å·²å…³æ³¨":"å…³æ³¨"),11,["onClick"])],8,["onClick"])))),128))])):e.createCommentVNode("v-if",!0)])],2112)),e.createCommentVNode(" ç”¨æˆ·è¯¦æƒ…å¼¹çª— "),s.showUserPopup?(e.openBlock(),e.createBlock(c,{key:4,user:s.selectedUser,pets:s.selectedUserPets,"is-following":s.isUserFollowing,visible:s.showUserPopup,onClose:s.closeUserPopup,onMessage:s.messageUser,onFollow:s.followUser},null,8,["user","pets","is-following","visible","onClose","onMessage","onFollow"])):e.createCommentVNode("v-if",!0)])}],["__file","D:/caloriesH5/CloudStorage/pages/profile/following.vue"]]);const Mt=ze({components:{UserInfoPopup:lt},setup(){const t=Re(),o=e.ref(!0),s=e.ref([]),r=e.ref(!1),n=e.ref(null),i=e.ref([]),l=e.ref(!1),c=e.ref(!1);e.onMounted((()=>__async(this,null,(function*(){yield u()}))));const u=()=>__async(this,null,(function*(){o.value=!0,c.value=!1;try{if(!t.isAuthenticated)return void uni.navigateTo({url:"/pages/login/login"});const e=t.userId||uni.getStorageSync("userId");if(!e)return uni.showToast({title:"æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯",icon:"none"}),void(o.value=!1);const r=yield A.user.getFollowers(e);a("log","at pages/profile/followers.vue:101","Followers list:",r),s.value=r;const n=(yield t.fetchUserInfo()).following||[];s.value=s.value.map((e=>__spreadProps(__spreadValues({},e),{isFollowing:n.some((t=>t===e._id||t._id&&t._id===e._id))})))}catch(e){a("error","at pages/profile/followers.vue:116","Failed to load followers:",e),o.value=!1,c.value=!0,uni.showToast({title:"åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}finally{o.value=!1}})),d=e=>__async(this,null,(function*(){if(t.isAuthenticated)try{const a=yield A.user.followUser(e._id);a&&void 0!==a.isFollowing&&(e.isFollowing=a.isFollowing,uni.showToast({title:e.isFollowing?"å…³æ³¨æˆåŠŸ":"å–æ¶ˆå…³æ³¨æˆåŠŸ",icon:"success"}),yield t.fetchUserStats())}catch(o){a("error","at pages/profile/followers.vue:154","å…³æ³¨æ“ä½œå¤±è´¥:",o),uni.showToast({title:"æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}else uni.navigateTo({url:"/pages/login/login"})}));return{isLoading:o,followersList:s,goBack:()=>{uni.navigateBack()},shareApp:()=>{uni.showToast({title:"åˆ†äº«åŠŸèƒ½å¼€å‘ä¸­",icon:"none"})},toggleFollow:d,viewUserProfile:e=>__async(this,null,(function*(){n.value=__spreadProps(__spreadValues({},e),{isCurrentUser:t.userId===e._id});try{const t=yield A.user.getPetsByUser(e._id);i.value=t||[],l.value=e.isFollowing||!1,r.value=!0}catch(o){a("error","at pages/profile/followers.vue:180","è·å–ç”¨æˆ·è¯¦æƒ…å¤±è´¥:",o),i.value=[],r.value=!0}})),formatAvatarUrl:e=>{if(!e)return"/static/images/default-avatar.png";if(e.startsWith("http")||e.startsWith("/static"))return e;if(e.startsWith("/uploads")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}return"/static/images/default-avatar.png"},showUserPopup:r,selectedUser:n,selectedUserPets:i,isUserFollowing:l,closeUserPopup:()=>{r.value=!1},messageUser:e=>{a("log","at pages/profile/followers.vue:194","å‘é€æ¶ˆæ¯ç»™ç”¨æˆ·:",e)},followUser:e=>__async(this,null,(function*(){yield d(e),l.value=e.isFollowing||!1})),isRetryVisible:c}}},[["render",function(t,a,o,s,r,n){const i=e.resolveComponent("uni-nav-bar"),l=e.resolveComponent("uni-icons"),c=e.resolveComponent("UserInfoPopup");return e.openBlock(),e.createElementBlock("view",{class:"followers-container"},[e.createVNode(i,{"left-icon":"back",onClickLeft:s.goBack,title:"ç²‰ä¸åˆ—è¡¨"},null,8,["onClickLeft"]),e.createCommentVNode(" Loading state "),s.isLoading?(e.openBlock(),e.createElementBlock("view",{key:0,class:"loading-container"},[e.createVNode(l,{type:"spinner-cycle",size:"24",color:"#ff5f15",class:"loading-icon"}),e.createElementVNode("text",{class:"loading-text"},"åŠ è½½ä¸­...")])):s.isRetryVisible?(e.openBlock(),e.createElementBlock(e.Fragment,{key:1},[e.createCommentVNode(" Retry state "),e.createElementVNode("view",{class:"retry-container"},[e.createElementVNode("text",{class:"error-text"},"åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•"),e.createElementVNode("button",{class:"retry-button",onClick:a[0]||(a[0]=(...e)=>t.loadFollowersList&&t.loadFollowersList(...e))},"é‡è¯•")])],2112)):0===s.followersList.length?(e.openBlock(),e.createElementBlock(e.Fragment,{key:2},[e.createCommentVNode(" Empty state "),e.createElementVNode("view",{class:"empty-container"},[e.createElementVNode("image",{src:"/static/images/empty-followers.png",class:"empty-image"}),e.createElementVNode("text",{class:"empty-text"},"æš‚æ— ç²‰ä¸")])],2112)):(e.openBlock(),e.createElementBlock(e.Fragment,{key:3},[e.createCommentVNode(" Followers list "),e.createElementVNode("view",{class:"followers-list"},[!s.isLoading&&s.followersList.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"user-list"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.followersList,((t,a)=>(e.openBlock(),e.createElementBlock("view",{class:"user-item",key:a,onClick:e=>s.viewUserProfile(t)},[e.createElementVNode("image",{class:"user-avatar",src:s.formatAvatarUrl(t.avatar),mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"user-info"},[e.createElementVNode("text",{class:"user-name"},e.toDisplayString(t.username||t.nickname||"ç”¨æˆ·"),1),t.bio?(e.openBlock(),e.createElementBlock("text",{key:0,class:"user-desc"},e.toDisplayString(t.bio),1)):e.createCommentVNode("v-if",!0)]),e.createElementVNode("button",{class:e.normalizeClass(["follow-btn",{following:t.isFollowing}]),onClick:e.withModifiers((e=>s.toggleFollow(t)),["stop"])},e.toDisplayString(t.isFollowing?"å·²å…³æ³¨":"å…³æ³¨"),11,["onClick"])],8,["onClick"])))),128))])):e.createCommentVNode("v-if",!0)])],2112)),e.createCommentVNode(" ç”¨æˆ·è¯¦æƒ…å¼¹çª— "),s.showUserPopup?(e.openBlock(),e.createBlock(c,{key:4,user:s.selectedUser,pets:s.selectedUserPets,"is-following":s.isUserFollowing,visible:s.showUserPopup,onClose:s.closeUserPopup,onMessage:s.messageUser,onFollow:s.followUser},null,8,["user","pets","is-following","visible","onClose","onMessage","onFollow"])):e.createCommentVNode("v-if",!0)])}],["__file","D:/caloriesH5/CloudStorage/pages/profile/followers.vue"]]);const Dt=new class{constructor(){this.messageCaches={nearby:[],city:[]},this.messageQueue=[],this.isProcessingQueue=!1,this.loadingStates={nearby:!1,city:!1},this.pagination={nearby:{page:1,limit:20,total:0},city:{page:1,limit:20,total:0}},this.networkStatus={isOnline:!0,lastChecked:Date.now()},this.checkNetworkStatus(),uni.onNetworkStatusChange((e=>{this.handleNetworkChange(e.isConnected)}))}getNearbyMessages(){return __async(this,arguments,(function*(e={}){try{this.loadingStates.nearby=!0,a("log","at utils/chatService.js:63","chatServiceå¼€å§‹è·å–é™„è¿‘æ¶ˆæ¯, å‚æ•°:",e);const t=__spreadProps(__spreadValues({},e),{page:e.page||this.pagination.nearby.page,limit:e.limit||this.pagination.nearby.limit}),o=yield A.chat.getNearbyMessages(t);a("log","at utils/chatService.js:74","chatServiceè·å–åˆ°é™„è¿‘æ¶ˆæ¯rawå“åº”:",o),o&&o.pagination&&(this.pagination.nearby=o.pagination);let s=[];if(o&&o.data?s=o.data:Array.isArray(o)&&(s=o),a("log","at utils/chatService.js:91","chatServiceå¤„ç†åçš„æ¶ˆæ¯æ•°æ®:",s),1===t.page)this.messageCaches.nearby=[...s];else{const e=this.messageCaches.nearby.map((e=>e.id)),t=s.filter((t=>!e.includes(t.id)));this.messageCaches.nearby=[...this.messageCaches.nearby,...t]}return this.messageCaches.nearby.length>50&&(this.messageCaches.nearby=this.messageCaches.nearby.slice(-50)),s}catch(t){if(a("error","at utils/chatService.js:110","è·å–é™„è¿‘æ¶ˆæ¯å¤±è´¥:",t),this.isNetworkError(t)&&this.messageCaches.nearby.length>0)return a("log","at utils/chatService.js:114","ä½¿ç”¨ç¼“å­˜çš„é™„è¿‘æ¶ˆæ¯"),this.messageCaches.nearby;throw t}finally{this.loadingStates.nearby=!1}}))}getCityMessages(){return __async(this,arguments,(function*(e={}){try{if(this.loadingStates.city=!0,a("log","at utils/chatService.js:132","chatServiceå¼€å§‹è·å–åŸå¸‚æ¶ˆæ¯, å‚æ•°:",e),!e.cityName)return a("error","at utils/chatService.js:135","åŸå¸‚åç§°ä¸èƒ½ä¸ºç©º"),[];const t=__spreadProps(__spreadValues({},e),{page:e.page||this.pagination.city.page,limit:e.limit||this.pagination.city.limit}),o=yield A.chat.getCityMessages(t);a("log","at utils/chatService.js:148","chatServiceè·å–åˆ°åŸå¸‚æ¶ˆæ¯rawå“åº”:",o),o&&o.pagination&&(this.pagination.city=o.pagination);let s=[];if(o&&o.data?s=o.data:Array.isArray(o)&&(s=o),a("log","at utils/chatService.js:165","chatServiceå¤„ç†åçš„åŸå¸‚æ¶ˆæ¯æ•°æ®:",s),1===t.page)this.messageCaches.city=[...s];else{const e=this.messageCaches.city.map((e=>e.id)),t=s.filter((t=>!e.includes(t.id)));this.messageCaches.city=[...this.messageCaches.city,...t]}return this.messageCaches.city.length>50&&(this.messageCaches.city=this.messageCaches.city.slice(-50)),s}catch(t){if(a("error","at utils/chatService.js:184","è·å–åŸå¸‚æ¶ˆæ¯å¤±è´¥:",t),this.isNetworkError(t)&&this.messageCaches.city.length>0)return a("log","at utils/chatService.js:188","ä½¿ç”¨ç¼“å­˜çš„åŸå¸‚æ¶ˆæ¯"),this.messageCaches.city;throw t}finally{this.loadingStates.city=!1}}))}sendNearbyMessage(e){return __async(this,null,(function*(){return this.sendMessage("nearby",e)}))}sendCityMessage(e){return __async(this,null,(function*(){return this.sendMessage("city",e)}))}sendMessage(e,t){return __async(this,null,(function*(){const a={id:"temp-"+Date.now()+"-"+Math.floor(1e3*Math.random()),content:t.content,createTime:(new Date).getTime(),status:"sending",type:e,data:t,retryCount:0};return this.messageQueue.push(a),this.isProcessingQueue||this.processMessageQueue(),a}))}processMessageQueue(){return __async(this,null,(function*(){if(0!==this.messageQueue.length&&!this.isProcessingQueue){if(this.isProcessingQueue=!0,!this.networkStatus.isOnline)return a("log","at utils/chatService.js:261","ç½‘ç»œç¦»çº¿ï¼Œæš‚åœå¤„ç†æ¶ˆæ¯é˜Ÿåˆ—"),void(this.isProcessingQueue=!1);try{const e=this.messageQueue[0];let t;"nearby"===e.type?t=yield A.chat.sendNearbyMessage(e.data):"city"===e.type&&(t=yield A.chat.sendCityMessage(e.data)),t&&(a("log","at utils/chatService.js:280","æ¶ˆæ¯å‘é€æˆåŠŸ:",t),this.messageQueue.shift(),this.updateMessageStatus(e.id,"sent",t))}catch(e){a("error","at utils/chatService.js:289","å‘é€æ¶ˆæ¯å¤±è´¥:",e);const t=this.messageQueue[0];t.retryCount++,t.retryCount>=3?(a("log","at utils/chatService.js:299",`æ¶ˆæ¯ ${t.id} é‡è¯•å¤±è´¥ ${t.retryCount} æ¬¡ï¼Œæ”¾å¼ƒé‡è¯•`),this.messageQueue.shift(),this.updateMessageStatus(t.id,"failed")):a("log","at utils/chatService.js:304",`æ¶ˆæ¯ ${t.id} å‘é€å¤±è´¥ï¼Œå°†åœ¨ 2000ms åé‡è¯• (${t.retryCount}/3)`)}finally{this.isProcessingQueue=!1,this.messageQueue.length>0&&setTimeout((()=>{this.processMessageQueue()}),2e3)}}}))}updateMessageStatus(e,t,o=null){a("log","at utils/chatService.js:327","æ¶ˆæ¯çŠ¶æ€æ›´æ–°:",e,t,o),uni.$emit("chat:message-status-update",{messageId:e,status:t,serverData:o})}isNetworkError(e){var t,a,o;return(null==(t=e.message)?void 0:t.includes("ç½‘ç»œ"))||(null==(a=e.message)?void 0:a.includes("Network"))||(null==(o=e.message)?void 0:o.includes("timeout"))||0===e.statusCode||!this.networkStatus.isOnline}checkNetworkStatus(){uni.getNetworkType({success:e=>{const t="none"!==e.networkType;this.handleNetworkChange(t)}})}handleNetworkChange(e){const t=this.networkStatus.isOnline;this.networkStatus.isOnline=e,this.networkStatus.lastChecked=Date.now(),a("log","at utils/chatService.js:373","ç½‘ç»œçŠ¶æ€æ›´æ–°:",e?"åœ¨çº¿":"ç¦»çº¿"),!t&&e&&(a("log","at utils/chatService.js:377","ç½‘ç»œå·²æ¢å¤ï¼Œé‡æ–°å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—"),setTimeout((()=>{this.processMessageQueue()}),1e3)),uni.$emit("chat:network-status-change",{isOnline:e})}};const At=new class{constructor(){this.status=e.reactive({isConnected:!0,networkType:"unknown",lastChecked:Date.now()}),this.listeners=[],this.checkNetworkStatus(),this.setupListeners()}setupListeners(){uni.onNetworkStatusChange((e=>{this.handleNetworkChange(e)})),setInterval((()=>{this.checkNetworkStatus()}),3e4)}checkNetworkStatus(){return new Promise((e=>{uni.getNetworkType({success:t=>{this.handleNetworkChange(t),e(this.status)},fail:()=>{this.handleNetworkChange({isConnected:!1,networkType:"none"}),e(this.status)}})}))}handleNetworkChange(e){const t=this.status.isConnected;this.status.isConnected=void 0!==e.isConnected?e.isConnected:"none"!==e.networkType,this.status.networkType=e.networkType||"unknown",this.status.lastChecked=Date.now(),a("log","at utils/networkManager.js:73",`ç½‘ç»œçŠ¶æ€å˜åŒ–: ${this.status.isConnected?"åœ¨çº¿":"ç¦»çº¿"}, ç±»å‹: ${this.status.networkType}`),uni.$emit("network:status-change",__spreadValues({},this.status)),this.notifyListeners(),!t&&this.status.isConnected&&(a("log","at utils/networkManager.js:83","ç½‘ç»œå·²æ¢å¤è¿æ¥"),uni.$emit("network:reconnected",__spreadValues({},this.status))),t&&!this.status.isConnected&&(a("log","at utils/networkManager.js:89","ç½‘ç»œå·²æ–­å¼€è¿æ¥"),uni.$emit("network:disconnected",__spreadValues({},this.status)),uni.showToast({title:"ç½‘ç»œå·²æ–­å¼€ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥",icon:"none",duration:2e3}))}addListener(e){return"function"!=typeof e?(a("error","at utils/networkManager.js:108","ç½‘ç»œçŠ¶æ€ç›‘å¬å™¨å¿…é¡»æ˜¯å‡½æ•°"),()=>{}):(this.listeners.push(e),e(__spreadValues({},this.status)),()=>{this.removeListener(e)})}removeListener(e){const t=this.listeners.indexOf(e);-1!==t&&this.listeners.splice(t,1)}notifyListeners(){const e=__spreadValues({},this.status);this.listeners.forEach((t=>{try{t(e)}catch(o){a("error","at utils/networkManager.js:143","ç½‘ç»œçŠ¶æ€ç›‘å¬å™¨å›è°ƒé”™è¯¯:",o)}}))}getStatus(){return __spreadValues({},this.status)}isOnline(){return this.status.isConnected}isGoodConnection(){return!!this.status.isConnected&&("wifi"===this.status.networkType||"4g"===this.status.networkType||"5g"===this.status.networkType)}},Bt="chat_nearby_messages",Ut="chat_city_messages",jt=6048e5;function Ft(){try{const e=uni.getStorageSync("chat_pending_messages");if(e){return JSON.parse(e).messages||[]}}catch(e){a("error","at utils/chatStorage.js:214","è¯»å–å¾…å¤„ç†æ¶ˆæ¯å¤±è´¥:",e)}return[]}const Lt={getNearbyMessagesCache:function(e=""){const t=e?`${Bt}_${e}`:Bt;try{const e=uni.getStorageSync(t);if(e){const o=JSON.parse(e);return o.timestamp&&Date.now()-o.timestamp>jt?(a("log","at utils/chatStorage.js:26","é™„è¿‘æ¶ˆæ¯ç¼“å­˜å·²è¿‡æœŸï¼Œæ¸…é™¤ç¼“å­˜"),uni.removeStorageSync(t),[]):o.messages||[]}}catch(o){a("error","at utils/chatStorage.js:34","è¯»å–é™„è¿‘æ¶ˆæ¯ç¼“å­˜å¤±è´¥:",o)}return[]},saveNearbyMessagesCache:function(e,t=""){if(!Array.isArray(e))return void a("error","at utils/chatStorage.js:46","ä¿å­˜çš„æ¶ˆæ¯å¿…é¡»æ˜¯æ•°ç»„");const o=t?`${Bt}_${t}`:Bt;try{const t={messages:e.slice(-100),timestamp:Date.now()};uni.setStorageSync(o,JSON.stringify(t))}catch(s){a("error","at utils/chatStorage.js:62","ä¿å­˜é™„è¿‘æ¶ˆæ¯ç¼“å­˜å¤±è´¥:",s)}},getCityMessagesCache:function(e){if(!e)return a("error","at utils/chatStorage.js:73","è·å–åŸå¸‚æ¶ˆæ¯ç¼“å­˜éœ€è¦åŸå¸‚åç§°"),[];const t=`${Ut}_${e}`;try{const o=uni.getStorageSync(t);if(o){const s=JSON.parse(o);return s.timestamp&&Date.now()-s.timestamp>jt?(a("log","at utils/chatStorage.js:85",`åŸå¸‚ã€${e}ã€‘æ¶ˆæ¯ç¼“å­˜å·²è¿‡æœŸï¼Œæ¸…é™¤ç¼“å­˜`),uni.removeStorageSync(t),[]):s.messages||[]}}catch(o){a("error","at utils/chatStorage.js:93",`è¯»å–åŸå¸‚ã€${e}ã€‘æ¶ˆæ¯ç¼“å­˜å¤±è´¥:`,o)}return[]},saveCityMessagesCache:function(e,t){if(!Array.isArray(e))return void a("error","at utils/chatStorage.js:105","ä¿å­˜çš„æ¶ˆæ¯å¿…é¡»æ˜¯æ•°ç»„");if(!t)return void a("error","at utils/chatStorage.js:110","ä¿å­˜åŸå¸‚æ¶ˆæ¯ç¼“å­˜éœ€è¦åŸå¸‚åç§°");const o=`${Ut}_${t}`;try{const t={messages:e.slice(-100),timestamp:Date.now()};uni.setStorageSync(o,JSON.stringify(t))}catch(s){a("error","at utils/chatStorage.js:126",`ä¿å­˜åŸå¸‚ã€${t}ã€‘æ¶ˆæ¯ç¼“å­˜å¤±è´¥:`,s)}},clearExpiredMessageCaches:function(){try{const e=uni.getStorageInfoSync().keys;e.filter((e=>e.startsWith(Bt)||e.startsWith(Ut))).forEach((e=>{try{const t=uni.getStorageSync(e);if(t){const o=JSON.parse(t);o.timestamp&&Date.now()-o.timestamp>jt&&(a("log","at utils/chatStorage.js:153",`ç¼“å­˜ã€${e}ã€‘å·²è¿‡æœŸï¼Œæ¸…é™¤ç¼“å­˜`),uni.removeStorageSync(e))}}catch(t){a("warn","at utils/chatStorage.js:159",`ç¼“å­˜ã€${e}ã€‘æ•°æ®æ— æ•ˆï¼Œæ¸…é™¤ç¼“å­˜`),uni.removeStorageSync(e)}})),a("log","at utils/chatStorage.js:164","æ¸…ç†è¿‡æœŸç¼“å­˜å®Œæˆ")}catch(e){a("error","at utils/chatStorage.js:166","æ¸…ç†è¿‡æœŸç¼“å­˜å¤±è´¥:",e)}},savePendingMessage:function(e){if(e&&e.id)try{const t=Ft(),a=t.findIndex((t=>t.id===e.id));-1!==a?t[a]=e:t.push(e),uni.setStorageSync("chat_pending_messages",JSON.stringify({messages:t,timestamp:Date.now()}))}catch(t){a("error","at utils/chatStorage.js:198","ä¿å­˜å¾…å¤„ç†æ¶ˆæ¯å¤±è´¥:",t)}else a("error","at utils/chatStorage.js:176","ä¿å­˜çš„æ¶ˆæ¯å¯¹è±¡æ— æ•ˆ")},getPendingMessages:Ft,removePendingMessage:function(e){if(e)try{const t=Ft().filter((t=>t.id!==e));uni.setStorageSync("chat_pending_messages",JSON.stringify({messages:t,timestamp:Date.now()}))}catch(t){a("error","at utils/chatStorage.js:235","ç§»é™¤å¾…å¤„ç†æ¶ˆæ¯å¤±è´¥:",t)}},getPrivateMessages:function(e){if(!e)return a("error","at utils/chatStorage.js:246","è·å–ç§èŠæ¶ˆæ¯ç¼“å­˜éœ€è¦ç¼“å­˜é”®"),[];try{const t=uni.getStorageSync(e);if(t){const o=JSON.parse(t);return o.timestamp&&Date.now()-o.timestamp>jt?(a("log","at utils/chatStorage.js:257",`ç§èŠæ¶ˆæ¯ç¼“å­˜ã€${e}ã€‘å·²è¿‡æœŸï¼Œæ¸…é™¤ç¼“å­˜`),uni.removeStorageSync(e),[]):o.messages||[]}}catch(t){a("error","at utils/chatStorage.js:265",`è¯»å–ç§èŠæ¶ˆæ¯ç¼“å­˜ã€${e}ã€‘å¤±è´¥:`,t)}return[]},savePrivateMessages:function(e,t){if(Array.isArray(e))if(t)try{const a={messages:e.slice(-100),timestamp:Date.now()};uni.setStorageSync(t,JSON.stringify(a))}catch(o){a("error","at utils/chatStorage.js:297",`ä¿å­˜ç§èŠæ¶ˆæ¯ç¼“å­˜ã€${t}ã€‘å¤±è´¥:`,o)}else a("error","at utils/chatStorage.js:282","ä¿å­˜ç§èŠæ¶ˆæ¯ç¼“å­˜éœ€è¦ç¼“å­˜é”®");else a("error","at utils/chatStorage.js:277","ä¿å­˜çš„æ¶ˆæ¯å¿…é¡»æ˜¯æ•°ç»„")}},$t="/static/images/empty-message.png";const Ot=ze({setup(){const t=Re(),o=e.computed((()=>t.user||{})),l=e.computed((()=>o.value.id||o.value._id||"")),c=e.ref({}),u=e.ref(""),d=e.ref(!1),m=e.ref([]),p=e.ref(!1),g=e.ref(!1),v=e.ref(!1),h=e.ref(0),f=e.ref(null),y=e.ref(null),w=e.ref(!1),k=e.ref(""),E=e.ref(!1),N=e.ref({isConnected:!0,networkType:"unknown"}),V=e.ref(!0),S=e.ref(1);let _=null,C=null;const b=()=>{if(!l.value||!u.value)return null;return`private_chat_${[l.value,u.value].sort().join("_")}`},P=()=>__async(this,null,(function*(){if(u.value)try{const e=yield A.user.getUserInfo(u.value);e&&(e.id||e._id)?c.value=e:(a("warn","at pages/chat/chat.vue:201","è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨ä¸´æ—¶æ•°æ®"),c.value={id:u.value,username:"èŠå¤©ç”¨æˆ·",avatar:"/static/images/default-avatar.png"}),D()}catch(e){a("error","at pages/chat/chat.vue:213","åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",e);try{const e=b();if(e){const t=uni.getStorageSync(`${e}_user`);if(t){const e=JSON.parse(t);c.value=e,a("log","at pages/chat/chat.vue:223","ä½¿ç”¨ç¼“å­˜çš„ç”¨æˆ·ä¿¡æ¯:",e)}}}catch(t){a("error","at pages/chat/chat.vue:227","è¯»å–ç¼“å­˜ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",t)}uni.showToast({title:"åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥",icon:"none"})}})),x=(t=!1)=>__async(this,null,(function*(){if(u.value&&l.value)if(!p.value||t)try{p.value=!0,t&&(S.value=1,v.value=!1,y.value=null);const s={targetUserId:u.value,page:S.value,limit:20};y.value&&!t&&(s.beforeMessageId=y.value),a("log","at pages/chat/chat.vue:267","åŠ è½½æ¶ˆæ¯, å‚æ•°:",s);let r=[];try{if(A.chat.getPrivateMessages){const e=yield A.chat.getPrivateMessages(s);r=(null==e?void 0:e.data)||e||[]}else a("warn","at pages/chat/chat.vue:279","æ²¡æœ‰æ‰¾åˆ°ç§èŠæ¶ˆæ¯APIï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®"),r=t?Array(5).fill().map(((e,t)=>({id:`msg-${Date.now()}-${t}`,content:`è¿™æ˜¯ä¸€æ¡æ¨¡æ‹Ÿæ¶ˆæ¯ ${t+1}`,senderId:t%2==0?l.value:u.value,receiverId:t%2==0?u.value:l.value,createTime:new Date(Date.now()-6e4*t).getTime(),status:"sent"}))):Array(3).fill().map(((e,t)=>({id:`msg-old-${Date.now()}-${t}`,content:`è¿™æ˜¯æ›´æ—©çš„æ¨¡æ‹Ÿæ¶ˆæ¯ ${t+1}`,senderId:t%2==0?l.value:u.value,receiverId:t%2==0?u.value:l.value,createTime:new Date(Date.now()-6e4*(t+10)).getTime(),status:"sent"})))}catch(o){if(a("error","at pages/chat/chat.vue:304","APIè°ƒç”¨å¤±è´¥:",o),At.isNetworkError(o)){const e=b();if(e){const t=Lt.getPrivateMessages(e);t&&t.length>0&&(r=t,a("log","at pages/chat/chat.vue:313","ä»ç¼“å­˜åŠ è½½ç§èŠæ¶ˆæ¯",r.length))}}0===r.length&&t&&(r=[{id:`temp-${Date.now()}`,content:"ç½‘ç»œè¿æ¥ä¸ä½³ï¼Œæ— æ³•åŠ è½½æ¶ˆæ¯å†å²",senderId:"system",createTime:Date.now(),status:"info",isSystemMessage:!0}])}if(r&&r.length>0){if(t)m.value=r;else{const e=m.value.map((e=>e.id)),t=r.filter((t=>!e.includes(t.id)));if(t.length>0){if(m.value=[...t,...m.value],S.value++,t.length>0){const e=[...t].sort(((e,t)=>new Date(e.createTime)-new Date(t.createTime)))[0];e&&(y.value=e.id,a("log","at pages/chat/chat.vue:354","æ›´æ–°æœ€ååŠ è½½çš„æ¶ˆæ¯ID:",y.value))}}else v.value=!0,a("log","at pages/chat/chat.vue:359","æ²¡æœ‰æ›´å¤šå†å²æ¶ˆæ¯äº†")}const o=b();o&&(Lt.savePrivateMessages(m.value,o),c.value&&(c.value.id||c.value._id)&&uni.setStorageSync(`${o}_user`,JSON.stringify(c.value))),t&&(yield e.nextTick(),B())}else t||(v.value=!0);M()}catch(s){a("error","at pages/chat/chat.vue:389","åŠ è½½æ¶ˆæ¯å¤±è´¥:",s),uni.showToast({title:"åŠ è½½æ¶ˆæ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥",icon:"none"})}finally{p.value=!1,g.value=!1}else a("log","at pages/chat/chat.vue:242","å·²æœ‰åŠ è½½è¯·æ±‚è¿›è¡Œä¸­ï¼Œè·³è¿‡")})),I=()=>__async(this,null,(function*(){u.value&&l.value&&!p.value&&!v.value?(g.value=!0,yield x(),g.value=!1):g.value=!1})),T=e=>__async(this,null,(function*(){const t=m.value.findIndex((t=>t.id===e));if(-1===t)return;const o=m.value[t];m.value[t].status="sending";try{let r;try{A.chat.sendPrivateMessage?r=yield A.chat.sendPrivateMessage({receiverId:u.value,content:o.content}):(a("warn","at pages/chat/chat.vue:544","æ²¡æœ‰æ‰¾åˆ°å‘é€ç§èŠæ¶ˆæ¯APIï¼Œæ¨¡æ‹Ÿå‘é€æˆåŠŸ"),yield new Promise((e=>setTimeout(e,500))),r={id:"msg-"+Date.now(),status:"sent"}),m.value[t].status="sent",r&&(r.id||r._id)&&(m.value[t].id=r.id||r._id);const s=b();s&&Lt.savePrivateMessages(m.value,s),Lt.removePendingMessage(e)}catch(s){throw s}}catch(r){a("error","at pages/chat/chat.vue:572","é‡è¯•å‘é€æ¶ˆæ¯å¤±è´¥:",r),m.value[t].status="failed";const e=b();e&&Lt.savePrivateMessages(m.value,e),uni.showToast({title:"å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ",icon:"none"})}})),M=()=>__async(this,null,(function*(){if(u.value&&l.value)if(A.chat.markMessagesAsRead)try{yield A.chat.markMessagesAsRead(u.value),a("log","at pages/chat/chat.vue:598","æ ‡è®°æ¶ˆæ¯å·²è¯»æˆåŠŸ")}catch(e){a("error","at pages/chat/chat.vue:600","æ ‡è®°æ¶ˆæ¯å·²è¯»å¤±è´¥:",e)}else a("log","at pages/chat/chat.vue:603","æ²¡æœ‰æ‰¾åˆ°æ ‡è®°æ¶ˆæ¯å·²è¯»API")})),D=()=>__async(this,null,(function*(){if(u.value)try{if(A.user.checkUserOnline){const e=yield A.user.checkUserOnline(u.value);d.value=(null==e?void 0:e.isOnline)||!1}else d.value=Math.random()>.5}catch(e){a("error","at pages/chat/chat.vue:621","æ£€æŸ¥ç”¨æˆ·åœ¨çº¿çŠ¶æ€å¤±è´¥:",e),d.value=!1}})),B=()=>{h.value=Math.random(),e.nextTick((()=>{uni.createSelectorQuery().in(this).select(".message-list").boundingClientRect((e=>{e&&(h.value=99999)})).exec()}))},U=()=>{C&&(clearInterval(C),C=null),C=setInterval((()=>{V.value&&N.value.isConnected&&(a("log","at pages/chat/chat.vue:663","è‡ªåŠ¨åˆ·æ–°æ¶ˆæ¯"),x(!0))}),15e3)};return n((e=>{u.value=e.userId||(uni.getLaunchOptionsSync().query||{}).userId||"",u.value?(At.addListener((e=>{N.value=e,a("log","at pages/chat/chat.vue:166","ç½‘ç»œçŠ¶æ€æ›´æ–°:",e),e.isConnected&&V.value&&(a("log","at pages/chat/chat.vue:170","ç½‘ç»œæ¢å¤ï¼Œåˆ·æ–°æ¶ˆæ¯"),x(!0))})),P(),(()=>{const e=Lt.getPendingMessages();e&&e.length>0&&(a("log","at pages/chat/chat.vue:673","æ¢å¤å¾…å¤„ç†ç§èŠæ¶ˆæ¯"),e.forEach((e=>{"private"===e.type&&e.data.receiverId===u.value&&(-1===m.value.findIndex((t=>t.id===e.id))&&m.value.push({id:e.id,content:e.content,createTime:e.createTime,senderId:l.value,receiverId:u.value,status:e.status}),"sending"!==e.status&&"failed"!==e.status||T(e.id))})))})(),x(!0),U(),_=setInterval(D,3e4)):(uni.showToast({title:"ç”¨æˆ·IDä¸èƒ½ä¸ºç©º",icon:"none"}),setTimeout((()=>{uni.navigateBack()}),1500))})),s((()=>{V.value=!0,D(),M(),w.value&&N.value.isConnected&&(x(!0),w.value=!1),U()})),r((()=>{V.value=!1,C&&(clearInterval(C),C=null)})),i((()=>{_&&(clearInterval(_),_=null),C&&(clearInterval(C),C=null)})),{chatUser:c,isOnline:d,messages:m,isLoading:p,isRefreshing:g,noMoreMessages:v,scrollTop:h,messageList:f,newMessage:k,inputFocus:E,userInfo:o,userId:l,loadMoreMessages:I,sendMessage:()=>__async(this,null,(function*(){if(!k.value.trim()||!u.value||!l.value)return;if(!N.value.isConnected)return void uni.showToast({title:"ç½‘ç»œä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥",icon:"none"});const t=k.value.trim();k.value="";const o="temp-"+Date.now(),s={id:o,content:t,createTime:(new Date).getTime(),senderId:l.value,receiverId:u.value,status:"sending"};m.value.push(s);const r=b();r&&Lt.savePrivateMessages(m.value,r),yield e.nextTick(),B();try{let e;try{A.chat.sendPrivateMessage?e=yield A.chat.sendPrivateMessage({receiverId:u.value,content:t}):(a("warn","at pages/chat/chat.vue:464","æ²¡æœ‰æ‰¾åˆ°å‘é€ç§èŠæ¶ˆæ¯APIï¼Œæ¨¡æ‹Ÿå‘é€æˆåŠŸ"),yield new Promise((e=>setTimeout(e,500))),e={id:"msg-"+Date.now(),status:"sent"});const s=m.value.findIndex((e=>e.id===o));-1!==s&&(m.value[s].status="sent",e&&(e.id||e._id)&&(m.value[s].id=e.id||e._id||o),r&&Lt.savePrivateMessages(m.value,r))}catch(n){throw n}}catch(i){a("error","at pages/chat/chat.vue:491","å‘é€æ¶ˆæ¯å¤±è´¥:",i);const e=m.value.findIndex((e=>e.id===o));-1!==e&&(m.value[e].status="failed",r&&Lt.savePrivateMessages(m.value,r)),Lt.savePendingMessage(__spreadProps(__spreadValues({},s),{type:"private",data:{receiverId:u.value,content:t}})),uni.showToast({title:"å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ",icon:"none"})}})),retryMessage:T,backToList:()=>{uni.navigateBack()},shouldShowDate:(e,t)=>{if(0===t)return!0;const a=m.value[t-1],o=new Date(a.createTime),s=new Date(e.createTime);return s-o>18e5||o.toDateString()!==s.toDateString()},formatDate:e=>{if(!e)return"";const t=new Date(e),a=new Date;if(t.toDateString()===a.toDateString())return"ä»Šå¤© "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0");const o=new Date;if(o.setDate(o.getDate()-1),t.toDateString()===o.toDateString())return"æ˜¨å¤© "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0");const s=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];return Math.floor((a-t)/864e5)<7?"æ˜ŸæœŸ"+s[t.getDay()]+" "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0"):t.getFullYear()!==a.getFullYear()?t.getFullYear()+"å¹´"+(t.getMonth()+1)+"æœˆ"+t.getDate()+"æ—¥ "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0"):t.getMonth()+1+"æœˆ"+t.getDate()+"æ—¥ "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0")},formatAvatarUrl:e=>{if(!e)return"/static/images/default-avatar.png";if(e.startsWith("http")||e.startsWith("/static"))return e;if(e.startsWith("/uploads")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}return"/static/images/default-avatar.png"},onScrollToUpper:()=>{p.value||v.value||I()}}}},[["render",function(t,a,o,s,r,n){return e.openBlock(),e.createElementBlock("view",{class:"container"},[e.createCommentVNode(" å¤´éƒ¨å¯¼èˆª "),e.createElementVNode("view",{class:"header"},[e.createElementVNode("view",{class:"back",onClick:a[0]||(a[0]=(...e)=>s.backToList&&s.backToList(...e))},[e.createElementVNode("text",{class:"back-icon"},"â†")]),e.createElementVNode("view",{class:"user-info"},[e.createElementVNode("text",{class:"username"},e.toDisplayString(s.chatUser.nickname||s.chatUser.username||"ç”¨æˆ·"),1),s.isOnline?(e.openBlock(),e.createElementBlock("text",{key:0,class:"status"},"åœ¨çº¿")):e.createCommentVNode("v-if",!0)]),e.createElementVNode("view",{class:"action"},[e.createElementVNode("text",{class:"more-icon"},"â‹®")])]),e.createCommentVNode(" æ¶ˆæ¯åˆ—è¡¨ "),e.createElementVNode("scroll-view",{class:"message-list","scroll-y":"true","scroll-top":s.scrollTop,"scroll-with-animation":!0,"refresher-triggered":s.isRefreshing,"refresher-enabled":"",onRefresherrefresh:a[1]||(a[1]=(...e)=>s.loadMoreMessages&&s.loadMoreMessages(...e)),onScrolltoupper:a[2]||(a[2]=(...e)=>s.onScrollToUpper&&s.onScrollToUpper(...e)),ref:"messageList"},[s.isLoading&&s.messages.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"refresh-tip"},[e.createElementVNode("text",null,"åŠ è½½æ›´å¤šæ¶ˆæ¯...")])):e.createCommentVNode("v-if",!0),e.createElementVNode("view",{class:"messages-container"},[e.createCommentVNode(" æ²¡æœ‰æ›´å¤šæ¶ˆæ¯æç¤º "),s.noMoreMessages&&s.messages.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"no-more"},[e.createElementVNode("text",null,"æ²¡æœ‰æ›´å¤šæ¶ˆæ¯äº†")])):e.createCommentVNode("v-if",!0),e.createCommentVNode(" æ¶ˆæ¯é¡¹ "),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.messages,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:t.id||a,class:e.normalizeClass(["message-item",{"own-message":t.senderId===s.userId}])},[e.createCommentVNode(" æ—¥æœŸåˆ†éš”çº¿ "),s.shouldShowDate(t,a)?(e.openBlock(),e.createElementBlock("view",{key:0,class:"date-divider"},[e.createElementVNode("text",null,e.toDisplayString(s.formatDate(t.createTime)),1)])):e.createCommentVNode("v-if",!0),e.createElementVNode("view",{class:"message-content"},[e.createCommentVNode(" å¯¹æ–¹å¤´åƒ "),t.senderId!==s.userId?(e.openBlock(),e.createElementBlock("image",{key:0,class:"avatar",src:s.formatAvatarUrl(s.chatUser.avatar),mode:"aspectFill"},null,8,["src"])):(e.openBlock(),e.createElementBlock(e.Fragment,{key:1},[e.createCommentVNode(" ç©ºç™½å ä½ï¼Œè®©è‡ªå·±çš„æ¶ˆæ¯é å³ "),e.createElementVNode("view",{class:"avatar-placeholder"})],2112)),e.createCommentVNode(" æ¶ˆæ¯æ°”æ³¡ "),e.createElementVNode("view",{class:e.normalizeClass(["bubble",{"own-bubble":t.senderId===s.userId}])},[e.createElementVNode("text",{class:"message-text"},e.toDisplayString(t.content),1)],2),e.createCommentVNode(" è‡ªå·±çš„å¤´åƒ "),t.senderId===s.userId?(e.openBlock(),e.createElementBlock("image",{key:2,class:"avatar",src:s.formatAvatarUrl(s.userInfo.avatar),mode:"aspectFill"},null,8,["src"])):(e.openBlock(),e.createElementBlock(e.Fragment,{key:3},[e.createCommentVNode(" ç©ºç™½å ä½ï¼Œè®©å¯¹æ–¹æ¶ˆæ¯é å·¦ "),e.createElementVNode("view",{class:"avatar-placeholder"})],2112))])],2)))),128))]),e.createCommentVNode(" ç©ºæ¶ˆæ¯çŠ¶æ€ "),0!==s.messages.length||s.isLoading?e.createCommentVNode("v-if",!0):(e.openBlock(),e.createElementBlock("view",{key:1,class:"empty-state"},[e.createElementVNode("image",{class:"empty-icon",src:$t,mode:"aspectFit"}),e.createElementVNode("text",{class:"empty-text"},"æš‚æ— æ¶ˆæ¯"),e.createElementVNode("text",{class:"empty-tip"},"å‘é€æ¶ˆæ¯å¼€å§‹èŠå¤©å§")]))],40,["scroll-top","refresher-triggered"]),e.createCommentVNode(" è¾“å…¥åŒºåŸŸ "),e.createElementVNode("view",{class:"input-area"},[e.withDirectives(e.createElementVNode("input",{type:"text",class:"message-input","onUpdate:modelValue":a[3]||(a[3]=e=>s.newMessage=e),placeholder:"è¾“å…¥æ¶ˆæ¯...",focus:s.inputFocus,"confirm-type":"send",onConfirm:a[4]||(a[4]=(...e)=>s.sendMessage&&s.sendMessage(...e))},null,40,["focus"]),[[e.vModelText,s.newMessage]]),e.createElementVNode("view",{class:e.normalizeClass(["send-btn",{active:s.newMessage.trim()}]),onClick:a[5]||(a[5]=(...e)=>s.sendMessage&&s.sendMessage(...e))},[e.createElementVNode("text",null,"å‘é€")],2)])])}],["__file","D:/caloriesH5/CloudStorage/pages/chat/chat.vue"]]);const Rt=ze({setup(){const t=Re(),o=qe(),l=e.computed((()=>t.user||{})),c=e.computed((()=>l.value.id||l.value._id||"")),u=e.ref("nearby"),d=e.ref({isConnected:!0,networkType:"unknown"}),m=e.reactive({latitude:null,longitude:null,address:"",city:"",district:"",lastUpdated:null}),p=e.ref([]),g=e.ref([]),v=e.ref(0),h=e.ref(0),f=e.ref(!1),y=e.ref(!1),w=e.ref(!1),k=e.ref(!1),E=e.ref(""),N=e.ref(!1),V=e.ref(!0),S=e.ref(1),_=e.ref(1);let C=null;const b=e.ref(!0),P=e.ref({atBottom:!0}),x=e.ref({atBottom:!0}),I=()=>__async(this,null,(function*(){try{a("log","at pages/chat/index.vue:317","å¼€å§‹åˆå§‹åŒ–ä½ç½®ä¿¡æ¯");const e=o.location;e&&e.latitude&&e.longitude&&(a("log","at pages/chat/index.vue:321","ä»storeè·å–åˆ°ä½ç½®ä¿¡æ¯:",e),m.latitude=e.latitude,m.longitude=e.longitude,m.address=e.address||"",m.city=e.city||"",m.district=e.district||"",m.lastUpdated=e.lastUpdated||Date.now(),a("log","at pages/chat/index.vue:329","æˆåŠŸè®¾ç½®ä½ç½®ä¿¡æ¯åˆ°currentLocation:",m));const t=6e5;!m.latitude||!m.longitude||!m.lastUpdated||Date.now()-m.lastUpdated>t?(a("log","at pages/chat/index.vue:337","ä½ç½®ä¿¡æ¯ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸï¼Œé‡æ–°è·å–"),yield T()):(a("log","at pages/chat/index.vue:341","ä½¿ç”¨ç°æœ‰ä½ç½®ä¿¡æ¯åŠ è½½æ¶ˆæ¯"),yield M(),O(),setTimeout((()=>{O()}),500))}catch(e){a("error","at pages/chat/index.vue:353","åˆå§‹åŒ–ä½ç½®ä¿¡æ¯å¤±è´¥:",e),uni.showToast({title:"è·å–ä½ç½®ä¿¡æ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥å®šä½æƒé™",icon:"none"})}})),T=()=>__async(this,null,(function*(){try{uni.showLoading({title:"è·å–ä½ç½®ä¸­...",mask:!1}),a("log","at pages/chat/index.vue:369","å¼€å§‹è·å–ä½ç½®");const t=yield Ze();a("log","at pages/chat/index.vue:371","è·å–åˆ°ä½ç½®:",t),t&&t.latitude&&t.longitude?(m.latitude=t.latitude,m.longitude=t.longitude,m.address=t.address||"",m.city=t.city||"",m.district=t.district||"",m.lastUpdated=Date.now(),o.updateLocation({latitude:t.latitude,longitude:t.longitude,address:t.address,city:t.city,district:t.district,lastUpdated:Date.now(),timestamp:(new Date).toISOString()}),a("log","at pages/chat/index.vue:393","ä½ç½®è·å–æˆåŠŸï¼Œåˆ·æ–°æ¶ˆæ¯ï¼Œå½“å‰ä½ç½®:",m),uni.hideLoading(),yield e.nextTick(),M()):(a("error","at pages/chat/index.vue:398","è·å–åˆ°çš„ä½ç½®æ•°æ®ä¸å®Œæ•´:",t),uni.hideLoading(),uni.showToast({title:"è·å–ä½ç½®ä¿¡æ¯ä¸å®Œæ•´ï¼Œè¯·æ£€æŸ¥å®šä½æƒé™",icon:"none",duration:2e3}))}catch(t){a("error","at pages/chat/index.vue:407","åˆ·æ–°ä½ç½®ä¿¡æ¯å¤±è´¥:",t),uni.hideLoading(),uni.showToast({title:"è·å–ä½ç½®ä¿¡æ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥å®šä½æƒé™",icon:"none"})}})),M=()=>__async(this,null,(function*(){if(a("log","at pages/chat/index.vue:418","refreshMessagesè¢«è°ƒç”¨ï¼Œå½“å‰æ ‡ç­¾:",u.value),a("log","at pages/chat/index.vue:419","å½“å‰ä½ç½®ä¿¡æ¯:",m),!m.latitude||!m.longitude)return a("warn","at pages/chat/index.vue:423","åˆ·æ–°æ¶ˆæ¯å¤±è´¥ï¼šä½ç½®ä¿¡æ¯ä¸å­˜åœ¨"),void uni.showToast({title:"æ— æ³•è·å–ä½ç½®ä¿¡æ¯ï¼Œè¯·ç‚¹å‡»åˆ·æ–°æŒ‰é’®",icon:"none"});try{uni.showLoading({title:"åŠ è½½ä¸­...",mask:!1}),"nearby"===u.value?(a("log","at pages/chat/index.vue:439","å¼€å§‹åˆ·æ–°é™„è¿‘æ¶ˆæ¯"),yield D(!0)):(a("log","at pages/chat/index.vue:442","å¼€å§‹åˆ·æ–°åŸå¸‚æ¶ˆæ¯"),yield B(!0)),uni.hideLoading(),a("log","at pages/chat/index.vue:449","æ¶ˆæ¯åˆ·æ–°å®Œæˆ"),setTimeout((()=>{"nearby"===u.value?v.value=999999:h.value=999999}),100),setTimeout((()=>{"nearby"===u.value?v.value=999999:h.value=999999}),300)}catch(e){uni.hideLoading(),a("error","at pages/chat/index.vue:470","åˆ·æ–°æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯:",e),uni.showToast({title:"åŠ è½½æ¶ˆæ¯å¤±è´¥ï¼Œè¯·ç¨åå†è¯•",icon:"none"})}})),D=(t=!1)=>__async(this,null,(function*(){if(!m.latitude||!m.longitude){a("log","at pages/chat/index.vue:481","ä½ç½®ä¿¡æ¯ä¸å­˜åœ¨ï¼Œå°è¯•ä»storeè·å–");const e=o.location;if(!(e&&e.latitude&&e.longitude))return a("log","at pages/chat/index.vue:493","æ— æ³•è·å–ä½ç½®ä¿¡æ¯ï¼Œæ˜¾ç¤ºæç¤º"),void uni.showToast({title:"æ— æ³•è·å–ä½ç½®ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥å®šä½æƒé™",icon:"none"});m.latitude=e.latitude,m.longitude=e.longitude,m.address=e.address||"",m.city=e.city||"",m.district=e.district||"",m.lastUpdated=e.lastUpdated||Date.now(),a("log","at pages/chat/index.vue:491","æˆåŠŸä»storeè·å–ä½ç½®ä¿¡æ¯:",m)}if(!y.value||t)try{y.value=!0,t&&(S.value=1,w.value=!1);const o={latitude:m.latitude,longitude:m.longitude,radius:5e3,page:1,limit:30,sort:"desc"};t||(o.page=S.value),a("log","at pages/chat/index.vue:531","åŠ è½½é™„è¿‘æ¶ˆæ¯, å‚æ•°:",o);const s=yield A.chat.getNearbyMessages(o);a("log","at pages/chat/index.vue:535","APIç›´æ¥è¿”å›çš„é™„è¿‘æ¶ˆæ¯:",s);let r=[];if(s&&s.data?r=s.data:Array.isArray(s)&&(r=s),r.sort(((e,t)=>new Date(e.createTime)-new Date(t.createTime))),a("log","at pages/chat/index.vue:550","å¤„ç†åçš„æ¶ˆæ¯æ•°æ®:",r),r&&r.length>0)t?(p.value=[...r],a("log","at pages/chat/index.vue:557","åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨ï¼Œå½“å‰æ¶ˆæ¯æ•°:",p.value.length),yield e.nextTick(),U(!0)):(p.value=[...r,...p.value],a("log","at pages/chat/index.vue:565","è¿½åŠ å†å²æ¶ˆæ¯ï¼Œå½“å‰æ¶ˆæ¯æ•°:",p.value.length)),Lt.saveNearbyMessagesCache(p.value),S.value++;else if(t||(w.value=!0,a("log","at pages/chat/index.vue:577","æ²¡æœ‰æ›´å¤šæ¶ˆæ¯")),t&&(!r||0===r.length)){const e=Lt.getNearbyMessagesCache();e&&e.length>0&&(a("log","at pages/chat/index.vue:584","ä»ç¼“å­˜åŠ è½½é™„è¿‘æ¶ˆæ¯"),e.sort(((e,t)=>new Date(e.createTime)-new Date(t.createTime))),p.value=e)}}catch(s){if(a("error","at pages/chat/index.vue:592","åŠ è½½é™„è¿‘æ¶ˆæ¯å¤±è´¥:",s),At.isNetworkError&&At.isNetworkError(s)){const e=Lt.getNearbyMessagesCache();e&&e.length>0&&(a("log","at pages/chat/index.vue:598","ç½‘ç»œé”™è¯¯ï¼Œä»ç¼“å­˜åŠ è½½é™„è¿‘æ¶ˆæ¯"),(t||0===p.value.length)&&(p.value=e))}uni.showToast({title:"åŠ è½½æ¶ˆæ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥",icon:"none"})}finally{y.value=!1}else a("log","at pages/chat/index.vue:503","å·²æœ‰åŠ è½½è¯·æ±‚è¿›è¡Œä¸­ï¼Œè·³è¿‡")})),B=(t=!1)=>__async(this,null,(function*(){if(!m.city){if(a("log","at pages/chat/index.vue:620","åŸå¸‚ä¿¡æ¯ä¸å­˜åœ¨ï¼Œå°è¯•ä»åœ°å€ä¸­æå–"),m.address){const e=m.address.split("å¸‚");if(e.length>0){const t=e[0].match(/([^çœ]+?)å¸‚/);if(t&&t[1])m.city=t[1],a("log","at pages/chat/index.vue:630","ä»åœ°å€ä¸­æå–çš„åŸå¸‚:",m.city);else{const e=m.address.split(/[çœå¸‚åŒºå¿]/);e.length>1&&(m.city=e[1].trim(),a("log","at pages/chat/index.vue:636","ä»åœ°å€åˆ†å‰²ä¸­æå–çš„åŸå¸‚:",m.city))}}}if(!m.city&&m.latitude&&m.longitude){a("log","at pages/chat/index.vue:644","ä»ç»çº¬åº¦åæŸ¥åŸå¸‚ä¿¡æ¯");try{const e=yield Ze();e&&e.city?(m.city=e.city,a("log","at pages/chat/index.vue:650","ä»getCurrentLocationè·å–åˆ°åŸå¸‚:",m.city)):(m.city="ä¸Šæµ·å¸‚",a("log","at pages/chat/index.vue:654","æ— æ³•è·å–åŸå¸‚ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤åŸå¸‚"))}catch(s){a("error","at pages/chat/index.vue:657","åæŸ¥åŸå¸‚å‡ºé”™:",s),m.city="ä¸Šæµ·å¸‚"}}m.city||(a("log","at pages/chat/index.vue:664","æ— æ³•è·å–åŸå¸‚ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤åŸå¸‚"),m.city="ä¸Šæµ·å¸‚"),m.latitude&&m.longitude?o.updateLocation(__spreadProps(__spreadValues({},o.location),{city:m.city,latitude:m.latitude,longitude:m.longitude,timestamp:(new Date).toISOString()})):a("log","at pages/chat/index.vue:678","æ— æ³•æ›´æ–°ä½ç½®storeï¼šç¼ºå°‘ç»çº¬åº¦ä¿¡æ¯")}if(!y.value||t)try{y.value=!0,t&&(_.value=1,k.value=!1);const o={cityName:m.city,page:1,limit:30,sort:"desc"};t||(o.page=_.value),a("log","at pages/chat/index.vue:709","åŠ è½½åŸå¸‚æ¶ˆæ¯, å‚æ•°:",o);const s=yield A.chat.getCityMessages(o);a("log","at pages/chat/index.vue:713","APIç›´æ¥è¿”å›çš„åŸå¸‚æ¶ˆæ¯:",s);let r=[];if(s&&s.data?r=s.data:Array.isArray(s)&&(r=s),r.sort(((e,t)=>new Date(e.createTime)-new Date(t.createTime))),a("log","at pages/chat/index.vue:728","å¤„ç†åçš„åŸå¸‚æ¶ˆæ¯æ•°æ®:",r),r&&r.length>0)t?(g.value=[...r],a("log","at pages/chat/index.vue:735","åˆ·æ–°åŸå¸‚æ¶ˆæ¯åˆ—è¡¨ï¼Œå½“å‰æ¶ˆæ¯æ•°:",g.value.length),yield e.nextTick(),U(!0)):(g.value=[...r,...g.value],a("log","at pages/chat/index.vue:743","è¿½åŠ å†å²åŸå¸‚æ¶ˆæ¯ï¼Œå½“å‰æ¶ˆæ¯æ•°:",g.value.length)),Lt.saveCityMessagesCache(g.value,m.city),_.value++;else if(t||(k.value=!0,a("log","at pages/chat/index.vue:755","æ²¡æœ‰æ›´å¤šåŸå¸‚æ¶ˆæ¯")),t&&(!r||0===r.length)){const e=Lt.getCityMessagesCache(m.city);e&&e.length>0&&(a("log","at pages/chat/index.vue:762","ä»ç¼“å­˜åŠ è½½åŸå¸‚æ¶ˆæ¯"),g.value=e)}}catch(s){if(a("error","at pages/chat/index.vue:768","åŠ è½½åŸå¸‚æ¶ˆæ¯å¤±è´¥:",s),At.isNetworkError&&At.isNetworkError(s)){const e=Lt.getCityMessagesCache(m.city);e&&e.length>0&&(a("log","at pages/chat/index.vue:774","ç½‘ç»œé”™è¯¯ï¼Œä»ç¼“å­˜åŠ è½½åŸå¸‚æ¶ˆæ¯"),(t||0===g.value.length)&&(g.value=e))}uni.showToast({title:"åŠ è½½æ¶ˆæ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥",icon:"none"})}finally{y.value=!1}else a("log","at pages/chat/index.vue:683","å·²æœ‰åŠ è½½è¯·æ±‚è¿›è¡Œä¸­ï¼Œè·³è¿‡")})),U=(e=!1)=>{a("log","at pages/chat/index.vue:871","æ‰§è¡Œæ»šåŠ¨åˆ°åº•éƒ¨, å¼ºåˆ¶æ»šåŠ¨:",e),setTimeout((()=>{try{"nearby"===u.value?v.value=999999:h.value=999999,"nearby"===u.value?P.value.atBottom=!0:x.value.atBottom=!0,a("log","at pages/chat/index.vue:892","è®¾ç½®scrollTopä»¥æ»šåŠ¨åˆ°åº•éƒ¨")}catch(e){a("error","at pages/chat/index.vue:894","æ»šåŠ¨åˆ°åº•éƒ¨å‡ºé”™:",e)}}),50)},j=()=>{C&&(clearInterval(C),C=null),C=setInterval((()=>{if(V.value&&d.value.isConnected){a("log","at pages/chat/index.vue:942","è‡ªåŠ¨åˆ·æ–°æ¶ˆæ¯");("nearby"===u.value?P.value.atBottom:x.value.atBottom)?F():a("log","at pages/chat/index.vue:954","ç”¨æˆ·æ­£åœ¨æŸ¥çœ‹å†å²æ¶ˆæ¯ï¼Œè·³è¿‡è‡ªåŠ¨åˆ·æ–°")}}),6e4)},F=()=>__async(this,null,(function*(){if(a("log","at pages/chat/index.vue:962","é™é»˜åˆ·æ–°æ¶ˆæ¯"),m.latitude&&m.longitude)try{const t="nearby"===u.value?p.value.length:g.value.length;"nearby"===u.value?yield L():yield $();if(("nearby"===u.value?p.value.length:g.value.length)>t){("nearby"===u.value?P.value.atBottom:x.value.atBottom)?(a("log","at pages/chat/index.vue:996","æ£€æµ‹åˆ°æ–°æ¶ˆæ¯ä¸”ç”¨æˆ·åœ¨åº•éƒ¨ï¼Œæ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯"),yield e.nextTick(),U(!0)):a("log","at pages/chat/index.vue:1000","æœ‰æ–°æ¶ˆæ¯ä½†ç”¨æˆ·ä¸åœ¨åº•éƒ¨ï¼Œä¸è‡ªåŠ¨æ»šåŠ¨")}}catch(t){a("error","at pages/chat/index.vue:1004","é™é»˜åˆ·æ–°æ¶ˆæ¯å¤±è´¥:",t)}else a("warn","at pages/chat/index.vue:966","åˆ·æ–°æ¶ˆæ¯å¤±è´¥ï¼šä½ç½®ä¿¡æ¯ä¸å­˜åœ¨")})),L=()=>__async(this,null,(function*(){try{const e={latitude:m.latitude,longitude:m.longitude,radius:5e3,page:1,limit:30,sort:"desc"};a("log","at pages/chat/index.vue:1021","é™é»˜åŠ è½½é™„è¿‘æ¶ˆæ¯, å‚æ•°:",e);const t=yield A.chat.getNearbyMessages(e);let o=[];if(t&&t.data?o=t.data:Array.isArray(t)&&(o=t),o.sort(((e,t)=>new Date(e.createTime)-new Date(t.createTime))),o&&o.length>0){const e=p.value.map((e=>e.id)),t=o.filter((t=>!e.includes(t.id)));if(t.length>0)return p.value=[...p.value,...t],p.value.length>50&&(p.value=p.value.slice(-50)),Lt.saveNearbyMessagesCache(p.value),!0}return!1}catch(e){return a("error","at pages/chat/index.vue:1060","é™é»˜åŠ è½½é™„è¿‘æ¶ˆæ¯å¤±è´¥:",e),!1}})),$=()=>__async(this,null,(function*(){try{const e={cityName:m.city,page:1,limit:30,sort:"desc"};a("log","at pages/chat/index.vue:1076","é™é»˜åŠ è½½åŸå¸‚æ¶ˆæ¯, å‚æ•°:",e);const t=yield A.chat.getCityMessages(e);let o=[];if(t&&t.data?o=t.data:Array.isArray(t)&&(o=t),o.sort(((e,t)=>new Date(e.createTime)-new Date(t.createTime))),o&&o.length>0){const e=g.value.map((e=>e.id)),t=o.filter((t=>!e.includes(t.id)));if(t.length>0)return g.value=[...g.value,...t],g.value.length>50&&(g.value=g.value.slice(-50)),Lt.saveCityMessagesCache(g.value,m.city),!0}return!1}catch(e){return a("error","at pages/chat/index.vue:1115","é™é»˜åŠ è½½åŸå¸‚æ¶ˆæ¯å¤±è´¥:",e),!1}}));e.watch(u,(e=>{a("log","at pages/chat/index.vue:1122","æ ‡ç­¾åˆ‡æ¢åˆ°:",e),"nearby"===e?0===p.value.length?D(!0):setTimeout((()=>{U(!0)}),100):"city"===e&&(0===g.value.length?B(!0):setTimeout((()=>{U(!0)}),100))}));const O=()=>{a("log","at pages/chat/index.vue:1427","å¼ºåˆ¶æ‰§è¡Œæ»šåŠ¨åˆ°åº•éƒ¨"),setTimeout((()=>{try{"nearby"===u.value?(v.value=99999999,a("log","at pages/chat/index.vue:1435","å¼ºåˆ¶è®¾ç½®é™„è¿‘æ¶ˆæ¯scrollTop:",v.value),P.value.atBottom=!0):(h.value=99999999,a("log","at pages/chat/index.vue:1439","å¼ºåˆ¶è®¾ç½®åŸå¸‚æ¶ˆæ¯scrollTop:",h.value),x.value.atBottom=!0)}catch(e){a("error","at pages/chat/index.vue:1443","forceScrollToBottomå‡ºé”™:",e),"nearby"===u.value?v.value=99999999:h.value=99999999}}),50)};return n((()=>__async(this,null,(function*(){a("log","at pages/chat/index.vue:1456","èŠå¤©é¡µé¢åŠ è½½"),At.addListener((e=>{d.value=e,a("log","at pages/chat/index.vue:263","ç½‘ç»œçŠ¶æ€æ›´æ–°:",e),e.isConnected&&V.value&&(a("log","at pages/chat/index.vue:267","ç½‘ç»œæ¢å¤ï¼Œåˆ·æ–°æ¶ˆæ¯"),M())})),uni.$on("network:reconnected",(()=>{V.value&&(a("log","at pages/chat/index.vue:275","ç½‘ç»œæ¢å¤äº‹ä»¶ï¼Œåˆ·æ–°æ¶ˆæ¯"),M())})),uni.$on("chat:message-status-update",(({messageId:e,status:t,serverData:o})=>{a("log","at pages/chat/index.vue:284","æ”¶åˆ°æ¶ˆæ¯çŠ¶æ€æ›´æ–°:",e,t);const s=a=>{const s=a.findIndex((t=>t.id===e));return-1!==s&&(a[s].status=t,o&&(a[s].id=o.id||o._id||a[s].id,a[s].serverTime=o.createdAt||o.createTime),!0)},r=s(p.value),n=s(g.value);(r||n)&&a("log","at pages/chat/index.vue:309","å·²æ›´æ–°æ¶ˆæ¯çŠ¶æ€")})),Lt.clearExpiredMessageCaches(),(()=>{const e=Lt.getPendingMessages();e&&e.length>0&&(a("log","at pages/chat/index.vue:1149","æ¢å¤å¾…å¤„ç†æ¶ˆæ¯:",e.length),e.forEach((e=>{"nearby"===e.type?(-1===p.value.findIndex((t=>t.id===e.id))&&p.value.push({id:e.id,content:e.content,userId:e.userId,userName:e.userName,userAvatar:e.userAvatar,createTime:e.createTime,status:e.status,distance:0,isOwnMessage:!0}),"sending"!==e.status&&"failed"!==e.status||Dt.sendNearbyMessage(e.data)):"city"===e.type&&(-1===g.value.findIndex((t=>t.id===e.id))&&g.value.push({id:e.id,content:e.content,userId:e.userId,userName:e.userName,userAvatar:e.userAvatar,createTime:e.createTime,status:e.status,isOwnMessage:!0}),"sending"!==e.status&&"failed"!==e.status||Dt.sendCityMessage(e.data))})))})(),j(),a("log","at pages/chat/index.vue:1474","å¼€å§‹åˆå§‹åŒ–ä½ç½®å’ŒåŠ è½½æ¶ˆæ¯");try{yield I(),a("log","at pages/chat/index.vue:1478","åˆå§‹åŒ–ä½ç½®å’ŒåŠ è½½æ¶ˆæ¯å®Œæˆ"),setTimeout((()=>{"nearby"===u.value?v.value=999999:h.value=999999}),300),setTimeout((()=>{"nearby"===u.value?v.value=999999:h.value=999999}),800)}catch(e){a("error","at pages/chat/index.vue:1497","åˆå§‹åŒ–ä½ç½®å’ŒåŠ è½½æ¶ˆæ¯å¤±è´¥:",e),M(),setTimeout((()=>{O()}),800)}})))),s((()=>{V.value=!0,I(),d.value.isConnected&&M(),j(),setTimeout((()=>{"nearby"===u.value?(v.value=999999,P.value.atBottom=!0):(h.value=999999,x.value.atBottom=!0)}),300),setTimeout((()=>{"nearby"===u.value?v.value=999999:h.value=999999}),600)})),r((()=>{V.value=!1,C&&(clearInterval(C),C=null)})),i((()=>{C&&(clearInterval(C),C=null),uni.$off("chat:message-status-update"),uni.$off("network:reconnected")})),{activeTab:u,currentLocation:m,networkStatus:d,nearbyMessages:p,cityMessages:g,scrollTop:v,cityScrollTop:h,showBackToBottom:f,isLoading:y,noMoreNearbyMessages:w,noMoreCityMessages:k,newMessage:E,inputFocus:N,userInfo:l,userId:c,refreshLocation:T,loadMoreNearbyMessages:()=>{if(w.value||y.value)return;const e=p.value.length;D().then((()=>{const t=p.value.length-e;t>0&&setTimeout((()=>{uni.createSelectorQuery().selectAll(".message-item").boundingClientRect((e=>{if(e&&e.length>0){let a=0;for(let o=0;o<Math.min(t,e.length);o++)a+=e[o].height;"nearby"===u.value&&(v.value+=a)}})).exec()}),100)}))},loadMoreCityMessages:()=>{if(k.value||y.value)return;const e=g.value.length;B().then((()=>{const t=g.value.length-e;t>0&&setTimeout((()=>{uni.createSelectorQuery().selectAll(".message-item").boundingClientRect((e=>{if(e&&e.length>0){let a=0;for(let o=0;o<Math.min(t,e.length);o++)a+=e[o].height;"city"===u.value&&(h.value+=a)}})).exec()}),100)}))},sendMessage:()=>__async(this,null,(function*(){if(!E.value.trim())return;if(!d.value.isConnected)return void uni.showToast({title:"ç½‘ç»œä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥",icon:"none"});if(!m.latitude||!m.longitude)return void uni.showToast({title:"ä½ç½®ä¿¡æ¯ä¸å­˜åœ¨ï¼Œæ— æ³•å‘é€æ¶ˆæ¯",icon:"none"});const t=E.value.trim();E.value="";const o={id:"temp-"+Date.now(),content:t,userId:c.value,userName:l.value.nickname||l.value.username||"æ¸¸å®¢",userAvatar:l.value.avatar||"/static/images/default-avatar.png",createTime:(new Date).getTime(),status:"sending",isOwnMessage:!0};if("nearby"===u.value){o.distance=0,p.value.push(o),Lt.savePendingMessage(__spreadProps(__spreadValues({},o),{type:"nearby",data:{content:t,latitude:m.latitude,longitude:m.longitude}}));try{yield Dt.sendNearbyMessage({content:t,latitude:m.latitude,longitude:m.longitude})}catch(s){a("error","at pages/chat/index.vue:1262","å‘é€é™„è¿‘æ¶ˆæ¯å¤±è´¥:",s)}}else{g.value.push(o),Lt.savePendingMessage(__spreadProps(__spreadValues({},o),{type:"city",data:{content:t,cityName:m.city,latitude:m.latitude,longitude:m.longitude}}));try{yield Dt.sendCityMessage({content:t,cityName:m.city,latitude:m.latitude,longitude:m.longitude})}catch(s){a("error","at pages/chat/index.vue:1290","å‘é€åŸå¸‚æ¶ˆæ¯å¤±è´¥:",s)}}a("log","at pages/chat/index.vue:1295","å‘é€æ¶ˆæ¯åï¼Œå¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨æ˜¾ç¤ºæ–°æ¶ˆæ¯"),yield e.nextTick(),"nearby"===u.value?(v.value=0,setTimeout((()=>{v.value=999999,P.value.atBottom=!0}),10)):(h.value=0,setTimeout((()=>{h.value=999999,x.value.atBottom=!0}),10)),setTimeout((()=>{"nearby"===u.value?v.value=999999:h.value=999999,a("log","at pages/chat/index.vue:1327","å‘é€æ¶ˆæ¯åï¼Œè®¾ç½®scrollTopå®Œæˆ")}),150)})),shouldShowDate:(e,t,a)=>{if(0===t)return!0;const o=a[t-1],s=new Date(o.createTime),r=new Date(e.createTime);return r-s>18e5||s.toDateString()!==r.toDateString()},formatDate:e=>{if(!e)return"";const t=new Date(e),a=new Date;if(t.toDateString()===a.toDateString())return"ä»Šå¤© "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0");const o=new Date;if(o.setDate(o.getDate()-1),t.toDateString()===o.toDateString())return"æ˜¨å¤© "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0");const s=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];return Math.floor((a-t)/864e5)<7?"æ˜ŸæœŸ"+s[t.getDay()]+" "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0"):t.getFullYear()!==a.getFullYear()?t.getFullYear()+"å¹´"+(t.getMonth()+1)+"æœˆ"+t.getDate()+"æ—¥ "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0"):t.getMonth()+1+"æœˆ"+t.getDate()+"æ—¥ "+t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0")},formatTime:e=>{if(!e)return"";const t=new Date(e);return t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0")},formatDistance:e=>null==e?"":e<1e3?e+"ç±³":(e/1e3).toFixed(1)+"å…¬é‡Œ",formatAvatarUrl:e=>{if(!e)return"/static/images/default-avatar.png";if(e.startsWith("http")||e.startsWith("/static"))return e;if(e.startsWith("/uploads")){return(uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000")+e}return"/static/images/default-avatar.png"},onScroll:e=>{const t=e.detail.scrollTop,a=e.detail.scrollHeight,o=e.detail.scrollHeight-e.detail.scrollTop,s=a-t-o<50;b.value=s,f.value=!s,"nearby"===u.value?P.value={scrollTop:t,scrollHeight:a,clientHeight:o,atBottom:s}:x.value={scrollTop:t,scrollHeight:a,clientHeight:o,atBottom:s}},scrollToBottom:U}}},[["render",function(t,a,o,s,r,n){return e.openBlock(),e.createElementBlock("view",{class:"container"},[e.createElementVNode("view",{class:"tab-container"},[e.createElementVNode("view",{class:e.normalizeClass(["tab",{active:"nearby"===s.activeTab}]),onClick:a[0]||(a[0]=e=>s.activeTab="nearby")},[e.createElementVNode("text",null,"é™„è¿‘ 5å…¬é‡Œ")],2),e.createElementVNode("view",{class:e.normalizeClass(["tab",{active:"city"===s.activeTab}]),onClick:a[1]||(a[1]=e=>s.activeTab="city")},[e.createElementVNode("text",null,"åŸå¸‚é¢‘é“")],2)]),e.createCommentVNode(" é™„è¿‘5å…¬é‡ŒèŠå¤©å†…å®¹ "),"nearby"===s.activeTab?(e.openBlock(),e.createElementBlock("view",{key:0,class:"content"},[e.createElementVNode("view",{class:"location-info"},[e.createElementVNode("text",{class:"location-text"},e.toDisplayString(s.currentLocation.address||"æ­£åœ¨è·å–ä½ç½®..."),1),e.createElementVNode("view",{class:"refresh-btn",onClick:a[2]||(a[2]=(...e)=>s.refreshLocation&&s.refreshLocation(...e))},[e.createElementVNode("text",{class:"refresh-icon"},"ğŸ”„")])]),e.createElementVNode("scroll-view",{class:"message-list nearby-message-list","scroll-y":"true","scroll-top":s.scrollTop,"scroll-with-animation":!0,"scroll-animation-duration":100,enhanced:!0,bounces:!1,"show-scrollbar":!1,onScrolltolower:a[3]||(a[3]=(...e)=>s.loadMoreNearbyMessages&&s.loadMoreNearbyMessages(...e)),onScroll:a[4]||(a[4]=(...e)=>s.onScroll&&s.onScroll(...e)),ref:"nearbyMessageList"},[e.createElementVNode("view",{class:"messages-container"},[e.createCommentVNode(" æ²¡æœ‰æ›´å¤šæ¶ˆæ¯æç¤º "),s.noMoreNearbyMessages&&s.nearbyMessages.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"no-more"},[e.createElementVNode("text",null,"æ²¡æœ‰æ›´å¤šæ¶ˆæ¯äº†")])):e.createCommentVNode("v-if",!0),e.createCommentVNode(" æ¶ˆæ¯é¡¹ "),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.nearbyMessages,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:t.id||a,class:"message-item",id:"nearby-msg-"+(t.id||a)},[e.createCommentVNode(" æ—¥æœŸåˆ†éš”çº¿ "),s.shouldShowDate(t,a,s.nearbyMessages)?(e.openBlock(),e.createElementBlock("view",{key:0,class:"date-divider"},[e.createElementVNode("text",null,e.toDisplayString(s.formatDate(t.createTime)),1)])):e.createCommentVNode("v-if",!0),e.createElementVNode("view",{class:"message-content"},[e.createCommentVNode(" ç”¨æˆ·å¤´åƒ "),e.createElementVNode("image",{class:"avatar",src:s.formatAvatarUrl(t.userAvatar),mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"message-bubble"},[e.createElementVNode("view",{class:"message-header"},[e.createElementVNode("text",{class:"username"},e.toDisplayString(t.userName),1),e.createElementVNode("text",{class:"time"},e.toDisplayString(s.formatTime(t.createTime)),1)]),e.createElementVNode("text",{class:"message-text"},e.toDisplayString(t.content),1),t.distance?(e.openBlock(),e.createElementBlock("view",{key:0,class:"message-footer"},[e.createElementVNode("text",{class:"distance"},"è·ç¦»: "+e.toDisplayString(s.formatDistance(t.distance)),1)])):e.createCommentVNode("v-if",!0)])])],8,["id"])))),128))]),e.createCommentVNode(" ç©ºæ¶ˆæ¯çŠ¶æ€ "),0!==s.nearbyMessages.length||s.isLoading?e.createCommentVNode("v-if",!0):(e.openBlock(),e.createElementBlock("view",{key:0,class:"empty-state"},[e.createElementVNode("image",{class:"empty-icon",src:$t,mode:"aspectFit"}),e.createElementVNode("text",{class:"empty-text"},"é™„è¿‘æš‚æ— æ¶ˆæ¯"),e.createElementVNode("text",{class:"empty-tip"},"å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œæˆä¸ºç¬¬ä¸€ä¸ªå‘è¨€çš„äººå§")])),e.createCommentVNode(" åŠ è½½ä¸­æç¤º "),s.isLoading?(e.openBlock(),e.createElementBlock("view",{key:1,class:"loading-state"},[e.createElementVNode("text",null,"åŠ è½½ä¸­...")])):e.createCommentVNode("v-if",!0)],40,["scroll-top"]),e.createCommentVNode(" åœ¨scroll-viewä¸‹æ–¹æ·»åŠ å›åˆ°åº•éƒ¨æŒ‰é’® "),s.showBackToBottom?(e.openBlock(),e.createElementBlock("view",{key:0,class:"back-to-bottom-btn",onClick:a[5]||(a[5]=(...e)=>s.scrollToBottom&&s.scrollToBottom(...e))},[e.createElementVNode("text",{class:"icon"},"â†“")])):e.createCommentVNode("v-if",!0)])):e.createCommentVNode("v-if",!0),e.createCommentVNode(" åŸå¸‚é¢‘é“å†…å®¹ "),"city"===s.activeTab?(e.openBlock(),e.createElementBlock("view",{key:1,class:"content"},[e.createElementVNode("view",{class:"location-info"},[e.createElementVNode("text",{class:"location-text"},e.toDisplayString(s.currentLocation.city||"æ­£åœ¨è·å–åŸå¸‚..."),1),e.createElementVNode("view",{class:"refresh-btn",onClick:a[6]||(a[6]=(...e)=>s.refreshLocation&&s.refreshLocation(...e))},[e.createElementVNode("text",{class:"refresh-icon"},"ğŸ”„")])]),e.createElementVNode("scroll-view",{class:"message-list city-message-list","scroll-y":"true","scroll-top":s.cityScrollTop,"scroll-with-animation":!0,"scroll-animation-duration":100,enhanced:!0,bounces:!1,"show-scrollbar":!1,onScrolltolower:a[7]||(a[7]=(...e)=>s.loadMoreCityMessages&&s.loadMoreCityMessages(...e)),onScroll:a[8]||(a[8]=(...e)=>s.onScroll&&s.onScroll(...e)),ref:"cityMessageList"},[e.createElementVNode("view",{class:"messages-container"},[e.createCommentVNode(" æ²¡æœ‰æ›´å¤šæ¶ˆæ¯æç¤º "),s.noMoreCityMessages&&s.cityMessages.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"no-more"},[e.createElementVNode("text",null,"æ²¡æœ‰æ›´å¤šæ¶ˆæ¯äº†")])):e.createCommentVNode("v-if",!0),e.createCommentVNode(" æ¶ˆæ¯é¡¹ "),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.cityMessages,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:t.id||a,class:"message-item",id:"city-msg-"+(t.id||a)},[e.createCommentVNode(" æ—¥æœŸåˆ†éš”çº¿ "),s.shouldShowDate(t,a,s.cityMessages)?(e.openBlock(),e.createElementBlock("view",{key:0,class:"date-divider"},[e.createElementVNode("text",null,e.toDisplayString(s.formatDate(t.createTime)),1)])):e.createCommentVNode("v-if",!0),e.createElementVNode("view",{class:"message-content"},[e.createCommentVNode(" ç”¨æˆ·å¤´åƒ "),e.createElementVNode("image",{class:"avatar",src:s.formatAvatarUrl(t.userAvatar),mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"message-bubble"},[e.createElementVNode("view",{class:"message-header"},[e.createElementVNode("text",{class:"username"},e.toDisplayString(t.userName),1),e.createElementVNode("text",{class:"time"},e.toDisplayString(s.formatTime(t.createTime)),1)]),e.createElementVNode("text",{class:"message-text"},e.toDisplayString(t.content),1)])])],8,["id"])))),128))]),e.createCommentVNode(" ç©ºæ¶ˆæ¯çŠ¶æ€ "),0!==s.cityMessages.length||s.isLoading?e.createCommentVNode("v-if",!0):(e.openBlock(),e.createElementBlock("view",{key:0,class:"empty-state"},[e.createElementVNode("image",{class:"empty-icon",src:$t,mode:"aspectFit"}),e.createElementVNode("text",{class:"empty-text"},"åŸå¸‚é¢‘é“æš‚æ— æ¶ˆæ¯"),e.createElementVNode("text",{class:"empty-tip"},"å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œæˆä¸ºç¬¬ä¸€ä¸ªå‘è¨€çš„äººå§")])),e.createCommentVNode(" åŠ è½½ä¸­æç¤º "),s.isLoading?(e.openBlock(),e.createElementBlock("view",{key:1,class:"loading-state"},[e.createElementVNode("text",null,"åŠ è½½ä¸­...")])):e.createCommentVNode("v-if",!0)],40,["scroll-top"]),e.createCommentVNode(" åœ¨scroll-viewä¸‹æ–¹æ·»åŠ å›åˆ°åº•éƒ¨æŒ‰é’® "),s.showBackToBottom?(e.openBlock(),e.createElementBlock("view",{key:0,class:"back-to-bottom-btn",onClick:a[9]||(a[9]=(...e)=>s.scrollToBottom&&s.scrollToBottom(...e))},[e.createElementVNode("text",{class:"icon"},"â†“")])):e.createCommentVNode("v-if",!0)])):e.createCommentVNode("v-if",!0),e.createCommentVNode(" è¾“å…¥åŒºåŸŸ - ä¿®æ”¹ä¸ºå›ºå®šåœ¨åº•éƒ¨ "),e.createElementVNode("view",{class:"input-area"},[e.withDirectives(e.createElementVNode("input",{type:"text",class:"message-input","onUpdate:modelValue":a[10]||(a[10]=e=>s.newMessage=e),placeholder:"è¾“å…¥æ¶ˆæ¯...",focus:s.inputFocus,"confirm-type":"send",onConfirm:a[11]||(a[11]=(...e)=>s.sendMessage&&s.sendMessage(...e))},null,40,["focus"]),[[e.vModelText,s.newMessage]]),e.createElementVNode("view",{class:e.normalizeClass(["send-btn",{active:s.newMessage.trim()}]),onClick:a[12]||(a[12]=(...e)=>s.sendMessage&&s.sendMessage(...e))},[e.createElementVNode("text",null,"å‘é€")],2)])])}],["__file","D:/caloriesH5/CloudStorage/pages/chat/index.vue"]]);const Wt=ze({setup(){Re();const t=Oe(),o=Ge(),s=e.reactive({title:"",description:"",type:"general",customTypeName:"",color:"#FF5733",isPublic:!0,latitude:39.9087,longitude:116.3975,radius:1,pet:null,images:[]}),r=e.ref([]);e.onMounted((()=>__async(this,null,(function*(){try{const e=yield(()=>{const e=getCurrentPages(),t=e[e.length-1].options||{};let o={latitude:39.9087,longitude:116.3975};return t.latitude&&t.longitude?{latitude:parseFloat(t.latitude),longitude:parseFloat(t.longitude)}:new Promise((e=>{uni.getLocation({type:"gcj02",success:t=>{a("log","at pages/map/add-marker.vue:220","è·å–å½“å‰ä½ç½®æˆåŠŸ:",t),e({latitude:t.latitude,longitude:t.longitude})},fail:t=>{a("error","at pages/map/add-marker.vue:227","è·å–å½“å‰ä½ç½®å¤±è´¥:",t),e(o)}})}))})();s.latitude=e.latitude,s.longitude=e.longitude,d(),setTimeout((()=>{const e=uni.createMapContext("marker-preview-map");e&&e.moveToLocation({latitude:s.latitude,longitude:s.longitude})}),500)}catch(e){a("error","at pages/map/add-marker.vue:273","åˆå§‹åŒ–ä½ç½®å¤±è´¥:",e)}}))));const n=[{value:"general",label:"ä¸€èˆ¬æ ‡è®°",icon:tt.general||"/static/images/marker.png",color:at},{value:"pet_friendly",label:"å® ç‰©å‹å¥½",icon:tt.pet_friendly||"/static/images/pet-marker.png",color:ot},{value:"danger",label:"å±é™©åŒºåŸŸ",icon:tt.danger||"/static/images/danger-marker.png",color:st},{value:"scenic",label:"é£æ™¯ä¼˜ç¾",icon:tt.scenic||"/static/images/park-marker.png",color:rt},{value:"pet_service",label:"å® ç‰©æœåŠ¡",icon:tt.pet_service||"/static/images/shop-marker.png",color:nt},{value:"custom",label:"è‡ªå®šä¹‰",icon:tt.custom||"/static/images/marker.png",color:it}],i=()=>{const e=n.find((e=>e.value===s.type));return e?e.icon:"/static/images/marker.png"},l=e.computed((()=>[{id:1,latitude:s.latitude,longitude:s.longitude,iconPath:i()||"/static/images/marker.png",width:40,height:40,anchor:{x:.5,y:1},callout:{content:"é•¿æŒ‰å¯æ‹–åŠ¨",color:"#000000",fontSize:12,borderRadius:4,padding:5,display:"ALWAYS"},draggable:!0}])),c=e.computed((()=>({latitude:s.latitude,longitude:s.longitude,color:s.color+"33",fillColor:s.color+"33",radius:1e3*s.radius,strokeWidth:2,strokeColor:s.color}))),u=e.ref([]),d=()=>__async(this,null,(function*(){const e=yield t.fetchPets();u.value=e})),m=(e,t)=>{a("log","at pages/map/add-marker.vue:504","æ›´æ–°æ ‡è®°ä½ç½®:",e,t),s.latitude=e,s.longitude=t,setTimeout((()=>{const a=uni.createMapContext("marker-preview-map");a&&a.moveToLocation({latitude:e,longitude:t})}),100),uni.showToast({title:"ä½ç½®å·²æ›´æ–°",icon:"success",duration:1500})},p=()=>{uni.showToast({title:"æ— æ³•ç¡®å®šä½ç½®ï¼Œè¯·å°è¯•æ‹–åŠ¨æ ‡è®°",icon:"none",duration:2e3})},g=e=>e*(Math.PI/180);function v(e){a("log","at pages/map/add-marker.vue:577","é€‰æ‹©å›¾ç‰‡ï¼š",e);const t=e.tempFilePaths.map(((t,a)=>({url:t,file:t,caption:"",name:e.tempFiles[a].name||`å›¾ç‰‡${s.images.length+a+1}`})));s.images.push(...t)}return{markerData:s,markerTypes:n,colorOptions:["#FF5733","#33FF57","#3357FF","#FF33F5","#F5FF33","#33FFF5"],markers:l,mapCircle:c,myPets:u,imageFiles:r,getSelectedTypeLabel:()=>{if("custom"===s.type&&s.customTypeName)return`è‡ªå®šä¹‰: ${s.customTypeName}`;const e=n.find((e=>e.value===s.type));return e?e.label:"è¯·é€‰æ‹©æ ‡è®°ç±»å‹"},getSelectedTypeIcon:i,getSelectedPetName:()=>{if(!s.pet)return"è¯·é€‰æ‹©å…³è”å® ç‰©";const e=u.value.find((e=>e._id===s.pet));return e?e.name:"è¯·é€‰æ‹©å…³è”å® ç‰©"},selectMarkerType:e=>{s.type=e,"custom"!==s.type&&(s.customTypeName="")},handlePetChange:e=>{const t=e.detail.value;s.pet=u.value[t]._id},handleRadiusChange:e=>{s.radius=parseFloat(parseFloat(e.detail.value).toFixed(2))},handleImageSelect:v,handleImageDelete:function(e){a("log","at pages/map/add-marker.vue:592","åˆ é™¤å›¾ç‰‡ï¼š",e)},removeImage:function(e){s.images.splice(e,1)},previewImage:function(e){const t=s.images.map((e=>e.url));uni.previewImage({urls:t,current:e})},selectColor:e=>{s.color=e},togglePublic:()=>{s.isPublic=!s.isPublic},handleMapTap:e=>{if(a("log","at pages/map/add-marker.vue:395","åœ°å›¾ç‚¹å‡»åŸå§‹äº‹ä»¶:",e),e&&e.detail&&(a("log","at pages/map/add-marker.vue:399","ç‚¹å‡»è¯¦æƒ…:",e.detail),"number"==typeof e.detail.x&&"number"==typeof e.detail.y)){const t=uni.createMapContext("marker-preview-map");if(t&&"function"==typeof t.fromScreenLocation)return void t.fromScreenLocation({x:e.detail.x,y:e.detail.y,success:e=>{m(e.latitude,e.longitude)},fail:e=>{a("error","at pages/map/add-marker.vue:414","åæ ‡è½¬æ¢å¤±è´¥:",e),p()}})}let t,o;e.detail&&"number"==typeof e.detail.latitude&&"number"==typeof e.detail.longitude?(t=e.detail.latitude,o=e.detail.longitude):"number"==typeof e.latitude&&"number"==typeof e.longitude?(t=e.latitude,o=e.longitude):e.target&&"number"==typeof e.target.latitude&&"number"==typeof e.target.longitude?(t=e.target.latitude,o=e.target.longitude):e.detail&&e.detail.target&&"number"==typeof e.detail.target.latitude&&"number"==typeof e.detail.target.longitude&&(t=e.detail.target.latitude,o=e.detail.target.longitude),t&&o?m(t,o):setTimeout((()=>{const e=uni.createMapContext("marker-preview-map");e&&"function"==typeof e.getCenterLocation?e.getCenterLocation({success:e=>{e.latitude&&e.longitude&&(m(e.latitude,e.longitude),uni.showToast({title:"å·²ä½¿ç”¨åœ°å›¾ä¸­å¿ƒä½ç½®",icon:"none",duration:1500}))}}):p()}),100)},handleMarkerDrag:e=>{if(a("log","at pages/map/add-marker.vue:475","æ ‡è®°æ‹–åŠ¨äº‹ä»¶:",e),e.detail&&"number"==typeof e.detail.latitude&&"number"==typeof e.detail.longitude)m(e.detail.latitude,e.detail.longitude);else if(1===e.markerId){let t,a;e.latitude&&e.longitude?(t=e.latitude,a=e.longitude):e.target&&e.target.latitude&&e.target.longitude&&(t=e.target.latitude,a=e.target.longitude),t&&a&&m(t,a)}},moveToMarker:()=>{uni.createMapContext("marker-preview-map").moveToLocation({latitude:s.latitude,longitude:s.longitude,success:()=>{uni.showToast({title:"å·²å®šä½åˆ°æ ‡è®°",icon:"success",duration:1500})}})},submitMarker:()=>__async(this,null,(function*(){var e,t;if(!s.title)return void uni.showToast({title:"è¯·è¾“å…¥æ ‡è®°æ ‡é¢˜",icon:"none"});if("custom"===s.type&&!s.customTypeName.trim())return void uni.showToast({title:"è¯·è¾“å…¥è‡ªå®šä¹‰ç±»å‹åç§°",icon:"none"});try{if("none"===(yield new Promise(((e,t)=>{uni.getNetworkType({success:t=>e(t.networkType),fail:e=>t(e)})}))))return void uni.showModal({title:"ç½‘ç»œé”™è¯¯",content:"æ‚¨å½“å‰æ— ç½‘ç»œè¿æ¥ï¼Œæ— æ³•ä¿å­˜æ ‡è®°ã€‚è¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®åé‡è¯•ã€‚",showCancel:!1})}catch(l){a("error","at pages/map/add-marker.vue:672","è·å–ç½‘ç»œçŠ¶æ€å¤±è´¥:",l)}let r=[];if(s.images&&s.images.length>0)try{uni.showLoading({title:"æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...",mask:!0});for(let e=0;e<s.images.length;e++){const t=s.images[e];if(!t.url||t.file){if(uni.showLoading({title:`ä¸Šä¼ å›¾ç‰‡ ${e+1}/${s.images.length}`,mask:!0}),!t.file)throw a("error","at pages/map/add-marker.vue:707",`å›¾ç‰‡ ${e+1} æ–‡ä»¶è·¯å¾„ä¸å­˜åœ¨`),new Error(`å›¾ç‰‡ ${e+1} æ–‡ä»¶è·¯å¾„ä¸å­˜åœ¨`);a("log","at pages/map/add-marker.vue:712",`å‡†å¤‡ä¸Šä¼ å›¾ç‰‡ ${e+1}:`,t.file);try{let o=null;if(o=yield new Promise(((o,r)=>{uni.uploadFile({url:"/api/markers/upload-fallback",filePath:t.file,name:"image",formData:{type:s.type||"default"},success:e=>{if(200===e.statusCode)try{const t=JSON.parse(e.data);o(t)}catch(t){r(new Error("è§£æå“åº”æ•°æ®å¤±è´¥"))}else r(new Error(`ä¸Šä¼ å¤±è´¥ï¼ŒçŠ¶æ€ç : ${e.statusCode}`))},fail:e=>{r(new Error(`å¤‡ç”¨ä¸Šä¼ å¤±è´¥: ${e.errMsg||"æœªçŸ¥é”™è¯¯"}`))}}).onProgressUpdate((t=>{a("log","at pages/map/add-marker.vue:746",`ä¸Šä¼ è¿›åº¦ ${e+1}/${s.images.length}: ${t.progress}%`)}))})),!o||!o.success)throw new Error((null==o?void 0:o.message)||"ä¸Šä¼ å¤±è´¥");r.push({url:o.url,caption:t.caption||""}),a("log","at pages/map/add-marker.vue:755",`å›¾ç‰‡ ${e+1} ä¸Šä¼ æˆåŠŸ:`,o)}catch(c){throw a("error","at pages/map/add-marker.vue:760",`å›¾ç‰‡ ${e+1} ä¸Šä¼ å¤±è´¥:`,c),new Error(`å›¾ç‰‡ ${e+1} ä¸Šä¼ å¤±è´¥: ${c.message}`)}}else r.push({url:t.url,caption:t.caption||""})}a("log","at pages/map/add-marker.vue:765","æ‰€æœ‰å›¾ç‰‡ä¸Šä¼ å®Œæˆ:",r)}catch(l){return a("error","at pages/map/add-marker.vue:767","å›¾ç‰‡ä¸Šä¼ å¤±è´¥:",l),uni.hideLoading(),void uni.showModal({title:"å›¾ç‰‡ä¸Šä¼ å¤±è´¥",content:l.message||"ä¸Šä¼ å›¾ç‰‡æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•",showCancel:!1})}const n={title:s.title,description:s.description,type:s.type,icon:i(),color:s.color,longitude:s.longitude,latitude:s.latitude,radius:parseFloat(parseFloat(s.radius).toFixed(2)),isPublic:s.isPublic,properties:{},images:r};a("log","at pages/map/add-marker.vue:794","å‡†å¤‡ä¿å­˜æ ‡è®°æ•°æ®:",n),a("log","at pages/map/add-marker.vue:795","è¦†ç›–åŠå¾„å€¼ (km):",n.radius),"custom"===s.type&&(n.properties.customTypeName=s.customTypeName.trim()),s.pet&&(n.pet=s.pet),a("log","at pages/map/add-marker.vue:807","å‡†å¤‡ä¿å­˜æ ‡è®°æ•°æ®:",n);try{uni.showLoading({title:"æ­£åœ¨ä¿å­˜...",mask:!0});const e=yield o.createMarker(n);uni.hideLoading(),e?(a("log","at pages/map/add-marker.vue:821","æ ‡è®°ä¿å­˜æˆåŠŸï¼Œæ•°æ®:",e),e.data&&e.data._id?(uni.$emit("marker-created",{marker:e.data,timestamp:Date.now()}),setTimeout((()=>{uni.navigateBack({delta:1,success:()=>{uni.$emit("refresh-map",{timestamp:Date.now()})}})}),1500)):(uni.showToast({title:"æ ‡è®°ä¿å­˜æˆåŠŸ",icon:"success"}),setTimeout((()=>{uni.navigateBack({delta:1})}),1500))):uni.showModal({title:"ä¿å­˜å¤±è´¥",content:"æ ‡è®°æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·è”ç³»å®¢æœã€‚",showCancel:!1})}catch(l){uni.hideLoading(),a("error","at pages/map/add-marker.vue:867","ä¿å­˜æ ‡è®°æ—¶å‡ºé”™:",l);const o=(null==(t=null==(e=l.response)?void 0:e.data)?void 0:t.message)||l.message||"ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•";uni.showModal({title:"ä¿å­˜å¤±è´¥",content:o,showCancel:!1})}})),calculateDistance:(e,t,a,o)=>{if(!(e&&t&&a&&o))return 0;const s=g(a-e),r=g(o-t),n=Math.sin(s/2)*Math.sin(s/2)+Math.cos(g(e))*Math.cos(g(a))*Math.sin(r/2)*Math.sin(r/2);return 6371*(2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)))},deg2rad:g,cancel:()=>{uni.navigateBack()},openFilePicker:function(){uni.chooseImage({count:9-s.images.length,sizeType:["original","compressed"],sourceType:["album","camera"],success:e=>{v({tempFilePaths:e.tempFilePaths,tempFiles:e.tempFiles})},fail:e=>{a("error","at pages/map/add-marker.vue:626","é€‰æ‹©å›¾ç‰‡å¤±è´¥:",e),uni.showToast({title:"é€‰æ‹©å›¾ç‰‡å¤±è´¥",icon:"none"})}})}}}},[["render",function(t,a,o,s,r,n){const i=e.resolveComponent("uni-icons"),l=e.resolveComponent("uni-file-picker");return e.openBlock(),e.createElementBlock("view",{class:"marker-form-container"},[e.createElementVNode("view",{class:"form-header"},[e.createElementVNode("text",{class:"form-title"},"æ·»åŠ åœ°å›¾æ ‡è®°/æ•…äº‹")]),e.createElementVNode("view",{class:"form-content"},[e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},[e.createTextVNode("æ ‡è®°æ ‡é¢˜"),e.createElementVNode("text",{class:"required"},"*")]),e.withDirectives(e.createElementVNode("input",{class:"form-input",type:"text","onUpdate:modelValue":a[0]||(a[0]=e=>s.markerData.title=e),placeholder:"è¯·è¾“å…¥æ ‡è®°æ ‡é¢˜",maxlength:"50"},null,512),[[e.vModelText,s.markerData.title]])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"æ ‡è®°æè¿°"),e.withDirectives(e.createElementVNode("textarea",{class:"form-textarea","onUpdate:modelValue":a[1]||(a[1]=e=>s.markerData.description=e),placeholder:"è¯·è¾“å…¥æ ‡è®°æè¿°",maxlength:"200"},null,512),[[e.vModelText,s.markerData.description]])]),e.createCommentVNode(" å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ "),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"ä¸Šä¼ å›¾ç‰‡"),e.createElementVNode("view",{class:"image-upload-area"},[e.createCommentVNode(" æ˜¾ç¤ºæ˜ç¡®çš„ä¸Šä¼ æŒ‰é’® "),0===s.markerData.images.length?(e.openBlock(),e.createElementBlock("view",{key:0,class:"upload-button",onClick:a[2]||(a[2]=(...e)=>s.openFilePicker&&s.openFilePicker(...e))},[e.createVNode(i,{type:"camera-filled",size:"24",color:"#007AFF"}),e.createElementVNode("text",{class:"upload-text"},"ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡")])):e.createCommentVNode("v-if",!0),e.createVNode(l,{ref:"filePicker",modelValue:s.imageFiles,"onUpdate:modelValue":a[3]||(a[3]=e=>s.imageFiles=e),fileMediatype:"image",mode:"grid",limit:9,onSelect:s.handleImageSelect,onDelete:s.handleImageDelete},null,8,["modelValue","onSelect","onDelete"]),e.createCommentVNode(" å·²ä¸Šä¼ å›¾ç‰‡é¢„è§ˆå’Œæè¿° "),s.markerData.images&&s.markerData.images.length>0?(e.openBlock(),e.createElementBlock("view",{key:1,class:"uploaded-images"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.markerData.images,((t,a)=>(e.openBlock(),e.createElementBlock("view",{class:"image-item",key:a},[e.createElementVNode("image",{src:t.url,mode:"aspectFill",class:"preview-image",onClick:e=>s.previewImage(a)},null,8,["src","onClick"]),e.withDirectives(e.createElementVNode("input",{type:"text","onUpdate:modelValue":e=>t.caption=e,placeholder:"è¯·è¾“å…¥å›¾ç‰‡æè¿°(å¯é€‰)",class:"image-caption-input"},null,8,["onUpdate:modelValue"]),[[e.vModelText,t.caption]]),e.createElementVNode("view",{class:"image-actions"},[e.createElementVNode("view",{class:"delete-btn",onClick:e=>s.removeImage(a)},[e.createVNode(i,{type:"trash",size:"18"})],8,["onClick"])])])))),128)),e.createCommentVNode(" æ·»åŠ æ›´å¤šå›¾ç‰‡çš„æŒ‰é’® "),s.markerData.images.length<9?(e.openBlock(),e.createElementBlock("view",{key:0,class:"add-more-btn",onClick:a[4]||(a[4]=(...e)=>s.openFilePicker&&s.openFilePicker(...e))},[e.createVNode(i,{type:"plus",size:"20",color:"#007AFF"}),e.createElementVNode("text",null,"æ·»åŠ æ›´å¤šå›¾ç‰‡")])):e.createCommentVNode("v-if",!0)])):e.createCommentVNode("v-if",!0)])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"æ ‡è®°ç±»å‹"),e.createElementVNode("view",{class:"marker-type-selector"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.markerTypes,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:a,class:e.normalizeClass(["marker-type-item",{active:s.markerData.type===t.value}]),onClick:e=>s.selectMarkerType(t.value)},[e.createElementVNode("view",{class:"marker-type-icon",style:e.normalizeStyle({backgroundColor:t.color||"#007AFF"})},[t.icon.startsWith("data:")?(e.openBlock(),e.createElementBlock("image",{key:1,src:t.icon,class:"type-icon svg-icon",mode:"aspectFit"},null,8,["src"])):(e.openBlock(),e.createElementBlock("image",{key:0,src:t.icon,class:"type-icon",mode:"aspectFit"},null,8,["src"]))],4),e.createElementVNode("text",{class:"marker-type-label"},e.toDisplayString(t.label),1)],10,["onClick"])))),128))])]),e.createCommentVNode(" è‡ªå®šä¹‰ç±»å‹åç§°è¾“å…¥ "),"custom"===s.markerData.type?(e.openBlock(),e.createElementBlock("view",{key:0,class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"è‡ªå®šä¹‰ç±»å‹åç§°"),e.withDirectives(e.createElementVNode("input",{class:"form-input",type:"text","onUpdate:modelValue":a[5]||(a[5]=e=>s.markerData.customTypeName=e),placeholder:"è¯·è¾“å…¥è‡ªå®šä¹‰ç±»å‹åç§°",maxlength:"20"},null,512),[[e.vModelText,s.markerData.customTypeName]])])):e.createCommentVNode("v-if",!0),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"æ ‡è®°é¢œè‰²"),e.createElementVNode("view",{class:"color-selector"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.colorOptions,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:a,class:e.normalizeClass(["color-item",{active:s.markerData.color===t}]),style:e.normalizeStyle({backgroundColor:t}),onClick:e=>s.selectColor(t)},null,14,["onClick"])))),128))])]),e.createCommentVNode(" æ·»åŠ æ ‡è®°åŠå¾„å­—æ®µ "),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"è¦†ç›–åŠå¾„ (åƒç±³)"),e.createElementVNode("slider",{class:"radius-slider",min:.1,max:10,step:.1,value:s.markerData.radius,"show-value":!0,onChange:a[6]||(a[6]=(...e)=>s.handleRadiusChange&&s.handleRadiusChange(...e))},null,40,["value"]),e.createElementVNode("text",{class:"radius-value"},e.toDisplayString(s.markerData.radius)+"km",1)]),e.createElementVNode("view",{class:"form-item checkbox-item"},[e.createElementVNode("checkbox",{checked:s.markerData.isPublic,onClick:a[7]||(a[7]=(...e)=>s.togglePublic&&s.togglePublic(...e))},null,8,["checked"]),e.createElementVNode("text",{class:"checkbox-label"},"å…¬å¼€æ­¤æ ‡è®°ï¼ˆå…è®¸å…¶ä»–ç”¨æˆ·çœ‹åˆ°ï¼‰")]),s.myPets.length>0?(e.openBlock(),e.createElementBlock("view",{key:1,class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"å…³è”å® ç‰©"),e.createElementVNode("picker",{class:"form-picker",range:s.myPets,"range-key":"name",onChange:a[8]||(a[8]=(...e)=>s.handlePetChange&&s.handlePetChange(...e))},[e.createElementVNode("view",{class:"picker-value"},e.toDisplayString(s.getSelectedPetName()),1)],40,["range"])])):e.createCommentVNode("v-if",!0),e.createElementVNode("view",{class:"form-location"},[e.createElementVNode("text",{class:"location-label"},"ä½ç½®ä¿¡æ¯"),e.createElementVNode("view",{class:"location-info"},[e.createElementVNode("text",{class:"location-coordinates"},"ç»åº¦: "+e.toDisplayString(s.markerData.longitude.toFixed(6))+", çº¬åº¦: "+e.toDisplayString(s.markerData.latitude.toFixed(6)),1),e.createElementVNode("text",{class:"location-hint"},"ç‚¹å‡»ä¸‹æ–¹åœ°å›¾å¯ç›´æ¥æ ‡è®°ä½ç½®ï¼Œæˆ–æ‹–åŠ¨æ ‡è®°ç‚¹è°ƒæ•´ä½ç½®")]),e.createElementVNode("view",{class:"location-map"},[e.createCommentVNode(" åœ°å›¾åŒºåŸŸ "),e.createElementVNode("map",{id:"marker-preview-map",class:"mini-map",latitude:s.markerData.latitude,longitude:s.markerData.longitude,markers:s.markers,circles:[s.mapCircle],scale:"16",onTap:a[9]||(a[9]=(...e)=>s.handleMapTap&&s.handleMapTap(...e)),onMarkerdrag:a[10]||(a[10]=(...e)=>s.handleMarkerDrag&&s.handleMarkerDrag(...e)),"show-location":""},null,40,["latitude","longitude","markers","circles"]),e.createCommentVNode(" ä½ç½®è¯´æ˜ "),e.createElementVNode("view",{class:"map-overlay-tips"},[e.createElementVNode("text",null,"ç‚¹å‡»åœ°å›¾ä»»æ„ä½ç½® æˆ– é•¿æŒ‰æ ‡è®°è¿›è¡Œæ‹–åŠ¨")]),e.createCommentVNode(" å®šä½æŒ‰é’® "),e.createElementVNode("view",{class:"map-controls"},[e.createElementVNode("view",{class:"map-control-btn",onClick:a[11]||(a[11]=(...e)=>s.moveToMarker&&s.moveToMarker(...e))},[e.createElementVNode("text",{class:"map-control-text"},"å®šä½åˆ°æ ‡è®°")])])])])]),e.createElementVNode("view",{class:"form-actions"},[e.createElementVNode("button",{class:"btn btn-cancel",onClick:a[12]||(a[12]=(...e)=>s.cancel&&s.cancel(...e))},"å–æ¶ˆ"),e.createElementVNode("button",{class:"btn btn-submit",onClick:a[13]||(a[13]=(...e)=>s.submitMarker&&s.submitMarker(...e))},"ä¿å­˜")])])}],["__file","D:/caloriesH5/CloudStorage/pages/map/add-marker.vue"]]);const zt=ze({setup(){const t=e.ref({}),o=Ge(),s=Re(),r=e.ref(!1),n=e.ref(null),i=e.ref(0),l=e.ref(0),c=e.computed((()=>t.value.images&&t.value.images.length>0?2:1));e.onMounted((()=>__async(this,null,(function*(){var e;try{a("log","at pages/map/marker-detail.vue:181","é¡µé¢åŠ è½½ï¼Œå‡†å¤‡è·å–æ ‡è®°è¯¦æƒ…");const s=getCurrentPages(),r=s[s.length-1],n=null==(e=null==r?void 0:r.options)?void 0:e.id;if(!n)throw new Error("æ²¡æœ‰æŒ‡å®šæ ‡è®°ID");a("log","at pages/map/marker-detail.vue:190","å¼€å§‹è·å–æ ‡è®°è¯¦æƒ…ï¼Œæ ‡è®°ID:",n);const i=o.selectedMarker;i&&i._id===n?(a("log","at pages/map/marker-detail.vue:195","ä»storeè·å–æ ‡è®°æ•°æ®"),t.value=i,a("log","at pages/map/marker-detail.vue:197","æ ‡è®°æ•°æ®:",JSON.stringify(t.value,null,2)),t.value.user?"string"==typeof t.value.user?(a("log","at pages/map/marker-detail.vue:202","ç”¨æˆ·ä¿¡æ¯åªæœ‰IDï¼Œéœ€è¦è·å–è¯¦æƒ…:",t.value.user),yield d(t.value.user)):a("log","at pages/map/marker-detail.vue:205","å·²æœ‰å®Œæ•´ç”¨æˆ·ä¿¡æ¯:",t.value.user):a("log","at pages/map/marker-detail.vue:208","æ ‡è®°æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯")):(a("log","at pages/map/marker-detail.vue:212","ä»APIè·å–æ ‡è®°è¯¦æƒ…"),yield u(n))}catch(s){a("error","at pages/map/marker-detail.vue:216","æ ‡è®°è¯¦æƒ…é¡µé¢åˆå§‹åŒ–å¤±è´¥:",s),uni.showToast({title:"è·å–æ ‡è®°ä¿¡æ¯å¤±è´¥",icon:"none"})}}))));const u=e=>new Promise(((o,r)=>{a("log","at pages/map/marker-detail.vue:227","ä»APIè·å–æ ‡è®°ï¼ŒID:",e),uni.request({url:`/api/markers/${e}`,method:"GET",header:{Authorization:`Bearer ${s.token}`},success:e=>__async(this,null,(function*(){var s;try{if(200===e.statusCode&&e.data)e.data.success&&e.data.data?t.value=e.data.data:t.value=e.data,a("log","at pages/map/marker-detail.vue:246","æ ‡è®°æ•°æ®è·å–æˆåŠŸ:",t.value),t.value.user&&"string"==typeof t.value.user?(a("log","at pages/map/marker-detail.vue:250","éœ€è¦è·å–ç”¨æˆ·è¯¦æƒ…ï¼Œç”¨æˆ·ID:",t.value.user),yield d(t.value.user)):t.value.user?a("log","at pages/map/marker-detail.vue:253","æ ‡è®°åŒ…å«å®Œæ•´ç”¨æˆ·ä¿¡æ¯:",t.value.user):a("log","at pages/map/marker-detail.vue:255","æ ‡è®°æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯"),o(t.value);else{const t=(null==(s=e.data)?void 0:s.message)||"è·å–æ ‡è®°å¤±è´¥";a("error","at pages/map/marker-detail.vue:261","APIå“åº”é”™è¯¯:",t),r(new Error(t))}}catch(n){a("error","at pages/map/marker-detail.vue:265","å¤„ç†APIå“åº”æ—¶å‡ºé”™:",n),r(n)}})),fail:e=>{a("error","at pages/map/marker-detail.vue:270","APIè¯·æ±‚å¤±è´¥:",e),r(e)}})})),d=e=>__async(this,null,(function*(){r.value=!0,n.value=null;try{return a("log","at pages/map/marker-detail.vue:283","å¼€å§‹è·å–ç”¨æˆ·ä¿¡æ¯ï¼ŒID:",e),new Promise(((o,i)=>{uni.request({url:`/api/users/${e}`,method:"GET",header:{Authorization:`Bearer ${s.token}`},success:s=>{var r;if(200===s.statusCode&&s.data)t.value.user=s.data,a("log","at pages/map/marker-detail.vue:297","ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ:",t.value.user),o(t.value.user);else{const i=(null==(r=s.data)?void 0:r.message)||"è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥";a("error","at pages/map/marker-detail.vue:301","è·å–ç”¨æˆ·ä¿¡æ¯APIå“åº”é”™è¯¯:",i),n.value=new Error(i),t.value.user={username:"ç”¨æˆ·"+e.substr(-4),nickname:"æœªçŸ¥ç”¨æˆ·"},o(null)}},fail:s=>{a("error","at pages/map/marker-detail.vue:312","è·å–ç”¨æˆ·ä¿¡æ¯è¯·æ±‚å¤±è´¥:",s),n.value=s,t.value.user={username:"ç”¨æˆ·"+e.substr(-4),nickname:"æœªçŸ¥ç”¨æˆ·"},o(null)},complete:()=>{r.value=!1}})}))}catch(o){return a("error","at pages/map/marker-detail.vue:327","è·å–ç”¨æˆ·ä¿¡æ¯å¤„ç†å¤±è´¥:",o),n.value=o,r.value=!1,t.value.user={username:e?"ç”¨æˆ·"+e.substr(-4):"æœªçŸ¥ç”¨æˆ·",nickname:"æœªçŸ¥ç”¨æˆ·"},null}})),m=e=>{if(!e)return"/static/images/default-avatar.png";if(e.startsWith("http://")||e.startsWith("https://"))return e;try{let t=uni.getStorageSync("BASE_URL")||"http://49.235.65.37:5000";return e.startsWith("/")?t+e:e.startsWith("static/")?"/"+e:t+"/"+e}catch(t){return a("error","at pages/map/marker-detail.vue:408","URLå¤„ç†é”™è¯¯:",t,e),e.startsWith("/")?e:"/"+e}},p=e=>{if(!e)return"/static/images/default-cover.jpg";try{return e.startsWith("http://")||e.startsWith("https://")?e:m(e)}catch(t){return a("error","at pages/map/marker-detail.vue:427","å›¾ç‰‡URLå¤„ç†é”™è¯¯:",t,e),"/static/images/default-cover.jpg"}};return{marker:t,isLoadingUser:r,userError:n,currentPage:i,currentPhotoIndex:l,totalPages:c,getMarkerTypeName:e=>({general:"æ™®é€šæ ‡è®°",pet_friendly:"å® ç‰©å‹å¥½",danger:"å±é™©åŒºåŸŸ",scenic:"é£æ™¯åŒº",pet_service:"å® ç‰©æœåŠ¡",custom:"è‡ªå®šä¹‰"}[e]||"æœªçŸ¥ç±»å‹"),formatTime:e=>{if(!e)return"æœªçŸ¥æ—¶é—´";const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`},getImageUrl:p,getUserAvatar:e=>{if(!e)return"/static/images/default-avatar.png";if("string"==typeof e)return"/static/images/default-avatar.png";const t=e.avatar||"/static/images/default-avatar.png";return m(t)},getUserName:e=>e?"string"==typeof e?"ç”¨æˆ·"+e.substr(-4):e.nickname||e.username||"æœªçŸ¥ç”¨æˆ·":"æœªçŸ¥ç”¨æˆ·",previewImage:e=>{if(!t.value.images||0===t.value.images.length)return;const a=t.value.images.map((e=>p(e.url)));uni.previewImage({urls:a,current:e})},goBack:()=>{uni.navigateBack()},navigateToMarker:()=>{const e=getCurrentPages(),a=e[e.length-2];a&&a.$vm&&a.$vm.navigateToLocation?(a.$vm.navigateToLocation(t.value),setTimeout((()=>{uni.navigateBack()}),500)):(uni.setStorageSync("navigate_to_marker",t.value),uni.navigateBack())},onPageChange:e=>{i.value=e.detail.current},onPhotoChange:e=>{l.value=e.detail.current},goToPage:e=>{i.value=e}}}},[["render",function(t,a,o,s,r,n){return e.openBlock(),e.createElementBlock("view",{class:"marker-album-container"},[e.createCommentVNode(" é¡¶éƒ¨å®‰å…¨åŒºåŸŸ "),e.createElementVNode("view",{class:"safe-area-top"}),e.createCommentVNode(" é¡¶éƒ¨è¿”å›æŒ‰é’® - æ›´åŠ çªå‡º "),e.createElementVNode("view",{class:"back-button",onClick:a[0]||(a[0]=(...e)=>s.goBack&&s.goBack(...e))},[e.createCommentVNode(" ä½¿ç”¨æ–‡æœ¬ä»£æ›¿å›¾æ ‡é¿å…ç»„ä»¶é—®é¢˜ "),e.createElementVNode("text",{class:"back-icon"},"â†"),e.createCommentVNode(' <text class="back-text">è¿”å›</text> ')]),e.createCommentVNode(" ä¸»å†…å®¹åŒºåŸŸ - ç”»å†Œé£æ ¼ "),e.createElementVNode("swiper",{class:"main-swiper",current:s.currentPage,onChange:a[2]||(a[2]=(...e)=>s.onPageChange&&s.onPageChange(...e)),"indicator-dots":!1,duration:400},[e.createCommentVNode(" åˆå¹¶çš„å°é¢å’Œè¯¦æƒ…é¡µ "),e.createElementVNode("swiper-item",null,[e.createElementVNode("scroll-view",{class:"album-combined","scroll-y":""},[e.createCommentVNode(" å°é¢å›¾ç‰‡ "),e.createElementVNode("view",{class:"combined-cover"},[e.createElementVNode("image",{class:"cover-image",src:s.marker.images&&s.marker.images.length>0?s.getImageUrl(s.marker.images[0].url):"/static/images/default-cover.jpg",mode:"aspectFill"},null,8,["src"]),e.createElementVNode("view",{class:"cover-overlay"}),e.createElementVNode("view",{class:"cover-content"},[e.createElementVNode("text",{class:"cover-title"},e.toDisplayString(s.marker.title||"æœªå‘½åæ ‡è®°"),1),e.createElementVNode("view",{class:"cover-creator"},[e.createCommentVNode(" æ·»åŠ åŠ è½½çŠ¶æ€æ˜¾ç¤º "),s.isLoadingUser?(e.openBlock(),e.createElementBlock("view",{key:0,class:"loading-user"},[e.createElementVNode("text",null,"åŠ è½½ç”¨æˆ·ä¿¡æ¯...")])):(e.openBlock(),e.createElementBlock(e.Fragment,{key:1},[e.createElementVNode("image",{class:"creator-avatar",src:s.getUserAvatar(s.marker.user),mode:"aspectFill"},null,8,["src"]),e.createElementVNode("text",{class:"creator-name"},e.toDisplayString(s.getUserName(s.marker.user)),1)],64))]),e.createElementVNode("text",{class:"cover-time"},e.toDisplayString(s.formatTime(s.marker.createdAt)),1),e.createElementVNode("view",{class:"cover-type-tag"},[e.createElementVNode("text",null,e.toDisplayString(s.getMarkerTypeName(s.marker.type)),1)])])]),e.createCommentVNode(" è¯¦æƒ…æè¿°éƒ¨åˆ† "),e.createElementVNode("view",{class:"combined-detail"},[e.createElementVNode("view",{class:"detail-header"},[e.createElementVNode("text",{class:"detail-title"},"è¯¦æƒ…æè¿°")]),e.createElementVNode("view",{class:"detail-content"},[e.createElementVNode("text",{class:"detail-text"},e.toDisplayString(s.marker.description||"æš‚æ— æè¿°å†…å®¹"),1)]),e.createElementVNode("view",{class:"detail-info"},[e.createElementVNode("view",{class:"info-row"},[e.createElementVNode("text",{class:"info-label"},"æ ‡è®°ç±»å‹"),e.createElementVNode("text",{class:"info-value"},e.toDisplayString(s.getMarkerTypeName(s.marker.type)),1)]),s.marker.radius?(e.openBlock(),e.createElementBlock("view",{key:0,class:"info-row"},[e.createElementVNode("text",{class:"info-label"},"è¦†ç›–åŠå¾„"),e.createElementVNode("text",{class:"info-value"},e.toDisplayString(s.marker.radius)+"ç±³",1)])):e.createCommentVNode("v-if",!0),e.createElementVNode("view",{class:"info-row"},[e.createElementVNode("text",{class:"info-label"},"åˆ›å»ºæ—¶é—´"),e.createElementVNode("text",{class:"info-value"},e.toDisplayString(s.formatTime(s.marker.createdAt)),1)]),e.createCommentVNode(" æ·»åŠ åˆ›å»ºè€…ä¿¡æ¯ "),s.isLoadingUser?e.createCommentVNode("v-if",!0):(e.openBlock(),e.createElementBlock("view",{key:1,class:"info-row"},[e.createElementVNode("text",{class:"info-label"},"åˆ›å»ºè€…"),e.createElementVNode("text",{class:"info-value"},e.toDisplayString(s.getUserName(s.marker.user)),1)]))]),s.marker.images&&s.marker.images.length>0?(e.openBlock(),e.createElementBlock("view",{key:0,class:"navigation-hint"},[e.createElementVNode("text",null,"å‘å·¦æ»‘åŠ¨æŸ¥çœ‹ç…§ç‰‡"),e.createElementVNode("text",{class:"arrow-icon"},"â†’")])):e.createCommentVNode("v-if",!0)])])]),e.createCommentVNode(" å›¾ç‰‡æµè§ˆé¡µ "),s.marker.images&&s.marker.images.length>0?(e.openBlock(),e.createElementBlock("swiper-item",{key:0},[e.createElementVNode("view",{class:"album-photos"},[e.createElementVNode("swiper",{class:"photos-swiper","indicator-dots":!0,autoplay:!1,duration:300,current:s.currentPhotoIndex,onChange:a[1]||(a[1]=(...e)=>s.onPhotoChange&&s.onPhotoChange(...e))},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.marker.images,((t,a)=>(e.openBlock(),e.createElementBlock("swiper-item",{key:a,onClick:e=>s.previewImage(a)},[e.createElementVNode("view",{class:"photo-container"},[e.createElementVNode("image",{class:"photo-image",src:s.getImageUrl(t.url),mode:"aspectFit"},null,8,["src"]),e.createElementVNode("view",{class:"photo-caption-container"},[e.createElementVNode("text",{class:"photo-caption"},e.toDisplayString(t.caption||"æ— æè¿°"),1),e.createElementVNode("text",{class:"photo-index"},e.toDisplayString(a+1)+"/"+e.toDisplayString(s.marker.images.length),1)])])],8,["onClick"])))),128))],40,["current"])])])):(e.openBlock(),e.createElementBlock(e.Fragment,{key:1},[e.createCommentVNode(" æ— å›¾ç‰‡æç¤º "),e.createElementVNode("swiper-item",null,[e.createElementVNode("view",{class:"no-photos"},[e.createElementVNode("text",{class:"no-photos-icon"},"ğŸ–¼ï¸"),e.createElementVNode("text",{class:"no-photos-text"},"æš‚æ— ç…§ç‰‡")])])],2112))],40,["current"]),e.createCommentVNode(" åº•éƒ¨å¯¼èˆªæ¡ "),e.createElementVNode("view",{class:"album-footer"},[e.createElementVNode("view",{class:"footer-dots"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.totalPages,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:a,class:e.normalizeClass(["footer-dot",{active:s.currentPage===a}]),onClick:e=>s.goToPage(a)},null,10,["onClick"])))),128))]),e.createElementVNode("button",{class:"navigate-btn",onClick:a[3]||(a[3]=(...e)=>s.navigateToMarker&&s.navigateToMarker(...e))},[e.createElementVNode("text",{class:"location-icon"},"ğŸ“"),e.createElementVNode("text",null,"å¯¼èˆªåˆ°æ­¤å¤„")])])])}],["__scopeId","data-v-c0e2ee7a"],["__file","D:/caloriesH5/CloudStorage/pages/map/marker-detail.vue"]]);const Jt=ze({setup(){var t;const o=Re();e.ref((null==(t=o.userInfo)?void 0:t.id)||"");const s=e.ref([]),r=e.ref(!1),n=e.ref(!1),i=e.ref({breed:"",englishName:"",breedConfidence:0,purity:"",features:"",characteristics:{friendliness:0,activity:0,trainability:0,grooming:0},note:"",petType:"",identified:!0,message:""}),l=e=>{i.value={identified:!1!==e.identified,message:e.message||"",breed:e.breed||"æœªè¯†åˆ«",englishName:e.englishName||"",breedConfidence:e.breedConfidence||0,purity:e.purity||"æœªè¯†åˆ«",features:e.features||"æ— æ³•è·å–ç‰¹å¾æè¿°",characteristics:e.characteristics||{friendliness:0,activity:0,trainability:0,grooming:0},note:e.note||"",petType:e.petType||"unknown"},i.value.identified&&c(i.value)},c=e=>{try{const t=uni.getStorageSync("petAnalysisHistory")||"[]",a=JSON.parse(t);a.unshift({id:"history-"+Date.now(),timestamp:Date.now(),result:e,images:s.value.map((e=>e.path))});const o=10;a.length>o&&a.splice(o),uni.setStorageSync("petAnalysisHistory",JSON.stringify(a))}catch(t){a("error","at pages/petIdentify/index.vue:317","ä¿å­˜åˆ†æå†å²å¤±è´¥:",t)}},u=e=>{uni.setClipboardData({data:e,success:()=>{uni.showToast({title:"åˆ†äº«å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿",icon:"none",duration:2e3})}})};return{imageList:s,maxImageCount:4,isAnalyzing:r,showResult:n,result:i,chooseImage:()=>{uni.chooseImage({count:4-s.value.length,sizeType:["compressed"],sourceType:["album","camera"],success:e=>{const t=e.tempFiles.map((e=>({path:e.path,size:e.size,uploaded:!1})));s.value=[...s.value,...t]},fail:e=>{e.errMsg&&-1!==e.errMsg.indexOf("cancel")?a("log","at pages/petIdentify/index.vue:176","ç”¨æˆ·å–æ¶ˆé€‰æ‹©å›¾ç‰‡"):(a("error","at pages/petIdentify/index.vue:180","é€‰æ‹©å›¾ç‰‡å¤±è´¥:",e),uni.showToast({title:"é€‰æ‹©å›¾ç‰‡å¤±è´¥",icon:"none"}))}})},deleteImage:e=>{s.value.splice(e,1),0===s.value.length&&(n.value=!1)},analyzeImages:()=>__async(this,null,(function*(){if(0!==s.value.length){r.value=!0,n.value=!1;try{uni.showLoading({title:"æ­£åœ¨åˆ†æå›¾ç‰‡...",mask:!0});const e=s.value.map((e=>e.path)),t=yield _t(e);uni.hideLoading(),!1===t.identified?(uni.showToast({title:t.message||"æ— æ³•è¯†åˆ«ï¼Œè¯·å°è¯•æ¸…æ™°çš„å® ç‰©ç…§ç‰‡",icon:"none",duration:3e3}),i.value=__spreadProps(__spreadValues({},t),{breed:"æœªèƒ½è¯†åˆ«",breedConfidence:0,purity:"æœªçŸ¥",characteristics:{friendliness:0,activity:0,trainability:0,grooming:0}})):(l(t),n.value=!0)}catch(e){a("error","at pages/petIdentify/index.vue:254","åˆ†æå¤±è´¥:",e),uni.hideLoading(),uni.showToast({title:e.message||"åˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none",duration:3e3})}finally{r.value=!1}}else uni.showToast({title:"è¯·å…ˆä¸Šä¼ å® ç‰©ç…§ç‰‡",icon:"none"})})),formatCharName:e=>({friendliness:"å‹å–„åº¦",activity:"æ´»è·ƒåº¦",trainability:"å¯è®­ç»ƒæ€§",grooming:"æ¯›å‘æŠ¤ç†éœ€æ±‚"}[e]||e),shareResult:()=>{if(n.value)try{const e=`æˆ‘çš„å® ç‰©æ˜¯${i.value.breed}(${i.value.englishName})ï¼Œ${i.value.purity}ï¼Œ${i.value.features}`;uni.share({provider:"weixin",scene:"WXSceneSession",type:0,title:`å® ç‰©è¯†åˆ«ç»“æœï¼š${i.value.breed}`,summary:e.substring(0,80)+"...",imageUrl:s.value.length>0?s.value[0].path:"",success:e=>{a("log","at pages/petIdentify/index.vue:358","åˆ†äº«æˆåŠŸ:",e)},fail:t=>{a("error","at pages/petIdentify/index.vue:361","åˆ†äº«å¤±è´¥:",t),u(e)}})}catch(e){a("error","at pages/petIdentify/index.vue:373","åˆ†äº«å¤„ç†å¼‚å¸¸:",e),u(`æˆ‘çš„å® ç‰©æ˜¯${i.value.breed}ï¼Œ${i.value.purity}`)}else uni.showToast({title:"æš‚æ— ç»“æœå¯åˆ†äº«",icon:"none"})},saveResult:()=>{uni.showToast({title:"æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...",icon:"none"}),setTimeout((()=>{uni.showToast({title:"ä¿å­˜æˆåŠŸ",icon:"success"})}),2e3)},goBack:()=>{uni.navigateBack()}}}},[["render",function(t,a,o,s,r,n){return e.openBlock(),e.createElementBlock("view",{class:"container"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("view",{class:"back-btn",onClick:a[0]||(a[0]=(...e)=>s.goBack&&s.goBack(...e))},[e.createElementVNode("text",{class:"icon"},"â†")]),e.createElementVNode("text",{class:"title"},"å® ç‰©è¯†åˆ«åˆ†æ")]),e.createElementVNode("view",{class:"content"},[e.createCommentVNode(" æç¤ºä¿¡æ¯ "),e.createElementVNode("view",{class:"tips-section"},[e.createElementVNode("text",{class:"tips-title"},"è¯·ä¸Šä¼ æ‚¨å® ç‰©çš„å¤šè§’åº¦ç…§ç‰‡"),e.createElementVNode("text",{class:"tips-desc"},"ä¸ºäº†æ›´å‡†ç¡®åˆ†æï¼Œå»ºè®®ä¸Šä¼ æ­£é¢ã€ä¾§é¢åŠç‰¹å†™ç…§ç‰‡")]),e.createCommentVNode(" å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ "),e.createElementVNode("view",{class:"upload-section"},[e.createElementVNode("view",{class:"image-list"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.imageList,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:a,class:"image-item"},[e.createElementVNode("image",{src:t.path,mode:"aspectFill",class:"pet-image"},null,8,["src"]),e.createElementVNode("view",{class:"delete-btn",onClick:e=>s.deleteImage(a)},[e.createElementVNode("text",{class:"delete-icon"},"Ã—")],8,["onClick"])])))),128)),e.createCommentVNode(" æ·»åŠ å›¾ç‰‡æŒ‰é’® "),s.imageList.length<s.maxImageCount?(e.openBlock(),e.createElementBlock("view",{key:0,class:"add-image-btn",onClick:a[1]||(a[1]=(...e)=>s.chooseImage&&s.chooseImage(...e))},[e.createElementVNode("text",{class:"add-icon"},"+"),e.createElementVNode("text",{class:"add-text"},"æ·»åŠ ç…§ç‰‡")])):e.createCommentVNode("v-if",!0)])]),e.createCommentVNode(" è¯†åˆ«æŒ‰é’® "),e.createElementVNode("view",{class:e.normalizeClass(["analyze-btn",{active:s.imageList.length>0}]),onClick:a[2]||(a[2]=(...e)=>s.analyzeImages&&s.analyzeImages(...e))},[e.createElementVNode("text",null,e.toDisplayString(s.isAnalyzing?"åˆ†æä¸­...":"å¼€å§‹è¯†åˆ«"),1)],2),e.createCommentVNode(" åˆ†æç»“æœå±•ç¤º "),s.showResult?(e.openBlock(),e.createElementBlock("view",{key:0,class:"result-section"},[e.createElementVNode("view",{class:"result-header"},[e.createElementVNode("text",{class:"result-title"},"è¯†åˆ«ç»“æœ")]),e.createElementVNode("view",{class:"result-content"},[e.createCommentVNode(" å® ç‰©å“ç§ "),e.createElementVNode("view",{class:"result-item"},[e.createElementVNode("text",{class:"item-label"},"å“ç§:"),e.createElementVNode("text",{class:"item-value"},e.toDisplayString(s.result.breed),1),e.createElementVNode("text",{class:"confidence"},"(ç½®ä¿¡åº¦: "+e.toDisplayString(s.result.breedConfidence)+"%)",1)]),e.createCommentVNode(" è¡€ç»Ÿè¯„ä¼° "),e.createElementVNode("view",{class:"result-item"},[e.createElementVNode("text",{class:"item-label"},"è¡€ç»Ÿçº¯åº¦è¯„ä¼°:"),e.createElementVNode("text",{class:"item-value"},e.toDisplayString(s.result.purity),1)]),e.createCommentVNode(" ç‰¹å¾æè¿° "),e.createElementVNode("view",{class:"result-item features"},[e.createElementVNode("text",{class:"item-label"},"ç‰¹å¾æè¿°:"),e.createElementVNode("text",{class:"item-value"},e.toDisplayString(s.result.features),1)]),e.createCommentVNode(" å…¶ä»–ç‰¹æ€§ "),e.createElementVNode("view",{class:"characteristics"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.result.characteristics,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:a,class:"char-item"},[e.createElementVNode("text",{class:"char-label"},e.toDisplayString(s.formatCharName(a))+":",1),e.createElementVNode("view",{class:"char-value-bar"},[e.createElementVNode("view",{class:"char-value-fill",style:e.normalizeStyle({width:t+"%"})},null,4)]),e.createElementVNode("text",{class:"char-percent"},e.toDisplayString(t)+"%",1)])))),128))]),e.createCommentVNode(" é™„åŠ è¯´æ˜ "),s.result.note?(e.openBlock(),e.createElementBlock("view",{key:0,class:"result-note"},[e.createElementVNode("text",{class:"note-title"},"é™„åŠ è¯´æ˜:"),e.createElementVNode("text",{class:"note-content"},e.toDisplayString(s.result.note),1)])):e.createCommentVNode("v-if",!0)]),e.createCommentVNode(" åˆ†äº«å’Œä¿å­˜æŒ‰é’® "),e.createElementVNode("view",{class:"action-buttons"},[e.createElementVNode("view",{class:"action-btn share",onClick:a[3]||(a[3]=(...e)=>s.shareResult&&s.shareResult(...e))},[e.createElementVNode("text",null,"åˆ†äº«ç»“æœ")]),e.createElementVNode("view",{class:"action-btn save",onClick:a[4]||(a[4]=(...e)=>s.saveResult&&s.saveResult(...e))},[e.createElementVNode("text",null,"ä¿å­˜è‡³ç›¸å†Œ")])])])):e.createCommentVNode("v-if",!0)])])}],["__file","D:/caloriesH5/CloudStorage/pages/petIdentify/index.vue"]]);const Ht=ze({__name:"my-markers",setup(t,{expose:o}){o();const s=Ge(),r=Re(),n=e.ref([]),i=e.ref(!0),l=e.ref(!1),c=e.ref(null),u=e.ref(!1),d=e.reactive({_id:"",title:"",description:"",type:"general",customTypeName:"",color:"#FF5733",isPublic:!0,latitude:0,longitude:0,radius:1,properties:{}}),m=[{value:"general",label:"ä¸€èˆ¬æ ‡è®°"},{value:"pet_friendly",label:"å® ç‰©å‹å¥½"},{value:"danger",label:"å±é™©åŒºåŸŸ"},{value:"scenic",label:"é£æ™¯ä¼˜ç¾"},{value:"pet_service",label:"å® ç‰©æœåŠ¡"},{value:"custom",label:"è‡ªå®šä¹‰"}],p=()=>__async(this,null,(function*(){var e,t;i.value=!0;try{r.userInfo&&r.user||(a("log","at pages/profile/my-markers.vue:191","ç”¨æˆ·ä¿¡æ¯æœªåŠ è½½ï¼Œå°è¯•è·å–..."),yield r.fetchUserInfo());const o=(null==(e=r.userInfo)?void 0:e._id)||(null==(t=r.user)?void 0:t._id);if(!o)return a("error","at pages/profile/my-markers.vue:199","ç”¨æˆ·IDä¸å¯ç”¨ï¼Œå¯èƒ½æœªç™»å½•"),uni.showToast({title:"è¯·å…ˆç™»å½•",icon:"none"}),void setTimeout((()=>{uni.navigateTo({url:"/pages/login/login"})}),1500);a("log","at pages/profile/my-markers.vue:214","å¼€å§‹è·å–ç”¨æˆ·æ ‡è®°ï¼Œç”¨æˆ·ID:",o);const i=yield s.fetchUserMarkers(o);n.value=i||[],a("log","at pages/profile/my-markers.vue:220","è·å–åˆ°ç”¨æˆ·æ ‡è®°æ•°é‡:",n.value.length)}catch(o){a("error","at pages/profile/my-markers.vue:222","è·å–ç”¨æˆ·æ ‡è®°å¤±è´¥:",o),uni.showToast({title:"åŠ è½½æ ‡è®°å¤±è´¥",icon:"none"})}finally{i.value=!1}}));e.onMounted((()=>{p()}));const g={markerStore:s,userStore:r,markers:n,loading:i,showDeleteConfirm:l,markerToDelete:c,showEditDialog:u,editingMarker:d,colorOptions:["#FF5733","#33FF57","#3357FF","#FF33F5","#F5FF33","#33FFF5"],markerTypes:m,loadUserMarkers:p,formatDate:e=>{if(!e)return"æœªçŸ¥æ—¶é—´";const t=new Date(e);return`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")}`},getMarkerTypeLabel:e=>{if("custom"===e.type&&e.properties&&e.properties.customTypeName)return`è‡ªå®šä¹‰: ${e.properties.customTypeName}`;const t=m.find((t=>t.value===e.type));return t?t.label:"æœªçŸ¥ç±»å‹"},getEditingTypeLabel:()=>{if("custom"===d.type&&d.customTypeName)return`è‡ªå®šä¹‰: ${d.customTypeName}`;const e=m.find((e=>e.value===d.type));return e?e.label:"è¯·é€‰æ‹©æ ‡è®°ç±»å‹"},navigateToAddMarker:()=>{uni.navigateTo({url:"/pages/map/add-marker"})},editMarker:e=>{a("log","at pages/profile/my-markers.vue:266","ç¼–è¾‘æ ‡è®°:",e),Object.assign(d,{_id:e._id,title:e.title||"",description:e.description||"",type:e.type||"general",color:e.color||"#FF5733",isPublic:!1!==e.isPublic,latitude:e.latitude||0,longitude:e.longitude||0,radius:e.radius||1,properties:e.properties||{}}),"custom"===e.type&&e.properties&&e.properties.customTypeName?d.customTypeName=e.properties.customTypeName:d.customTypeName="",u.value=!0},closeEditDialog:()=>{u.value=!1},handleTypeChange:e=>{const t=e.detail.value;d.type=m[t].value,"custom"!==d.type&&(d.customTypeName="")},handleRadiusChange:e=>{d.radius=parseFloat(e.detail.value)},selectColor:e=>{d.color=e},togglePublic:()=>{d.isPublic=!d.isPublic},saveMarker:()=>__async(this,null,(function*(){var e,t;if(!d.title)return void uni.showToast({title:"è¯·è¾“å…¥æ ‡è®°æ ‡é¢˜",icon:"none"});if("custom"===d.type&&!d.customTypeName.trim())return void uni.showToast({title:"è¯·è¾“å…¥è‡ªå®šä¹‰ç±»å‹åç§°",icon:"none"});const o={title:d.title,description:d.description,type:d.type,color:d.color,radius:d.radius,isPublic:d.isPublic,properties:__spreadValues({},d.properties)};"custom"===d.type&&(o.properties.customTypeName=d.customTypeName.trim());try{uni.showLoading({title:"ä¿å­˜ä¸­...",mask:!0});const e=yield s.updateMarker({id:d._id,data:o});if(uni.hideLoading(),e){u.value=!1;const t=n.value.findIndex((e=>e._id===d._id));-1!==t&&(n.value[t]=__spreadValues({},e)),uni.showToast({title:"æ ‡è®°å·²æ›´æ–°",icon:"success"})}else uni.showModal({title:"æ›´æ–°å¤±è´¥",content:"æœåŠ¡å™¨å¤„ç†è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åå†è¯•",showCancel:!1})}catch(r){uni.hideLoading(),a("error","at pages/profile/my-markers.vue:407","æ›´æ–°æ ‡è®°å¤±è´¥:",r);const o=(null==(t=null==(e=r.response)?void 0:e.data)?void 0:t.message)||r.message||"æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ";uni.showModal({title:"æ›´æ–°å¤±è´¥",content:o,showCancel:!1})}})),confirmDeleteMarker:e=>{c.value=e,l.value=!0},deleteMarker:()=>__async(this,null,(function*(){var e,t;if(!c.value)return;const o=c.value,r=n.value.findIndex((e=>e._id===o));r>=0&&(n.value[r].isDeleting=!0),uni.showLoading({title:"åˆ é™¤ä¸­...",mask:!0});try{const e=yield s.deleteMarker(o);uni.hideLoading(),e?(uni.showToast({title:"æ ‡è®°å·²åˆ é™¤",icon:"success",duration:2e3}),n.value=n.value.filter((e=>e._id!==o))):(r>=0&&(n.value[r].isDeleting=!1),uni.showModal({title:"åˆ é™¤å¤±è´¥",content:"æœåŠ¡å™¨å¤„ç†è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åå†è¯•",showCancel:!1}))}catch(i){uni.hideLoading(),r>=0&&(n.value[r].isDeleting=!1),a("error","at pages/profile/my-markers.vue:481","åˆ é™¤æ ‡è®°å¤±è´¥:",i);const o=(null==(t=null==(e=i.response)?void 0:e.data)?void 0:t.message)||i.message||"æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ";uni.showModal({title:"åˆ é™¤å¤±è´¥",content:o,showCancel:!1})}finally{l.value=!1,c.value=null}})),ref:e.ref,onMounted:e.onMounted,reactive:e.reactive,get useMarkerStore(){return Ge},get useUserStore(){return Re}};return Object.defineProperty(g,"__isScriptSetup",{enumerable:!1,value:!0}),g}},[["render",function(t,a,o,s,r,n){return e.openBlock(),e.createElementBlock("view",{class:"my-markers-container"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("text",{class:"page-title"},"æˆ‘çš„æ ‡è®°")]),e.createElementVNode("view",{class:"markers-list"},[e.createCommentVNode(" åŠ è½½çŠ¶æ€æ˜¾ç¤º "),s.loading?(e.openBlock(),e.createElementBlock("view",{key:0,class:"loading-container"},[e.createElementVNode("text",{class:"loading-text"},"åŠ è½½ä¸­...")])):0===s.markers.length?(e.openBlock(),e.createElementBlock(e.Fragment,{key:1},[e.createCommentVNode(" æ— æ ‡è®°æ—¶æ˜¾ç¤º "),e.createElementVNode("view",{class:"empty-state"},[e.createElementVNode("image",{class:"empty-icon",src:"/static/images/empty-markers.png",mode:"aspectFit"}),e.createElementVNode("text",{class:"empty-text"},"æ‚¨è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•æ ‡è®°"),e.createElementVNode("button",{class:"add-btn",onClick:s.navigateToAddMarker},"æ·»åŠ æ ‡è®°")])],2112)):(e.openBlock(),e.createElementBlock(e.Fragment,{key:2},[e.createCommentVNode(" æ ‡è®°åˆ—è¡¨ "),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.markers,((t,a)=>(e.openBlock(),e.createElementBlock("view",{class:"marker-item",key:t._id,onClick:e=>s.editMarker(t)},[e.createElementVNode("view",{class:"marker-icon",style:e.normalizeStyle({backgroundColor:t.color||"#FF5733"})},[e.createElementVNode("image",{class:"icon",src:t.icon||"/static/images/marker.png",mode:"aspectFit"},null,8,["src"])],4),e.createElementVNode("view",{class:"marker-info"},[e.createElementVNode("text",{class:"marker-title"},e.toDisplayString(t.title),1),e.createElementVNode("text",{class:"marker-desc"},e.toDisplayString(t.description||"æ— æè¿°"),1),e.createElementVNode("text",{class:"marker-type"},"ç±»å‹: "+e.toDisplayString(s.getMarkerTypeLabel(t)),1),e.createElementVNode("text",{class:"marker-date"},"åˆ›å»ºæ—¶é—´: "+e.toDisplayString(s.formatDate(t.createdAt)),1)]),e.createElementVNode("view",{class:"marker-actions"},[e.createElementVNode("button",{class:"action-btn delete-btn",onClick:e.withModifiers((e=>s.confirmDeleteMarker(t._id)),["stop"])},"åˆ é™¤",8,["onClick"])])],8,["onClick"])))),128))],64))]),e.createCommentVNode(" åˆ é™¤ç¡®è®¤å¼¹çª— "),s.showDeleteConfirm?(e.openBlock(),e.createElementBlock("view",{key:0,class:"confirm-dialog"},[e.createElementVNode("view",{class:"dialog-content"},[e.createElementVNode("text",{class:"dialog-title"},"ç¡®è®¤åˆ é™¤"),e.createElementVNode("text",{class:"dialog-text"},"ç¡®å®šè¦åˆ é™¤æ­¤æ ‡è®°å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚"),e.createElementVNode("view",{class:"dialog-buttons"},[e.createElementVNode("button",{class:"dialog-btn cancel-btn",onClick:a[0]||(a[0]=e=>s.showDeleteConfirm=!1)},"å–æ¶ˆ"),e.createElementVNode("button",{class:"dialog-btn confirm-btn",onClick:s.deleteMarker},"ç¡®è®¤åˆ é™¤")])])])):e.createCommentVNode("v-if",!0),e.createCommentVNode(" æ·»åŠ ç¼–è¾‘æ ‡è®°å¼¹çª— "),s.showEditDialog?(e.openBlock(),e.createElementBlock("view",{key:1,class:"edit-dialog"},[e.createElementVNode("view",{class:"edit-dialog-content"},[e.createElementVNode("view",{class:"edit-dialog-header"},[e.createElementVNode("text",{class:"edit-dialog-title"},"ç¼–è¾‘æ ‡è®°"),e.createElementVNode("text",{class:"edit-close-btn",onClick:s.closeEditDialog},"Ã—")]),e.createElementVNode("view",{class:"edit-form"},[e.createCommentVNode(" æ ‡è®°æ ‡é¢˜ "),e.createElementVNode("view",{class:"edit-form-item"},[e.createElementVNode("text",{class:"edit-form-label"},[e.createTextVNode("æ ‡è®°æ ‡é¢˜"),e.createElementVNode("text",{class:"required"},"*")]),e.withDirectives(e.createElementVNode("input",{class:"edit-form-input",type:"text","onUpdate:modelValue":a[1]||(a[1]=e=>s.editingMarker.title=e),placeholder:"è¯·è¾“å…¥æ ‡è®°æ ‡é¢˜",maxlength:"50"},null,512),[[e.vModelText,s.editingMarker.title]])]),e.createCommentVNode(" æ ‡è®°æè¿° "),e.createElementVNode("view",{class:"edit-form-item"},[e.createElementVNode("text",{class:"edit-form-label"},"æ ‡è®°æè¿°"),e.withDirectives(e.createElementVNode("textarea",{class:"edit-form-textarea","onUpdate:modelValue":a[2]||(a[2]=e=>s.editingMarker.description=e),placeholder:"è¯·è¾“å…¥æ ‡è®°æè¿°",maxlength:"200"},null,512),[[e.vModelText,s.editingMarker.description]])]),e.createCommentVNode(" æ ‡è®°ç±»å‹ "),e.createElementVNode("view",{class:"edit-form-item"},[e.createElementVNode("text",{class:"edit-form-label"},"æ ‡è®°ç±»å‹"),e.createElementVNode("picker",{class:"edit-form-picker",range:s.markerTypes,"range-key":"label",onChange:s.handleTypeChange},[e.createElementVNode("view",{class:"edit-picker-value"},e.toDisplayString(s.getEditingTypeLabel()),1)],32)]),e.createCommentVNode(" è‡ªå®šä¹‰ç±»å‹åç§° "),"custom"===s.editingMarker.type?(e.openBlock(),e.createElementBlock("view",{key:0,class:"edit-form-item"},[e.createElementVNode("text",{class:"edit-form-label"},"è‡ªå®šä¹‰ç±»å‹åç§°"),e.withDirectives(e.createElementVNode("input",{class:"edit-form-input",type:"text","onUpdate:modelValue":a[3]||(a[3]=e=>s.editingMarker.customTypeName=e),placeholder:"è¯·è¾“å…¥è‡ªå®šä¹‰ç±»å‹åç§°",maxlength:"20"},null,512),[[e.vModelText,s.editingMarker.customTypeName]])])):e.createCommentVNode("v-if",!0),e.createCommentVNode(" æ ‡è®°é¢œè‰² "),e.createElementVNode("view",{class:"edit-form-item"},[e.createElementVNode("text",{class:"edit-form-label"},"æ ‡è®°é¢œè‰²"),e.createElementVNode("view",{class:"edit-color-selector"},[(e.openBlock(),e.createElementBlock(e.Fragment,null,e.renderList(s.colorOptions,((t,a)=>e.createElementVNode("view",{key:a,class:e.normalizeClass(["edit-color-item",{active:s.editingMarker.color===t}]),style:e.normalizeStyle({backgroundColor:t}),onClick:e=>s.selectColor(t)},null,14,["onClick"]))),64))])]),e.createCommentVNode(" è¦†ç›–åŠå¾„ "),e.createElementVNode("view",{class:"edit-form-item"},[e.createElementVNode("text",{class:"edit-form-label"},"è¦†ç›–åŠå¾„ (åƒç±³)"),e.createElementVNode("slider",{class:"edit-radius-slider",min:.1,max:10,step:.1,value:s.editingMarker.radius||1,"show-value":!0,onChange:s.handleRadiusChange},null,40,["value"]),e.createElementVNode("text",{class:"edit-radius-value"},e.toDisplayString(s.editingMarker.radius||1)+"km",1)]),e.createCommentVNode(" å…¬å¼€è®¾ç½® "),e.createElementVNode("view",{class:"edit-form-item checkbox-item"},[e.createElementVNode("checkbox",{checked:s.editingMarker.isPublic,onClick:s.togglePublic},null,8,["checked"]),e.createElementVNode("text",{class:"checkbox-label"},"å…¬å¼€æ­¤æ ‡è®°ï¼ˆå…è®¸å…¶ä»–ç”¨æˆ·çœ‹åˆ°ï¼‰")]),e.createCommentVNode(" æŒ‰é’®æ“ä½œ "),e.createElementVNode("view",{class:"edit-form-actions"},[e.createElementVNode("button",{class:"edit-btn cancel-btn",onClick:s.closeEditDialog},"å–æ¶ˆ"),e.createElementVNode("button",{class:"edit-btn save-btn",onClick:s.saveMarker},"ä¿å­˜")])])])])):e.createCommentVNode("v-if",!0)])}],["__file","D:/caloriesH5/CloudStorage/pages/profile/my-markers.vue"]]);var qt=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,62,0,62,0,63,52,53,54,55,56,57,58,59,60,61,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,0,0,0,0,63,0,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51];const Gt={getRandomValues(e){if(!(e instanceof Int8Array||e instanceof Uint8Array||e instanceof Int16Array||e instanceof Uint16Array||e instanceof Int32Array||e instanceof Uint32Array||e instanceof Uint8ClampedArray))throw new Error("Expected an integer array");if(e.byteLength>65536)throw new Error("Can only request a maximum of 65536 bytes");return function(e,t){for(var a,o=e.length,s="="===e[o-2]?2:"="===e[o-1]?1:0,r=0,n=o-s&4294967292,i=0;i<n;i+=4)a=qt[e.charCodeAt(i)]<<18|qt[e.charCodeAt(i+1)]<<12|qt[e.charCodeAt(i+2)]<<6|qt[e.charCodeAt(i+3)],t[r++]=a>>16&255,t[r++]=a>>8&255,t[r++]=255&a;1===s&&(a=qt[e.charCodeAt(i)]<<10|qt[e.charCodeAt(i+1)]<<4|qt[e.charCodeAt(i+2)]>>2,t[r++]=a>>8&255,t[r++]=255&a),2===s&&(a=qt[e.charCodeAt(i)]<<2|qt[e.charCodeAt(i+1)]>>4,t[r++]=255&a)}(t("DCloud-Crypto").getRandomValues(e.byteLength),new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),e}};function Qt(e,t,o){return __async(this,null,(function*(){const s=function(e){const t="abcdefghijklmnopqrstuvwxyz0123456789";let a="";for(let o=0;o<e;o++)a+=t.charAt(Math.floor(36*Math.random()));return a}(8),r=Math.floor(Date.now()/1e3).toString(),n=JSON.stringify(t),i=e+n+s+r;try{const e=yield function(e,t){return __async(this,null,(function*(){try{const a=new TextEncoder,o=a.encode(t),s=a.encode(e),r=yield Gt.subtle.importKey("raw",o,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),n=yield Gt.subtle.sign("HMAC",r,s);return Array.from(new Uint8Array(n)).map((e=>e.toString(16).padStart(2,"0"))).join("")}catch(o){throw a("error","at utils/vetmew.js:88","HMACè®¡ç®—å¤±è´¥ (Web Crypto API)",o),o}}))}(i,o),t=function(e){const t=Array.from(e).map((e=>String.fromCharCode(e))).join("");return btoa(t)}(new Uint8Array(e.match(/.{1,2}/g).map((e=>parseInt(e,16)))));return a("log","at utils/vetmew.js:123","ç­¾åè®¡ç®—æˆåŠŸ",{nonce:s,timestamp:r,signature:t,signStr:i}),{signature:t,timestamp:r,nonce:s}}catch(l){throw a("error","at utils/vetmew.js:136","ç­¾åç”Ÿæˆå¤±è´¥:",l),l}}))}function Kt(e){return __async(this,arguments,(function*(e,t={}){const o=t.apiKey||"vmb1c7f72adc9473f7",s=t.apiSecret||"44yth8axrytm8ux23f53c78bjw3kg20h",r=t.apiPath||"/open/v1/chat",n="/vetmew-api"+r;try{let t;a("log","at utils/vetmewProxy.js:20","å‡†å¤‡è°ƒç”¨APIï¼Œè¯·æ±‚æ•°æ®:",e);try{t=yield Qt(r,e,s)}catch(i){throw a("error","at utils/vetmewProxy.js:27","ç­¾åç”Ÿæˆå¤±è´¥:",i),i}const u={"Content-Type":"application/json","X-ApiKey":o,"X-Timestamp":t.timestamp,"X-Nonce":t.nonce,"X-Signature":t.signature};a("log","at utils/vetmewProxy.js:40","å‘é€APIè¯·æ±‚",{url:n,headers:u});const d=yield fetch(n,{method:"POST",headers:u,body:JSON.stringify(e)});if(!d.ok)throw new Error(`APIè¯·æ±‚å¤±è´¥: ${d.status} ${d.statusText}`);const m=yield d.text();if(a("log","at utils/vetmewProxy.js:58","æ¥æ”¶åˆ°åŸå§‹å“åº”"),m.includes("data:")){a("log","at utils/vetmewProxy.js:62","æ£€æµ‹åˆ°SSEæµå¼å“åº”");const e=m.split("\n\n");a("log","at utils/vetmewProxy.js:66",`è¯†åˆ«åˆ°${e.length}ä¸ªå“åº”ç‰‡æ®µ`);let t="",o="";for(const s of e){const e=s.trim();if(e&&e.startsWith("data:"))try{if("data: [DONE]"===e){a("log","at utils/vetmewProxy.js:79","æµå¼å“åº”å®Œæˆ");break}const s=e.substring(5).trim(),r=JSON.parse(s);r.msg&&(t+=r.msg),r.conversation_id&&!o&&(o=r.conversation_id)}catch(l){a("warn","at utils/vetmewProxy.js:97","è§£æSSEç‰‡æ®µå¤±è´¥:",l,e)}}return a("log","at utils/vetmewProxy.js:101","å®Œæ•´å“åº”æ¶ˆæ¯:",t),{code:0,message:"æˆåŠŸ",data:t,conversation_id:o,streaming:!0}}try{const e=JSON.parse(m);return a("log","at utils/vetmewProxy.js:115","è§£æä¸ºæ ‡å‡†JSONå“åº”:",e),e}catch(c){return a("error","at utils/vetmewProxy.js:118","JSONè§£æé”™è¯¯:",c),{code:9999,message:"æœåŠ¡å™¨è¿”å›äº†æ— æ•ˆçš„æ•°æ®æ ¼å¼",data:null,rawResponse:m}}}catch(u){return a("error","at utils/vetmewProxy.js:128","æ±ªå–µçµçµAPIè°ƒç”¨å‡ºé”™:",u),{code:9999,message:`APIè°ƒç”¨å¤±è´¥: ${u.message}`,data:null}}}))}const Yt=ze({setup(){const o=e.ref([]),s=e.ref(""),r=e.ref(!1),n=e.ref(0),i=e.ref(!1),l=e.ref(""),c=e.ref(""),u=e.ref(""),d=e.ref(""),m=e.ref(0),p=e.computed((()=>{const e="undefined"!=typeof window&&"undefined"!=typeof document,o="undefined"!=typeof uni&&void 0===t;try{const t=uni.getSystemInfoSync(),s=t.platform,r=t.uniPlatform;return a("log","at pages/ai-medical/index.vue:162","ç¯å¢ƒæ£€æµ‹ - å¹³å°:",s,"è®¾å¤‡:",t.model,"uniå¹³å°:",r),a("log","at pages/ai-medical/index.vue:163","æ˜¯å¦H5ç¯å¢ƒ:",e,"æ˜¯å¦UniApp H5:",o),e||"web"===s||"web"===r}catch(s){return a("error","at pages/ai-medical/index.vue:168","è·å–ç³»ç»Ÿä¿¡æ¯å¤±è´¥:",s),e}})),g=[{name:"é—®è¯ŠæœåŠ¡",path:"/open/v1/chat",requiresPetInfo:!0,requiresImage:!1,isConsultation:!0},{name:"å“ç§è¯†åˆ«",path:"/open/v1/breed-recognition",requiresPetInfo:!1,requiresImage:!0,isConsultation:!1},{name:"æƒ…ç»ªåˆ†æ",path:"/open/v1/emotion-recognition",requiresPetInfo:!1,requiresImage:!0,isConsultation:!1},{name:"ç²ªä¾¿åˆ†æ",path:"/open/v1/feces-recognition",requiresPetInfo:!0,requiresImage:!0,isConsultation:!1},{name:"çš®è‚¤åˆ†æ",path:"/open/v1/skin-recognition",requiresPetInfo:!0,requiresImage:!0,isConsultation:!1},{name:"å°¿æ¶²åˆ†æ",path:"/open/v1/urine-recognition",requiresPetInfo:!0,requiresImage:!0,isConsultation:!1},{name:"å‘•åç‰©åˆ†æ",path:"/open/v1/vomitus-recognition",requiresPetInfo:!0,requiresImage:!0,isConsultation:!1},{name:"è€³é“åˆ†æ",path:"/open/v1/ear-canal-recognition",requiresPetInfo:!0,requiresImage:!0,isConsultation:!1}],v=e.computed((()=>g[m.value])),h=e.computed((()=>v.value.isConsultation)),f=["ç‹—","çŒ«"],y=e.ref(0),w={"ç‹—":1,"çŒ«":2},k=["å…¬","æ¯"],E=e.ref(0),N={"å…¬":1,"æ¯":2},V=["æœªç»è‚²","å·²ç»è‚²"],S=e.ref(0),_={"æœªç»è‚²":1,"å·²ç»è‚²":2},C=e.reactive({nick_name:"",breed:1,birth:"2023-01-01",gender:1,fertility:1}),b="vmb1c7f72adc9473f7",P="44yth8axrytm8ux23f53c78bjw3kg20h",x=(e,t)=>{o.value.push({type:"user",content:"å›¾ç‰‡æ¶ˆæ¯",imageUrl:e}),U(),A(t,e)},I=e=>new Promise(((t,o)=>{if(p.value)return a("log","at pages/ai-medical/index.vue:467","æ£€æµ‹åˆ°H5ç¯å¢ƒï¼Œä¸è½¬æ¢base64ï¼Œä½¿ç”¨URLæ–¹å¼"),void t("");try{if("function"!=typeof uni.getFileSystemManager)return a("warn","at pages/ai-medical/index.vue:476","getFileSystemManagerä¸å¯ç”¨ï¼Œä½¿ç”¨URLæ–¹å¼"),void t("");uni.getFileSystemManager().readFile({filePath:e,encoding:"base64",success:e=>{a("log","at pages/ai-medical/index.vue:486","base64è½¬æ¢æˆåŠŸ"),t(e.data)},fail:e=>{a("error","at pages/ai-medical/index.vue:490","è¯»å–å›¾ç‰‡å¤±è´¥:",e),t("")}})}catch(s){a("error","at pages/ai-medical/index.vue:496","è½¬æ¢base64å‘ç”Ÿé”™è¯¯:",s),t("")}})),T=()=>__async(this,null,(function*(){r.value=!0,c.value&&(o.value.push({type:"user",content:"å›¾ç‰‡åˆ†æè¯·æ±‚",imageUrl:c.value}),U());try{const t={};if(u.value)t.image=u.value;else if(c.value){if(!c.value.startsWith("http"))return uni.showToast({title:"å›¾ç‰‡æ ¼å¼ä¸æ”¯æŒï¼Œè¯·æä¾›æœ‰æ•ˆURL",icon:"none"}),void(r.value=!1);t.url=c.value}v.value.requiresPetInfo&&(Object.assign(t,{breed:C.breed,birth:C.birth,gender:C.gender,fertility:C.fertility}),"å“ç§è¯†åˆ«"!==v.value.name&&"æƒ…ç»ªåˆ†æ"!==v.value.name&&(t.nick_name=C.nick_name)),a("log","at pages/ai-medical/index.vue:612","å‡†å¤‡å‘é€åˆ†æè¯·æ±‚:",t);const s=yield Kt(t,{apiKey:b,apiSecret:P,apiPath:v.value.path});if(a("log","at pages/ai-medical/index.vue:621","APIå“åº”:",s),s&&0===s.code){let t="";if("string"==typeof s.data)try{const e=JSON.parse(s.data);t=M(e,v.value.name)}catch(e){t=s.data||"åˆ†æå®Œæˆ"}else t=M(s.data,v.value.name);o.value.push({type:"ai",content:t})}else B(s)}catch(t){a("error","at pages/ai-medical/index.vue:656","APIè°ƒç”¨å¼‚å¸¸:",t),o.value.push({type:"ai",content:"ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œåé‡è¯•ã€‚"})}finally{r.value=!1,U()}})),M=(e,t)=>{if(!e)return"åˆ†æå®Œæˆ";if("string"==typeof e)return e;if(e.text)return e.text;try{if(Array.isArray(e)&&e.length>0&&e[0].text)return e[0].text;if(e.contents){if("string"==typeof e.contents)return e.contents;if(Array.isArray(e.contents)&&e.contents.length>0)return e.contents.map((e=>e.text||e.content||JSON.stringify(e))).join("\n")}if(e.content)return e.content}catch(o){a("error","at pages/ai-medical/index.vue:704","è§£æåµŒå¥—JSONå‡ºé”™:",o)}switch(t){case"å“ç§è¯†åˆ«":if(e.breed)return`è¯†åˆ«ç»“æœï¼š${e.breed}\nå¯ä¿¡åº¦ï¼š${(100*e.confidence).toFixed(2)}%`;break;case"æƒ…ç»ªåˆ†æ":if(e.emotion)return`æƒ…ç»ªåˆ†æç»“æœï¼š${e.emotion}\nå¯ä¿¡åº¦ï¼š${(100*e.confidence).toFixed(2)}%`;break;case"ç²ªä¾¿åˆ†æ":case"çš®è‚¤åˆ†æ":case"å°¿æ¶²åˆ†æ":case"å‘•åç‰©åˆ†æ":case"è€³é“åˆ†æ":let t="";return e.conclusion&&(t+=`è¯Šæ–­ç»“è®ºï¼š${e.conclusion}\n\n`),e.analysis&&(t+=`è¯¦ç»†åˆ†æï¼š${e.analysis}\n\n`),e.suggestion&&(t+=`å»ºè®®ï¼š${e.suggestion}`),t||D(e)}return D(e)},D=e=>{try{let a,o="string"==typeof e?e:JSON.stringify(e);try{a="object"==typeof e?e:JSON.parse(o)}catch(t){return o}if(a.text)return a.text;if(a.message)return a.message;if(a.content)return a.content;if(a.data)return D(a.data);if(a.choices&&Array.isArray(a.choices)&&a.choices.length>0){const e=a.choices[0];if(e.text)return e.text;if(e.message&&e.message.content)return e.message.content}return o=JSON.stringify(a,null,2),o=o.replace(/^{|}$/g,""),o=o.replace(/^\s*"([^"]+)":\s*/gm,"$1: "),o=o.replace(/,$/gm,""),o=o.replace(/"msg_id":[^,}]+,?/g,""),o}catch(t){return a("error","at pages/ai-medical/index.vue:783","æ¸…ç†JSONå‡ºé”™:",t),"åˆ†æå®Œæˆï¼Œè¯·æŸ¥çœ‹ç»“æœ"}},A=(e,t="")=>__async(this,null,(function*(){if(!r.value){r.value=!0;try{const n={breed:C.breed,birth:C.birth,gender:C.gender,nick_name:C.nick_name,fertility:C.fertility};if(e&&e.length>0)n.image=e;else if(t&&t.startsWith("http"))n.url=t;else{if(!c.value||!c.value.startsWith("http"))return uni.showToast({title:"æ— æ³•å¤„ç†å›¾ç‰‡ï¼Œè¯·å°è¯•è¾“å…¥URL",icon:"none"}),void(r.value=!1);n.url=c.value}l.value&&(n.conversation_id=l.value),a("log","at pages/ai-medical/index.vue:927","å‡†å¤‡å‘é€å›¾ç‰‡è¯·æ±‚");const i=yield Kt(n,{apiKey:b,apiSecret:P,apiPath:v.value.path});if(a("log","at pages/ai-medical/index.vue:936","APIå“åº”:",i),i&&0===i.code){i.conversation_id&&(l.value=i.conversation_id);let e="";if("string"==typeof i.data)try{const t=JSON.parse(i.data);e=M(t,v.value.name)}catch(s){e=i.data||"æˆ‘å·²åˆ†ææ‚¨ä¸Šä¼ çš„å›¾ç‰‡..."}else e=M(i.data,v.value.name);o.value.push({type:"ai",content:e})}else B(i)}catch(n){a("error","at pages/ai-medical/index.vue:975","å›¾ç‰‡APIè°ƒç”¨å¼‚å¸¸:",n),o.value.push({type:"ai",content:"å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚"})}finally{r.value=!1,U()}}})),B=e=>{let t="æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚";if(e&&e.code)switch(e.code){case 6001:t="æ— æ•ˆçš„APIå¯†é’¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚";break;case 6002:t="è°ƒç”¨è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•ã€‚";break;case 6003:t="è°ƒç”¨æ¬¡æ•°ä¸è¶³ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚";break;case 6004:case 6005:t="ç­¾åéªŒè¯å¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚";break;case 6006:t="è¯·æ±‚å‚æ•°æ— æ•ˆï¼Œè¯·æ£€æŸ¥è¾“å…¥ã€‚";break;case 6007:t="ä¼šè¯å·²ç»“æŸï¼Œè¯·é‡æ–°å¼€å§‹å¯¹è¯ã€‚";break;case 6008:t="ç³»ç»Ÿæ­£å¿™ï¼Œè¯·ç¨åå†è¯•ã€‚";break;case 6009:t="æ‚¨çš„è¾“å…¥åŒ…å«æ•æ„Ÿè¯æ±‡ï¼Œè¯·è°ƒæ•´åé‡è¯•ã€‚";break;case 9999:e.rawResponse?(a("log","at pages/ai-medical/index.vue:1021","åŸå§‹é”™è¯¯å“åº”:",e.rawResponse),t=e.rawResponse.includes("<!DOCTYPE html>")?"æœåŠ¡å™¨è¿”å›äº†HTMLé¡µé¢è€Œä¸æ˜¯APIå“åº”ï¼Œå¯èƒ½æ˜¯ä»£ç†é…ç½®é”™è¯¯æˆ–æœåŠ¡å™¨å¼‚å¸¸ã€‚":"æœåŠ¡å™¨è¿”å›æ ¼å¼é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚"):t=`æœåŠ¡å™¨è¿æ¥å¤±è´¥: ${e.message}`;break;default:t=`æœåŠ¡å™¨è¿”å›é”™è¯¯: ${e.code||"æœªçŸ¥é”™è¯¯"}`}o.value.push({type:"ai",content:t}),a("error","at pages/ai-medical/index.vue:1042","APIè¯·æ±‚é”™è¯¯:",e)},U=()=>{e.nextTick((()=>{n.value=999999}))};return{messages:o,inputMessage:s,isLoading:r,scrollTop:n,chatStarted:i,petInfo:C,petTypes:f,petTypeIndex:y,genders:k,genderIndex:E,fertilityOptions:V,fertilityIndex:S,imageUrl:c,imageUrlInput:d,isH5Platform:p,serviceTypes:g,selectedServiceIndex:m,currentService:v,isConsultationService:h,goBack:()=>{uni.navigateBack()},sendMessage:()=>__async(this,null,(function*(){if(!s.value.trim()||r.value||!h.value)return;const e=s.value.trim();s.value="",o.value.push({type:"user",content:e}),U(),r.value=!0;try{const s={msg:e,breed:C.breed,birth:C.birth,gender:C.gender,nick_name:C.nick_name,fertility:C.fertility};l.value&&(s.conversation_id=l.value,a("log","at pages/ai-medical/index.vue:822","ä½¿ç”¨ç°æœ‰ä¼šè¯IDç»§ç»­å¯¹è¯:",l.value)),a("log","at pages/ai-medical/index.vue:825","å‡†å¤‡å‘é€è¯·æ±‚:",s);const r=yield Kt(s,{apiKey:b,apiSecret:P,apiPath:v.value.path});if(a("log","at pages/ai-medical/index.vue:834","APIå“åº”:",r),r&&0===r.code){r.conversation_id&&(l.value=r.conversation_id,a("log","at pages/ai-medical/index.vue:843","ä¿å­˜ä¼šè¯ID:",l.value));let e="";if("string"==typeof r.data)try{const t=JSON.parse(r.data);e=M(t,v.value.name)}catch(t){e=r.data||"æˆ‘æ­£åœ¨åˆ†ææ‚¨çš„é—®é¢˜..."}else e=M(r.data,v.value.name);o.value.push({type:"ai",content:e})}else B(r)}catch(n){a("error","at pages/ai-medical/index.vue:874","APIè°ƒç”¨å¼‚å¸¸:",n),o.value.push({type:"ai",content:"ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œåé‡è¯•ã€‚"})}finally{r.value=!1,U()}})),loadMoreHistory:()=>{},onPetTypeChange:e=>{y.value=e.detail.value,C.breed=w[f[y.value]]},onBirthChange:e=>{C.birth=e.detail.value},onGenderChange:e=>{E.value=e.detail.value,C.gender=N[k[E.value]]},onFertilityChange:e=>{S.value=e.detail.value,C.fertility=_[V[S.value]]},startChat:()=>{!v.value.requiresPetInfo||C.nick_name?!v.value.requiresImage||u.value?(i.value=!0,h.value?o.value.push({type:"ai",content:`æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIå® ç‰©åŒ»ç”ŸåŠ©æ‰‹ã€‚è¯·é—®${C.nick_name}æœ‰ä»€ä¹ˆå¥åº·é—®é¢˜å‘¢ï¼Ÿæˆ‘ä¼šå°½åŠ›å¸®åŠ©æ‚¨ã€‚`}):T()):uni.showToast({title:"è¯·ä¸Šä¼ å›¾ç‰‡",icon:"none"}):uni.showToast({title:"è¯·è¾“å…¥å® ç‰©æ˜µç§°",icon:"none"})},selectService:e=>{m.value=e},chooseImage:()=>__async(this,null,(function*(){try{const t=yield uni.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"]});if(t.tempFilePaths&&t.tempFilePaths.length>0)if(c.value=t.tempFilePaths[0],d.value="",p.value)try{const e=yield uni.chooseFile({count:1,extension:[".png",".jpg",".jpeg"],type:"image"});if(e.tempFiles&&e.tempFiles.length>0){const t=e.tempFiles[0],o=new FileReader;o.onload=e=>{const t=e.target.result.split(",")[1];u.value=t},o.onerror=()=>{a("error","at pages/ai-medical/index.vue:326","è¯»å–æ–‡ä»¶å¤±è´¥"),uni.showToast({title:"å›¾ç‰‡è¯»å–å¤±è´¥ï¼Œè¯·å°è¯•è¾“å…¥URL",icon:"none"})},o.readAsDataURL(t)}}catch(e){a("error","at pages/ai-medical/index.vue:335","H5ç¯å¢ƒä¸‹è·å–æ–‡ä»¶å¤±è´¥:",e),uni.showToast({title:"H5ç¯å¢ƒä¸‹è¯·ä½¿ç”¨å›¾ç‰‡URLæˆ–ä½¿ç”¨Appç‰ˆæœ¬",icon:"none"})}else{const e=yield I(t.tempFilePaths[0]);u.value=e}}catch(t){a("error","at pages/ai-medical/index.vue:349","é€‰æ‹©å›¾ç‰‡å¤±è´¥:",t),uni.showToast({title:"é€‰æ‹©å›¾ç‰‡å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–æ–¹å¼",icon:"none"})}})),chooseAdditionalImage:()=>__async(this,null,(function*(){if(!r.value)try{const t=yield uni.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"]});if(t.tempFilePaths&&t.tempFilePaths.length>0){const o=t.tempFilePaths[0];let s="";if(p.value)try{const e=yield uni.chooseFile({count:1,extension:[".png",".jpg",".jpeg"],type:"image"});if(e.tempFiles&&e.tempFiles.length>0){const t=e.tempFiles[0],r=new FileReader;return r.onload=e=>{s=e.target.result.split(",")[1],x(o,s)},r.onerror=()=>{a("error","at pages/ai-medical/index.vue:416","è¯»å–æ–‡ä»¶å¤±è´¥"),x(o,"")},void r.readAsDataURL(t)}}catch(e){return a("error","at pages/ai-medical/index.vue:424","H5ç¯å¢ƒä¸‹è·å–æ–‡ä»¶å¤±è´¥:",e),void x(o,"")}else s=yield I(o);x(o,s)}}catch(t){a("error","at pages/ai-medical/index.vue:438","é€‰æ‹©å›¾ç‰‡å¤±è´¥:",t),uni.showToast({title:"é€‰æ‹©å›¾ç‰‡å¤±è´¥",icon:"none",duration:2e3})}})),previewUrlImage:()=>{d.value&&(d.value.startsWith("http")?(c.value=d.value,u.value="",uni.showToast({title:"å›¾ç‰‡URLå·²è®¾ç½®",icon:"success"})):uni.showToast({title:"è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡URL",icon:"none"}))}}}},[["render",function(t,a,o,s,r,n){return e.openBlock(),e.createElementBlock("view",{class:"ai-medical-container"},[e.createCommentVNode(" é¡¶éƒ¨å¯¼èˆªæ  "),e.createElementVNode("view",{class:"nav-bar"},[e.createElementVNode("view",{class:"back-btn",onClick:a[0]||(a[0]=(...e)=>s.goBack&&s.goBack(...e))},[e.createElementVNode("text",{class:"icon"},"â†")]),e.createElementVNode("text",{class:"title"},"AIå® ç‰©åŒ»ç–—åŠ©æ‰‹")]),e.createCommentVNode(" æœåŠ¡ç±»å‹é€‰æ‹©å™¨ "),s.chatStarted?e.createCommentVNode("v-if",!0):(e.openBlock(),e.createElementBlock("view",{key:0,class:"service-selector"},[e.createElementVNode("view",{class:"selector-title"},"é€‰æ‹©æœåŠ¡ç±»å‹"),e.createElementVNode("scroll-view",{class:"service-list","scroll-x":"true"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.serviceTypes,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:a,class:e.normalizeClass(["service-item",{active:s.selectedServiceIndex===a}]),onClick:e=>s.selectService(a)},[e.createElementVNode("text",null,e.toDisplayString(t.name),1)],10,["onClick"])))),128))])])),e.createCommentVNode(" å® ç‰©ä¿¡æ¯é…ç½®è¡¨å• "),s.chatStarted?e.createCommentVNode("v-if",!0):(e.openBlock(),e.createElementBlock("view",{key:1,class:"pet-info-form"},[e.createElementVNode("view",{class:"form-title"},"å¡«å†™"+e.toDisplayString(s.serviceTypes[s.selectedServiceIndex].name)+"æ‰€éœ€ä¿¡æ¯",1),e.createCommentVNode(" å® ç‰©åŸºæœ¬ä¿¡æ¯ï¼Œé—®è¯Šå’Œéƒ¨åˆ†åˆ†ææœåŠ¡éœ€è¦ "),s.currentService.requiresPetInfo?(e.openBlock(),e.createElementBlock(e.Fragment,{key:0},[e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"å® ç‰©æ˜µç§°"),e.withDirectives(e.createElementVNode("input",{type:"text","onUpdate:modelValue":a[1]||(a[1]=e=>s.petInfo.nick_name=e),placeholder:"è¯·è¾“å…¥å® ç‰©æ˜µç§°"},null,512),[[e.vModelText,s.petInfo.nick_name]])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"å® ç‰©ç±»å‹"),e.createElementVNode("picker",{onChange:a[2]||(a[2]=(...e)=>s.onPetTypeChange&&s.onPetTypeChange(...e)),value:s.petTypeIndex,range:s.petTypes},[e.createElementVNode("view",{class:"picker-value"},e.toDisplayString(s.petTypes[s.petTypeIndex]),1)],40,["value","range"])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"å‡ºç”Ÿæ—¥æœŸ"),e.createElementVNode("picker",{mode:"date",value:s.petInfo.birth,onChange:a[3]||(a[3]=(...e)=>s.onBirthChange&&s.onBirthChange(...e))},[e.createElementVNode("view",{class:"picker-value"},e.toDisplayString(s.petInfo.birth||"è¯·é€‰æ‹©å‡ºç”Ÿæ—¥æœŸ"),1)],40,["value"])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"æ€§åˆ«"),e.createElementVNode("picker",{onChange:a[4]||(a[4]=(...e)=>s.onGenderChange&&s.onGenderChange(...e)),value:s.genderIndex,range:s.genders},[e.createElementVNode("view",{class:"picker-value"},e.toDisplayString(s.genders[s.genderIndex]),1)],40,["value","range"])]),e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"ç”Ÿè‚²çŠ¶æ€"),e.createElementVNode("picker",{onChange:a[5]||(a[5]=(...e)=>s.onFertilityChange&&s.onFertilityChange(...e)),value:s.fertilityIndex,range:s.fertilityOptions},[e.createElementVNode("view",{class:"picker-value"},e.toDisplayString(s.fertilityOptions[s.fertilityIndex]),1)],40,["value","range"])])],64)):e.createCommentVNode("v-if",!0),e.createCommentVNode(" å›¾ç‰‡ä¸Šä¼ åŒºåŸŸï¼Œéé—®è¯ŠæœåŠ¡éœ€è¦ "),s.currentService.requiresImage?(e.openBlock(),e.createElementBlock(e.Fragment,{key:1},[e.createElementVNode("view",{class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"ä¸Šä¼ å›¾ç‰‡"),e.createElementVNode("view",{class:"image-upload-area",onClick:a[6]||(a[6]=(...e)=>s.chooseImage&&s.chooseImage(...e))},[s.imageUrl?(e.openBlock(),e.createElementBlock("image",{key:0,src:s.imageUrl,mode:"aspectFit",class:"preview-image"},null,8,["src"])):(e.openBlock(),e.createElementBlock("view",{key:1,class:"upload-placeholder"},[e.createElementVNode("text",{class:"upload-icon"},"+"),e.createElementVNode("text",{class:"upload-text"},"ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡")]))])]),e.createCommentVNode(" H5ç¯å¢ƒä¸‹æ·»åŠ å›¾ç‰‡URLè¾“å…¥é€‰é¡¹ "),s.isH5Platform?(e.openBlock(),e.createElementBlock("view",{key:0,class:"form-item"},[e.createElementVNode("text",{class:"form-label"},"æˆ–è¾“å…¥å›¾ç‰‡URL"),e.withDirectives(e.createElementVNode("input",{type:"text","onUpdate:modelValue":a[7]||(a[7]=e=>s.imageUrlInput=e),placeholder:"https://example.com/image.jpg"},null,512),[[e.vModelText,s.imageUrlInput]]),s.imageUrlInput?(e.openBlock(),e.createElementBlock("view",{key:0,class:"url-preview-btn",onClick:a[8]||(a[8]=(...e)=>s.previewUrlImage&&s.previewUrlImage(...e))},"é¢„è§ˆ")):e.createCommentVNode("v-if",!0)])):e.createCommentVNode("v-if",!0)],64)):e.createCommentVNode("v-if",!0),e.createElementVNode("view",{class:"start-chat-btn",onClick:a[9]||(a[9]=(...e)=>s.startChat&&s.startChat(...e))},[e.createElementVNode("text",null,"å¼€å§‹"+e.toDisplayString(s.currentService.name),1)])])),e.createCommentVNode(" èŠå¤©ç•Œé¢ "),s.chatStarted?(e.openBlock(),e.createElementBlock("view",{key:2,class:"chat-interface"},[e.createElementVNode("scroll-view",{class:"chat-container","scroll-y":"true","scroll-top":s.scrollTop,onScrolltoupper:a[10]||(a[10]=(...e)=>s.loadMoreHistory&&s.loadMoreHistory(...e))},[e.createElementVNode("view",{class:"chat-messages"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.messages,((t,a)=>(e.openBlock(),e.createElementBlock("view",{key:a,class:e.normalizeClass(["message-item",t.type])},[t.imageUrl?(e.openBlock(),e.createElementBlock("image",{key:0,src:t.imageUrl,mode:"widthFix",class:"message-image"},null,8,["src"])):e.createCommentVNode("v-if",!0),e.createElementVNode("view",{class:"message-content"},[e.createElementVNode("text",null,e.toDisplayString(t.content),1)])],2)))),128))])],40,["scroll-top"]),e.createCommentVNode(" è¾“å…¥åŒºåŸŸ "),e.createElementVNode("view",{class:"input-area"},[e.createElementVNode("view",{class:"input-box"},[e.withDirectives(e.createElementVNode("input",{type:"text","onUpdate:modelValue":a[11]||(a[11]=e=>s.inputMessage=e),placeholder:"è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...",onConfirm:a[12]||(a[12]=(...e)=>s.sendMessage&&s.sendMessage(...e)),disabled:s.isLoading||!s.isConsultationService},null,40,["disabled"]),[[e.vModelText,s.inputMessage]]),e.createElementVNode("view",{class:e.normalizeClass(["send-btn",{disabled:s.isLoading||!s.isConsultationService}]),onClick:a[13]||(a[13]=(...e)=>s.sendMessage&&s.sendMessage(...e))},[e.createElementVNode("text",{class:"icon"},e.toDisplayString(s.isLoading?"âŒ›":"â¤"),1)],2),e.createCommentVNode(" å›¾ç‰‡ä¸Šä¼ æŒ‰é’® "),s.isConsultationService?(e.openBlock(),e.createElementBlock("view",{key:0,class:"upload-btn",onClick:a[14]||(a[14]=(...e)=>s.chooseAdditionalImage&&s.chooseAdditionalImage(...e))},[e.createElementVNode("text",{class:"icon"},"ğŸ“·")])):e.createCommentVNode("v-if",!0)])])])):e.createCommentVNode("v-if",!0),e.createCommentVNode(" éšè—çš„canvasç”¨äºå›¾ç‰‡å¤„ç† "),e.createElementVNode("canvas",{"canvas-id":"imageCanvas",style:{position:"absolute",left:"-1000px",top:"-1000px",width:"100px",height:"100px"}})])}],["__file","D:/caloriesH5/CloudStorage/pages/ai-medical/index.vue"]]);__definePage("pages/login/login",Je),__definePage("pages/login/register",He),__definePage("pages/map/map",ct),__definePage("pages/community/community",mt),__definePage("pages/index/index",pt),__definePage("pages/community/create",gt),__definePage("pages/community/post-detail",vt),__definePage("pages/pet/management",yt),__definePage("pages/pet/edit",wt),__definePage("pages/pet/recognition",Ct),__definePage("pages/community/my-posts",bt),__definePage("pages/walk/history",Pt),__definePage("pages/profile/settings",xt),__definePage("pages/profile/profile",It),__definePage("pages/profile/following",Tt),__definePage("pages/profile/followers",Mt),__definePage("pages/chat/chat",Ot),__definePage("pages/chat/index",Rt),__definePage("pages/map/add-marker",Wt),__definePage("pages/map/marker-detail",zt),__definePage("pages/petIdentify/index",Jt),__definePage("pages/profile/my-markers",Ht),__definePage("pages/ai-medical/index",Yt);const Xt=e.reactive({}),Zt=e.ref(!1);function ea(){return __async(this,null,(function*(){try{const t=`/static/icon-versions.json?t=${Date.now()}`;a("log","at utils/iconManager.js:24","å°è¯•åŠ è½½å›¾æ ‡ç‰ˆæœ¬ä¿¡æ¯:",t);const o=yield fetch(t);if(!o.ok)return a("warn","at utils/iconManager.js:28",`å›¾æ ‡ç‰ˆæœ¬ä¿¡æ¯åŠ è½½å¤±è´¥ (${o.status}):`,yield o.text()),a("log","at utils/iconManager.js:31","ä½¿ç”¨ç©ºå›¾æ ‡ç‰ˆæœ¬ä¿¡æ¯"),Zt.value=!0,{};const s=o.headers.get("content-type");if(!s||!s.includes("application/json"))return a("warn","at utils/iconManager.js:39","å›¾æ ‡ç‰ˆæœ¬ä¿¡æ¯å“åº”ä¸æ˜¯JSONæ ¼å¼:",s),Zt.value=!0,{};try{const e=yield o.json();return a("log","at utils/iconManager.js:46","åŠ è½½åˆ°å›¾æ ‡ç‰ˆæœ¬ä¿¡æ¯:",e),Object.assign(Xt,e),Zt.value=!0,e}catch(e){return a("error","at utils/iconManager.js:54","è§£æå›¾æ ‡ç‰ˆæœ¬ä¿¡æ¯JSONå¤±è´¥:",e),Zt.value=!0,{}}}catch(t){return a("error","at utils/iconManager.js:59","åŠ è½½å›¾æ ‡ç‰ˆæœ¬ä¿¡æ¯å‡ºé”™:",t),Zt.value=!0,{}}}))}function ta(e){if(!e)return null;const t=e.startsWith("/")?e:`/${e}`;return Xt[t]?Xt[t].version:null}function aa(e='img[src*="/static/"]'){try{const t=document.querySelectorAll(e);a("log","at utils/iconManager.js:227",`æ‰¾åˆ° ${t.length} ä¸ªåŒ¹é…çš„å›¾æ ‡`);let o=0;return t.forEach(((e,t)=>{const s=function(e,t=!1){if(!e)return"";const a=e.split("?")[0],o=ta(a)||Date.now(),s=t?Math.random().toString(36).substring(2,8):"";return`${a}?v=${o}${s?`&r=${s}`:""}`}(e.src.split("?")[0],!0),r=new Image;r.onload=function(){a("log","at utils/iconManager.js:240",`å›¾æ ‡ ${t+1} å·²é‡æ–°åŠ è½½: ${s}`)},Array.from(e.attributes).forEach((e=>{"src"!==e.name&&r.setAttribute(e.name,e.value)})),r.src=s,e.parentNode&&(e.parentNode.replaceChild(r,e),o++)})),a("log","at utils/iconManager.js:260",`å·²åˆ·æ–° ${o} ä¸ªå›¾æ ‡`),o}catch(t){return a("error","at utils/iconManager.js:263","åˆ·æ–°DOMå›¾æ ‡å¤±è´¥:",t),0}}setTimeout((()=>{ea().catch((e=>a("error","at utils/iconManager.js:408","åˆå§‹åŒ–å›¾æ ‡ç‰ˆæœ¬ä¿¡æ¯å¤±è´¥:",e)))}),1e3);const oa=ze({components:{IconLoader:ze({name:"IconLoader",emits:["update-applied"],setup(t,{emit:o}){const s=e.ref(!1),r=e.ref(0);let n=null;const i=e.ref(0),l=()=>__async(this,null,(function*(){try{yield ea(),a("log","at components/IconLoader.vue:36","å›¾æ ‡ç‰ˆæœ¬ä¿¡æ¯åŠ è½½å®Œæˆ")}catch(e){a("error","at components/IconLoader.vue:38","åŠ è½½å›¾æ ‡ç‰ˆæœ¬ä¿¡æ¯å¤±è´¥:",e)}})),c=()=>__async(this,null,(function*(){const e=Date.now();if(!(e-i.value<6e5)){i.value=e;try{if(yield function(){return __async(this,null,(function*(){const e=yield ea();let t=!1;for(const[o,s]of Object.entries(e)){const e=ta(o);(!e||s.version>e)&&(t=!0,a("log","at utils/iconManager.js:212",`å‘ç°å›¾æ ‡æ›´æ–°: ${o}, æ–°ç‰ˆæœ¬: ${s.version}`))}return t}))}()){const e=document.querySelectorAll('img[src*="/static/"]');r.value=e.length,r.value>0&&(s.value=!0)}}catch(t){a("error","at components/IconLoader.vue:66","æ£€æŸ¥å›¾æ ‡æ›´æ–°å¤±è´¥:",t)}}}));return e.onMounted((()=>__async(this,null,(function*(){yield l(),yield c(),n=setInterval(c,18e5)})))),e.onBeforeUnmount((()=>{n&&clearInterval(n)})),{showUpdate:s,pendingUpdates:r,applyUpdates:()=>{try{const e=aa();a("log","at components/IconLoader.vue:75",`å·²åˆ·æ–° ${e} ä¸ªå›¾æ ‡`),s.value=!1,r.value=0,o("update-applied",e)}catch(e){a("error","at components/IconLoader.vue:84","åº”ç”¨å›¾æ ‡æ›´æ–°å¤±è´¥:",e)}}}}},[["render",function(t,a,o,s,r,n){return s.showUpdate?(e.openBlock(),e.createElementBlock("view",{key:0,class:"icon-update-notification"},[e.createElementVNode("view",{class:"icon-update-content",onClick:a[0]||(a[0]=(...e)=>s.applyUpdates&&s.applyUpdates(...e))},[e.createElementVNode("text",{class:"icon-update-text"},"å‘ç°å›¾æ ‡æ›´æ–°ï¼Œç‚¹å‡»åº”ç”¨"),e.createElementVNode("view",{class:"icon-update-badge"},e.toDisplayString(s.pendingUpdates),1)])])):e.createCommentVNode("v-if",!0)}],["__scopeId","data-v-8ab6c055"],["__file","D:/caloriesH5/CloudStorage/components/IconLoader.vue"]])},onLaunch:function(){a("log","at App.vue:13","App Launch");const e=Re(),t=Oe(),o=N.BASE_API_URL;if(a("log","at App.vue:21","åˆå§‹åŒ–BASE_URL:",o),uni.setStorageSync("BASE_URL",o),this.initApi(),uni.getStorageSync("token")){try{const t=uni.getStorageSync("userInfo");if(t){const o=JSON.parse(t);o&&o._id&&(e.user=o,a("log","at App.vue:37","ä»æœ¬åœ°å­˜å‚¨åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯:",o.nickname,"å¤´åƒ:",o.avatar))}}catch(s){a("error","at App.vue:41","ä»æœ¬åœ°å­˜å‚¨æ¢å¤ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",s)}e.init().then((()=>(a("log","at App.vue:46","ç”¨æˆ·çŠ¶æ€åˆå§‹åŒ–æˆåŠŸ","ç”¨æˆ·ä¿¡æ¯:",e.user),e.fetchUserStats()))).catch((e=>{a("error","at App.vue:50","åˆå§‹åŒ–ç”¨æˆ·çŠ¶æ€å¤±è´¥:",e)}))}t.restorePetState?t.restorePetState():a("warn","at App.vue:58","å® ç‰©çŠ¶æ€æ¢å¤æ–¹æ³•ä¸å­˜åœ¨"),uni.addInterceptor("request",{fail:e=>{a("error","at App.vue:64","è¯·æ±‚æ‹¦æˆªåˆ°é”™è¯¯:",e),(404===e.statusCode||e.errMsg&&e.errMsg.includes("404"))&&(a("warn","at App.vue:68","APIè¯·æ±‚404é”™è¯¯:",e.errMsg),uni.showToast({title:"ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åå†è¯•",icon:"none",duration:2e3}))}})},onShow:function(){a("log","at App.vue:79","App Show");const e=Re();uni.getStorageSync("token")&&!e.user&&(a("log","at App.vue:84","App Show: æ£€æµ‹åˆ°tokenä½†ç”¨æˆ·ä¿¡æ¯ä¸å­˜åœ¨ï¼Œå°è¯•é‡æ–°åˆå§‹åŒ–"),e.init().catch((e=>{a("error","at App.vue:86","é‡æ–°åˆå§‹åŒ–ç”¨æˆ·çŠ¶æ€å¤±è´¥:",e)}))),uni.$api||(a("warn","at App.vue:92","APIå°šæœªåˆå§‹åŒ–ï¼Œå°è¯•é‡æ–°åˆå§‹åŒ–"),this.initApi())},onHide:function(){a("log","at App.vue:97","App Hide")},methods:{initApi(){try{uni.$api?a("log","at App.vue:130","APIå·²åˆå§‹åŒ–ï¼Œæ— éœ€å†æ¬¡åˆå§‹åŒ–"):(a("log","at App.vue:105","æ­£åœ¨åˆå§‹åŒ–API..."),uni.$api=A,this.globalData.apiReady=!0,a("log","at App.vue:108","APIåˆå§‹åŒ–æˆåŠŸï¼Œå½“å‰APIå¯¹è±¡:",Object.keys(uni.$api)),uni.$api.community||(a("warn","at App.vue:112","ç¤¾åŒºAPIä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºå¯¹è±¡"),uni.$api.community={getPosts:()=>Promise.resolve([]),getMyPosts:()=>Promise.resolve([]),createPost:()=>Promise.resolve({success:!0}),getPostById:()=>Promise.resolve(null)}),uni.$api.pet||(a("warn","at App.vue:122","å® ç‰©APIä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºå¯¹è±¡"),uni.$api.pet={getPets:()=>Promise.resolve([]),getPetById:()=>Promise.resolve(null),createPet:()=>Promise.resolve({success:!0})}))}catch(e){a("error","at App.vue:133","APIåˆå§‹åŒ–å¤±è´¥:",e),this.globalData.apiReady=!1,uni.$api={community:{getPosts:()=>Promise.resolve([]),getMyPosts:()=>Promise.resolve([]),createPost:()=>Promise.resolve({success:!0}),getPostById:()=>Promise.resolve(null)},pet:{getPets:()=>Promise.resolve([]),getPetById:()=>Promise.resolve(null),createPet:()=>Promise.resolve({success:!0})},auth:{login:()=>Promise.resolve({token:"mock-token"}),register:()=>Promise.resolve({success:!0}),resetPassword:()=>Promise.resolve({success:!0})}},setTimeout((()=>{this.initApi()}),5e3)}},handleIconUpdated(e){a("log","at App.vue:164",`åº”ç”¨å›¾æ ‡æ›´æ–°å®Œæˆï¼Œæ›´æ–°äº† ${e} ä¸ªå›¾æ ‡`),uni.showToast({title:`æ›´æ–°äº† ${e} ä¸ªå›¾æ ‡`,icon:"success"})}},globalData:{apiReady:!1}},[["render",function(t,a,o,s,r,n){const i=e.resolveComponent("router-view"),l=e.resolveComponent("IconLoader");return e.openBlock(),e.createElementBlock("div",{class:"app-container"},[e.createVNode(i),e.createVNode(l,{onUpdateApplied:n.handleIconUpdated},null,8,["onUpdateApplied"])])}],["__file","D:/caloriesH5/CloudStorage/App.vue"]]);uni.$api=A;const{app:sa,Vuex:ra,Pinia:na}=function(){const t=e.createVueApp(oa),o=function(){const t=e.effectScope(!0),a=t.run((()=>e.ref({})));let o=[],s=[];const r=e.markRaw({install(e){J(r),r._a=e,e.provide(H,r),e.config.globalProperties.$pinia=r,Y&&Se(e,r),s.forEach((e=>o.push(e))),s=[]},use(e){return this._a?o.push(e):s.push(e),this},_p:o,_a:null,_e:t,_s:new Map,state:a});return Y&&"undefined"!=typeof Proxy&&r.use(Pe),r}();return t.use(o),uni.$api=A,t.config.errorHandler=(e,t,o)=>{if(a("error","at main.js:24","Vue Error:",e),e.message&&e.message.includes("Failed to fetch dynamically imported module")){a("warn","at main.js:28","åŠ¨æ€å¯¼å…¥æ¨¡å—å¤±è´¥ï¼Œæ¨¡å—è·¯å¾„å¯èƒ½æœ‰è¯¯:",e.message);const t=e.message.match(/http:\/\/localhost:5173\/(.*?)(\?|$)/);t&&t[1]&&(a("warn","at main.js:31","æ— æ³•åŠ è½½é¡µé¢:",t[1]),uni.showToast({title:"é¡µé¢åŠ è½½å¤±è´¥",icon:"none",duration:2e3}),setTimeout((()=>{uni.navigateBack({fail:()=>{uni.switchTab({url:"/pages/index/index"})}})}),1500))}else(404===e.status||e.message&&e.message.includes("404"))&&(a("warn","at main.js:55","APIè¯·æ±‚404é”™è¯¯:",e.message),uni.showToast({title:"ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åå†è¯•",icon:"none"}))},{app:t}}();uni.Vuex=ra,uni.Pinia=na,sa.provide("__globalStyles",__uniConfig.styles),sa._component.mpType="app",sa._component.render=()=>{},sa.mount("#app")}(Vue);
