import{b as A,f as N,h as S,a as U}from"./story-C7UPQB8y.js";import{_ as B}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{b as y,d as s,J as x,e as r,w as l,g as a,D as L,i as c,s as f,E as M,o as p,p as n,f as z,t as g,F as T,h as P}from"./index-BZUGXbIj.js";import"./index-xsH4HHeE.js";const R={name:"PlotDetail",data(){return{loading:!1,plotId:null,plot:{},chapters:[],chapterDialogVisible:!1,isEditChapter:!1,editingChapterId:null,requirementCustomJson:"{}",rewardItemsJson:"[]",chapterForm:{plotId:"",title:"",description:"",sortOrder:0,isActive:!0,requirement:{userLevel:0,previousChapter:null,customCondition:{}},reward:{experience:0,items:[]}},chapterRules:{title:[{required:!0,message:"请输入章节标题",trigger:"blur"},{min:2,max:50,message:"长度在 2 到 50 个字符",trigger:"blur"}],description:[{required:!0,message:"请输入章节描述",trigger:"blur"}]}}},created(){this.plotId=this.$route.params.id,this.plotId&&this.fetchData()},methods:{fetchData(){this.loading=!0,U(this.plotId).then(o=>{this.plot=o.data.plot,this.chapters=o.data.chapters,this.loading=!1}).catch(()=>{this.loading=!1,f.error("获取剧情信息失败")})},formatDate(o){return o?new Date(o).toLocaleString():""},goBack(){this.$router.push("/story/plots")},handleEdit(){this.$router.push(`/story/plots/${this.plotId}/edit`)},handleAddChapter(){this.isEditChapter=!1,this.editingChapterId=null,this.chapterForm={plotId:this.plotId,title:"",description:"",sortOrder:this.chapters.length>0?Math.max(...this.chapters.map(o=>o.sortOrder))+1:0,isActive:!0,requirement:{userLevel:0,previousChapter:null,customCondition:{}},reward:{experience:0,items:[]}},this.requirementCustomJson="{}",this.rewardItemsJson="[]",this.chapterDialogVisible=!0},handleViewChapter(o){this.$router.push(`/story/chapters/${o._id}`)},handleEditChapter(o){var e,C,b,t,d,u,m;this.isEditChapter=!0,this.editingChapterId=o._id,this.chapterForm={plotId:this.plotId,title:o.title,description:o.description,sortOrder:o.sortOrder,isActive:o.isActive,requirement:{userLevel:((e=o.requirement)==null?void 0:e.userLevel)||0,previousChapter:((C=o.requirement)==null?void 0:C.previousChapter)||null,customCondition:((b=o.requirement)==null?void 0:b.customCondition)||{}},reward:{experience:((t=o.reward)==null?void 0:t.experience)||0,items:((d=o.reward)==null?void 0:d.items)||[]}},this.requirementCustomJson=JSON.stringify(((u=o.requirement)==null?void 0:u.customCondition)||{},null,2),this.rewardItemsJson=JSON.stringify(((m=o.reward)==null?void 0:m.items)||[],null,2),this.chapterDialogVisible=!0},handleDeleteChapter(o){M.confirm("此操作将永久删除该章节及其所有事件，是否继续？","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{S(o._id).then(()=>{f({type:"success",message:"删除成功!"}),this.fetchData()})}).catch(()=>{f({type:"info",message:"已取消删除"})})},submitChapterForm(){this.$refs.chapterForm.validate(o=>{if(o){try{this.chapterForm.requirement.customCondition=JSON.parse(this.requirementCustomJson||"{}"),this.chapterForm.reward.items=JSON.parse(this.rewardItemsJson||"[]")}catch{return f.error("JSON格式不正确")}(this.isEditChapter?A(this.editingChapterId,this.chapterForm):N(this.chapterForm)).then(()=>{f.success(this.isEditChapter?"更新成功":"创建成功"),this.chapterDialogVisible=!1,this.fetchData()}).catch(()=>{f.error(this.isEditChapter?"更新失败":"创建失败")})}else return!1})}}},j={class:"app-container"},G={class:"filter-container"},H={class:"card-header"},K={class:"plot-info"},Q={key:0,class:"plot-cover"},W=["src"],X={class:"plot-details"},Y={class:"dialog-footer"};function Z(o,e,C,b,t,d){const u=a("el-button"),m=a("el-tag"),k=a("el-card"),v=a("el-table-column"),D=a("el-table"),_=a("el-input"),h=a("el-form-item"),I=a("el-switch"),V=a("el-input-number"),q=a("el-option"),J=a("el-select"),O=a("el-form"),E=a("el-dialog"),F=L("loading");return p(),y("div",j,[s("div",G,[r(u,{class:"filter-item",type:"primary",onClick:d.goBack},{default:l(()=>e[11]||(e[11]=[n(" 返回 ")])),_:1},8,["onClick"]),r(u,{class:"filter-item",type:"success",onClick:d.handleEdit},{default:l(()=>e[12]||(e[12]=[n(" 编辑剧情 ")])),_:1},8,["onClick"]),r(u,{class:"filter-item",type:"primary",onClick:d.handleAddChapter},{default:l(()=>e[13]||(e[13]=[n(" 添加章节 ")])),_:1},8,["onClick"])]),x((p(),c(k,{class:"box-card"},{header:l(()=>[s("div",H,[s("span",null,g(t.plot.title||"剧情详情"),1),t.plot.isMainStory?(p(),c(m,{key:0,type:"danger"},{default:l(()=>e[14]||(e[14]=[n("主线剧情")])),_:1})):(p(),c(m,{key:1},{default:l(()=>e[15]||(e[15]=[n("支线剧情")])),_:1}))])]),default:l(()=>[s("div",K,[t.plot.coverImage?(p(),y("div",Q,[s("img",{src:t.plot.coverImage,alt:"剧情封面"},null,8,W)])):z("",!0),s("div",X,[s("p",null,[e[16]||(e[16]=s("strong",null,"描述：",-1)),n(" "+g(t.plot.description),1)]),s("p",null,[e[19]||(e[19]=s("strong",null,"状态：",-1)),t.plot.isActive?(p(),c(m,{key:0,type:"success"},{default:l(()=>e[17]||(e[17]=[n("已激活")])),_:1})):(p(),c(m,{key:1,type:"info"},{default:l(()=>e[18]||(e[18]=[n("未激活")])),_:1}))]),s("p",null,[e[20]||(e[20]=s("strong",null,"排序：",-1)),n(" "+g(t.plot.sortOrder),1)]),s("p",null,[e[21]||(e[21]=s("strong",null,"创建时间：",-1)),n(" "+g(d.formatDate(t.plot.createdAt)),1)]),s("p",null,[e[22]||(e[22]=s("strong",null,"更新时间：",-1)),n(" "+g(d.formatDate(t.plot.updatedAt)),1)])])])]),_:1})),[[F,t.loading]]),x((p(),c(k,{class:"box-card"},{header:l(()=>e[23]||(e[23]=[s("div",{class:"card-header"},[s("span",null,"章节列表")],-1)])),default:l(()=>[r(D,{data:t.chapters,border:"",fit:"","highlight-current-row":""},{default:l(()=>[r(v,{align:"center",label:"序号",width:"80"},{default:l(i=>[s("span",null,g(i.row.sortOrder),1)]),_:1}),r(v,{align:"center",label:"章节标题",prop:"title"}),r(v,{align:"center",label:"状态",width:"120"},{default:l(i=>[i.row.isActive?(p(),c(m,{key:0,type:"success"},{default:l(()=>e[24]||(e[24]=[n("已激活")])),_:1})):(p(),c(m,{key:1,type:"info"},{default:l(()=>e[25]||(e[25]=[n("未激活")])),_:1}))]),_:1}),r(v,{align:"center",label:"操作",width:"250"},{default:l(i=>[r(u,{size:"small",type:"primary",onClick:w=>d.handleViewChapter(i.row)},{default:l(()=>e[26]||(e[26]=[n(" 管理事件 ")])),_:2},1032,["onClick"]),r(u,{size:"small",type:"success",onClick:w=>d.handleEditChapter(i.row)},{default:l(()=>e[27]||(e[27]=[n(" 编辑 ")])),_:2},1032,["onClick"]),r(u,{size:"small",type:"danger",onClick:w=>d.handleDeleteChapter(i.row)},{default:l(()=>e[28]||(e[28]=[n(" 删除 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})),[[F,t.loading]]),r(E,{title:t.isEditChapter?"编辑章节":"添加章节",modelValue:t.chapterDialogVisible,"onUpdate:modelValue":e[10]||(e[10]=i=>t.chapterDialogVisible=i),width:"60%"},{footer:l(()=>[s("span",Y,[r(u,{onClick:e[9]||(e[9]=i=>t.chapterDialogVisible=!1)},{default:l(()=>e[29]||(e[29]=[n("取消")])),_:1}),r(u,{type:"primary",onClick:d.submitChapterForm},{default:l(()=>e[30]||(e[30]=[n("确认")])),_:1},8,["onClick"])])]),default:l(()=>[r(O,{ref:"chapterForm",model:t.chapterForm,rules:t.chapterRules,"label-width":"120px"},{default:l(()=>[r(h,{label:"章节标题",prop:"title"},{default:l(()=>[r(_,{modelValue:t.chapterForm.title,"onUpdate:modelValue":e[0]||(e[0]=i=>t.chapterForm.title=i),placeholder:"请输入章节标题"},null,8,["modelValue"])]),_:1}),r(h,{label:"章节描述",prop:"description"},{default:l(()=>[r(_,{modelValue:t.chapterForm.description,"onUpdate:modelValue":e[1]||(e[1]=i=>t.chapterForm.description=i),type:"textarea",rows:4,placeholder:"请输入章节描述"},null,8,["modelValue"])]),_:1}),r(h,{label:"是否激活"},{default:l(()=>[r(I,{modelValue:t.chapterForm.isActive,"onUpdate:modelValue":e[2]||(e[2]=i=>t.chapterForm.isActive=i),"active-value":!0,"inactive-value":!1},null,8,["modelValue"])]),_:1}),r(h,{label:"排序"},{default:l(()=>[r(V,{modelValue:t.chapterForm.sortOrder,"onUpdate:modelValue":e[3]||(e[3]=i=>t.chapterForm.sortOrder=i),min:0,max:999},null,8,["modelValue"])]),_:1}),r(h,{label:"前置章节"},{default:l(()=>[r(J,{modelValue:t.chapterForm.requirement.previousChapter,"onUpdate:modelValue":e[4]||(e[4]=i=>t.chapterForm.requirement.previousChapter=i),clearable:"",placeholder:"选择前置章节"},{default:l(()=>[(p(!0),y(T,null,P(t.chapters,i=>(p(),c(q,{key:i._id,label:i.title,value:i._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),r(h,{label:"用户等级要求"},{default:l(()=>[r(V,{modelValue:t.chapterForm.requirement.userLevel,"onUpdate:modelValue":e[5]||(e[5]=i=>t.chapterForm.requirement.userLevel=i),min:0,max:100},null,8,["modelValue"])]),_:1}),r(h,{label:"其他要求",title:"JSON格式的特殊要求配置"},{default:l(()=>[r(_,{modelValue:t.requirementCustomJson,"onUpdate:modelValue":e[6]||(e[6]=i=>t.requirementCustomJson=i),type:"textarea",rows:3,placeholder:"{}"},null,8,["modelValue"])]),_:1}),r(h,{label:"经验奖励"},{default:l(()=>[r(V,{modelValue:t.chapterForm.reward.experience,"onUpdate:modelValue":e[7]||(e[7]=i=>t.chapterForm.reward.experience=i),min:0,max:1e4},null,8,["modelValue"])]),_:1}),r(h,{label:"物品奖励",title:"JSON格式的物品奖励配置"},{default:l(()=>[r(_,{modelValue:t.rewardItemsJson,"onUpdate:modelValue":e[8]||(e[8]=i=>t.rewardItemsJson=i),type:"textarea",rows:3,placeholder:"[]"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"])])}const re=B(R,[["render",Z],["__scopeId","data-v-4858dafb"]]);export{re as default};
