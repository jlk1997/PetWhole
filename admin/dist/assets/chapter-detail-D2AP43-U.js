import{j as K,k as B,l as S,m as j}from"./story-C7UPQB8y.js";import{_ as H}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{b as u,d as s,J as w,e as t,w as n,g as p,D as z,i as y,s as k,E as W,o as i,p as d,f as E,t as h,F as C,h as F}from"./index-BZUGXbIj.js";import"./index-xsH4HHeE.js";const J={name:"ChapterDetail",data(){return{loading:!1,chapterId:null,plotId:null,chapter:{},events:[],eventDialogVisible:!1,isEditEvent:!1,editingEventId:null,eventForm:{chapterId:"",title:"",eventType:"DIALOG",content:{dialogues:[],taskObjective:"",guideInfo:{targetPage:"",targetElement:"",guideText:""},choices:[]},triggerCondition:{type:"AUTO",pageId:"",elementId:"",delay:0},nextEventId:null,isActive:!0,sortOrder:0},eventRules:{title:[{required:!0,message:"请输入事件标题",trigger:"blur"}],eventType:[{required:!0,message:"请选择事件类型",trigger:"change"}]}}},created(){this.chapterId=this.$route.params.id,this.chapterId&&this.fetchData()},methods:{fetchData(){this.loading=!0,j(this.chapterId).then(r=>{this.chapter=r.data.chapter,this.events=r.data.events,this.plotId=this.chapter.plotId,this.loading=!1}).catch(()=>{this.loading=!1,k.error("获取章节信息失败")})},goBack(){this.$router.push(`/story/plots/${this.plotId}`)},getPreviousChapterName(r){return r},getEventTypeTag(r){return{DIALOG:"primary",TASK:"success",GUIDE:"warning",REWARD:"danger",MULTI_CHOICE:"info"}[r]||"info"},getEventTypeName(r){return{DIALOG:"对话",TASK:"任务",GUIDE:"引导",REWARD:"奖励",MULTI_CHOICE:"多选"}[r]||r},getTriggerTypeName(r){return{AUTO:"自动",ENTER_PAGE:"进入页面",CLICK_ELEMENT:"点击元素",COMPLETE_TASK:"完成任务",MANUAL:"手动"}[r]||r},getTriggerTypeDesc(r){return{AUTO:"自动触发事件",ENTER_PAGE:"进入指定页面时触发",CLICK_ELEMENT:"点击指定元素时触发",COMPLETE_TASK:"完成特定任务时触发",MANUAL:"由用户手动触发"}[r]||"未知触发条件"},handleEventTypeChange(r){r==="DIALOG"&&this.eventForm.content.dialogues.length===0?this.addDialog():r==="MULTI_CHOICE"&&this.eventForm.content.choices.length===0&&this.addChoice()},addDialog(){this.eventForm.content.dialogues.push({speaker:"",content:"",avatar:""})},removeDialog(r){this.eventForm.content.dialogues.splice(r,1)},addChoice(){this.eventForm.content.choices.push({text:"",nextEventId:null})},removeChoice(r){this.eventForm.content.choices.splice(r,1)},handleAddEvent(){this.isEditEvent=!1,this.editingEventId=null,this.eventForm={chapterId:this.chapterId,title:"",eventType:"DIALOG",content:{dialogues:[{speaker:"",content:"",avatar:""}],taskObjective:"",guideInfo:{targetPage:"",targetElement:"",guideText:""},choices:[]},triggerCondition:{type:"AUTO",pageId:"",elementId:"",delay:0},nextEventId:null,isActive:!0,sortOrder:this.events.length>0?Math.max(...this.events.map(r=>r.sortOrder))+1:0},this.eventDialogVisible=!0},handleViewEvent(r){this.$router.push(`/story/events/${r._id}`)},handleEditEvent(r){var e,D,U,l,a,g,I;this.isEditEvent=!0,this.editingEventId=r._id,this.eventForm={chapterId:this.chapterId,title:r.title,eventType:r.eventType,content:{dialogues:Array.isArray(r.content.dialogues)?[...r.content.dialogues]:[],taskObjective:r.content.taskObjective||"",guideInfo:{targetPage:((e=r.content.guideInfo)==null?void 0:e.targetPage)||"",targetElement:((D=r.content.guideInfo)==null?void 0:D.targetElement)||"",guideText:((U=r.content.guideInfo)==null?void 0:U.guideText)||""},choices:Array.isArray(r.content.choices)?[...r.content.choices]:[]},triggerCondition:{type:((l=r.triggerCondition)==null?void 0:l.type)||"AUTO",pageId:((a=r.triggerCondition)==null?void 0:a.pageId)||"",elementId:((g=r.triggerCondition)==null?void 0:g.elementId)||"",delay:((I=r.triggerCondition)==null?void 0:I.delay)||0},nextEventId:r.nextEventId,isActive:r.isActive,sortOrder:r.sortOrder},this.eventForm.content.dialogues||(this.eventForm.content.dialogues=[]),this.eventForm.content.choices||(this.eventForm.content.choices=[]),this.eventDialogVisible=!0},handleDeleteEvent(r){W.confirm("此操作将永久删除该事件，是否继续？","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{S(r._id).then(()=>{k({type:"success",message:"删除成功!"}),this.fetchData()})}).catch(()=>{k({type:"info",message:"已取消删除"})})},submitEventForm(){this.$refs.eventForm.validate(r=>{if(r)(this.isEditEvent?K(this.editingEventId,this.eventForm):B(this.eventForm)).then(()=>{k.success(this.isEditEvent?"更新成功":"创建成功"),this.eventDialogVisible=!1,this.fetchData()}).catch(()=>{k.error(this.isEditEvent?"更新失败":"创建失败")});else return!1})}}},Q={class:"app-container"},X={class:"filter-container"},Y={class:"card-header"},Z={class:"chapter-info"},$={key:0},ee={key:1},te={key:2},le={key:0},ne={key:1},oe={class:"dialog-footer"};function re(r,e,D,U,l,a){const g=p("el-button"),I=p("el-tag"),O=p("el-card"),V=p("el-table-column"),M=p("el-tooltip"),G=p("el-table"),_=p("el-input"),m=p("el-form-item"),c=p("el-option"),A=p("el-select"),T=p("el-divider"),b=p("el-col"),x=p("el-row"),L=p("el-input-number"),P=p("el-switch"),R=p("el-form"),q=p("el-dialog"),N=z("loading");return i(),u("div",Q,[s("div",X,[t(g,{class:"filter-item",type:"primary",onClick:a.goBack},{default:n(()=>e[15]||(e[15]=[d(" 返回剧情 ")])),_:1},8,["onClick"]),t(g,{class:"filter-item",type:"primary",onClick:a.handleAddEvent},{default:n(()=>e[16]||(e[16]=[d(" 添加事件 ")])),_:1},8,["onClick"])]),w((i(),y(O,{class:"box-card"},{header:n(()=>[s("div",Y,[s("span",null,h(l.chapter.title||"章节详情"),1),s("div",null,[l.chapter.isActive?(i(),y(I,{key:0,type:"success"},{default:n(()=>e[17]||(e[17]=[d("已激活")])),_:1})):(i(),y(I,{key:1,type:"info"},{default:n(()=>e[18]||(e[18]=[d("未激活")])),_:1}))])])]),default:n(()=>[s("div",Z,[s("p",null,[e[19]||(e[19]=s("strong",null,"描述：",-1)),d(" "+h(l.chapter.description),1)]),s("p",null,[e[20]||(e[20]=s("strong",null,"排序：",-1)),d(" "+h(l.chapter.sortOrder),1)]),l.chapter.requirement&&l.chapter.requirement.userLevel?(i(),u("p",$,[e[21]||(e[21]=s("strong",null,"用户等级要求：",-1)),d(" "+h(l.chapter.requirement.userLevel),1)])):E("",!0),l.chapter.requirement&&l.chapter.requirement.previousChapter?(i(),u("p",ee,[e[22]||(e[22]=s("strong",null,"前置章节：",-1)),d(" "+h(a.getPreviousChapterName(l.chapter.requirement.previousChapter)),1)])):E("",!0),l.chapter.reward?(i(),u("div",te,[l.chapter.reward.experience?(i(),u("p",le,[e[23]||(e[23]=s("strong",null,"经验奖励：",-1)),d(" "+h(l.chapter.reward.experience),1)])):E("",!0),l.chapter.reward.items&&l.chapter.reward.items.length>0?(i(),u("div",ne,[e[24]||(e[24]=s("p",null,[s("strong",null,"物品奖励：")],-1)),s("ul",null,[(i(!0),u(C,null,F(l.chapter.reward.items,(o,f)=>(i(),u("li",{key:f},h(o.itemType)+" - "+h(o.itemId)+" (x"+h(o.quantity)+") ",1))),128))])])):E("",!0)])):E("",!0)])]),_:1})),[[N,l.loading]]),w((i(),y(O,{class:"box-card"},{header:n(()=>e[25]||(e[25]=[s("div",{class:"card-header"},[s("span",null,"事件列表")],-1)])),default:n(()=>[t(G,{data:l.events,border:"",fit:"","highlight-current-row":""},{default:n(()=>[t(V,{align:"center",label:"序号",width:"80"},{default:n(o=>[s("span",null,h(o.row.sortOrder),1)]),_:1}),t(V,{align:"center",label:"事件标题",prop:"title"}),t(V,{align:"center",label:"事件类型",width:"120"},{default:n(o=>[t(I,{type:a.getEventTypeTag(o.row.eventType)},{default:n(()=>[d(h(a.getEventTypeName(o.row.eventType)),1)]),_:2},1032,["type"])]),_:1}),t(V,{align:"center",label:"触发条件",width:"120"},{default:n(o=>[t(M,{content:a.getTriggerTypeDesc(o.row.triggerCondition.type),placement:"top"},{default:n(()=>[t(I,null,{default:n(()=>[d(h(a.getTriggerTypeName(o.row.triggerCondition.type)),1)]),_:2},1024)]),_:2},1032,["content"])]),_:1}),t(V,{align:"center",label:"状态",width:"100"},{default:n(o=>[o.row.isActive?(i(),y(I,{key:0,type:"success"},{default:n(()=>e[26]||(e[26]=[d("已激活")])),_:1})):(i(),y(I,{key:1,type:"info"},{default:n(()=>e[27]||(e[27]=[d("未激活")])),_:1}))]),_:1}),t(V,{align:"center",label:"操作",width:"250"},{default:n(o=>[t(g,{size:"small",type:"primary",onClick:f=>a.handleViewEvent(o.row)},{default:n(()=>e[28]||(e[28]=[d(" 查看 ")])),_:2},1032,["onClick"]),t(g,{size:"small",type:"success",onClick:f=>a.handleEditEvent(o.row)},{default:n(()=>e[29]||(e[29]=[d(" 编辑 ")])),_:2},1032,["onClick"]),t(g,{size:"small",type:"danger",onClick:f=>a.handleDeleteEvent(o.row)},{default:n(()=>e[30]||(e[30]=[d(" 删除 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})),[[N,l.loading]]),t(q,{title:l.isEditEvent?"编辑事件":"添加事件",modelValue:l.eventDialogVisible,"onUpdate:modelValue":e[14]||(e[14]=o=>l.eventDialogVisible=o),width:"70%"},{footer:n(()=>[s("span",oe,[t(g,{onClick:e[13]||(e[13]=o=>l.eventDialogVisible=!1)},{default:n(()=>e[39]||(e[39]=[d("取消")])),_:1}),t(g,{type:"primary",onClick:a.submitEventForm},{default:n(()=>e[40]||(e[40]=[d("确认")])),_:1},8,["onClick"])])]),default:n(()=>[t(R,{ref:"eventForm",model:l.eventForm,rules:l.eventRules,"label-width":"120px"},{default:n(()=>[t(m,{label:"事件标题",prop:"title"},{default:n(()=>[t(_,{modelValue:l.eventForm.title,"onUpdate:modelValue":e[0]||(e[0]=o=>l.eventForm.title=o),placeholder:"请输入事件标题"},null,8,["modelValue"])]),_:1}),t(m,{label:"事件类型",prop:"eventType"},{default:n(()=>[t(A,{modelValue:l.eventForm.eventType,"onUpdate:modelValue":e[1]||(e[1]=o=>l.eventForm.eventType=o),placeholder:"选择事件类型",onChange:a.handleEventTypeChange},{default:n(()=>[t(c,{label:"对话",value:"DIALOG"}),t(c,{label:"任务",value:"TASK"}),t(c,{label:"引导",value:"GUIDE"}),t(c,{label:"奖励",value:"REWARD"}),t(c,{label:"多选项",value:"MULTI_CHOICE"})]),_:1},8,["modelValue","onChange"])]),_:1}),l.eventForm.eventType==="DIALOG"?(i(),u(C,{key:0},[t(T,{"content-position":"left"},{default:n(()=>e[31]||(e[31]=[d("对话内容")])),_:1}),(i(!0),u(C,null,F(l.eventForm.content.dialogues,(o,f)=>(i(),u("div",{key:f,class:"dialog-item"},[t(m,{label:"对话 "+(f+1)},{default:n(()=>[t(x,{gutter:10},{default:n(()=>[t(b,{span:6},{default:n(()=>[t(_,{modelValue:o.speaker,"onUpdate:modelValue":v=>o.speaker=v,placeholder:"说话者"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),t(b,{span:14},{default:n(()=>[t(_,{modelValue:o.content,"onUpdate:modelValue":v=>o.content=v,placeholder:"对话内容"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),t(b,{span:4},{default:n(()=>[t(g,{type:"danger",icon:"el-icon-delete",circle:"",onClick:v=>a.removeDialog(f)},null,8,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1032,["label"])]))),128)),t(m,null,{default:n(()=>[t(g,{type:"primary",onClick:a.addDialog},{default:n(()=>e[32]||(e[32]=[d("添加对话")])),_:1},8,["onClick"])]),_:1})],64)):E("",!0),l.eventForm.eventType==="TASK"?(i(),u(C,{key:1},[t(T,{"content-position":"left"},{default:n(()=>e[33]||(e[33]=[d("任务内容")])),_:1}),t(m,{label:"任务目标"},{default:n(()=>[t(_,{modelValue:l.eventForm.content.taskObjective,"onUpdate:modelValue":e[2]||(e[2]=o=>l.eventForm.content.taskObjective=o),type:"textarea",rows:2,placeholder:"请输入任务目标描述"},null,8,["modelValue"])]),_:1})],64)):E("",!0),l.eventForm.eventType==="GUIDE"?(i(),u(C,{key:2},[t(T,{"content-position":"left"},{default:n(()=>e[34]||(e[34]=[d("引导内容")])),_:1}),t(m,{label:"目标页面"},{default:n(()=>[t(_,{modelValue:l.eventForm.content.guideInfo.targetPage,"onUpdate:modelValue":e[3]||(e[3]=o=>l.eventForm.content.guideInfo.targetPage=o),placeholder:"要引导的页面ID"},null,8,["modelValue"])]),_:1}),t(m,{label:"目标元素"},{default:n(()=>[t(_,{modelValue:l.eventForm.content.guideInfo.targetElement,"onUpdate:modelValue":e[4]||(e[4]=o=>l.eventForm.content.guideInfo.targetElement=o),placeholder:"要引导的元素ID"},null,8,["modelValue"])]),_:1}),t(m,{label:"引导文本"},{default:n(()=>[t(_,{modelValue:l.eventForm.content.guideInfo.guideText,"onUpdate:modelValue":e[5]||(e[5]=o=>l.eventForm.content.guideInfo.guideText=o),type:"textarea",rows:2,placeholder:"引导提示文本"},null,8,["modelValue"])]),_:1})],64)):E("",!0),l.eventForm.eventType==="MULTI_CHOICE"?(i(),u(C,{key:3},[t(T,{"content-position":"left"},{default:n(()=>e[35]||(e[35]=[d("选项内容")])),_:1}),(i(!0),u(C,null,F(l.eventForm.content.choices,(o,f)=>(i(),u("div",{key:f,class:"choice-item"},[t(m,{label:"选项 "+(f+1)},{default:n(()=>[t(x,{gutter:10},{default:n(()=>[t(b,{span:16},{default:n(()=>[t(_,{modelValue:o.text,"onUpdate:modelValue":v=>o.text=v,placeholder:"选项文本"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),t(b,{span:4},{default:n(()=>[t(A,{modelValue:o.nextEventId,"onUpdate:modelValue":v=>o.nextEventId=v,placeholder:"下一个事件"},{default:n(()=>[(i(!0),u(C,null,F(l.events,v=>(i(),y(c,{key:v._id,label:v.title,value:v._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1024),t(b,{span:4},{default:n(()=>[t(g,{type:"danger",icon:"el-icon-delete",circle:"",onClick:v=>a.removeChoice(f)},null,8,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1032,["label"])]))),128)),t(m,null,{default:n(()=>[t(g,{type:"primary",onClick:a.addChoice},{default:n(()=>e[36]||(e[36]=[d("添加选项")])),_:1},8,["onClick"])]),_:1})],64)):E("",!0),t(T,{"content-position":"left"},{default:n(()=>e[37]||(e[37]=[d("触发条件")])),_:1}),t(m,{label:"触发类型"},{default:n(()=>[t(A,{modelValue:l.eventForm.triggerCondition.type,"onUpdate:modelValue":e[6]||(e[6]=o=>l.eventForm.triggerCondition.type=o),placeholder:"选择触发类型"},{default:n(()=>[t(c,{label:"自动触发",value:"AUTO"}),t(c,{label:"进入页面触发",value:"ENTER_PAGE"}),t(c,{label:"点击元素触发",value:"CLICK_ELEMENT"}),t(c,{label:"完成任务触发",value:"COMPLETE_TASK"}),t(c,{label:"手动触发",value:"MANUAL"})]),_:1},8,["modelValue"])]),_:1}),l.eventForm.triggerCondition.type==="ENTER_PAGE"?(i(),y(m,{key:4,label:"目标页面ID"},{default:n(()=>[t(_,{modelValue:l.eventForm.triggerCondition.pageId,"onUpdate:modelValue":e[7]||(e[7]=o=>l.eventForm.triggerCondition.pageId=o),placeholder:"页面ID"},null,8,["modelValue"])]),_:1})):E("",!0),l.eventForm.triggerCondition.type==="CLICK_ELEMENT"?(i(),y(m,{key:5,label:"目标元素ID"},{default:n(()=>[t(_,{modelValue:l.eventForm.triggerCondition.elementId,"onUpdate:modelValue":e[8]||(e[8]=o=>l.eventForm.triggerCondition.elementId=o),placeholder:"元素ID"},null,8,["modelValue"])]),_:1})):E("",!0),l.eventForm.triggerCondition.type!=="MANUAL"?(i(),y(m,{key:6,label:"延迟时间(毫秒)"},{default:n(()=>[t(L,{modelValue:l.eventForm.triggerCondition.delay,"onUpdate:modelValue":e[9]||(e[9]=o=>l.eventForm.triggerCondition.delay=o),min:0,max:6e4,step:100},null,8,["modelValue"])]),_:1})):E("",!0),t(T,{"content-position":"left"},{default:n(()=>e[38]||(e[38]=[d("其他设置")])),_:1}),t(m,{label:"下一个事件"},{default:n(()=>[t(A,{modelValue:l.eventForm.nextEventId,"onUpdate:modelValue":e[10]||(e[10]=o=>l.eventForm.nextEventId=o),filterable:"",clearable:"",placeholder:"选择下一个事件"},{default:n(()=>[(i(!0),u(C,null,F(l.events,o=>(i(),y(c,{key:o._id,label:o.title,value:o._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(m,{label:"是否激活"},{default:n(()=>[t(P,{modelValue:l.eventForm.isActive,"onUpdate:modelValue":e[11]||(e[11]=o=>l.eventForm.isActive=o),"active-value":!0,"inactive-value":!1},null,8,["modelValue"])]),_:1}),t(m,{label:"排序"},{default:n(()=>[t(L,{modelValue:l.eventForm.sortOrder,"onUpdate:modelValue":e[12]||(e[12]=o=>l.eventForm.sortOrder=o),min:0,max:999},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"])])}const ue=H(J,[["render",re],["__scopeId","data-v-07880ff7"]]);export{ue as default};
